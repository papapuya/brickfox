{"file_contents":{"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\n// Always use PostgreSQL (Supabase) - no more local SQLite\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL!,\n  },\n});\n","size_bytes":278},"server/migrate.ts":{"content":"import { drizzle } from 'drizzle-orm/better-sqlite3';\r\nimport Database from 'better-sqlite3';\r\nimport { projects, productsInProjects, templates } from '@shared/schema';\r\n\r\n// Create SQLite database and tables\r\nconst sqlite = new Database('local.db');\r\nconst db = drizzle(sqlite);\r\n\r\nasync function migrate() {\r\n  try {\r\n    console.log('Creating database tables...');\r\n    \r\n    // Create projects table\r\n    sqlite.exec(`\r\n      CREATE TABLE IF NOT EXISTS projects (\r\n        id TEXT PRIMARY KEY,\r\n        name TEXT NOT NULL,\r\n        created_at TEXT NOT NULL\r\n      )\r\n    `);\r\n    \r\n    // Create products_in_projects table\r\n    sqlite.exec(`\r\n      CREATE TABLE IF NOT EXISTS products_in_projects (\r\n        id TEXT PRIMARY KEY,\r\n        project_id TEXT NOT NULL,\r\n        name TEXT,\r\n        files TEXT,\r\n        html_code TEXT,\r\n        preview_text TEXT,\r\n        extracted_data TEXT,\r\n        template TEXT,\r\n        created_at TEXT NOT NULL,\r\n        FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE\r\n      )\r\n    `);\r\n    \r\n    // Create templates table\r\n    sqlite.exec(`\r\n      CREATE TABLE IF NOT EXISTS templates (\r\n        id TEXT PRIMARY KEY,\r\n        name TEXT NOT NULL,\r\n        content TEXT NOT NULL,\r\n        is_default TEXT,\r\n        created_at TEXT NOT NULL\r\n      )\r\n    `);\r\n    \r\n    // Insert default template\r\n    const defaultTemplate = {\r\n      id: 'default-template',\r\n      name: 'Standard Produktbeschreibung',\r\n      content: `<div class=\"product-description\">\r\n  <h2>{{productName}}</h2>\r\n  <p>{{description}}</p>\r\n  <h3>Technische Daten:</h3>\r\n  <ul>\r\n    {{#each technicalSpecs}}\r\n    <li><strong>{{@key}}:</strong> {{this}}</li>\r\n    {{/each}}\r\n  </ul>\r\n  <h3>Features:</h3>\r\n  <ul>\r\n    {{#each features}}\r\n    <li>{{this}}</li>\r\n    {{/each}}\r\n  </ul>\r\n</div>`,\r\n      isDefault: 'true',\r\n      createdAt: new Date().toISOString()\r\n    };\r\n    \r\n    // Check if default template exists\r\n    const existingTemplate = sqlite.prepare('SELECT id FROM templates WHERE id = ?').get('default-template');\r\n    if (!existingTemplate) {\r\n      sqlite.prepare(`\r\n        INSERT INTO templates (id, name, content, is_default, created_at)\r\n        VALUES (?, ?, ?, ?, ?)\r\n      `).run(\r\n        defaultTemplate.id,\r\n        defaultTemplate.name,\r\n        defaultTemplate.content,\r\n        defaultTemplate.isDefault,\r\n        defaultTemplate.createdAt\r\n      );\r\n      console.log('Default template created');\r\n    }\r\n    \r\n    console.log('Database migration completed successfully!');\r\n  } catch (error) {\r\n    console.error('Migration error:', error);\r\n    throw error;\r\n  } finally {\r\n    sqlite.close();\r\n  }\r\n}\r\n\r\nmigrate().catch(console.error);\r\n\r\n","size_bytes":2699},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/pages/project-detail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { apiDownload, apiPost } from \"@/lib/api\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, Plus, FileText, Trash2, Upload, Download, Calendar, FolderOpen, Table, TrendingUp, CheckCircle, XCircle, FileSpreadsheet } from \"lucide-react\";\nimport { useLocation, useParams } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { de } from \"date-fns/locale\";\nimport type { Project, ProductInProject, ExportColumn } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Papa from \"papaparse\";\nimport BrickfoxDataPreview from \"@/components/brickfox-data-preview\";\n\nexport default function ProjectDetail() {\n  const { id } = useParams<{ id: string }>();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isExportDialogOpen, setIsExportDialogOpen] = useState(false);\n  const [activeTab, setActiveTab] = useState<\"products\" | \"pixi\">(\"products\");\n  const [selectedProduct, setSelectedProduct] = useState<ProductInProject | null>(null);\n  const [isProductDialogOpen, setIsProductDialogOpen] = useState(false);\n  \n  // Pixi comparison state\n  const [isPixiDialogOpen, setIsPixiDialogOpen] = useState(false);\n  const [pixiSupplNr, setPixiSupplNr] = useState('');\n  const [pixiLoading, setPixiLoading] = useState(false);\n  const [pixiResults, setPixiResults] = useState<any>(null);\n\n  // Brickfox preview state\n  const [isBrickfoxPreviewOpen, setIsBrickfoxPreviewOpen] = useState(false);\n  \n  // Pagination for product table\n  const [currentPage, setCurrentPage] = useState(1);\n  const productsPerPage = 6;\n\n  const defaultColumns: ExportColumn[] = [\n    // Basis-Informationen\n    { id: 'articleNumber', label: 'Artikelnummer', field: 'articleNumber', enabled: true },\n    { id: 'name', label: 'Produktname', field: 'name', enabled: true },\n    { id: 'exactProductName', label: 'Exakter Produktname', field: 'exactProductName', enabled: false },\n    \n    // Beschreibungen\n    { id: 'htmlCode', label: 'HTML-Beschreibung', field: 'htmlCode', enabled: true },\n    { id: 'previewText', label: 'Flietext', field: 'previewText', enabled: false },\n    { id: 'seoBeschreibung', label: 'SEO Beschreibung', field: 'seoBeschreibung', enabled: false },\n    { id: 'kurzbeschreibung', label: 'Kurzbeschreibung', field: 'kurzbeschreibung', enabled: false },\n    \n    // Produktdaten\n    { id: 'ean', label: 'EAN', field: 'ean', enabled: false },\n    { id: 'manufacturer', label: 'Hersteller', field: 'manufacturer', enabled: false },\n    { id: 'category', label: 'Kategorie', field: 'category', enabled: false },\n    \n    // Preise\n    { id: 'vk', label: 'VK (Verkaufspreis)', field: 'vk', enabled: false },\n    { id: 'ek', label: 'EK (Einkaufspreis)', field: 'ek', enabled: false },\n    { id: 'uvp', label: 'UVP', field: 'uvp', enabled: false },\n    \n    // Bilder & Medien\n    { id: 'files', label: 'Produktbilder (URLs)', field: 'files', enabled: true },\n    \n    // Mae & Gewicht\n    { id: 'weight', label: 'Gewicht', field: 'weight', enabled: false },\n    { id: 'height', label: 'Hhe', field: 'height', enabled: false },\n    { id: 'width', label: 'Breite', field: 'width', enabled: false },\n    { id: 'length', label: 'Lnge', field: 'length', enabled: false },\n    \n    // Meta-Daten\n    { id: 'createdAt', label: 'Erstellt am', field: 'createdAt', enabled: false },\n    { id: 'status', label: 'Status', field: 'status', enabled: false },\n  ];\n\n  const [selectedColumns, setSelectedColumns] = useState<ExportColumn[]>(defaultColumns);\n\n  // Generate dynamic columns based on products' custom attributes\n  const generateDynamicColumns = (products: ProductInProject[]): ExportColumn[] => {\n    const baseColumns = [...defaultColumns];\n    const customAttributeColumns = new Map<string, ExportColumn>();\n\n    // Extract all unique custom attributes from all products\n    products.forEach(product => {\n      if (product.customAttributes && product.customAttributes.length > 0) {\n        product.customAttributes.forEach(attr => {\n          if (!customAttributeColumns.has(attr.key)) {\n            customAttributeColumns.set(attr.key, {\n              id: `custom_${attr.key}`,\n              label: attr.key,\n              field: `custom_${attr.key}`,\n              enabled: false, // Custom attributes are disabled by default\n            });\n          }\n        });\n      }\n    });\n\n    // Add custom attribute columns\n    customAttributeColumns.forEach((column, key) => {\n      if (!baseColumns.find(col => col.id === column.id)) {\n        baseColumns.push(column);\n      }\n    });\n\n    console.log('Generated dynamic columns:', baseColumns.length, 'total columns');\n    console.log('Custom attribute columns:', customAttributeColumns.size);\n    \n    return baseColumns;\n  };\n\n  // Fetch project\n  const { data: project, isLoading: isLoadingProject } = useQuery<Project>({\n    queryKey: [`/api/projects/${id}`],\n    enabled: !!id,\n  });\n\n  // Fetch products\n  const { data: productsData, isLoading: isLoadingProducts } = useQuery<{ success: boolean; products: ProductInProject[] }>({\n    queryKey: [`/api/projects/${id}/products`],\n    enabled: !!id,\n  });\n\n  const products = productsData?.products || [];\n\n  // Update columns when products change\n  const dynamicColumns = generateDynamicColumns(products);\n\n  // Update selectedColumns when dynamic columns change\n  useEffect(() => {\n    // Always sync selectedColumns with dynamicColumns to ensure all columns are available\n    setSelectedColumns(prev => {\n      const updatedColumns = [...prev];\n      \n      // Add new columns that don't exist yet\n      dynamicColumns.forEach(dynCol => {\n        if (!updatedColumns.find(col => col.id === dynCol.id)) {\n          updatedColumns.push(dynCol);\n        }\n      });\n      \n      // Remove columns that no longer exist\n      return updatedColumns.filter(col => \n        dynamicColumns.find(dynCol => dynCol.id === col.id)\n      );\n    });\n  }, [dynamicColumns]);\n\n  // Delete product mutation\n  const deleteProductMutation = useMutation({\n    mutationFn: async (productId: string) => {\n      return apiRequest('DELETE', `/api/products/${productId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${id}/products`] });\n      // Invalidate all product-counts queries\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === '/api/projects/product-counts'\n      });\n      setIsProductDialogOpen(false);\n      setSelectedProduct(null);\n      toast({\n        title: \"Produkt gelscht\",\n        description: \"Das Produkt wurde erfolgreich gelscht.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Fehler\",\n        description: error.message || \"Produkt konnte nicht gelscht werden.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDeleteProduct = (e: React.MouseEvent, productId: string) => {\n    e.stopPropagation();\n    if (confirm(\"Mchten Sie dieses Produkt wirklich lschen?\")) {\n      deleteProductMutation.mutate(productId);\n    }\n  };\n\n  const handleProductClick = (product: ProductInProject) => {\n    setSelectedProduct(product);\n    setIsProductDialogOpen(true);\n  };\n\n  const handleOpenPixiDialog = async () => {\n    try {\n      const response = await apiRequest('GET', '/api/suppliers');\n      const data = await response.json() as { suppliers: Array<{ id: string; name: string; supplNr?: string }> };\n      \n      if (data.suppliers && data.suppliers.length > 0) {\n        const suppliersWithNr = data.suppliers.filter((s: { id: string; name: string; supplNr?: string }) => s.supplNr);\n        \n        if (suppliersWithNr.length >= 1) {\n          setPixiSupplNr(suppliersWithNr[0].supplNr || '');\n        } else {\n          setPixiSupplNr('');\n        }\n      } else {\n        setPixiSupplNr('');\n      }\n    } catch (error) {\n      console.error('Error loading suppliers:', error);\n      toast({\n        title: \"Hinweis\",\n        description: \"Lieferanten konnten nicht geladen werden\",\n        variant: \"default\",\n      });\n    }\n    \n    setIsPixiDialogOpen(true);\n  };\n\n  const handleBrickfoxPreview = () => {\n    setIsBrickfoxPreviewOpen(true);\n  };\n\n  const handleBrickfoxExport = async () => {\n    try {\n      toast({\n        title: \"Export gestartet\",\n        description: \"Brickfox CSV wird generiert...\",\n      });\n\n      await apiDownload(\n        '/api/brickfox/export',\n        { projectId: id },\n        `brickfox-export-${id}.csv`\n      );\n\n      toast({\n        title: \"Export erfolgreich\",\n        description: \"Brickfox CSV wurde heruntergeladen\",\n      });\n      \n      setIsBrickfoxPreviewOpen(false);\n    } catch (error) {\n      console.error('[Brickfox Export] Error:', error);\n      toast({\n        title: \"Export fehlgeschlagen\",\n        description: \"Fehler beim Exportieren der Brickfox CSV\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handlePixiCompare = async () => {\n    if (!pixiSupplNr) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie eine Lieferantennummer ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setPixiLoading(true);\n    setPixiResults(null);\n\n    try {\n      // Convert project products to CSV format expected by Pixi API\n      const csvProducts = products.map(p => ({\n        Artikelnummer: p.customAttributes?.find(a => a.key === 'artikelnummer')?.value || p.articleNumber || '',\n        Produktname: p.name || '',\n        EAN: p.customAttributes?.find(a => a.key === 'ean')?.value || '',\n        Hersteller: p.customAttributes?.find(a => a.key === 'hersteller')?.value || '',\n      }));\n\n      const token = localStorage.getItem('supabase_token');\n      const response = await fetch('/api/pixi/compare-json', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          products: csvProducts,\n          supplNr: pixiSupplNr,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok || !data.success) {\n        throw new Error(data.error || 'Vergleich fehlgeschlagen');\n      }\n\n      setPixiResults(data);\n      setIsPixiDialogOpen(false);\n      setActiveTab('pixi');\n      \n      toast({\n        title: \"Pixi-Vergleich abgeschlossen\",\n        description: `${data.summary.neu} neue, ${data.summary.vorhanden} vorhandene Produkte`,\n      });\n    } catch (err: any) {\n      toast({\n        title: \"Fehler\",\n        description: err.message || 'Pixi-Vergleich fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setPixiLoading(false);\n    }\n  };\n\n  const downloadPixiResults = () => {\n    if (!pixiResults) return;\n\n    const csvContent = [\n      ['Artikelnummer', 'Produktname', 'EAN', 'Hersteller', 'Pixi Status'].join(';'),\n      ...pixiResults.products.map((p: any) => \n        [\n          p.artikelnummer,\n          `\"${p.produktname}\"`,\n          p.ean,\n          p.hersteller,\n          p.pixi_status\n        ].join(';')\n      )\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    link.href = URL.createObjectURL(blob);\n    link.download = `${project?.name || 'projekt'}_pixi-vergleich.csv`;\n    link.click();\n  };\n\n  const handleExportProject = () => {\n    if (products.length === 0) {\n      toast({\n        title: \"Keine Produkte\",\n        description: \"Es gibt keine Produkte zum Exportieren.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const enabledColumns = selectedColumns.filter(col => col.enabled);\n    \n    // Get the base URL for images\n    const baseUrl = window.location.origin;\n    \n    const csvData = products.map(product => {\n      const row: Record<string, string> = {};\n      enabledColumns.forEach(col => {\n        if (col.field.startsWith('custom_')) {\n          // Handle custom attributes\n          const attrKey = col.field.replace('custom_', '');\n          const customAttr = product.customAttributes?.find(attr => attr.key === attrKey);\n          row[col.label] = customAttr?.value || '';\n        } else {\n          const value = product[col.field as keyof ProductInProject];\n          \n          // Special handling for specific fields\n          if (col.field === 'createdAt' && value) {\n            row[col.label] = format(new Date(value as string), \"dd.MM.yyyy HH:mm\");\n          } else if (col.field === 'files' && Array.isArray(value)) {\n            // Convert all image filenames to full URLs\n            row[col.label] = value.map((f: any) => {\n              const filename = f.fileName || f.filename || '';\n              if (filename) {\n                return `${baseUrl}/product-images/${filename}`;\n              }\n              return '';\n            }).filter(url => url).join(', ');\n          } else if (col.field === 'ean' || col.field === 'manufacturer' || col.field === 'category' || \n                     col.field === 'vk' || col.field === 'ek' || col.field === 'uvp' ||\n                     col.field === 'weight' || col.field === 'height' || col.field === 'width' || col.field === 'length') {\n            // Try to extract from extractedData first\n            if (product.extractedData && product.extractedData.length > 0) {\n              try {\n                const extracted = JSON.parse(product.extractedData[0].extractedText || '{}');\n                row[col.label] = extracted[col.field] || '';\n              } catch {\n                row[col.label] = '';\n              }\n            } else {\n              row[col.label] = '';\n            }\n          } else {\n            row[col.label] = String(value || '');\n          }\n        }\n      });\n      return row;\n    });\n\n    const csv = Papa.unparse(csvData, {\n      delimiter: \";\",\n      header: true,\n    });\n\n    const blob = new Blob([csv], { type: \"text/csv;charset=utf-8;\" });\n    const link = document.createElement(\"a\");\n    const url = URL.createObjectURL(blob);\n    link.setAttribute(\"href\", url);\n    link.setAttribute(\"download\", `${project?.name || 'projekt'}_export.csv`);\n    link.style.visibility = \"hidden\";\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n\n    setIsExportDialogOpen(false);\n    toast({\n      title: \"Export erfolgreich\",\n      description: `${products.length} Produkt${products.length !== 1 ? 'e' : ''} wurden exportiert.`,\n    });\n  };\n\n  if (!project && !isLoadingProject && !isLoadingProducts) {\n    return (\n      <div className=\"h-full flex items-center justify-center\">\n        <div className=\"text-center\">\n          <h2 className=\"text-2xl font-bold mb-2\">Projekt nicht gefunden</h2>\n          <Button onClick={() => setLocation('/projects')} data-testid=\"button-back-to-projects\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Zurck zu Projekten\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 max-w-7xl\">\n        {/* Header */}\n        <div className=\"mb-6\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation('/projects')}\n            className=\"mb-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Zurck zu Projekten\n          </Button>\n\n          <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">{project?.name}</h1>\n              {project && (\n                <p className=\"text-muted-foreground mt-1 flex items-center gap-2\">\n                  <Calendar className=\"w-4 h-4\" />\n                  Erstellt am {format(new Date(project.createdAt), \"dd. MMMM yyyy\", { locale: de })}\n                </p>\n              )}\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={handleOpenPixiDialog}\n                disabled={products.length === 0}\n                data-testid=\"button-pixi-compare\"\n              >\n                <TrendingUp className=\"w-4 h-4 mr-2\" />\n                Mit Pixi vergleichen\n              </Button>\n              <Button\n                variant=\"default\"\n                onClick={handleBrickfoxPreview}\n                disabled={products.length === 0}\n                data-testid=\"button-brickfox-preview\"\n                className=\"bg-green-600 hover:bg-green-700\"\n              >\n                <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                Brickfox CSV Vorschau\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsExportDialogOpen(true)}\n                disabled={products.length === 0}\n                data-testid=\"button-export-project\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Projekt exportieren\n              </Button>\n              <Button\n                onClick={() => setLocation('/url-scraper')}\n                data-testid=\"button-add-product\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Neues Produkt\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Tabs fr verschiedene Ansichten */}\n        <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as \"products\" | \"pixi\")} className=\"mb-6\">\n          <TabsList>\n            <TabsTrigger value=\"products\" className=\"flex items-center gap-2\">\n              <FolderOpen className=\"w-4 h-4\" />\n              Produkte ({products.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"pixi\" className=\"flex items-center gap-2\" disabled={!pixiResults}>\n              <TrendingUp className=\"w-4 h-4\" />\n              Pixi Vergleich {pixiResults && `(${pixiResults.summary.total})`}\n            </TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"products\" className=\"mt-6\">\n            {/* Products Table */}\n            {isLoadingProducts ? (\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"animate-pulse space-y-4\">\n                    <div className=\"h-10 bg-muted rounded\"></div>\n                    <div className=\"h-10 bg-muted rounded\"></div>\n                    <div className=\"h-10 bg-muted rounded\"></div>\n                  </div>\n                </CardContent>\n              </Card>\n            ) : products.length === 0 ? (\n              <Card className=\"border-dashed\">\n                <CardContent className=\"flex flex-col items-center justify-center py-16\">\n                  <FolderOpen className=\"w-16 h-16 text-muted-foreground mb-4\" />\n                  <h3 className=\"text-lg font-semibold mb-2\">Noch keine Produkte</h3>\n                  <p className=\"text-muted-foreground text-center mb-6\">\n                    Fgen Sie Ihr erstes Produkt hinzu, um mit der Beschreibung zu beginnen\n                  </p>\n                  <Button\n                    onClick={() => setLocation('/url-scraper')}\n                    data-testid=\"button-add-first-product\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Produkt erstellen\n                  </Button>\n                </CardContent>\n              </Card>\n            ) : (\n              <Card>\n                <CardHeader>\n                  <CardTitle>Gescrapte Produktdaten</CardTitle>\n                  <CardDescription>{products.length} Produkte</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"border rounded-md overflow-auto max-h-[600px]\">\n                    <table className=\"w-full text-sm\">\n                      <thead className=\"bg-muted sticky top-0 z-10\">\n                        <tr>\n                          <th className=\"text-left p-3 font-medium sticky left-0 bg-muted z-20\">Produktname</th>\n                          <th className=\"text-left p-3 font-medium\">Artikelnr.</th>\n                          {/* Dynamic columns from extractedData */}\n                          {(() => {\n                            const allKeys = new Set<string>();\n                            products.forEach(product => {\n                              const extractedData = product.extractedData || [];\n                              console.log('Product extracted data:', product.id, extractedData);\n                              if (Array.isArray(extractedData)) {\n                                extractedData.forEach((item: any) => allKeys.add(item.key));\n                              } else if (typeof extractedData === 'object') {\n                                Object.keys(extractedData).forEach(key => allKeys.add(key));\n                              }\n                              // Also check customAttributes\n                              const customAttrs = product.customAttributes || [];\n                              console.log('Product custom attributes:', product.id, customAttrs);\n                              if (Array.isArray(customAttrs)) {\n                                customAttrs.forEach((item: any) => allKeys.add(item.key));\n                              } else if (typeof customAttrs === 'object') {\n                                Object.keys(customAttrs).forEach(key => allKeys.add(key));\n                              }\n                            });\n                            console.log('All unique keys found:', Array.from(allKeys));\n                            return Array.from(allKeys).map(key => (\n                              <th key={key} className=\"text-left p-3 font-medium whitespace-nowrap\">\n                                {key.charAt(0).toUpperCase() + key.slice(1)}\n                              </th>\n                            ));\n                          })()}\n                          <th className=\"text-left p-3 font-medium\">Erstellt</th>\n                          <th className=\"text-right p-3 font-medium sticky right-0 bg-muted z-20\">Aktionen</th>\n                        </tr>\n                      </thead>\n                      <tbody className=\"divide-y\">\n                        {products\n                          .slice((currentPage - 1) * productsPerPage, currentPage * productsPerPage)\n                          .map((product) => {\n                          const extractedData = product.extractedData || [];\n                          const customAttrs = product.customAttributes || [];\n                          \n                          const getExtractedValue = (key: string) => {\n                            // Try extractedData first\n                            if (Array.isArray(extractedData)) {\n                              const item = extractedData.find((d: any) => d.key === key) as any;\n                              if (item?.value) return item.value;\n                            } else if (typeof extractedData === 'object') {\n                              const value = (extractedData as any)[key];\n                              if (value) return value;\n                            }\n                            \n                            // Then try customAttributes\n                            if (Array.isArray(customAttrs)) {\n                              const item = customAttrs.find((d: any) => d.key === key) as any;\n                              if (item?.value) return item.value;\n                            } else if (typeof customAttrs === 'object') {\n                              const value = (customAttrs as any)[key];\n                              if (value) return value;\n                            }\n                            \n                            return '-';\n                          };\n\n                          // Get all unique keys from all products (including customAttributes)\n                          const allKeys = new Set<string>();\n                          products.forEach(p => {\n                            const data = p.extractedData || [];\n                            if (Array.isArray(data)) {\n                              data.forEach((item: any) => allKeys.add(item.key));\n                            } else if (typeof data === 'object') {\n                              Object.keys(data).forEach(key => allKeys.add(key));\n                            }\n                            \n                            const attrs = p.customAttributes || [];\n                            if (Array.isArray(attrs)) {\n                              attrs.forEach((item: any) => allKeys.add(item.key));\n                            } else if (typeof attrs === 'object') {\n                              Object.keys(attrs).forEach(key => allKeys.add(key));\n                            }\n                          });\n                          \n                          return (\n                            <tr key={product.id} className=\"hover:bg-muted/50\">\n                              <td className=\"p-3 max-w-[250px] truncate sticky left-0 bg-background z-10\">\n                                {product.name || product.exactProductName || '-'}\n                              </td>\n                              <td className=\"p-3\">{product.articleNumber || '-'}</td>\n                              {/* Dynamic columns */}\n                              {Array.from(allKeys).map(key => (\n                                <td key={key} className=\"p-3 max-w-[200px] truncate\">\n                                  {getExtractedValue(key)}\n                                </td>\n                              ))}\n                              <td className=\"p-3 text-xs text-muted-foreground whitespace-nowrap\">\n                                {format(new Date(product.createdAt), \"dd.MM.yyyy\", { locale: de })}\n                              </td>\n                              <td className=\"p-3 text-right sticky right-0 bg-background z-10\">\n                                <div className=\"flex justify-end gap-2\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => handleProductClick(product)}\n                                  >\n                                    <FileText className=\"w-4 h-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      handleDeleteProduct(e, product.id);\n                                    }}\n                                  >\n                                    <Trash2 className=\"w-4 h-4 text-destructive\" />\n                                  </Button>\n                                </div>\n                              </td>\n                            </tr>\n                          );\n                        })}\n                      </tbody>\n                    </table>\n                  </div>\n                  \n                  {/* Pagination Controls */}\n                  {products.length > productsPerPage && (\n                    <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30\">\n                      <div className=\"text-sm text-muted-foreground\">\n                        Zeige {((currentPage - 1) * productsPerPage) + 1} bis {Math.min(currentPage * productsPerPage, products.length)} von {products.length} Produkten\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n                          disabled={currentPage === 1}\n                        >\n                          Zurck\n                        </Button>\n                        <div className=\"flex items-center gap-1\">\n                          {Array.from({ length: Math.ceil(products.length / productsPerPage) }, (_, i) => i + 1).map((page) => (\n                            <Button\n                              key={page}\n                              variant={currentPage === page ? \"default\" : \"outline\"}\n                              size=\"sm\"\n                              onClick={() => setCurrentPage(page)}\n                              className=\"w-8 h-8 p-0\"\n                            >\n                              {page}\n                            </Button>\n                          ))}\n                        </div>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.min(Math.ceil(products.length / productsPerPage), currentPage + 1))}\n                          disabled={currentPage === Math.ceil(products.length / productsPerPage)}\n                        >\n                          Weiter\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"pixi\" className=\"mt-6\">\n            {pixiResults && (\n              <Card>\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <TrendingUp className=\"w-5 h-5\" />\n                        Pixi ERP Vergleich\n                      </CardTitle>\n                      <CardDescription>\n                        {pixiResults.summary.total} Produkte verglichen\n                      </CardDescription>\n                    </div>\n                    <Button onClick={downloadPixiResults} variant=\"outline\" size=\"sm\">\n                      <Download className=\"w-4 h-4 mr-2\" />\n                      CSV Export\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {/* Statistiken */}\n                  <div className=\"grid grid-cols-3 gap-4 mb-6\">\n                    <Card>\n                      <CardContent className=\"pt-6\">\n                        <div className=\"text-center\">\n                          <div className=\"text-2xl font-bold\">{pixiResults.summary.total}</div>\n                          <div className=\"text-xs text-muted-foreground\">Gesamt</div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"border-green-200 bg-green-50\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"text-center\">\n                          <div className=\"text-2xl font-bold text-green-700\">{pixiResults.summary.neu}</div>\n                          <div className=\"text-xs text-green-700\">Neu</div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                    <Card className=\"border-blue-200 bg-blue-50\">\n                      <CardContent className=\"pt-6\">\n                        <div className=\"text-center\">\n                          <div className=\"text-2xl font-bold text-blue-700\">{pixiResults.summary.vorhanden}</div>\n                          <div className=\"text-xs text-blue-700\">Vorhanden</div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  {/* Tabelle */}\n                  <div className=\"border rounded-md\">\n                    <div className=\"max-h-[500px] overflow-auto\">\n                      <table className=\"w-full\">\n                        <thead className=\"bg-muted sticky top-0\">\n                          <tr>\n                            <th className=\"text-left p-3 text-sm font-medium\">Status</th>\n                            <th className=\"text-left p-3 text-sm font-medium\">Artikelnummer</th>\n                            <th className=\"text-left p-3 text-sm font-medium\">Produktname</th>\n                            <th className=\"text-left p-3 text-sm font-medium\">EAN</th>\n                            <th className=\"text-left p-3 text-sm font-medium\">Hersteller</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {pixiResults.products.map((product: any, idx: number) => (\n                            <tr key={idx} className=\"border-t hover:bg-muted/50\">\n                              <td className=\"p-3\">\n                                {product.pixi_status === 'NEU' ? (\n                                  <Badge className=\"bg-green-100 text-green-800 hover:bg-green-200\">\n                                    <CheckCircle className=\"w-3 h-3 mr-1\" />\n                                    NEU\n                                  </Badge>\n                                ) : (\n                                  <Badge variant=\"secondary\">\n                                    <XCircle className=\"w-3 h-3 mr-1\" />\n                                    VORHANDEN\n                                  </Badge>\n                                )}\n                              </td>\n                              <td className=\"p-3 text-sm\">{product.artikelnummer}</td>\n                              <td className=\"p-3 text-sm\">{product.produktname}</td>\n                              <td className=\"p-3 text-sm font-mono text-xs\">{product.ean}</td>\n                              <td className=\"p-3 text-sm\">{product.hersteller}</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n        </Tabs>\n\n        {/* Pixi Comparison Dialog */}\n        <Dialog open={isPixiDialogOpen} onOpenChange={setIsPixiDialogOpen}>\n          <DialogContent data-testid=\"dialog-pixi-compare\">\n            <DialogHeader>\n              <DialogTitle>Mit Pixi ERP vergleichen</DialogTitle>\n              <DialogDescription>\n                Vergleichen Sie die Produkte dieses Projekts mit Ihrem Pixi ERP-System\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"pixi-supplnr\">Lieferantennummer</Label>\n                <Input\n                  id=\"pixi-supplnr\"\n                  placeholder=\"z.B. 7077\"\n                  value={pixiSupplNr}\n                  onChange={(e) => setPixiSupplNr(e.target.value)}\n                  disabled={pixiLoading}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  {products.length} Produkt{products.length !== 1 ? 'e' : ''} werden verglichen\n                </p>\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsPixiDialogOpen(false)}\n                disabled={pixiLoading}\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handlePixiCompare}\n                disabled={pixiLoading || !pixiSupplNr}\n              >\n                {pixiLoading ? (\n                  <>\n                    <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2\" />\n                    Vergleichen...\n                  </>\n                ) : (\n                  <>\n                    <TrendingUp className=\"w-4 h-4 mr-2\" />\n                    Vergleichen\n                  </>\n                )}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Product Detail Dialog */}\n        <Dialog open={isProductDialogOpen} onOpenChange={setIsProductDialogOpen}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-product-detail\">\n            <DialogHeader>\n              <DialogTitle>{selectedProduct?.name || 'Produktdetails'}</DialogTitle>\n              <DialogDescription>\n                {selectedProduct && format(new Date(selectedProduct.createdAt), \"dd. MMMM yyyy 'um' HH:mm 'Uhr'\", { locale: de })}\n              </DialogDescription>\n            </DialogHeader>\n            {selectedProduct && (\n              <div className=\"space-y-6 mt-4\">\n                {/* Custom Attributes */}\n                {selectedProduct.customAttributes && selectedProduct.customAttributes.length > 0 && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <FileText className=\"w-4 h-4\" />\n                      Produktattribute\n                    </h3>\n                    <div className=\"grid gap-3 md:grid-cols-2\">\n                      {selectedProduct.customAttributes.map((attr, idx) => (\n                        <div key={idx} className=\"rounded-md border p-3\">\n                          <div className=\"text-xs text-muted-foreground mb-1\">{attr.key}</div>\n                          <div className=\"text-sm\">{attr.value}</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* HTML Description */}\n                {selectedProduct.htmlCode && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <FileText className=\"w-4 h-4\" />\n                      HTML-Beschreibung\n                    </h3>\n                    <div \n                      className=\"prose prose-sm max-w-none border rounded-md p-4 bg-muted/30\"\n                      dangerouslySetInnerHTML={{ __html: selectedProduct.htmlCode }}\n                    />\n                  </div>\n                )}\n\n                {/* Preview Text */}\n                {selectedProduct.previewText && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <FileText className=\"w-4 h-4\" />\n                      Flietext\n                    </h3>\n                    <div className=\"border rounded-md p-4 bg-muted/30 text-sm whitespace-pre-wrap\">\n                      {selectedProduct.previewText}\n                    </div>\n                  </div>\n                )}\n\n                {/* Files */}\n                {selectedProduct.files && selectedProduct.files.length > 0 && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold mb-3 flex items-center gap-2\">\n                      <Upload className=\"w-4 h-4\" />\n                      Dateien ({selectedProduct.files.length})\n                    </h3>\n                    <div className=\"space-y-2\">\n                      {selectedProduct.files.map((file: any, idx: number) => (\n                        <div key={idx} className=\"flex items-center gap-2 text-sm border rounded-md p-2\">\n                          <FileText className=\"w-4 h-4 text-muted-foreground\" />\n                          <span>{file.fileName || file.filename || `Datei ${idx + 1}`}</span>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button\n                    variant=\"destructive\"\n                    onClick={(e) => {\n                      if (confirm(\"Mchten Sie dieses Produkt wirklich lschen?\")) {\n                        deleteProductMutation.mutate(selectedProduct.id);\n                      }\n                    }}\n                    disabled={deleteProductMutation.isPending}\n                  >\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    {deleteProductMutation.isPending ? \"Wird gelscht...\" : \"Produkt lschen\"}\n                  </Button>\n                  <Button onClick={() => setIsProductDialogOpen(false)}>\n                    Schlieen\n                  </Button>\n                </div>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        {/* Export Dialog */}\n        <Dialog open={isExportDialogOpen} onOpenChange={setIsExportDialogOpen}>\n          <DialogContent data-testid=\"dialog-export-project\">\n            <DialogHeader>\n              <DialogTitle>Projekt exportieren</DialogTitle>\n              <DialogDescription>\n                Whlen Sie die Spalten fr den CSV-Export\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 mt-4\">\n              {/* Select All Controls */}\n              <div className=\"flex items-center gap-4 pb-3 border-b\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setSelectedColumns(prev => {\n                      const updated = [...prev];\n                      dynamicColumns.forEach(dynCol => {\n                        const existingIndex = updated.findIndex(col => col.id === dynCol.id);\n                        if (existingIndex >= 0) {\n                          updated[existingIndex] = { ...updated[existingIndex], enabled: true };\n                        } else {\n                          updated.push({ ...dynCol, enabled: true });\n                        }\n                      });\n                      return updated;\n                    });\n                  }}\n                >\n                  Alle auswhlen\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    setSelectedColumns(prev => {\n                      const updated = [...prev];\n                      dynamicColumns.forEach(dynCol => {\n                        const existingIndex = updated.findIndex(col => col.id === dynCol.id);\n                        if (existingIndex >= 0) {\n                          updated[existingIndex] = { ...updated[existingIndex], enabled: false };\n                        } else {\n                          updated.push({ ...dynCol, enabled: false });\n                        }\n                      });\n                      return updated;\n                    });\n                  }}\n                >\n                  Alle abwhlen\n                </Button>\n                <span className=\"text-xs text-muted-foreground\">\n                  {selectedColumns.filter(col => col.enabled).length} von {dynamicColumns.length} ausgewhlt\n                </span>\n              </div>\n\n              {/* Column List */}\n              <div className=\"max-h-60 overflow-y-auto space-y-2\">\n                {dynamicColumns.map((col) => {\n                  const selectedCol = selectedColumns.find(sc => sc.id === col.id);\n                  const isChecked = selectedCol ? selectedCol.enabled : col.enabled;\n                  \n                  return (\n                    <div key={col.id} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={col.id}\n                        checked={isChecked}\n                        onCheckedChange={(checked) => {\n                          setSelectedColumns(prev =>\n                            prev.map(c => c.id === col.id ? { ...c, enabled: !!checked } : c)\n                          );\n                        }}\n                        data-testid={`checkbox-export-${col.id}`}\n                      />\n                      <Label htmlFor={col.id} className=\"text-sm font-normal cursor-pointer\">\n                        {col.label}\n                        {col.field.startsWith('custom_') && (\n                          <span className=\"ml-2 text-xs text-muted-foreground\">(Custom)</span>\n                        )}\n                      </Label>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2 mt-6\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsExportDialogOpen(false)}\n                data-testid=\"button-cancel-export\"\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handleExportProject}\n                disabled={!selectedColumns.some(col => col.enabled)}\n                data-testid=\"button-confirm-export\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Exportieren\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Brickfox Preview Dialog */}\n        <Dialog open={isBrickfoxPreviewOpen} onOpenChange={setIsBrickfoxPreviewOpen}>\n          <DialogContent className=\"max-w-7xl max-h-[90vh] overflow-auto\">\n            <BrickfoxDataPreview \n              products={products || []}\n              projectName={project?.name}\n              projectId={id}\n            />\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":46268},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/brickfox-data-preview.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Download, RefreshCw, Eye, Settings } from \"lucide-react\";\nimport type { ProductInProject } from \"@shared/schema\";\nimport { apiDownload, apiPost } from \"@/lib/api\";\n\ninterface BrickfoxRow {\n  [key: string]: string | number | boolean | null;\n}\n\ninterface BrickfoxDataPreviewProps {\n  products: ProductInProject[];\n  projectName?: string;\n  projectId: string; // Required for backend export\n  supplierId?: string;\n}\n\nexport default function BrickfoxDataPreview({ products, projectName, projectId, supplierId }: BrickfoxDataPreviewProps) {\n  const [brickfoxData, setBrickfoxData] = useState<BrickfoxRow[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [visibleColumns, setVisibleColumns] = useState<string[]>([]);\n  const [allColumns, setAllColumns] = useState<string[]>([]);\n  const [isColumnDialogOpen, setIsColumnDialogOpen] = useState(false);\n\n  // Load Brickfox preview data from API\n  const loadPreviewData = async () => {\n    if (!projectId) {\n      setError('No project ID provided');\n      return;\n    }\n\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      const data = await apiPost<{ success: boolean; rows: any[]; error?: string }>(\n        '/api/brickfox/preview',\n        { projectId, supplierId }\n      );\n      \n      if (!data.success) {\n        throw new Error(data.error || 'Failed to generate Brickfox preview');\n      }\n\n      setBrickfoxData(data.rows || []);\n\n      // Extract all column names from first row\n      if (data.rows && data.rows.length > 0) {\n        const columns = Object.keys(data.rows[0]);\n        setAllColumns(columns);\n        \n        // Show important columns by default\n        const defaultColumns = columns.filter(col => \n          col.includes('p_item_number') ||\n          col.includes('p_name') ||\n          col.includes('v_manufacturers_item_number') ||\n          col.includes('v_supplier_item_number') ||\n          col.includes('v_ean') ||\n          col.includes('v_purchase_price') ||\n          col.includes('v_price[Eur]') ||\n          col.includes('p_brand')\n        );\n        setVisibleColumns(defaultColumns.length > 0 ? defaultColumns : columns.slice(0, 10));\n      }\n    } catch (err: any) {\n      console.error('[Brickfox Preview] Error:', err);\n      setError(err.message || 'Failed to load Brickfox preview');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // Load data on mount\n  useEffect(() => {\n    loadPreviewData();\n  }, [projectId, supplierId]);\n\n  // Handle column toggle\n  const handleColumnToggle = (column: string) => {\n    setVisibleColumns(prev => {\n      if (prev.includes(column)) {\n        return prev.filter(c => c !== column);\n      } else {\n        return [...prev, column];\n      }\n    });\n  };\n\n  // Export to CSV via Backend API (ensures exact parity with preview)\n  const handleExport = async () => {\n    if (!projectId) {\n      alert('Projekt-ID fehlt - Export nicht mglich');\n      return;\n    }\n\n    try {\n      // Use same parameters as preview to ensure parity\n      await apiDownload(\n        '/api/brickfox/export',\n        { projectId, supplierId },\n        `brickfox-export-${projectId}.csv`\n      );\n    } catch (error) {\n      console.error('[Brickfox Export] Error:', error);\n      alert('Export fehlgeschlagen');\n    }\n  };\n\n  // Filtered data (only visible columns)\n  const filteredData = brickfoxData.map(row => {\n    const filteredRow: BrickfoxRow = {};\n    visibleColumns.forEach(col => {\n      filteredRow[col] = row[col];\n    });\n    return filteredRow;\n  });\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle>Brickfox CSV Vorschau</CardTitle>\n            <CardDescription>\n              Vorschau der Brickfox-Exportdaten mit Fixed Values und Auto-Generate Feldern\n              {brickfoxData.length > 0 && `  ${brickfoxData.length} Produkte  ${allColumns.length} Spalten`}\n            </CardDescription>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" size=\"sm\" onClick={loadPreviewData} disabled={isLoading}>\n              <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />\n              Neu laden\n            </Button>\n            <Dialog open={isColumnDialogOpen} onOpenChange={setIsColumnDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\">\n                  <Settings className=\"h-4 w-4 mr-2\" />\n                  Spalten ({visibleColumns.length}/{allColumns.length})\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Sichtbare Spalten auswhlen</DialogTitle>\n                </DialogHeader>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  {allColumns.map(column => (\n                    <div key={column} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={column}\n                        checked={visibleColumns.includes(column)}\n                        onCheckedChange={() => handleColumnToggle(column)}\n                      />\n                      <Label htmlFor={column} className=\"text-sm cursor-pointer\">\n                        {column}\n                      </Label>\n                    </div>\n                  ))}\n                </div>\n                <div className=\"flex justify-end gap-2 mt-4\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setVisibleColumns(allColumns)}\n                  >\n                    Alle auswhlen\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setVisibleColumns([])}\n                  >\n                    Alle abwhlen\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n            <Button onClick={handleExport} disabled={isLoading || brickfoxData.length === 0}>\n              <Download className=\"h-4 w-4 mr-2\" />\n              CSV Exportieren\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading && (\n          <div className=\"flex items-center justify-center py-12\">\n            <RefreshCw className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n            <span className=\"ml-3 text-muted-foreground\">Lade Brickfox-Daten...</span>\n          </div>\n        )}\n\n        {error && (\n          <div className=\"bg-red-50 border border-red-200 rounded-md p-4\">\n            <p className=\"text-red-800 font-medium\">Fehler beim Laden der Daten</p>\n            <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n            <Button onClick={loadPreviewData} variant=\"outline\" size=\"sm\" className=\"mt-3\">\n              Erneut versuchen\n            </Button>\n          </div>\n        )}\n\n        {!isLoading && !error && brickfoxData.length === 0 && (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Eye className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n            <p>Keine Daten vorhanden</p>\n          </div>\n        )}\n\n        {!isLoading && !error && brickfoxData.length > 0 && (\n          <div className=\"border rounded-md\">\n            <div className=\"overflow-x-auto max-h-[600px]\">\n              <Table>\n                <TableHeader className=\"sticky top-0 bg-background\">\n                  <TableRow>\n                    {visibleColumns.map(column => (\n                      <TableHead key={column} className=\"min-w-[150px] font-semibold\">\n                        {column}\n                      </TableHead>\n                    ))}\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredData.map((row, index) => (\n                    <TableRow key={index}>\n                      {visibleColumns.map(column => (\n                        <TableCell key={column} className=\"max-w-[300px]\">\n                          <div className=\"truncate\" title={String(row[column] || '')}>\n                            {row[column] !== null && row[column] !== undefined ? String(row[column]) : '-'}\n                          </div>\n                        </TableCell>\n                      ))}\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":9327},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  define: {\n    'import.meta.env.VITE_SUPABASE_URL': JSON.stringify(\n      process.env.VITE_SUPABASE_URL || 'https://lxemqwvdaxzeldpjmxoc.supabase.co'\n    ),\n    'import.meta.env.VITE_SUPABASE_ANON_KEY': JSON.stringify(\n      process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4ZW1xd3ZkYXh6ZWxkcGpteG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MTM3MDgsImV4cCI6MjA3NzM4OTcwOH0.Skn1wZFzXEIbYi-CEE7VxJfL2zzkuHjAoSC6eRmM6Ts'\n    ),\n  },\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n    sourcemap: false,  // Disable source maps in dev to reduce CPU\n  },\n  optimizeDeps: {\n    exclude: ['lucide-react'],  // Don't pre-bundle heavy icon libraries\n  },\n  server: {\n    host: '0.0.0.0',\n    port: 5000,\n    strictPort: false,\n    hmr: {\n      clientPort: 443,\n    },\n    watch: {\n      usePolling: false,  // Disable polling, use native file system events\n      interval: 1000,     // Slower polling if needed\n    },\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n  preview: {\n    host: '0.0.0.0',\n    port: 5000,\n  },\n  base: '/',\n});\n","size_bytes":2049},"API-SETUP.md":{"content":"# OpenAI API-Schlssel einrichten\r\n\r\n## Schritt 1: API-Schlssel erhalten\r\n1. Gehe zu [https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)\r\n2. Melde dich an oder erstelle ein Konto\r\n3. Klicke auf \"Create new secret key\"\r\n4. Kopiere den generierten API-Schlssel\r\n\r\n## Schritt 2: API-Schlssel in der App konfigurieren\r\n1. ffne die Datei `config/api-keys.js`\r\n2. Ersetze `'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'` mit deinem echten API-Schlssel\r\n3. Speichere die Datei\r\n\r\n## Schritt 3: Server neu starten\r\n```powershell\r\n$env:NODE_ENV=\"development\"; npx tsx server/index.ts\r\n```\r\n\r\n## Was die AI-Features bieten:\r\n-  Automatische Produktbeschreibungen aus CSV-Daten\r\n-  Bildanalyse fr Screenshots und Produktfotos  \r\n-  PDF-Text-Extraktion und -Analyse\r\n-  Intelligente Produktnamen-Generierung\r\n-  HTML-Formatierung von Produktbeschreibungen\r\n\r\n**Hinweis:** Ohne API-Schlssel funktionieren alle anderen Features (CSV-Upload, Tabellen-Management, etc.) weiterhin normal - nur die AI-gesttzten Features sind dann nicht verfgbar.\r\n","size_bytes":1209},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"design_guidelines.md":{"content":"# Design Guidelines: MediaMarkt CSV Enricher\n\n## Design Approach: Function-First Data Processing Tool\n\n**Selected System:** Material Design with clean, German enterprise aesthetics  \n**Rationale:** Data-heavy utility application requiring clarity, efficiency, and reliable interaction patterns for CSV processing workflows.\n\n**Core Principles:**\n- Clarity over decoration\n- Immediate functional feedback\n- Scannable data presentation\n- Error prevention and clear recovery\n\n---\n\n## Color Palette\n\n**Light Mode:**\n- Background: 240 5% 98%\n- Surface: 0 0% 100%\n- Primary: 210 90% 48% (professional blue)\n- Success: 142 76% 36%\n- Error: 0 84% 60%\n- Warning: 38 92% 50%\n- Text Primary: 220 13% 18%\n- Text Secondary: 220 9% 46%\n- Border: 220 13% 91%\n\n**Dark Mode:**\n- Background: 222 47% 11%\n- Surface: 217 33% 17%\n- Primary: 210 90% 58%\n- Success: 142 76% 46%\n- Error: 0 84% 70%\n- Warning: 38 92% 60%\n- Text Primary: 210 20% 98%\n- Text Secondary: 215 20% 65%\n- Border: 217 33% 25%\n\n---\n\n## Typography\n\n**Font Family:** Inter (Google Fonts) for interface, JetBrains Mono for data/SKU display\n\n**Scale:**\n- Heading (H1): text-3xl font-bold (page title)\n- Section Header (H2): text-xl font-semibold\n- Table Header: text-sm font-medium uppercase tracking-wide\n- Body: text-sm\n- Data/Monospace: text-sm font-mono (for SKUs, technical specs)\n- Helper Text: text-xs text-secondary\n\n---\n\n## Layout System\n\n**Spacing Primitives:** Use Tailwind units of 2, 4, 6, 8, 12, 16  \n**Container:** max-w-7xl mx-auto px-6  \n**Section Padding:** py-6 to py-8  \n**Card Spacing:** p-6  \n**Table Cell Padding:** px-4 py-3\n\n---\n\n## Component Library\n\n### File Upload Zone\n- Dashed border (border-dashed) with hover state\n- Large drop area (min-h-64)\n- Upload icon centered with instructional text\n- File type restriction visible: \"Nur CSV-Dateien (.csv)\"\n- Drag-over state with highlighted border (primary color)\n- Selected file preview with name and size\n\n### Processing States\n- Loading spinner with animated pulse\n- Progress indication: \"X von Y Zeilen verarbeitet\"\n- Error alerts with clear, actionable messages in German\n- Success confirmation with data count\n\n### Data Table\n- Sticky header row\n- Alternating row backgrounds (subtle zebra striping)\n- Editable cells with inline editing (click to edit)\n- Duplicate row highlighting with warning-colored left border (4px)\n- Column headers: Artikelnummer, Produktname, Produktbeschreibung, MediaMarkt Titel, Spannung, Kapazitt, Energiegehalt, Leistung\n- Horizontal scroll for overflow (overflow-x-auto)\n- Monospace font for SKU/technical values\n- Truncated text with tooltip on hover for long descriptions\n\n### Buttons\n- Primary: Download CSV (solid primary color)\n- Secondary: File upload trigger\n- Size: px-6 py-3 for primary actions\n- Clear icons (Download, Upload from lucide-react)\n\n### Status Indicators\n- Duplicate badge: Small pill with warning background\n- Processing count: \"X Produkte verarbeitet\"\n- File info: Name, size, encoding detected\n\n---\n\n## Animations\n\n**Minimal, Functional Only:**\n- Subtle fade-in for loaded data (duration-300)\n- Smooth row hover states (transition-colors)\n- Button press feedback (active:scale-98)\n- No decorative animations\n\n---\n\n## Layout Structure\n\n1. **Header Section** (sticky)\n   - App title: \"MediaMarkt CSV Produktdaten-Anreicherung\"\n   - Brief description of functionality\n\n2. **Upload Area** (prominent when no data)\n   - Large drop zone centered\n   - File requirements clearly stated\n   - Sample CSV format hint\n\n3. **Data Processing View** (when file uploaded)\n   - Processing status bar\n   - Error messages (if any) in alert component\n   - Action buttons: Download, Clear/Reset\n\n4. **Data Table Section** (full width)\n   - Responsive table container\n   - All enriched columns visible\n   - Inline editing capability\n   - Duplicate indicators\n\n5. **Footer**\n   - Export button (always accessible when data present)\n   - Summary statistics: Total products, duplicates found\n\n---\n\n## German Language Requirements\n\n- All interface text in German\n- Button labels: \"Hochladen\", \"CSV Exportieren\", \"Zurcksetzen\"\n- Error messages in German\n- Date/number formatting per German locale\n\n---\n\n## Accessibility & Data Integrity\n\n- Clear focus states on all interactive elements\n- Keyboard navigation for table cells\n- ARIA labels for icon-only buttons\n- Color is not the only indicator (icons + text for duplicates)\n- High contrast maintained in both modes\n- Monospace fonts ensure data alignment and readability","size_bytes":4480},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"PRESENTATION.md":{"content":"# CodeCSVUpload App - Prsentation\r\n\r\n##  Was ist die App?\r\n\r\n**Automatisierte Produktbeschreibungs-Generierung mit KI**\r\n- Upload von PDFs, CSVs, Bildern oder URLs\r\n- KI extrahiert automatisch Produktdaten\r\n- Generiert strukturierte HTML-Beschreibungen\r\n- Export fr Shop-Systeme\r\n\r\n##  Technische Architektur\r\n\r\n```\r\n        \r\n   Frontend              Backend             External      \r\n   React + TS       Node.js + TS     Services      \r\n   Port: 3000           Port: 5000                         \r\n        \r\n                                                       \r\n                                                       \r\n                                                       \r\n        \r\n   UI/UX                SQLite DB            OpenAI API    \r\n   Tailwind CSS         Prisma ORM           Firecrawl API \r\n        \r\n```\r\n\r\n##  Kernfunktionen\r\n\r\n### **1. Multi-Format Support**\r\n-  **PDF**: Produktkataloge automatisch lesen\r\n-  **CSV**: Tabellendaten importieren\r\n-  **Bilder**: OCR fr Produktbilder\r\n-  **URLs**: Direktes Web-Scraping\r\n\r\n### **2. KI-basierte Verarbeitung**\r\n-  **GPT-4o**: Intelligente Texterstellung\r\n-  **GPT Vision**: Bildanalyse\r\n-  **Automatische Extraktion**: Technische Daten\r\n-  **Strukturierung**: HTML-Formatierung\r\n\r\n### **3. Workflow-Integration**\r\n-  **Projekt-Management**: Mehrere Produkte verwalten\r\n-  **Export-Funktionen**: Fr Shop-Systeme\r\n-  **API-Endpoints**: Fr externe Integration\r\n\r\n##  Deployment-Optionen\r\n\r\n### **Option 1: Cloud (Empfohlen)**\r\n- **Frontend**: Vercel/Netlify (kostenlos)\r\n- **Backend**: Railway/Render ($10-20/Monat)\r\n- **Datenbank**: PlanetScale/Supabase (kostenlos)\r\n\r\n### **Option 2: On-Premise**\r\n- **Server**: Windows/Linux Server\r\n- **Datenbank**: SQL Server/PostgreSQL\r\n- **Wartung**: Interne IT-Abteilung\r\n\r\n### **Option 3: Hybrid**\r\n- **Frontend**: Cloud\r\n- **Backend**: On-Premise\r\n- **Datenbank**: Lokal\r\n\r\n##  Kostenstruktur\r\n\r\n### **Einmalige Kosten**\r\n-  **Entwicklung**: Bereits abgeschlossen\r\n-  **Setup**: 1-2 Tage IT-Aufwand\r\n-  **Training**: 2-4 Stunden pro Nutzer\r\n\r\n### **Laufende Kosten**\r\n- **OpenAI API**: ~$0.01-0.05 pro Produkt\r\n- **Firecrawl API**: ~$0.001 pro URL\r\n- **Hosting**: $10-50/Monat\r\n\r\n### **ROI**\r\n- **Zeitersparnis**: 80-90% (30-60 Min  5-10 Min)\r\n- **Qualitt**: Konsistente, vollstndige Beschreibungen\r\n- **Skalierung**: Unbegrenzte Produktanzahl\r\n\r\n##  Sicherheit & Compliance\r\n\r\n### **Datenverarbeitung**\r\n-  **Lokal**: Keine Cloud-Datenbertragung\r\n-  **Verschlsselt**: API-Keys sicher gespeichert\r\n-  **GDPR**: Konforme lokale Speicherung\r\n\r\n### **Zugriffskontrolle**\r\n-  **Benutzer-Management**: Rollenbasierte Rechte\r\n-  **Audit-Logs**: Vollstndige Nachverfolgung\r\n-  **Backup**: Automatische Datensicherung\r\n\r\n##  Performance & Skalierung\r\n\r\n### **Aktuelle Kapazitt**\r\n- **Concurrent Users**: 10-20\r\n- **Dateigre**: 50MB pro Upload\r\n- **Verarbeitungszeit**: 10-30 Sekunden pro Produkt\r\n\r\n### **Skalierungsoptionen**\r\n- **PostgreSQL**: Fr mehr Nutzer\r\n- **Redis**: Caching fr Performance\r\n- **Queue System**: Batch-Processing\r\n- **CDN**: Fr statische Assets\r\n\r\n##  Integration in bestehende Systeme\r\n\r\n### **Shop-Systeme**\r\n- **Shopware**: CSV/JSON Export\r\n- **Magento**: API-Integration\r\n- **WooCommerce**: WordPress Plugin\r\n\r\n### **PIM-Systeme**\r\n- **Akeneo**: API-Connector\r\n- **Pimcore**: Custom Integration\r\n- **inRiver**: Export-Funktionen\r\n\r\n### **ERP-Systeme**\r\n- **SAP**: Custom Connector\r\n- **Microsoft Dynamics**: API-Integration\r\n- **Oracle**: Custom Module\r\n\r\n##  Roadmap\r\n\r\n### **Phase 1 (1-3 Monate)**\r\n- Bulk-Processing fr groe Kataloge\r\n- Template-System fr verschiedene Produkttypen\r\n- Erweiterte Export-Formate\r\n\r\n### **Phase 2 (3-6 Monate)**\r\n- Multi-Language Support\r\n- Advanced AI Prompts\r\n- ERP-Integration\r\n\r\n### **Phase 3 (6-12 Monate)**\r\n- Machine Learning fr bessere Extraktion\r\n- Automatische Produktkategorisierung\r\n- Real-time Collaboration\r\n\r\n##  Business Value\r\n\r\n### **Fr Produktmanager**\r\n- Schnelle Katalog-Verarbeitung\r\n- Konsistente Produktdaten\r\n- Reduzierte manuelle Arbeit\r\n\r\n### **Fr Content-Team**\r\n- Hochwertige Beschreibungen\r\n- SEO-optimierte Texte\r\n- Einheitliche Formatierung\r\n\r\n### **Fr IT-Team**\r\n- Einfache Integration\r\n- Skalierbare Architektur\r\n- Wartungsfreundlich\r\n\r\n##  Hufige Fragen\r\n\r\n### **Q: Wie sicher sind die Daten?**\r\nA: Alle Daten werden lokal verarbeitet und gespeichert. Keine Cloud-bertragung.\r\n\r\n### **Q: Kann die App offline arbeiten?**\r\nA: Ja, nach dem ersten Setup funktioniert die App vollstndig offline.\r\n\r\n### **Q: Wie viele Produkte kann die App verarbeiten?**\r\nA: Unbegrenzt. Die App skaliert automatisch mit der Datenbank.\r\n\r\n### **Q: Brauchen wir eine Internetverbindung?**\r\nA: Nur fr KI-Services (OpenAI). Lokale Verarbeitung funktioniert offline.\r\n\r\n### **Q: Wie lange dauert die Einrichtung?**\r\nA: 1-2 Tage fr Setup + 2-4 Stunden Training pro Nutzer.\r\n\r\n##  Nchste Schritte\r\n\r\n1. **Demo**: Live-Demonstration der App\r\n2. **Pilot**: Test mit 10-20 Produkten\r\n3. **Rollout**: Schrittweise Einfhrung\r\n4. **Training**: Schulung der Nutzer\r\n5. **Integration**: Anbindung an bestehende Systeme\r\n","size_bytes":6084},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/pages/credentials.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport CredentialsManager from \"@/components/credentials-manager\";\n\nexport default function CredentialsPage() {\n  const [, setLocation] = useLocation();\n\n  return (\n    <div className=\"container mx-auto py-8 max-w-4xl\">\n      <div className=\"mb-6\">\n        <Button\n          variant=\"outline\"\n          onClick={() => setLocation('/')}\n          className=\"mb-4\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Zurck zur bersicht\n        </Button>\n        <h1 className=\"text-3xl font-bold\">API Credentials</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Verwalten Sie Ihre API-Schlssel fr OpenAI, Pixi, Channel-Engine und Brickfox\n        </p>\n      </div>\n\n      <CredentialsManager />\n    </div>\n  );\n}\n","size_bytes":916},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"TECHNICAL-OVERVIEW.md":{"content":"# Technische bersicht: CodeCSVUpload App\r\n\r\n##  Architektur & Technologie-Stack\r\n\r\n### **Frontend (Client)**\r\n- **Framework**: React 18 mit TypeScript\r\n- **Build Tool**: Vite (schneller als Webpack)\r\n- **UI Framework**: Tailwind CSS + shadcn/ui Komponenten\r\n- **State Management**: React Query (TanStack Query) fr API-Calls\r\n- **Port**: 3000 (Development)\r\n\r\n### **Backend (Server)**\r\n- **Runtime**: Node.js mit TypeScript\r\n- **Framework**: Express.js\r\n- **Build Tool**: tsx (TypeScript Execution)\r\n- **Port**: 5000 (Development)\r\n\r\n### **Datenbank**\r\n- **Typ**: SQLite (lokale Datei: `local.db`)\r\n- **ORM**: Prisma (Type-safe Database Access)\r\n- **Schema**: Automatische Migrationen\r\n\r\n### **AI & Machine Learning**\r\n- **OpenAI GPT-4o**: Produktbeschreibungen generieren\r\n- **OpenAI GPT Vision**: Bildanalyse und OCR\r\n- **Tesseract.js**: Fallback OCR fr Bilder\r\n- **Firecrawl API**: Web-Scraping von Produktseiten\r\n\r\n### **Dateiverarbeitung**\r\n- **PDF**: pdf-parse fr Text-Extraktion\r\n- **CSV**: csv-parser fr Tabellendaten\r\n- **Bilder**: Sharp fr Bildverarbeitung + OCR\r\n\r\n##  Kernfunktionalitten\r\n\r\n### **1. Multi-Format Upload**\r\n- PDF-Dokumente (Produktkataloge)\r\n- CSV-Dateien (Produktlisten)\r\n- Bilder (PNG, JPG) mit OCR\r\n- URLs (direktes Web-Scraping)\r\n\r\n### **2. KI-basierte Datenverarbeitung**\r\n- Automatische Produktname-Generierung\r\n- Technische Spezifikationen extrahieren\r\n- Strukturierte HTML-Beschreibungen erstellen\r\n- Einheitliche Formatierung (mm, g)\r\n\r\n### **3. Web-Scraping**\r\n- Firecrawl API fr professionelles Scraping\r\n- Fallback-Methoden bei Blockierung\r\n- Automatische Datenbereinigung\r\n- Bot-Erkennung umgehen\r\n\r\n### **4. Projekt-Management**\r\n- Mehrere Produkte pro Projekt\r\n- Versionskontrolle\r\n- Export-Funktionen\r\n\r\n##  Deployment & Workflow-Integration\r\n\r\n### **Lokale Entwicklung**\r\n```bash\r\nnpm run dev    # Startet Frontend (3000) + Backend (5000)\r\nnpm run build  # Production Build\r\nnpm start      # Production Server\r\n```\r\n\r\n### **Produktions-Deployment**\r\n\r\n#### **Option 1: Docker Container**\r\n```dockerfile\r\n# Dockerfile vorhanden\r\ndocker build -t codecsvupload .\r\ndocker run -p 5000:5000 codecsvupload\r\n```\r\n\r\n#### **Option 2: Cloud Deployment**\r\n- **Vercel/Netlify**: Frontend (Static)\r\n- **Railway/Render**: Backend (Node.js)\r\n- **PlanetScale/Supabase**: Datenbank (PostgreSQL)\r\n\r\n#### **Option 3: On-Premise Server**\r\n- Windows Server mit Node.js\r\n- IIS als Reverse Proxy\r\n- SQL Server statt SQLite\r\n\r\n### **Workflow-Integration**\r\n\r\n#### **Fr E-Commerce Teams**\r\n1. **Produktmanager**: Upload von Katalogen/CSVs\r\n2. **Content-Team**: KI-generierte Beschreibungen prfen/anpassen\r\n3. **IT-Team**: Export fr Shop-Systeme (Shopware, Magento)\r\n\r\n#### **API-Integration**\r\n```typescript\r\n// REST API Endpoints\r\nPOST /api/analyze-files     // Datei-Upload\r\nPOST /api/scrape-url        // URL-Scraping\r\nPOST /api/generate-description // KI-Generierung\r\nGET  /api/projects          // Projekt-Management\r\n```\r\n\r\n##  Sicherheit & Compliance\r\n\r\n### **API-Key Management**\r\n- Verschlsselte Speicherung (AES-256)\r\n- Sichere Credential-Verwaltung\r\n- Keine Hardcoded Keys\r\n\r\n### **Datenverarbeitung**\r\n- Lokale Verarbeitung (keine Cloud-Daten)\r\n- GDPR-konform (lokale Speicherung)\r\n- Automatische Datenbereinigung\r\n\r\n##  Performance & Skalierung\r\n\r\n### **Aktuelle Limits**\r\n- **Dateigre**: 50MB pro Upload\r\n- **Concurrent Users**: 10-20 (SQLite)\r\n- **API Calls**: OpenAI Rate Limits\r\n\r\n### **Skalierungsoptionen**\r\n- **PostgreSQL**: Fr mehr Nutzer\r\n- **Redis**: Caching fr bessere Performance\r\n- **Queue System**: Bull/Agenda fr Batch-Processing\r\n- **CDN**: Fr statische Assets\r\n\r\n##  Wartung & Monitoring\r\n\r\n### **Logging**\r\n- Strukturierte Logs (Winston)\r\n- Error Tracking\r\n- Performance Monitoring\r\n\r\n### **Updates**\r\n- Automatische Dependency Updates\r\n- Schema-Migrationen\r\n- Backward Compatibility\r\n\r\n##  Kostenstruktur\r\n\r\n### **Laufende Kosten**\r\n- **OpenAI API**: ~$0.01-0.05 pro Produkt\r\n- **Firecrawl API**: ~$0.001 pro URL\r\n- **Hosting**: $10-50/Monat (je nach Gre)\r\n\r\n### **Einmalige Kosten**\r\n- **Entwicklung**: Bereits abgeschlossen\r\n- **Setup**: 1-2 Tage IT-Aufwand\r\n- **Training**: 2-4 Stunden pro Nutzer\r\n\r\n##  Integration in bestehende Systeme\r\n\r\n### **Shop-Systeme**\r\n- **Shopware**: CSV/JSON Export\r\n- **Magento**: API-Integration mglich\r\n- **WooCommerce**: WordPress Plugin\r\n\r\n### **PIM-Systeme**\r\n- **Akeneo**: API-Integration\r\n- **Pimcore**: Custom Connector\r\n- **inRiver**: Export-Funktionen\r\n\r\n### **CMS-Systeme**\r\n- **WordPress**: Plugin-Integration\r\n- **Drupal**: Custom Module\r\n- **Typo3**: Extension-Development\r\n\r\n##  Roadmap & Erweiterungen\r\n\r\n### **Kurzfristig (1-3 Monate)**\r\n- Bulk-Processing fr groe Kataloge\r\n- Template-System fr verschiedene Produkttypen\r\n- Erweiterte Export-Formate\r\n\r\n### **Mittelfristig (3-6 Monate)**\r\n- Multi-Language Support\r\n- Advanced AI Prompts\r\n- Integration mit ERP-Systemen\r\n\r\n### **Langfristig (6-12 Monate)**\r\n- Machine Learning fr bessere Extraktion\r\n- Automatische Produktkategorisierung\r\n- Real-time Collaboration\r\n\r\n##  Business Value\r\n\r\n### **Zeitersparnis**\r\n- **Vorher**: 30-60 Min pro Produktbeschreibung\r\n- **Nachher**: 5-10 Min pro Produktbeschreibung\r\n- **ROI**: 80-90% Zeitersparnis\r\n\r\n### **Qualitt**\r\n- Konsistente Formatierung\r\n- Vollstndige technische Daten\r\n- SEO-optimierte Beschreibungen\r\n\r\n### **Skalierbarkeit**\r\n- Unbegrenzte Produktanzahl\r\n- Automatisierte Workflows\r\n- Reduzierte manuelle Fehler\r\n","size_bytes":5518},"client/src/components/credentials-manager.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Settings, Key, Eye, EyeOff } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface Credentials {\n  openaiApiKey: string;\n  pixiApiKey: string;\n  channelEngineApiKey: string;\n  brickfoxApiKey: string;\n}\n\nexport default function CredentialsManager() {\n  const [credentials, setCredentials] = useState<Credentials>({\n    openaiApiKey: '',\n    pixiApiKey: '',\n    channelEngineApiKey: '',\n    brickfoxApiKey: '',\n  });\n  const [showKey, setShowKey] = useState(false);\n  const [isSaving, setIsSaving] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const { toast } = useToast();\n\n  // Load credentials on mount\n  useEffect(() => {\n    loadCredentials();\n  }, []);\n\n  const loadCredentials = async () => {\n    try {\n      setIsLoading(true);\n      const response = await apiRequest('GET', '/api/credentials');\n      const data = await response.json();\n      \n      if (data.success && data.credentials) {\n        setCredentials({\n          openaiApiKey: data.credentials.openaiApiKey || '',\n          pixiApiKey: data.credentials.pixiApiKey || '',\n          channelEngineApiKey: data.credentials.channelEngineApiKey || '',\n          brickfoxApiKey: data.credentials.brickfoxApiKey || '',\n        });\n      }\n    } catch (error) {\n      console.error('Failed to load credentials:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const saveCredentials = async () => {\n    try {\n      setIsSaving(true);\n      \n      const response = await apiRequest('POST', '/api/saveKeys', {\n        openaiKey: credentials.openaiApiKey,\n        pixiKey: credentials.pixiApiKey,\n        channelEngineKey: credentials.channelEngineApiKey,\n        brickfoxKey: credentials.brickfoxApiKey,\n      });\n      \n      const data = await response.json();\n      \n      if (data.success) {\n        toast({\n          title: \"Erfolg\",\n          description: data.message || \"API-Schlssel wurde gespeichert!\",\n        });\n      } else {\n        toast({\n          title: \"Fehler\",\n          description: data.message || \"Fehler beim Speichern\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      console.error('Failed to save credentials:', error);\n      toast({\n        title: \"Fehler beim Speichern\",\n        description: error instanceof Error ? error.message : \"Unbekannter Fehler\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Settings className=\"w-5 h-5\" />\n            API Credentials\n          </CardTitle>\n          <CardDescription>\n            Verwalten Sie Ihren OpenAI API-Schlssel\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"flex justify-center py-8\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Settings className=\"w-5 h-5\" />\n          API Credentials\n        </CardTitle>\n        <CardDescription>\n          Verwalten Sie Ihre API-Schlssel fr AI-Generierung und Integration mit Pixi, Channel-Engine und Brickfox\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        {/* OpenAI API Key */}\n        <div className=\"space-y-3\">\n          <Label htmlFor=\"openai-key\" className=\"flex items-center gap-2\">\n            <Key className=\"w-4 h-4\" />\n            OpenAI API Key\n          </Label>\n          <div className=\"flex gap-2\">\n            <Input\n              id=\"openai-key\"\n              type={showKey ? \"text\" : \"password\"}\n              placeholder=\"sk-...\"\n              value={credentials.openaiApiKey}\n              onChange={(e) => setCredentials({ ...credentials, openaiApiKey: e.target.value })}\n              className=\"flex-1\"\n            />\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowKey(!showKey)}\n            >\n              {showKey ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n            </Button>\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            Bentigt fr die AI-gesttzte Produktbeschreibungs-Generierung\n          </p>\n        </div>\n\n        {/* Pixi API Key */}\n        <div className=\"space-y-3\">\n          <Label htmlFor=\"pixi-key\" className=\"flex items-center gap-2\">\n            <Key className=\"w-4 h-4\" />\n            Pixi API Key\n          </Label>\n          <div className=\"flex gap-2\">\n            <Input\n              id=\"pixi-key\"\n              type={showKey ? \"text\" : \"password\"}\n              placeholder=\"Pixi API-Schlssel\"\n              value={credentials.pixiApiKey}\n              onChange={(e) => setCredentials({ ...credentials, pixiApiKey: e.target.value })}\n              className=\"flex-1\"\n            />\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            Bentigt fr die Integration mit Pixi\n          </p>\n        </div>\n\n        {/* Channel-Engine API Key */}\n        <div className=\"space-y-3\">\n          <Label htmlFor=\"channel-engine-key\" className=\"flex items-center gap-2\">\n            <Key className=\"w-4 h-4\" />\n            Channel-Engine API Key\n          </Label>\n          <div className=\"flex gap-2\">\n            <Input\n              id=\"channel-engine-key\"\n              type={showKey ? \"text\" : \"password\"}\n              placeholder=\"Channel-Engine API-Schlssel\"\n              value={credentials.channelEngineApiKey}\n              onChange={(e) => setCredentials({ ...credentials, channelEngineApiKey: e.target.value })}\n              className=\"flex-1\"\n            />\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            Bentigt fr die Integration mit Channel-Engine\n          </p>\n        </div>\n\n        {/* Brickfox API Key */}\n        <div className=\"space-y-3\">\n          <Label htmlFor=\"brickfox-key\" className=\"flex items-center gap-2\">\n            <Key className=\"w-4 h-4\" />\n            Brickfox API Key\n          </Label>\n          <div className=\"flex gap-2\">\n            <Input\n              id=\"brickfox-key\"\n              type={showKey ? \"text\" : \"password\"}\n              placeholder=\"Brickfox API-Schlssel\"\n              value={credentials.brickfoxApiKey}\n              onChange={(e) => setCredentials({ ...credentials, brickfoxApiKey: e.target.value })}\n              className=\"flex-1\"\n            />\n          </div>\n          <p className=\"text-sm text-muted-foreground\">\n            Bentigt fr die Integration mit Brickfox\n          </p>\n        </div>\n\n        <Button \n          onClick={saveCredentials}\n          disabled={isSaving}\n          className=\"w-full\"\n        >\n          {isSaving ? 'Speichern...' : 'API-Schlssel speichern'}\n        </Button>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":7455},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"README.md":{"content":"# CodeCSVUpload - KI-gesttzte Produktbeschreibungen\r\n\r\nEine moderne Web-Anwendung zur automatischen Generierung von Produktbeschreibungen aus Lieferantendaten mit Hilfe von KI.\r\n\r\n##  Features\r\n\r\n- **URL-Analyse**: Direkte Analyse von Lieferanten-Websites\r\n- **Bildanalyse**: KI-gesttzte Analyse von Produktbildern und Screenshots\r\n- **Automatische Generierung**: Intelligente Produktbeschreibungen im Akkushop.de Format\r\n- **Technische Daten**: Automatische Extraktion und Formatierung\r\n- **Custom Attributes**: Flexible Anpassung von Produkteigenschaften\r\n\r\n##  Installation\r\n\r\n### Voraussetzungen\r\n- Node.js (Version 18 oder hher)\r\n- npm oder yarn\r\n\r\n### Setup\r\n\r\n1. **ZIP-Datei entpacken**\r\n   ```bash\r\n   # Entpacken Sie CodeCSVUpload-App.zip in einen Ordner Ihrer Wahl\r\n   ```\r\n\r\n2. **Abhngigkeiten installieren**\r\n   ```bash\r\n   npm install\r\n   ```\r\n\r\n3. **Umgebungsvariablen konfigurieren**\r\n   ```bash\r\n   # Kopieren Sie .env.example zu .env (falls vorhanden)\r\n   # Oder erstellen Sie eine neue .env Datei mit folgenden Inhalten:\r\n   ```\r\n   \r\n   Erstellen Sie eine `.env` Datei mit:\r\n   ```env\r\n   # API Keys (erforderlich fr KI-Funktionen)\r\n   OPENAI_API_KEY=your_openai_api_key_here\r\n   FIRECRAWL_API_KEY=your_firecrawl_api_key_here\r\n   \r\n   # Server Konfiguration\r\n   PORT=5000\r\n   NODE_ENV=development\r\n   ```\r\n\r\n4. **Datenbank initialisieren**\r\n   ```bash\r\n   npm run migrate\r\n   ```\r\n\r\n5. **Anwendung starten**\r\n   ```bash\r\n   # Windows\r\n   .\\start-app.ps1\r\n   \r\n   # Oder manuell:\r\n   npm run dev\r\n   ```\r\n\r\n6. **Anwendung ffnen**\r\n   - ffnen Sie http://localhost:5000 in Ihrem Browser\r\n\r\n##  API Keys Setup\r\n\r\nDie Anwendung bentigt API Keys fr folgende Services:\r\n\r\n### OpenAI API Key\r\n- Registrieren Sie sich bei https://platform.openai.com/\r\n- Erstellen Sie einen API Key\r\n- Fgen Sie ihn in die `.env` Datei ein\r\n\r\n### Firecrawl API Key\r\n- Registrieren Sie sich bei https://firecrawl.dev/\r\n- Erstellen Sie einen API Key\r\n- Fgen Sie ihn in die `.env` Datei ein\r\n\r\n##  Verwendung\r\n\r\n1. **URL analysieren**: Geben Sie eine Produkt-URL ein und klicken Sie auf \"URL analysieren\"\r\n2. **Bilder hochladen**: Laden Sie Produktbilder oder Screenshots hoch\r\n3. **KI generieren**: Whlen Sie Dateien aus und klicken Sie auf \"KI generieren\"\r\n4. **Anpassen**: Bearbeiten Sie die generierte Beschreibung nach Bedarf\r\n\r\n##  Entwicklung\r\n\r\n### Projektstruktur\r\n```\r\n client/          # React Frontend\r\n server/          # Express Backend\r\n shared/          # Gemeinsame TypeScript Typen\r\n dist/           # Build Output\r\n```\r\n\r\n### Verfgbare Scripts\r\n```bash\r\nnpm run dev          # Startet Entwicklungsserver\r\nnpm run build        # Erstellt Production Build\r\nnpm run migrate      # Fhrt Datenbankmigrationen aus\r\n```\r\n\r\n##  Dokumentation\r\n\r\n- `API-SETUP.md` - Detaillierte API-Konfiguration\r\n- `TECHNICAL-OVERVIEW.md` - Technische bersicht\r\n- `TECHNICAL-FAQ.md` - Hufige Fragen\r\n- `DEPLOYMENT.md` - Deployment-Anweisungen\r\n\r\n##  Support\r\n\r\nBei Problemen oder Fragen:\r\n1. Prfen Sie die Logs in der Konsole\r\n2. Stellen Sie sicher, dass alle API Keys korrekt konfiguriert sind\r\n3. berprfen Sie die Netzwerkverbindung\r\n\r\n##  Lizenz\r\n\r\nDieses Projekt ist fr den internen Gebrauch bestimmt.\r\n\r\n---\r\n\r\n**Erstellt am:** $(Get-Date -Format \"dd.MM.yyyy\")\r\n**Version:** 1.0.0\r\n","size_bytes":3381},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/pages/projects.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Plus, FolderOpen, Trash2, Calendar } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { de } from \"date-fns/locale\";\nimport type { Project } from \"@shared/schema\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function Projects() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [projectName, setProjectName] = useState(\"\");\n\n  // Fetch projects\n  const { data: projectsData, isLoading } = useQuery<{ success: boolean; projects: Project[] }>({\n    queryKey: ['/api/projects'],\n  });\n\n  const projects = projectsData?.projects || [];\n\n  // Create project mutation\n  const createProjectMutation = useMutation({\n    mutationFn: async (name: string) => {\n      return apiRequest('POST', '/api/projects', { name });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      setIsDialogOpen(false);\n      setProjectName(\"\");\n      toast({\n        title: \"Projekt erstellt\",\n        description: \"Das Projekt wurde erfolgreich erstellt.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Fehler\",\n        description: error.message || \"Projekt konnte nicht erstellt werden.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete project mutation\n  const deleteProjectMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/projects/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      toast({\n        title: \"Projekt gelscht\",\n        description: \"Das Projekt wurde erfolgreich gelscht.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Fehler\",\n        description: error.message || \"Projekt konnte nicht gelscht werden.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateProject = () => {\n    if (projectName.trim()) {\n      createProjectMutation.mutate(projectName.trim());\n    }\n  };\n\n  const handleDeleteProject = (e: React.MouseEvent, projectId: string) => {\n    e.stopPropagation();\n    if (confirm(\"Mchten Sie dieses Projekt wirklich lschen? Alle Produkte im Projekt werden ebenfalls gelscht.\")) {\n      deleteProjectMutation.mutate(projectId);\n    }\n  };\n\n  return (\n    <div className=\"h-full overflow-auto\">\n      <div className=\"container mx-auto p-6 max-w-7xl\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between mb-8\">\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight\">Meine Projekte</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Verwalten Sie Ihre Produktbeschreibungs-Projekte\n            </p>\n          </div>\n          \n          {projects.length > 0 && (\n            <Button onClick={() => setIsDialogOpen(true)} data-testid=\"button-create-project\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Neues Projekt\n            </Button>\n          )}\n        </div>\n        \n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogContent data-testid=\"dialog-create-project\">\n            <DialogHeader>\n              <DialogTitle>Neues Projekt erstellen</DialogTitle>\n              <DialogDescription>\n                Geben Sie einen Namen fr Ihr neues Projekt ein\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"project-name\">Projektname</Label>\n                <Input\n                  id=\"project-name\"\n                  placeholder=\"z.B. MediaMarkt Batterien Mrz 2025\"\n                  value={projectName}\n                  onChange={(e) => setProjectName(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter') {\n                      handleCreateProject();\n                    }\n                  }}\n                  data-testid=\"input-project-name\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n                data-testid=\"button-cancel-create\"\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handleCreateProject}\n                disabled={!projectName.trim() || createProjectMutation.isPending}\n                data-testid=\"button-confirm-create\"\n              >\n                {createProjectMutation.isPending ? \"Wird erstellt...\" : \"Erstellen\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Projects Grid */}\n        {isLoading ? (\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n            {[1, 2, 3].map((i) => (\n              <Card key={i} className=\"animate-pulse\">\n                <CardHeader className=\"space-y-3\">\n                  <div className=\"h-5 bg-muted rounded w-3/4\"></div>\n                  <div className=\"h-4 bg-muted rounded w-1/2\"></div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"h-4 bg-muted rounded w-full\"></div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : projects.length === 0 ? (\n          <Card className=\"border-dashed\">\n            <CardContent className=\"flex flex-col items-center justify-center py-16\">\n              <FolderOpen className=\"w-16 h-16 text-muted-foreground mb-4\" />\n              <h3 className=\"text-lg font-semibold mb-2\">Noch keine Projekte</h3>\n              <p className=\"text-muted-foreground text-center mb-6\">\n                Erstellen Sie Ihr erstes Projekt, um mit der Produktbeschreibung zu beginnen\n              </p>\n              <Button onClick={() => setIsDialogOpen(true)} data-testid=\"button-create-first-project\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Erstes Projekt erstellen\n              </Button>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n            {projects.map((project) => (\n              <Card\n                key={project.id}\n                className=\"hover-elevate active-elevate-2 cursor-pointer transition-all\"\n                onClick={() => setLocation(`/project/${project.id}`)}\n                data-testid={`card-project-${project.id}`}\n              >\n                <CardHeader className=\"space-y-0 pb-3\">\n                  <CardTitle className=\"text-xl flex items-start justify-between gap-2\">\n                    <span className=\"line-clamp-2\">{project.name}</span>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"flex-shrink-0 h-8 w-8\"\n                      onClick={(e) => handleDeleteProject(e, project.id)}\n                      data-testid={`button-delete-project-${project.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4 text-destructive\" />\n                    </Button>\n                  </CardTitle>\n                  <CardDescription className=\"flex items-center gap-1 text-xs\">\n                    <Calendar className=\"w-3 h-3\" />\n                    {format(new Date(project.createdAt), \"dd. MMM yyyy\", { locale: de })}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <Calendar className=\"w-4 h-4\" />\n                    Klicken zum ffnen\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":8506},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/pages/component-demo.tsx":{"content":"import React from \"react\";\nimport { Button } from \"../components/ui/button\";\nimport { Card } from \"../components/ui/card\";\nimport { Section } from \"../components/ui/section\";\n\nexport default function ComponentDemo() {\n  return (\n    <main className=\"min-h-screen flex flex-col items-center justify-center bg-white\">\n      <Section title=\"Willkommen in deiner Lovable App \">\n        <div className=\"flex flex-col items-center gap-6\">\n          <Card className=\"max-w-md text-center\">\n            <h3 className=\"text-xl mb-2\">Modernes UI</h3>\n            <p className=\"text-gray-600 mb-4\">\n              Jetzt im Lovable-Style: runde Ecken, sanfte Schatten und klare Farben.\n            </p>\n            <Button>Los geht's </Button>\n          </Card>\n        </div>\n      </Section>\n    </main>\n  );\n}\n","size_bytes":808},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport \"@fontsource/inter\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":185},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/product-table.tsx":{"content":"import { useState } from \"react\";\nimport { Product } from \"@shared/schema\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface ProductTableProps {\n  products: Product[];\n  onUpdateProduct: (id: number, field: keyof Product, value: string) => void;\n}\n\nexport function ProductTable({ products, onUpdateProduct }: ProductTableProps) {\n  const [displayLimit, setDisplayLimit] = useState(50);\n\n  const displayedProducts = products.slice(0, displayLimit);\n  const hasMore = products.length > displayLimit;\n\n  return (\n    <Card className=\"overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"w-full border-collapse\" data-testid=\"table-products\">\n          <thead className=\"sticky top-0 z-10 bg-primary text-primary-foreground\">\n            <tr>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[140px]\">\n                Artikelnummer\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[200px]\">\n                Produktname\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[300px]\">\n                Produktbeschreibung\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[300px]\">\n                MediaMarkt Titel V1\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[300px]\">\n                MediaMarkt Titel V2\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[120px]\">\n                Spannung\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[130px]\">\n                Kapazitt\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[140px]\">\n                Energiegehalt\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[120px]\">\n                Leistung\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[160px]\">\n                Verpackungseinheit\n              </th>\n              <th className=\"px-4 py-3 text-left text-sm font-medium uppercase tracking-wide min-w-[250px]\">\n                Lieferumfang\n              </th>\n            </tr>\n          </thead>\n          <tbody>\n            {displayedProducts.map((product, index) => (\n              <tr\n                key={product.id}\n                className={`\n                  border-b border-border transition-colors hover-elevate\n                  ${index % 2 === 0 ? 'bg-background' : 'bg-muted/30'}\n                `}\n                data-testid={`row-product-${product.id}`}\n              >\n                <td className=\"px-4 py-3\">\n                  <span className=\"text-sm font-mono text-foreground\" data-testid={`text-sku-${product.id}`}>\n                    {product.sku || '-'}\n                  </span>\n                </td>\n                <td className=\"px-4 py-3\">\n                  <TooltipProvider>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <p className=\"text-sm text-foreground line-clamp-3\">\n                          {product.titel || '-'}\n                        </p>\n                      </TooltipTrigger>\n                      {product.titel && product.titel.length > 50 && (\n                        <TooltipContent className=\"max-w-md\">\n                          <p className=\"text-xs\">{product.titel}</p>\n                        </TooltipContent>\n                      )}\n                    </Tooltip>\n                  </TooltipProvider>\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Textarea\n                    value={product.produktbeschreibung}\n                    onChange={(e) => onUpdateProduct(product.id, 'produktbeschreibung', e.target.value)}\n                    className=\"text-xs resize-none min-h-[80px] font-sans\"\n                    data-testid={`input-beschreibung-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Textarea\n                    value={product.titel_marktplatz}\n                    onChange={(e) => onUpdateProduct(product.id, 'titel_marktplatz', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans font-medium\"\n                    data-testid={`input-marktplatz-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Textarea\n                    value={product.titel_marktplatz_v2}\n                    onChange={(e) => onUpdateProduct(product.id, 'titel_marktplatz_v2', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans font-medium\"\n                    data-testid={`input-marktplatz-v2-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Input\n                    value={product.spannung}\n                    onChange={(e) => onUpdateProduct(product.id, 'spannung', e.target.value)}\n                    className=\"text-sm font-mono\"\n                    placeholder=\"-\"\n                    data-testid={`input-spannung-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Input\n                    value={product.kapazitaet}\n                    onChange={(e) => onUpdateProduct(product.id, 'kapazitaet', e.target.value)}\n                    className=\"text-sm font-mono\"\n                    placeholder=\"-\"\n                    data-testid={`input-kapazitaet-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Input\n                    value={product.energiegehalt}\n                    onChange={(e) => onUpdateProduct(product.id, 'energiegehalt', e.target.value)}\n                    className=\"text-sm font-mono\"\n                    placeholder=\"-\"\n                    data-testid={`input-energiegehalt-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Input\n                    value={product.leistung}\n                    onChange={(e) => onUpdateProduct(product.id, 'leistung', e.target.value)}\n                    className=\"text-sm font-mono\"\n                    placeholder=\"-\"\n                    data-testid={`input-leistung-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Input\n                    value={product.verpackungseinheit}\n                    onChange={(e) => onUpdateProduct(product.id, 'verpackungseinheit', e.target.value)}\n                    className=\"text-sm\"\n                    placeholder=\"-\"\n                    data-testid={`input-verpackungseinheit-${product.id}`}\n                  />\n                </td>\n                <td className=\"px-4 py-3\">\n                  <Textarea\n                    value={product.lieferumfang}\n                    onChange={(e) => onUpdateProduct(product.id, 'lieferumfang', e.target.value)}\n                    className=\"text-xs resize-none min-h-[80px] font-sans\"\n                    data-testid={`input-lieferumfang-${product.id}`}\n                  />\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n\n      {hasMore && (\n        <div className=\"p-6 text-center border-t border-border bg-muted/30\">\n          <p className=\"text-sm text-muted-foreground mb-4\">\n            Zeige {displayLimit} von {products.length} Produkten\n          </p>\n          <button\n            onClick={() => setDisplayLimit(prev => prev + 50)}\n            className=\"text-sm text-primary hover:underline font-medium\"\n            data-testid=\"button-load-more\"\n          >\n            Weitere 50 Produkte laden\n          </button>\n        </div>\n      )}\n\n      {!hasMore && products.length > 50 && (\n        <div className=\"p-4 text-center border-t border-border bg-muted/30\">\n          <p className=\"text-xs text-muted-foreground\">\n            Alle {products.length} Produkte werden angezeigt\n          </p>\n        </div>\n      )}\n    </Card>\n  );\n}\n","size_bytes":8760},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\n// Helper to get token from the correct storage based on rememberMe preference\nfunction getAuthToken(): string | null {\n  const saved = localStorage.getItem('rememberMe');\n  // Default to true if not set (matches login page default and DynamicStorage)\n  const rememberMe = saved === null ? true : saved === 'true';\n  \n  if (rememberMe) {\n    return localStorage.getItem('supabase_token');\n  } else {\n    return sessionStorage.getItem('supabase_token');\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const token = getAuthToken();\n  const headers: Record<string, string> = {};\n  \n  if (data) {\n    headers[\"Content-Type\"] = \"application/json\";\n  }\n  \n  if (token) {\n    headers[\"Authorization\"] = `Bearer ${token}`;\n  }\n\n  const res = await fetch(url, {\n    method,\n    headers,\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const token = getAuthToken();\n    const headers: Record<string, string> = {};\n    \n    if (token) {\n      headers['Authorization'] = `Bearer ${token}`;\n    }\n\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      headers,\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":2191},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/pages/landing.tsx":{"content":"import { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Sparkles, CheckCircle2, Zap, TrendingUp, Shield, Package, ChevronDown, Linkedin, Facebook, Twitter } from \"lucide-react\";\nimport { useState } from \"react\";\n\nexport default function Landing() {\n  const [productMenuOpen, setProductMenuOpen] = useState(false);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-indigo-50 via-white to-white\">\n      {/* Header Navigation - Modern Clean Design */}\n      <header className=\"sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-6 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <div className=\"flex items-center gap-2 cursor-pointer group\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-lg flex items-center justify-center\">\n                  <Package className=\"w-6 h-6 text-white\" />\n                </div>\n                <span className=\"text-xl font-bold text-gray-900\">\n                  PIMPilot\n                </span>\n              </div>\n            </Link>\n\n            {/* Navigation Links - Desktop */}\n            <nav className=\"hidden md:flex items-center gap-8\">\n              {/* Produkt Dropdown */}\n              <div \n                className=\"relative\"\n                onMouseEnter={() => setProductMenuOpen(true)}\n                onMouseLeave={() => setProductMenuOpen(false)}\n              >\n                <button className=\"flex items-center gap-1 text-gray-700 hover:text-indigo-600 font-medium transition-colors py-2\">\n                  Produkt\n                  <ChevronDown className=\"w-4 h-4\" />\n                </button>\n                {productMenuOpen && (\n                  <div className=\"absolute top-full left-0 pt-1 w-56\">\n                    <div className=\"bg-white rounded-lg shadow-xl border border-gray-200 py-2\">\n                      <a href=\"#features\" className=\"block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors\">\n                        Tool Funktionen\n                      </a>\n                      <a href=\"#features\" className=\"block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors\">\n                        CSV Bulk Import\n                      </a>\n                      <a href=\"#features\" className=\"block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors\">\n                        URL Scraper\n                      </a>\n                      <a href=\"#features\" className=\"block px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors\">\n                        AI-Generierung\n                      </a>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              <Link href=\"/pricing\">\n                <span className=\"text-gray-700 hover:text-indigo-600 font-medium transition-colors cursor-pointer\">\n                  Tarife\n                </span>\n              </Link>\n              \n              <a href=\"#\" className=\"text-gray-700 hover:text-indigo-600 font-medium transition-colors\">\n                ber uns\n              </a>\n              \n              <Link href=\"/contact\">\n                <span className=\"text-gray-700 hover:text-indigo-600 font-medium transition-colors cursor-pointer\">\n                  Kontakt\n                </span>\n              </Link>\n            </nav>\n\n            {/* Auth Buttons */}\n            <div className=\"flex items-center gap-3\">\n              <Link href=\"/login\">\n                <Button asChild variant=\"outline\" className=\"text-gray-700 border-gray-300 hover:text-indigo-600 hover:border-indigo-300\">\n                  <span>Einloggen</span>\n                </Button>\n              </Link>\n              <Link href=\"/register\">\n                <Button asChild className=\"bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white shadow-md\">\n                  <span>Demo anfordern</span>\n                </Button>\n              </Link>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Hero Section - PromptPop Style */}\n      <section className=\"relative\">\n        <div className=\"max-w-6xl mx-auto px-6 py-16 md:py-24\">\n          <div className=\"text-center space-y-8 max-w-4xl mx-auto\">\n            <h1 className=\"text-4xl md:text-5xl lg:text-6xl font-bold text-gray-900 leading-tight\">\n              Produktdaten-Management neu gedacht  <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600\">Automatisiert, intelligent, zeitsparend</span>\n            </h1>\n            \n            <p className=\"text-lg md:text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed\">\n              Schluss mit manuellen Excel-Marathons und endlosen Copy-Paste-Aufgaben. Unser Produktdaten-Manager automatisiert deine Produkttexte, Mappings und Exporte  in Sekunden statt Stunden.\n            </p>\n            \n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center pt-4\">\n              <Link href=\"/pricing\">\n                <Button asChild size=\"lg\" className=\"text-lg px-8 py-6 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white rounded-xl shadow-lg\">\n                  <span>Kostenlos starten</span>\n                </Button>\n              </Link>\n              <a href=\"#features\">\n                <Button size=\"lg\" variant=\"outline\" className=\"text-lg px-8 py-6 border-2 border-indigo-300 text-indigo-700 hover:bg-indigo-50 rounded-xl\">\n                  Mehr erfahren\n                </Button>\n              </a>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Stats Section - PromptPop Style */}\n      <section className=\"py-16 bg-white\" id=\"features\">\n        <div className=\"max-w-6xl mx-auto px-6\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">Produktdaten-Management in Zahlen</h2>\n            <p className=\"text-lg text-gray-600\">Erlebe echte Zeitersparnis und Effizienz bei deiner tglichen Arbeit</p>\n          </div>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-6\">\n            <div className=\"bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl p-6 text-center border border-indigo-100\">\n              <div className=\"text-4xl font-bold text-indigo-600 mb-2\">10.000+</div>\n              <div className=\"text-sm text-gray-600\">Produkte in Minuten verarbeitet</div>\n            </div>\n            <div className=\"bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl p-6 text-center border border-indigo-100\">\n              <div className=\"text-4xl font-bold text-indigo-600 mb-2\">95%</div>\n              <div className=\"text-sm text-gray-600\">Weniger manuelle Arbeit</div>\n            </div>\n            <div className=\"bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl p-6 text-center border border-indigo-100\">\n              <div className=\"text-4xl font-bold text-indigo-600 mb-2\">Alle</div>\n              <div className=\"text-sm text-gray-600\">MediaMarkt, Brickfox & mehr</div>\n            </div>\n            <div className=\"bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl p-6 text-center border border-indigo-100\">\n              <div className=\"text-4xl font-bold text-indigo-600 mb-2\">2-5 Min</div>\n              <div className=\"text-sm text-gray-600\">Statt 4-8 Stunden pro Produkt</div>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Pain Points Section */}\n      <section className=\"py-20 bg-gradient-to-b from-white to-indigo-50\">\n        <div className=\"max-w-6xl mx-auto px-6\">\n          <div className=\"text-center mb-16\">\n            <h2 className=\"text-3xl md:text-4xl font-bold text-gray-900 mb-4\">Kennst du diese Probleme?</h2>\n            <p className=\"text-lg text-gray-600\">Typische Herausforderungen im Produktdaten-Management</p>\n          </div>\n          <div className=\"grid md:grid-cols-3 gap-8\">\n            <div className=\"bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition-shadow border border-gray-100\">\n              <div className=\"w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mb-4\">\n                <Sparkles className=\"w-6 h-6 text-indigo-600\" />\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-3\">Endlose Excel-Arbeit</h3>\n              <p className=\"text-gray-600\">\n                Stunden ber Stunden mit Copy-Paste, Formatieren und manuellen Anpassungen. Deine wertvolle Zeit geht fr repetitive Aufgaben drauf.\n              </p>\n            </div>\n            <div className=\"bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition-shadow border border-gray-100\">\n              <div className=\"w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center mb-4\">\n                <TrendingUp className=\"w-6 h-6 text-violet-600\" />\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-3\">Chaos bei Plattform-Mappings</h3>\n              <p className=\"text-gray-600\">\n                Jede Plattform will andere Felder. MediaMarkt, Brickfox, Channel-Engine  alle haben ihre eigenen Anforderungen. Ein Alptraum ohne System.\n              </p>\n            </div>\n            <div className=\"bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition-shadow border border-gray-100\">\n              <div className=\"w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mb-4\">\n                <Shield className=\"w-6 h-6 text-indigo-600\" />\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-3\">Inkonsistente Produkttexte</h3>\n              <p className=\"text-gray-600\">\n                Mal gut, mal schlecht. Keine einheitliche Qualitt. SEO-Optimierung? Fehlanzeige. Deine Produkte verschwinden in der Masse.\n              </p>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Feature 2: Individualization */}\n      <section className=\"py-20 bg-gray-50\">\n        <div className=\"max-w-4xl mx-auto px-6\">\n          <div className=\"text-center space-y-8\">\n            <div className=\"inline-block bg-indigo-100 text-indigo-600 px-4 py-2 rounded-full text-sm font-semibold\">\n              Individualisierung\n            </div>\n            <h2 className=\"text-4xl font-bold text-gray-900\">\n              Mageschneiderte Texte dank individuell trainierter Software\n            </h2>\n            <ul className=\"space-y-4 text-left max-w-2xl mx-auto\">\n              <li className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                <div>\n                  <p className=\"text-lg text-gray-700\">Individuelle und CI-konforme Produktbeschreibungen</p>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                <div>\n                  <p className=\"text-lg text-gray-700\">Tonalitt und Vokabular perfekt auf Ihre Zielgruppe abgestimmt</p>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                <div>\n                  <p className=\"text-lg text-gray-700\">Branchenunabhngige Anpassung</p>\n                </div>\n              </li>\n              <li className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                <div>\n                  <p className=\"text-lg text-gray-700\">Interner, persnlicher Kontakt fr Support & Onboarding</p>\n                </div>\n              </li>\n            </ul>\n            <Link href=\"/pricing\">\n              <Button size=\"lg\" className=\"mt-4 bg-indigo-600 hover:bg-indigo-700\">\n                Mehr ber Anpassungen\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </section>\n\n      {/* Feature 3: ROI / Results */}\n      <section className=\"py-20 bg-white\">\n        <div className=\"max-w-6xl mx-auto px-6\">\n          <div className=\"grid md:grid-cols-2 gap-12 items-center\">\n            <div className=\"space-y-6\">\n              <div className=\"inline-block bg-green-100 text-green-600 px-4 py-2 rounded-full text-sm font-semibold\">\n                Erfolg & ROI\n              </div>\n              <h2 className=\"text-4xl font-bold text-gray-900\">\n                Mehr Sichtbarkeit & Conversions aus unserer 30-jhrigen Erfahrung\n              </h2>\n              <ul className=\"space-y-4\">\n                <li className=\"flex items-start gap-3\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                  <div>\n                    <p className=\"text-lg text-gray-700\">Sales-Steigerung von bis zu 28% durch Conversion Uplift</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start gap-3\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                  <div>\n                    <p className=\"text-lg text-gray-700\">Bis zu 10 hhere SEO-Sichtbarkeit</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start gap-3\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                  <div>\n                    <p className=\"text-lg text-gray-700\">Zeitersparnis von 500+ Stunden bei 2.000 Produkten</p>\n                  </div>\n                </li>\n                <li className=\"flex items-start gap-3\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500 flex-shrink-0 mt-1\" />\n                  <div>\n                    <p className=\"text-lg text-gray-700\">Kostenersparnis von bis zu 97% gegenber manueller Erstellung</p>\n                  </div>\n                </li>\n              </ul>\n            </div>\n            <div className=\"relative\">\n              <div className=\"bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl p-8 shadow-xl\">\n                <div className=\"space-y-6\">\n                  <div className=\"bg-white rounded-lg p-6 shadow-md text-center\">\n                    <div className=\"text-5xl font-bold text-green-600 mb-2\">+28%</div>\n                    <div className=\"text-gray-600\">mehr Conversions durch<br/>hervorragende Texte</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-6 shadow-md text-center\">\n                    <div className=\"text-5xl font-bold text-indigo-600 mb-2\">~1</div>\n                    <div className=\"text-gray-600\">pro perfektem<br/>Text</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-6 shadow-md text-center\">\n                    <div className=\"text-5xl font-bold text-violet-600 mb-2\">+80%</div>\n                    <div className=\"text-gray-600\">mehr Traffic durch SEO-<br/>optimierte Inhalte</div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* CTA Section */}\n      <section className=\"py-20 bg-gradient-to-br from-indigo-600 to-violet-700\">\n        <div className=\"max-w-4xl mx-auto px-6 text-center\">\n          <h2 className=\"text-4xl md:text-5xl font-bold text-white mb-6\">\n            Sprechen wir ber Ihren individuellen Anwendungsfall\n          </h2>\n          <p className=\"text-xl text-white mb-12\">\n            Vereinbaren Sie jetzt einen unverbindlichen 30-Minuten-Termin\n          </p>\n          <Link href=\"/pricing\">\n            <Button size=\"lg\" className=\"text-lg px-10 py-6 bg-white text-indigo-600 hover:bg-gray-100 rounded-lg shadow-xl\">\n              Jetzt 30-Minuten-Termin vereinbaren\n            </Button>\n          </Link>\n        </div>\n      </section>\n\n      {/* Media Mentions */}\n      <section className=\"py-12 bg-gray-50\">\n        <div className=\"max-w-6xl mx-auto px-6\">\n          <p className=\"text-center text-sm uppercase tracking-wide text-gray-500 font-semibold mb-8\">\n            Bekannt aus fhrenden Medien\n          </p>\n          <div className=\"grid grid-cols-2 md:grid-cols-5 gap-6 items-center opacity-50\">\n            <div className=\"flex items-center justify-center text-gray-400 font-bold\">OMR</div>\n            <div className=\"flex items-center justify-center text-gray-400 font-bold\">T3N</div>\n            <div className=\"flex items-center justify-center text-gray-400 font-bold\">Horizont</div>\n            <div className=\"flex items-center justify-center text-gray-400 font-bold\">Hubspot</div>\n            <div className=\"flex items-center justify-center text-gray-400 font-bold\">Online Marketing</div>\n          </div>\n        </div>\n      </section>\n\n      {/* Footer - Modern Dark Design */}\n      <footer className=\"bg-gray-900 text-white\">\n        <div className=\"max-w-7xl mx-auto px-6 py-16\">\n          <div className=\"grid grid-cols-1 md:grid-cols-12 gap-12 mb-12\">\n            {/* Company Info - 4 columns */}\n            <div className=\"md:col-span-4\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <div className=\"w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-lg flex items-center justify-center\">\n                  <Package className=\"w-6 h-6 text-white\" />\n                </div>\n                <span className=\"text-xl font-bold text-white\">PIMPilot</span>\n              </div>\n              <p className=\"text-gray-400 text-sm leading-relaxed mb-6\">\n                Textoptimierung mit AI  die perfekte Lsung fr erfolgreiche Online-Shops und groe Unternehmen\n              </p>\n              <div className=\"flex items-center gap-4\">\n                <a href=\"#\" className=\"w-9 h-9 bg-gray-800 hover:bg-emerald-500 rounded-lg flex items-center justify-center transition-colors group\">\n                  <Linkedin className=\"w-4 h-4 text-gray-400 group-hover:text-white transition-colors\" />\n                </a>\n                <a href=\"#\" className=\"w-9 h-9 bg-gray-800 hover:bg-emerald-500 rounded-lg flex items-center justify-center transition-colors group\">\n                  <Facebook className=\"w-4 h-4 text-gray-400 group-hover:text-white transition-colors\" />\n                </a>\n                <a href=\"#\" className=\"w-9 h-9 bg-gray-800 hover:bg-emerald-500 rounded-lg flex items-center justify-center transition-colors group\">\n                  <Twitter className=\"w-4 h-4 text-gray-400 group-hover:text-white transition-colors\" />\n                </a>\n              </div>\n            </div>\n\n            {/* Tarife - 2 columns */}\n            <div className=\"md:col-span-2\">\n              <h4 className=\"font-semibold mb-4 text-white text-sm uppercase tracking-wider\">Tarife</h4>\n              <ul className=\"space-y-3 text-sm\">\n                <li><Link href=\"/pricing\" className=\"text-gray-400 hover:text-white transition-colors\">Starter</Link></li>\n                <li><Link href=\"/pricing\" className=\"text-gray-400 hover:text-white transition-colors\">Professional</Link></li>\n                <li><Link href=\"/pricing\" className=\"text-gray-400 hover:text-white transition-colors\">Enterprise</Link></li>\n                <li><Link href=\"/register\" className=\"text-gray-400 hover:text-white transition-colors\">Kostenlos testen</Link></li>\n              </ul>\n            </div>\n\n            {/* Tools - 2 columns */}\n            <div className=\"md:col-span-2\">\n              <h4 className=\"font-semibold mb-4 text-white text-sm uppercase tracking-wider\">Tools</h4>\n              <ul className=\"space-y-3 text-sm\">\n                <li><a href=\"#features\" className=\"text-gray-400 hover:text-white transition-colors\">CSV Bulk Import</a></li>\n                <li><a href=\"#features\" className=\"text-gray-400 hover:text-white transition-colors\">URL Scraper</a></li>\n                <li><a href=\"#features\" className=\"text-gray-400 hover:text-white transition-colors\">AI-Generierung</a></li>\n                <li><a href=\"#features\" className=\"text-gray-400 hover:text-white transition-colors\">Projekt-Management</a></li>\n              </ul>\n            </div>\n\n            {/* Unternehmen - 2 columns */}\n            <div className=\"md:col-span-2\">\n              <h4 className=\"font-semibold mb-4 text-white text-sm uppercase tracking-wider\">Unternehmen</h4>\n              <ul className=\"space-y-3 text-sm\">\n                <li><a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">ber uns</a></li>\n                <li><a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">Karriere</a></li>\n                <li><a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">Kontakt</a></li>\n                <li><a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">Impressum</a></li>\n              </ul>\n            </div>\n          </div>\n\n          {/* Bottom Bar */}\n          <div className=\"border-t border-gray-800 pt-8\">\n            <div className=\"flex flex-col md:flex-row justify-between items-center gap-4\">\n              <div className=\"text-sm text-gray-400\">\n                 {new Date().getFullYear()} PIMPilot. Alle Rechte vorbehalten.\n              </div>\n              <div className=\"flex items-center gap-6 text-sm\">\n                <a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">Datenschutz</a>\n                <a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">AGB</a>\n                <a href=\"#\" className=\"text-gray-400 hover:text-white transition-colors\">Cookies</a>\n              </div>\n            </div>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","size_bytes":22140},"server/api-key-manager.ts":{"content":"import { encryptionService } from './services/encryption-service';\n\ninterface SecureApiKeys {\n  openai?: string;\n  firecrawl?: string;\n}\n\nclass ApiKeyManager {\n  private encryptedKeys: SecureApiKeys = {};\n  \n  setApiKey(service: keyof SecureApiKeys, apiKey: string): void {\n    const encrypted = encryptionService.encrypt(apiKey);\n    if (encrypted) {\n      this.encryptedKeys[service] = encrypted;\n      console.log(`API-Schlssel fr ${service} verschlsselt gespeichert`);\n    }\n  }\n  \n  getApiKey(service: keyof SecureApiKeys): string | null {\n    const encryptedKey = this.encryptedKeys[service];\n    if (!encryptedKey) {\n      return null;\n    }\n    \n    try {\n      return encryptionService.decrypt(encryptedKey);\n    } catch (error) {\n      console.error(`Fehler beim Entschlsseln des ${service} API-Schlssels:`, error);\n      return null;\n    }\n  }\n  \n  loadFromEnvironment(): void {\n    const encryptedOpenAI = process.env.ENCRYPTED_OPENAI_API_KEY;\n    const encryptedFirecrawl = process.env.ENCRYPTED_FIRECRAWL_API_KEY;\n    \n    if (encryptedOpenAI) {\n      try {\n        this.encryptedKeys.openai = encryptedOpenAI;\n        console.log('OpenAI API-Schlssel aus verschlsselter Umgebungsvariable geladen');\n      } catch (error) {\n        console.error('Fehler beim Laden des verschlsselten OpenAI API-Schlssels:', error);\n      }\n    }\n    \n    if (encryptedFirecrawl) {\n      try {\n        this.encryptedKeys.firecrawl = encryptedFirecrawl;\n        console.log('Firecrawl API-Schlssel aus verschlsselter Umgebungsvariable geladen');\n      } catch (error) {\n        console.error('Fehler beim Laden des verschlsselten Firecrawl API-Schlssels:', error);\n      }\n    }\n  }\n  \n  clearAllKeys(): void {\n    this.encryptedKeys = {};\n    console.log('Alle API-Schlssel gelscht');\n  }\n}\n\nexport const apiKeyManager = new ApiKeyManager();\n\nexport function getSecureOpenAIKey(): string | null {\n  return process.env.OPENAI_API_KEY || apiKeyManager.getApiKey('openai') || null;\n}\n\nexport function getSecureFirecrawlKey(): string | null {\n  return apiKeyManager.getApiKey('firecrawl') || process.env.FIRECRAWL_API_KEY || null;\n}\n","size_bytes":2156},"server/db.ts":{"content":"import { drizzle } from 'drizzle-orm/neon-serverless';\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport ws from 'ws';\nimport * as schema from \"@shared/schema\";\n\n// Always use PostgreSQL (Supabase) - no more SQLite\nneonConfig.webSocketConstructor = ws;\n\nlet db: any;\nlet pool: any = null;\n\nasync function initializeDatabase() {\n  if (!process.env.DATABASE_URL) {\n    throw new Error('DATABASE_URL environment variable is required');\n  }\n  \n  // Log connection info (mask password)\n  const dbUrlMasked = process.env.DATABASE_URL.replace(/:[^:@]+@/, ':***@');\n  console.log(`[Database] Connecting to: ${dbUrlMasked}`);\n  \n  // Detect environment\n  const isHelium = process.env.DATABASE_URL.includes('helium');\n  const isSupabase = process.env.DATABASE_URL.includes('supabase.co');\n  const dbType = isHelium ? 'Helium (Development)' : isSupabase ? 'Supabase (Production)' : 'PostgreSQL';\n  console.log(`[Database] Type: ${dbType}`);\n  \n  try {\n    pool = new Pool({ connectionString: process.env.DATABASE_URL });\n    db = drizzle({ client: pool, schema });\n    \n    console.log(` [Database] Connected successfully to ${dbType}`);\n  } catch (error: any) {\n    console.error(` [Database] Connection failed to ${dbType}:`, error.message);\n    \n    // Detailed error logging\n    if (error.code === 'ENOTFOUND') {\n      console.error(`[Database] DNS resolution failed - host not found`);\n      console.error(`[Database] Hint: Check if hostname is reachable from Replit environment`);\n    } else if (error.code === 'ETIMEDOUT') {\n      console.error(`[Database] Connection timeout - check firewall/network`);\n      console.error(`[Database] Hint: Supabase port 5432 may be blocked, try port 6543 (pooler)`);\n    } else if (error.message?.includes('SSL') || error.message?.includes('ssl')) {\n      console.error(`[Database] SSL error - check sslmode parameter`);\n      console.error(`[Database] Hint: Add ?sslmode=require for Supabase or ?sslmode=disable for Helium`);\n    }\n    \n    throw error;\n  }\n}\n\n// Initialize database\ninitializeDatabase();\n\nexport { db, pool };","size_bytes":2084},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes-supabase\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport fs from 'fs';\nimport path from 'path';\n\n// Load .env file if it exists\nconst envPath = path.join(process.cwd(), \".env\");\nif (fs.existsSync(envPath)) {\n  const envContent = fs.readFileSync(envPath, 'utf8');\n  const lines = envContent.split('\\n');\n  \n  for (const line of lines) {\n    if (line.trim() && !line.startsWith('#')) {\n      const [key, ...valueParts] = line.split('=');\n      if (key && valueParts.length > 0) {\n        const value = valueParts.join('=').trim();\n        process.env[key.trim()] = value;\n        console.log(`Loaded env var: ${key.trim()}=${value ? '***' + value.slice(-4) : 'empty'}`);\n      }\n    }\n  }\n} else {\n  console.log('No .env file found');\n}\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  limit: '50mb',\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false, limit: '50mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Serve product images statically\n  const productImagesPath = path.join(process.cwd(), 'attached_assets', 'product_images');\n  app.use('/product-images', express.static(productImagesPath));\n  log('Static file server enabled for /product-images');\n\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  const host = '0.0.0.0';\n  \n  server.listen({\n    port,\n    host,\n  }, () => {\n    const nodeEnv = process.env.NODE_ENV || 'development';\n    log(`serving on port ${port} (${nodeEnv} mode on ${host})`);\n  });\n})();\n","size_bytes":3272},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  // In production, the bundled server is in dist/index.js\n  // and static files are in dist/public\n  const isProduction = process.env.NODE_ENV === 'production';\n  const distPath = isProduction \n    ? path.join(process.cwd(), 'dist', 'public')\n    : path.resolve(import.meta.dirname, '..', 'dist', 'public');\n\n  if (!fs.existsSync(distPath)) {\n    console.error(` Build directory not found at: ${distPath}`);\n    console.error(`Current directory: ${process.cwd()}`);\n    console.error(`NODE_ENV: ${process.env.NODE_ENV}`);\n    try {\n      console.error(`Files in cwd:`, fs.readdirSync(process.cwd()));\n      if (fs.existsSync(path.join(process.cwd(), 'dist'))) {\n        console.error(`Files in dist:`, fs.readdirSync(path.join(process.cwd(), 'dist')));\n      }\n    } catch (e) {\n      console.error('Could not list files:', e);\n    }\n    throw new Error(\n      `Could not find the build directory: ${distPath}`,\n    );\n  }\n\n  console.log(` Serving static files from: ${distPath}`);\n  app.use(express.static(distPath, {\n    maxAge: '1d',\n    etag: true,\n    lastModified: true\n  }));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.join(distPath, \"index.html\"));\n  });\n}\n","size_bytes":3087},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n        '2xl': '1rem',\n      },\n      boxShadow: {\n        'soft': '0 4px 20px rgba(0,0,0,0.05)',\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n          hover: '#6366f1',\n          light: '#818cf8',\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n        neutral: {\n          100: '#f9fafb',\n          200: '#f3f4f6',\n          800: '#1f2937',\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4312},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/lib/html-templates.ts":{"content":"import { CreatorProduct, HtmlTemplate, ProductImage } from \"@shared/schema\";\n\n/**\n * MediaMarkt Template\n * Professional MediaMarkt-style product description with advantages, technical specs table, and safety info\n */\nfunction mediaMarktTemplate(product: CreatorProduct): string {\n  const advantages = product.advantages || product.features || [];\n  const technicalSpecs = product.technicalSpecs || {};\n  const safetyInfo = product.safetyInfo || 'Produkt entspricht den geltenden Sicherheitsstandards.';\n  const packageContents = product.packageContents || `1  ${product.name}`;\n\n  return `\n<h2>${product.name}</h2>\n<p>${product.description}</p>\n\n<h4>Vorteile & Eigenschaften:</h4>\n${advantages.map((adv: string) => `<p> ${adv}</p>`).join('\\n')}\n\n<h4>Technische Daten</h4>\n<table border=\"0\" summary=\"\">\n<tbody>\n${Object.entries(technicalSpecs).map(([key, value]) => \n  `<tr><td>${key}:</td><td>${value}</td></tr>`\n).join('\\n')}\n</tbody>\n</table>\n\n<h4>Sicherheit & Technologie</h4>\n<p>${safetyInfo}</p>\n\n<h4>Lieferumfang</h4>\n<p>${packageContents}</p>\n`.trim();\n}\n\n/**\n * Technical Data Block Template\n * Structured layout with product images and technical specifications\n */\nfunction technicalTemplate(product: CreatorProduct): string {\n  const images = product.images || [];\n  const imageHtml = images.map((img: ProductImage, index: number) => \n    `<img src=\"${img.dataUrl}\" alt=\"${product.name} - Bild ${index + 1}\" style=\"max-width: 100%; height: auto; margin-bottom: 15px; border-radius: 4px;\" />`\n  ).join('\\n');\n\n  return `\n<div style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n  <h2 style=\"color: #d50000; font-size: 24px; margin-bottom: 20px;\">${product.name}</h2>\n  \n  <div style=\"margin-bottom: 30px;\">\n    ${imageHtml}\n  </div>\n  \n  <div style=\"background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n    <h3 style=\"color: #d50000; font-size: 18px; margin-bottom: 15px;\">Produktbeschreibung</h3>\n    <p style=\"margin: 0; line-height: 1.8;\">${product.description}</p>\n  </div>\n  \n  <div style=\"margin-top: 30px;\">\n    <p style=\"color: #666; font-size: 14px; margin: 0;\">SKU: ${product.sku}</p>\n  </div>\n</div>\n`.trim();\n}\n\n/**\n * Storytelling Template\n * Engaging narrative style with emphasis on benefits\n */\nfunction storytellingTemplate(product: CreatorProduct): string {\n  const images = product.images || [];\n  const mainImage = images[0];\n  const additionalImages = images.slice(1);\n\n  return `\n<div style=\"font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.8; color: #2c3e50;\">\n  ${mainImage ? `\n  <div style=\"text-align: center; margin-bottom: 30px;\">\n    <img src=\"${mainImage.dataUrl}\" alt=\"${product.name}\" style=\"max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);\" />\n  </div>\n  ` : ''}\n  \n  <h1 style=\"color: #d50000; font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center;\">\n    ${product.name}\n  </h1>\n  \n  <div style=\"background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); padding: 25px; border-left: 4px solid #d50000; margin-bottom: 25px; border-radius: 4px;\">\n    <p style=\"font-size: 16px; margin: 0; color: #444;\">${product.description}</p>\n  </div>\n  \n  ${additionalImages.length > 0 ? `\n  <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px;\">\n    ${additionalImages.map((img: ProductImage, index: number) => \n      `<img src=\"${img.dataUrl}\" alt=\"${product.name} - Detail ${index + 1}\" style=\"width: 100%; height: auto; border-radius: 8px;\" />`\n    ).join('\\n')}\n  </div>\n  ` : ''}\n  \n  <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;\">\n    <p style=\"color: #888; font-size: 13px; margin: 0;\">Art.-Nr.: ${product.sku}</p>\n  </div>\n</div>\n`.trim();\n}\n\n/**\n * Minimal Template\n * Clean and simple layout focusing on essential information\n */\nfunction minimalTemplate(product: CreatorProduct): string {\n  const images = product.images || [];\n  const imageGallery = images.map((img: ProductImage, index: number) => \n    `<img src=\"${img.dataUrl}\" alt=\"${product.name} ${index + 1}\" style=\"width: 100%; max-width: 400px; height: auto; margin: 10px 0;\" />`\n  ).join('\\n');\n\n  return `\n<div style=\"font-family: 'Helvetica Neue', Arial, sans-serif; color: #333; max-width: 800px;\">\n  <h2 style=\"font-size: 22px; font-weight: 600; margin-bottom: 16px; color: #000;\">${product.name}</h2>\n  \n  ${imageGallery}\n  \n  <p style=\"font-size: 15px; line-height: 1.7; margin: 20px 0; color: #555;\">${product.description}</p>\n  \n  <p style=\"font-size: 13px; color: #999; margin-top: 24px;\">Artikelnummer: ${product.sku}</p>\n</div>\n`.trim();\n}\n\n/**\n * Feature List Template\n * Bullet-point style highlighting key features\n */\nfunction featureListTemplate(product: CreatorProduct): string {\n  const images = product.images || [];\n  const mainImage = images[0];\n  \n  // Extract features from description (split by periods, newlines, or bullet points)\n  const features = product.description\n    .split(/[.\\n]/)\n    .map((f: string) => f.trim())\n    .filter((f: string) => f.length > 10)\n    .slice(0, 5);\n\n  return `\n<div style=\"font-family: Arial, sans-serif; color: #333;\">\n  <div style=\"background: #d50000; color: white; padding: 20px; margin-bottom: 25px; border-radius: 8px 8px 0 0;\">\n    <h2 style=\"margin: 0; font-size: 24px; font-weight: bold;\">${product.name}</h2>\n  </div>\n  \n  ${mainImage ? `\n  <div style=\"text-align: center; margin-bottom: 25px;\">\n    <img src=\"${mainImage.dataUrl}\" alt=\"${product.name}\" style=\"max-width: 100%; height: auto; border-radius: 8px;\" />\n  </div>\n  ` : ''}\n  \n  <div style=\"background: #fafafa; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n    <h3 style=\"color: #d50000; font-size: 18px; margin-bottom: 15px;\"> Highlights</h3>\n    <ul style=\"list-style: none; padding: 0; margin: 0;\">\n      ${features.map((feature: string) => \n        `<li style=\"padding: 8px 0; border-bottom: 1px solid #e0e0e0;\">\n          <span style=\"color: #d50000; margin-right: 8px;\"></span>${feature}\n        </li>`\n      ).join('\\n')}\n    </ul>\n  </div>\n  \n  ${images.length > 1 ? `\n  <div style=\"display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;\">\n    ${images.slice(1).map((img: ProductImage, index: number) => \n      `<img src=\"${img.dataUrl}\" alt=\"Detail ${index + 1}\" style=\"width: calc(33.333% - 7px); height: auto; border-radius: 4px;\" />`\n    ).join('\\n')}\n  </div>\n  ` : ''}\n  \n  <div style=\"color: #666; font-size: 13px; margin-top: 20px;\">\n    <p style=\"margin: 0;\">Artikel: ${product.sku}</p>\n  </div>\n</div>\n`.trim();\n}\n\n/**\n * Available HTML templates for product descriptions\n */\nexport const htmlTemplates: HtmlTemplate[] = [\n  {\n    id: 'mediamarkt',\n    name: 'MediaMarkt',\n    description: 'MediaMarkt-konformes Template mit Vorteilen, technischer Tabelle und Lieferumfang',\n    category: 'technical',\n    templateFunction: mediaMarktTemplate,\n  },\n  {\n    id: 'technical',\n    name: 'Technische Daten',\n    description: 'Strukturiertes Layout mit Bildern und technischen Spezifikationen',\n    category: 'technical',\n    templateFunction: technicalTemplate,\n  },\n  {\n    id: 'storytelling',\n    name: 'Storytelling',\n    description: 'Ansprechende Narrative mit Fokus auf Benefits und Produktvorteilen',\n    category: 'storytelling',\n    templateFunction: storytellingTemplate,\n  },\n  {\n    id: 'minimal',\n    name: 'Minimal',\n    description: 'Klares und einfaches Layout mit essentiellen Informationen',\n    category: 'minimal',\n    templateFunction: minimalTemplate,\n  },\n  {\n    id: 'feature-list',\n    name: 'Feature-Liste',\n    description: 'Aufzhlungsstil mit Hervorhebung der wichtigsten Produktmerkmale',\n    category: 'technical',\n    templateFunction: featureListTemplate,\n  },\n];\n\n/**\n * Get template by ID\n */\nexport function getTemplateById(id: string): HtmlTemplate | undefined {\n  return htmlTemplates.find(t => t.id === id);\n}\n\n/**\n * Generate HTML description for a product using a specific template\n */\nexport function generateHtmlDescription(\n  product: CreatorProduct,\n  templateId: string\n): string {\n  const template = getTemplateById(templateId);\n  if (!template) {\n    throw new Error(`Template with ID \"${templateId}\" not found`);\n  }\n  return template.templateFunction(product);\n}\n","size_bytes":8319},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"server/credentials.ts":{"content":"import fs from 'fs';\nimport path from 'path';\n\nconst CREDENTIALS_FILE = path.join(process.cwd(), 'credentials.json');\n\ninterface Credentials {\n  openaiApiKey: string;\n  firecrawlApiKey: string;\n}\n\n// Load credentials from file\nexport function loadCredentials(): Credentials {\n  try {\n    if (fs.existsSync(CREDENTIALS_FILE)) {\n      const data = fs.readFileSync(CREDENTIALS_FILE, 'utf8');\n      const credentials = JSON.parse(data);\n      \n      // Set environment variables\n      if (credentials.openaiApiKey) {\n        process.env.OPENAI_API_KEY = credentials.openaiApiKey;\n      }\n      if (credentials.firecrawlApiKey) {\n        process.env.FIRECRAWL_API_KEY = credentials.firecrawlApiKey;\n      }\n      \n      console.log(' Credentials loaded from file');\n      return credentials;\n    }\n  } catch (error) {\n    console.error('Error loading credentials:', error);\n  }\n  \n  return { openaiApiKey: '', firecrawlApiKey: '' };\n}\n\n// Save credentials to file\nexport function saveCredentials(credentials: Credentials): void {\n  try {\n    fs.writeFileSync(CREDENTIALS_FILE, JSON.stringify(credentials, null, 2));\n    \n    // Set environment variables\n    if (credentials.openaiApiKey) {\n      process.env.OPENAI_API_KEY = credentials.openaiApiKey;\n    }\n    if (credentials.firecrawlApiKey) {\n      process.env.FIRECRAWL_API_KEY = credentials.firecrawlApiKey;\n    }\n    \n    console.log(' Credentials saved to file');\n  } catch (error) {\n    console.error('Error saving credentials:', error);\n  }\n}\n","size_bytes":1503},"client/src/components/api-key-manager.tsx":{"content":"import React, { useState, useEffect } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Alert, AlertDescription } from '@/components/ui/alert';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { Eye, EyeOff, Lock, Unlock, Trash2 } from 'lucide-react';\r\n\r\ninterface ApiKeyStatus {\r\n  openai: string | null;\r\n  firecrawl: string | null;\r\n}\r\n\r\nexport default function ApiKeyManager() {\r\n  const [apiKeys, setApiKeys] = useState<ApiKeyStatus>({ openai: null, firecrawl: null });\r\n  const [newApiKey, setNewApiKey] = useState('');\r\n  const [selectedService, setSelectedService] = useState<'openai' | 'firecrawl'>('openai');\r\n  const [showApiKey, setShowApiKey] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n\r\n  // API-Schlssel-Status laden\r\n  const loadApiKeyStatus = async () => {\r\n    try {\r\n      const response = await fetch('/api/api-key-status');\r\n      if (response.ok) {\r\n        const status = await response.json();\r\n        setApiKeys(status);\r\n      }\r\n    } catch (error) {\r\n      console.error('Fehler beim Laden des API-Schlssel-Status:', error);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadApiKeyStatus();\r\n  }, []);\r\n\r\n  // API-Schlssel verschlsselt speichern\r\n  const saveApiKey = async () => {\r\n    if (!newApiKey.trim()) {\r\n      toast({\r\n        variant: \"destructive\",\r\n        title: \"Fehler\",\r\n        description: \"Bitte geben Sie einen API-Schlssel ein\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      const response = await fetch('/api/encrypt-api-key', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          service: selectedService,\r\n          apiKey: newApiKey,\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast({\r\n          title: \"Erfolgreich\",\r\n          description: `${selectedService} API-Schlssel wurde verschlsselt gespeichert`,\r\n        });\r\n        setNewApiKey('');\r\n        loadApiKeyStatus();\r\n      } else {\r\n        const error = await response.json();\r\n        toast({\r\n          variant: \"destructive\",\r\n          title: \"Fehler\",\r\n          description: error.error || \"Fehler beim Speichern des API-Schlssels\",\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        variant: \"destructive\",\r\n        title: \"Fehler\",\r\n        description: \"Netzwerkfehler beim Speichern des API-Schlssels\",\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Alle API-Schlssel lschen\r\n  const clearAllApiKeys = async () => {\r\n    if (!confirm('Sind Sie sicher, dass Sie alle API-Schlssel lschen mchten?')) {\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      const response = await fetch('/api/clear-api-keys', {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast({\r\n          title: \"Erfolgreich\",\r\n          description: \"Alle API-Schlssel wurden gelscht\",\r\n        });\r\n        setApiKeys({ openai: null, firecrawl: null });\r\n      } else {\r\n        const error = await response.json();\r\n        toast({\r\n          variant: \"destructive\",\r\n          title: \"Fehler\",\r\n          description: error.error || \"Fehler beim Lschen der API-Schlssel\",\r\n        });\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        variant: \"destructive\",\r\n        title: \"Fehler\",\r\n        description: \"Netzwerkfehler beim Lschen der API-Schlssel\",\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-2xl mx-auto p-6 space-y-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Lock className=\"w-5 h-5\" />\r\n            API-Schlssel-Verwaltung\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Sichere Verschlsselung und Verwaltung Ihrer API-Schlssel\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-6\">\r\n          {/* Aktueller Status */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold\">Aktueller Status</h3>\r\n            \r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"p-3 border rounded-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  {apiKeys.openai ? <Unlock className=\"w-4 h-4 text-green-500\" /> : <Lock className=\"w-4 h-4 text-red-500\" />}\r\n                  <span className=\"font-medium\">OpenAI</span>\r\n                </div>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {apiKeys.openai || 'Nicht gesetzt'}\r\n                </p>\r\n              </div>\r\n              \r\n              <div className=\"p-3 border rounded-lg\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                  {apiKeys.firecrawl ? <Unlock className=\"w-4 h-4 text-green-500\" /> : <Lock className=\"w-4 h-4 text-red-500\" />}\r\n                  <span className=\"font-medium\">Firecrawl</span>\r\n                </div>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {apiKeys.firecrawl || 'Nicht gesetzt'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Neuen API-Schlssel hinzufgen */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-lg font-semibold\">Neuen API-Schlssel hinzufgen</h3>\r\n            \r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <Label htmlFor=\"service\">Service auswhlen</Label>\r\n                <select\r\n                  id=\"service\"\r\n                  value={selectedService}\r\n                  onChange={(e) => setSelectedService(e.target.value as 'openai' | 'firecrawl')}\r\n                  className=\"w-full p-2 border rounded-md\"\r\n                >\r\n                  <option value=\"openai\">OpenAI</option>\r\n                  <option value=\"firecrawl\">Firecrawl</option>\r\n                </select>\r\n              </div>\r\n              \r\n              <div>\r\n                <Label htmlFor=\"apiKey\">API-Schlssel</Label>\r\n                <div className=\"relative\">\r\n                  <Input\r\n                    id=\"apiKey\"\r\n                    type={showApiKey ? 'text' : 'password'}\r\n                    value={newApiKey}\r\n                    onChange={(e) => setNewApiKey(e.target.value)}\r\n                    placeholder=\"Ihr API-Schlssel...\"\r\n                    className=\"pr-10\"\r\n                  />\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\r\n                    onClick={() => setShowApiKey(!showApiKey)}\r\n                  >\r\n                    {showApiKey ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n              \r\n              <Button \r\n                onClick={saveApiKey} \r\n                disabled={isLoading || !newApiKey.trim()}\r\n                className=\"w-full\"\r\n              >\r\n                {isLoading ? 'Speichere...' : 'Verschlsselt speichern'}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Sicherheitshinweise */}\r\n          <Alert>\r\n            <Lock className=\"h-4 w-4\" />\r\n            <AlertDescription>\r\n              <strong>Sicherheitshinweise:</strong>\r\n              <ul className=\"mt-2 space-y-1 text-sm\">\r\n                <li> API-Schlssel werden mit AES-256 verschlsselt gespeichert</li>\r\n                <li> Schlssel werden nur im Arbeitsspeicher entschlsselt</li>\r\n                <li> Keine API-Schlssel werden in Logs oder Datenbanken gespeichert</li>\r\n                <li> Bei Server-Neustart mssen Schlssel neu eingegeben werden</li>\r\n              </ul>\r\n            </AlertDescription>\r\n          </Alert>\r\n\r\n          {/* Alle Schlssel lschen */}\r\n          <div className=\"pt-4 border-t\">\r\n            <Button \r\n              variant=\"destructive\" \r\n              onClick={clearAllApiKeys}\r\n              disabled={isLoading}\r\n              className=\"w-full\"\r\n            >\r\n              <Trash2 className=\"w-4 h-4 mr-2\" />\r\n              Alle API-Schlssel lschen\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","size_bytes":8752},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/section.tsx":{"content":"import React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface SectionProps extends React.HTMLAttributes<HTMLDivElement> {\n  title?: string;\n}\n\nexport const Section: React.FC<SectionProps> = ({ title, children, className, ...props }) => (\n  <section className={cn(\"py-10 px-4 md:px-10\", className)} {...props}>\n    {title && <h2 className=\"text-2xl font-bold mb-6\">{title}</h2>}\n    <div>{children}</div>\n  </section>\n);\n","size_bytes":430},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"server/ai-service.ts":{"content":"import OpenAI from 'openai';\n\n// Debug logging helper - only logs when DEBUG_MODE=true\nconst DEBUG_MODE = process.env.DEBUG_MODE === 'true';\nfunction debugLog(...args: any[]) {\n  if (DEBUG_MODE) {\n    console.log('[AI Service DEBUG]', ...args);\n  }\n}\n\n/**\n * Analyzes a product image using OpenAI Vision API to detect the dominant color\n * @param imageUrl - URL of the product image to analyze\n * @returns Detected color in German (schwarz, gelb, rot, blau, grn, wei, grau, etc.)\n */\nexport async function analyzeProductImageColor(imageUrl: string): Promise<string> {\n  try {\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      console.warn('[Image Color Analysis] OpenAI API key nicht konfiguriert - berspringe Farbanalyse');\n      return '';\n    }\n    \n    const openai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    console.log(`[Image Color Analysis] Analysiere Produktbild: ${imageUrl}`);\n    \n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: `Du bist ein Experte fr visuelle Produktanalyse. \n          \nAnalysiere das Produktbild und erkenne die HAUPTFARBE des Akkupacks/der Batterie.\n\nWICHTIG:\n- Ignoriere den Hintergrund\n- Fokussiere auf das Gehuse/die Ummantelung des Akkupacks\n- Gib NUR die Farbe auf Deutsch zurck (ein Wort)\n- Erlaubte Farben: schwarz, gelb, rot, blau, grn, wei, grau, orange, silber\n\nBeispiele:\n- Schwarzes Akkupack  \"schwarz\"\n- Gelbes Schrumpfschlauch  \"gelb\"\n- Rote Ummantelung  \"rot\"\n- Blaue Batterie  \"blau\"`\n        },\n        {\n          role: 'user',\n          content: [\n            {\n              type: 'text',\n              text: 'Welche Farbe hat dieser Akkupack/diese Batterie?'\n            },\n            {\n              type: 'image_url',\n              image_url: {\n                url: imageUrl,\n                detail: 'low' // Low detail fr schnellere/gnstigere Analyse\n              }\n            }\n          ]\n        }\n      ],\n      max_tokens: 10,\n      temperature: 0.3 // Niedrige Temperature fr konsistente Ergebnisse\n    });\n    \n    const detectedColor = response.choices[0]?.message?.content?.trim().toLowerCase() || '';\n    console.log(`[Image Color Analysis] Erkannte Farbe: ${detectedColor}`);\n    \n    // Validierung: Nur erlaubte Farben zurckgeben\n    const validColors = ['schwarz', 'gelb', 'rot', 'blau', 'grn', 'wei', 'grau', 'orange', 'silber'];\n    if (validColors.includes(detectedColor)) {\n      return detectedColor;\n    } else {\n      console.warn(`[Image Color Analysis] Unbekannte Farbe erkannt: ${detectedColor}`);\n      return '';\n    }\n    \n  } catch (error) {\n    console.error('[Image Color Analysis] Fehler bei Bildanalyse:', error);\n    return '';\n  }\n}\n\n// Helper function to clean HTML responses from markdown code blocks\nfunction cleanHTMLResponse(content: string): string {\n  // Remove markdown code blocks (```html, ```, etc.)\n  let cleaned = content.replace(/^```(?:html|HTML)?\\s*\\n?/gm, '');\n  cleaned = cleaned.replace(/\\n?```\\s*$/gm, '');\n  cleaned = cleaned.replace(/^```html\\s*\\n?/gm, '');\n  cleaned = cleaned.replace(/^```\\s*\\n?/gm, '');\n  \n  // KRITISCH: Entferne  Icons aus berschriften (MediaMarkt: nur in <li>)\n  cleaned = cleaned.replace(/<h[1-6]>\\s*([^<]+)<\\/h[1-6]>/g, '<h3>$1</h3>');\n  cleaned = cleaned.replace(/<h[1-6]>\\s*\\s*([^<]+)<\\/h[1-6]>/g, '<h3>$1</h3>');\n  \n  // MediaMarkt: Fix wrong h4 to h3\n  cleaned = cleaned.replace(/<h4>/g, '<h3>');\n  cleaned = cleaned.replace(/<\\/h4>/g, '</h3>');\n  \n  // Remove unwanted accessibility USPs (in <li> or <p>)\n  const unwantedPatterns = [\n    /<li>\\s*Drcken Sie die Eingabetaste.*?<\\/li>/gi,\n    /<li>\\s*Barrierefreiheit.*?<\\/li>/gi,\n    /<li>\\s*Screenreader.*?<\\/li>/gi,\n    /<li>\\s*Men.*?<\\/li>/gi,\n    /<li>\\s*Eingabetaste.*?<\\/li>/gi,\n    /<li>\\s*Blinde.*?<\\/li>/gi,\n    /<p>\\s*Drcken Sie die Eingabetaste.*?<\\/p>/gi,\n    /<p>\\s*Barrierefreiheit.*?<\\/p>/gi,\n  ];\n  \n  unwantedPatterns.forEach(pattern => {\n    cleaned = cleaned.replace(pattern, '');\n  });\n  \n  // MediaMarkt: Count <li> items in Vorteile section (should be 5)\n  const uspMatches = cleaned.match(/<li>.*?<\\/li>/g);\n  const uspCount = uspMatches ? uspMatches.length : 0;\n  \n  if (uspCount < 5) {\n    const fallbackUSPs = [\n      '<li> Hochwertige Verarbeitung fr lange Lebensdauer</li>',\n      '<li> Zuverlssige Leistung im Dauereinsatz</li>',\n      '<li> Einfache Handhabung und Bedienung</li>',\n      '<li> Optimales Preis-Leistungs-Verhltnis</li>',\n      '<li> Vielseitig einsetzbar</li>'\n    ];\n    \n    // Find Vorteile section and ensure it has <ul>\n    const vorteileSection = cleaned.match(/<h3>Vorteile & Eigenschaften<\\/h3>[\\s\\S]*?(?=<h3>|$)/);\n    if (vorteileSection) {\n      const newVorteileSection = `<h3>Vorteile & Eigenschaften</h3>\\n<ul>\\n${fallbackUSPs.join('\\n')}\\n</ul>`;\n      cleaned = cleaned.replace(vorteileSection[0], newVorteileSection);\n    }\n  }\n  \n  cleaned = cleaned.trim();\n  return cleaned;\n}\n\n// Helper functions to convert units\nfunction convertWeightToGrams(weightStr: string): string {\n  // Convert kg to g\n  const kgMatch = weightStr.match(/(\\d+(?:[.,]\\d+)?)\\s*kg/i);\n  if (kgMatch) {\n    const kgValue = parseFloat(kgMatch[1].replace(',', '.'));\n    const grams = Math.round(kgValue * 1000);\n    return weightStr.replace(kgMatch[0], `${grams} g`);\n  }\n  \n  // If already in grams, return as is\n  return weightStr;\n}\n\nfunction convertDimensionsToMm(dimensionsStr: string): string {\n  // Convert cm to mm\n  const cmMatch = dimensionsStr.match(/(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*cm/i);\n  if (cmMatch) {\n    const dim1 = Math.round(parseFloat(cmMatch[1].replace(',', '.')) * 10);\n    const dim2 = Math.round(parseFloat(cmMatch[2].replace(',', '.')) * 10);\n    const dim3 = Math.round(parseFloat(cmMatch[3].replace(',', '.')) * 10);\n    return dimensionsStr.replace(cmMatch[0], `${dim1}  ${dim2}  ${dim3} mm`);\n  }\n  \n  // If already in mm, return as is\n  return dimensionsStr;\n}\n\n// Helper function to convert units in extracted text\nfunction convertUnitsInText(text: string): string {\n  let convertedText = text;\n  \n  // Convert weight from kg to g\n  convertedText = convertedText.replace(/(\\d+(?:[.,]\\d+)?)\\s*kg/gi, (match, value) => {\n    const kgValue = parseFloat(value.replace(',', '.'));\n    const grams = Math.round(kgValue * 1000);\n    return `${grams} g`;\n  });\n  \n  // Convert dimensions from cm to mm\n  convertedText = convertedText.replace(/(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*cm/gi, (match, dim1, dim2, dim3) => {\n    const d1 = Math.round(parseFloat(dim1.replace(',', '.')) * 10);\n    const d2 = Math.round(parseFloat(dim2.replace(',', '.')) * 10);\n    const d3 = Math.round(parseFloat(dim3.replace(',', '.')) * 10);\n    return `${d1}  ${d2}  ${d3} mm`;\n  });\n  \n  return convertedText;\n}\n\n// Helper function to clean extracted text from markdown formatting\nfunction cleanExtractedText(content: string): string {\n  // Remove markdown code blocks (```plaintext, ```, etc.)\n  let cleaned = content.replace(/^```(?:plaintext|html|HTML)?\\s*\\n?/gm, '');\n  cleaned = cleaned.replace(/\\n?```\\s*$/gm, '');\n  \n  // Remove ALL occurrences of markdown bold indicators (**)\n  cleaned = cleaned.replace(/\\*\\*/g, '');\n  \n  // Remove ALL occurrences of markdown italic indicators (*)\n  cleaned = cleaned.replace(/\\*/g, '');\n  \n  // Remove any remaining markdown formatting\n  cleaned = cleaned.trim();\n  \n  // Convert units in the cleaned text\n  cleaned = convertUnitsInText(cleaned);\n  \n  return cleaned;\n}\n\n// Initialize OpenAI with API key from config or environment\nlet openai: OpenAI | null = null;\n\nimport { getSecureOpenAIKey } from './api-key-manager';\n\n// Function to get current API key from secure manager\nfunction getOpenAIKey(): string | null {\n  return getSecureOpenAIKey();\n}\n\nfunction getOpenAIBaseUrl(): string | undefined {\n  return process.env.OPENAI_BASE_URL || process.env.AI_INTEGRATIONS_OPENAI_BASE_URL;\n}\n\n// Initialize OpenAI with current API key\nconst apiKey = getOpenAIKey();\nconst baseUrl = getOpenAIBaseUrl();\n\nif (apiKey && apiKey !== 'dein-api-schlssel-hier') {\n  openai = new OpenAI({\n    apiKey: apiKey,\n    baseURL: baseUrl,\n  });\n}\n\nexport interface FileAnalysisResult {\n  fileName: string;\n  fileType: 'csv';\n  extractedText: string;\n  structuredData?: Record<string, any>;\n  confidence?: number;\n}\n\nexport async function analyzeCSV(text: string, fileName: string): Promise<FileAnalysisResult> {\n  const lines = text.split('\\n').filter(line => line.trim());\n  const headers = lines[0]?.split(/[,;\\t]/).map(h => h.trim()) || [];\n  const rows = lines.slice(1).map(line => {\n    const values = line.split(/[,;\\t]/).map(v => v.trim());\n    return headers.reduce((obj, header, index) => {\n      obj[header] = values[index] || '';\n      return obj;\n    }, {} as Record<string, string>);\n  });\n\n  return {\n    fileName,\n    fileType: 'csv',\n    extractedText: cleanExtractedText(text),\n    structuredData: { headers, rows },\n    confidence: 1.0,\n  };\n}\n\nexport async function generateProductDescription(\n  extractedData: any[],\n  template?: string,\n  customAttributes?: {\n    exactProductName?: string;\n    articleNumber?: string;\n    customAttributes?: Array<{key: string, value: string, type: string}>;\n    structuredData?: Record<string, any>; // WICHTIG: Strukturierte Daten (length, led1, led2, etc.)\n    technicalDataTable?: string; // Original HTML table from supplier\n    safetyWarnings?: string; // 1:1 safety warnings from supplier\n    pdfManualUrl?: string; // PDF manual URL\n  },\n  model: string = 'gpt-4o-mini', // COST OPTIMIZATION: 30 gnstiger!\n  onProgress?: (step: number, message: string) => void\n): Promise<{ html: string; categoryId: string; enrichedProductData: any }> {\n  console.log(`=== USING CATEGORY-BASED GENERATION with ${model} ===`);\n  \n  const { detectCategory, getCategoryConfig } = await import('./templates/category-config.js');\n  const { generateProductCopy } = await import('./templates/ai-generator.js');\n  const { renderProductHtml } = await import('./templates/renderer.js');\n  \n  const currentApiKey = getOpenAIKey();\n  const currentBaseUrl = getOpenAIBaseUrl();\n  \n  if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n    throw new Error('OpenAI API key nicht konfiguriert');\n  }\n\n  const firstData = extractedData[0] || {};\n  const productName = customAttributes?.exactProductName || firstData.productName || firstData.product_name || '';\n  \n  // WICHTIG: Strukturierte Daten (length, led1, led2, maxLuminosity, etc.) mit productData zusammenfhren\n  const enrichedProductData = {\n    ...firstData,\n    ...(customAttributes?.structuredData || {})  // Technische Felder hinzufgen\n  };\n  \n  console.log(' [AI-SERVICE] Enriched product data fields:', Object.keys(enrichedProductData));\n  console.log(' [AI-SERVICE] Nitecore fields:', {\n    length: enrichedProductData.length,\n    led1: enrichedProductData.led1,\n    led2: enrichedProductData.led2,\n    maxLuminosity: enrichedProductData.maxLuminosity\n  });\n  \n  const categoryId = detectCategory(enrichedProductData);\n  const categoryConfig = getCategoryConfig(categoryId);\n  \n  console.log(`Detected category: ${categoryId} (${categoryConfig.name})`);\n\n  const copy = await generateProductCopy(\n    enrichedProductData,  // WICHTIG: Angereicherte Daten bergeben!\n    categoryConfig,\n    currentApiKey,\n    currentBaseUrl,\n    model  // Pass model to AI generator\n  );\n\n  const html = renderProductHtml({\n    productName,\n    categoryConfig,\n    copy,\n    layoutStyle: 'mediamarkt',\n    technicalDataTable: customAttributes?.technicalDataTable, // Pass original HTML table\n    safetyWarnings: customAttributes?.safetyWarnings, // Pass 1:1 safety warnings\n    pdfManualUrl: customAttributes?.pdfManualUrl // Pass PDF URL\n  });\n\n  return { html, categoryId, enrichedProductData };\n}\n\nexport async function convertTextToHTML(\n  plainText: string,\n  extractedData?: string[]\n): Promise<string> {\n  try {\n    // Get current API key\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      console.log('OpenAI API key not configured. Returning fallback description.');\n      return 'OpenAI API key nicht konfiguriert. Bitte konfigurieren Sie den API-Schlssel.';\n    }\n    \n    // Create OpenAI instance with current key\n    const currentOpenai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    const dataContext = extractedData?.length \n      ? `\\n\\nZustzliche Produktdaten:\\n${extractedData.join('\\n\\n---\\n\\n')}`\n      : '';\n\n    const response = await currentOpenai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        {\n          role: 'system',\n          content: `Du bist ein Experte fr MediaMarkt-Produktbeschreibungen. Erstelle eine HTML-Produktbeschreibung nach MediaMarkt-Standard.\n\nMEDIAMARKT HTML-STRUKTUR (EXAKT SO):\n\n<h2>Produktname</h2>\n<p>Einleitungstext (1-2 Stze ber das Produkt)</p>\n\n<h3>Vorteile & Eigenschaften</h3>\n<ul>\n<li> Vorteil 1 - verkaufsfrdernde Beschreibung</li>\n<li> Vorteil 2 - verkaufsfrdernde Beschreibung</li>\n<li> Vorteil 3 - verkaufsfrdernde Beschreibung</li>\n<li> Vorteil 4 - verkaufsfrdernde Beschreibung</li>\n<li> Vorteil 5 - verkaufsfrdernde Beschreibung</li>\n</ul>\n\n<h3>Technische Daten</h3>\n<table border=\"0\" cellspacing=\"0\" cellpadding=\"4\">\n<tbody>\n<tr><td><strong>Feldname:</strong></td><td>Wert</td></tr>\n...\n</tbody>\n</table>\n\n<h3>Sicherheit & Technologie</h3>\n<p>Beschreibung (NUR wenn relevante Daten vorhanden)</p>\n\n<h3>Lieferumfang</h3>\n<p>1  Produktname</p>\n\nKRITISCHE REGELN:\n- IMMER <h2> fr Produktname, IMMER <h3> fr berschriften\n- Vorteile IMMER als <ul><li> Text</li></ul> (NICHT als <p>)\n-  Icons NUR in <li>, NIEMALS in berschriften\n- Technische Daten IMMER in <table> (1:1 vom Lieferanten kopiert)\n- \"Sicherheit & Technologie\" NUR wenn relevante Daten vorhanden\n- Lieferumfang immer am Ende\n\n VERBOTEN in Vorteilen: Technische Specs (Volt, mAh, Gramm, mm, etc.)\n ERLAUBT in Vorteilen: Verkaufsargumente (\"Lange Laufzeit\", \"Sicher durch Schutzschaltung\", etc.)\n\nGib NUR den reinen HTML-Code zurck, OHNE \\`\\`\\`html oder \\`\\`\\`.`,\n        },\n        {\n          role: 'user',\n          content: `Erstelle MediaMarkt-Produktbeschreibung aus:\\n\\n${plainText}${dataContext}`,\n        },\n      ],\n      max_tokens: 2000,\n      temperature: 0.5,\n    });\n\n    const generatedContent = response.choices[0]?.message?.content || '';\n    \n    // Clean up the response to remove markdown code blocks\n    return cleanHTMLResponse(generatedContent);\n  } catch (error) {\n    throw new Error(`Text to HTML conversion failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function refineDescription(\n  currentDescription: string,\n  userPrompt: string,\n  extractedData?: string[]\n): Promise<string> {\n  try {\n    // Get current API key\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      console.log('OpenAI API key not configured. Returning fallback description.');\n      return 'OpenAI API key nicht konfiguriert. Bitte konfigurieren Sie den API-Schlssel.';\n    }\n    \n    // Create OpenAI instance with current key\n    const currentOpenai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    const dataContext = extractedData?.length \n      ? `\\n\\nVerfgbare Produktdaten:\\n${extractedData.join('\\n\\n---\\n\\n')}`\n      : '';\n\n    const response = await currentOpenai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        {\n          role: 'system',\n          content: `Du bist ein Experte fr E-Commerce-Produktbeschreibungen. \nVerfeinere die bestehende HTML-Produktbeschreibung basierend auf den Anweisungen des Users.\n\nWICHTIG: Erstelle KEINE feste Struktur! Passe die Struktur an die verfgbaren Daten an.\n\nWichtig:\n- Behalte die HTML-Struktur bei\n- Setze die nderungen przise um\n- Gib NUR den reinen HTML-Code zurck, OHNE \\`\\`\\`html am Anfang oder \\`\\`\\` am Ende\n- Verwende KEINE Markdown-Codeblcke oder zustzliche Erklrungen\n- Fr technische Daten in Tabellen: Abmessungen in mm, Gewicht in g\n- KEINE festen Sektionen - nur das was Daten hat\n- Passe die Struktur an die verfgbaren Daten an`,\n        },\n        {\n          role: 'user',\n          content: `Aktuelle Produktbeschreibung:\\n\\n${currentDescription}\\n\\nnderungswunsch: ${userPrompt}${dataContext}`,\n        },\n      ],\n      max_tokens: 2000,\n      temperature: 0.7,\n    });\n\n    const generatedContent = response.choices[0]?.message?.content || '';\n    \n    // Clean up the response to remove markdown code blocks\n    return cleanHTMLResponse(generatedContent);\n  } catch (error) {\n    throw new Error(`Description refinement failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function generateProductName(\n  extractedData: string[]\n): Promise<string> {\n  try {\n    // Get current API key\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      console.log('OpenAI API key not configured. Returning fallback description.');\n      return 'OpenAI API key nicht konfiguriert. Bitte konfigurieren Sie den API-Schlssel.';\n    }\n    \n    // Create OpenAI instance with current key\n    const currentOpenai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    const combinedData = extractedData.join('\\n\\n---\\n\\n');\n\n    const response = await currentOpenai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        {\n          role: 'system',\n          content: `Du bist ein Experte fr E-Commerce-Produktnamen. \nGeneriere einen kurzen, prgnanten Produktnamen basierend auf den extrahierten Produktdaten.\n\nDer Produktname sollte:\n- Maximal 60 Zeichen lang sein\n- Den wichtigsten Produkttyp und die Marke enthalten\n- Klar und professionell formuliert sein\n- Ohne Anfhrungszeichen oder Sonderformatierung sein\n- Im Format: \"Marke Produkttyp Modell/Variante\" (z.B. \"Varta Wiederaufladbare AA-Batterie USB\")\n\nGib NUR den Produktnamen zurck, ohne zustzliche Erklrungen oder Formatierung.`,\n        },\n        {\n          role: 'user',\n          content: `Extrahierte Produktdaten:\\n\\n${combinedData}`,\n        },\n      ],\n      max_tokens: 100,\n      temperature: 0.5,\n    });\n\n    let productName = response.choices[0]?.message?.content || '';\n    \n    // Clean up the product name\n    productName = productName.replace(/^[\"']|[\"']$/g, '').trim();\n    \n    return productName;\n  } catch (error) {\n    throw new Error(`Product name generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n// ===== NEUER 3-STUFEN WORKFLOW =====\n\n// ===== SCHRITT 1: DATENEXTRAKTION =====\nexport async function extractProductData(htmlOrText: string): Promise<any> {\n  try {\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      throw new Error('OpenAI API key nicht konfiguriert');\n    }\n    \n    const openai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    const systemPrompt = `Du bist ein Datenextraktions-Agent fr Produktseiten.\n\n Wichtige Regeln:\n1. Ignoriere jegliche vorherige Inhalte, Zwischenspeicher oder temporre Variablen.  \n   Erstelle die Ausgabe **ausschlielich basierend auf der aktuellen Eingabe (input)**.  \n   Verwende keine Daten aus Cache, Memory, Session oder Response-Historie.\n2. Verarbeite jede Anfrage als **vollstndig neuen Kontext**.\n3. Deine Ausgabe muss **ausschlielich valides JSON** sein  keine Markdown-Zeichen, keine Code-Blcke.\n4. Der JSON-Code beginnt immer mit { und endet mit }.\n5. Wenn du alten oder fehlerhaften Inhalt erkennst, **berschreibe den gesamten Inhalt neu**.\n\nAnalysiere den folgenden HTML- oder Textinhalt einer Lieferantenseite und extrahiere nur die relevanten Produktinformationen.\n\nLiefere das Ergebnis ausschlielich als gltiges JSON im folgenden Format:\n\n{\n  \"product_name\": \"\",\n  \"short_intro\": \"\",\n  \"features\": [],\n  \"performance\": {\n    \"flutlicht\": {},\n    \"spotlicht\": {},\n    \"mix\": {}\n  },\n  \"technical_data\": {},\n  \"use_cases\": [],\n  \"safety_notes\": \"\",\n  \"package_contents\": \"\"\n}\n\nRegeln:\n- Extrahiere nur das Hauptprodukt (keine Zubehrartikel oder Alternativen).\n- Falls ein Wert fehlt, lasse das Feld leer (\"\").\n- Werte aus Tabellen oder Stichpunkten korrekt bernehmen.\n- Leistungsdaten (Lumen, Stunden, Modi etc.) sollen als Key-Value-Paare bernommen werden.\n- Entferne HTML-Tags, behalte nur reinen Text.\n- Achte auf Sonderzeichen (, , ) in Unicode (nicht als Entities).\n\nBeispielausgabe:\n{\n  \"product_name\": \"Nitecore P40 - LEP-Laser Lampe, 2000 Lumen\",\n  \"short_intro\": \"Leistungsstarke LEP-Taschenlampe mit 2000 Lumen und 2900 m Reichweite.\",\n  \"features\": [\n    \"Bis zu 2000 Lumen Lichtleistung\",\n    \"Drei Lichtmodi: Spot-, Flut- und Mixbetrieb\",\n    \"HAIII eloxiertes Aluminiumgehuse, IP68\",\n    \"USB-C Schnellladefunktion\"\n  ],\n  \"performance\": {\n    \"flutlicht\": {\n      \"high\": \"800 Lumen  2h30min\",\n      \"mid\": \"400 Lumen  4h\",\n      \"low\": \"100 Lumen  20h\"\n    },\n    \"spotlicht\": {\n      \"turbo\": \"2000 Lumen  1h\",\n      \"high\": \"400 Lumen  2h30min\",\n      \"mid\": \"200 Lumen  3h45min\",\n      \"low\": \"50 Lumen  20h\"\n    }\n  },\n  \"technical_data\": {\n    \"Leuchtweite\": \"2900 m\",\n    \"Gewicht\": \"186 g\",\n    \"Akku\": \"21700 Li-Ion 5500 mAh\",\n    \"Wasserschutz\": \"IP68\"\n  },\n  \"use_cases\": [\"Outdoor\", \"Polizei\", \"Jagd\"],\n  \"safety_notes\": \"Nur mit geeigneten Akkus betreiben, nicht in Augen leuchten.\",\n  \"package_contents\": \"Lampe, Akku, Holster, USB-C-Kabel, Ersatzringe\"\n}\n\nDie Ausgabe ist valides JSON.`;\n\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: htmlOrText }\n      ],\n      temperature: 0.1,\n    });\n\n    const jsonString = response.choices[0]?.message?.content?.trim() || '{}';\n    \n    // Parse JSON und validieren\n    try {\n      // Clean JSON response - remove markdown code blocks\n      let cleanedContent = jsonString;\n      cleanedContent = cleanedContent.replace(/^```json\\s*\\n?/gm, '');\n      cleanedContent = cleanedContent.replace(/\\n?```\\s*$/gm, '');\n      cleanedContent = cleanedContent.replace(/^```\\s*\\n?/gm, '');\n      cleanedContent = cleanedContent.trim();\n      \n      console.log('Cleaned JSON:', cleanedContent);\n      \n      return JSON.parse(cleanedContent);\n    } catch (parseError) {\n      console.error('JSON Parse Error:', parseError);\n      console.error('Raw response:', jsonString);\n      throw new Error('KI konnte keine gltigen JSON-Daten extrahieren');\n    }\n    \n  } catch (error) {\n    console.error('ExtractProductData error:', error);\n    throw error;\n  }\n}\n\n// ===== SCHRITT 2: VALIDIERUNG & NORMALISIERUNG =====\nexport function normalizeProductData(input: any): any {\n  const data = typeof input === \"string\" ? JSON.parse(input) : input;\n\n  // Konvertiere Gewicht zu Gramm\n  const convertWeightToGrams = (weightStr: string): string => {\n    if (!weightStr || weightStr === 'Nicht angegeben') return 'Nicht angegeben';\n    \n    const weight = parseFloat(weightStr.replace(/[^\\d.,]/g, '').replace(',', '.'));\n    if (isNaN(weight)) return weightStr;\n    \n    if (weightStr.toLowerCase().includes('kg')) {\n      return `${Math.round(weight * 1000)} g`;\n    } else if (weightStr.toLowerCase().includes('g')) {\n      return `${Math.round(weight)} g`;\n    } else {\n      return `${Math.round(weight)} g`;\n    }\n  };\n  \n  // Konvertiere Abmessungen zu mm\n  const convertDimensionsToMm = (dimStr: string): string => {\n    if (!dimStr || dimStr === 'Nicht angegeben') return 'Nicht angegeben';\n    \n    // Wenn bereits mm enthalten, zurckgeben\n    if (dimStr.toLowerCase().includes('mm')) return dimStr;\n    \n    // Wenn cm enthalten, zu mm konvertieren\n    if (dimStr.toLowerCase().includes('cm')) {\n      const numbers = dimStr.match(/[\\d.,]+/g);\n      if (numbers) {\n        const converted = numbers.map(num => {\n          const val = parseFloat(num.replace(',', '.'));\n          return isNaN(val) ? num : String(Math.round(val * 10));\n        });\n        // Ersetze Zahlen und entferne \"cm\", fge \"mm\" hinzu\n        let idx = 0;\n        return dimStr.replace(/[\\d.,]+/g, () => converted[idx++]).replace(/cm/gi, '') + ' mm';\n      }\n    }\n    \n    return dimStr;\n  };\n\n  // Konvertiere Gewicht und Abmessungen\n  if (data.weight) {\n    data.weight = convertWeightToGrams(data.weight);\n  }\n  if (data.size) {\n    data.size = convertDimensionsToMm(data.size);\n  }\n  if (data.abmessungen) {\n    data.abmessungen = convertDimensionsToMm(data.abmessungen);\n  }\n  if (data.gewicht) {\n    data.gewicht = convertWeightToGrams(data.gewicht);\n  }\n\n  // Standardwerte ergnzen\n  if (!data.safety_notes) {\n    data.safety_notes = \"Bitte beachten Sie die Sicherheitsanweisungen des Herstellers zur sicheren Verwendung des Produkts.\";\n  }\n\n  if (!data.package_contents) {\n    data.package_contents = \"Lieferumfang: Produkt wie beschrieben.\";\n  }\n\n  if (!data.use_cases || data.use_cases.length === 0) {\n    data.use_cases = [\"Haushalt\", \"Werkstatt\", \"Outdoor\"];\n  }\n\n  // Einheitliche Reihenfolge erzwingen\n  const ordered = {\n    product_name: data.product_name || \"\",\n    short_intro: data.short_intro || \"\",\n    features: data.features || [],\n    performance: data.performance || {},\n    technical_data: data.technical_data || {},\n    use_cases: data.use_cases || [],\n    safety_notes: data.safety_notes || \"\",\n    package_contents: data.package_contents || \"\",\n    // Fge konvertierte Werte hinzu\n    leistung: data.leistung || data.power || 'Nicht angegeben',\n    spannung: data.spannung || data.voltage || 'Nicht angegeben',\n    gewicht: data.gewicht || data.weight || 'Nicht angegeben',\n    abmessungen: data.abmessungen || data.size || 'Nicht angegeben',\n    material: data.material || 'Nicht angegeben',\n    feature_1: data.feature_1 || 'Hochwertige Verarbeitung',\n    feature_2: data.feature_2 || 'Zuverlssige Leistung',\n    feature_3: data.feature_3 || 'Benutzerfreundliches Design',\n    feature_4: data.feature_4 || 'Langlebige Qualitt',\n    feature_5: data.feature_5 || 'Optimales Preis-Leistungs-Verhltnis'\n  };\n\n  return ordered;\n}\n\n// ===== SCHRITT 3: HTML-GENERIERUNG =====\nexport async function generateAkkushopDescription(normalizedData: any): Promise<string> {\n  try {\n    const currentApiKey = getOpenAIKey();\n    const currentBaseUrl = getOpenAIBaseUrl();\n    \n    if (!currentApiKey || currentApiKey === 'dein-api-schlssel-hier') {\n      throw new Error('OpenAI API key nicht konfiguriert');\n    }\n    \n    const openai = new OpenAI({\n      apiKey: currentApiKey,\n      baseURL: currentBaseUrl,\n    });\n    \n    const systemPrompt = `Du bist ein spezialisierter Produkttext-Agent fr den Onlineshop Akkushop.de.\n\nERSTELLE IMMER DIESE EXAKTE STRUKTUR:\n\n<ul>\n<li>\n<h2>PRODUKTNAME</h2>\n<p>USP 1 (produktspezifisch basierend auf technischen Specs, z.B. \"Hohe Energiedichte\")<br />\nUSP 2 (produktspezifisch, z.B. \"Thermisch stabil\")<br />\nUSP 3 (produktspezifisch, z.B. \"Schutzschaltung integriert\")<br />\nVersandkostenfrei ab 39,95 Kundenservice <span style=\"color: green;\"></span>071517071010</p>\n\nKRITISCH: KEINE langen Produktbeschreibungen! Nur kurze USP-Bulletpoints!\nDie ersten 3 Bulletpoints () mssen PRODUKTSPEZIFISCHE USPs sein (kurz und prgnant)!\nDie letzten 2 USPs sind IMMER zusammen in einer Zeile: \"Versandkostenfrei ab 39,95 Kundenservice <span style=\"color: green;\"></span>071517071010\"\n\nFORMATIERUNG:\n- Verwende  (nicht )\n- KEIN Leerzeichen zwischen  und Text\n- Telefonnummer mit grnem  Symbol: <span style=\"color: green;\"></span>071517071010\n\nPRODUKTSPEZIFISCHE USPs (whle aus technischen Specs):\n Akkupack mit mehreren Zellen  \"Hohe Energiedichte - langanhaltende Leistung\"\n Hohe Kapazitt (>2000 mAh)  \"Lange Laufzeit - fr intensive Anwendungen\"\n Lithium-Ionen Zellenchemie  \"Moderne Li-Ion Technologie - keine Memory-Effekte\"\n Integrierte Schutzschaltung  \"Schutzschaltung integriert - Sicherheit vor berladung\"\n Thermisch stabil  \"Thermisch stabil - sicher bei hohen Temperaturen\"\n Hoher Entladestrom  \"Hoher Entladestrom - fr leistungsstarke Gerte\"\n Wiederaufladbar  \"Wiederaufladbar - nachhaltig und kostensparend\"\n\nVERBOTEN in den Bulletpoints:\n Reine Zahlenwerte (z.B. \"7,2 V\", \"5200 mAh\", \"184 g\", \"7037.537.5 mm\")\n Technische Rohdaten ohne Kundennutzen\n Generische USPs wenn produktspezifische Daten verfgbar sind\n\nPRODUKTTYP-ERKENNUNG:\n- Wenn Spannung + Kapazitt vorhanden  \"Akkupack\" (nicht \"Batterie\")\n- Wenn nur Spannung  \"Batterie\"</p>\n\n<h3>Produkteigenschaften & Highlights</h3>\n<ul>\n<li>Robustes Gehuse und langlebige Verarbeitung</li>\n<li>Ergonomisches Design fr komfortables Arbeiten</li>\n<li>Hohe Leistung bei geringem Energieverbrauch</li>\n<li>Vielseitig einsetzbar in Werkstatt und Haushalt</li>\n<li>Optimales Preis-Leistungs-Verhltnis</li>\n</ul>\n\n<h4>Technische Daten:</h4>\n<table border=\"0\" summary=\"\">\n<tbody>\n<tr><td>Leistung:</td><td>VERWENDE technicalSpecs.standards ODER technicalSpecs.kapazitt</td></tr>\n<tr><td>Spannung:</td><td>VERWENDE technicalSpecs.ladestrom ODER technicalSpecs.spannung</td></tr>\n<tr><td>Gewicht:</td><td>VERWENDE technicalSpecs.weight</td></tr>\n<tr><td>Abmessungen:</td><td>VERWENDE technicalSpecs.size (Format: LBH mm)</td></tr>\n<tr><td>Material:</td><td>VERWENDE technicalSpecs.material ODER \"Lithium-Ionen\" fr Akkus</td></tr>\n</tbody>\n</table>\n\n<p>PRODUKTNAME steht fr Qualitt, Zuverlssigkeit und Langlebigkeit  ideal fr den tglichen Einsatz.</p>\n\n<h3>Sicherheitshinweise</h3>\n<p> Nicht ins Feuer werfen oder erhitzen. Vor Kurzschluss schtzen. Nur mit geeigneten Ladegerten laden. Von Kindern fernhalten. Bei Beschdigung nicht mehr verwenden.</p>\n\n<h3>Lieferumfang</h3>\n<p>LIEFERUMFANG AUS DATEN</p>\n</li>\n</ul>\n\nWICHTIGE REGELN:\n1. Verwende NUR die Daten aus den Produktdaten\n2. Ersetze PRODUKTNAME durch den echten Produktnamen\n3. Ersetze Feature 1-5 durch echte Produktfeatures\n4. Ersetze WERT AUS DATEN durch echte technische Werte\n5. Ersetze LIEFERUMFANG AUS DATEN durch echte Lieferumfang-Angaben\n6. berschriften OHNE Icons (nur Text)\n7. Verwende  (nicht ) fr USPs in <p> Elementen\n8. KEIN Leerzeichen zwischen  und Text\n9. Letzte Zeile IMMER: \"Versandkostenfrei ab 39,95 Kundenservice <span style=\"color: green;\"></span>071517071010\"\n10. Abmessungen Format: \"LBH mm\" (z.B. \"572069 mm\") - NICHT \"572069 mm\"\n9. Gewicht immer in Gramm (g)\n10. Verwende IMMER die Werte aus technicalSpecs.size fr Abmessungen, NICHT aus bullets\n11. Gib NUR den HTML-Code zurck, ohne \\`\\`\\`html`;\n\n    // Bereinige Bulletpoints - entferne technische Daten, die bereits in technicalSpecs stehen\n    if (normalizedData.bullets) {\n      normalizedData.bullets = normalizedData.bullets.filter((bullet: string) => {\n        const bulletLower = bullet.toLowerCase();\n        // Entferne Bulletpoints mit technischen Daten, die bereits in technicalSpecs stehen\n        return !bulletLower.includes('abmessungen:') && \n               !bulletLower.includes('gewicht:') && \n               !bulletLower.includes('spannung:') && \n               !bulletLower.includes('kapazitt:') &&\n               !bulletLower.includes('entladestrom:') &&\n               !bulletLower.includes('nominalspannung:') &&\n               !bulletLower.includes('nominalkapazitt:') &&\n               !bulletLower.includes('max. entladestrom:') &&\n               !bulletLower.includes('zulassungen:');\n      });\n      console.log('Bereinigte Bulletpoints:', normalizedData.bullets);\n    }\n\n    // Formatiere Abmessungen korrekt vor der AI-Verarbeitung\n    if (normalizedData.size && normalizedData.size.includes('')) {\n      // Abmessungen sind bereits korrekt formatiert\n      console.log('Abmessungen bereits korrekt formatiert:', normalizedData.size);\n    } else if (normalizedData.size && normalizedData.size.match(/^\\d+mm$/)) {\n      // Konvertiere \"572069mm\" zu \"572069 mm\"\n      const numbers = normalizedData.size.match(/\\d+/g);\n      if (numbers && numbers[0].length >= 6) {\n        const numStr = numbers[0];\n        const dim1 = numStr.substring(0, 2);\n        const dim2 = numStr.substring(2, 4);\n        const dim3 = numStr.substring(4, 6);\n        normalizedData.size = `${dim1}${dim2}${dim3} mm`;\n        console.log('Abmessungen korrigiert:', normalizedData.size);\n      }\n    }\n\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: JSON.stringify(normalizedData, null, 2) }\n      ],\n      temperature: 0.3,\n    });\n\n    return response.choices[0]?.message?.content?.trim() || '';\n    \n  } catch (error) {\n    console.error('GenerateAkkushopDescription error:', error);\n    throw error;\n  }\n}\n\n// ===== KOMPLETTER WORKFLOW MIT FORTSCHRITT =====\nexport async function processProductWithNewWorkflow(htmlOrText: string, onProgress?: (step: number, message: string) => void): Promise<string> {\n  try {\n    console.log('=== NEUER WORKFLOW GESTARTET ===');\n    \n    // Schritt 1: Daten extrahieren\n    console.log('Schritt 1: ExtractProductData...');\n    onProgress?.(33, 'Daten werden extrahiert...');\n    const extractedData = await extractProductData(htmlOrText);\n    debugLog('Extrahierte Daten:', extractedData);\n    \n    // Schritt 2: Daten normalisieren\n    console.log('Schritt 2: NormalizeProductData...');\n    onProgress?.(66, 'Daten werden strukturiert...');\n    const normalizedData = normalizeProductData(extractedData);\n    debugLog('Normalisierte Daten:', normalizedData);\n    \n    // Schritt 3: HTML generieren mit einfacher Template-Funktion\n    console.log('Schritt 3: GenerateAkkushopDescription...');\n    onProgress?.(90, 'Produktbeschreibung wird generiert...');\n    \n    // Verwende die einfache Template-Funktion statt der komplexen AI-Funktion\n    const productName = normalizedData.product_name || 'Unbekanntes Produkt';\n    const description = normalizedData.short_intro || 'Hochwertiges Produkt fr professionelle Anwendungen.';\n    \n    // Extrahiere Features\n    const features = [\n      normalizedData.feature_1 || 'Hochwertige Verarbeitung',\n      normalizedData.feature_2 || 'Zuverlssige Leistung', \n      normalizedData.feature_3 || 'Benutzerfreundliches Design',\n      normalizedData.feature_4 || 'Langlebige Qualitt',\n      normalizedData.feature_5 || 'Optimales Preis-Leistungs-Verhltnis'\n    ];\n    \n    // Konvertiere Gewicht zu Gramm\n    const convertWeightToGrams = (weightStr: string): string => {\n      if (!weightStr || weightStr === 'Nicht angegeben') return 'Nicht angegeben';\n      \n      const weight = parseFloat(weightStr.replace(/[^\\d.,]/g, '').replace(',', '.'));\n      if (isNaN(weight)) return weightStr;\n      \n      if (weightStr.toLowerCase().includes('kg')) {\n        return `${Math.round(weight * 1000)} g`;\n      } else if (weightStr.toLowerCase().includes('g')) {\n        return `${Math.round(weight)} g`;\n      } else {\n        // Annahme: wenn keine Einheit, dann Gramm\n        return `${Math.round(weight)} g`;\n      }\n    };\n    \n    // Konvertiere Abmessungen zu mm\n    const convertDimensionsToMm = (dimStr: string): string => {\n      if (!dimStr || dimStr === 'Nicht angegeben') return 'Nicht angegeben';\n      \n      // Wenn bereits mm enthalten, zurckgeben\n      if (dimStr.toLowerCase().includes('mm')) return dimStr;\n      \n      // Wenn cm enthalten, zu mm konvertieren\n      if (dimStr.toLowerCase().includes('cm')) {\n        const numbers = dimStr.match(/[\\d.,]+/g);\n        if (numbers) {\n          const converted = numbers.map(num => {\n            const val = parseFloat(num.replace(',', '.'));\n            return isNaN(val) ? num : String(Math.round(val * 10));\n          });\n          // Ersetze Zahlen und entferne \"cm\", fge \"mm\" hinzu\n          let idx = 0;\n          return dimStr.replace(/[\\d.,]+/g, () => converted[idx++]).replace(/cm/gi, '') + ' mm';\n        }\n      }\n      \n      return dimStr;\n    };\n    \n    // Technische Daten mit Konvertierung - prfe alle mglichen Feldnamen\n    const rawWeight = normalizedData.gewicht || normalizedData.weight || normalizedData.produktgewicht || 'Nicht angegeben';\n    const rawDimensions = normalizedData.abmessungen || normalizedData.size || normalizedData.dimensions || 'Nicht angegeben';\n    \n    const power = normalizedData.leistung || normalizedData.power || 'Nicht angegeben';\n    const voltage = normalizedData.spannung || normalizedData.voltage || 'Nicht angegeben';\n    const weight = convertWeightToGrams(rawWeight);\n    const dimensions = convertDimensionsToMm(rawDimensions);\n    const material = normalizedData.material || 'Nicht angegeben';\n    const packageContents = normalizedData.package_contents || 'Produkt wie beschrieben';\n    const safetyNotes = normalizedData.safety_notes || ' Nicht ins Feuer werfen oder erhitzen. Vor Kurzschluss schtzen. Nur mit geeigneten Ladegerten laden. Von Kindern fernhalten. Bei Beschdigung nicht mehr verwenden.';\n    \n    const htmlDescription = `<ul>\n<li>\n<h2>${productName}</h2>\n<p>${description}<br /><br />\n ${features[0]}<br />\n ${features[1]}<br />\n ${features[2]}<br />\n ${features[3]}<br />\n ${features[4]}</p>\n\n<h3>Produkteigenschaften & Highlights</h3>\n<ul>\n<li>Robustes Gehuse und langlebige Verarbeitung</li>\n<li>Ergonomisches Design fr komfortables Arbeiten</li>\n<li>Hohe Leistung bei geringem Energieverbrauch</li>\n<li>Vielseitig einsetzbar in Werkstatt und Haushalt</li>\n<li>Optimales Preis-Leistungs-Verhltnis</li>\n</ul>\n\n<h4>Technische Daten:</h4>\n<table border=\"0\" summary=\"\">\n<tbody>\n<tr><td>Leistung:</td><td>${power}</td></tr>\n<tr><td>Spannung:</td><td>${voltage}</td></tr>\n<tr><td>Gewicht:</td><td>${weight}</td></tr>\n<tr><td>Abmessungen:</td><td>${dimensions}</td></tr>\n<tr><td>Material:</td><td>${material}</td></tr>\n</tbody>\n</table>\n\n<p>${productName} steht fr Qualitt, Zuverlssigkeit und Langlebigkeit  ideal fr den tglichen Einsatz.</p>\n\n<h3>Sicherheitshinweise</h3>\n<p>${safetyNotes}</p>\n\n<h3>Lieferumfang</h3>\n<p>${packageContents}</p>\n</li>\n</ul>`;\n    \n    console.log('Generierte HTML-Lnge:', htmlDescription.length);\n    \n    onProgress?.(100, 'Fertig!');\n    console.log('=== WORKFLOW ABGESCHLOSSEN ===');\n    return htmlDescription;\n    \n  } catch (error) {\n    console.error('Workflow-Fehler:', error);\n    onProgress?.(0, 'Fehler aufgetreten');\n    throw error;\n  }\n}\n\n/**\n * Generate SEO-optimized Keywords in structured categories\n * @param productTitle - Product title\n * @param productDescription - Product description\n * @param maxKeywords - Maximum keywords per category (default: 12)\n * @param model - AI model to use (default: gpt-4o-mini)\n * @returns Structured keywords object\n */\nexport async function generateSEOKeywords(\n  productTitle: string,\n  productDescription: string,\n  maxKeywords: number = 12,\n  model: string = 'gpt-4o-mini'\n): Promise<{\n  hauptkeywords: string[];\n  longtail_keywords: string[];\n  brand_keywords: string[];\n  intent_keywords: string[];\n}> {\n  const openai = new OpenAI({\n    apiKey: process.env.OPENAI_API_KEY,\n  });\n\n  const systemPrompt = `Du bist ein professioneller SEO-Keyword-Agent fr Produktdaten. \nDeine Aufgabe ist es, aus Produktinformationen gezielte Keywords fr Suchmaschinen zu generieren. \nDie Keywords sollen thematisch relevant, deutschsprachig, markenbezogen und suchintention-orientiert sein.\n\nEingabeparameter:\n- product_title: {Produktname}\n- product_description: {Produktbeschreibung}\n- max_keywords: {Zahl der gewnschten Keywords, Standard = 12}\n\nAusgabeformat (immer in JSON):\n{\n  \"hauptkeywords\": [\"...\"],\n  \"longtail_keywords\": [\"...\"],\n  \"brand_keywords\": [\"...\"],\n  \"intent_keywords\": [\"...\"]\n}\n\nRegeln:\n- Gib nie mehr als {max_keywords} pro Kategorie aus.\n- Verwende keine doppelten oder bedeutungsgleichen Begriffe.\n- Longtail-Keywords mssen reale Suchphrasen enthalten (z. B. kaufen\", Test\", Erfahrungen\", beste\", akku 21700\").\n- Brand-Keywords sollen den Markennamen enthalten (z. B. Nitecore\", Nitecore Akku\").\n- Intent-Keywords zielen auf Kaufabsicht oder Informationssuche.\n- Antworte nur im JSON-Format, ohne Erklrtext.`;\n\n  const prompt = systemPrompt\n    .replace('{Produktname}', productTitle)\n    .replace('{Produktbeschreibung}', productDescription)\n    .replace('{Zahl der gewnschten Keywords, Standard = 12}', maxKeywords.toString())\n    .replace('{max_keywords}', maxKeywords.toString());\n\n  const userMessage = `product_title: \"${productTitle}\"\nproduct_description: \"${productDescription}\"\nmax_keywords: ${maxKeywords}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model,\n      messages: [\n        {\n          role: 'system',\n          content: prompt\n        },\n        {\n          role: 'user',\n          content: userMessage\n        }\n      ],\n      temperature: 0.7,\n      response_format: { type: \"json_object\" }\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No response from AI');\n    }\n\n    const parsed = JSON.parse(content);\n    \n    return {\n      hauptkeywords: parsed.hauptkeywords || [],\n      longtail_keywords: parsed.longtail_keywords || [],\n      brand_keywords: parsed.brand_keywords || [],\n      intent_keywords: parsed.intent_keywords || []\n    };\n    \n  } catch (error) {\n    console.error('[SEO Keywords Generation Error]:', error);\n    // Fallback to empty arrays\n    return {\n      hauptkeywords: [],\n      longtail_keywords: [],\n      brand_keywords: [],\n      intent_keywords: []\n    };\n  }\n}\n\n/**\n * Generate SEO-optimized Meta Title and Meta Description\n * @param productData - Product information (name, manufacturer, specs, etc.)\n * @param model - AI model to use (default: gpt-4o-mini)\n * @returns Object with seoTitle and seoDescription\n */\nexport async function generateSEOMetadata(\n  productData: {\n    productName: string;\n    manufacturer?: string;\n    category?: string;\n    articleNumber?: string;\n    description?: string;\n    technicalSpecs?: string[];\n    nominalkapazitaet?: string;\n    zellenchemie?: string;\n  },\n  model: string = 'gpt-4o-mini'\n): Promise<{ seoTitle: string; seoDescription: string }> {\n  const openai = new OpenAI({\n    apiKey: process.env.OPENAI_API_KEY,\n  });\n\n  const { productName, manufacturer, category, articleNumber, description, technicalSpecs, nominalkapazitaet, zellenchemie } = productData;\n  \n  // Build context from available data\n  const productTitle = productName;\n  const productDescription = description || '';\n\n  // Bestimme Produkttyp basierend auf Kategorie und technischen Daten\n  let productType = 'Akkupack'; // Default\n  let productTypeAdjective = 'Hochwertiger'; // Default fr Akkupack\n  \n  if (category === 'flashlight') {\n    productType = 'Taschenlampe';\n    productTypeAdjective = 'Leistungsstarke';\n  } else if (category === 'charger') {\n    productType = 'Ladegert';\n    productTypeAdjective = 'Professionelles';\n  } else if (category === 'testing_equipment') {\n    productType = 'Messgert';\n    productTypeAdjective = 'Przises';\n  } else if (category === 'accessory') {\n    productType = 'Zubehr';\n    productTypeAdjective = 'Hochwertiges';\n  } else if (category === 'battery') {\n    // Unterscheide zwischen Akkupack (wiederaufladbar) und Batterie (Einweg)\n    const zellenchemieStr = (zellenchemie || '').toLowerCase();\n    const hasCapacity = !!nominalkapazitaet;\n    \n    if (hasCapacity || zellenchemieStr.includes('nimh') || zellenchemieStr.includes('nickel') || zellenchemieStr.includes('li-ion') || zellenchemieStr.includes('lithium-ion')) {\n      productType = 'Akkupack';\n      productTypeAdjective = 'Hochwertiger';\n    } else if (zellenchemieStr.includes('alkaline') || zellenchemieStr.includes('lithium')) {\n      productType = 'Batterie';\n      productTypeAdjective = 'Hochwertige';\n    }\n  }\n\n  console.log(`[SEO] Produkttyp erkannt: ${productType} (Kategorie: ${category}, Zellenchemie: ${zellenchemie})`);\n\n  // SEO Title Prompt (akkushop.de Format) - KATEGORIE-ABHNGIG\n  const titlePrompt = `Du bist ein professioneller SEO-Experte fr Akkushop-Produkttitel.\n\nEingabeparameter:\n- product_title: ${productTitle}\n- product_description: ${productDescription}\n- product_type: ${productType}\n\nZiel:\nErstelle einen prgnanten Meta-Titel mit **EXAKT 45-55 Zeichen** im akkushop.de-Stil.\n\nStruktur:\n${productType} [SPEZIFIKATION] kaufen | Akkushop\n\nRegeln:\n1. **KRITISCH: Zielbereich 45-55 Zeichen** (optimal: 380-480 Pixel)\n2. **Produkttyp:** \"${productType}\" (EXAKT verwenden!)\n3. **Spezifikation:** Hauptmerkmale aus Produktnamen extrahieren (z.B. \"Mignon AA\", \"2500 Lumen\", \"2s2p 5200mah\")\n4. **ENDE mit \"kaufen | Akkushop\"** (Branding + Conversion-Keyword)\n5. **Keine Marke:** Fokus auf Produkttyp und Specs\n6. **Deutsche Sprache:** Ausschlielich Deutsch\n7. **Nur Titel ausgeben**  keine Erklrungen\n\nBeispiele:\n- ${productType === 'Batterie' ? 'Batterie Mignon AA kaufen | Akkushop' : ''}\n- ${productType === 'Akkupack' ? 'Akkupack 2s2p 5200mah kaufen | Akkushop' : ''}\n- ${productType === 'Taschenlampe' ? 'Taschenlampe 2500 Lumen kaufen | Akkushop' : ''}\n\nWICHTIG: Gib NUR den Text aus, OHNE Anfhrungszeichen am Anfang/Ende!`;\n\n  // SEO Description Prompt (akkushop.de Format) - KATEGORIE-ABHNGIG\n  const descriptionPrompt = `Du bist ein professioneller SEO-Experte fr Akkushop-Produktbeschreibungen.\n\nEingabeparameter:\n- product_title: ${productTitle}\n- product_description: ${productDescription}\n- product_type: ${productType}\n\nZiel:\nErstelle eine prgnante Meta-Description mit **EXAKT 120-140 Zeichen** im akkushop.de-Stil.\n\nStruktur:\n${productTypeAdjective} ${productType} [SPEZIFIKATION] Qualittsprodukte Versandkostenfrei ab 39,95 Kundenservice 071517071010\n\nRegeln:\n1. **KRITISCH: Zielbereich 120-140 Zeichen** (optimal: 750-880 Pixel)\n2. **Start:** \"${productTypeAdjective} ${productType}\" + Spezifikation (z.B. \"Mignon AA\", \"2500 Lumen\")\n3. **FESTE USPs (IMMER verwenden):**\n   - Qualittsprodukte\n   - Versandkostenfrei ab 39,95\n   - Kundenservice 071517071010\n4. **Keine variablen USPs:** Nur die 3 festen Service-USPs\n5. **Deutsche Sprache:** Ausschlielich Deutsch\n6. **Kein Punkt am Ende** (akkushop.de-Stil)\n7. **Nur Text ausgeben**  keine Erklrungen\n\nBeispiele:\n- ${productType === 'Batterie' ? 'Hochwertige Batterie Mignon AA Qualittsprodukte Versandkostenfrei ab 39,95 Kundenservice 071517071010' : ''}\n- ${productType === 'Akkupack' ? 'Hochwertiger Akkupack 2s2p 5200mah Qualittsprodukte Versandkostenfrei ab 39,95 Kundenservice 071517071010' : ''}\n- ${productType === 'Taschenlampe' ? 'Leistungsstarke Taschenlampe 2500 Lumen Qualittsprodukte Versandkostenfrei ab 39,95 Kundenservice 071517071010' : ''}\n\nWICHTIG: Gib NUR den Text aus, OHNE Anfhrungszeichen am Anfang/Ende!`;\n\n  try {\n    // Generate SEO Title\n    const titleResponse = await openai.chat.completions.create({\n      model,\n      messages: [\n        {\n          role: 'system',\n          content: 'Du bist ein professioneller SEO-Experte fr Produktdaten.'\n        },\n        {\n          role: 'user',\n          content: titlePrompt\n        }\n      ],\n      temperature: 0.7\n    });\n\n    let seoTitle = titleResponse.choices[0]?.message?.content?.trim() || productName.substring(0, 65);\n    \n    // Remove surrounding quotes if AI added them\n    seoTitle = seoTitle.replace(/^[\"']|[\"']$/g, '').trim();\n\n    // Generate SEO Description\n    const descriptionResponse = await openai.chat.completions.create({\n      model,\n      messages: [\n        {\n          role: 'system',\n          content: 'Du bist ein professioneller SEO- und Produkttext-Experte fr Akkus und Elektronikprodukte.'\n        },\n        {\n          role: 'user',\n          content: descriptionPrompt\n        }\n      ],\n      temperature: 0.7\n    });\n\n    let seoDescription = descriptionResponse.choices[0]?.message?.content?.trim() || description?.substring(0, 150) || '';\n    \n    // Remove surrounding quotes if AI added them\n    seoDescription = seoDescription.replace(/^[\"']|[\"']$/g, '').trim();\n    \n    // Remove trailing \"...\" if AI added it (we want complete sentences)\n    seoDescription = seoDescription.replace(/\\.\\.\\.+$/, '').trim();\n    \n    // Only truncate if AI ignored the limit (emergency fallback)\n    if (seoDescription.length > 160) {\n      // Find last complete sentence before 160 chars\n      const truncated = seoDescription.substring(0, 157);\n      const lastPeriod = truncated.lastIndexOf('.');\n      seoDescription = lastPeriod > 100 ? truncated.substring(0, lastPeriod + 1) : truncated + '...';\n    }\n    \n    return {\n      seoTitle: seoTitle, // AI respects 70 char limit - no forced truncation\n      seoDescription\n    };\n    \n  } catch (error) {\n    console.error('[SEO Generation Error]:', error);\n    // Fallback to simple truncation\n    return {\n      seoTitle: productName.length > 65 ? productName.substring(0, 62) + '...' : productName,\n      seoDescription: description ? (description.length > 400 ? description.substring(0, 397) + '...' : description) : ''\n    };\n  }\n}\n\n","size_bytes":50177},"replit.md":{"content":"# PIMPilot - Produktmanagement SaaS\n\n## Overview\nPIMPilot is a multi-tenant B2B SaaS platform automating AI-powered product description and PIM metadata generation from supplier data. It processes product data via CSV uploads for multiple business customers, ensuring strict data isolation. The platform leverages OpenAI's GPT-4o-mini for text generation and a custom Cheerio-based web scraper. Its core capabilities include a robust multi-tenant architecture, secure authentication, Stripe-based subscription management, real-time API call monitoring, dynamic AI prompting, and a sophisticated category-based template system. The project aims to streamline product information management and enhance e-commerce content creation with a business vision to automate product content creation for e-commerce.\n\n## User Preferences\nNo specific preferences documented.\n\n## System Architecture\n\n### UI/UX Decisions\nThe frontend utilizes React 18, TypeScript, Vite, shadcn/ui, Radix UI, and Tailwind CSS for a modern and responsive user experience. Standardized `Table`-components ensure consistent design and functionality across the platform, including features like sticky headers and hover effects. The pricing page features a modern, two-column layout with gradient designs and consistent button heights.\n\n### Technical Implementations\n- **Frontend**: React 18, TypeScript, Vite, shadcn/ui, Radix UI, Tailwind CSS\n- **Backend**: Express.js, TypeScript\n- **Database**: PostgreSQL (Helium Dev / Supabase Production) with Drizzle ORM\n- **AI/ML**: OpenAI API (GPT-4o-mini for text generation, GPT-4o-mini Vision for image analysis)\n- **Web Scraping**: Cheerio (Custom scraper service)\n- **Authentication**: Supabase Auth (JWT-based)\n\n### Feature Specifications\n- **Multi-Tenant Architecture**: Ensures data isolation, dynamic tenant creation, and robust slug generation.\n- **User Authentication**: Supabase Auth with session management.\n- **Subscription Management**: Stripe integration for tiered access and trials, with default features for new customers (URL Web-Scraper, CSV Mass Import, AI Product Descriptions).\n- **Usage Tracking**: Real-time API call monitoring with limit enforcement.\n- **CSV Bulk Processing**: Upload and process product data for mass AI generation, with standardized column selection for PIM mapping and full image URL export. Brickfox CSV export now includes separate columns for up to 10 image URLs and consistent preview/export.\n- **URL Web Scraper**: Custom Cheerio-based scraper with configurable CSS selectors (restructured for better data capture of base data, prices, media, descriptions, technical data), intelligent auto-recognition, table parsing, multi-URL scraping, automatic login, session cookie capture, automatic image download, and Magento-specific JSON gallery parsing.\n- **AI Generation**: Automated product descriptions using OpenAI GPT-4o-mini, including AI-powered image analysis for color detection and dynamic product type extraction.\n- **Project Management**: Organize generated products into projects.\n- **Supplier Profiles**: Manage multiple suppliers with saved selectors.\n- **ERP Integration (e.g., Pixi)**: Automated product comparison for identifying new vs. existing products, intelligent multi-strategy matching (item number, manufacturer's item number, EAN), and CSV export. Direct integration for PDF Scraper to Pixi Compare without intermediate CSV steps. Ensures hyphens in manufacturer item numbers are preserved for correct matching.\n- **CSS Selector Verification System**: Workflow for testing and verifying supplier-specific CSS selectors with visual feedback.\n- **Field Mapping Tool**: Visual \"Click-to-Connect\" interface for mapping scraped data or CSV columns to export fields, supporting custom transformations and reusable presets. A new automatic mapping module utilizes `mappingRules.json` for centralized configuration, including priority logic, fixed values, auto-generation (e.g., category path), validation, and unit transformations.\n- **Admin Dashboard**: Professional dashboard with real-time KPIs and tenant management capabilities (subscription status, customer deletion, feature flags). Includes a checkbox-based bulk delete for customers.\n- **PDF Parser**: Improved PDF parser for accurate extraction of purchase and selling prices.\n- **Image Handling**: Static file server for local product images, automatic image download during scraping, and an interactive image gallery for scraped products.\n- **Contact Form**: Professional contact form with direct email sending to admin.\n- **Enterprise Security Features**: Implemented automatic backup system (Point-in-Time Recovery, multi-tenant isolation, audit-logging), granular RBAC with 5 roles (`admin`, `editor`, `viewer`, `project_manager`, `member`) and resource/action/scope-based permissions, comprehensive audit-log system for all CRUD operations, and field-level AES-256-GCM encryption for sensitive data (e.g., passwords, API keys).\n\n### System Design\nThe application employs a modular subprompt architecture for specialized AI tasks, centrally orchestrated. A 3-layer category-based template system (Category Configuration, AI Generator, Template Renderer) facilitates automatic category recognition and dynamic AI prompt adaptation. Multi-tenancy is enforced server-side using `organization_id` foreign keys to ensure data isolation.\n\n## External Dependencies\n- **OpenAI API**: For AI-driven text generation (GPT-4o-mini) and image analysis (GPT-4o-mini Vision).\n- **Supabase**: Provides PostgreSQL database, multi-tenancy support, and authentication services.\n- **Stripe**: Integrated for subscription management and payment processing.\n- **Pixi ERP API**: Used for product inventory comparison and duplicate detection.\n- **Greyhound SMTP**: E-mail sending for automated supplier requests via nodemailer.","size_bytes":5843},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"server/migrate-custom-attributes.ts":{"content":"import { drizzle } from 'drizzle-orm/better-sqlite3';\r\nimport Database from 'better-sqlite3';\r\nimport * as schema from \"@shared/schema\";\r\n\r\nconst sqlite = new Database('local.db');\r\nconst db = drizzle(sqlite, { schema });\r\n\r\nasync function migrateCustomAttributes() {\r\n  console.log('Adding custom attributes columns to products_in_projects table...');\r\n  \r\n  try {\r\n    // Add new columns to products_in_projects table\r\n    await sqlite.exec(`\r\n      ALTER TABLE products_in_projects \r\n      ADD COLUMN custom_attributes TEXT;\r\n    `);\r\n    console.log('Added custom_attributes column');\r\n  } catch (error) {\r\n    console.log('custom_attributes column might already exist:', error);\r\n  }\r\n\r\n  try {\r\n    await sqlite.exec(`\r\n      ALTER TABLE products_in_projects \r\n      ADD COLUMN exact_product_name TEXT;\r\n    `);\r\n    console.log('Added exact_product_name column');\r\n  } catch (error) {\r\n    console.log('exact_product_name column might already exist:', error);\r\n  }\r\n\r\n  try {\r\n    await sqlite.exec(`\r\n      ALTER TABLE products_in_projects \r\n      ADD COLUMN article_number TEXT;\r\n    `);\r\n    console.log('Added article_number column');\r\n  } catch (error) {\r\n    console.log('article_number column might already exist:', error);\r\n  }\r\n\r\n  console.log('Custom attributes migration completed successfully!');\r\n}\r\n\r\nmigrateCustomAttributes().catch((err) => {\r\n  console.error('Custom attributes migration failed:', err);\r\n  process.exit(1);\r\n});\r\n\r\n","size_bytes":1455},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/ui/section-custom.tsx":{"content":"import React from \"react\";\nimport { cn } from \"../../lib/utils\";\n\ninterface SectionProps extends React.HTMLAttributes<HTMLDivElement> {\n  title?: string;\n}\n\nexport const SectionCustom: React.FC<SectionProps> = ({ title, children, className, ...props }) => (\n  <section className={cn(\"py-10 px-4 md:px-10\", className)} {...props}>\n    {title && <h2 className=\"text-2xl font-bold mb-6\">{title}</h2>}\n    <div>{children}</div>\n  </section>\n);\n","size_bytes":440},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/custom-attributes-preview.tsx":{"content":"import { useState, useEffect, useMemo, useCallback } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Sparkles, Eye, Settings, CheckCircle2, Columns, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { ExtractedProductData } from \"@shared/schema\";\n\n// Helper function to clean extracted text from markdown formatting\nfunction cleanExtractedText(content: string): string {\n  // Remove markdown code blocks (```plaintext, ```, etc.)\n  let cleaned = content.replace(/^```(?:plaintext|html|HTML)?\\s*\\n?/gm, '');\n  cleaned = cleaned.replace(/\\n?```\\s*$/gm, '');\n  \n  // Remove ALL occurrences of markdown bold indicators (**)\n  cleaned = cleaned.replace(/\\*\\*/g, '');\n  \n  // Remove ALL occurrences of markdown italic indicators (*)\n  cleaned = cleaned.replace(/\\*/g, '');\n  \n  // Remove any remaining markdown formatting\n  cleaned = cleaned.trim();\n  \n  return cleaned;\n}\n\n// Helper functions to convert units\nfunction convertWeightToGrams(weightStr: string): string {\n  // Convert kg to g\n  const kgMatch = weightStr.match(/(\\d+(?:[.,]\\d+)?)\\s*kg/i);\n  if (kgMatch) {\n    const kgValue = parseFloat(kgMatch[1].replace(',', '.'));\n    const grams = Math.round(kgValue * 1000);\n    return weightStr.replace(kgMatch[0], `${grams} g`);\n  }\n  \n  // If already in grams, return as is\n  return weightStr;\n}\n\nfunction convertDimensionsToMm(dimensionsStr: string): string {\n  // Convert cm to mm\n  const cmMatch = dimensionsStr.match(/(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*\\s*(\\d+(?:[.,]\\d+)?)\\s*cm/i);\n  if (cmMatch) {\n    const dim1 = Math.round(parseFloat(cmMatch[1].replace(',', '.')) * 10);\n    const dim2 = Math.round(parseFloat(cmMatch[2].replace(',', '.')) * 10);\n    const dim3 = Math.round(parseFloat(cmMatch[3].replace(',', '.')) * 10);\n    return dimensionsStr.replace(cmMatch[0], `${dim1}  ${dim2}  ${dim3} mm`);\n  }\n  \n  // If already in mm, return as is\n  return dimensionsStr;\n}\n\n// Helper function to clean measurement values with different formatting options\nfunction cleanMeasurementValue(value: string, format: 'voltage' | 'capacity' | 'weight' | 'dimension' | 'default' = 'default'): string {\n  // 1. Remove common measurement units, qualifiers, and tolerance values\n  let cleaned = value\n    .replace(/\\s*(mm|cm|m|km|inch|in|ft|feet)\\s*/gi, '') // Length units\n    .replace(/\\s*(g|kg|mg|lb|pound|oz|ounce)\\s*/gi, '') // Weight units\n    .replace(/\\s*(ml|l|dl|cl|gal|gallon)\\s*/gi, '') // Volume units\n    .replace(/\\s*(V|mV|kV|volt)\\s*/gi, '') // Voltage units\n    .replace(/\\s*(A|mA|kA|amp|ampere)\\s*/gi, '') // Current units\n    .replace(/\\s*(W|mW|kW|watt)\\s*/gi, '') // Power units\n    .replace(/\\s*(mAh|Ah|Wh|kWh)\\s*/gi, '') // Energy/Capacity units\n    .replace(/\\s*(Hz|kHz|MHz|GHz)\\s*/gi, '') // Frequency units\n    .replace(/\\s*(C|F|K|celsius|fahrenheit|kelvin)\\s*/gi, '') // Temperature units\n    .replace(/\\s*(bar|psi|pa|pascal|atm)\\s*/gi, '') // Pressure units\n    .replace(/\\s*(rpm|U\\/min|UPM)\\s*/gi, '') // Rotation units\n    .replace(/\\s*(dB|db)\\s*/gi, '') // Decibel units\n    .replace(/\\s*(lux|lx)\\s*/gi, '') // Light units\n    .replace(/\\s*(dpi|ppi)\\s*/gi, '') // Resolution units\n    .replace(/\\s*(bit|byte|kb|mb|gb|tb)\\s*/gi, '') // Data units\n    .replace(/\\s*(h|min|sec|s|ms|s|ns)\\s*/gi, '') // Time units\n    .replace(/\\s*(typisch|typical|ca\\.|approx\\.|~|)\\s*/gi, '') // Common qualifiers\n    .replace(/\\s*(\\+\\/\\-|\\+\\-|\\-\\+)\\s*\\d+(?:[.,]\\d+)?\\s*(?:order)?\\s*/gi, '') // +/- tolerance values like +/-0,3\n    .replace(/\\s*order\\s*(\\+\\/\\-|\\+\\-|\\-\\+)?\\s*\\d+(?:[.,]\\d+)?\\s*/gi, '') // order +/-0,3\n    .replace(/\\s*\\d+(?:[.,]\\d+)?\\s*order\\s*/gi, '') // 0,3 order\n    .replace(/\\s*\\d+(?:[.,]\\d+)?\\s*(\\+\\/\\-|\\+\\-|\\-\\+)\\s*\\d+(?:[.,]\\d+)?\\s*order\\s*/gi, '') // 0,3 +/-0,1 order\n    .replace(/\\s*\\d+(?:[.,]\\d+)?\\s*(\\+\\/\\-|\\+\\-|\\-\\+)\\s*\\d+(?:[.,]\\d+)?\\s*/gi, '') // 0,3 +/-0,1\n    .replace(/\\s*\\+\\d+(?:[.,]\\d+)?\\s*\\-\\d+(?:[.,]\\d+)?\\s*/gi, '') // +0.3-0.1\n    .trim();\n\n  // 2. Extract the first plausible number and format it according to type\n  const numberMatch = cleaned.match(/(\\d+([.,]\\d+)?)/);\n  if (numberMatch && numberMatch[1]) {\n    let numStr = numberMatch[1];\n    // Replace comma with dot for consistent parseFloat parsing\n    numStr = numStr.replace(/,/g, '.');\n    const num = parseFloat(numStr);\n    if (!isNaN(num)) {\n      switch (format) {\n        case 'voltage':\n          return num.toFixed(1); // 1 decimal place for voltage\n        case 'capacity':\n          return Math.round(num).toString(); // No decimal places for capacity\n        case 'weight':\n          return Math.round(num).toString(); // No decimal places for weight\n        case 'dimension':\n          return num.toFixed(1); // 1 decimal place for dimensions\n        default:\n          return num.toFixed(2); // 2 decimal places for everything else\n      }\n    }\n  }\n\n  return ''; // Return empty string if no valid number found or parsed\n}\n\ninterface CustomAttribute {\n  key: string;\n  value: string;\n  type: string;\n  enabled: boolean;\n  category: 'basic' | 'technical' | 'dimensions' | 'features' | 'seo' | 'business' | 'images';\n  required?: boolean;\n}\n\ninterface CustomAttributesPreviewProps {\n  extractedData: ExtractedProductData[];\n  onAttributesChange: (attributes: Array<{key: string, value: string, type: string}>) => void;\n  onExactProductNameChange: (name: string) => void;\n  onArticleNumberChange: (number: string) => void;\n  articleNumber: string;\n  customAttributes?: Array<{key: string, value: string, type: string}>;\n  generatedHtmlDescription?: string;\n}\n\nexport default function CustomAttributesPreview({\n  extractedData,\n  onAttributesChange,\n  onExactProductNameChange,\n  onArticleNumberChange,\n  articleNumber,\n  customAttributes = [],\n  generatedHtmlDescription\n}: CustomAttributesPreviewProps) {\n  const [availableAttributes, setAvailableAttributes] = useState<CustomAttribute[]>([]);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [showPreview, setShowPreview] = useState(false);\n  const [isConfigDialogOpen, setIsConfigDialogOpen] = useState(false);\n  const { toast } = useToast();\n\n  // Load saved attributes from localStorage on component mount\n  useEffect(() => {\n    const savedAttributes = localStorage.getItem('customAttributes');\n    if (savedAttributes) {\n      try {\n        const parsed = JSON.parse(savedAttributes);\n        setAvailableAttributes(parsed);\n      } catch (error) {\n        console.error('Error loading saved attributes:', error);\n      }\n    }\n  }, []);\n\n  // Save attributes to localStorage whenever they change\n  useEffect(() => {\n    if (availableAttributes.length > 0) {\n      localStorage.setItem('customAttributes', JSON.stringify(availableAttributes));\n    }\n  }, [availableAttributes]);\n\n  // Sync customAttributes from parent component - prevent flickering with stable comparison\n  useEffect(() => {\n    if (customAttributes.length > 0) {\n      setAvailableAttributes(prev => {\n        // Create a stable comparison by checking if any values actually changed\n        let hasChanges = false;\n        const updated = [...prev];\n        \n        customAttributes.forEach(customAttr => {\n          const index = updated.findIndex(attr => attr.key === customAttr.key);\n          if (index !== -1 && updated[index].value !== customAttr.value) {\n            updated[index] = { ...updated[index], value: customAttr.value };\n            hasChanges = true;\n          }\n        });\n        \n        // Only return new array if there were actual changes\n        return hasChanges ? updated : prev;\n      });\n    }\n  }, [customAttributes]);\n\n  // Auto-insert generated HTML description into \"Produktbeschreibung\" field\n  useEffect(() => {\n    if (generatedHtmlDescription && generatedHtmlDescription.trim()) {\n      setAvailableAttributes(prev => {\n        const updated = prev.map(attr => {\n          if (attr.key === 'Produktbeschreibung') {\n            return { ...attr, value: generatedHtmlDescription };\n          } else if (attr.key === 'SEO Beschreibung') {\n            // Generate SEO description from HTML content\n            const seoDescription = generateSeoDescription(generatedHtmlDescription);\n            return { ...attr, value: seoDescription };\n          } else if (attr.key === 'SEO Content') {\n            // Generate SEO content from HTML content\n            const seoContent = generateSeoContent(generatedHtmlDescription);\n            return { ...attr, value: seoContent };\n          }\n          return attr;\n        });\n        return updated;\n      });\n    }\n  }, [generatedHtmlDescription]);\n\n  // Convert units in existing custom attributes\n  useEffect(() => {\n    if (customAttributes.length > 0) {\n      const updatedAttributes = customAttributes.map(attr => {\n        if (attr.key.toLowerCase().includes('gewicht') || attr.key.toLowerCase().includes('weight')) {\n          const convertedValue = convertWeightToGrams(attr.value);\n          return { ...attr, value: convertedValue };\n        } else if (attr.key.toLowerCase().includes('abmessung') || attr.key.toLowerCase().includes('dimension') || \n                   attr.key.toLowerCase().includes('gre') || attr.key.toLowerCase().includes('size')) {\n          const convertedValue = convertDimensionsToMm(attr.value);\n          return { ...attr, value: convertedValue };\n        }\n        return attr;\n      });\n      \n      // Only update if there are changes\n      const hasChanges = updatedAttributes.some((attr, index) => \n        attr.value !== customAttributes[index].value\n      );\n      \n      if (hasChanges) {\n        onAttributesChange(updatedAttributes);\n      }\n    }\n  }, [customAttributes, onAttributesChange]);\n\n  // Helper function to generate SEO description\n  function generateSeoDescription(htmlContent: string): string {\n    // Remove HTML tags and extract clean text\n    const cleanText = htmlContent\n      .replace(/<[^>]*>/g, '') // Remove HTML tags\n      .replace(/\\s+/g, ' ') // Normalize whitespace\n      .replace(//g, '') // Remove checkmarks\n      .trim();\n    \n    // Extract the main product description (first paragraph)\n    const sentences = cleanText.split('.').filter(s => s.trim().length > 10);\n    const mainDescription = sentences[0] || cleanText.substring(0, 150);\n    \n    // Take first 150 characters for SEO description\n    const seoDesc = mainDescription.substring(0, 150);\n    const result = seoDesc.endsWith('.') ? seoDesc : seoDesc + '...';\n    \n    return result;\n  }\n\n  // Helper function to generate SEO content\n  function generateSeoContent(htmlContent: string): string {\n    // Remove HTML tags and extract clean text\n    const cleanText = htmlContent\n      .replace(/<[^>]*>/g, '') // Remove HTML tags\n      .replace(/\\s+/g, ' ') // Normalize whitespace\n      .replace(//g, '') // Remove checkmarks\n      .trim();\n    \n    // Extract the main product description and key features\n    const sentences = cleanText.split('.').filter(s => s.trim().length > 10);\n    const mainContent = sentences.slice(0, 3).join('. ') || cleanText.substring(0, 300);\n    \n    // Take first 300 characters for SEO content\n    const seoContent = mainContent.substring(0, 300);\n    const result = seoContent.endsWith('.') ? seoContent : seoContent + '...';\n    \n    return result;\n  }\n\n  // Define all actual attributes based on user requirements (removed duplicates)\n  const allAttributes: CustomAttribute[] = [\n    // Basic Product Information\n    { key: 'Produktname', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Mediamarktname V1', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Mediamarktname V2', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Produktbeschreibung', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Status', value: 'Aktiv', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Marke', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Produktart', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Farbe', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Bauform', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'passend fr Hersteller / Marke', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    { key: 'Artikelnummer', value: '', type: 'text', enabled: true, category: 'basic', required: true },\n    \n    // Business Information\n    { key: 'Regelsteuersatz', value: '19', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Herstellungsland', value: 'China', type: 'text', enabled: true, category: 'business', required: true },\n    \n    // SEO Information\n    { key: 'SEO Name', value: '', type: 'text', enabled: true, category: 'seo', required: true },\n    { key: 'SEO Beschreibung', value: '', type: 'text', enabled: true, category: 'seo', required: true },\n    { key: 'SEO Content', value: '', type: 'text', enabled: true, category: 'seo', required: true },\n    { key: 'SEO Keywords', value: '', type: 'text', enabled: true, category: 'seo', required: true },\n    \n    // Product Lists\n    { key: 'Auflistung 1', value: '', type: 'text', enabled: false, category: 'features', required: false },\n    { key: 'Auflistung 2', value: '', type: 'text', enabled: false, category: 'features', required: false },\n    { key: 'Auflistung 3', value: '', type: 'text', enabled: false, category: 'features', required: false },\n    { key: 'Auflistung 4', value: '', type: 'text', enabled: false, category: 'features', required: false },\n    \n    // Technical Specifications\n    { key: 'Spannung V', value: '', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Wiederaufladbar', value: 'Ja', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Kapazitt mAh', value: '', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Kapazitt Wh', value: '', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Anschlussart Akku', value: '', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Schutzschaltung', value: 'Ja', type: 'text', enabled: true, category: 'technical', required: true },\n    \n    // Dimensions\n    { key: 'Durchmesser mm', value: '', type: 'text', enabled: true, category: 'dimensions', required: true },\n    { key: 'Lnge mm', value: '', type: 'text', enabled: true, category: 'dimensions', required: true },\n    { key: 'Breite mm', value: '', type: 'text', enabled: true, category: 'dimensions', required: true },\n    { key: 'Hhe mm', value: '', type: 'text', enabled: true, category: 'dimensions', required: true },\n    { key: 'Plus Pol', value: 'Erhht', type: 'text', enabled: true, category: 'technical', required: true },\n    \n    // Chemical and Safety\n    { key: 'Zusammensetzung (Chemie)', value: '', type: 'text', enabled: true, category: 'technical', required: true },\n    { key: 'Gefahrgut', value: 'Nein', type: 'text', enabled: true, category: 'business', required: true },\n    \n    // Logistics\n    { key: 'Verpackungseinheit', value: '1', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Klassifizierung', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Lieferzeit', value: '2-3 Werktage', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Neber out of Stock', value: 'Nein', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Zolltarifnummer', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Warenbeschreibung', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    \n    // Pricing\n    { key: 'Preis VK', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Stck', value: '1', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Lieferant', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'Lieferanten-Art. nr', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    { key: 'EK', value: '', type: 'text', enabled: true, category: 'business', required: true },\n    \n    // Images\n    { key: 'Bild 1', value: '', type: 'text', enabled: true, category: 'images', required: true },\n    { key: 'Bild 2', value: '', type: 'text', enabled: false, category: 'images', required: false },\n    { key: 'Bild 3', value: '', type: 'text', enabled: false, category: 'images', required: false },\n    { key: 'Bild 4', value: '', type: 'text', enabled: false, category: 'images', required: false },\n    { key: 'Bild 5', value: '', type: 'text', enabled: false, category: 'images', required: false },\n    { key: 'Bild 6', value: '', type: 'text', enabled: false, category: 'images', required: false },\n    { key: 'Media Upload', value: '', type: 'text', enabled: false, category: 'images', required: false }\n  ];\n\n  // Extract technical attributes from extracted data\n  const extractTechnicalAttributes = (extractedText: string): CustomAttribute[] => {\n    const attributes: CustomAttribute[] = [];\n    \n    // Extract voltage\n    const voltageMatch = extractedText.match(/(?:Spannung|Nennspannung):\\s*([^\\n\\r]+)/i);\n    if (voltageMatch) {\n      let voltage = cleanMeasurementValue(voltageMatch[1], 'voltage');\n      // Handle voltage ranges like \"3,6V - 3,7V\" by taking first value\n      if (voltage.includes('-')) {\n        voltage = voltage.split('-')[0].trim();\n      }\n      attributes.push({\n        key: 'Spannung V',\n        value: voltage,\n        type: 'text',\n        enabled: true,\n        category: 'technical',\n        required: true\n      });\n    }\n\n    // Extract capacity in mAh\n    const capacityMatch = extractedText.match(/(?:Kapazitt|Nennkapazitt|Min\\. Kapazitt):\\s*([^\\n\\r]+)/i);\n    if (capacityMatch) {\n      const capacity = cleanMeasurementValue(capacityMatch[1], 'capacity');\n      attributes.push({\n        key: 'Kapazitt mAh',\n        value: capacity,\n        type: 'text',\n        enabled: true,\n        category: 'technical',\n        required: true\n      });\n    }\n\n    // Extract weight\n    const weightMatch = extractedText.match(/Gewicht:\\s*([^\\n\\r]+)/i);\n    if (weightMatch) {\n      const convertedWeight = convertWeightToGrams(weightMatch[1]);\n      const weight = cleanMeasurementValue(convertedWeight, 'weight');\n      attributes.push({\n        key: 'Gewicht',\n        value: weight,\n        type: 'text',\n        enabled: true,\n        category: 'technical',\n        required: false\n      });\n    }\n\n    // Extract dimensions\n    const dimensionsMatch = extractedText.match(/(?:Abmessungen|Gre|Durchmesser|Hhe):\\s*([^\\n\\r]+)/i);\n    if (dimensionsMatch) {\n      const convertedDimensions = convertDimensionsToMm(dimensionsMatch[1]);\n      const dimensions = cleanMeasurementValue(convertedDimensions, 'dimension');\n      if (dimensions.includes('x')) {\n        const parts = dimensions.split('x');\n        if (parts.length >= 3) {\n          // Format: Lnge x Breite x Hhe\n          attributes.push({\n            key: 'Lnge mm',\n            value: parts[0].trim(),\n            type: 'text',\n            enabled: true,\n            category: 'dimensions',\n            required: true\n          });\n          attributes.push({\n            key: 'Breite mm',\n            value: parts[1].trim(),\n            type: 'text',\n            enabled: true,\n            category: 'dimensions',\n            required: true\n          });\n          attributes.push({\n            key: 'Hhe mm',\n            value: parts[2].trim(),\n            type: 'text',\n            enabled: true,\n            category: 'dimensions',\n            required: true\n          });\n        } else if (parts.length >= 2) {\n          // Format: Durchmesser x Lnge\n          attributes.push({\n            key: 'Durchmesser mm',\n            value: parts[0].trim(),\n            type: 'text',\n            enabled: true,\n            category: 'dimensions',\n            required: true\n          });\n          attributes.push({\n            key: 'Lnge mm',\n            value: parts[1].trim(),\n            type: 'text',\n            enabled: true,\n            category: 'dimensions',\n            required: true\n          });\n        }\n      } else {\n        attributes.push({\n          key: 'Durchmesser mm',\n          value: dimensions,\n          type: 'text',\n          enabled: true,\n          category: 'dimensions',\n          required: true\n        });\n      }\n    }\n\n    // Extract chemistry\n    const chemistryMatch = extractedText.match(/(?:Zellchemie|Chemie|Zusammensetzung):\\s*([^\\n\\r]+)/i);\n    if (chemistryMatch) {\n      const chemistry = cleanExtractedText(chemistryMatch[1]);\n      attributes.push({\n        key: 'Zusammensetzung (Chemie)',\n        value: chemistry,\n        type: 'text',\n        enabled: true,\n        category: 'technical',\n        required: true\n      });\n    }\n\n    // Extract protection circuit\n    const protectionMatch = extractedText.match(/(?:Schutzschaltung|Schutz|PCB|BMS):\\s*([^\\n\\r]+)/i);\n    if (protectionMatch) {\n      const protection = cleanExtractedText(protectionMatch[1]);\n      attributes.push({\n        key: 'Schutzschaltung',\n        value: protection === 'Ja' ? 'Ja' : 'Nein',\n        type: 'text',\n        enabled: true,\n        category: 'technical',\n        required: true\n      });\n    }\n\n    return attributes;\n  };\n\n  // Apply automatic rules to attributes\n  const applyAttributeRules = (attributes: CustomAttribute[]): CustomAttribute[] => {\n    return attributes.map(attr => {\n      let newAttr = { ...attr };\n      \n      // Auto-detect product type and set defaults based on extracted data\n      const extractedText = extractedData.length > 0 ? extractedData[0].extractedText : '';\n      if (extractedText) {\n        const lowerExtractedText = extractedText.toLowerCase();\n        \n        // Battery/Akku specific rules\n        if (lowerExtractedText.includes('akku') || lowerExtractedText.includes('batterie') || lowerExtractedText.includes('battery')) {\n          if (attr.key === 'Produktart' && !attr.value) {\n            newAttr.value = 'Akku';\n            newAttr.enabled = true;\n          }\n          if (attr.key === 'Bauform' && !attr.value) {\n            newAttr.value = 'Zylindrisch';\n            newAttr.enabled = true;\n          }\n          if (attr.key === 'Zusammensetzung (Chemie)' && !attr.value) {\n            newAttr.value = 'Li-Ion';\n            newAttr.enabled = true;\n          }\n          if (attr.key === 'Wiederaufladbar' && !attr.value) {\n            newAttr.value = 'Ja';\n            newAttr.enabled = true;\n          }\n          if (attr.key === 'Schutzschaltung' && !attr.value) {\n            newAttr.value = 'Ja';\n            newAttr.enabled = true;\n          }\n        }\n        \n        // Cable/Kabel specific rules\n        if (lowerExtractedText.includes('kabel') || lowerExtractedText.includes('cable')) {\n          if (attr.key === 'Produktart' && !attr.value) {\n            newAttr.value = 'Kabel';\n            newAttr.enabled = true;\n          }\n        }\n        \n        // Power supply/Netzteil specific rules\n        if (lowerExtractedText.includes('netzteil') || lowerExtractedText.includes('ladegert') || lowerExtractedText.includes('charger')) {\n          if (attr.key === 'Produktart' && !attr.value) {\n            newAttr.value = 'Netzteil';\n            newAttr.enabled = true;\n          }\n        }\n      }\n      \n      return newAttr;\n    });\n  };\n\n  // Extract all possible attributes from the extracted data\n  useEffect(() => {\n    if (extractedData.length === 0) {\n      // Don't clear attributes if we have saved ones\n      const savedAttributes = localStorage.getItem('customAttributes');\n      if (!savedAttributes) {\n        setAvailableAttributes([]);\n      }\n      return;\n    }\n\n    const extractedText = extractedData[0].extractedText;\n    const attributes: CustomAttribute[] = [];\n\n    // Helper function to extract field value from text\n    const extractFieldValue = (fieldName: string, patterns: RegExp[] = []): string => {\n      // Try explicit field pattern first\n      const explicitPattern = new RegExp(`${fieldName}\\\\s*:\\\\s*([^\\\\n\\\\r]+)`, 'i');\n      const explicitMatch = extractedText.match(explicitPattern);\n      if (explicitMatch) {\n        return cleanExtractedText(explicitMatch[1].trim());\n      }\n      \n      // Try additional patterns\n      for (const pattern of patterns) {\n        const match = extractedText.match(pattern);\n        if (match) {\n          return cleanExtractedText(match[1] || match[0]).trim();\n        }\n      }\n      \n      return '';\n    };\n\n    // Extract product name with USP\n    let baseProductName = '';\n    \n    // First try to get from extracted text\n    const productNameMatch = extractedText.match(/Produktname:\\s*([^\\n\\r]+)/i);\n    if (productNameMatch) {\n      baseProductName = cleanExtractedText(productNameMatch[1].trim());\n    } else {\n      // Fallback to productName field\n      baseProductName = extractedData[0].productName || extractedData[0].extractedText;\n    }\n    \n    // Extract USP from bullets if available\n    let productNameWithUSP = baseProductName;\n    if (extractedData[0].bullets && extractedData[0].bullets.length > 0) {\n      // Find the best USP from bullets\n      const bestUSP = findBestUSP(extractedData[0].bullets);\n      if (bestUSP) {\n        productNameWithUSP = `${baseProductName} - ${bestUSP}`;\n      }\n    }\n    \n    // Helper function to find the best USP\n    function findBestUSP(bullets: string[]): string {\n      const productName = baseProductName.toLowerCase();\n      \n      // Generate context-aware, benefit-focused USPs based on product type and specifications\n      if (productName.includes('akkupack') || productName.includes('akku')) {\n        // For battery products, create capacity-based USPs\n        for (const bullet of bullets) {\n          const cleanBullet = bullet.replace(/^[-]\\s*/, '').trim();\n          const lowerBullet = cleanBullet.toLowerCase();\n          \n          // Look for capacity indicators and create benefit-focused USPs\n          if (lowerBullet.includes('kapazitt') || lowerBullet.includes('mah')) {\n            const capacityMatch = lowerBullet.match(/(\\d+)\\s*mah/i);\n            if (capacityMatch) {\n              const capacity = parseInt(capacityMatch[1]);\n              if (capacity >= 7000) {\n                return 'Extra hohe Kapazitt fr maximale Laufzeit';\n              } else if (capacity >= 5000) {\n                return 'Hohe Kapazitt fr langanhaltende Nutzung';\n              } else if (capacity >= 3000) {\n                return 'Optimale Kapazitt fr den tglichen Gebrauch';\n              }\n            }\n            return 'Hohe Kapazitt fr langanhaltende Nutzung';\n          }\n        }\n        \n        // Look for voltage indicators for power-focused USPs\n        for (const bullet of bullets) {\n          const cleanBullet = bullet.replace(/^[-]\\s*/, '').trim();\n          const lowerBullet = cleanBullet.toLowerCase();\n          \n          if (lowerBullet.includes('spannung') || lowerBullet.includes('v')) {\n            const voltageMatch = lowerBullet.match(/(\\d+[,.]?\\d*)\\s*v/i);\n            if (voltageMatch) {\n              const voltage = parseFloat(voltageMatch[1].replace(',', '.'));\n              if (voltage >= 10) {\n                return 'Hohe Leistung fr anspruchsvolle Gerte';\n              } else if (voltage >= 7) {\n                return 'Optimale Leistung fr mobile Gerte';\n              }\n            }\n            return 'Zuverlssige Leistung fr den tglichen Gebrauch';\n          }\n        }\n        \n        // Fallback for battery products\n        return 'Fr den alltglichen Gebrauch';\n      }\n      \n      if (productName.includes('ladegert') || productName.includes('charger')) {\n        // For chargers, prioritize speed and convenience\n        for (const bullet of bullets) {\n          const cleanBullet = bullet.replace(/^[-]\\s*/, '').trim();\n          const lowerBullet = cleanBullet.toLowerCase();\n          \n          if (lowerBullet.includes('schnell') || lowerBullet.includes('fast') || lowerBullet.includes('quick')) {\n            return 'Schnelles Aufladen fr maximale Effizienz';\n          }\n        }\n        return 'Schnelles Aufladen fr maximale Effizienz';\n      }\n      \n      if (productName.includes('netzteil') || productName.includes('power')) {\n        // For power supplies, prioritize reliability\n        return 'Zuverlssige Stromversorgung fr sichere Nutzung';\n      }\n      \n      // Look for sales-promoting keywords as fallback\n      const salesKeywords = ['hoch', 'max', 'schnell', 'langanhaltend', 'zuverlssig', 'optimal', 'effizient', 'leistungsstark', 'robust', 'sicher'];\n      \n      for (const bullet of bullets) {\n        const cleanBullet = bullet.replace(/^[-]\\s*/, '').trim();\n        const lowerBullet = cleanBullet.toLowerCase();\n        \n        // Check if bullet contains sales-promoting keywords\n        const hasSalesKeyword = salesKeywords.some(keyword => lowerBullet.includes(keyword));\n        \n        if (hasSalesKeyword) {\n          // Extract the most important part (before dash, colon, or colon with value)\n          let shortUSP = cleanBullet.split(' - ')[0] || cleanBullet.split('  ')[0] || cleanBullet;\n          \n          // Remove value after colon (e.g., \"max. Entladestrom: 7,8 A\" -> \"max. Entladestrom\")\n          if (shortUSP.includes(':')) {\n            shortUSP = shortUSP.split(':')[0].trim();\n          }\n          \n          return shortUSP.trim();\n        }\n      }\n      \n      // Final fallback: use first bullet if no sales-promoting keyword found\n      if (bullets.length > 0) {\n        const firstBullet = bullets[0].replace(/^[-]\\s*/, '').trim();\n        let shortUSP = firstBullet.split(' - ')[0] || firstBullet.split('  ')[0] || firstBullet;\n        \n        // Remove value after colon\n        if (shortUSP.includes(':')) {\n          shortUSP = shortUSP.split(':')[0].trim();\n        }\n        \n        return shortUSP.trim();\n      }\n      \n      return '';\n    }\n    \n    // Extract article number first\n    const articleNumber = extractFieldValue('Artikelnummer');\n    \n    // Extract all basic product information\n    const basicFields = [\n      { key: 'Produktname', value: productNameWithUSP },\n      { key: 'Status', value: 'Aktiv', patterns: [/Status:\\s*([^\\n\\r]+)/i] },\n      { key: 'Marke', value: extractedData[0].url?.includes('ansmann') ? 'Accucell' : extractFieldValue('Marke') },\n      { key: 'Produktart', value: extractProductType() },\n      { key: 'Farbe', value: extractFieldValue('Farbe', [/Color:\\s*([^\\n\\r]+)/i, /Farbton:\\s*([^\\n\\r]+)/i]) },\n      { key: 'Bauform', value: extractFieldValue('Bauform', [/Form:\\s*([^\\n\\r]+)/i, /Shape:\\s*([^\\n\\r]+)/i]) },\n      { key: 'passend fr Hersteller / Marke', value: extractFieldValue('passend fr', [/Kompatibel mit:\\s*([^\\n\\r]+)/i]) },\n    ];\n\n    // Add article number directly to basic fields\n    if (articleNumber) {\n      // Generate article number from supplier name + article number\n      let supplierName = '';\n      if (extractedData[0].url) {\n        const urlMatch = extractedData[0].url.match(/https?:\\/\\/(?:www\\.)?([^\\/]+)/);\n        if (urlMatch) {\n          supplierName = urlMatch[1].split('.')[0]; // Take domain without extension\n        }\n      } else if (extractedData[0].fileName) {\n        supplierName = extractedData[0].fileName.split('.')[0];\n      }\n      \n      // Get first 3 uppercase letters from supplier name\n      const supplierPrefix = supplierName.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 3);\n      \n      // Remove dashes from article number\n      const cleanArticleNumber = articleNumber.replace(/-/g, '');\n      \n      // Combine: Supplier prefix + clean article number\n      const generatedArticleNumber = `${supplierPrefix}${cleanArticleNumber}`;\n      \n      basicFields.push({ key: 'Artikelnummer', value: generatedArticleNumber });\n      console.log('Added article number to basicFields:', generatedArticleNumber);\n    }\n\n    // Extract dimensions and add to basic fields\n    const dimensionsMatch = extractedText.match(/(?:Abmessungen|Gre|Durchmesser|Hhe):\\s*([^\\n\\r]+)/i);\n    if (dimensionsMatch) {\n      const dimensions = cleanMeasurementValue(dimensionsMatch[1], 'dimension');\n      if (dimensions.includes('x')) {\n        const parts = dimensions.split('x');\n        if (parts.length >= 3) {\n          // Format: Lnge x Breite x Hhe\n          basicFields.push({ key: 'Lnge mm', value: parts[0].trim() });\n          basicFields.push({ key: 'Breite mm', value: parts[1].trim() });\n          basicFields.push({ key: 'Hhe mm', value: parts[2].trim() });\n        } else if (parts.length >= 2) {\n          // Format: Durchmesser x Lnge\n          basicFields.push({ key: 'Durchmesser mm', value: parts[0].trim() });\n          basicFields.push({ key: 'Lnge mm', value: parts[1].trim() });\n        }\n    } else {\n        basicFields.push({ key: 'Durchmesser mm', value: dimensions });\n      }\n    }\n    \n    // Extract business information\n    const businessFields = [\n      { key: 'Regelsteuersatz', value: '19' },\n      { key: 'Herstellungsland', value: 'China' },\n    ];\n    \n    // Extract SEO information\n    const seoFields = [\n      { key: 'SEO Name', value: baseProductName },\n      { key: 'SEO Beschreibung', value: extractedData[0].description || '' },\n      { key: 'SEO Content', value: extractedData[0].description || '' },\n      { key: 'SEO Keywords', value: generateKeywords() },\n    ];\n    \n    // Extract technical information\n    const technicalFields = [\n      { key: 'Wiederaufladbar', value: 'Ja' },\n      { key: 'Schutzschaltung', value: 'Ja' },\n      { key: 'Plus Pol', value: 'Erhht' },\n      { key: 'Zusammensetzung (Chemie)', value: 'Li-Ion' },\n      { key: 'Gefahrgut', value: 'Nein' },\n      { key: 'Verpackungseinheit', value: '1' },\n      { key: 'Lieferzeit', value: '3-5 Werktage' },\n      { key: 'Neber out of Stock', value: 'Nein' },\n      { key: 'Stck', value: '1' },\n    ];\n    \n    // Helper functions\n    function extractProductType(): string {\n      const productName = baseProductName.toLowerCase();\n      const description = extractedData[0].description?.toLowerCase() || '';\n      const fullText = (productName + ' ' + description).toLowerCase();\n      \n      if (fullText.includes('akkupack')) return 'Akkupack';\n      if (fullText.includes('akku') || fullText.includes('battery')) return 'Akku';\n      if (fullText.includes('ladegert') || fullText.includes('charger')) return 'Ladegert';\n      if (fullText.includes('netzteil') || fullText.includes('power supply')) return 'Netzteil';\n      return 'Akku';\n    }\n    \n    function generateKeywords(): string {\n      const keywords = [];\n      \n      // Extract product type and specifications\n      const productType = extractProductType();\n      const productName = baseProductName.toLowerCase();\n      \n      // Generate 6 short-tail keywords based on product data\n      if (productName.includes('lithium') && productName.includes('ionen')) {\n        keywords.push('Lithium-Ionen Akku');\n      } else if (productName.includes('lithium')) {\n        keywords.push('Lithium Akku');\n      } else if (productName.includes('ionen')) {\n        keywords.push('Ionen Akku');\n      } else {\n        keywords.push('Akku');\n      }\n      \n      // Add product type specific keywords\n      if (productType === 'Akkupack') {\n        keywords.push('Akkupack');\n      } else if (productType === 'Ladegert') {\n        keywords.push('Ladegert');\n      } else if (productType === 'Netzteil') {\n        keywords.push('Netzteil');\n      }\n      \n      // Add brand keyword\n      if (extractedData[0].url?.includes('ansmann')) {\n        keywords.push('Accucell');\n      }\n      \n      // Add voltage/capacity keywords\n      const voltageMatch = productName.match(/(\\d+[,.]?\\d*)\\s*v/i);\n      if (voltageMatch) {\n        keywords.push(`${voltageMatch[1]}V Akku`);\n      }\n      \n      const capacityMatch = productName.match(/(\\d+[,.]?\\d*)\\s*mah/i);\n      if (capacityMatch) {\n        keywords.push(`${capacityMatch[1]}mAh`);\n      }\n      \n      // Ensure we have exactly 6 keywords\n      const finalKeywords = keywords.slice(0, 6);\n      \n      // Fill remaining slots with generic terms if needed\n      while (finalKeywords.length < 6) {\n        if (!finalKeywords.includes('Batterie')) {\n          finalKeywords.push('Batterie');\n        } else if (!finalKeywords.includes('Energie')) {\n          finalKeywords.push('Energie');\n        } else if (!finalKeywords.includes('Power')) {\n          finalKeywords.push('Power');\n        } else {\n          finalKeywords.push('Akku Zubehr');\n        }\n      }\n      \n      return finalKeywords.slice(0, 6).join(', ');\n    }\n    \n    // Add all fields to attributes\n    [...basicFields, ...businessFields, ...seoFields, ...technicalFields].forEach(field => {\n      if (field.value) {\n          attributes.push({\n          key: field.key,\n          value: field.value,\n            type: 'text',\n            enabled: true,\n          category: getCategory(field.key),\n          required: isRequired(field.key),\n        });\n      }\n    });\n    \n    function getCategory(key: string): 'basic' | 'technical' | 'dimensions' | 'features' | 'seo' | 'business' | 'images' {\n      if (['Produktname', 'Status', 'Marke', 'Produktart', 'Farbe', 'Bauform', 'passend fr Hersteller / Marke', 'Artikelnummer', 'Mediamarktname V1', 'Mediamarktname V2'].includes(key)) return 'basic';\n      if (['Regelsteuersatz', 'Herstellungsland'].includes(key)) return 'business';\n      if (key.startsWith('SEO')) return 'seo';\n      if (['Durchmesser mm', 'Lnge mm', 'Breite mm', 'Hhe mm'].includes(key)) return 'dimensions';\n      return 'features';\n    }\n    \n    function isRequired(key: string): boolean {\n      return ['Produktname', 'Status', 'Marke', 'Produktart', 'Regelsteuersatz', 'Herstellungsland', 'Artikelnummer', 'Mediamarktname V1', 'Mediamarktname V2'].includes(key);\n    }\n\n\n    // Generate Mediamarkt V1 and V2 names\n    let mediamarktV1 = '';\n    let mediamarktV2 = `${baseProductName} - MediaMarkt`;\n    \n    // Generate V1 from extracted text with product type + model number\n    const productType = extractProductType();\n    let modelNumber = '';\n    if (articleNumber) {\n      modelNumber = articleNumber;\n      } else {\n      // Try to extract from product name\n      const modelMatch = baseProductName.match(/(\\d+[A-Z]?\\d*[A-Z]?\\d*)/);\n      if (modelMatch) {\n        modelNumber = modelMatch[1];\n      }\n    }\n    \n    mediamarktV1 = `${productType} ${modelNumber}`;\n    \n    // Add Mediamarkt names to basic fields\n    basicFields.push(\n      { key: 'Mediamarktname V1', value: mediamarktV1 },\n      { key: 'Mediamarktname V2', value: mediamarktV2 }\n    );\n\n\n\n\n    // Add price to business fields\n    const price = extractFieldValue('Preis');\n    if (price) {\n      businessFields.push({ key: 'Preis VK', value: price });\n    }\n    \n    // Add technical attributes\n    const technicalAttributes = extractTechnicalAttributes(extractedText);\n    technicalAttributes.forEach(attr => {\n      technicalFields.push({ key: attr.key, value: attr.value });\n    });\n\n    // Merge with all attributes and apply rules\n    const mergedAttributes = allAttributes.map(allAttr => {\n      const extractedAttr = attributes.find(attr => attr.key === allAttr.key);\n      if (extractedAttr) {\n        return { ...allAttr, value: extractedAttr.value, enabled: true };\n      }\n      return allAttr;\n    });\n\n    const finalAttributes = applyAttributeRules(mergedAttributes);\n    \n    // Merge with existing saved attributes to preserve user changes\n    setAvailableAttributes(prev => {\n      const savedAttributes = localStorage.getItem('customAttributes');\n      if (savedAttributes) {\n        try {\n          const saved = JSON.parse(savedAttributes);\n          // Merge saved attributes with new ones, preserving user values\n          const merged = finalAttributes.map(newAttr => {\n            const savedAttr = saved.find((s: CustomAttribute) => s.key === newAttr.key);\n            if (savedAttr && savedAttr.value) {\n              return { ...newAttr, value: savedAttr.value };\n            }\n            return newAttr;\n          });\n          return merged;\n        } catch (error) {\n          console.error('Error merging saved attributes:', error);\n        }\n      }\n      return finalAttributes;\n    });\n  }, [extractedData]);\n\n  // Memoize enabled attributes to prevent unnecessary re-renders\n  const enabledAttributes = useMemo(() => {\n    return availableAttributes\n      .filter(attr => attr.enabled)\n      .map(attr => ({\n        key: attr.key,\n        value: attr.value,\n        type: attr.type\n      }));\n  }, [availableAttributes]);\n\n  // Update parent component when attributes change\n  useEffect(() => {\n    onAttributesChange(enabledAttributes);\n  }, [enabledAttributes, onAttributesChange]);\n\n  const handleAttributeToggle = (key: string) => {\n    setAvailableAttributes(prev => \n      prev.map(attr => \n        attr.key === key ? { ...attr, enabled: !attr.enabled } : attr\n      )\n    );\n  };\n\n  const handleAttributeValueChange = (key: string, value: string) => {\n    setAvailableAttributes(prev => \n      prev.map(attr => \n        attr.key === key ? { ...attr, value } : attr\n      )\n    );\n  };\n\n  const handleAIGeneration = async (attributeKey: string) => {\n    if (extractedData.length === 0) {\n      toast({\n        variant: \"destructive\",\n        title: \"Keine Daten\",\n        description: \"Bitte laden Sie zuerst Dateien hoch fr die AI-Generierung\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n\n    try {\n      const extractedText = extractedData.map(d => d.extractedText).join('\\n\\n');\n      \n      let prompt = '';\n      switch (attributeKey) {\n        case 'SEO Name':\n          prompt = `Generiere einen SEO-optimierten Produktnamen basierend auf den Produktdaten. Der Name sollte:\n- Maximal 60 Zeichen lang sein\n- Die wichtigsten Keywords enthalten\n- Suchmaschinenfreundlich sein\n- Den Produkttyp und die Marke hervorheben\n\nProduktdaten: ${extractedText}`;\n          break;\n        case 'SEO Beschreibung':\n          prompt = `Generiere eine SEO-optimierte Produktbeschreibung basierend auf den Produktdaten. Die Beschreibung sollte:\n- Maximal 160 Zeichen lang sein\n- Die wichtigsten Features und Vorteile hervorheben\n- Suchmaschinenfreundlich sein\n- Zum Klicken animieren\n\nProduktdaten: ${extractedText}`;\n          break;\n        case 'SEO Content':\n          prompt = `Generiere SEO-optimierten Content fr das Produkt basierend auf den Produktdaten. Der Content sollte:\n- Strukturiert und informativ sein\n- Alle wichtigen technischen Daten enthalten\n- Suchmaschinenfreundlich formatiert sein\n- Zwischen 200-300 Wrtern lang sein\n\nProduktdaten: ${extractedText}`;\n          break;\n        case 'SEO Keywords':\n          prompt = `Generiere relevante SEO-Keywords fr das Produkt basierend auf den Produktdaten. Die Keywords sollten:\n- Komma-getrennt sein\n- Relevante Suchbegriffe enthalten\n- Verschiedene Keyword-Varianten umfassen\n- Maximal 20 Keywords enthalten\n\nProduktdaten: ${extractedText}`;\n          break;\n    case 'Mediamarktname V1':\n      prompt = `Generiere einen Mediamarkt-optimierten Produktnamen V1 basierend auf den Produktdaten. Der Name sollte:\n- Mit einem generischen Produkttyp beginnen (z.B. \"Akku\", \"Kabel\", \"Notebook Netzteil\")\n- Wichtige Identifikatoren enthalten (Artikelnummer, Kapazitt, Spannung)\n- Maximal 60 Zeichen lang sein\n- Fr Mediamarkt-Kunden verstndlich sein\n\nProduktdaten: ${extractedText}`;\n      break;\n    case 'Mediamarktname V2':\n      prompt = `Generiere einen Mediamarkt-optimierten Produktnamen V2 basierend auf den Produktdaten. Der Name sollte:\n- Eine kompakte Version von V1 sein (ohne generischen Produkttyp)\n- Nur die wichtigsten Identifikatoren enthalten (Artikelnummer, Kapazitt, Spannung)\n- Maximal 40 Zeichen lang sein\n- Fr Mediamarkt-Kunden verstndlich sein\n\nProduktdaten: ${extractedText}`;\n      break;\n        default:\n          prompt = `Generiere einen Wert fr \"${attributeKey}\" basierend auf den Produktdaten: ${extractedText}`;\n      }\n\n      const response = await fetch('/api/generate-description', {\n        method: 'POST',\n        body: JSON.stringify({\n          extractedData: [prompt],\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`${response.status}: ${await response.text()}`);\n      }\n\n      const result = await response.json();\n      if (result.success && result.description) {\n        const generatedValue = cleanExtractedText(result.description);\n        handleAttributeValueChange(attributeKey, generatedValue);\n        \n        toast({\n          title: \"AI-Generierung erfolgreich\",\n          description: `${attributeKey} wurde automatisch generiert`,\n        });\n      } else {\n        throw new Error('Keine Antwort von der AI erhalten');\n      }\n    } catch (error) {\n      toast({\n        variant: \"destructive\",\n        title: \"AI-Generierung fehlgeschlagen\",\n        description: error instanceof Error ? error.message : \"Unbekannter Fehler\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const getCategoryCount = (category: string) => {\n    return availableAttributes.filter(attr => attr.category === category).length;\n  };\n\n  const getEnabledCount = (category: string) => {\n    return availableAttributes.filter(attr => attr.category === category && attr.enabled).length;\n  };\n\n  const getRequiredCount = () => {\n    return availableAttributes.filter(attr => attr.required).length;\n  };\n\n  const getEnabledRequiredCount = () => {\n    return availableAttributes.filter(attr => attr.required && attr.enabled).length;\n  };\n\n  const categories = [\n    { key: 'basic', label: 'Grunddaten', icon: '' },\n    { key: 'technical', label: 'Technisch', icon: '' },\n    { key: 'dimensions', label: 'Abmessungen', icon: '' },\n    { key: 'features', label: 'Features', icon: '' },\n    { key: 'seo', label: 'SEO', icon: '' },\n    { key: 'business', label: 'Business', icon: '' },\n    { key: 'images', label: 'Bilder', icon: '' }\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Settings className=\"w-5 h-5\" />\n                Grunddaten (Custom Attributes)\n              </CardTitle>\n              <CardDescription>\n                Konfigurieren Sie die Attribute, die automatisch generiert werden sollen\n              </CardDescription>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowPreview(!showPreview)}\n              >\n                <Eye className=\"w-4 h-4 mr-2\" />\n                Vorschau\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setIsConfigDialogOpen(true)}\n              >\n                <Columns className=\"w-4 h-4 mr-2\" />\n                Spalten konfigurieren\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* All Attributes in Single List */}\n          <div className=\"space-y-4\">\n            {availableAttributes.map((attr, index) => (\n              <div key={index} className=\"border rounded-lg p-4 bg-card\">\n                {/* Attribute Header */}\n                <div className=\"flex items-center gap-3 mb-3\">\n                  <Checkbox\n                    checked={attr.enabled}\n                    onCheckedChange={() => handleAttributeToggle(attr.key)}\n                  />\n                  <Label className=\"text-sm font-semibold flex-1\">{attr.key}</Label>\n                </div>\n                \n                {/* Input Field */}\n                <div className=\"space-y-3\">\n                  {attr.key === 'Produktbeschreibung' ? (\n                    <textarea\n                      value={attr.value}\n                      onChange={(e) => handleAttributeValueChange(attr.key, e.target.value)}\n                      placeholder={`${attr.key} eingeben...`}\n                      className=\"w-full px-3 py-2 text-sm border rounded-md min-h-[100px] resize-y focus:ring-2 focus:ring-primary focus:border-primary\"\n                      rows={4}\n                    />\n                  ) : (\n                    <input\n                      type=\"text\"\n                      value={attr.value}\n                      onChange={(e) => handleAttributeValueChange(attr.key, e.target.value)}\n                      placeholder={`${attr.key} eingeben...`}\n                      className=\"w-full px-3 py-2 text-sm border rounded-md focus:ring-2 focus:ring-primary focus:border-primary\"\n                    />\n                  )}\n                  \n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Preview Dialog */}\n      <Dialog open={showPreview} onOpenChange={setShowPreview}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Attribute Vorschau</DialogTitle>\n            <DialogDescription>\n              Vorschau aller ausgewhlten Attribute fr den Export\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            {availableAttributes\n              .filter(attr => attr.enabled)\n              .map((attr, index) => (\n                <div key={index} className=\"flex justify-between items-center p-3 border rounded\">\n                  <span className=\"font-medium\">{attr.key}</span>\n                  <span className=\"text-muted-foreground\">{attr.value || '(leer)'}</span>\n                </div>\n              ))}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Spalten konfigurieren Dialog */}\n      <Dialog open={isConfigDialogOpen} onOpenChange={setIsConfigDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Columns className=\"w-5 h-5\" />\n              Spalten konfigurieren\n            </DialogTitle>\n            <DialogDescription>\n              Whlen Sie die Attribute aus, die in der CSV-Export enthalten sein sollen\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"flex-1\">\n            <div className=\"space-y-6\">\n              {categories.map(category => {\n                const categoryAttributes = availableAttributes.filter(attr => attr.category === category.key);\n                \n                return (\n                  <div key={category.key} className=\"space-y-4\">\n                    {/* Category Header */}\n                    <div className=\"flex items-center gap-3 border-b pb-2\">\n                      <span className=\"text-xl\">{category.icon}</span>\n                      <h3 className=\"text-lg font-semibold\">{category.label}</h3>\n                      <div className=\"text-sm text-muted-foreground bg-muted px-2 py-1 rounded\">\n                        {getEnabledCount(category.key)}/{getCategoryCount(category.key)} aktiviert\n                      </div>\n                    </div>\n                    \n                    {/* Attributes List */}\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                      {categoryAttributes.map((attr, index) => (\n                        <div key={index} className=\"flex items-center space-x-3 p-3 border rounded-lg bg-card\">\n                          <Checkbox\n                            checked={attr.enabled}\n                            onCheckedChange={() => handleAttributeToggle(attr.key)}\n                            className=\"h-4 w-4\"\n                          />\n                          <div className=\"flex-1\">\n                            <Label className=\"text-sm font-medium\">\n                              {attr.key}\n                            </Label>\n                            {attr.value && (\n                              <p className=\"text-xs text-muted-foreground mt-1 truncate\">\n                                {attr.value}\n                              </p>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n          <div className=\"flex justify-end gap-2 pt-4 border-t\">\n            <Button variant=\"outline\" onClick={() => setIsConfigDialogOpen(false)}>\n              Schlieen\n            </Button>\n            <Button onClick={() => setIsConfigDialogOpen(false)}>\n              Speichern\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":54098},"server/encryption.ts":{"content":"import crypto from 'crypto';\n\n// SECURITY: Use proper 32-byte key from environment, hashed for consistent length\nconst ENCRYPTION_KEY_STR = process.env.ENCRYPTION_KEY || 'your-32-character-secret-key-here!';\nconst ENCRYPTION_KEY = crypto.createHash('sha256').update(ENCRYPTION_KEY_STR).digest();\nconst ALGORITHM = 'aes-256-cbc';\n\nexport function encrypt(text: string): string {\n  const iv = crypto.randomBytes(16);\n  const cipher = crypto.createCipheriv(ALGORITHM, ENCRYPTION_KEY, iv);\n  let encrypted = cipher.update(text, 'utf8', 'hex');\n  encrypted += cipher.final('hex');\n  return iv.toString('hex') + ':' + encrypted;\n}\n\nexport function decrypt(encryptedText: string): string {\n  const textParts = encryptedText.split(':');\n  const iv = Buffer.from(textParts.shift()!, 'hex');\n  const encryptedData = textParts.join(':');\n  const decipher = crypto.createDecipheriv(ALGORITHM, ENCRYPTION_KEY, iv);\n  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');\n  decrypted += decipher.final('utf8');\n  return decrypted;\n}\n\n// Hilfsfunktion zum Verschlsseln von API-Schlsseln\nexport function encryptApiKey(apiKey: string): string {\n  return encrypt(apiKey);\n}\n\n// Hilfsfunktion zum Entschlsseln von API-Schlsseln\nexport function decryptApiKey(encryptedApiKey: string): string {\n  return decrypt(encryptedApiKey);\n}\n","size_bytes":1328},"client/src/components/app-sidebar.tsx":{"content":"import { Home, FileSpreadsheet, Globe, FolderOpen, Settings, Zap, Building2, User, CreditCard, LayoutDashboard, Crown, GitCompare, LogOut } from \"lucide-react\";\nimport { useLocation, Link } from \"wouter\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useTenant } from \"@/lib/tenant-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\n\nconst menuItems = [\n  {\n    title: \"Home\",\n    url: \"/\",\n    icon: Home,\n  },\n  {\n    title: \"Dashboard\",\n    url: \"/dashboard\",\n    icon: LayoutDashboard,\n  },\n  {\n    title: \"CSV Bulk Beschreibungen\",\n    url: \"/csv-bulk-description\",\n    icon: Zap,\n  },\n  {\n    title: \"Meine Projekte\",\n    url: \"/projects\",\n    icon: FolderOpen,\n  },\n  {\n    title: \"URL Webscraper\",\n    url: \"/url-scraper\",\n    icon: Globe,\n  },\n  {\n    title: \"PDF Auto-Scraper\",\n    url: \"/pdf-auto-scraper\",\n    icon: FileSpreadsheet,\n  },\n  {\n    title: \"Lieferanten-Profile\",\n    url: \"/suppliers\",\n    icon: Building2,\n  },\n  {\n    title: \"Pixi Vergleich\",\n    url: \"/pixi-compare\",\n    icon: GitCompare,\n  },\n  {\n    title: \"Mein Account\",\n    url: \"/account\",\n    icon: User,\n  },\n  {\n    title: \"Abonnement\",\n    url: \"/pricing\",\n    icon: CreditCard,\n  },\n  {\n    title: \"API Credentials\",\n    url: \"/credentials\",\n    icon: Settings,\n  },\n];\n\nexport function AppSidebar() {\n  const [location, setLocation] = useLocation();\n  const { user } = useAuth();\n  const { currentTenant } = useTenant();\n  const { toast } = useToast();\n\n  // Filter menu items based on tenant features\n  const tenantFeatures = currentTenant?.settings?.features || {};\n  const filteredMenuItems = menuItems.filter(item => {\n    // Hide \"Abonnement\" and \"API Credentials\" for Super-Admins (they use Replit Secrets)\n    if (item.url === '/pricing' || item.url === '/credentials') {\n      return !user?.isAdmin;\n    }\n    \n    // Always show these basic items\n    if (['/', '/dashboard', '/projects', '/suppliers', '/account'].includes(item.url)) {\n      return true;\n    }\n    \n    // Show Pixi Compare only if tenant has pixiIntegration enabled\n    if (item.url === '/pixi-compare') {\n      return tenantFeatures.pixiIntegration === true;\n    }\n    \n    // Show CSV Bulk if enabled (default: true)\n    if (item.url === '/csv-bulk-description') {\n      return tenantFeatures.csvBulkImport !== false;\n    }\n    \n    // Show URL Scraper if enabled (default: true)\n    if (item.url === '/url-scraper') {\n      return tenantFeatures.urlScraper !== false;\n    }\n    \n    // Show PDF Auto-Scraper if URL Scraper is enabled (uses same feature)\n    if (item.url === '/pdf-auto-scraper') {\n      return tenantFeatures.urlScraper !== false;\n    }\n    \n    return true;\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/auth/logout', {\n        method: 'POST',\n        headers: token ? { 'Authorization': `Bearer ${token}` } : {},\n        credentials: 'include',\n      });\n      if (!res.ok) throw new Error('Logout fehlgeschlagen');\n      return res.json();\n    },\n    onSuccess: () => {\n      localStorage.removeItem('supabase_token');\n      toast({\n        title: 'Erfolgreich abgemeldet',\n        description: 'Sie wurden abgemeldet.',\n      });\n      setLocation('/login');\n    },\n    onError: () => {\n      toast({\n        title: 'Fehler',\n        description: 'Logout fehlgeschlagen',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b border-border\">\n        <div>\n          <h2 className=\"text-lg font-bold text-foreground\">PIMPilot</h2>\n          <p className=\"text-xs text-muted-foreground\">Produktmanagement</p>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Navigation</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filteredMenuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    data-testid={`sidebar-${item.url.replace('/', '')}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"w-4 h-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n      <SidebarFooter className=\"p-4 border-t border-border\">\n        <div className=\"space-y-3\">\n          {user && (\n            <div className=\"flex items-center justify-between px-2 py-1\">\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium text-foreground truncate\">\n                  {user.email}\n                </p>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  {user.isAdmin && (\n                    <Badge variant=\"default\" className=\"text-xs\">\n                      Admin\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n          <Button\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() => logoutMutation.mutate()}\n            disabled={logoutMutation.isPending}\n          >\n            <LogOut className=\"w-4 h-4 mr-2\" />\n            {logoutMutation.isPending ? 'Wird abgemeldet...' : 'Abmelden'}\n          </Button>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","size_bytes":6051},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { AuthProvider } from \"@/lib/auth-context\";\nimport { TenantProvider } from \"@/lib/tenant-context\";\nimport { ProtectedRoute } from \"@/components/protected-route\";\nimport { AdminProtectedRoute } from \"@/components/admin-protected-route\";\nimport { SubscriptionBadge } from \"@/components/subscription-badge\";\nimport { TenantSwitcher } from \"@/components/tenant-switcher\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport Landing from \"@/pages/landing\";\nimport Dashboard from \"@/pages/dashboard\";\nimport AdminDashboard from \"@/pages/admin-dashboard\";\nimport AdminBackups from \"@/pages/admin-backups\";\nimport AdminPermissions from \"@/pages/admin-permissions\";\nimport AdminAuditLogs from \"@/pages/admin-audit-logs\";\nimport CSVBulkDescription from \"@/pages/csv-bulk-description\";\nimport URLScraper from \"@/pages/url-scraper\";\nimport PDFAutoScraper from \"@/pages/pdf-auto-scraper\";\nimport Projects from \"@/pages/projects\";\nimport ProjectDetail from \"@/pages/project-detail\";\nimport CredentialsPage from \"@/pages/credentials\";\nimport Suppliers from \"@/pages/suppliers\";\nimport SupplierDetail from \"@/pages/supplier-detail\";\nimport PixiComparePage from \"@/pages/pixi-compare\";\nimport Login from \"@/pages/login\";\nimport Register from \"@/pages/register\";\nimport Pricing from \"@/pages/pricing\";\nimport Contact from \"@/pages/contact\";\nimport Success from \"@/pages/success\";\nimport Account from \"@/pages/account\";\nimport NotFound from \"@/pages/not-found\";\nimport FieldMappingDemo from \"@/pages/field-mapping-demo\";\n\nfunction Router() {\n  return (\n    <Switch>\n      {/* Public routes - no sidebar */}\n      <Route path=\"/login\" component={Login} />\n      <Route path=\"/register\" component={Register} />\n      <Route path=\"/pricing\" component={Pricing} />\n      <Route path=\"/contact\" component={Contact} />\n      <Route path=\"/success\" component={Success} />\n      <Route path=\"/\" component={Landing} />\n      \n      {/* Protected routes - with sidebar */}\n      <Route path=\"/dashboard\">\n        <ProtectedRoute>\n          <Dashboard />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/admin/dashboard\">\n        <AdminProtectedRoute>\n          <AdminDashboard />\n        </AdminProtectedRoute>\n      </Route>\n      <Route path=\"/admin/backups\">\n        <AdminProtectedRoute>\n          <AdminBackups />\n        </AdminProtectedRoute>\n      </Route>\n      <Route path=\"/admin/permissions\">\n        <AdminProtectedRoute>\n          <AdminPermissions />\n        </AdminProtectedRoute>\n      </Route>\n      <Route path=\"/admin/audit-logs\">\n        <AdminProtectedRoute>\n          <AdminAuditLogs />\n        </AdminProtectedRoute>\n      </Route>\n      <Route path=\"/csv-bulk-description\">\n        <ProtectedRoute>\n          <CSVBulkDescription />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/url-scraper\">\n        <ProtectedRoute>\n          <URLScraper />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/pdf-auto-scraper\">\n        <ProtectedRoute>\n          <PDFAutoScraper />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/projects\">\n        <ProtectedRoute>\n          <Projects />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/project/:id\">\n        <ProtectedRoute>\n          <ProjectDetail />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/suppliers\">\n        <ProtectedRoute>\n          <Suppliers />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/suppliers/:id\">\n        <ProtectedRoute>\n          <SupplierDetail />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/pixi-compare\">\n        <ProtectedRoute>\n          <PixiComparePage />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/credentials\">\n        <ProtectedRoute>\n          <CredentialsPage />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/account\">\n        <ProtectedRoute>\n          <Account />\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/field-mapping-demo\">\n        <ProtectedRoute>\n          <FieldMappingDemo />\n        </ProtectedRoute>\n      </Route>\n      \n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AppContent() {\n  const [location] = useLocation();\n  const { user } = useAuth();\n  \n  // Public routes that should NOT show sidebar\n  const publicRoutes = ['/', '/login', '/register', '/pricing', '/success'];\n  const isPublicRoute = publicRoutes.includes(location);\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  if (isPublicRoute) {\n    // Public layout - no sidebar\n    return (\n      <>\n        <Router />\n        <Toaster />\n      </>\n    );\n  }\n\n  // Protected layout - with sidebar\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 overflow-hidden\">\n          <header className=\"flex items-center justify-between px-4 py-2 border-b border-border bg-card\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <div className=\"flex items-center gap-4\">\n              {user?.isAdmin && <TenantSwitcher />}\n              <SubscriptionBadge />\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto\">\n            <Router />\n          </main>\n        </div>\n      </div>\n      <Toaster />\n    </SidebarProvider>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <AuthProvider>\n        <TenantProvider>\n          <TooltipProvider>\n            <AppContent />\n          </TooltipProvider>\n        </TenantProvider>\n      </AuthProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":6111},"client/src/components/ui/card-custom.tsx":{"content":"import React from \"react\";\nimport { cn } from \"../../lib/utils\";\n\ninterface CardProps extends React.HTMLAttributes<HTMLDivElement> {}\n\nexport const CardCustom: React.FC<CardProps> = ({ className, children, ...props }) => (\n  <div className={cn(\"bg-white rounded-2xl shadow-soft p-6\", className)} {...props}>\n    {children}\n  </div>\n);\n","size_bytes":335},"client/src/components/ui/button-custom.tsx":{"content":"import React from \"react\";\nimport { cn } from \"../../lib/utils\";\n\ninterface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\n  variant?: \"primary\" | \"outline\";\n}\n\nexport const ButtonCustom: React.FC<ButtonProps> = ({ variant = \"primary\", className, children, ...props }) => {\n  const base = \"px-5 py-2.5 rounded-2xl font-medium transition-all duration-200 shadow-soft\";\n  const styles = {\n    primary: \"bg-primary text-white hover:bg-primary-hover\",\n    outline: \"border border-primary text-primary bg-white hover:bg-primary hover:text-white\"\n  };\n\n  return (\n    <button className={cn(base, styles[variant], className)} {...props}>\n      {children}\n    </button>\n  );\n};\n","size_bytes":691},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/lib/csv-processor.ts":{"content":"import { Product } from \"@shared/schema\";\nimport Papa from \"papaparse\";\n\ninterface RawCSVRow {\n  [key: string]: string;\n}\n\nexport interface CSVParseResult {\n  data: RawCSVRow[];\n  warnings: Papa.ParseError[];\n}\n\n/**\n * Parse a CSV line respecting quotes and delimiters\n */\nfunction parseCSVLine(line: string, delimiter: string): string[] {\n  const result: string[] = [];\n  let current = '';\n  let inQuotes = false;\n  \n  for (let i = 0; i < line.length; i++) {\n    const char = line[i];\n    \n    if (char === '\"') {\n      inQuotes = !inQuotes;\n    } else if (char === delimiter && !inQuotes) {\n      result.push(current.trim());\n      current = '';\n    } else {\n      current += char;\n    }\n  }\n  result.push(current.trim());\n  return result;\n}\n\n/**\n * Try to read file with different encodings using TextDecoder\n */\nasync function readFileWithEncoding(file: File): Promise<string> {\n  // Read file as text - browser will handle encoding automatically\n  let text = await file.text();\n  \n  // Remove BOM if present\n  if (text.charCodeAt(0) === 0xFEFF) {\n    text = text.slice(1);\n  }\n  \n  // Remove surrounding quotes from each line if present\n  // This fixes files where each line is wrapped in quotes\n  const lines = text.split('\\n');\n  const cleanedLines = lines.map(line => {\n    line = line.trim();\n    // Remove quotes if line starts and ends with them\n    if (line.startsWith('\"') && line.endsWith('\"')) {\n      return line.slice(1, -1);\n    }\n    return line;\n  });\n  \n  const cleanedText = cleanedLines.join('\\n');\n  console.log('File gelesen, first 100 chars:', cleanedText.substring(0, 100));\n  return cleanedText;\n}\n\n/**\n * Detect CSV delimiter by analyzing the first few lines\n */\nfunction detectDelimiter(text: string): string {\n  const lines = text.split('\\n').slice(0, 3); // Check first 3 lines\n  const delimiters = [';', ',', '\\t', '|'];\n  \n  const scores = delimiters.map(delimiter => {\n    const counts = lines.map(line => (line.match(new RegExp(`\\\\${delimiter}`, 'g')) || []).length);\n    const avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;\n    const variance = counts.every(c => c === counts[0]) ? 0 : 1; // Prefer consistent counts\n    return { delimiter, score: avgCount, variance };\n  });\n  \n  // Sort by score (highest count) and consistency (lowest variance)\n  scores.sort((a, b) => {\n    if (a.score !== b.score) return b.score - a.score;\n    return a.variance - b.variance;\n  });\n  \n  console.log('Delimiter detection:', scores);\n  return scores[0].score > 0 ? scores[0].delimiter : ',';\n}\n\n/**\n * Parse CSV file and return raw data rows using PapaParse\n */\nexport async function parseCSV(file: File): Promise<CSVParseResult> {\n  try {\n    const text = await readFileWithEncoding(file);\n    \n    // Detect delimiter\n    const delimiter = detectDelimiter(text);\n    console.log('Using delimiter:', delimiter === '\\t' ? 'TAB' : delimiter);\n    console.log('First line of CSV:', text.split('\\n')[0]);\n    \n    // Use PapaParse to parse the CSV\n    const parseConfig: Papa.ParseConfig = {\n      header: true,\n      delimiter: delimiter,\n      skipEmptyLines: true,\n      transformHeader: (header: string) => header.trim(),\n      transform: (value: string) => value.trim(),\n      dynamicTyping: false\n    };\n    \n    console.log('Papa.parse config:', parseConfig);\n    const result = Papa.parse<RawCSVRow>(text, parseConfig);\n    \n    if (result.errors && result.errors.length > 0) {\n      console.warn(`CSV Parse Warnungen: ${result.errors.length} Warnungen gefunden`);\n    }\n    \n    if (!result.data || result.data.length === 0) {\n      throw new Error('CSV enthlt keine Daten');\n    }\n    \n    // Log column names for debugging\n    const headers = Object.keys(result.data[0]);\n    console.log('Gefundene Spalten:', headers.length);\n    console.log('Spalten-Namen:', headers.slice(0, 10));\n    console.log('Erste Zeile:', result.data[0]);\n    \n    console.log('Zeilen eingelesen:', result.data.length);\n    \n    return {\n      data: result.data,\n      warnings: result.errors || []\n    };\n  } catch (error) {\n    console.error('CSV Parse Fehler:', error);\n    throw new Error(`Fehler beim Parsen der CSV: ${error instanceof Error ? error.message : 'Unbekannter Fehler'}`);\n  }\n}\n\n/**\n * Categorize product based on name and description\n */\nfunction categorizeProduct(name: string, description: string): string {\n  const combinedText = (name + ' ' + description).toLowerCase();\n  \n  // Specific categories (highest priority)\n  if (combinedText.match(/\\b(akku|battery|batterie|hochleistungs-akku|li-ion|lithium|cell)\\b/i)) {\n    return 'Akku';\n  }\n  if (combinedText.match(/\\b(netzteil|notebook netzteil|notebook-netzteil|power supply|ac adapter|netzadapter|stromversorgung)\\b/i)) {\n    return 'Notebook Netzteil';\n  }\n  if (combinedText.match(/\\b(kfz|auto|car)\\b/i) && combinedText.match(/\\b(ladekabel|ladegeraet|charger)\\b/i)) {\n    return 'KFZ Ladekabel';\n  }\n  if (combinedText.match(/\\b(ladegeraet|ladestation|charger|charging station|lader)\\b/i)) {\n    return 'Ladegert';\n  }\n  if (combinedText.match(/\\b(speicherkarte|memory card|sd|sdhc|sdxc|microsd)\\b/i)) {\n    return 'Speicherkarte';\n  }\n  if (combinedText.match(/\\b(hdmi)\\b/i) && combinedText.match(/\\b(umschaltbox|switch)\\b/i)) {\n    return 'HDMI Umschaltbox';\n  }\n  if (combinedText.match(/\\b(hdmi)\\b/i) && combinedText.match(/\\b(konverter|converter|adapter)\\b/i)) {\n    return 'HDMI Konverter';\n  }\n  if (combinedText.match(/\\b(tv|fernseh)\\b/i) && combinedText.match(/\\b(kupplung|verteiler)\\b/i)) {\n    return 'TV Kupplung';\n  }\n  if (combinedText.match(/\\b(dockingstation|docking station|dock)\\b/i)) {\n    return 'Dockingstation';\n  }\n  if (combinedText.match(/\\b(led)\\b/i) && combinedText.match(/\\b(lampe|leuchte|light)\\b/i)) {\n    return 'LED Lampe';\n  }\n  if (combinedText.match(/\\b(adapter|stromadapter)\\b/i)) {\n    return 'Adapter';\n  }\n  if (combinedText.match(/\\b(kabel|cable|stromkabel|netzkabel)\\b/i)) {\n    return 'Kabel';\n  }\n  \n  // Fallback: use first 2 words from product name\n  if (name) {\n    const words = name.split(/[\\s,;.\\-]+/).filter(w => w.length > 2);\n    if (words.length > 0) {\n      return words.slice(0, 2).join(' ').trim();\n    }\n  }\n  \n  return 'Zubehr';\n}\n\n/**\n * Extract model numbers from text\n */\nfunction extractModelNumbers(text: string): string[] {\n  const modelPattern = /\\b[A-Z0-9]{3,}[\\dA-Z\\-\\/]{0,}\\b/g;\n  const matches = text.match(modelPattern) || [];\n  \n  // Filter out technical values, years, and invalid patterns\n  const validModels = matches.filter(m => \n    m.length >= 3 && m.length <= 20 && \n    (/\\d/.test(m) || m.match(/^(SDHC|SDXC|USB|HDMI|LED)$/i)) &&\n    !m.match(/^(DE|EN|FR|IT|ES|NL|PL|VGA|DVI|AUX|RGB)$/i) &&\n    !m.match(/^\\d+V$/i) &&\n    !m.match(/^\\d+W$/i) &&\n    !m.match(/^\\d+Wh$/i) &&\n    !m.match(/^\\d+mAh$/i) &&\n    !m.match(/^\\d+Ah$/i) &&\n    !m.match(/^(19|20)\\d{2}$/i)  // Filter out years like 2019, 2020, 2021, etc.\n  );\n  \n  return Array.from(new Set(validModels));\n}\n\n/**\n * Find column name from CSV headers using multiple possible variants\n */\nfunction findColumn(row: RawCSVRow, possibleNames: string[]): string {\n  const headers = Object.keys(row);\n  \n  for (const name of possibleNames) {\n    // Exact match (case-insensitive)\n    const exactMatch = headers.find(h => h.toLowerCase() === name.toLowerCase());\n    if (exactMatch) return exactMatch;\n    \n    // Partial match (case-insensitive)\n    const partialMatch = headers.find(h => \n      h.toLowerCase().includes(name.toLowerCase()) || \n      name.toLowerCase().includes(h.toLowerCase())\n    );\n    if (partialMatch) return partialMatch;\n  }\n  \n  return '';\n}\n\n/**\n * Generate MediaMarkt optimized title V1\n * Format: [Produkttyp] [Modellnummer(n)] - NO brand names!\n * Examples: \"Notebook Netzteil K42JQ\", \"Akku P210 P290\", \"Dockingstation USB Q10\"\n */\nfunction generateMarketplaceTitle(name: string, description: string): string {\n  const combinedText = (name + ' ' + description).toLowerCase();\n  \n  // Determine product type (NO brand names!)\n  let productType = '';\n  \n  if (combinedText.match(/\\b(netzteil|notebook netzteil|notebook-netzteil|power supply|ac adapter|netzadapter|stromversorgung)\\b/i)) {\n    productType = 'Notebook Netzteil';\n  } else if (combinedText.match(/\\b(akku|battery|batterie|hochleistungs-akku|li-ion|lithium|cell)\\b/i)) {\n    productType = 'Akku';\n  } else if (combinedText.match(/\\b(kfz|auto|car)\\b/i) && combinedText.match(/\\b(ladekabel|ladegeraet|charger)\\b/i)) {\n    productType = 'KFZ Ladekabel';\n  } else if (combinedText.match(/\\b(ladegeraet|ladestation|charger|charging station|lader)\\b/i)) {\n    productType = 'Ladegert';\n  } else if (combinedText.match(/\\b(speicherkarte|memory card|sd|sdhc|sdxc|microsd)\\b/i)) {\n    productType = 'Speicherkarte';\n  } else if (combinedText.match(/\\b(hdmi)\\b/i) && combinedText.match(/\\b(umschaltbox|switch)\\b/i)) {\n    productType = 'HDMI Umschaltbox';\n  } else if (combinedText.match(/\\b(hdmi)\\b/i) && combinedText.match(/\\b(konverter|converter|adapter)\\b/i)) {\n    productType = 'HDMI Konverter';\n  } else if (combinedText.match(/\\b(dockingstation|docking station|dock)\\b/i)) {\n    productType = 'Dockingstation';\n  } else if (combinedText.match(/\\b(led)\\b/i) && combinedText.match(/\\b(lampe|leuchte|light)\\b/i)) {\n    productType = 'LED Lampe';\n  } else if (combinedText.match(/\\b(adapter|stromadapter)\\b/i)) {\n    productType = 'Adapter';\n  } else if (combinedText.match(/\\b(kabel|cable|stromkabel|netzkabel)\\b/i)) {\n    productType = 'Kabel';\n  } else if (combinedText.match(/\\b(tv|fernseh)\\b/i) && combinedText.match(/\\b(kupplung|verteiler)\\b/i)) {\n    productType = 'TV Kupplung';\n  } else {\n    // Fallback: Use first 2 words from name, but filter out brand names\n    const words = name.split(/[\\s,;.\\-]+/).filter(w => {\n      const lower = w.toLowerCase();\n      // Filter out common brand names and unwanted words\n      return w.length > 2 && \n        !lower.match(/^(asus|hp|dell|lenovo|acer|samsung|apple|sony|lg|toshiba|msi|asus|ibm|fujitsu|medion|fr|fuer|kein|original|passend|geeignet)$/i);\n    });\n    productType = words.slice(0, 2).join(' ');\n  }\n  \n  // Extract model numbers (alphanumeric codes)\n  const models = extractModelNumbers(name + ' ' + description);\n  \n  // Build title: ProductType + Model Numbers\n  let title = productType;\n  if (models.length > 0) {\n    // Add up to 3 model numbers\n    const modelStr = models.slice(0, 3).join(' ');\n    title += ' ' + modelStr;\n  }\n  \n  // Clean up whitespace\n  title = title.replace(/\\s+/g, ' ').trim();\n  \n  // Limit length to 100 characters\n  if (title.length > 100) {\n    title = title.substring(0, 100).trim();\n    const lastSpace = title.lastIndexOf(' ');\n    if (lastSpace > 80) {\n      title = title.substring(0, lastSpace);\n    }\n  }\n  \n  return title;\n}\n\n/**\n * Generate MediaMarkt optimized title V2 (follows TTL and TTB rules)\n * Format: ONLY model numbers - NO product type, NO brand names!\n * MediaMarkt automatically adds product type and attributes.\n * Examples: \"K42JQ\", \"P210 P290\", \"USB Q10\"\n */\nfunction generateMarketplaceTitleV2(name: string, description: string): string {\n  // Extract model numbers only\n  const models = extractModelNumbers(name + ' ' + description);\n  \n  if (models.length === 0) {\n    // If no models found, try to extract meaningful words from name (no brands)\n    const words = name.split(/[\\s,;.\\-]+/).filter(w => {\n      const lower = w.toLowerCase();\n      return w.length > 2 && \n        !lower.match(/^(asus|hp|dell|lenovo|acer|samsung|apple|sony|lg|toshiba|msi|ibm|fujitsu|medion|netzteil|akku|fr|fuer|kein|original|passend|geeignet|notebook|laptop|charger|adapter|cable|kabel)$/i);\n    });\n    \n    if (words.length > 0) {\n      return words.slice(0, 3).join(' ').trim();\n    }\n    \n    return '';\n  }\n  \n  // Build title: ONLY Model Numbers (up to 3)\n  let title = models.slice(0, 3).join(' ');\n  \n  // Clean up whitespace\n  title = title.replace(/\\s+/g, ' ').trim();\n  \n  // Limit length to 80 characters (shorter for MediaMarkt)\n  if (title.length > 80) {\n    title = title.substring(0, 80).trim();\n    const lastSpace = title.lastIndexOf(' ');\n    if (lastSpace > 60) {\n      title = title.substring(0, lastSpace);\n    }\n  }\n  \n  return title;\n}\n\n/**\n * Extract Verpackungseinheit from description\n */\nfunction extractVerpackungseinheit(description: string): string {\n  // Look for patterns like \"1 Stck\", \"2er Pack\", \"10-er Set\", etc.\n  const patterns = [\n    /(\\d+)\\s*(?:er)?[\\s-]*(?:Pack|Set|Stck|Stuck|Stueck|pcs|pieces|pc)/i,\n    /(?:Pack|Set)\\s*(?:mit|zu|a)\\s*(\\d+)/i,\n    /(\\d+)[\\s-]*teilig/i,\n    /Einzelstueck|Einzelstck/i\n  ];\n  \n  for (const pattern of patterns) {\n    const match = description.match(pattern);\n    if (match) {\n      if (match[0].match(/Einzelstueck|Einzelstck/i)) {\n        return '1 Stck';\n      }\n      if (match[1]) {\n        return `${match[1]} Stck`;\n      }\n    }\n  }\n  \n  return '';\n}\n\n/**\n * Extract Lieferumfang from description\n */\nfunction extractLieferumfang(description: string): string {\n  // Look for sections mentioning \"Lieferumfang\", \"enthlt\", \"inkl.\", etc.\n  const lieferumfangPatterns = [\n    /Lieferumfang:\\s*([^.;]+)/i,\n    /Im Lieferumfang enthalten:\\s*([^.;]+)/i,\n    /Enthlt:\\s*([^.;]+)/i,\n    /Inklusive:\\s*([^.;]+)/i,\n    /inkl\\.\\s*([^.;]+)/i\n  ];\n  \n  for (const pattern of lieferumfangPatterns) {\n    const match = description.match(pattern);\n    if (match && match[1]) {\n      let umfang = match[1].trim();\n      // Clean up and limit length\n      if (umfang.length > 200) {\n        umfang = umfang.substring(0, 200).trim();\n        const lastComma = umfang.lastIndexOf(',');\n        if (lastComma > 150) {\n          umfang = umfang.substring(0, lastComma);\n        }\n      }\n      return umfang;\n    }\n  }\n  \n  return '';\n}\n\n/**\n * Clean HTML tags and decode HTML entities\n */\nfunction cleanHTML(text: string): string {\n  if (!text) return '';\n  \n  // Remove script and style tags with their content\n  let cleaned = text.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, ' ');\n  cleaned = cleaned.replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, ' ');\n  \n  // Remove style attributes from HTML tags (e.g., style=\"font-family: tahoma...\")\n  cleaned = cleaned.replace(/\\s+style\\s*=\\s*\"[^\"]*\"/gi, '');\n  cleaned = cleaned.replace(/\\s+style\\s*=\\s*'[^']*'/gi, '');\n  \n  // Remove all other HTML tags\n  cleaned = cleaned.replace(/<[^>]*>/g, ' ');\n  \n  // Decode common HTML entities\n  const entities: Record<string, string> = {\n    '&nbsp;': ' ',\n    '&nbsp': ' ',\n    '&amp;': '&',\n    '&amp': '&',\n    '&lt;': '<',\n    '&lt': '<',\n    '&gt;': '>',\n    '&gt': '>',\n    '&quot;': '\"',\n    '&quot': '\"',\n    '&apos;': \"'\",\n    '&apos': \"'\",\n    '&#39;': \"'\",\n    '&#39': \"'\",\n    '&auml;': '',\n    '&ouml;': '',\n    '&uuml;': '',\n    '&Auml;': '',\n    '&Ouml;': '',\n    '&Uuml;': '',\n    '&szlig;': '',\n    '&euro;': ''\n  };\n  \n  // Replace all HTML entities\n  Object.keys(entities).forEach(entity => {\n    const regex = new RegExp(entity, 'gi');\n    cleaned = cleaned.replace(regex, entities[entity]);\n  });\n  \n  // Clean up whitespace\n  cleaned = cleaned.replace(/\\s+/g, ' ').trim();\n  \n  return cleaned;\n}\n\n/**\n * Enrich raw CSV data with categorization and technical specs\n */\nexport function enrichProducts(rawData: RawCSVRow[]): Product[] {\n  const enriched: Product[] = [];\n  \n  // Find the correct column names from the first row\n  if (rawData.length === 0) {\n    return enriched;\n  }\n  \n  const firstRow = rawData[0];\n  const skuColumn = findColumn(firstRow, ['Shop SKU', 'SKU', 'Artikelnummer', 'p_item_number', 'Item Number', 'Article Number']);\n  const titleColumn = findColumn(firstRow, ['Titel (DE)', 'Title', 'Produktname', 'p_name[de]', 'Product Name', 'Name']);\n  const descColumn = findColumn(firstRow, ['Produktbeschreibung (DE)', 'Description', 'Beschreibung', 'p_description[de]', 'Product Description']);\n  const brandColumn = findColumn(firstRow, ['Brand', 'Marke', 'p_group_path[de]', 'Hersteller', 'Manufacturer']);\n  \n  console.log('Gefundene Spalten-Mapping:');\n  console.log('  SKU:', skuColumn);\n  console.log('  Titel:', titleColumn);\n  console.log('  Beschreibung:', descColumn);\n  console.log('  Marke:', brandColumn);\n  \n  for (let i = 0; i < rawData.length; i++) {\n    const row = rawData[i];\n    \n    // Debug: Log first 3 rows to see what's in the SKU column\n    if (i < 3) {\n      console.log(`Zeile ${i} - Roh-SKU:`, row[skuColumn]);\n    }\n    \n    // Clean all text fields from HTML tags and entities\n    let artikelnummer = cleanHTML(row[skuColumn] || '');\n    \n    // Extra cleaning for SKU: Remove everything except alphanumeric, dash, underscore\n    // This removes any remaining CSS, HTML, or special characters\n    artikelnummer = artikelnummer.replace(/[^a-zA-Z0-9\\-_]/g, '').trim();\n    \n    const produktname = cleanHTML(row[titleColumn] || '');\n    const produktbeschreibung = row[descColumn] || '';\n    const marke = cleanHTML(row[brandColumn] || '');\n    \n    // Debug: Log cleaned value\n    if (i < 3) {\n      console.log(`Zeile ${i} - Bereinigte SKU:`, artikelnummer);\n    }\n    \n    // Clean HTML tags and entities from description\n    const cleanBeschreibung = cleanHTML(produktbeschreibung);\n    \n    // Extract technical specifications\n    // Preserve original voltage string for ranges, extract single values\n    let spannung = '';\n    const voltageRangeMatch = produktbeschreibung.match(/\\d+[,.]?\\d*\\s*(?:bis|-|to)\\s*\\d+[,.]?\\d*\\s*(?:Volt|V)(?!\\w)/i);\n    if (voltageRangeMatch) {\n      // Preserve the exact original range string\n      spannung = voltageRangeMatch[0].trim();\n    } else {\n      // Single voltage value - extract and format\n      const spannungMatch = produktbeschreibung.match(/(\\d+[,.]?\\d*)\\s*(?:Volt|V)(?!\\w)/i);\n      if (spannungMatch) {\n        const value = spannungMatch[1];\n        spannung = value + ' V';\n      }\n    }\n    \n    const kapazitaetMatch = produktbeschreibung.match(/(\\d+)\\s*mAh/i);\n    const kapazitaet = kapazitaetMatch ? kapazitaetMatch[1] + ' mAh' : '';\n    \n    const wattMatch = produktbeschreibung.match(/(\\d+)\\s*W(?!h)/i);\n    const energiegehalt = wattMatch ? wattMatch[1] + ' W' : '';\n    \n    const whMatch = produktbeschreibung.match(/(\\d+[,.]?\\d*)\\s*Wh/i);\n    const leistung = whMatch ? whMatch[1].replace(',', '.') + ' Wh' : '';\n    \n    // Extract Verpackungseinheit and Lieferumfang\n    const verpackungseinheit = extractVerpackungseinheit(produktbeschreibung);\n    const lieferumfang = extractLieferumfang(produktbeschreibung);\n    \n    // Generate marketplace titles (both versions)\n    const titelMarktplatz = generateMarketplaceTitle(produktname, cleanBeschreibung);\n    const titelMarktplatzV2 = generateMarketplaceTitleV2(produktname, cleanBeschreibung);\n    \n    enriched.push({\n      id: i,\n      sku: artikelnummer,\n      titel: produktname,\n      produktbeschreibung: cleanBeschreibung,\n      marke: marke,\n      titel_marktplatz: titelMarktplatz,\n      titel_marktplatz_v2: titelMarktplatzV2,\n      spannung: spannung,\n      kapazitaet: kapazitaet,\n      energiegehalt: energiegehalt,\n      leistung: leistung,\n      verpackungseinheit: verpackungseinheit,\n      lieferumfang: lieferumfang,\n    });\n    \n    if (i % 500 === 0 && i > 0) {\n      console.log('Verarbeitet:', i, 'Zeilen');\n    }\n  }\n  \n  // Filter out empty descriptions and CSV header rows\n  const filtered = enriched.filter(item => {\n    // Remove rows with empty descriptions\n    if (item.produktbeschreibung.length === 0) return false;\n    \n    // Remove CSV header row (e.g., SKU = \"SHOP_SKU\" or \"p_item_number\")\n    const skuUpper = item.sku.toUpperCase();\n    if (skuUpper === 'SHOP_SKU' || skuUpper === 'P_ITEM_NUMBER' || skuUpper === 'SKU' || skuUpper === 'ARTIKELNUMMER') {\n      return false;\n    }\n    \n    // Remove rows where title looks like a header (e.g., \"TITLE\" or \"Product_Description\")\n    const titleUpper = item.titel.toUpperCase();\n    if (titleUpper === 'TITLE' || titleUpper === 'PRODUKTNAME' || titleUpper === 'P_NAME[DE]') {\n      return false;\n    }\n    \n    // Remove rows where description looks like a header (e.g., \"Product_Description\")\n    const descUpper = item.produktbeschreibung.toUpperCase();\n    if (descUpper === 'PRODUCT_DESCRIPTION' || descUpper === 'PRODUKTBESCHREIBUNG' || descUpper === 'P_DESCRIPTION[DE]' || descUpper === 'DESCRIPTION') {\n      return false;\n    }\n    \n    return true;\n  });\n  \n  // Detect duplicates by SKU\n  const skuCounts: Record<string, number> = {};\n  filtered.forEach(item => {\n    if (item.sku) {\n      skuCounts[item.sku] = (skuCounts[item.sku] || 0) + 1;\n    }\n  });\n  \n  const withDuplicates = filtered.map(item => ({\n    ...item,\n    isDuplicate: item.sku ? skuCounts[item.sku] > 1 : false,\n  }));\n  \n  console.log('Verarbeitung abgeschlossen:', filtered.length, 'Produkte');\n  return withDuplicates;\n}\n\nexport interface ExportColumn {\n  key: string;\n  label: string;\n  enabled: boolean;\n}\n\n/**\n * Export products to CSV using PapaParse library\n */\nexport function exportToCSV(products: Product[], selectedColumns: ExportColumn[]): void {\n  try {\n    // Map column keys to product properties and export labels\n    const columnMapping: Record<string, { property: keyof Product; label: string }> = {\n      'sku': { property: 'sku', label: 'Artikelnummer' },\n      'titel': { property: 'titel', label: 'Produktname_Brickfox' },\n      'titel_marktplatz': { property: 'titel_marktplatz', label: 'Produktname_MediaMarkt_V1' },\n      'titel_marktplatz_v2': { property: 'titel_marktplatz_v2', label: 'Produktname_MediaMarkt_V2' },\n      'energiegehalt': { property: 'energiegehalt', label: 'Energiegehalt_W' },\n      'spannung': { property: 'spannung', label: 'Spannung_V' },\n      'kapazitaet': { property: 'kapazitaet', label: 'Kapazitaet_mAh' },\n      'leistung': { property: 'leistung', label: 'Leistung_Wh' },\n      'verpackungseinheit': { property: 'verpackungseinheit', label: 'Verpackungseinheit' },\n      'lieferumfang': { property: 'lieferumfang', label: 'Lieferumfang' },\n    };\n\n    // Build data with only selected columns\n    const data = products.map(row => {\n      const exportRow: Record<string, string> = {};\n      selectedColumns.forEach(col => {\n        const mapping = columnMapping[col.key];\n        if (mapping) {\n          exportRow[mapping.label] = (row[mapping.property] as string) || '';\n        }\n      });\n      return exportRow;\n    });\n    \n    // Use PapaParse to generate CSV with proper formatting\n    const csv = Papa.unparse(data, {\n      delimiter: ';',\n      header: true,\n      quotes: true,\n      quoteChar: '\"',\n      escapeChar: '\"',\n      newline: '\\r\\n'\n    });\n    \n    // Add BOM for proper encoding in Excel\n    const BOM = '\\uFEFF';\n    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });\n    const url = URL.createObjectURL(blob);\n    \n    // Create download link\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `mediamarkt_export_${new Date().toISOString().split('T')[0]}.csv`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    // Cleanup\n    setTimeout(() => {\n      URL.revokeObjectURL(url);\n    }, 100);\n    \n    console.log('CSV heruntergeladen:', products.length, 'Produkte');\n  } catch (error) {\n    console.error('Download-Fehler:', error);\n    throw new Error('Fehler beim Herunterladen der CSV-Datei');\n  }\n}\n","size_bytes":23399},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 240 5% 98%;\n\n  --foreground: 220 13% 18%;\n\n  --border: 220 13% 91%;\n\n  --card: 0 0% 100%;\n\n  --card-foreground: 220 13% 18%;\n\n  --card-border: 220 13% 94%;\n\n  --sidebar: 240 5% 96%;\n\n  --sidebar-foreground: 220 13% 18%;\n\n  --sidebar-border: 220 13% 89%;\n\n  --sidebar-primary: 238 84% 60%;\n\n  --sidebar-primary-foreground: 210 20% 98%;\n\n  --sidebar-accent: 220 10% 92%;\n\n  --sidebar-accent-foreground: 220 13% 18%;\n\n  --sidebar-ring: 238 84% 60%;\n\n  --popover: 240 5% 94%;\n\n  --popover-foreground: 220 13% 18%;\n\n  --popover-border: 220 13% 87%;\n\n  --primary: 238 84% 60%;\n\n  --primary-foreground: 210 20% 98%;\n\n  --secondary: 220 10% 90%;\n\n  --secondary-foreground: 220 13% 18%;\n\n  --muted: 220 8% 93%;\n\n  --muted-foreground: 220 9% 46%;\n\n  --accent: 220 12% 95%;\n\n  --accent-foreground: 220 13% 18%;\n\n  --destructive: 0 84% 60%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 85%;\n  --ring: 238 84% 60%;\n  --chart-1: 238 84% 60%;\n  --chart-2: 142 76% 36%;\n  --chart-3: 38 92% 50%;\n  --chart-4: 271 81% 60%;\n  --chart-5: 0 84% 60%;\n\n  --font-sans: Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: \"JetBrains Mono\", Menlo, monospace;\n  --radius: .5rem; /* 8px */\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 13% 18% / 0.05);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 13% 18% / 0.08);\n  --shadow-sm: 0px 2px 4px -1px hsl(220 13% 18% / 0.06), 0px 1px 2px -1px hsl(220 13% 18% / 0.05);\n  --shadow: 0px 4px 6px -1px hsl(220 13% 18% / 0.08), 0px 2px 4px -1px hsl(220 13% 18% / 0.06);\n  --shadow-md: 0px 6px 12px -2px hsl(220 13% 18% / 0.10), 0px 3px 7px -3px hsl(220 13% 18% / 0.08);\n  --shadow-lg: 0px 10px 20px -5px hsl(220 13% 18% / 0.12), 0px 8px 16px -6px hsl(220 13% 18% / 0.10);\n  --shadow-xl: 0px 20px 25px -5px hsl(220 13% 18% / 0.14), 0px 10px 18px -7px hsl(220 13% 18% / 0.12);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 13% 18% / 0.18);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 222 47% 11%;\n\n  --foreground: 210 20% 98%;\n\n  --border: 217 33% 25%;\n\n  --card: 217 33% 17%;\n\n  --card-foreground: 210 20% 98%;\n\n  --card-border: 217 33% 22%;\n\n  --sidebar: 220 40% 14%;\n\n  --sidebar-foreground: 210 20% 98%;\n\n  --sidebar-border: 217 33% 20%;\n\n  --sidebar-primary: 238 84% 68%;\n\n  --sidebar-primary-foreground: 210 20% 98%;\n\n  --sidebar-accent: 220 35% 19%;\n\n  --sidebar-accent-foreground: 210 20% 98%;\n\n  --sidebar-ring: 238 84% 68%;\n\n  --popover: 217 35% 20%;\n\n  --popover-foreground: 210 20% 98%;\n\n  --popover-border: 217 33% 27%;\n\n  --primary: 238 84% 68%;\n\n  --primary-foreground: 210 20% 98%;\n\n  --secondary: 220 30% 23%;\n\n  --secondary-foreground: 210 20% 98%;\n\n  --muted: 220 28% 21%;\n\n  --muted-foreground: 215 20% 65%;\n\n  --accent: 220 32% 18%;\n\n  --accent-foreground: 210 20% 98%;\n\n  --destructive: 0 84% 70%;\n\n  --destructive-foreground: 210 20% 98%;\n\n  /* Used as the border around inputs. Dark mode: Should be a border that is light enough to have high contrast when rendered on a --card background. More contrast than standard --border */\n  --input: 217 33% 32%;\n  --ring: 238 84% 68%;\n  --chart-1: 238 84% 68%;\n  --chart-2: 142 76% 46%;\n  --chart-3: 38 92% 60%;\n  --chart-4: 271 81% 68%;\n  --chart-5: 0 84% 70%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(0 0% 0% / 0.30);\n  --shadow-xs: 0px 1px 3px 0px hsl(0 0% 0% / 0.35);\n  --shadow-sm: 0px 2px 4px -1px hsl(0 0% 0% / 0.32), 0px 1px 2px -1px hsl(0 0% 0% / 0.30);\n  --shadow: 0px 4px 6px -1px hsl(0 0% 0% / 0.35), 0px 2px 4px -1px hsl(0 0% 0% / 0.32);\n  --shadow-md: 0px 6px 12px -2px hsl(0 0% 0% / 0.38), 0px 3px 7px -3px hsl(0 0% 0% / 0.35);\n  --shadow-lg: 0px 10px 20px -5px hsl(0 0% 0% / 0.42), 0px 8px 16px -6px hsl(0 0% 0% / 0.38);\n  --shadow-xl: 0px 20px 25px -5px hsl(0 0% 0% / 0.48), 0px 10px 18px -7px hsl(0 0% 0% / 0.42);\n  --shadow-2xl: 0px 25px 50px -12px hsl(0 0% 0% / 0.55);\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n\nh1, h2, h3, h4 {\n  @apply font-bold text-foreground;\n}\n\na {\n  @apply text-primary hover:text-primary-hover transition;\n}\n\n/* Permanente horizontale Scrollbar fr Produkttabellen */\n.table-scroll-visible {\n  overflow-x: auto !important;\n  overflow-y: auto !important;\n}\n\n.table-scroll-visible::-webkit-scrollbar {\n  height: 14px;\n}\n\n.table-scroll-visible::-webkit-scrollbar-track {\n  background: #f1f1f1;\n  border-radius: 8px;\n}\n\n.table-scroll-visible::-webkit-scrollbar-thumb {\n  background: #888;\n  border-radius: 8px;\n}\n\n.table-scroll-visible::-webkit-scrollbar-thumb:hover {\n  background: #555;\n}","size_bytes":12220},"shared/schema.ts":{"content":"import { z } from \"zod\";\nimport { pgTable, text, integer, uuid, timestamp, jsonb, boolean } from \"drizzle-orm/pg-core\";\nimport { relations, sql } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\n\n// Product data model for CSV enrichment\nexport const productSchema = z.object({\n  id: z.number(),\n  sku: z.string(),\n  titel: z.string(),\n  produktbeschreibung: z.string(),\n  marke: z.string(),\n  titel_marktplatz: z.string(),\n  titel_marktplatz_v2: z.string(),\n  spannung: z.string(),\n  kapazitaet: z.string(),\n  energiegehalt: z.string(),\n  leistung: z.string(),\n  verpackungseinheit: z.string(),\n  lieferumfang: z.string(),\n  isDuplicate: z.boolean().optional(),\n});\n\nexport type Product = z.infer<typeof productSchema>;\n\n// File upload state\nexport interface FileUploadState {\n  file: File | null;\n  fileName: string;\n  fileSize: number;\n  encoding: string;\n}\n\n// Processing state\nexport interface ProcessingState {\n  isProcessing: boolean;\n  progress: number;\n  totalRows: number;\n  currentRow: number;\n}\n\n// Product Creator schemas - AI-powered PIM description generation\nexport const extractedProductDataSchema = z.object({\n  id: z.string(),\n  fileName: z.string(),\n  fileType: z.enum(['pdf', 'csv', 'image', 'url']),\n  extractedText: z.string(),\n  productName: z.string().optional(),\n  description: z.string().optional(),\n  dimensions: z.string().optional(),\n  weight: z.string().optional(),\n  voltage: z.string().optional(),\n  capacity: z.string().optional(),\n  power: z.string().optional(),\n  technicalSpecs: z.record(z.string(), z.any()).optional(),\n  confidence: z.number().optional(),\n  createdAt: z.string().optional(),\n  url: z.string().optional(),\n  supplierTableHtml: z.string().optional(),\n  bullets: z.array(z.string()).optional(),\n  structuredData: z.record(z.string(), z.any()).optional(),\n});\n\nexport type ExtractedProductData = z.infer<typeof extractedProductDataSchema>;\n\nexport const pimProductSchema = z.object({\n  id: z.string(),\n  sku: z.string().optional(),\n  name: z.string().optional(),\n  brand: z.string().optional(),\n  category: z.string().optional(),\n  description: z.string().optional(),\n  technicalSpecs: z.record(z.string(), z.string()).optional(),\n  features: z.array(z.string()).optional(),\n  extractedData: z.array(extractedProductDataSchema).optional(),\n  generatedDescription: z.string().optional(),\n  customFields: z.record(z.string(), z.string()).optional(),\n});\n\nexport type PIMProduct = z.infer<typeof pimProductSchema>;\n\n\nexport const templateSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  content: z.string(),\n  isDefault: z.boolean().optional(),\n});\n\nexport type Template = z.infer<typeof templateSchema>;\n\nexport const exportColumnSchema = z.object({\n  id: z.string(),\n  label: z.string(),\n  field: z.string(),\n  enabled: z.boolean(),\n});\n\nexport type ExportColumn = z.infer<typeof exportColumnSchema>;\n\n// Project management schemas\nexport const projectSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  createdAt: z.string(),\n});\n\nexport type Project = z.infer<typeof projectSchema>;\n\nexport const createProjectSchema = projectSchema.omit({ id: true, createdAt: true });\nexport type CreateProject = z.infer<typeof createProjectSchema>;\n\nexport const productInProjectSchema = z.object({\n  id: z.string(),\n  projectId: z.string(),\n  name: z.string().optional(),\n  files: z.array(z.object({\n    fileName: z.string(),\n    fileType: z.string(),\n    fileSize: z.number(),\n  })).optional(),\n  htmlCode: z.string().optional(),\n  previewText: z.string().optional(),\n  extractedData: z.array(z.any()).optional(), // Flexible format: can be extractedProductDataSchema OR simple key-value pairs\n  template: z.string().optional(),\n  customAttributes: z.array(z.object({\n    key: z.string(),\n    value: z.string(),\n    type: z.string(),\n  })).optional(),\n  exactProductName: z.string().optional(),\n  articleNumber: z.string().optional(),\n  pixi_status: z.enum(['NEU', 'VORHANDEN']).optional(),\n  pixi_ean: z.string().optional(),\n  pixi_checked_at: z.string().optional(),\n  createdAt: z.string(),\n});\n\nexport type ProductInProject = z.infer<typeof productInProjectSchema>;\n\nexport const createProductInProjectSchema = productInProjectSchema.omit({ id: true, createdAt: true, projectId: true }).extend({\n  manufacturerArticleNumber: z.string().optional()\n});\nexport type CreateProductInProject = z.infer<typeof createProductInProjectSchema>;\n\nexport const updateProductInProjectSchema = productInProjectSchema.partial().omit({ id: true, projectId: true, createdAt: true });\nexport type UpdateProductInProject = z.infer<typeof updateProductInProjectSchema>;\n\n// Tenant Settings interface for feature flags and configurations\nexport interface TenantSettings {\n  // Feature Flags\n  features?: {\n    pixiIntegration?: boolean;      // Enable Pixi ERP Comparison\n    sapIntegration?: boolean;        // Enable SAP ERP Integration\n    urlScraper?: boolean;           // Enable URL Scraper (default: true)\n    csvBulkImport?: boolean;        // Enable CSV Bulk Import (default: true)\n    aiDescriptions?: boolean;       // Enable AI Descriptions (default: true)\n  };\n  \n  // ERP Configuration\n  erp?: {\n    type?: 'pixi' | 'sap' | 'custom' | null;\n    apiUrl?: string;\n    apiKey?: string;\n    settings?: Record<string, any>;\n  };\n  \n  // Custom branding (optional)\n  branding?: {\n    logo?: string;\n    primaryColor?: string;\n    companyName?: string;\n  };\n  \n  // Other custom settings\n  [key: string]: any;\n}\n\n// Zod schema for tenant creation\nexport const createTenantSchema = z.object({\n  name: z.string().min(1, 'Tenant name required'),\n  slug: z.string().optional(),\n  settings: z.any().optional(),\n});\n\nexport type CreateTenant = z.infer<typeof createTenantSchema>;\n\nexport const updateTenantSchema = z.object({\n  name: z.string().optional(),\n  settings: z.any().optional(),\n});\n\nexport type UpdateTenant = z.infer<typeof updateTenantSchema>;\n\n// Drizzle database tables for PostgreSQL (Supabase)\n\n// Tenants table for multi-tenant B2B SaaS (akkushop.de, kunde2, etc.)\nexport const tenants = pgTable(\"tenants\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  settings: jsonb(\"settings\").default({}),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Users table for authentication and subscription management\n// Note: passwords are managed by Supabase Auth, not stored here\nexport const users = pgTable(\"users\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  email: text(\"email\").notNull().unique(),\n  username: text(\"username\"),\n  isAdmin: boolean(\"is_admin\").default(false),\n  \n  // Multi-tenant fields\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").default('member'),\n  \n  // Stripe subscription fields\n  stripeCustomerId: text(\"stripe_customer_id\"),\n  subscriptionStatus: text(\"subscription_status\"), // active, canceled, past_due, trialing, incomplete\n  subscriptionId: text(\"subscription_id\"),\n  planId: text(\"plan_id\"), // starter, pro, enterprise\n  currentPeriodEnd: timestamp(\"current_period_end\", { withTimezone: true }),\n  \n  // Usage tracking for API limits\n  apiCallsUsed: integer(\"api_calls_used\").default(0),\n  apiCallsLimit: integer(\"api_calls_limit\").default(500), // Default: Starter plan\n  \n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const projects = pgTable(\"projects\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const productsInProjects = pgTable(\"products_in_projects\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  projectId: uuid(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  name: text(\"name\"),\n  files: jsonb(\"files\"),\n  htmlCode: text(\"html_code\"),\n  previewText: text(\"preview_text\"),\n  extractedData: jsonb(\"extracted_data\"),\n  template: text(\"template\"),\n  customAttributes: jsonb(\"custom_attributes\"),\n  exactProductName: text(\"exact_product_name\"),\n  articleNumber: text(\"article_number\"),\n  manufacturerArticleNumber: text(\"manufacturer_article_number\"),\n  pixiStatus: text(\"pixi_status\"),\n  pixiEan: text(\"pixi_ean\"),\n  pixiCheckedAt: timestamp(\"pixi_checked_at\", { withTimezone: true }),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\nexport const templates = pgTable(\"templates\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  content: text(\"content\").notNull(),\n  isDefault: boolean(\"is_default\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Supplier profiles for web scraping\nexport const suppliers = pgTable(\"suppliers\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  supplNr: text(\"suppl_nr\"),\n  urlPattern: text(\"url_pattern\"),\n  description: text(\"description\"),\n  selectors: jsonb(\"selectors\").notNull(), // JSON object of ScraperSelectors\n  productLinkSelector: text(\"product_link_selector\"),\n  sessionCookies: text(\"session_cookies\"), // Session cookies for authenticated access\n  userAgent: text(\"user_agent\"), // Custom user agent string\n  loginUrl: text(\"login_url\"), // URL to POST credentials to\n  loginUsernameField: text(\"login_username_field\"), // Form field name for username\n  loginPasswordField: text(\"login_password_field\"), // Form field name for password\n  loginUsername: text(\"login_username\"), // Stored username\n  loginPassword: text(\"login_password\"), // Encrypted password\n  verifiedFields: jsonb(\"verified_fields\"), // JSON array of verified field names\n  lastVerifiedAt: timestamp(\"last_verified_at\", { withTimezone: true }),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Temporary scrape session - stores scraped products until new scrape or manual clear\nexport const scrapeSession = pgTable(\"scrape_session\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  scrapedProducts: jsonb(\"scraped_products\").notNull(), // JSON array of ScrapedProduct[]\n  scrapedProduct: jsonb(\"scraped_product\"), // JSON object of single ScrapedProduct\n  generatedDescription: text(\"generated_description\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Backups table for automated database snapshots\nexport const backups = pgTable(\"backups\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  backupType: text(\"backup_type\").notNull(), // 'manual', 'scheduled', 'pre_migration'\n  status: text(\"status\").notNull().default('pending'), // 'pending', 'in_progress', 'completed', 'failed'\n  backupData: jsonb(\"backup_data\").notNull(), // Complete snapshot of tenant data\n  size: integer(\"size\"), // Size in bytes\n  createdBy: uuid(\"created_by\").references(() => users.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  expiresAt: timestamp(\"expires_at\", { withTimezone: true }), // Auto-delete old backups\n  metadata: jsonb(\"metadata\"), // Additional info: table counts, duration, etc.\n});\n\n// Audit log table for RBAC compliance\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  userId: uuid(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  action: text(\"action\").notNull(), // 'create', 'update', 'delete', 'export', 'restore'\n  resourceType: text(\"resource_type\").notNull(), // 'product', 'project', 'supplier', 'user', 'backup'\n  resourceId: text(\"resource_id\"), // UUID of affected resource\n  changes: jsonb(\"changes\"), // Before/after snapshot for updates\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Permissions table for granular RBAC\nexport const permissions = pgTable(\"permissions\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  tenantId: uuid(\"tenant_id\").references(() => tenants.id, { onDelete: \"cascade\" }),\n  resource: text(\"resource\").notNull(), // 'products', 'projects', 'suppliers', 'backups', 'users'\n  action: text(\"action\").notNull(), // 'read', 'create', 'update', 'delete', 'export'\n  scope: text(\"scope\").default('all'), // 'all', 'own', 'team', 'none'\n  conditions: jsonb(\"conditions\"), // Additional constraints (e.g., project_id, status)\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n});\n\n// Relations\nexport const tenantsRelations = relations(tenants, ({ many }) => ({\n  users: many(users),\n  projects: many(projects),\n  products: many(productsInProjects),\n  suppliers: many(suppliers),\n  templates: many(templates),\n  scrapeSessions: many(scrapeSession),\n}));\n\nexport const usersRelations = relations(users, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [users.tenantId],\n    references: [tenants.id],\n  }),\n  projects: many(projects),\n  suppliers: many(suppliers),\n  scrapeSessions: many(scrapeSession),\n}));\n\nexport const projectsRelations = relations(projects, ({ one, many }) => ({\n  user: one(users, {\n    fields: [projects.userId],\n    references: [users.id],\n  }),\n  tenant: one(tenants, {\n    fields: [projects.tenantId],\n    references: [tenants.id],\n  }),\n  products: many(productsInProjects),\n}));\n\nexport const productsInProjectsRelations = relations(productsInProjects, ({ one }) => ({\n  project: one(projects, {\n    fields: [productsInProjects.projectId],\n    references: [projects.id],\n  }),\n  tenant: one(tenants, {\n    fields: [productsInProjects.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const suppliersRelations = relations(suppliers, ({ one }) => ({\n  user: one(users, {\n    fields: [suppliers.userId],\n    references: [users.id],\n  }),\n  tenant: one(tenants, {\n    fields: [suppliers.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const scrapeSessionRelations = relations(scrapeSession, ({ one }) => ({\n  user: one(users, {\n    fields: [scrapeSession.userId],\n    references: [users.id],\n  }),\n  tenant: one(tenants, {\n    fields: [scrapeSession.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\n// HTML Template types for product descriptions\nexport interface ProductImage {\n  dataUrl: string;\n  fileName: string;\n  fileSize: number;\n}\n\nexport interface CreatorProduct {\n  id: string;\n  sku: string;\n  name: string;\n  description: string;\n  brand?: string;\n  images?: ProductImage[];\n  technicalSpecs?: Record<string, string>;\n  features?: string[];\n  advantages?: string[];\n  safetyInfo?: string;\n  packageContents?: string;\n}\n\nexport interface HtmlTemplate {\n  id: string;\n  name: string;\n  description: string;\n  category: string;\n  templateFunction: (product: CreatorProduct) => string;\n}\n\n// Supplier profile schemas\nexport const supplierSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  supplNr: z.string().optional(),\n  urlPattern: z.string().optional(),\n  description: z.string().optional(),\n  selectors: z.record(z.string(), z.string()),\n  productLinkSelector: z.string().optional(),\n  sessionCookies: z.string().optional(),\n  userAgent: z.string().optional(),\n  loginUrl: z.string().optional(),\n  loginUsernameField: z.string().optional(),\n  loginPasswordField: z.string().optional(),\n  loginUsername: z.string().optional(),\n  loginPassword: z.string().optional(),\n  verifiedFields: z.array(z.string()).optional(),\n  lastVerifiedAt: z.string().optional(),\n  createdAt: z.string(),\n  updatedAt: z.string(),\n});\n\nexport type Supplier = z.infer<typeof supplierSchema>;\n\nexport const createSupplierSchema = z.object({\n  name: z.string().min(1, \"Name ist erforderlich\"),\n  supplNr: z.string().optional(),\n  urlPattern: z.string().optional(),\n  description: z.string().optional(),\n  selectors: z.record(z.string(), z.string()).default({}),\n  productLinkSelector: z.string().optional(),\n  sessionCookies: z.string().optional(),\n  userAgent: z.string().optional(),\n  loginUrl: z.string().optional(),\n  loginUsernameField: z.string().optional(),\n  loginPasswordField: z.string().optional(),\n  loginUsername: z.string().optional(),\n  loginPassword: z.string().optional(),\n  verifiedFields: z.array(z.string()).optional(),\n  lastVerifiedAt: z.string().optional(),\n});\n\nexport type CreateSupplier = z.infer<typeof createSupplierSchema>;\n\nexport const updateSupplierSchema = createSupplierSchema.partial();\nexport type UpdateSupplier = z.infer<typeof updateSupplierSchema>;\n\n// Tenant schemas for multi-tenant B2B SaaS (definitions moved above Drizzle tables)\n\n// User schemas for authentication\nexport const userSchema = z.object({\n  id: z.string(),\n  email: z.string().email(),\n  username: z.string().optional(),\n  isAdmin: z.boolean().optional().default(false),\n  tenantId: z.string().optional(),\n  role: z.enum(['admin', 'member']).optional().default('member'),\n  stripeCustomerId: z.string().optional(),\n  subscriptionStatus: z.string().optional(),\n  subscriptionId: z.string().optional(),\n  planId: z.string().optional(),\n  currentPeriodEnd: z.string().optional(),\n  apiCallsUsed: z.number().default(0),\n  apiCallsLimit: z.number().default(500),\n  createdAt: z.string(),\n  updatedAt: z.string(),\n});\n\nexport type User = z.infer<typeof userSchema>;\n\nexport const registerUserSchema = z.object({\n  companyName: z.string().min(2, \"Firmenname muss mindestens 2 Zeichen lang sein\"),\n  email: z.string().email(\"Ungltige E-Mail-Adresse\"),\n  password: z.string().min(8, \"Passwort muss mindestens 8 Zeichen lang sein\"),\n  username: z.string().optional(),\n});\n\nexport type RegisterUser = z.infer<typeof registerUserSchema>;\n\nexport const loginUserSchema = z.object({\n  email: z.string().min(1, \"Benutzername oder E-Mail erforderlich\"), // Accepts username OR email\n  password: z.string().min(1, \"Passwort erforderlich\"),\n});\n\nexport type LoginUser = z.infer<typeof loginUserSchema>;\n\n// Import mapping tables\nexport * from './mapping-schema';\n\n// Drizzle insert schemas\nexport const insertUserSchema = createInsertSchema(users).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertProjectSchema = createInsertSchema(projects).omit({ id: true, createdAt: true });\nexport const insertProductInProjectSchema = createInsertSchema(productsInProjects).omit({ id: true, createdAt: true });\nexport const insertTemplateSchema = createInsertSchema(templates).omit({ id: true, createdAt: true });\nexport const insertSupplierSchema = createInsertSchema(suppliers).omit({ id: true, createdAt: true, updatedAt: true });\n","size_bytes":19761},"DEPLOYMENT.md":{"content":"# CSV Upload App - Render Deployment\r\n\r\n## Deploy to Render\r\n\r\n### 1. Fork this repository\r\nFork this repository to your GitHub account.\r\n\r\n### 2. Create a new Web Service on Render\r\n1. Go to [Render Dashboard](https://dashboard.render.com)\r\n2. Click \"New +\"  \"Web Service\"\r\n3. Connect your GitHub repository\r\n4. Select this repository\r\n\r\n### 3. Configure the service\r\n- **Name**: csv-upload-app (or your preferred name)\r\n- **Environment**: Node\r\n- **Plan**: Free\r\n- **Build Command**: `npm install && npm run build`\r\n- **Start Command**: `npm start`\r\n\r\n### 4. Environment Variables\r\nAdd these environment variables in Render dashboard:\r\n\r\n- `NODE_ENV`: `production`\r\n- `DATABASE_URL`: Will be provided by Render PostgreSQL database\r\n- `AI_INTEGRATIONS_OPENAI_API_KEY`: Your OpenAI API key\r\n- `AI_INTEGRATIONS_OPENAI_BASE_URL`: `https://api.openai.com/v1`\r\n\r\n### 5. Create PostgreSQL Database\r\n1. In Render dashboard, click \"New +\"  \"PostgreSQL\"\r\n2. Name it: `csv-upload-db`\r\n3. Plan: Free\r\n4. Copy the connection string to `DATABASE_URL` environment variable\r\n\r\n### 6. Deploy\r\nClick \"Create Web Service\" and wait for deployment to complete.\r\n\r\n## Features\r\n-  CSV file upload and analysis\r\n-  AI-powered product description generation\r\n-  Custom attributes management\r\n-  Project management\r\n-  Clean data extraction (no ** formatting, no units)\r\n\r\n## Local Development\r\n```bash\r\nnpm install\r\nnpm run dev\r\n```\r\n\r\n## Production Build\r\n```bash\r\nnpm run build\r\nnpm start\r\n```\r\n","size_bytes":1496},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"TECHNICAL-FAQ.md":{"content":"# Technische FAQ fr IT-Abteilung\r\n\r\n##  Architektur & Technologie\r\n\r\n### **Q: Welche Programmiersprachen werden verwendet?**\r\nA: \r\n- **Frontend**: TypeScript + React\r\n- **Backend**: TypeScript + Node.js\r\n- **Datenbank**: SQL (SQLite/PostgreSQL)\r\n- **Build**: JavaScript (Vite, tsx)\r\n\r\n### **Q: Welche Frameworks und Bibliotheken werden genutzt?**\r\nA:\r\n- **Frontend**: React 18, Tailwind CSS, shadcn/ui, React Query\r\n- **Backend**: Express.js, Prisma ORM, Multer (File Upload)\r\n- **AI**: OpenAI SDK, Tesseract.js (OCR)\r\n- **Scraping**: Firecrawl API, Cheerio (HTML Parser)\r\n\r\n### **Q: Wie ist die App strukturiert?**\r\nA:\r\n```\r\nCodeCSVUpload/\r\n client/          # React Frontend\r\n server/          # Node.js Backend\r\n shared/          # Gemeinsame TypeScript Types\r\n local.db         # SQLite Datenbank\r\n package.json     # Dependencies\r\n```\r\n\r\n##  Entwicklung & Deployment\r\n\r\n### **Q: Wie starte ich die App lokal?**\r\nA:\r\n```bash\r\nnpm install          # Dependencies installieren\r\nnpm run dev         # Development Server starten\r\n# Frontend: http://localhost:3000\r\n# Backend: http://localhost:5000\r\n```\r\n\r\n### **Q: Wie baue ich die App fr Production?**\r\nA:\r\n```bash\r\nnpm run build       # Frontend Build\r\nnpm start          # Production Server\r\n```\r\n\r\n### **Q: Welche Umgebungsvariablen brauche ich?**\r\nA:\r\n```env\r\nOPENAI_API_KEY=sk-...           # OpenAI API Key\r\nFIRECRAWL_API_KEY=fc-...        # Firecrawl API Key\r\nPORT=5000                       # Server Port\r\nNODE_ENV=production             # Environment\r\n```\r\n\r\n##  Datenbank & Storage\r\n\r\n### **Q: Welche Datenbank wird verwendet?**\r\nA: \r\n- **Development**: SQLite (lokale Datei)\r\n- **Production**: PostgreSQL (empfohlen)\r\n- **ORM**: Prisma fr Type-safe Queries\r\n\r\n### **Q: Wie funktioniert die Datenmigration?**\r\nA:\r\n```bash\r\nnpx prisma migrate dev    # Development Migration\r\nnpx prisma migrate deploy # Production Migration\r\nnpx prisma generate      # Client generieren\r\n```\r\n\r\n### **Q: Wo werden Upload-Dateien gespeichert?**\r\nA: Temporr im `uploads/` Ordner, werden nach Verarbeitung gelscht.\r\n\r\n##  Sicherheit & API-Keys\r\n\r\n### **Q: Wie werden API-Keys gespeichert?**\r\nA: \r\n- Verschlsselt mit AES-256\r\n- Lokale Speicherung in `api-keys.json`\r\n- Keine Hardcoded Keys im Code\r\n\r\n### **Q: Wie verschlssele ich neue API-Keys?**\r\nA:\r\n```bash\r\nnode encrypt-keys.js\r\n# Eingabe: Plaintext API Key\r\n# Ausgabe: Verschlsselter Key fr .env\r\n```\r\n\r\n### **Q: Welche Sicherheitsmanahmen gibt es?**\r\nA:\r\n- Input Validation (Zod Schemas)\r\n- File Type Validation\r\n- Rate Limiting\r\n- CORS Protection\r\n- SQL Injection Prevention (Prisma)\r\n\r\n##  Netzwerk & APIs\r\n\r\n### **Q: Welche externen APIs werden verwendet?**\r\nA:\r\n- **OpenAI API**: GPT-4o fr Textgenerierung\r\n- **Firecrawl API**: Web-Scraping\r\n- **Tesseract.js**: Lokale OCR (kein API)\r\n\r\n### **Q: Wie funktioniert das Web-Scraping?**\r\nA:\r\n1. **Primary**: Firecrawl API (professionell)\r\n2. **Fallback**: Direkter Fetch mit User-Agent\r\n3. **Fallback**: Googlebot User-Agent\r\n4. **Error Handling**: Detaillierte Fehlermeldungen\r\n\r\n### **Q: Welche Ports werden verwendet?**\r\nA:\r\n- **Frontend**: 3000 (Development)\r\n- **Backend**: 5000 (Development/Production)\r\n- **Database**: 5432 (PostgreSQL) oder lokale SQLite\r\n\r\n##  Performance & Monitoring\r\n\r\n### **Q: Wie berwache ich die App-Performance?**\r\nA:\r\n- **Logs**: Strukturierte Logs mit Winston\r\n- **Metrics**: Response Times, Error Rates\r\n- **Database**: Query Performance mit Prisma\r\n- **Memory**: Node.js Memory Usage\r\n\r\n### **Q: Wie skaliere ich die App?**\r\nA:\r\n- **Horizontal**: Load Balancer + mehrere Instanzen\r\n- **Vertical**: Mehr RAM/CPU fr grere Dateien\r\n- **Database**: PostgreSQL fr mehr Concurrent Users\r\n- **Caching**: Redis fr hufige Queries\r\n\r\n### **Q: Welche Performance-Limits gibt es?**\r\nA:\r\n- **File Size**: 50MB pro Upload\r\n- **Concurrent Users**: 10-20 (SQLite), 100+ (PostgreSQL)\r\n- **API Rate Limits**: OpenAI/Firecrawl Limits\r\n- **Memory**: ~500MB pro Instanz\r\n\r\n##  Integration & APIs\r\n\r\n### **Q: Welche REST API Endpoints gibt es?**\r\nA:\r\n```\r\nPOST /api/analyze-files        # File Upload & Analysis\r\nPOST /api/scrape-url           # URL Scraping\r\nPOST /api/generate-description # AI Description Generation\r\nGET  /api/projects             # Project Management\r\nPOST /api/projects             # Create Project\r\nPUT  /api/projects/:id         # Update Project\r\nDELETE /api/projects/:id       # Delete Project\r\n```\r\n\r\n### **Q: Wie integriere ich die App in bestehende Systeme?**\r\nA:\r\n- **REST API**: Standard HTTP Endpoints\r\n- **Webhooks**: Fr Event-basierte Integration\r\n- **Export**: CSV/JSON fr Shop-Systeme\r\n- **Import**: CSV fr Bulk-Operations\r\n\r\n### **Q: Kann ich die App als Microservice verwenden?**\r\nA: Ja, die App ist bereits als Microservice designed:\r\n- Stateless Backend\r\n- Externe Datenbank\r\n- API-first Architecture\r\n- Container-ready (Dockerfile vorhanden)\r\n\r\n##  Container & Deployment\r\n\r\n### **Q: Wie containerisiere ich die App?**\r\nA:\r\n```dockerfile\r\n# Dockerfile ist vorhanden\r\ndocker build -t codecsvupload .\r\ndocker run -p 5000:5000 codecsvupload\r\n```\r\n\r\n### **Q: Welche Deployment-Optionen gibt es?**\r\nA:\r\n- **Docker**: Lokal oder auf Server\r\n- **Kubernetes**: Fr groe Deployments\r\n- **Cloud**: Railway, Render, Heroku\r\n- **On-Premise**: Windows/Linux Server\r\n\r\n### **Q: Wie konfiguriere ich die App fr Production?**\r\nA:\r\n```env\r\nNODE_ENV=production\r\nPORT=5000\r\nDATABASE_URL=postgresql://...\r\nOPENAI_API_KEY=sk-...\r\nFIRECRAWL_API_KEY=fc-...\r\n```\r\n\r\n##  Wartung & Updates\r\n\r\n### **Q: Wie aktualisiere ich die App?**\r\nA:\r\n```bash\r\ngit pull origin main           # Code Updates\r\nnpm install                   # Dependencies\r\nnpx prisma migrate deploy    # Database Updates\r\nnpm run build                # Frontend Build\r\npm2 restart all              # Server Restart\r\n```\r\n\r\n### **Q: Wie backup ich die Datenbank?**\r\nA:\r\n```bash\r\n# SQLite\r\ncp local.db backup-$(date +%Y%m%d).db\r\n\r\n# PostgreSQL\r\npg_dump -h localhost -U user -d database > backup.sql\r\n```\r\n\r\n### **Q: Wie berwache ich die App-Logs?**\r\nA:\r\n```bash\r\n# PM2 Logs\r\npm2 logs codecsvupload\r\n\r\n# Docker Logs\r\ndocker logs -f codecsvupload\r\n\r\n# File Logs\r\ntail -f logs/app.log\r\n```\r\n\r\n##  Troubleshooting\r\n\r\n### **Q: Die App startet nicht - was tun?**\r\nA:\r\n1. **Port bereits belegt**: `netstat -ano | findstr :5000`\r\n2. **Dependencies fehlen**: `npm install`\r\n3. **API Keys fehlen**: `.env` Datei prfen\r\n4. **Database Error**: `npx prisma migrate dev`\r\n\r\n### **Q: Upload funktioniert nicht - was ist das Problem?**\r\nA:\r\n1. **File Size Limit**: Max 50MB\r\n2. **File Type**: Nur PDF, CSV, PNG, JPG\r\n3. **Disk Space**: Uploads Ordner prfen\r\n4. **Permissions**: Schreibrechte prfen\r\n\r\n### **Q: KI-Generierung funktioniert nicht - warum?**\r\nA:\r\n1. **API Key**: OpenAI Key prfen\r\n2. **Rate Limits**: OpenAI Limits erreicht\r\n3. **Network**: Internetverbindung prfen\r\n4. **Content**: Zu wenig Produktdaten\r\n\r\n##  Monitoring & Alerting\r\n\r\n### **Q: Wie setze ich Monitoring auf?**\r\nA:\r\n- **Uptime**: UptimeRobot oder Pingdom\r\n- **Logs**: ELK Stack oder CloudWatch\r\n- **Metrics**: Prometheus + Grafana\r\n- **Alerts**: Slack/Email bei Fehlern\r\n\r\n### **Q: Welche Metriken sollte ich berwachen?**\r\nA:\r\n- **Response Time**: < 2 Sekunden\r\n- **Error Rate**: < 1%\r\n- **Memory Usage**: < 80%\r\n- **Disk Space**: < 80%\r\n- **API Rate Limits**: OpenAI/Firecrawl\r\n\r\n##  Security Best Practices\r\n\r\n### **Q: Wie sichere ich die App ab?**\r\nA:\r\n- **HTTPS**: SSL/TLS Zertifikate\r\n- **Firewall**: Nur notwendige Ports ffnen\r\n- **Updates**: Regelmige Security Updates\r\n- **Backups**: Automatische Datensicherung\r\n- **Monitoring**: Security Event Logging\r\n\r\n### **Q: Wie teste ich die App-Sicherheit?**\r\nA:\r\n- **Penetration Testing**: OWASP ZAP\r\n- **Dependency Scanning**: `npm audit`\r\n- **Code Analysis**: SonarQube\r\n- **Security Headers**: Helmet.js\r\n","size_bytes":7931},"server/templates/types.ts":{"content":"export interface ProductCopyPayload {\n  narrative: string;\n  uspBullets: string[];\n  technicalSpecs: Record<string, string>;\n  safetyNotice?: string;\n  packageContents?: string;\n  productHighlights?: string[];\n}\n\nexport interface GenerateDescriptionInput {\n  extractedData: any;\n  categoryId: string;\n  layoutId?: string;\n  customAttributes?: {\n    exactProductName?: string;\n    articleNumber?: string;\n    customAttributes?: Array<{key: string, value: string, type: string}>;\n  };\n}\n","size_bytes":485},"server/templates/ai-generator.ts":{"content":"import OpenAI from 'openai';\nimport { ProductCopyPayload } from './types';\nimport { ProductCategoryConfig } from './category-config';\nimport { createOrchestrator } from '../prompts/orchestrator';\nimport type { PromptContext } from '../prompts/types';\nimport { processProductCopy } from './post-processor';\nimport { extractTechSpecs1to1 } from './tech-spec-parser';\n\nexport async function generateProductCopy(\n  productData: any,\n  categoryConfig: ProductCategoryConfig,\n  openaiKey: string,\n  openaiBaseUrl?: string,\n  model: string = 'gpt-4o-mini', // COST OPTIMIZATION: 30 gnstiger!\n  useModularPrompts: boolean = true\n): Promise<ProductCopyPayload> {\n  if (useModularPrompts || categoryConfig.subpromptPreferences?.useModularPrompts) {\n    return await generateProductCopyModular(productData, categoryConfig, openaiKey, openaiBaseUrl, model);\n  } else {\n    return await generateProductCopyMonolithic(productData, categoryConfig, openaiKey, openaiBaseUrl, model);\n  }\n}\n\nasync function generateProductCopyModular(\n  productData: any,\n  categoryConfig: ProductCategoryConfig,\n  openaiKey: string,\n  openaiBaseUrl?: string,\n  model: string = 'gpt-4o-mini'\n): Promise<ProductCopyPayload> {\n  console.log(` Using MODULAR subprompt architecture with ${model}`);\n\n  const orchestrator = createOrchestrator({\n    openaiKey,\n    openaiBaseUrl,\n    model, // Pass model to orchestrator\n  });\n\n  const context: PromptContext = {\n    categoryName: categoryConfig.name,\n    categoryDescription: categoryConfig.description,\n    productData,\n    availableFields: categoryConfig.technicalFields.map(f => \n      `${f.label}${f.unit ? ` (${f.unit})` : ''}`\n    ),\n    uspTemplates: categoryConfig.uspTemplates,\n  };\n\n  try {\n    const result = await orchestrator.generateFullProductCopy(context);\n\n    // POST-PROCESSING: Validiere und bereinige AI-Output\n    const processed = processProductCopy({\n      narrative: result.narrative,\n      uspBullets: result.uspBullets,\n    });\n\n    if (processed.validationIssues.length > 0) {\n      console.log(' Post-processing applied:', processed.validationIssues);\n    }\n\n    // 1:1 TECH SPECS EXTRAKTION: Aus Vision-Text oder strukturierten Daten\n    const directTechSpecs = extractTechSpecs1to1(\n      productData.extractedText || '',\n      productData.structuredData || productData,\n      categoryConfig\n    );\n    \n    // Wenn direkte Extraktion erfolgreich war, nutze diese (berschreibt AI)\n    const mergedTechSpecs = {\n      ...result.technicalSpecs,      // AI-generierte Specs (Fallback)\n      ...directTechSpecs,             // 1:1 extrahierte Specs (berschreiben AI)\n    };\n\n    console.log(` Tech Specs: ${Object.keys(mergedTechSpecs).length} total (${Object.keys(directTechSpecs).length} direct 1:1, ${Object.keys(result.technicalSpecs).length} AI fallback)`);\n\n    return {\n      narrative: processed.narrative,\n      uspBullets: processed.uspBullets.length >= 5 \n        ? processed.uspBullets.slice(0, 5)\n        : [...processed.uspBullets, ...categoryConfig.uspTemplates].slice(0, 5),\n      technicalSpecs: mergedTechSpecs,\n      safetyNotice: result.safetyNotice || categoryConfig.safetyNotice,\n      packageContents: result.packageContents,\n      productHighlights: categoryConfig.productHighlights.slice(0, 5),\n    };\n  } catch (error) {\n    console.error('Modular generation failed, using fallback:', error);\n    return getFallbackCopy(categoryConfig);\n  }\n}\n\nfunction extractSupplierTechnicalData(\n  productData: any,\n  categoryConfig: ProductCategoryConfig\n): Record<string, string> {\n  const extracted: Record<string, string> = {};\n  \n  // Prfe auf strukturierte CSV/Excel-Daten\n  if (productData.technicalData || productData.technicalSpecs || productData.specs) {\n    const source = productData.technicalData || productData.technicalSpecs || productData.specs;\n    \n    for (const field of categoryConfig.technicalFields) {\n      const value = source[field.label] || source[field.key];\n      if (value && value !== 'Nicht angegeben' && value !== 'Nicht sichtbar') {\n        extracted[field.label] = value;\n        console.log(` 1:1 bernahme: ${field.label} = ${value}`);\n      }\n    }\n  }\n  \n  // Prfe auf direkte Felder im productData (z.B. von CSV-Import)\n  for (const field of categoryConfig.technicalFields) {\n    if (!extracted[field.label]) {\n      const value = productData[field.label] || productData[field.key];\n      if (value && value !== 'Nicht angegeben' && value !== 'Nicht sichtbar') {\n        extracted[field.label] = value;\n        console.log(` 1:1 bernahme: ${field.label} = ${value}`);\n      }\n    }\n  }\n  \n  return extracted;\n}\n\nasync function generateProductCopyMonolithic(\n  productData: any,\n  categoryConfig: ProductCategoryConfig,\n  openaiKey: string,\n  openaiBaseUrl?: string,\n  model: string = 'gpt-4o-mini'\n): Promise<ProductCopyPayload> {\n  console.log(` Using MONOLITHIC prompt (legacy) with ${model}`);\n\n  const openai = new OpenAI({\n    apiKey: openaiKey,\n    baseURL: openaiBaseUrl,\n  });\n\n  const systemPrompt = `Du bist ein Produkttext-Experte fr Online-Shops.\n\nPRODUKTKATEGORIE: ${categoryConfig.name}\n${categoryConfig.description}\n\nWICHTIGE TECHNISCHE FELDER FR DIESE KATEGORIE:\n${categoryConfig.technicalFields.map(field => \n  `- ${field.label}${field.unit ? ` (${field.unit})` : ''} ${field.required ? '[wichtig]' : '[optional]'}`\n).join('\\n')}\n\nVERFGBARE USP-VORSCHLGE (whle passende aus oder erstelle hnliche):\n${categoryConfig.uspTemplates.map((usp, i) => `${i + 1}. ${usp}`).join('\\n')}\n\nDEINE AUFGABE:\nAnalysiere die gegebenen Produktdaten und erstelle ein JSON-Objekt mit folgender Struktur:\n\n{\n  \"narrative\": \"Eine professionelle Produktbeschreibung in 4-5 Stzen, die die Hauptvorteile und Einsatzmglichkeiten beschreibt\",\n  \"uspBullets\": [\n    \"5 verkaufsfrdernde USP-Bulletpoints\",\n    \"Verwende die Vorschlge oder erstelle hnliche\",\n    \"KEINE technischen Daten wie Spannung, Gewicht, Mae!\",\n    \"Fokus auf Vorteile fr den Kunden\",\n    \"...\"\n  ],\n  \"technicalSpecs\": {\n    \"Feldname\": \"Wert (nur Felder, die tatschlich in den Daten vorhanden sind)\"\n  },\n  \"packageContents\": \"Was ist im Lieferumfang enthalten\",\n  \"productHighlights\": [\n    \"Produktspezifisches Highlight 1 (max. 8-10 Wrter)\",\n    \"Produktspezifisches Highlight 2\",\n    \"Produktspezifisches Highlight 3\",\n    \"Produktspezifisches Highlight 4\"\n  ]\n}\n\nPRODUKTHIGHLIGHTS erstellen (hnlich wie USPs, aber krzer):\nSTIL-BEISPIELE fr Akku-Highlights:\n- \"Hochwertige Lithium-Ionen-Zelle fr konstante Leistung\"\n- \"Mehrfachschutz vor berladung, Kurzschluss und Tiefentladung\"\n- \"Geringe Selbstentladung  ideal fr Langzeitlagerung\"\n\nWICHTIG: Basierend auf echten Produktdaten, nicht generisch!\n\nKRITISCHE REGELN:\n1. Verwende NUR Informationen, die in den Produktdaten tatschlich vorhanden sind\n2. Wenn ein Feld nicht vorhanden ist  lass es komplett weg (kein \"Nicht angegeben\")\n3. USP-Bulletpoints MSSEN verkaufsfrdernd sein (KEINE nackten technischen Daten!)\n4. Technische Daten gehren in \"technicalSpecs\", NICHT in \"uspBullets\"\n5. Verwende die Feld-Labels aus der Liste oben fr technicalSpecs\n6. Gib NUR valides JSON zurck, ohne Markdown-Formatierung\n7. Der Produktname wird separat behandelt - schreibe ihn NICHT in die narrative\n\nBEISPIEL FR GUTE USPs:\n \"Wiederaufladbar - spart langfristig Kosten\"\n \"Integrierte Schutzschaltung - maximale Sicherheit\"\n \"Langlebige Technologie - zuverlssig im Dauereinsatz\"\n\nBEISPIEL FR SCHLECHTE USPs:\n \"3,6 V Spannung\" (technisches Datum)\n \"Gewicht: 184 g\" (technisches Datum)\n \"Abmessungen: 7037.537.5 mm\" (technisches Datum)`;\n\n  const userPrompt = `Produktdaten:\n${JSON.stringify(productData, null, 2)}\n\nErstelle jetzt das JSON-Objekt mit Produkttexten basierend auf diesen Daten.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model, // COST OPTIMIZATION: Use GPT-4o-mini by default (30 gnstiger!)\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: userPrompt }\n      ],\n      temperature: 0.3,\n      response_format: { type: 'json_object' },\n    });\n\n    const content = response.choices[0]?.message?.content?.trim() || '{}';\n    let parsedContent: ProductCopyPayload;\n\n    try {\n      parsedContent = JSON.parse(content);\n    } catch (parseError) {\n      console.error('Failed to parse AI response as JSON:', content);\n      throw new Error('AI returned invalid JSON');\n    }\n\n    return {\n      narrative: parsedContent.narrative || '',\n      uspBullets: parsedContent.uspBullets || [],\n      technicalSpecs: parsedContent.technicalSpecs || {},\n      safetyNotice: parsedContent.safetyNotice,\n      packageContents: parsedContent.packageContents,\n      productHighlights: parsedContent.productHighlights,\n    };\n\n  } catch (error) {\n    console.error('AI generation error:', error);\n    return getFallbackCopy(categoryConfig);\n  }\n}\n\nfunction getFallbackCopy(categoryConfig: ProductCategoryConfig): ProductCopyPayload {\n  return {\n    narrative: 'Hochwertiges Produkt fr professionelle Anwendungen. Zeichnet sich durch zuverlssige Leistung und langlebige Qualitt aus.',\n    uspBullets: categoryConfig.uspTemplates.slice(0, 5),\n    technicalSpecs: {},\n    packageContents: 'Produkt wie beschrieben',\n    productHighlights: categoryConfig.productHighlights.slice(0, 5),\n  };\n}\n","size_bytes":9397},"server/templates/renderer.ts":{"content":"import { ProductCopyPayload } from './types';\nimport { ProductCategoryConfig, TechnicalField } from './category-config';\n\nexport interface RenderOptions {\n  productName: string;\n  categoryConfig: ProductCategoryConfig;\n  copy: ProductCopyPayload;\n  layoutStyle?: 'mediamarkt' | 'minimal' | 'detailed';\n  technicalDataTable?: string; // Original HTML table from supplier website\n  safetyWarnings?: string; // 1:1 safety warnings from supplier (without icons)\n  pdfManualUrl?: string; // PDF manual URL for reference\n}\n\nfunction cleanMarkdown(text: string): string {\n  if (!text) return text;\n  \n  let cleaned = text;\n  \n  // Entferne \"- **\" am Anfang\n  cleaned = cleaned.replace(/^-\\s*\\*\\*/gm, '');\n  \n  // Entferne alle ** (bold markers)\n  cleaned = cleaned.replace(/\\*\\*/g, '');\n  \n  // Entferne alle * (italic markers)\n  cleaned = cleaned.replace(/\\*/g, '');\n  \n  // Entferne fhrende/folgende Leerzeichen\n  cleaned = cleaned.trim();\n  \n  return cleaned;\n}\n\nexport function renderProductHtml(options: RenderOptions): string {\n  const { productName, categoryConfig, copy, layoutStyle = 'mediamarkt', technicalDataTable, safetyWarnings, pdfManualUrl } = options;\n  \n  const cleanProductName = cleanMarkdown(productName);\n\n  // USE AI-GENERATED SAFETY WARNINGS (based on supplier warnings if available)\n  const safetyNotice = cleanMarkdown(copy.safetyNotice || categoryConfig.safetyNotice);\n  const packageContents = cleanMarkdown(copy.packageContents || 'Produkt wie beschrieben');\n\n  // Use original HTML table if available, otherwise build from specs\n  const technicalSpecs = buildTechnicalSpecsTable(\n    copy.technicalSpecs,\n    categoryConfig.technicalFields\n  );\n\n  const cleanNarrative = cleanMarkdown(copy.narrative);\n  const uspBullets = copy.uspBullets.map(usp => cleanMarkdown(usp)).slice(0, 5);\n  while (uspBullets.length < 5) {\n    const remainingTemplates = categoryConfig.uspTemplates.filter(\n      template => !uspBullets.includes(template)\n    );\n    if (remainingTemplates.length > 0) {\n      uspBullets.push(remainingTemplates[0]);\n    } else {\n      break;\n    }\n  }\n\n  if (layoutStyle === 'mediamarkt') {\n    return renderMediaMarktLayout({\n      productName: cleanProductName,\n      narrative: cleanNarrative,\n      uspBullets,\n      technicalSpecs,\n      safetyNotice,\n      packageContents,\n      technicalDataTable, // Pass original HTML table\n      pdfManualUrl, // Pass PDF URL for reference\n    });\n  }\n\n  return renderMediaMarktLayout({\n    productName: cleanProductName,\n    narrative: cleanNarrative,\n    uspBullets,\n    technicalSpecs,\n    safetyNotice,\n    packageContents,\n    technicalDataTable, // Pass original HTML table\n    pdfManualUrl, // Pass PDF URL for reference\n  });\n}\n\nfunction buildTechnicalSpecsTable(\n  specs: Record<string, string>,\n  fields: TechnicalField[]\n): Array<{label: string, value: string}> {\n  const result: Array<{label: string, value: string}> = [];\n\n  // 1:1 BERNAHME: Alle Felder aus specs bernehmen (nicht nur vordefinierte!)\n  for (const [label, value] of Object.entries(specs)) {\n    if (value && value !== 'Nicht angegeben' && value !== 'Nicht sichtbar' && value !== '-') {\n      result.push({\n        label: label,\n        value: cleanMarkdown(value)\n      });\n    }\n  }\n\n  // Falls keine Specs vorhanden, fge required Felder mit Fallbacks hinzu\n  if (result.length === 0) {\n    for (const field of fields) {\n      if (field.required && field.fallback) {\n        result.push({\n          label: field.label,\n          value: cleanMarkdown(field.fallback)\n        });\n      }\n    }\n  }\n\n  console.log(` Technische Daten: ${result.length} Felder 1:1 bernommen`);\n  return result;\n}\n\nfunction cleanTechnicalTable(htmlTable: string): string {\n  // Remove wrapper divs and clean up the table for left-aligned display\n  let cleaned = htmlTable;\n  \n  // Remove wrapper divs\n  cleaned = cleaned.replace(/<div[^>]*class=\"[^\"]*additional-attributes-wrapper[^\"]*\"[^>]*>/gi, '');\n  cleaned = cleaned.replace(/<\\/div>/gi, '');\n  \n  // Remove caption\n  cleaned = cleaned.replace(/<caption[^>]*>.*?<\\/caption>/gi, '');\n  \n  // Remove all class attributes from table, tr, th, td\n  cleaned = cleaned.replace(/\\s+class=\"[^\"]*\"/gi, '');\n  cleaned = cleaned.replace(/\\s+id=\"[^\"]*\"/gi, '');\n  cleaned = cleaned.replace(/\\s+data-th=\"[^\"]*\"/gi, '');\n  cleaned = cleaned.replace(/\\s+scope=\"[^\"]*\"/gi, '');\n  \n  // Add left-aligned inline styles to table\n  cleaned = cleaned.replace(/<table/gi, '<table border=\"0\" style=\"border-collapse: collapse; width: 100%; max-width: 600px;\"');\n  \n  // Make both th and td left-aligned with proper padding\n  cleaned = cleaned.replace(/<th/gi, '<th style=\"padding: 4px 12px 4px 0; text-align: left; vertical-align: top; font-weight: 600;\"');\n  cleaned = cleaned.replace(/<td/gi, '<td style=\"padding: 4px 0 4px 0; text-align: left; vertical-align: top;\"');\n  \n  return cleaned.trim();\n}\n\nfunction renderMediaMarktLayout(data: {\n  productName: string;\n  narrative: string;\n  uspBullets: string[];\n  technicalSpecs: Array<{label: string, value: string}>;\n  safetyNotice: string;\n  packageContents: string;\n  technicalDataTable?: string; // Original HTML table from supplier\n  pdfManualUrl?: string; // PDF manual URL for reference\n}): string {\n  const uspHtml = data.uspBullets\n    .map(usp => ` ${usp}`)\n    .join('<br />\\n');\n\n  //  PRIORITY: Use original HTML table from supplier if available (1:1), otherwise build from AI specs\n  const techTableHtml = data.technicalDataTable\n    ? `<h4>Technische Daten:</h4>\n${cleanTechnicalTable(data.technicalDataTable)}\n\n`\n    : data.technicalSpecs.length > 0\n    ? `<h4>Technische Daten:</h4>\n<table border=\"0\" summary=\"\" style=\"border-collapse: collapse; width: 100%; max-width: 600px;\">\n<tbody>\n${data.technicalSpecs.map(spec => `<tr>\n  <td style=\"padding: 4px 12px 4px 0; text-align: left; vertical-align: top; font-weight: 600;\">${spec.label}</td>\n  <td style=\"padding: 4px 0 4px 8px; text-align: left; vertical-align: top;\">${spec.value}</td>\n</tr>`).join('\\n')}\n</tbody>\n</table>\n\n`\n    : '';\n\n  // 1:1 SICHERHEITSHINWEISE: Entferne nur Icons, bernehme Text unverndert\n  const safetyHtml = data.safetyNotice \n    ? `<h3>Sicherheitshinweise</h3>\n<p>${data.safetyNotice.replace(//g, '').replace(/[]/g, '').trim()}</p>\n\n`\n    : '';\n\n  // PDF-Hinweis (optional, falls vorhanden)\n  const pdfHtml = data.pdfManualUrl\n    ? `<p><strong> Bedienungsanleitung:</strong> <a href=\"${data.pdfManualUrl}\" target=\"_blank\">Download PDF</a></p>\n\n`\n    : '';\n\n  return `<h2>${data.productName}</h2>\n<p>${data.narrative}</p>\n<br />\n\n<p>${uspHtml}</p>\n<br />\n\n${techTableHtml}${techTableHtml ? '<br />\\n' : ''}${safetyHtml}${safetyHtml ? '<br />\\n' : ''}${pdfHtml}${pdfHtml ? '<br />\\n' : ''}<h3>Lieferumfang</h3>\n<p>${data.packageContents}</p>`;\n}\n","size_bytes":6805},"server/templates/category-config.ts":{"content":"export interface TechnicalField {\n  key: string;\n  label: string;\n  unit?: string;\n  required: boolean;\n  fallback?: string;\n}\n\nexport interface SubpromptPreferences {\n  useModularPrompts?: boolean;\n  customUSPStyle?: 'benefits' | 'features' | 'mixed';\n  safetyLevel?: 'standard' | 'detailed' | 'minimal';\n}\n\nexport interface ProductCategoryConfig {\n  id: string;\n  name: string;\n  description: string;\n  keywords: string[];\n  technicalFields: TechnicalField[];\n  uspTemplates: string[];\n  safetyNotice: string;\n  productHighlights: string[];\n  subpromptPreferences?: SubpromptPreferences;\n}\n\nexport const PRODUCT_CATEGORIES: Record<string, ProductCategoryConfig> = {\n  flashlight: {\n    id: 'flashlight',\n    name: 'Taschenlampe',\n    description: 'LED-Taschenlampen und Stirnlampen',\n    keywords: ['taschenlampe', 'flashlight', 'torch', 'lampe', 'lumen', 'led', 'licht', 'leuchtweite', 'chameleon', 'nitecore', 'stirnlampe', 'headlamp'],\n    technicalFields: [\n      { key: 'led1', label: 'LED Weilicht', required: false },\n      { key: 'led2', label: 'LED Farblicht', required: false },\n      { key: 'maxLuminosity', label: 'Max. Helligkeit', unit: 'Lumen', required: true, fallback: 'Nicht angegeben' },\n      { key: 'spotIntensity', label: 'Spot-Intensitt', unit: 'cd', required: false },\n      { key: 'maxBeamDistance', label: 'Max. Leuchtweite', unit: 'm', required: false },\n      { key: 'powerSupply', label: 'Stromversorgung', required: false },\n      { key: 'length', label: 'Lnge', unit: 'mm', required: false },\n      { key: 'bodyDiameter', label: 'Krperdurchmesser', unit: 'mm', required: false },\n      { key: 'headDiameter', label: 'Kopfdurchmesser', unit: 'mm', required: false },\n      { key: 'weightWithoutBattery', label: 'Gewicht ohne Akku', unit: 'g', required: false },\n      { key: 'waterResistance', label: 'Wasserdichtigkeit', required: false },\n      { key: 'impactResistance', label: 'Stofestigkeit', required: false },\n    ],\n    uspTemplates: [\n      'Extrem leistungsstark - ideal fr Outdoor, Camping und professionellen Einsatz',\n      'Mehrfarbige LEDs - vielseitig einsetzbar fr verschiedene Anwendungen',\n      'Robustes Aluminiumgehuse - stofest und wetterfest',\n      'Lange Leuchtdauer - dank effizienter LED-Technologie',\n      'Mehrere Leuchtmodi - anpassbar an jede Situation',\n      'Kompakt und handlich - perfekt fr unterwegs',\n      'Wiederaufladbar - umweltfreundlich und kosteneffizient',\n    ],\n    safetyNotice: ' Nicht direkt in die Augen leuchten. Vor Wasser schtzen (auer bei wasserdichten Modellen). Akkus nur mit geeigneten Ladegerten laden. Von Kindern fernhalten.',\n    productHighlights: [\n      'Hochwertige LED-Technologie fr maximale Helligkeit',\n      'Langlebiges Aluminiumgehuse fr jahrelangen Einsatz',\n      'Vielseitige Leuchtmodi fr jeden Einsatzzweck',\n      'Kompakte Bauweise - ideal fr unterwegs',\n      'Hervorragendes Preis-Leistungs-Verhltnis',\n    ],\n  },\n\n  battery: {\n    id: 'battery',\n    name: 'Akku/Batterie',\n    description: 'Wiederaufladbare Akkus und Einwegbatterien',\n    keywords: ['akku', 'batterie', 'battery', 'li-ion', 'lithium', 'nimh', 'nicd', 'mah', 'wh'],\n    technicalFields: [\n      // Mapping-Definitionen fr konsistente Labels (dynamische Tabelle zeigt alle gefundenen Specs)\n      { key: 'model', label: 'Modell', required: false },\n      { key: 'type', label: 'Typ', required: false },\n      { key: 'capacity', label: 'Kapazitt', required: false },\n      { key: 'voltage', label: 'Spannung', required: false },\n      { key: 'chemistry', label: 'Technologie', required: false },\n      { key: 'chargingMethod', label: 'Ladeverfahren', required: false },\n      { key: 'maxChargeCurrent', label: 'Max. Ladestrom', required: false },\n      { key: 'maxDischargeCurrent', label: 'Max. Entladestrom', required: false },\n      { key: 'current', label: 'Stromstrke', required: false },\n      { key: 'dimensions', label: 'Mae', required: false },\n      { key: 'abmessungen', label: 'Abmessungen', required: false },\n      { key: 'weight', label: 'Gewicht', required: false },\n      { key: 'protection', label: 'Schutzschaltung', required: false },\n      { key: 'features', label: 'Besonderheiten', required: false },\n    ],\n    uspTemplates: [\n      'Integrierte BMS-Schutzelektronik fr maximale Zellensicherheit',\n      'Kompatibel mit Gerten, die CR123A Primrzellen nutzen  wiederaufladbare Alternative',\n      'Hervorragende Spannungsstabilitt auch bei hoher Belastung',\n      'Qualittszelle mit langer Lebensdauer  ideal fr Dauerbetrieb',\n      'Entwickelt fr professionelle Anwendungen (z. B. Taschenlampen, Messgerte, Fotoausrstung)',\n      'Kein Memory-Effekt - jederzeit nachladbar ohne Kapazittsverlust',\n      'Geringe Selbstentladung  optimal fr Langzeitlagerung',\n    ],\n    safetyNotice: ' Nicht ins Feuer werfen oder erhitzen. Vor Kurzschluss schtzen. Nur mit geeigneten Ladegerten laden. Von Kindern fernhalten. Bei Beschdigung nicht mehr verwenden.',\n    productHighlights: [\n      'Hochwertige Lithium-Ionen-Zelle fr konstante Leistung',\n      'Mehrfachschutz vor berladung, Kurzschluss und Tiefentladung',\n      'Geringe Selbstentladung  ideal fr Langzeitlagerung',\n      'Zuverlssige Energieversorgung fr professionelle Anwendungen',\n      'Optimales Preis-Leistungs-Verhltnis bei hoher Qualitt',\n    ],\n  },\n\n  charger: {\n    id: 'charger',\n    name: 'Ladegert',\n    description: 'Ladegerte fr Akkus und Batterien',\n    keywords: ['ladegert', 'charger', 'lader', 'charging', 'laden', 'netzteil'],\n    technicalFields: [\n      { key: 'input', label: 'Eingang', unit: 'V/A', required: true, fallback: '230V AC' },\n      { key: 'output', label: 'Ausgang', unit: 'V/A', required: true, fallback: 'Nicht angegeben' },\n      { key: 'chargingTime', label: 'Ladezeit', unit: 'h', required: false, fallback: 'Abhngig von Akkukapazitt' },\n      { key: 'compatibility', label: 'Kompatibilitt', required: false, fallback: 'Siehe Beschreibung' },\n      { key: 'features', label: 'Funktionen', required: false, fallback: 'Standard-Ladefunktion' },\n      { key: 'weight', label: 'Gewicht', unit: 'g', required: false, fallback: 'Nicht angegeben' },\n    ],\n    uspTemplates: [\n      'Intelligente Ladesteuerung - optimale Ladung fr maximale Akkulebensdauer',\n      'Mehrfachschutz - gegen berladung, berhitzung und Kurzschluss',\n      'Schnellladefunktion - spart wertvolle Zeit',\n      'Universal einsetzbar - kompatibel mit verschiedenen Akkutypen',\n      'LED-Anzeige - zeigt den aktuellen Ladestatus',\n      'Kompaktes Design - ideal fr unterwegs',\n      'Energieeffizient - niedriger Standby-Verbrauch',\n    ],\n    safetyNotice: ' Nur in trockenen Rumen verwenden. Nicht abdecken whrend des Ladevorgangs. Bei berhitzung sofort vom Netz trennen. Kinder beaufsichtigen. Nur mit kompatiblen Akkus verwenden.',\n    productHighlights: [\n      'Hochwertige Elektronik fr sichere Ladung',\n      'Langlebige Konstruktion fr jahrelangen Einsatz',\n      'Einfache Bedienung und klare Anzeigen',\n      'Zuverlssige Leistung bei kompakter Bauweise',\n      'Optimales Preis-Leistungs-Verhltnis',\n    ],\n  },\n\n  tool: {\n    id: 'tool',\n    name: 'Werkzeug',\n    description: 'Elektrowerkzeuge und Handwerkzeuge',\n    keywords: ['werkzeug', 'tool', 'bohrmaschine', 'sge', 'schleifer', 'schrauber', 'akkuschrauber'],\n    technicalFields: [\n      { key: 'power', label: 'Leistung', unit: 'W', required: true, fallback: 'Nicht angegeben' },\n      { key: 'torque', label: 'Drehmoment', unit: 'Nm', required: false, fallback: 'Nicht angegeben' },\n      { key: 'speed', label: 'Drehzahl', unit: 'min', required: false, fallback: 'Nicht angegeben' },\n      { key: 'voltage', label: 'Spannung', unit: 'V', required: false, fallback: 'Nicht angegeben' },\n      { key: 'weight', label: 'Gewicht', unit: 'kg', required: false, fallback: 'Nicht angegeben' },\n      { key: 'dimensions', label: 'Abmessungen', unit: 'mm', required: false, fallback: 'Nicht angegeben' },\n    ],\n    uspTemplates: [\n      'Kraftvolle Leistung - fr anspruchsvolle Arbeiten',\n      'Ergonomisches Design - ermdungsfreies Arbeiten auch bei langen Einstzen',\n      'Robuste Konstruktion - langlebig und zuverlssig',\n      'Vielseitig einsetzbar - fr professionelle und private Anwendungen',\n      'Przise Arbeitsweise - exakte Ergebnisse',\n      'Einfache Handhabung - intuitive Bedienung',\n      'Sicheres Arbeiten - integrierte Sicherheitsfunktionen',\n    ],\n    safetyNotice: ' Bedienungsanleitung vor Gebrauch lesen. Schutzkleidung (Brille, Handschuhe, Gehrschutz) tragen. Werkstck sicher fixieren. Von Kindern fernhalten. Regelmige Wartung durchfhren.',\n    productHighlights: [\n      'Professionelle Qualitt fr anspruchsvolle Aufgaben',\n      'Langlebige Verarbeitung und hochwertige Materialien',\n      'Optimal ausbalanciert fr przise Kontrolle',\n      'Vielseitig einsetzbar in Werkstatt und auf der Baustelle',\n      'Hervorragendes Preis-Leistungs-Verhltnis',\n    ],\n  },\n\n  accessory: {\n    id: 'accessory',\n    name: 'Zubehr',\n    description: 'Kabel, Adapter, Klemmen, Taschen und weiteres Zubehr',\n    keywords: ['kabel', 'cable', 'adapter', 'klemme', 'clip', 'tasche', 'case', 'halter', 'halterung', 'mount', 'zubehr', 'accessory', 'krokodilklemme', 'verbindung', 'stecker', 'buchse', 'connector'],\n    technicalFields: [\n      { key: 'connector', label: 'Anschluss', required: false, fallback: 'Standard' },\n      { key: 'compatibility', label: 'Kompatibilitt', required: true, fallback: 'Siehe Beschreibung' },\n      { key: 'cableLength', label: 'Kabellnge', unit: 'cm', required: false, fallback: 'Nicht angegeben' },\n      { key: 'material', label: 'Material', required: false, fallback: 'Hochwertige Verarbeitung' },\n      { key: 'features', label: 'Besonderheiten', required: false, fallback: 'Zuverlssige Qualitt' },\n      { key: 'weight', label: 'Gewicht', unit: 'g', required: false, fallback: 'Nicht angegeben' },\n    ],\n    uspTemplates: [\n      'Przise Verbindung - zuverlssiger Kontakt fr exakte Messungen',\n      'Hochwertige Kontaktflchen - minimaler bergangswiderstand',\n      'Einfache Handhabung - schnelle Anbringung ohne Werkzeug',\n      'Robust und langlebig - fr den tglichen professionellen Einsatz',\n      'Isolierte Ausfhrung - Schutz vor Kurzschlssen',\n      'Universal kompatibel - passend fr viele Gerte',\n      'Professionelle Qualitt - zuverlssig in jeder Situation',\n    ],\n    safetyNotice: ' Vor dem Anschluss Polaritt beachten. Nicht bei laufendem Betrieb an-/abstecken. Beschdigte Kabel nicht verwenden. Von Kindern fernhalten. Bei Defekten sofort austauschen.',\n    productHighlights: [\n      'Robuste Verarbeitung fr langen Einsatz',\n      'Hochwertige Materialien fr beste Leitfhigkeit',\n      'Einfache Installation und Handhabung',\n      'Zuverlssige Kontaktierung',\n      'Optimales Preis-Leistungs-Verhltnis',\n    ],\n  },\n\n  testing_equipment: {\n    id: 'testing_equipment',\n    name: 'Messgert',\n    description: 'Mess- und Prfgerte fr Akkus, Batterien und Elektronik',\n    keywords: ['messgert', 'tester', 'prfgert', 'multimeter', 'innenwiderstand', 'kapazitt', 'measuring', 'testing', 'analyzer', 'meter'],\n    technicalFields: [\n      { key: 'measurementRange', label: 'Messbereich', required: true, fallback: 'Siehe Beschreibung' },\n      { key: 'accuracy', label: 'Genauigkeit', unit: '%', required: false, fallback: 'Hoch' },\n      { key: 'display', label: 'Anzeige', required: false, fallback: 'LCD' },\n      { key: 'powerSupply', label: 'Stromversorgung', required: false, fallback: 'Batterie' },\n      { key: 'features', label: 'Funktionen', required: false, fallback: 'Siehe Beschreibung' },\n      { key: 'dimensions', label: 'Abmessungen', unit: 'mm', required: false, fallback: 'Nicht angegeben' },\n    ],\n    uspTemplates: [\n      'Przise Messungen - professionelle Genauigkeit fr zuverlssige Ergebnisse',\n      'Einfache Bedienung - intuitive Handhabung auch fr Einsteiger',\n      'bersichtliches Display - klare Anzeige aller Messwerte',\n      'Vielseitig einsetzbar - fr verschiedene Mess-Anwendungen',\n      'Robustes Gehuse - langlebig und stofest',\n      'Schnelle Messungen - Ergebnisse in Sekundenschnelle',\n      'Professionelle Qualitt - zuverlssig im tglichen Einsatz',\n    ],\n    safetyNotice: ' Nicht an stromfhrenden Teilen messen ohne entsprechende Schutzmanahmen. Messbereich beachten. Vor Feuchtigkeit schtzen. Batterie bei lngerer Nichtbenutzung entfernen. Kalibrierung regelmig prfen.',\n    productHighlights: [\n      'Professionelle Messgenauigkeit',\n      'Langlebige und robuste Konstruktion',\n      'Einfache und sichere Handhabung',\n      'Vielseitige Einsatzmglichkeiten',\n      'Hervorragendes Preis-Leistungs-Verhltnis',\n    ],\n  },\n};\n\nexport function detectCategory(productData: any): string {\n  // Support both snake_case (CSV/PDF) and camelCase (URL Scraper)\n  const searchText = [\n    productData.product_name || productData.productName || '',\n    productData.short_intro || productData.shortIntro || '',\n    productData.description || '',\n    productData.extractedText || '',\n    JSON.stringify(productData.bullets || []),\n    // WICHTIG: ALLE technischen Felder prfen (snake_case + camelCase)\n    // Taschenlampen-Felder\n    productData.led1 || '',\n    productData.led2 || '',\n    productData.maxLuminosity || productData.max_luminosity || '',\n    productData.spotIntensity || productData.spot_intensity || '',\n    productData.maxBeamDistance || productData.max_beam_distance || '',\n    productData.powerSupply || productData.power_supply || '',\n    // Batterie/Akku-Felder\n    productData.nominalspannung || productData.nominalSpannung || '',\n    productData.nominalkapazitaet || productData.nominalKapazitaet || '',\n    productData.zellenchemie || productData.zellenChemie || '',\n    productData.energie || '',\n    // Abmessungen\n    productData.laenge || productData.length || '',\n    productData.breite || productData.width || '',\n    productData.hoehe || productData.height || '',\n  ].join(' ').toLowerCase();\n\n  let bestCategory = 'battery';\n  let bestScore = 0;\n\n  for (const [categoryId, config] of Object.entries(PRODUCT_CATEGORIES)) {\n    const matches = config.keywords.filter(keyword => \n      searchText.includes(keyword.toLowerCase())\n    ).length;\n\n    if (matches > bestScore) {\n      bestScore = matches;\n      bestCategory = categoryId;\n    }\n  }\n\n  console.log(`Category detection: \"${bestCategory}\" with ${bestScore} keyword matches`);\n  return bestCategory;\n}\n\nexport function getCategoryConfig(categoryId: string): ProductCategoryConfig {\n  return PRODUCT_CATEGORIES[categoryId] || PRODUCT_CATEGORIES.battery;\n}\n\nexport function getAllCategories(): ProductCategoryConfig[] {\n  return Object.values(PRODUCT_CATEGORIES);\n}\n","size_bytes":15020},"server/prompts/safety-warnings.ts":{"content":"import { PromptContext, SubpromptConfig } from './types';\n\nexport const safetyWarningsConfig: SubpromptConfig = {\n  name: 'safety-warnings',\n  temperature: 0.2,\n  maxTokens: 300,\n  responseFormat: 'json_object',\n  \n  systemPrompt: (context: PromptContext) => `Du erstellst Sicherheitshinweise fr Produkte.\n\nPRODUKTKATEGORIE: ${context.categoryName}\n\nDEINE AUFGABE:\nErstelle **GENAU 3 kurze Stze** als Sicherheitshinweise.\n\n${context.productData.safetyWarnings ? `WICHTIG: Nutze die folgenden Original-Sicherheitshinweise vom Lieferanten als Basis und fasse sie in 3 kurze, prgnante Stze zusammen:\n\nLIEFERANTEN-SICHERHEITSHINWEISE:\n${context.productData.safetyWarnings}\n\nExtrahiere die wichtigsten 3 Punkte daraus und formuliere sie kurz und klar.` : 'Falls keine Lieferanten-Hinweise vorhanden sind, erstelle 3 relevante Sicherheitshinweise basierend auf der Produktkategorie.'}\n\nREGELN:\n1. GENAU 3 kurze Stze (nicht mehr, nicht weniger)\n2. Jeder Satz endet mit einem Punkt\n3. Kurz und przise (max. 10 Wrter pro Satz)\n4. OHNE  Icon am Anfang\n5. Fokus auf die wichtigsten Sicherheitsaspekte\n\nBEISPIELE:\n- \"Nicht ins Feuer werfen. Vor Kurzschluss schtzen. Nur mit geeigneten Ladegerten laden.\"\n- \"Schutzkleidung tragen. Werkstck sicher fixieren. Von Kindern fernhalten.\"\n- \"Polaritt beachten. Nicht bei laufendem Betrieb an-/abstecken. berhitzung vermeiden.\"\n\nOUTPUT-FORMAT (JSON):\n{\n  \"safetyNotice\": \"Satz 1. Satz 2. Satz 3.\"\n}`,\n\n  userPrompt: (context: PromptContext) => `Produktdaten:\n${JSON.stringify(context.productData, null, 2)}\n\nErstelle GENAU 3 kurze Sicherheitshinweise als JSON.`\n};\n","size_bytes":1624},"server/prompts/orchestrator.ts":{"content":"import OpenAI from 'openai';\nimport { \n  PromptContext, \n  SubpromptResult, \n  SubpromptConfig,\n  SubpromptName \n} from './types';\nimport { getBaseSystemPrompt } from './base-system';\nimport { uspGenerationConfig } from './usp-generation';\nimport { techExtractionConfig } from './tech-extraction';\nimport { narrativeConfig } from './narrative';\nimport { safetyWarningsConfig } from './safety-warnings';\nimport { packageContentsConfig } from './package-contents';\n\nconst SUBPROMPT_CONFIGS: Record<SubpromptName, SubpromptConfig> = {\n  'usp-generation': uspGenerationConfig,\n  'tech-extraction': techExtractionConfig,\n  'narrative': narrativeConfig,\n  'safety-warnings': safetyWarningsConfig,\n  'package-contents': packageContentsConfig,\n};\n\nexport interface OrchestratorOptions {\n  openaiKey: string;\n  openaiBaseUrl?: string;\n  model?: string;\n}\n\nexport class PromptOrchestrator {\n  private openai: OpenAI;\n  private model: string;\n\n  constructor(options: OrchestratorOptions) {\n    this.openai = new OpenAI({\n      apiKey: options.openaiKey,\n      baseURL: options.openaiBaseUrl,\n    });\n    this.model = options.model || 'gpt-4o';\n  }\n\n  async executeSubprompt(\n    name: SubpromptName,\n    context: PromptContext,\n    retries = 5\n  ): Promise<SubpromptResult> {\n    const config = SUBPROMPT_CONFIGS[name];\n    if (!config) {\n      return {\n        success: false,\n        data: null,\n        error: `Unknown subprompt: ${name}`,\n      };\n    }\n\n    // RETRY LOGIC: Exponential Backoff bei Rate Limit Errors\n    for (let attempt = 0; attempt < retries; attempt++) {\n      try {\n        const basePrompt = getBaseSystemPrompt();\n        const systemPrompt = `${basePrompt}\\n\\n${config.systemPrompt(context)}`;\n        const userPrompt = config.userPrompt(context);\n\n        const response = await this.openai.chat.completions.create({\n          model: this.model,\n          messages: [\n            { role: 'system', content: systemPrompt },\n            { role: 'user', content: userPrompt }\n          ],\n          temperature: config.temperature,\n          max_tokens: config.maxTokens,\n          response_format: config.responseFormat ? { type: config.responseFormat } : undefined,\n        });\n\n        const content = response.choices[0]?.message?.content?.trim() || '{}';\n        \n        if (config.responseFormat === 'json_object') {\n          try {\n            const parsedData = JSON.parse(content);\n            return {\n              success: true,\n              data: parsedData,\n            };\n          } catch (parseError) {\n            console.error(`Failed to parse JSON from ${name}:`, content);\n            return {\n              success: false,\n              data: null,\n              error: 'Invalid JSON response',\n            };\n          }\n        } else {\n          return {\n            success: true,\n            data: content,\n          };\n        }\n      } catch (error: any) {\n        // Rate Limit Error: Retry with exponential backoff\n        if (error.status === 429 && attempt < retries - 1) {\n          const waitTime = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s, 8s, 16s\n          console.log(` Rate limit hit for ${name}, retrying in ${waitTime}ms (attempt ${attempt + 1}/${retries})`);\n          await new Promise(resolve => setTimeout(resolve, waitTime));\n          continue; // Retry\n        }\n        \n        // Other errors or max retries reached\n        console.error(`Subprompt ${name} failed:`, error);\n        return {\n          success: false,\n          data: null,\n          error: error instanceof Error ? error.message : 'Unknown error',\n        };\n      }\n    }\n    \n    // Should never reach here, but TypeScript requires it\n    return {\n      success: false,\n      data: null,\n      error: 'Max retries exceeded',\n    };\n  }\n\n  async executeMultiple(\n    subprompts: SubpromptName[],\n    context: PromptContext\n  ): Promise<Record<SubpromptName, SubpromptResult>> {\n    const results = await Promise.all(\n      subprompts.map(name => \n        this.executeSubprompt(name, context).then(result => ({ name, result }))\n      )\n    );\n\n    return results.reduce((acc, { name, result }) => {\n      acc[name] = result;\n      return acc;\n    }, {} as Record<SubpromptName, SubpromptResult>);\n  }\n\n  async generateFullProductCopy(context: PromptContext): Promise<{\n    narrative: string;\n    uspBullets: string[];\n    technicalSpecs: Record<string, string>;\n    safetyNotice?: string;\n    packageContents?: string;\n    productHighlights: string[];\n  }> {\n    const results = await this.executeMultiple(\n      ['narrative', 'usp-generation', 'tech-extraction', 'safety-warnings', 'package-contents'],\n      context\n    );\n\n    const narrative = results['narrative']?.success \n      ? results['narrative'].data.narrative || ''\n      : 'Hochwertiges Produkt fr professionelle Anwendungen.';\n\n    const uspBullets = results['usp-generation']?.success\n      ? results['usp-generation'].data.usps || []\n      : [];\n\n    const technicalSpecs = results['tech-extraction']?.success\n      ? results['tech-extraction'].data.technicalSpecs || {}\n      : {};\n\n    const safetyNotice = results['safety-warnings']?.success\n      ? results['safety-warnings'].data.safetyNotice\n      : undefined;\n\n    const packageContents = results['package-contents']?.success\n      ? results['package-contents'].data.packageContents\n      : undefined;\n\n    return {\n      narrative,\n      uspBullets,\n      technicalSpecs,\n      safetyNotice,\n      packageContents,\n      productHighlights: results['narrative'].success && results['narrative'].data?.productHighlights \n        ? results['narrative'].data.productHighlights \n        : []\n    };\n  }\n}\n\nexport function createOrchestrator(options: OrchestratorOptions): PromptOrchestrator {\n  return new PromptOrchestrator(options);\n}\n","size_bytes":5802},"server/prompts/types.ts":{"content":"export interface PromptContext {\n  categoryName: string;\n  categoryDescription: string;\n  productData: any;\n  availableFields?: string[];\n  uspTemplates?: string[];\n}\n\nexport interface SubpromptResult {\n  success: boolean;\n  data: any;\n  error?: string;\n}\n\nexport type SubpromptName = \n  | 'usp-generation'\n  | 'tech-extraction'\n  | 'narrative'\n  | 'safety-warnings'\n  | 'package-contents';\n\nexport interface SubpromptConfig {\n  name: SubpromptName;\n  systemPrompt: (context: PromptContext) => string;\n  userPrompt: (context: PromptContext) => string;\n  temperature: number;\n  maxTokens: number;\n  responseFormat?: 'json_object' | 'text';\n}\n","size_bytes":641},"server/prompts/tech-extraction.ts":{"content":"import { PromptContext, SubpromptConfig } from './types';\n\nexport const techExtractionConfig: SubpromptConfig = {\n  name: 'tech-extraction',\n  temperature: 0.1,\n  maxTokens: 500,\n  responseFormat: 'json_object',\n  \n  systemPrompt: (context: PromptContext) => `Du extrahierst technische Produktdaten aus ALLEN verfgbaren Informationen.\n\nPRODUKTKATEGORIE: ${context.categoryName}\n\nWICHTIGE TECHNISCHE FELDER:\n${context.availableFields?.map(field => `- ${field}`).join('\\n') || 'Keine Felder definiert'}\n\nDEINE AUFGABE:\nExtrahiere die technischen Daten aus ALLEN Quellen:\n1. Produkttitel/Name\n2. Produktbeschreibung\n3. Strukturierte Felder\n4. Freitext-Informationen\n\nREGELN FR EXTRAKTION:\n1. Suche BERALL nach technischen Werten (auch im Titel!)\n2. Erkenne Muster wie:\n   - \"5000mAh\" oder \"5000 mAh\"  Kapazitt\n   - \"3.6V\" oder \"3,6 V\" oder \"3.6-3.7V\"  Spannung\n   - \"25A\" oder \"25 Ampere\"  Stromstrke\n   - \"21700\" oder \"18650\"  Format/Bauform\n   - \"184 g\" oder \"184g\"  Gewicht\n   - \"7037.537.5 mm\"  Abmessungen\n   - \"Li-Ion\" oder \"Lithium-Ionen\"  Technologie\n3. Verwende die Feld-Labels von oben\n4. Normalisiere Einheiten (z.B. \"5000 mAh\"  \"5000 mAh\")\n5. Wenn mehrere Werte (z.B. \"3.6V - 3.7V\")  behalte beide\n6. Nur Felder mit echten Werten zurckgeben\n\nBEISPIELE:\nTitel: \"XTAR 21700-HP 25A 5000mAh 3.6V - 3.7V Li-Ionen-Akku\"\n Extrahiere:\n  - Kapazitt: 5000 mAh\n  - Spannung: 3.6V - 3.7V\n  - Stromstrke: 25A\n  - Mae:  21mm  70mm (falls vorhanden)\n  - Technologie: Li-Ion\n  - Gewicht: 184 g (falls vorhanden)\n\nWICHTIG: Schaue in ALLEN Produktdaten, nicht nur in strukturierten Feldern!\n\nOUTPUT-FORMAT (JSON):\n{\n  \"technicalSpecs\": {\n    \"Feldname1\": \"Wert1\",\n    \"Feldname2\": \"Wert2\"\n  }\n}`,\n\n  userPrompt: (context: PromptContext) => {\n    // Baue einen umfassenden Text mit ALLEN verfgbaren Daten\n    const allText: string[] = [];\n    \n    if (context.productData.product_name || context.productData.titel) {\n      allText.push(`PRODUKTTITEL: ${context.productData.product_name || context.productData.titel}`);\n    }\n    \n    if (context.productData.short_intro) {\n      allText.push(`KURZBESCHREIBUNG: ${context.productData.short_intro}`);\n    }\n    \n    if (context.productData.description || context.productData.beschreibung) {\n      allText.push(`BESCHREIBUNG: ${context.productData.description || context.productData.beschreibung}`);\n    }\n    \n    if (context.productData.extractedText) {\n      allText.push(`EXTRAHIERTER TEXT: ${context.productData.extractedText}`);\n    }\n    \n    if (context.productData.bullets && Array.isArray(context.productData.bullets)) {\n      allText.push(`EIGENSCHAFTEN: ${context.productData.bullets.join(' | ')}`);\n    }\n    \n    // Strukturierte technische Daten, falls vorhanden\n    if (context.productData.technischeDaten) {\n      allText.push(`STRUKTURIERTE DATEN: ${JSON.stringify(context.productData.technischeDaten)}`);\n    }\n\n    return `Produktdaten (suche in ALLEN Texten nach technischen Werten):\n\n${allText.join('\\n\\n')}\n\n---\n\nExtrahiere jetzt ALLE technischen Daten, die du finden kannst, als JSON.\nSchaue besonders im Produkttitel nach Zahlen mit Einheiten!`;\n  }\n};\n","size_bytes":3173},"server/prompts/package-contents.ts":{"content":"import { PromptContext, SubpromptConfig } from './types';\n\nexport const packageContentsConfig: SubpromptConfig = {\n  name: 'package-contents',\n  temperature: 0.2,\n  maxTokens: 200,\n  responseFormat: 'json_object',\n  \n  systemPrompt: (context: PromptContext) => `Du beschreibst den Lieferumfang von Produkten.\n\nPRODUKTKATEGORIE: ${context.categoryName}\n\nDEINE AUFGABE:\nBeschreibe was im Lieferumfang enthalten ist, basierend auf den Produktdaten.\n\nREGELN:\n1. Verwende NUR Informationen aus den Produktdaten\n2. Wenn Lieferumfang explizit genannt ist  bernimm 1:1\n3. Wenn nicht angegeben  beschreibe nur das Hauptprodukt\n4. Kurz und przise\n5. Keine Annahmen ber Zubehr\n\nBEISPIELE:\n- \"1x Akku wie beschrieben\"\n- \"Ladegert mit Netzkabel und Bedienungsanleitung\"\n- \"Krokodilklemmen fr YR-1035+ Innenwiderstandstester\"\n\nOUTPUT-FORMAT (JSON):\n{\n  \"packageContents\": \"Beschreibung des Lieferumfangs\"\n}`,\n\n  userPrompt: (context: PromptContext) => `Produktdaten:\n${JSON.stringify(context.productData, null, 2)}\n\nBeschreibe den Lieferumfang als JSON.`\n};\n","size_bytes":1062},"PRSENTATION.md":{"content":"# MediaMarkt Tools - Produktmanagement\n## Prsentation 2025\n\n---\n\n##  Folie 1: berblick\n\n### Was macht die App?\n**Automatische KI-gesttzte Produktbeschreibungen** aus Lieferantendaten\n\n**3 Haupt-Features:**\n-  CSV-Upload & Analyse\n-  Website-Scraping von Lieferanten\n-  Bild-Analyse mit OCR & AI Vision\n\n**Ergebnis:** Fertige MediaMarkt-konforme Produkttexte in Sekunden\n\n---\n\n##  Folie 2: Technologie-Stack\n\n### Frontend\n- **React 18** - Moderne UI-Bibliothek\n- **TypeScript** - Type-sichere Entwicklung\n- **Vite** - Blitzschneller Build-Prozess\n- **Tailwind CSS** - Utility-First CSS Framework\n- **shadcn/ui + Radix UI** - Professionelle UI-Komponenten\n\n### Backend\n- **Node.js + Express** - Server & API\n- **TypeScript** - End-to-End Type Safety\n- **Drizzle ORM** - Moderne Datenbank-Verwaltung\n\n### Datenbank\n- **SQLite** (Development) - Schnell & lokal\n- **PostgreSQL** (Production via Neon) - Skalierbar & zuverlssig\n\n---\n\n##  Folie 3: AI & Automatisierung\n\n### KI-Services\n- **OpenAI GPT-4o Vision** - Textgenerierung & Bildanalyse\n- **Firecrawl API** - Intelligentes Website-Scraping\n- **Tesseract.js** - OCR fr Produktbilder\n\n### Innovativer Ansatz: Modulare Prompt-Architektur\n**6 spezialisierte AI-Module:**\n1. USP-Generierung - Verkaufsfrdernde Vorteile\n2. Tech-Extraktion - Technische Daten\n3. Narrative - Produktbeschreibung\n4. Safety - Sicherheitshinweise\n5. Package - Lieferumfang\n6. Orchestrator - Intelligente Kombination\n\n**Vorteil:** Einzeln testbar, kostengnstiger, wiederverwendbar\n\n---\n\n##  Folie 4: Intelligente Kategorie-Erkennung\n\n### 5 Produktkategorien (automatisch erkannt)\n1. **Akkus & Batterien** - Wiederaufladbare Energiespeicher\n2. **Ladegerte** - Ladeelektronik\n3. **Werkzeuge** - Elektro- & Handwerkzeuge\n4. **Zubehr** - Kabel, Adapter, Klemmen\n5. **Messgerte** - Tester & Multimeter\n\n### Smart Detection\n- Keywords-basierte Erkennung\n- Whlt beste Match (nicht erste)\n- Kategorie-spezifische Templates\n- Dynamische Prompts\n\n---\n\n##  Folie 5: Architektur-Highlights\n\n### 3-Schicht-System fr Flexibilitt\n\n**Schicht 1: Kategorie-Konfiguration**\n- Definiert relevante Felder pro Kategorie\n- USP-Vorlagen\n- Sicherheitshinweise\n\n**Schicht 2: AI  Strukturiertes JSON**\n- Keine Template-Anweisungen im Output\n- Dynamischer Prompt basierend auf Daten\n- Funktioniert mit unterschiedlichen Lieferanten\n\n**Schicht 3: Code  HTML-Rendering**\n- Automatische Fallbacks\n- Konsistente MediaMarkt-Formatierung\n- Qualittssicherung\n\n---\n\n##  Folie 6: Development & Deployment\n\n### Moderne Development-Umgebung\n- **Hot Module Replacement** - nderungen sofort sichtbar\n- **Type Safety** - Fehler vor dem Deployment\n- **Modulare Architektur** - Einfache Wartung\n\n### Production-Ready\n- **Dual-Database-Strategie** - Dev & Prod getrennt\n- **Replit Deployment** - Ein-Klick-Publishing\n- **Autoscaling** - Automatische Skalierung bei Bedarf\n\n### Developer Experience\n- Shared Types zwischen Frontend/Backend\n- Monorepo-Struktur\n- Automatische Migrations\n\n---\n\n##  Folie 7: Workflow im Detail\n\n### 1. Daten-Upload\n```\nCSV hochladen  Automatische Analyse  Strukturierung\n```\n\n### 2. AI-Verarbeitung (Dual-Mode)\n```\nModular: 6 Subprompts parallel  Schneller & gnstiger\nFallback: Monolithischer Prompt  Zuverlssigkeit\n```\n\n### 3. Template-Generierung\n```\nJSON-Daten + Kategorie-Config  HTML-Output\n```\n\n### 4. Ergebnis\nFertige Produktbeschreibung mit:\n- Professioneller Text (4-5 Stze)\n- 5 verkaufsfrdernde USPs\n- Technische Tabelle\n- Sicherheitshinweise\n- Lieferumfang\n\n---\n\n##  Folie 8: Features im berblick\n\n### Haupt-Features\n CSV-Anreicherung mit AI\n URL-Analyse von Lieferanten-Websites\n Bildanalyse (OCR + Vision)\n Projektmanagement (mehrere Projekte parallel)\n Template-System (anpassbar)\n API-Key-Verwaltung (sicher)\n\n### Besondere Strken\n- Funktioniert mit **unterschiedlichen Lieferantendaten**\n- **Automatische Qualittssicherung**\n- **Kategorie-spezifische Optimierung**\n- **Dual-Mode fr Zuverlssigkeit**\n\n---\n\n##  Folie 9: UI/UX Highlights\n\n### Design-Prinzipien\n- **Clean & Modern** - shadcn/ui Komponenten\n- **Responsive** - Funktioniert auf allen Gerten\n- **Intuitiv** - Klarer Workflow\n- **Professionell** - MediaMarkt-Standards\n\n### Technische UI-Features\n- Dark/Light Mode Support (next-themes)\n- Drag & Drop File Upload\n- Real-time Preview\n- Progress Indicators\n- Toast Notifications\n\n---\n\n##  Folie 10: Sicherheit & Best Practices\n\n### Sicherheit\n- API-Keys verschlsselt gespeichert\n- Keine Secrets im Code\n- Separate Dev/Production Datenbanken\n- Type-sichere API-Calls\n\n### Code-Qualitt\n- TypeScript in Frontend & Backend\n- Drizzle ORM (SQL-Injection-Schutz)\n- Input-Validierung mit Zod\n- Error Handling & Fallbacks\n\n---\n\n##  Folie 11: Vorteile fr MediaMarkt\n\n### Zeit-Ersparnis\n**Frher:** Manuelle Produktbeschreibungen (15-30 Min/Produkt)\n**Jetzt:** Automatisch in Sekunden\n\n### Qualitt\n- Konsistente MediaMarkt-Formatierung\n- Verkaufsfrdernde Texte\n- Kategorie-optimiert\n- Fehlerfreie technische Daten\n\n### Skalierbarkeit\n- Hunderte Produkte gleichzeitig verarbeiten\n- Verschiedene Lieferanten untersttzt\n- Einfach erweiterbar\n\n---\n\n##  Folie 12: Technische Innovation\n\n### Modular Subprompt Architecture\n**Problem gelst:**\n- Monolithische Prompts sind teuer & unflexibel\n- Schwer zu testen & optimieren\n\n**Lsung:**\n- 6 spezialisierte Module\n- Parallel ausfhrbar\n- Einzeln A/B-testbar\n- Wiederverwendbar in anderen Tools\n\n### Smart Category Detection\n**Frher:** Erste Kategorie mit Match\n**Jetzt:** Beste Kategorie (Score-basiert)\n\n**Beispiel:** Krokodilklemmen\n-  Alt: \"Ladegert\" (falscher Match)\n-  Neu: \"Zubehr\" (korrekter Match)\n\n---\n\n##  Folie 13: Zukunftspotenzial\n\n### Erweiterbar fr:\n- Weitere Produktkategorien (Elektronik, Haushalt, etc.)\n- Andere Shops (Amazon, Otto, etc.)\n- Mehrsprachigkeit (EN, FR, IT)\n- Bulk-Export Funktionen\n- API fr externe Systeme\n\n### Technisch vorbereitet fr:\n- Agenten-basierte AI (GPT whlt Prompts selbst)\n- Caching von AI-Ergebnissen\n- Make/n8n Integration\n- Custom Template-Engine\n\n---\n\n##  Folie 14: Zusammenfassung\n\n### Was haben wir gebaut?\nEine **moderne, skalierbare Full-Stack-Anwendung** fr automatisierte Produktbeschreibungen\n\n### Tech-Stack\nReact + TypeScript + Tailwind + Express + OpenAI + PostgreSQL\n\n### Besonderheiten\n- Modulare AI-Architektur\n- Dual-Mode Generierung\n- Smart Category Detection\n- Kategorie-spezifische Templates\n\n### Status\n Produktionsbereit\n Type-safe\n Skalierbar\n Erweiterbar\n\n---\n\n##  Folie 15: Fragen?\n\n### Kontakt & Demo\n**Live-Demo verfgbar**\n**Code auf Replit gehostet**\n\n### Danke fr Ihre Aufmerksamkeit!\n\n---\n\n##  Appendix: Technische Details\n\n### Package-Highlights\n- `@tanstack/react-query` - Server State Management\n- `drizzle-orm` - Type-safe Database\n- `zod` - Runtime Validation\n- `wouter` - Lightweight Routing\n- `framer-motion` - Smooth Animations\n- `recharts` - Data Visualization\n\n### Performance\n- Vite Build < 10s\n- Hot Reload < 100ms\n- API Response < 2s (mit AI)\n- Database Queries < 50ms\n","size_bytes":7143},"server/prompts/usp-generation.ts":{"content":"import { PromptContext, SubpromptConfig } from './types';\n\nexport const uspGenerationConfig: SubpromptConfig = {\n  name: 'usp-generation',\n  temperature: 0.4,\n  maxTokens: 500,\n  responseFormat: 'json_object',\n  \n  systemPrompt: (context: PromptContext) => `Du bist Experte fr verkaufsfrdernde USPs (Unique Selling Propositions).\n\nPRODUKTKATEGORIE: ${context.categoryName}\n${context.categoryDescription}\n\n KRITISCH: Erstelle PRODUKTSPEZIFISCHE USPs basierend auf den ECHTEN Produktdaten!\nNICHT generische Templates verwenden, die auf JEDES Produkt passen!\n\nDEINE AUFGABE:\nAnalysiere die Produktdaten und erstelle GENAU 5 USP-Bulletpoints, die:\n1. Auf KONKRETEN Produkteigenschaften basieren\n2. SPEZIFISCH fr dieses Produkt sind\n3. Den echten Kundennutzen beschreiben\n4. Format: \"Feature/Vorteil - konkreter Nutzen\"\n5. Max. 12 Wrter pro USP\n\nBEISPIEL-ANALYSE:\n\nProdukt: Keeppower RCR123A 950mAh Akku mit BMS\n SCHLECHT (zu generisch):\n- \"Wiederaufladbar - spart Kosten\" (gilt fr ALLE Akkus)\n- \"Kompatibel mit vielen Gerten\" (zu vage!)\n- \"Hohe Leistung bei geringem Gewicht\" (zu allgemein)\n\n GUT (produktspezifisch - nutze solche Formulierungen):\n- \"Integrierte BMS-Schutzelektronik fr maximale Zellensicherheit\"\n- \"Kompatibel mit Gerten, die CR123A Primrzellen nutzen  wiederaufladbare Alternative\"\n- \"Hervorragende Spannungsstabilitt auch bei hoher Belastung\"\n- \"Qualittszelle mit langer Lebensdauer  ideal fr Dauerbetrieb\"\n- \"Entwickelt fr professionelle Anwendungen (z. B. Taschenlampen, Messgerte, Fotoausrstung)\"\n\nSTIL-BEISPIELE (zeigen den gewnschten Stil - NICHT 1:1 kopieren, sondern an das Produkt anpassen):\n${context.uspTemplates?.map((usp, i) => `${i + 1}. ${usp}`).join('\\n') || 'Keine Vorlagen'}\n\nWICHTIG: Nutze diesen STIL, aber erstelle EIGENE USPs basierend auf den echten Produktdaten!\n\nREGELN:\n Analysiere die Produktdaten (Kapazitt, Format, Schutzfunktionen, Anwendungsbereich)\n Nutze den Stil der Beispiele oben (z.B. \"BMS-Schutzelektronik\", \"CR123A-kompatibel\")\n Erstelle produktspezifische USPs mit echten Werten\n Erklre konkrete Anwendungen (welche Gerte? welche Zielgruppe?)\n Jeder USP muss auf DIESES spezielle Produkt passen\n\n VERBOTEN:\n- Generische Aussagen ohne Produktbezug\n- USPs, die auf jedes Produkt der Kategorie passen\n- Technische Daten ohne Nutzenerklrung\n\nOUTPUT-FORMAT (JSON):\n{\n  \"usps\": [\n    \"Produktspezifischer USP 1\",\n    \"Produktspezifischer USP 2\",\n    \"Produktspezifischer USP 3\",\n    \"Produktspezifischer USP 4\",\n    \"Produktspezifischer USP 5\"\n  ]\n}`,\n\n  userPrompt: (context: PromptContext) => `Produktdaten:\n${JSON.stringify(context.productData, null, 2)}\n\nErstelle jetzt 5 verkaufsfrdernde USPs als JSON.`\n};\n","size_bytes":2739},"server/prompts/base-system.ts":{"content":"export const BASE_SYSTEM_PROMPT = `Du bist ein Produkttext-Experte fr Online-Shops.\n\nGRUNDPRINZIPIEN:\n1. Verwende NUR Informationen aus den gegebenen Produktdaten\n2. Wenn ein Wert fehlt, lass das Feld komplett weg (kein \"Nicht angegeben\")\n3. Schreibe verkaufsfrdernde Texte, keine technischen Spezifikationen\n4. Gib immer valides JSON zurck, ohne Markdown-Formatierung\n5. Sei przise, professionell und kundenorientiert\n\nVERBOTEN:\n Erfundene Daten oder Annahmen\n Template-Anweisungen im Output (\"VERWENDE...\", \"FGE EIN...\")\n Markdown-Formatierung (\\`\\`\\`json, **, etc.)\n Technische Daten als USPs (\"3,6 V Spannung\")\n UI-Anweisungen oder Barrierefreiheits-Hinweise\n\nERLAUBT:\n Kundennutzen in den Vordergrund stellen\n Professionelle und klare Sprache\n Strukturierte JSON-Ausgabe\n Flexibilitt basierend auf verfgbaren Daten`;\n\nexport function getBaseSystemPrompt(): string {\n  return BASE_SYSTEM_PROMPT;\n}\n","size_bytes":943},"server/prompts/narrative.ts":{"content":"import { PromptContext, SubpromptConfig } from './types';\n\nexport const narrativeConfig: SubpromptConfig = {\n  name: 'narrative',\n  temperature: 0.5,\n  maxTokens: 400,\n  responseFormat: 'json_object',\n  \n  systemPrompt: (context: PromptContext) => `Du schreibst PRODUKTSPEZIFISCHE Produktbeschreibungen.\n\nPRODUKTKATEGORIE: ${context.categoryName}\n${context.categoryDescription}\n\n KRITISCH: Schreibe eine Beschreibung, die NUR auf DIESES Produkt passt!\nNICHT generische Texte, die auf jedes Produkt der Kategorie passen!\n\nDEINE AUFGABE:\nSchreibe eine professionelle, produktspezifische Beschreibung in GENAU 3-4 Stzen.\n\nINHALT (produktspezifisch):\n1. Was ist das Produkt KONKRET? Nenne Modell/Format (z.B. \"Der RCR123A...\")\n2. Welche SPEZIFISCHEN Vorteile hat es? (nutze echte Werte: 950mAh, PCB, etc.)\n3. WOFR wird es verwendet? (konkrete Anwendungen: Taschenlampen, Kameras)\n4. Fr wen ist ES geeignet? (spezifische Zielgruppe)\n\nBEISPIEL:\n\n SCHLECHT (generisch):\n\"Dieser Akku ist ein hochwertiger und zuverlssiger Energiespeicher. Er bietet langanhaltende Leistung und ist ideal fr professionelle Anwendungen. Die integrierte Schutzschaltung gewhrleistet maximale Sicherheit.\"\n\n GUT (produktspezifisch):\n\"Der Keeppower RCR123A ist ein wiederaufladbarer Li-Ion-Akku im kompakten 16340 Format, ideal fr LED-Taschenlampen, Fotokameras und Sicherheitstechnik. Mit 950 mAh Kapazitt bietet er lange Betriebszeiten, whrend die PCB/BMS Schutzschaltung zuverlssig vor berladung und Tiefentladung schtzt. Die konstante Spannung von 3,6V-3,7V gewhrleistet eine stabile Leistung in allen Anwendungen.\"\n\nSTIL:\n- Nutze konkrete Produktdaten (Modell, Kapazitt, Format)\n- Nenne spezifische Anwendungen\n- Erklre echte Vorteile (nicht \"hochwertig\", \"zuverlssig\")\n- Der Produktname wird separat behandelt - nicht wiederholen\n- GENAU 3-4 Stze (nicht mehr, nicht weniger!)\n\n VERBOTENE PHRASEN (nicht verwenden!):\n- \"steht fr Qualitt, Zuverlssigkeit und Langlebigkeit\"\n- \"ideal fr den tglichen Einsatz\"\n- \"perfekte Wahl fr\"\n- \"hochwertiges Produkt\"\n\nOUTPUT-FORMAT (JSON):\n{\n  \"narrative\": \"Die produktspezifische Beschreibung in 4-5 Stzen.\",\n  \"productHighlights\": [\n    \"Produktspezifisches Highlight 1\",\n    \"Produktspezifisches Highlight 2\", \n    \"Produktspezifisches Highlight 3\",\n    \"Produktspezifisches Highlight 4\"\n  ]\n}\n\nZUSTZLICH: Erstelle 4 produktspezifische Highlights (hnlich wie USPs, aber krzer):\n\nSTIL-BEISPIELE fr Akku-Highlights:\n- \"Hochwertige Lithium-Ionen-Zelle fr konstante Leistung\"\n- \"Mehrfachschutz vor berladung, Kurzschluss und Tiefentladung\"\n- \"Geringe Selbstentladung  ideal fr Langzeitlagerung\"\n\nWICHTIG fr Highlights:\n- Basierend auf echten Produktdaten\n- Krzer als USPs (max. 8-10 Wrter)\n- Fokus auf Qualittsmerkmale und Schutzfunktionen\n- Produktspezifisch, nicht generisch`,\n\n  userPrompt: (context: PromptContext) => `Produktdaten:\n${JSON.stringify(context.productData, null, 2)}\n\nSchreibe jetzt eine PRODUKTSPEZIFISCHE Beschreibung als JSON.\n\nWICHTIG:\n- Nutze konkrete Werte (Modell, Kapazitt, Format)\n- Erklre, WOFR dieses spezielle Produkt verwendet wird\n- Vermeide generische Phrasen ohne Kontext\n- Zeige den konkreten Kundennutzen auf`\n};\n","size_bytes":3252},"server/prompts/index.ts":{"content":"export * from './types';\nexport * from './base-system';\nexport * from './usp-generation';\nexport * from './tech-extraction';\nexport * from './narrative';\nexport * from './safety-warnings';\nexport * from './package-contents';\n","size_bytes":225},"server/templates/tech-spec-parser.ts":{"content":"/**\n * Parst technische Daten 1:1 aus extrahiertem Text\n * KEINE AI-Interpretation - nur direktes Mapping\n */\n\nimport { ProductCategoryConfig } from './category-config';\n\nexport interface ParsedTechSpecs {\n  specs: Record<string, string>;\n  source: 'vision_text' | 'structured_data' | 'none';\n}\n\n/**\n * Extrahiert Tech Specs 1:1 aus Vision-extrahiertem Text\n * DYNAMISCH: Extrahiert ALLE \"Feld: Wert\" Paare, nicht nur vordefinierte\n */\nexport function parseTechSpecsFromText(\n  extractedText: string,\n  categoryConfig: ProductCategoryConfig\n): ParsedTechSpecs {\n  const specs: Record<string, string> = {};\n  \n  // Pattern fr Tech Spec Zeilen: \"- Feldname: Wert\" oder \"Feldname: Wert\"\n  const lines = extractedText.split('\\n');\n  \n  for (const line of lines) {\n    const trimmed = line.trim();\n    if (!trimmed) continue;\n    \n    // Skip JSON objects (lines starting with { or containing JSON-like structure)\n    if (trimmed.startsWith('{') || trimmed.startsWith('[')) {\n      console.log(` Skipping JSON line: ${trimmed.substring(0, 50)}...`);\n      continue;\n    }\n    \n    // Pattern: \"- Kapazitt: 3800mAh\" oder \"Kapazitt: 3800mAh\"\n    const match = trimmed.match(/^-?\\s*\\*?\\*?\\s*([^:]+):\\s*(.+)$/);\n    if (!match) continue;\n    \n    let fieldName = match[1].trim();\n    const value = match[2].trim();\n    \n    // Skip invalide Werte\n    if (!isValidValue(value)) continue;\n    \n    // Bereinige Feldnamen (entferne **, etc.)\n    fieldName = fieldName.replace(/\\*\\*/g, '').trim();\n    \n    // Mappe auf bekannte Kategorie-Felder (fr konsistente Labels)\n    let mappedFieldName = fieldName;\n    for (const field of categoryConfig.technicalFields) {\n      const normalizedFieldName = normalizeFieldName(fieldName);\n      const normalizedLabel = normalizeFieldName(field.label);\n      const normalizedKey = normalizeFieldName(field.key);\n      \n      if (normalizedFieldName === normalizedLabel || normalizedFieldName === normalizedKey) {\n        mappedFieldName = field.label; // Nutze konsistenten Label\n        break;\n      }\n    }\n    \n    // SPEZIAL: Vereinfache Schutzschaltung (entferne redundante \"Schutz\"-Wrter)\n    let cleanedValue = value;\n    if (mappedFieldName === 'Schutzschaltung' || normalizeFieldName(fieldName).includes('schutz')) {\n      // \"PCB/BMS Schutz, berlade- und Entladeschutz, Kurzschlussschutz\"  \"PCB/BMS\"\n      cleanedValue = value.split(',')[0].replace(/schutz$/i, '').trim();\n    }\n    \n    // Speichere ALLE Specs (auch unbekannte)\n    specs[mappedFieldName] = cleanedValue;\n    console.log(` 1:1 Text-Parse: ${mappedFieldName} = ${cleanedValue}`);\n  }\n  \n  return {\n    specs,\n    source: Object.keys(specs).length > 0 ? 'vision_text' : 'none',\n  };\n}\n\n/**\n * Extrahiert Tech Specs aus strukturierten Daten (falls vorhanden)\n */\nexport function extractTechSpecsFromStructured(\n  structuredData: any,\n  categoryConfig: ProductCategoryConfig\n): ParsedTechSpecs {\n  if (!structuredData) {\n    return { specs: {}, source: 'none' };\n  }\n  \n  const specs: Record<string, string> = {};\n  \n  // Prfe auf verschiedene mgliche Strukturen\n  const sources = [\n    structuredData.technicalData,\n    structuredData.technicalSpecs,\n    structuredData.specs,\n    structuredData.technischeDaten,\n    structuredData, // WICHTIG: Auch direkt im Hauptobjekt suchen (fr CSV-Daten)\n  ].filter(Boolean);\n  \n  for (const source of sources) {\n    for (const field of categoryConfig.technicalFields) {\n      // Suche nach verschiedenen Varianten des Feldnamens\n      const possibleKeys = [\n        field.key,\n        field.label,\n        field.key.toLowerCase(),\n        field.label.toLowerCase(),\n        // CSV-spezifische Varianten\n        field.key.replace(/_/g, ''),\n        field.key.replace(/_/g, ' '),\n      ];\n      \n      let value = null;\n      for (const key of possibleKeys) {\n        if (source[key] && isValidValue(source[key])) {\n          value = source[key];\n          break;\n        }\n      }\n      \n      if (value) {\n        // SPEZIAL: Vereinfache Schutzschaltung\n        let cleanedValue = value;\n        if (field.key === 'protection' || field.label === 'Schutzschaltung') {\n          cleanedValue = value.split(',')[0].replace(/schutz$/i, '').trim();\n        }\n        \n        specs[field.label] = cleanedValue;\n        console.log(` 1:1 Strukturierte Daten: ${field.label} = ${cleanedValue}`);\n      }\n    }\n  }\n  \n  // DYNAMISCH: Extrahiere ALLE brigen Felder (auch wenn nicht in categoryConfig)\n  // Dies ermglicht dynamische Tabellen mit 18+ Specs\n  const processedKeys = new Set();\n  \n  // Sammle alle bereits verarbeiteten Feldnamen (normalisiert)\n  for (const specKey of Object.keys(specs)) {\n    processedKeys.add(normalizeFieldName(specKey));\n  }\n  \n  // Sammle auch alle Quell-Keys die bereits verarbeitet wurden\n  for (const field of categoryConfig.technicalFields) {\n    processedKeys.add(normalizeFieldName(field.key));\n    processedKeys.add(normalizeFieldName(field.label));\n  }\n  \n  for (const key of Object.keys(structuredData)) {\n    const value = structuredData[key];\n    \n    // Skip bereits verarbeitete Felder (normalisiert vergleichen)\n    const normalizedKeyField = normalizeFieldName(key);\n    if (processedKeys.has(normalizedKeyField)) {\n      console.log(` Skipping ${key} (already processed as ${normalizedKeyField})`);\n      continue;\n    }\n    \n    // Skip Meta-Felder und Business-Daten (nur echte technische Spezifikationen erlauben)\n    const metaFields = [\n      'productname', 'produktname', 'bezeichnung', 'name',\n      'seoname', 'description', 'beschreibung', 'beschreibunglieferant',\n      'hersteller', 'manufacturer', 'brand', 'marke',\n      'artikelnummer', 'sku', 'modellnummer',\n      'kategorie', 'category',\n      'ean', 'gtin', 'barcode',\n      'preis', 'price', 'uvp', 'cost',\n      'lieferant', 'supplier', 'vendor',\n      'lagerbestand', 'stock', 'availability',\n      'bild', 'image', 'foto', 'picture',\n      'url', 'link', 'website',\n      'extractedtext', 'extracteddata', // Rohdaten von Vision/OCR - nicht als Tech Spec anzeigen\n    ];\n    \n    // Normalisiere Feldname: entferne Leerzeichen, Sonderzeichen, Unterstriche\n    const normalizedMetaKey = key.toLowerCase().replace(/[\\s()_-]/g, '');\n    \n    // Check exakte bereinstimmung\n    if (metaFields.includes(normalizedMetaKey)) {\n      console.log(` Skipping ${key} (meta/business field, normalized: ${normalizedMetaKey})`);\n      continue;\n    }\n    \n    // Check Teilstrings: \"beschreibung\" in beliebigem Kontext blockieren\n    if (normalizedMetaKey.includes('beschreibung') || \n        normalizedMetaKey.includes('description') ||\n        normalizedMetaKey.includes('lieferant') ||\n        normalizedMetaKey.includes('supplier')) {\n      console.log(` Skipping ${key} (contains description/supplier keyword)`);\n      continue;\n    }\n    \n    // Nur gltige Werte\n    if (!isValidValue(value)) {\n      console.log(` Skipping ${key} (invalid value: ${value})`);\n      continue;\n    }\n    \n    // Formatiere Feldnamen (z.B. \"capacity_mah\"  \"Kapazitt Mah\", \"Lnge mm\"  \"Lnge Mm\")\n    const formattedKey = formatFieldName(key);\n    specs[formattedKey] = value;\n    processedKeys.add(normalizedKeyField);\n    console.log(` 1:1 Dynamisches Feld: ${formattedKey} = ${value}`);\n  }\n  \n  return {\n    specs,\n    source: Object.keys(specs).length > 0 ? 'structured_data' : 'none',\n  };\n}\n\n/**\n * Kombinierte Extraktion: Strukturierte Daten > Text-Parsing\n */\nexport function extractTechSpecs1to1(\n  extractedText: string,\n  structuredData: any,\n  categoryConfig: ProductCategoryConfig\n): Record<string, string> {\n  // Prioritt 1: Strukturierte Daten (wenn vorhanden)\n  const structuredResult = extractTechSpecsFromStructured(structuredData, categoryConfig);\n  if (structuredResult.source !== 'none') {\n    console.log(` Using ${Object.keys(structuredResult.specs).length} specs from structured data`);\n    return structuredResult.specs;\n  }\n  \n  // Prioritt 2: Text-Parsing\n  const textResult = parseTechSpecsFromText(extractedText, categoryConfig);\n  if (textResult.source !== 'none') {\n    console.log(` Using ${Object.keys(textResult.specs).length} specs from text parsing`);\n    return textResult.specs;\n  }\n  \n  console.log(' No tech specs found in data');\n  return {};\n}\n\n/**\n * Normalisiert Feldnamen fr besseres Matching\n */\nfunction normalizeFieldName(name: string): string {\n  return name\n    .toLowerCase()\n    .trim()\n    .replace(/[]/g, match => {\n      const map: Record<string, string> = { '': 'a', '': 'o', '': 'u', '': 'ss' };\n      return map[match] || match;\n    })\n    .replace(/[^a-z0-9]/g, '');\n}\n\n/**\n * Prft, ob ein Wert gltig ist (nicht \"Nicht angegeben\" etc.)\n */\nfunction isValidValue(value: string): boolean {\n  if (!value || typeof value !== 'string') return false;\n  \n  const invalid = [\n    'nicht angegeben',\n    'nicht spezifiziert',\n    'nicht sichtbar',\n    'unbekannt',\n    'n/a',\n    'na',\n    'keine angabe',\n  ];\n  \n  const normalized = value.toLowerCase().trim();\n  return !invalid.includes(normalized) && normalized.length > 0;\n}\n\nfunction formatFieldName(key: string): string {\n  // Entferne Unterstriche und formatiere\n  let formatted = key.replace(/_/g, ' ');\n  \n  // Groschreibe ersten Buchstaben jedes Wortes\n  formatted = formatted.split(' ')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n    .join(' ');\n  \n  return formatted;\n}\n","size_bytes":9455},"server/templates/post-processor.ts":{"content":"/**\n * Post-Processing fr AI-generierten Content\n * Stellt sicher, dass AI-Output sauber und konsistent ist\n */\n\n// Blacklist: Generische Phrasen, die entfernt werden sollen\nconst GENERIC_PHRASE_BLACKLIST = [\n  'steht fr Qualitt, Zuverlssigkeit und Langlebigkeit',\n  'ideal fr den tglichen Einsatz',\n  'perfekte Wahl fr',\n  'hochwertiges Produkt fr professionelle Anwendungen',\n  'zeichnet sich durch zuverlssige Leistung',\n];\n\n// Regex-Patterns fr Cleanup\nconst CLEANUP_PATTERNS = [\n  { pattern: /^-\\s*/gm, replacement: '' },           // Fhrende Bindestriche\n  { pattern: /^\\*\\*\\s*/gm, replacement: '' },        // Markdown Bold-Marker\n  { pattern: /\\*\\*/g, replacement: '' },             // Alle Bold-Marker\n  { pattern: /^-\\s*\\*\\*\\s*/gm, replacement: '' },   // Kombinierte Marker\n  { pattern: /\\s{2,}/g, replacement: ' ' },          // Mehrfache Leerzeichen\n];\n\nexport interface ValidationResult {\n  isValid: boolean;\n  cleaned: string;\n  issues: string[];\n}\n\n/**\n * Validiert und bereinigt AI-generierten Narrative-Text\n */\nexport function validateNarrative(text: string): ValidationResult {\n  const issues: string[] = [];\n  let cleaned = text.trim();\n\n  // Cleanup Patterns anwenden\n  for (const { pattern, replacement } of CLEANUP_PATTERNS) {\n    cleaned = cleaned.replace(pattern, replacement);\n  }\n\n  // Blacklist-Phrasen entfernen\n  for (const phrase of GENERIC_PHRASE_BLACKLIST) {\n    if (cleaned.includes(phrase)) {\n      cleaned = cleaned.replace(phrase, '').trim();\n      issues.push(`Removed generic phrase: \"${phrase}\"`);\n    }\n  }\n\n  // Satzanzahl prfen (sollte 3-5 Stze sein)\n  const sentences = cleaned.split(/[.!?]+/).filter(s => s.trim().length > 0);\n  if (sentences.length < 2) {\n    issues.push('Too few sentences (minimum 2)');\n  } else if (sentences.length > 6) {\n    issues.push('Too many sentences (maximum 6)');\n  }\n\n  // Prfe auf produktspezifische Inhalte (mindestens eine Zahl oder spezifischer Begriff)\n  const hasSpecificContent = /\\d+\\s*(mAh|V|A|Wh|mm|g|kg|W)/.test(cleaned);\n  if (!hasSpecificContent) {\n    issues.push('No specific product data found (capacity, voltage, etc.)');\n  }\n\n  const isValid = issues.length === 0 || issues.every(i => i.startsWith('Removed'));\n\n  return {\n    isValid,\n    cleaned: cleaned.trim(),\n    issues,\n  };\n}\n\n/**\n * Validiert und bereinigt USP-Bullets\n */\nexport function validateUSPs(usps: string[]): ValidationResult {\n  const issues: string[] = [];\n  const cleaned = usps.map(usp => {\n    let clean = usp.trim();\n    \n    // Cleanup Patterns\n    for (const { pattern, replacement } of CLEANUP_PATTERNS) {\n      clean = clean.replace(pattern, replacement);\n    }\n    \n    // Entferne fhrende  falls vorhanden\n    clean = clean.replace(/^\\s*/, '');\n    \n    return clean;\n  }).filter(usp => usp.length > 0);\n\n  // Prfe Anzahl\n  if (cleaned.length < 5) {\n    issues.push(`Too few USPs: ${cleaned.length} (expected 5)`);\n  } else if (cleaned.length > 5) {\n    issues.push(`Too many USPs: ${cleaned.length} (expected 5)`);\n  }\n\n  // Prfe Lnge pro USP\n  cleaned.forEach((usp, idx) => {\n    if (usp.length > 100) {\n      issues.push(`USP ${idx + 1} too long: ${usp.length} chars`);\n    }\n    if (usp.length < 10) {\n      issues.push(`USP ${idx + 1} too short: ${usp.length} chars`);\n    }\n  });\n\n  const isValid = issues.length === 0;\n\n  return {\n    isValid,\n    cleaned: cleaned.join('|'), // Dummy fr string return\n    issues,\n  };\n}\n\n/**\n * Hauptfunktion: Validiert und bereinigt komplettes Produktcopy\n */\nexport function processProductCopy(copy: {\n  narrative: string;\n  uspBullets: string[];\n}): {\n  narrative: string;\n  uspBullets: string[];\n  validationIssues: string[];\n} {\n  const narrativeResult = validateNarrative(copy.narrative);\n  const uspResult = validateUSPs(copy.uspBullets);\n\n  const allIssues = [...narrativeResult.issues, ...uspResult.issues];\n\n  if (allIssues.length > 0) {\n    console.log(' Validation issues found:', allIssues);\n  }\n\n  return {\n    narrative: narrativeResult.cleaned,\n    uspBullets: copy.uspBullets.map(usp => {\n      let clean = usp.trim();\n      for (const { pattern, replacement } of CLEANUP_PATTERNS) {\n        clean = clean.replace(pattern, replacement);\n      }\n      return clean.replace(/^\\s*/, '');\n    }),\n    validationIssues: allIssues,\n  };\n}\n","size_bytes":4321},"client/src/pages/csv-bulk-description.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Upload, Download, FileText, CheckCircle2, Loader2, AlertTriangle, Settings2, FolderPlus, Sparkles, Eye } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { parseCSV } from \"@/lib/csv-processor\";\nimport type Papa from \"papaparse\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport { BulkDescriptionTable } from \"@/components/bulk-description-table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Dialog, \n  DialogContent, \n  DialogDescription, \n  DialogFooter, \n  DialogHeader, \n  DialogTitle \n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { useLocation } from \"wouter\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Project } from \"@shared/schema\";\n\ninterface RawCSVRow {\n  [key: string]: string;\n}\n\ninterface BulkProduct {\n  id: number;\n  artikelnummer: string;\n  produktname: string;\n  produktbeschreibung: string;\n  produktbeschreibung_html: string;\n  mediamarktname_v1: string;\n  mediamarktname_v2: string;\n  seo_titel?: string;\n  seo_beschreibung: string;\n  kurzbeschreibung: string;\n  ean?: string;\n  hersteller?: string;\n  preis?: string;\n  gewicht?: string;\n  kategorie?: string;\n}\n\ninterface ExportColumn {\n  key: string;\n  label: string;\n  enabled: boolean;\n}\n\nexport default function CSVBulkDescription() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [file, setFile] = useState<File | null>(null);\n  const [bulkProducts, setBulkProducts] = useState<BulkProduct[]>([]);\n  const [rawData, setRawData] = useState<RawCSVRow[]>([]);\n  const [processing, setProcessing] = useState(false);\n  const [error, setError] = useState<string>(\"\");\n  const [isDragging, setIsDragging] = useState(false);\n  const [successMessage, setSuccessMessage] = useState<string>(\"\");\n  const [parseWarnings, setParseWarnings] = useState<Papa.ParseError[]>([]);\n  const [showColumnSelector, setShowColumnSelector] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [showSaveDialog, setShowSaveDialog] = useState(false);\n  const [projectName, setProjectName] = useState(\"\");\n  const [savingProject, setSavingProject] = useState(false);\n  const [selectedProjectId, setSelectedProjectId] = useState<string>(\"new\");\n  const [showHtmlPreview, setShowHtmlPreview] = useState(false);\n  const [htmlPreviewContent, setHtmlPreviewContent] = useState(\"\");\n\n  // Lade bestehende Projekte\n  const { data: projectsData } = useQuery<{ success: boolean; projects: Project[] }>({\n    queryKey: ['/api/projects'],\n    enabled: showSaveDialog,\n  });\n\n  const existingProjects = projectsData?.projects || [];\n  \n  const [exportColumns, setExportColumns] = useState<ExportColumn[]>([\n    { key: 'artikelnummer', label: 'Artikelnummer', enabled: true },\n    { key: 'produktname', label: 'Produktname', enabled: true },\n    { key: 'produktbeschreibung', label: 'Produktbeschreibung_Text', enabled: false },\n    { key: 'produktbeschreibung_html', label: 'Produktbeschreibung_HTML', enabled: true },\n    { key: 'mediamarktname_v1', label: 'Mediamarktname_V1', enabled: true },\n    { key: 'mediamarktname_v2', label: 'Mediamarktname_V2', enabled: true },\n    { key: 'seo_beschreibung', label: 'SEO_Beschreibung', enabled: true },\n    { key: 'kurzbeschreibung', label: 'Kurzbeschreibung', enabled: true },\n  ]);\n\n  // SessionStorage Keys\n  const SESSION_KEY_PRODUCTS = 'csv-bulk-products';\n  const SESSION_KEY_RAW_DATA = 'csv-bulk-raw-data';\n  const SESSION_KEY_FILE_NAME = 'csv-bulk-file-name';\n\n  // Beim Laden der Komponente: Daten aus sessionStorage wiederherstellen\n  useEffect(() => {\n    const savedProducts = sessionStorage.getItem(SESSION_KEY_PRODUCTS);\n    const savedRawData = sessionStorage.getItem(SESSION_KEY_RAW_DATA);\n    const savedFileName = sessionStorage.getItem(SESSION_KEY_FILE_NAME);\n\n    if (savedProducts && savedRawData) {\n      try {\n        const products = JSON.parse(savedProducts);\n        const rawData = JSON.parse(savedRawData);\n        \n        setBulkProducts(products);\n        setRawData(rawData);\n        \n        if (savedFileName) {\n          setSuccessMessage(`${products.length} gespeicherte Produkte wiederhergestellt (${savedFileName})`);\n        }\n      } catch (error) {\n        console.error('Failed to restore session data:', error);\n        sessionStorage.removeItem(SESSION_KEY_PRODUCTS);\n        sessionStorage.removeItem(SESSION_KEY_RAW_DATA);\n        sessionStorage.removeItem(SESSION_KEY_FILE_NAME);\n      }\n    }\n  }, []);\n\n  // Bei nderungen: Daten in sessionStorage speichern\n  useEffect(() => {\n    if (bulkProducts.length > 0) {\n      sessionStorage.setItem(SESSION_KEY_PRODUCTS, JSON.stringify(bulkProducts));\n      sessionStorage.setItem(SESSION_KEY_RAW_DATA, JSON.stringify(rawData));\n      if (file) {\n        sessionStorage.setItem(SESSION_KEY_FILE_NAME, file.name);\n      }\n    }\n  }, [bulkProducts, rawData, file]);\n\n  const handleFileSelect = (selectedFile: File | null) => {\n    if (!selectedFile) return;\n\n    setFile(selectedFile);\n    setError(\"\");\n    setSuccessMessage(\"\");\n\n    const fileName = selectedFile.name.toLowerCase();\n    if (!fileName.endsWith('.csv')) {\n      setError('Bitte whlen Sie eine gltige CSV-Datei aus.');\n      return;\n    }\n\n    processFile(selectedFile);\n  };\n\n  const processFile = async (fileToProcess: File) => {\n    setProcessing(true);\n    setError(\"\");\n    setParseWarnings([]);\n    setBulkProducts([]);\n    setProgress(0);\n\n    try {\n      const parseResult = await parseCSV(fileToProcess);\n      \n      if (parseResult.data.length === 0) {\n        setError('Die CSV-Datei enthlt keine gltigen Daten.');\n        setProcessing(false);\n        return;\n      }\n\n      setRawData(parseResult.data);\n      setParseWarnings(parseResult.warnings);\n      setSuccessMessage(`${parseResult.data.length} Zeilen erfolgreich eingelesen`);\n      setProcessing(false);\n\n      // AI-Generierung wird NICHT automatisch gestartet - User muss Button klicken\n      \n    } catch (err) {\n      console.error('Verarbeitungsfehler:', err);\n      setError(err instanceof Error ? err.message : 'Fehler beim Verarbeiten der Datei');\n      setProcessing(false);\n    }\n  };\n\n  const startAIGeneration = async () => {\n    if (rawData.length === 0) {\n      setError('Keine Daten zum Verarbeiten vorhanden');\n      return;\n    }\n\n    setProcessing(true);\n    setError(\"\");\n    setProgress(0);\n    \n    try {\n      await generateDescriptions(rawData);\n    } catch (err) {\n      console.error('Generierungsfehler:', err);\n      setError(err instanceof Error ? err.message : 'Fehler bei der AI-Generierung');\n      setProcessing(false);\n    }\n  };\n\n  const generateDescriptions = async (data: RawCSVRow[]) => {\n    const BATCH_SIZE = 5;\n    const total = data.length;\n    const results: (BulkProduct | undefined)[] = new Array(total);\n    let processedCount = 0;\n\n    for (let i = 0; i < total; i += BATCH_SIZE) {\n      const batch = data.slice(i, Math.min(i + BATCH_SIZE, total));\n\n      const settled = await Promise.allSettled(\n        batch.map(async (row, batchIndex) => {\n          const globalIndex = i + batchIndex;\n          const productData: Record<string, string> = {};\n\n          Object.keys(row).forEach((key) => {\n            const normalizedKey = key.toLowerCase().replace(/\\s+/g, '_');\n            productData[normalizedKey] = row[key];\n          });\n\n          // Produktname aus verschiedenen mglichen Spalten lesen\n          const produktname =\n            productData.produktname ||\n            productData.bezeichnung ||\n            productData.name ||\n            row['Produktname'] ||\n            row['Bezeichnung'] ||\n            row['Name'] ||\n            row['produktname'] ||\n            row['bezeichnung'] ||\n            'Unbekanntes Produkt';\n\n          productData.productName = produktname;\n\n          const token = localStorage.getItem('supabase_token');\n          const response = await fetch('/api/generate-description', {\n            method: 'POST',\n            headers: { \n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify({\n              extractedData: [{ \n                extractedText: JSON.stringify(productData),\n                structuredData: productData  // Pass parsed CSV data for dynamic tech table\n              }],\n              customAttributes: { exactProductName: produktname },\n            }),\n          });\n\n          if (!response.ok) {\n            throw new Error(`API request failed (${response.status})`);\n          }\n\n          const payload = await response.json();\n          const plainText = stripHtml(payload.description || '');\n          const sentences = plainText\n            .split('.')\n            .filter((sentence) => sentence.trim().length > 10);\n          const seoDesc = sentences[0]\n            ? `${sentences[0].substring(0, 150)}${\n                sentences[0].length > 150 ? '...' : ''\n              }`\n            : '';\n          const shortDesc =\n            sentences.slice(0, 2).join('. ') + (sentences.length > 2 ? '.' : '');\n\n          // MediaMarkt V1: Produkt + Modell (z.B. \"Akkupack Mignon AA / LR6\")\n          // Verwende den Produktnamen, der bereits \"Produkt + Modell\" enthlt\n          const artikelnummer = productData.artikelnummer || row['Artikelnummer'] || '';\n          const mmNameV1 = produktname.trim();\n\n          // MediaMarkt V2: Nur Modellcodes (Grobuchstaben und Zahlen)\n          // Entferne Herstellerprfixe wie \"ANS-\" und behalte nur alphanumerische Codes\n          const mmNameV2 = artikelnummer.replace(/^[A-Z]+-/, '').trim();\n\n          return {\n            id: globalIndex + 1,\n            artikelnummer:\n              productData.modell ||\n              productData.artikelnummer ||\n              productData.sku ||\n              '-',\n            produktname: produktname,\n            produktbeschreibung: plainText,\n            produktbeschreibung_html: payload.description || '',\n            mediamarktname_v1: mmNameV1.substring(0, 60),\n            mediamarktname_v2: mmNameV2.substring(0, 40),\n            seo_beschreibung: seoDesc,\n            kurzbeschreibung: shortDesc.substring(0, 300),\n          } satisfies BulkProduct;\n        })\n      );\n\n      settled.forEach((outcome, batchIndex) => {\n        const globalIndex = i + batchIndex;\n        processedCount += 1;\n        setProgress(Math.round((processedCount / total) * 100));\n\n        if (outcome.status === 'fulfilled') {\n          results[globalIndex] = outcome.value;\n        } else {\n          console.error(`Error processing row ${globalIndex}:`, outcome.reason);\n          results[globalIndex] = {\n            id: globalIndex + 1,\n            artikelnummer: '-',\n            produktname: 'Fehler',\n            produktbeschreibung: '',\n            produktbeschreibung_html: '',\n            mediamarktname_v1: '',\n            mediamarktname_v2: '',\n            seo_beschreibung: '',\n            kurzbeschreibung: '',\n          } satisfies BulkProduct;\n        }\n      });\n    }\n\n    const completedResults = results.filter(Boolean) as BulkProduct[];\n    setBulkProducts(completedResults);\n    setSuccessMessage(`${completedResults.length} Produkte erfolgreich verarbeitet`);\n    setProgress(100);\n    setProcessing(false);\n  };\n\n  const stripHtml = (html: string): string => {\n    return html.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').trim();\n  };\n\n  const handleDrop = (e: React.DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    setIsDragging(false);\n    const droppedFile = e.dataTransfer.files[0];\n    if (droppedFile) {\n      handleFileSelect(droppedFile);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = () => {\n    setIsDragging(false);\n  };\n\n  const handleDownload = () => {\n    try {\n      const selectedColumns = exportColumns.filter(col => col.enabled);\n      \n      const headers = selectedColumns.map(col => col.label);\n      const rows = bulkProducts.map(product => {\n        return selectedColumns.map(col => {\n          const value = product[col.key as keyof BulkProduct];\n          return typeof value === 'string' ? value : String(value);\n        });\n      });\n\n      const csvContent = [\n        headers.join(';'),\n        ...rows.map(row => row.map(cell => `\"${cell.replace(/\"/g, '\"\"')}\"`).join(';'))\n      ].join('\\n');\n\n      const BOM = '\\uFEFF';\n      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n      const url = URL.createObjectURL(blob);\n      \n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `produktbeschreibungen_${new Date().toISOString().split('T')[0]}.csv`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n\n      toast({\n        title: \"Export erfolgreich\",\n        description: \"CSV-Datei wurde heruntergeladen\",\n      });\n    } catch (err) {\n      setError('Fehler beim Herunterladen der CSV-Datei');\n    }\n  };\n\n  const toggleColumn = (key: string) => {\n    setExportColumns(prev => \n      prev.map(col => col.key === key ? { ...col, enabled: !col.enabled } : col)\n    );\n  };\n\n  const toggleAllColumns = (enabled: boolean) => {\n    setExportColumns(prev => prev.map(col => ({ ...col, enabled })));\n  };\n\n  const handleUpdateProduct = (id: number, field: keyof BulkProduct, value: string) => {\n    setBulkProducts(prev =>\n      prev.map(product =>\n        product.id === id ? { ...product, [field]: value } : product\n      )\n    );\n  };\n\n  const reset = () => {\n    setFile(null);\n    setRawData([]);\n    setBulkProducts([]);\n    setError(\"\");\n    setSuccessMessage(\"\");\n    setProgress(0);\n    \n    // SessionStorage leeren\n    sessionStorage.removeItem(SESSION_KEY_PRODUCTS);\n    sessionStorage.removeItem(SESSION_KEY_RAW_DATA);\n    sessionStorage.removeItem(SESSION_KEY_FILE_NAME);\n  };\n\n  const handleSaveToProject = async () => {\n    // Wenn neues Projekt: Projektname erforderlich\n    if (selectedProjectId === \"new\" && !projectName.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie einen Projektnamen ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Wenn bestehendes Projekt: Projekt muss ausgewhlt sein\n    if (selectedProjectId !== \"new\" && !selectedProjectId) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte whlen Sie ein Projekt aus\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setSavingProject(true);\n    try {\n      if (selectedProjectId === \"new\") {\n        // Neues Projekt erstellen\n        await apiRequest('POST', '/api/bulk-save-to-project', {\n          projectName: projectName.trim(),\n          products: bulkProducts,\n        });\n        \n        toast({\n          title: \"Projekt gespeichert\",\n          description: `${bulkProducts.length} Produkte wurden erfolgreich in \"${projectName}\" gespeichert`,\n        });\n      } else {\n        // Zu bestehendem Projekt hinzufgen\n        const savedCount = await addProductsToExistingProject(selectedProjectId, bulkProducts);\n        const project = existingProjects.find(p => p.id === selectedProjectId);\n        \n        // Invalidate queries to refresh product counts\n        queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n        // Invalidate all product-counts queries\n        queryClient.invalidateQueries({ \n          predicate: (query) => \n            Array.isArray(query.queryKey) && \n            query.queryKey[0] === '/api/projects/product-counts'\n        });\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/products`] });\n        \n        toast({\n          title: \"Produkte hinzugefgt\",\n          description: `${savedCount} Produkte wurden erfolgreich zu \"${project?.name}\" hinzugefgt`,\n        });\n      }\n\n      // Invalidate queries for new project case as well\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      // Invalidate all product-counts queries\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === '/api/projects/product-counts'\n      });\n\n      setShowSaveDialog(false);\n      setProjectName(\"\");\n      setSelectedProjectId(\"new\");\n      \n      // Weiterleitung zu Projekten nach 1 Sekunde\n      setTimeout(() => {\n        setLocation('/projects');\n      }, 1000);\n      \n    } catch (err) {\n      toast({\n        title: \"Fehler\",\n        description: err instanceof Error ? err.message : 'Projekt konnte nicht gespeichert werden',\n        variant: \"destructive\",\n      });\n    } finally {\n      setSavingProject(false);\n    }\n  };\n\n  const addProductsToExistingProject = async (projectId: string, products: BulkProduct[]): Promise<number> => {\n    let savedCount = 0;\n    for (const product of products) {\n      const extractedDataArray = [\n        product.ean ? { key: 'ean', value: product.ean, type: 'text' as const } : null,\n        product.hersteller ? { key: 'hersteller', value: product.hersteller, type: 'text' as const } : null,\n        product.preis ? { key: 'preis', value: product.preis, type: 'text' as const } : null,\n        product.gewicht ? { key: 'gewicht', value: product.gewicht, type: 'text' as const } : null,\n        product.kategorie ? { key: 'kategorie', value: product.kategorie, type: 'text' as const } : null,\n      ].filter((item): item is { key: string; value: string; type: 'text' } => item !== null);\n\n      const productData = {\n        name: product.produktname || 'Unbekanntes Produkt',\n        articleNumber: product.artikelnummer || '',\n        htmlCode: product.produktbeschreibung || '',\n        previewText: product.seo_beschreibung || product.kurzbeschreibung || '',\n        exactProductName: product.mediamarktname_v1 || product.mediamarktname_v2 || product.produktname || '',\n        extractedData: extractedDataArray.length > 0 ? extractedDataArray : undefined,\n        customAttributes: [\n          { key: 'mediamarktname_v1', value: product.mediamarktname_v1 || '', type: 'text' },\n          { key: 'mediamarktname_v2', value: product.mediamarktname_v2 || '', type: 'text' },\n          { key: 'seo_titel', value: product.seo_titel || '', type: 'text' },\n          { key: 'seo_beschreibung', value: product.seo_beschreibung || '', type: 'text' },\n          { key: 'kurzbeschreibung', value: product.kurzbeschreibung || '', type: 'text' },\n        ].filter(attr => attr.value),\n      };\n\n      try {\n        await apiRequest('POST', `/api/projects/${projectId}/products`, productData);\n        savedCount++;\n      } catch (error) {\n        console.error('Failed to save product:', error);\n      }\n    }\n    return savedCount;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"sticky top-0 z-50 bg-card border-b border-card-border shadow-sm\">\n        <div className=\"max-w-[1600px] mx-auto px-6 py-6\">\n          <h1 className=\"text-3xl font-bold text-foreground mb-2\">\n            PIMPilot\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Automatische PIM-Daten Generierung  AI-gesttzte Produktbeschreibungen  MediaMarkt-konforme Titel  CSV Massenverarbeitung\n          </p>\n        </div>\n      </header>\n\n      <main className=\"max-w-[1600px] mx-auto px-6 py-8\">\n        {error && (\n          <Alert className=\"mb-6 bg-destructive/10 border-destructive text-destructive\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertDescription className=\"ml-2\">{error}</AlertDescription>\n          </Alert>\n        )}\n\n        {successMessage && (\n          <Alert className=\"mb-6 bg-chart-2/10 border-chart-2 text-chart-2\">\n            <CheckCircle2 className=\"h-4 w-4\" />\n            <AlertDescription className=\"ml-2\">{successMessage}</AlertDescription>\n          </Alert>\n        )}\n\n        {!file && !processing && bulkProducts.length === 0 && (\n          <Card\n            className={`p-8 transition-colors ${\n              isDragging ? 'border-primary bg-accent/50' : ''\n            }`}\n            onDrop={handleDrop}\n            onDragOver={handleDragOver}\n            onDragLeave={handleDragLeave}\n          >\n            <div className=\"flex flex-col items-center justify-center gap-6 min-h-[400px]\">\n              <div className=\"p-6 rounded-full bg-primary/10\">\n                <Upload className=\"w-12 h-12 text-primary\" />\n              </div>\n              <div className=\"text-center space-y-2\">\n                <h2 className=\"text-2xl font-semibold text-foreground\">\n                  CSV-Datei hochladen\n                </h2>\n                <p className=\"text-muted-foreground max-w-md\">\n                  Laden Sie Ihre Produktdaten-CSV hoch und generieren Sie automatisch vollstndige PIM-Attribute mit AI\n                </p>\n              </div>\n              <input\n                type=\"file\"\n                accept=\".csv\"\n                onChange={(e) => handleFileSelect(e.target.files?.[0] || null)}\n                className=\"hidden\"\n                id=\"file-upload\"\n              />\n              <label htmlFor=\"file-upload\">\n                <Button asChild size=\"lg\">\n                  <span className=\"cursor-pointer\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Datei auswhlen\n                  </span>\n                </Button>\n              </label>\n            </div>\n          </Card>\n        )}\n\n        {/* Schritt 1 & 2: CSV eingelesen - zeige Rohdaten + Live-Updates whrend AI-Generierung */}\n        {rawData.length > 0 && bulkProducts.length < rawData.length && (\n          <div className=\"space-y-6\">\n            {/* Button Card (nur wenn noch nicht gestartet) */}\n            {!processing && bulkProducts.length === 0 && (\n              <Card className=\"p-8\">\n                <div className=\"flex flex-col items-center justify-center gap-6\">\n                  <CheckCircle2 className=\"w-16 h-16 text-chart-2\" />\n                  <div className=\"text-center space-y-2\">\n                    <h2 className=\"text-2xl font-bold text-foreground\">\n                      CSV erfolgreich eingelesen\n                    </h2>\n                    <p className=\"text-lg text-muted-foreground\">\n                      {rawData.length} Produkte bereit zur Verarbeitung\n                    </p>\n                  </div>\n                  <Button\n                    size=\"lg\"\n                    onClick={startAIGeneration}\n                    className=\"px-8 py-6 text-lg\"\n                  >\n                    <Sparkles className=\"w-5 h-5 mr-2\" />\n                    AI Beschreibungen generieren ({rawData.length} Produkte)\n                  </Button>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Die AI-Generierung bentigt ca. {Math.round(rawData.length * 8 / 60)} Minuten\n                  </p>\n                </div>\n              </Card>\n            )}\n\n            {/* Progress Bar whrend Generierung */}\n            {processing && (\n              <Card className=\"p-6\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <Loader2 className=\"w-5 h-5 text-primary animate-spin\" />\n                      <div>\n                        <h3 className=\"text-sm font-semibold text-foreground\">\n                          PIM-Daten werden generiert...\n                        </h3>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {bulkProducts.length} von {rawData.length} Produkten fertig ({progress}%)\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"h-3 bg-muted rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-primary transition-all duration-300\"\n                      style={{ width: `${progress}%` }}\n                    />\n                  </div>\n                </div>\n              </Card>\n            )}\n\n            {/* CSV Rohdaten Vorschau mit Live KI-Updates */}\n            <Card className=\"p-6\">\n              <h3 className=\"text-lg font-semibold text-foreground mb-4\">\n                CSV Vorschau ({rawData.length} Zeilen) + KI-Felder {processing && ''}\n              </h3>\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse text-sm\">\n                  <thead>\n                    <tr className=\"bg-muted\">\n                      {/* CSV Spalten */}\n                      {Object.keys(rawData[0] || {}).map((header) => (\n                        <th\n                          key={header}\n                          className=\"px-4 py-3 text-left text-xs font-semibold text-foreground border-b border-border whitespace-nowrap\"\n                        >\n                          {header}\n                        </th>\n                      ))}\n                      {/* KI-generierte Spalten */}\n                      <th className=\"px-4 py-3 text-left text-xs font-semibold text-primary border-b border-border whitespace-nowrap bg-primary/10\">\n                         MediaMarkt V1\n                      </th>\n                      <th className=\"px-4 py-3 text-left text-xs font-semibold text-primary border-b border-border whitespace-nowrap bg-primary/10\">\n                         MediaMarkt V2\n                      </th>\n                      <th className=\"px-4 py-3 text-left text-xs font-semibold text-primary border-b border-border whitespace-nowrap bg-primary/10\">\n                         SEO Titel\n                      </th>\n                      <th className=\"px-4 py-3 text-left text-xs font-semibold text-primary border-b border-border whitespace-nowrap bg-primary/10\">\n                         SEO Produktbeschreibung\n                      </th>\n                      <th className=\"px-4 py-3 text-left text-xs font-semibold text-primary border-b border-border whitespace-nowrap bg-primary/10\">\n                         SEO Keywords\n                      </th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {rawData.slice(0, 10).map((row, index) => {\n                      // Finde entsprechendes generiertes Produkt (falls bereits generiert)\n                      const generatedProduct = bulkProducts.find(p => p.id === index + 1);\n                      \n                      return (\n                        <tr\n                          key={index}\n                          className={index % 2 === 0 ? 'bg-background' : 'bg-muted/30'}\n                        >\n                          {/* CSV Daten */}\n                          {Object.values(row).map((value, cellIndex) => (\n                            <td\n                              key={cellIndex}\n                              className=\"px-4 py-3 text-xs text-foreground border-b border-border\"\n                            >\n                              {value || '-'}\n                            </td>\n                          ))}\n                          {/* KI-Spalten (live update wenn generiert) */}\n                          <td className=\"px-4 py-3 text-xs border-b border-border bg-primary/5\">\n                            {generatedProduct ? (\n                              <span className=\"text-foreground font-medium\">{generatedProduct.mediamarktname_v1}</span>\n                            ) : (\n                              <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                            )}\n                          </td>\n                          <td className=\"px-4 py-3 text-xs border-b border-border bg-primary/5\">\n                            {generatedProduct ? (\n                              <span className=\"text-foreground font-medium\">{generatedProduct.mediamarktname_v2}</span>\n                            ) : (\n                              <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                            )}\n                          </td>\n                          <td className=\"px-4 py-3 text-xs border-b border-border bg-primary/5\">\n                            {generatedProduct ? (\n                              <span className=\"text-foreground font-medium line-clamp-1\">{generatedProduct.produktname}</span>\n                            ) : (\n                              <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                            )}\n                          </td>\n                          <td className=\"px-4 py-3 text-xs border-b border-border bg-primary/5\">\n                            {generatedProduct ? (\n                              <span className=\"text-foreground line-clamp-2\">{generatedProduct.seo_beschreibung}</span>\n                            ) : (\n                              <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                            )}\n                          </td>\n                          <td className=\"px-4 py-3 text-xs border-b border-border bg-primary/5\">\n                            {generatedProduct ? (\n                              <span className=\"text-foreground line-clamp-1\">{generatedProduct.kurzbeschreibung}</span>\n                            ) : (\n                              <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                            )}\n                          </td>\n                        </tr>\n                      );\n                    })}\n                  </tbody>\n                </table>\n              </div>\n              {rawData.length > 10 && (\n                <p className=\"text-sm text-muted-foreground mt-4 text-center\">\n                  Zeige erste 10 von {rawData.length} Zeilen\n                </p>\n              )}\n              <div className=\"mt-4 p-4 bg-primary/10 rounded-lg border border-primary/20\">\n                <p className=\"text-sm text-foreground flex items-center gap-2\">\n                  <Sparkles className=\"w-4 h-4 text-primary\" />\n                  <strong>KI-Felder (blau markiert)</strong> werden {processing ? 'live befllt' : 'nach Klick auf \"AI Beschreibungen generieren\" automatisch befllt'}\n                </p>\n              </div>\n            </Card>\n          </div>\n        )}\n\n        {bulkProducts.length > 0 && !processing && (\n          <div className=\"space-y-6\">\n            <Card className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-lg font-semibold text-foreground\">Verarbeitete Produkte</h2>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    <span className=\"font-medium text-foreground\">{bulkProducts.length}</span>  \n                    Dateiname: <span className=\"font-mono text-xs\">{file?.name}</span>\n                  </p>\n                </div>\n                <div className=\"flex gap-3\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setShowColumnSelector(!showColumnSelector)}\n                  >\n                    <Settings2 className=\"w-4 h-4 mr-2\" />\n                    Spalten auswhlen\n                  </Button>\n                  <Button\n                    onClick={() => setShowSaveDialog(true)}\n                    disabled={bulkProducts.length === 0}\n                    size=\"sm\"\n                    variant=\"default\"\n                  >\n                    <FolderPlus className=\"w-4 h-4 mr-2\" />\n                    Als Projekt speichern\n                  </Button>\n                  <Button\n                    onClick={handleDownload}\n                    disabled={bulkProducts.length === 0}\n                    size=\"sm\"\n                  >\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    CSV Exportieren\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={reset}\n                    size=\"sm\"\n                  >\n                    Zurcksetzen\n                  </Button>\n                </div>\n              </div>\n\n              {showColumnSelector && (\n                <div className=\"mt-6 p-4 bg-muted/30 rounded-lg border\">\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <h3 className=\"text-sm font-semibold\">Spalten fr Export auswhlen</h3>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => toggleAllColumns(true)}\n                      >\n                        Alle auswhlen\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => toggleAllColumns(false)}\n                      >\n                        Alle abwhlen\n                      </Button>\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    {exportColumns.map(col => (\n                      <div key={col.key} className=\"flex items-center space-x-2\">\n                        <Checkbox\n                          id={`col-${col.key}`}\n                          checked={col.enabled}\n                          onCheckedChange={() => toggleColumn(col.key)}\n                        />\n                        <Label\n                          htmlFor={`col-${col.key}`}\n                          className=\"text-sm font-medium cursor-pointer\"\n                        >\n                          {col.label}\n                        </Label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </Card>\n\n            <BulkDescriptionTable\n              products={bulkProducts}\n              onUpdateProduct={handleUpdateProduct}\n              onPreviewHtml={(html) => {\n                setHtmlPreviewContent(html);\n                setShowHtmlPreview(true);\n              }}\n            />\n          </div>\n        )}\n      </main>\n\n      {/* Dialog zum Projekt speichern */}\n      <Dialog open={showSaveDialog} onOpenChange={(open) => {\n        setShowSaveDialog(open);\n        if (!open) {\n          setProjectName(\"\");\n          setSelectedProjectId(\"new\");\n        }\n      }}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Als Projekt speichern</DialogTitle>\n            <DialogDescription>\n              Speichern Sie alle {bulkProducts.length} Produkte in \"Meine Projekte\" fr sptere Bearbeitung\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4 space-y-4\">\n            <div>\n              <Label htmlFor=\"project-select\" className=\"mb-2 block\">\n                Projekt whlen\n              </Label>\n              <Select\n                value={selectedProjectId}\n                onValueChange={setSelectedProjectId}\n                disabled={savingProject}\n              >\n                <SelectTrigger id=\"project-select\">\n                  <SelectValue placeholder=\"Projekt auswhlen...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"new\">\n                    <div className=\"flex items-center\">\n                      <FolderPlus className=\"w-4 h-4 mr-2\" />\n                      Neues Projekt erstellen\n                    </div>\n                  </SelectItem>\n                  {existingProjects.length > 0 && (\n                    <>\n                      <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n                        Bestehende Projekte\n                      </div>\n                      {existingProjects.map(project => (\n                        <SelectItem key={project.id} value={project.id}>\n                          {project.name}\n                        </SelectItem>\n                      ))}\n                    </>\n                  )}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {selectedProjectId === \"new\" && (\n              <div>\n                <Label htmlFor=\"project-name\" className=\"mb-2 block\">\n                  Name fr neues Projekt\n                </Label>\n                <Input\n                  id=\"project-name\"\n                  placeholder=\"z.B. Akku-Import November 2024\"\n                  value={projectName}\n                  onChange={(e) => setProjectName(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !savingProject) {\n                      handleSaveToProject();\n                    }\n                  }}\n                  disabled={savingProject}\n                />\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowSaveDialog(false);\n                setProjectName(\"\");\n                setSelectedProjectId(\"new\");\n              }}\n              disabled={savingProject}\n            >\n              Abbrechen\n            </Button>\n            <Button\n              onClick={handleSaveToProject}\n              disabled={savingProject || (selectedProjectId === \"new\" && !projectName.trim())}\n            >\n              {savingProject ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Speichere...\n                </>\n              ) : selectedProjectId === \"new\" ? (\n                <>\n                  <FolderPlus className=\"w-4 h-4 mr-2\" />\n                  Projekt erstellen\n                </>\n              ) : (\n                <>\n                  <FolderPlus className=\"w-4 h-4 mr-2\" />\n                  Zu Projekt hinzufgen\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog fr HTML-Vorschau */}\n      <Dialog open={showHtmlPreview} onOpenChange={setShowHtmlPreview}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle>HTML Produktbeschreibung Vorschau</DialogTitle>\n            <DialogDescription>\n              So wird die Produktbeschreibung im MediaMarkt-System dargestellt\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"overflow-auto max-h-[60vh] border rounded-lg p-6 bg-white\">\n            <div dangerouslySetInnerHTML={{ __html: htmlPreviewContent }} />\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":39499},"client/src/components/bulk-description-table.tsx":{"content":"import { useState } from \"react\";\nimport { Card } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft, ChevronRight, Eye } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\ninterface BulkProduct {\n  id: number;\n  artikelnummer: string;\n  produktname: string;\n  produktbeschreibung: string;\n  produktbeschreibung_html: string;\n  mediamarktname_v1: string;\n  mediamarktname_v2: string;\n  seo_beschreibung: string;\n  kurzbeschreibung: string;\n}\n\ninterface BulkDescriptionTableProps {\n  products: BulkProduct[];\n  onUpdateProduct: (id: number, field: keyof BulkProduct, value: string) => void;\n  onPreviewHtml?: (htmlContent: string) => void;\n}\n\nexport function BulkDescriptionTable({ products, onUpdateProduct, onPreviewHtml }: BulkDescriptionTableProps) {\n  const [currentPage, setCurrentPage] = useState(1);\n  const itemsPerPage = 6;\n\n  const totalPages = Math.ceil(products.length / itemsPerPage);\n  const startIndex = (currentPage - 1) * itemsPerPage;\n  const endIndex = startIndex + itemsPerPage;\n  const displayedProducts = products.slice(startIndex, endIndex);\n\n  const goToNextPage = () => {\n    if (currentPage < totalPages) {\n      setCurrentPage(prev => prev + 1);\n    }\n  };\n\n  const goToPreviousPage = () => {\n    if (currentPage > 1) {\n      setCurrentPage(prev => prev - 1);\n    }\n  };\n\n  return (\n    <Card className=\"overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <Table data-testid=\"table-products\">\n          <TableHeader className=\"sticky top-0 bg-background z-10\">\n            <TableRow>\n              <TableHead className=\"min-w-[140px]\">\n                Artikelnummer\n              </TableHead>\n              <TableHead className=\"min-w-[200px]\">\n                Produktname\n              </TableHead>\n              <TableHead className=\"min-w-[400px]\">\n                Produktbeschreibung Text\n              </TableHead>\n              <TableHead className=\"min-w-[500px]\">\n                Produktbeschreibung HTML\n              </TableHead>\n              <TableHead className=\"min-w-[300px]\">\n                MediaMarkt Titel V1\n              </TableHead>\n              <TableHead className=\"min-w-[250px]\">\n                MediaMarkt Titel V2\n              </TableHead>\n              <TableHead className=\"min-w-[300px]\">\n                SEO Beschreibung\n              </TableHead>\n              <TableHead className=\"min-w-[350px]\">\n                Kurzbeschreibung\n              </TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {displayedProducts.map((product) => (\n              <TableRow\n                key={product.id}\n                data-testid={`row-product-${product.id}`}\n              >\n                <TableCell>\n                  <span className=\"text-sm font-mono\" data-testid={`text-sku-${product.id}`}>\n                    {product.artikelnummer || '-'}\n                  </span>\n                </TableCell>\n                <TableCell>\n                  <TooltipProvider>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <p className=\"text-sm line-clamp-3\">\n                          {product.produktname || '-'}\n                        </p>\n                      </TooltipTrigger>\n                      {product.produktname && product.produktname.length > 50 && (\n                        <TooltipContent className=\"max-w-md\">\n                          <p className=\"text-xs\">{product.produktname}</p>\n                        </TooltipContent>\n                      )}\n                    </Tooltip>\n                  </TooltipProvider>\n                </TableCell>\n                <TableCell>\n                  <Textarea\n                    value={product.produktbeschreibung}\n                    onChange={(e) => onUpdateProduct(product.id, 'produktbeschreibung', e.target.value)}\n                    className=\"text-xs resize-none min-h-[100px] font-sans\"\n                    data-testid={`input-beschreibung-${product.id}`}\n                  />\n                </TableCell>\n                <TableCell>\n                  <div className=\"flex gap-2 items-start\">\n                    <Textarea\n                      value={product.produktbeschreibung_html}\n                      onChange={(e) => onUpdateProduct(product.id, 'produktbeschreibung_html', e.target.value)}\n                      className=\"text-xs resize-none min-h-[100px] font-mono flex-1\"\n                      data-testid={`input-beschreibung-html-${product.id}`}\n                    />\n                    {onPreviewHtml && product.produktbeschreibung_html && (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => onPreviewHtml(product.produktbeschreibung_html)}\n                        title=\"HTML Vorschau anzeigen\"\n                        className=\"mt-1 flex-shrink-0\"\n                      >\n                        <Eye className=\"w-4 h-4\" />\n                      </Button>\n                    )}\n                  </div>\n                </TableCell>\n                <TableCell>\n                  <Textarea\n                    value={product.mediamarktname_v1}\n                    onChange={(e) => onUpdateProduct(product.id, 'mediamarktname_v1', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans font-medium\"\n                    data-testid={`input-marktplatz-${product.id}`}\n                  />\n                </TableCell>\n                <TableCell>\n                  <Textarea\n                    value={product.mediamarktname_v2}\n                    onChange={(e) => onUpdateProduct(product.id, 'mediamarktname_v2', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans font-medium\"\n                    data-testid={`input-marktplatz-v2-${product.id}`}\n                  />\n                </TableCell>\n                <TableCell>\n                  <Textarea\n                    value={product.seo_beschreibung}\n                    onChange={(e) => onUpdateProduct(product.id, 'seo_beschreibung', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans\"\n                    data-testid={`input-seo-${product.id}`}\n                  />\n                </TableCell>\n                <TableCell>\n                  <Textarea\n                    value={product.kurzbeschreibung}\n                    onChange={(e) => onUpdateProduct(product.id, 'kurzbeschreibung', e.target.value)}\n                    className=\"text-sm resize-none min-h-[80px] font-sans\"\n                    data-testid={`input-kurz-${product.id}`}\n                  />\n                </TableCell>\n              </TableRow>\n            ))}\n          </TableBody>\n        </Table>\n      </div>\n      {/* Pagination Controls */}\n      {products.length > itemsPerPage && (\n        <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30\">\n          <div className=\"text-sm text-muted-foreground\">\n            Zeige {startIndex + 1} bis {Math.min(endIndex, products.length)} von {products.length} Produkten\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={goToPreviousPage}\n              disabled={currentPage === 1}\n            >\n              Zurck\n            </Button>\n            <div className=\"flex items-center gap-1\">\n              {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (\n                <Button\n                  key={page}\n                  variant={currentPage === page ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => setCurrentPage(page)}\n                  className=\"w-8 h-8 p-0\"\n                >\n                  {page}\n                </Button>\n              ))}\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={goToNextPage}\n              disabled={currentPage === totalPages}\n            >\n              Weiter\n            </Button>\n          </div>\n        </div>\n      )}\n    </Card>\n  );\n}\n","size_bytes":8498},"server/scraper-service.ts":{"content":"import * as cheerio from 'cheerio';\n\nexport interface LoginConfig {\n  loginUrl: string;\n  usernameField: string;\n  passwordField: string;\n  username: string;\n  password: string;\n  userAgent?: string;\n}\n\nexport interface ScraperSelectors {\n  articleNumber?: string;\n  productName?: string;\n  ean?: string;\n  manufacturer?: string;\n  price?: string;\n  priceGross?: string;  // Hndler-EK-Preis (Brutto)\n  rrp?: string;  // UVP / Empfohlener VK-Preis\n  description?: string;\n  longDescription?: string;  // Ausfhrliche Beschreibung\n  images?: string;\n  weight?: string;\n  dimensions?: string;  // Abmessungen (LBH)\n  category?: string;\n  length?: string;\n  bodyDiameter?: string;\n  headDiameter?: string;\n  weightWithoutBattery?: string;\n  totalWeight?: string;\n  powerSupply?: string;\n  led1?: string;\n  led2?: string;\n  spotIntensity?: string;\n  maxLuminosity?: string;\n  maxBeamDistance?: string;\n}\n\nexport interface ScrapedProduct {\n  articleNumber: string;  // Brickfox Article Number (ANS + manufacturer number)\n  manufacturerArticleNumber?: string;  // Original manufacturer article number\n  productName: string;\n  ean?: string;\n  manufacturer?: string;\n  price?: string;\n  priceGross?: string;  // Hndler-EK-Preis (Brutto)\n  rrp?: string;  // UVP / Empfohlener VK-Preis\n  ekPrice?: string;  // Einkaufspreis (Purchase Price)\n  vkPrice?: string;  // Verkaufspreis (Sales Price) - calculated as EK * 2.38, rounded to .95\n  description?: string;\n  longDescription?: string;  // Ausfhrliche Beschreibung\n  images: string[];\n  weight?: string;\n  dimensions?: string;  // Abmessungen (LBH)\n  category?: string;\n  length?: string;\n  bodyDiameter?: string;\n  headDiameter?: string;\n  weightWithoutBattery?: string;\n  totalWeight?: string;\n  powerSupply?: string;\n  led1?: string;\n  led2?: string;\n  spotIntensity?: string;\n  maxLuminosity?: string;\n  maxBeamDistance?: string;\n  pdfManualUrl?: string;\n  safetyWarnings?: string;\n  rawHtml?: string;\n  technicalDataTable?: string;\n  autoExtractedDescription?: string;\n}\n\nexport interface ScrapeOptions {\n  url: string;\n  selectors: ScraperSelectors;\n  userAgent?: string;\n  cookies?: string;\n  timeout?: number;\n}\n\n/**\n * Login to a website and retrieve session cookies\n * Sends login form data and captures cookies from response\n */\nexport async function performLogin(config: LoginConfig): Promise<string> {\n  const {\n    loginUrl,\n    usernameField,\n    passwordField,\n    username,\n    password,\n    userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'\n  } = config;\n\n  console.log(`[Login] Attempting login to ${loginUrl}`);\n\n  try {\n    // Prepare form data\n    const formData = new URLSearchParams();\n    formData.append(usernameField, username);\n    formData.append(passwordField, password);\n\n    // Send POST request with credentials\n    const response = await fetch(loginUrl, {\n      method: 'POST',\n      headers: {\n        'User-Agent': userAgent,\n        'Content-Type': 'application/x-www-form-urlencoded',\n        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n        'Accept-Language': 'de,en-US;q=0.7,en;q=0.3'\n      },\n      body: formData.toString(),\n      redirect: 'manual' // Don't follow redirects automatically\n    });\n\n    // Extract cookies from Set-Cookie headers\n    const setCookieHeaders = response.headers.getSetCookie();\n    \n    if (!setCookieHeaders || setCookieHeaders.length === 0) {\n      console.log('[Login] No cookies received from login response');\n      return '';\n    }\n\n    // Parse cookies and build cookie string\n    const cookies = setCookieHeaders.map(cookie => {\n      // Extract cookie name and value (before first semicolon)\n      const match = cookie.match(/^([^=]+)=([^;]+)/);\n      return match ? `${match[1]}=${match[2]}` : '';\n    }).filter(c => c).join('; ');\n\n    console.log(`[Login] Successfully obtained ${setCookieHeaders.length} cookies`);\n    return cookies;\n  } catch (error) {\n    console.error('[Login] Login failed:', error);\n    throw new Error(`Login failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n/**\n * Extract dealer price from analytics JSON embedded in HTML\n * Searches <script> tags for Google Analytics/Tag Manager data with price information\n * Returns price in German format (e.g., \"87,50\") or undefined if not found\n */\nfunction extractDealerPriceFromAnalytics(html: string, articleNumber?: string): string | undefined {\n  try {\n    const $ = cheerio.load(html);\n    \n    // Search all script tags for analytics data\n    const scriptTags = $('script');\n    \n    for (let i = 0; i < scriptTags.length; i++) {\n      const scriptContent = $(scriptTags[i]).html();\n      if (!scriptContent) continue;\n      \n      // Look for JSON patterns containing \"price\" field\n      // Common patterns: dataLayer.push(...), gtag(...), window.dataLayer = [...]\n      const jsonPatterns = [\n        /\"price\":\\s*([0-9.]+)/g,  // Simple: \"price\":87.5\n        /\\{\"price\":([0-9.]+),\"index\":/g,  // GA4 ecommerce items\n      ];\n      \n      for (const pattern of jsonPatterns) {\n        const matches = Array.from(scriptContent.matchAll(pattern));\n        \n        for (const match of matches) {\n          const priceValue = parseFloat(match[1]);\n          if (!isNaN(priceValue) && priceValue > 0) {\n            // Additional validation: if articleNumber provided, check if it's nearby in the JSON\n            if (articleNumber) {\n              const contextStart = Math.max(0, match.index! - 200);\n              const contextEnd = Math.min(scriptContent.length, match.index! + 200);\n              const context = scriptContent.substring(contextStart, contextEnd);\n              \n              // Check if article number appears in the same JSON object\n              if (context.includes(`\"item_id\":\"${articleNumber}\"`)) {\n                const germanPrice = priceValue.toFixed(2).replace('.', ',');\n                console.log(`[Analytics Price] Found dealer price for ${articleNumber}: ${germanPrice}`);\n                return germanPrice;\n              }\n            } else {\n              // No article number validation, return first valid price found\n              const germanPrice = priceValue.toFixed(2).replace('.', ',');\n              console.log(`[Analytics Price] Found dealer price: ${germanPrice}`);\n              return germanPrice;\n            }\n          }\n        }\n      }\n    }\n    \n    console.log('[Analytics Price] No dealer price found in analytics data');\n    return undefined;\n  } catch (error) {\n    console.log('[Analytics Price] Error extracting price:', error);\n    return undefined;\n  }\n}\n\n/**\n * Helper function: Convert measurement to German format (comma, no units)\n * Automatically converts to millimeters (mm) for length measurements\n * Examples: \n *   \"250g\"  \"250\", \"1.5kg\"  \"1,5\"\n *   \"120mm\"  \"120\", \"12cm\"  \"120\", \"1.5m\"  \"1500\"\n */\nfunction formatMeasurement(text: string): string {\n  if (!text) return '';\n  \n  // Extract numeric portion and detect unit\n  const match = text.match(/([\\d,.]+)\\s*([a-zA-Z]+)?/);\n  if (!match) return '';\n  \n  let value = match[1];\n  const unit = match[2]?.toLowerCase() || '';\n  \n  // Normalize to internal format (dot as decimal separator)\n  const hasComma = value.includes(',');\n  const hasDot = value.includes('.');\n  \n  if (hasComma && hasDot) {\n    const lastComma = value.lastIndexOf(',');\n    const lastDot = value.lastIndexOf('.');\n    \n    if (lastComma > lastDot) {\n      // German format: 1.234,56  1234.56\n      value = value.replace(/\\./g, '').replace(',', '.');\n    } else {\n      // English format: 1,234.56  1234.56\n      value = value.replace(/,/g, '');\n    }\n  } else if (hasComma && !hasDot) {\n    // Only comma: convert to dot (e.g., 0,25  0.25)\n    value = value.replace(',', '.');\n  }\n  // If only dot or neither: keep as is\n  \n  // Convert to number for unit conversion\n  let numValue = parseFloat(value);\n  \n  // Convert length units to millimeters (mm)\n  if (unit === 'cm' || unit === 'zentimeter') {\n    numValue = numValue * 10; // cm  mm\n  } else if (unit === 'm' || unit === 'meter') {\n    numValue = numValue * 1000; // m  mm\n  } else if (unit === 'km' || unit === 'kilometer') {\n    numValue = numValue * 1000000; // km  mm\n  }\n  \n  // Convert weight units to grams (g)\n  else if (unit === 'kg' || unit === 'kilogramm') {\n    numValue = numValue * 1000; // kg  g\n  } else if (unit === 't' || unit === 'tonne') {\n    numValue = numValue * 1000000; // t  g\n  }\n  // mm and g stay as is\n  \n  // Convert back to string with German format (comma as decimal separator)\n  const formattedValue = numValue.toString().replace('.', ',');\n  \n  return formattedValue;\n}\n\n/**\n * Scrape product data from a URL using custom CSS selectors\n * Similar to PHP DomCrawler approach\n */\nexport async function scrapeProduct(options: ScrapeOptions): Promise<ScrapedProduct> {\n  const {\n    url,\n    selectors,\n    userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n    cookies,\n    timeout = 10000\n  } = options;\n\n  console.log(`Scraping URL: ${url}`);\n\n  // Fetch HTML with custom headers (like PHP stream_context_create)\n  const headers: Record<string, string> = {\n    'User-Agent': userAgent,\n    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n    'Accept-Language': 'de,en-US;q=0.7,en;q=0.3'\n  };\n\n  if (cookies) {\n    headers['Cookie'] = cookies;\n  }\n\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n  let html: string;\n  try {\n    const response = await fetch(url, {\n      headers,\n      signal: controller.signal\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    html = await response.text();\n  } catch (error) {\n    if (error instanceof Error && error.name === 'AbortError') {\n      throw new Error(`Request timeout after ${timeout}ms`);\n    }\n    throw error;\n  } finally {\n    clearTimeout(timeoutId);\n  }\n\n  console.log(`HTML fetched, length: ${html.length} characters`);\n\n  // Parse with Cheerio (equivalent to Symfony DomCrawler)\n  const $ = cheerio.load(html);\n\n  // Extract data using CSS selectors\n  const product: ScrapedProduct = {\n    articleNumber: '',\n    productName: '',\n    images: []\n  };\n\n  // Detect supplier from URL\n  const isANSMANN = url.includes('pim.ansmann.de');\n  const isNitecore = url.includes('nitecore.de');\n  \n  // Article Number / SKU (support both 'articleNumber' and 'productCode')\n  const articleSelector = (selectors as any).productCode || selectors.articleNumber;\n  if (articleSelector) {\n    const element = $(articleSelector).first();\n    let manufacturerNumber = element.text().trim() || element.attr('content')?.trim() || '';\n    \n    // Keep original format with hyphens (e.g., \"2447-3049-60\")\n    // DO NOT remove hyphens - required for Pixi ERP matching!\n    \n    // Store manufacturer article number (keep original format)\n    product.manufacturerArticleNumber = manufacturerNumber;\n    \n    // Generate Brickfox article number based on supplier\n    if (manufacturerNumber) {\n      if (isANSMANN) {\n        // ANSMANN: ANS + manufacturer number\n        product.articleNumber = 'ANS' + manufacturerNumber;\n        console.log(` [ANSMANN] Generated Article Number: ${product.articleNumber} (from ${manufacturerNumber})`);\n      } else if (isNitecore) {\n        // Nitecore: Use manufacturer number as-is (no prefix)\n        product.articleNumber = manufacturerNumber;\n        console.log(` [Nitecore] Using Article Number: ${product.articleNumber}`);\n      } else {\n        // Generic: Use manufacturer number as-is\n        product.articleNumber = manufacturerNumber;\n        console.log(` [Generic] Using Article Number: ${product.articleNumber}`);\n      }\n    } else {\n      product.articleNumber = '';\n    }\n  }\n\n  // Product Name\n  if (selectors.productName) {\n    const element = $(selectors.productName).first();\n    product.productName = element.text().trim() || element.attr('content')?.trim() || '';\n  }\n\n  // EAN / Barcode\n  if (selectors.ean) {\n    const element = $(selectors.ean).first();\n    product.ean = element.text().trim() || element.attr('content')?.trim() || '';\n    \n    // Fallback: Search for 13-digit number in HTML (like PHP regex)\n    if (!product.ean) {\n      const eanMatch = html.match(/\"\\d{13}\"/);\n      if (eanMatch) {\n        product.ean = eanMatch[0].replace(/\"/g, '');\n      }\n    }\n  }\n\n  // Manufacturer / Brand\n  if (selectors.manufacturer) {\n    const element = $(selectors.manufacturer).first();\n    // Try text first, then common attributes (content, alt, title, data-brand)\n    product.manufacturer = element.text().trim() \n      || element.attr('content')?.trim() \n      || element.attr('alt')?.trim() \n      || element.attr('title')?.trim() \n      || element.attr('data-brand')?.trim() \n      || '';\n  }\n  \n  // Auto-detect manufacturer from URL for ANSMANN\n  if (!product.manufacturer && url.includes('pim.ansmann.de')) {\n    product.manufacturer = 'ANSMANN';\n  }\n\n  // Price - Try analytics JSON extraction first (for dealer prices when logged in)\n  let priceFound = false;\n  if (cookies) {\n    // When logged in, try to extract dealer price from analytics JSON first\n    const analyticsPrice = extractDealerPriceFromAnalytics(html, product.articleNumber);\n    if (analyticsPrice) {\n      product.price = analyticsPrice;\n      priceFound = true;\n      console.log(` Using dealer price from analytics: ${analyticsPrice}`);\n    }\n  }\n\n  // Fallback to CSS selector if analytics extraction didn't find a price\n  if (!priceFound && selectors.price) {\n    const element = $(selectors.price).first();\n    let priceText = element.text().trim() || element.attr('content')?.trim() || '';\n    \n    if (priceText) {\n      // Step 1: Extract only the numeric portion with separators\n      const numericMatch = priceText.match(/[\\d,.]+/);\n      if (numericMatch) {\n        priceText = numericMatch[0];\n      } else {\n        priceText = '';\n      }\n      \n      if (priceText) {\n        // Step 2: Normalize to English format (dot as decimal separator)\n        const hasComma = priceText.includes(',');\n        const hasDot = priceText.includes('.');\n        \n        if (hasComma && hasDot) {\n          // Both present: last one is decimal separator\n          const lastComma = priceText.lastIndexOf(',');\n          const lastDot = priceText.lastIndexOf('.');\n          \n          if (lastComma > lastDot) {\n            // German format: 1.234,56 -> convert to English\n            priceText = priceText.replace(/\\./g, ''); // Remove thousands separators (dots)\n            priceText = priceText.replace(',', '.'); // Convert decimal comma to dot\n          } else {\n            // English format: 1,234.56 -> keep dot, remove comma\n            priceText = priceText.replace(/,/g, ''); // Remove thousands separators (commas)\n          }\n        } else if (hasDot && !hasComma) {\n          // Only dot: check if it's thousands separator or decimal\n          const dotParts = priceText.split('.');\n          if (dotParts.length === 2 && dotParts[1].length <= 2) {\n            // Likely decimal: 89.90 -> keep as is\n          } else {\n            // Likely thousands separator: 1.234 -> 1234\n            priceText = priceText.replace(/\\./g, '');\n          }\n        } else if (hasComma && !hasDot) {\n          // Only comma: check if it's thousands separator or decimal\n          const commaParts = priceText.split(',');\n          if (commaParts.length === 2 && commaParts[1].length <= 2) {\n            // Likely decimal: 89,90 -> convert to 89.90\n            priceText = priceText.replace(',', '.');\n          } else {\n            // Likely thousands separator: 1,234 -> 1234\n            priceText = priceText.replace(/,/g, '');\n          }\n        }\n        \n        // Step 3: Ensure exactly 2 decimal places\n        if (!priceText.includes('.')) {\n          // No decimals: add .00\n          priceText = priceText + '.00';\n        } else {\n          const parts = priceText.split('.');\n          if (parts[1]) {\n            // Pad or truncate to exactly 2 decimals\n            parts[1] = parts[1].padEnd(2, '0').substring(0, 2);\n          } else {\n            parts[1] = '00';\n          }\n          priceText = parts.join('.');\n        }\n        \n        // Step 4: Convert to German format (comma instead of dot)\n        priceText = priceText.replace('.', ',');\n      }\n    }\n    \n    product.price = priceText;\n  }\n\n  // Description (can be HTML)\n  if (selectors.description) {\n    const element = $(selectors.description).first();\n    product.description = element.html()?.trim() || element.text().trim() || '';\n  }\n\n  // Long Description (ausfhrliche Beschreibung)\n  if (selectors.longDescription) {\n    const element = $(selectors.longDescription).first();\n    product.longDescription = element.html()?.trim() || element.text().trim() || '';\n  }\n\n  // Price Gross (Hndler-EK-Preis Brutto)\n  if (selectors.priceGross) {\n    const element = $(selectors.priceGross).first();\n    let priceText = element.text().trim() || element.attr('content')?.trim() || '';\n    if (priceText) {\n      const numericMatch = priceText.match(/[\\d,.]+/);\n      if (numericMatch) {\n        priceText = numericMatch[0];\n        // Convert to German format with comma\n        if (priceText.includes('.') && !priceText.includes(',')) {\n          priceText = priceText.replace('.', ',');\n        }\n      }\n    }\n    product.priceGross = priceText;\n  }\n\n  // RRP / UVP (Empfohlener Verkaufspreis)\n  if (selectors.rrp) {\n    const element = $(selectors.rrp).first();\n    let priceText = element.text().trim() || element.attr('content')?.trim() || '';\n    if (priceText) {\n      const numericMatch = priceText.match(/[\\d,.]+/);\n      if (numericMatch) {\n        priceText = numericMatch[0];\n        // Convert to German format with comma\n        if (priceText.includes('.') && !priceText.includes(',')) {\n          priceText = priceText.replace('.', ',');\n        }\n      }\n    }\n    product.rrp = priceText;\n  }\n\n  // Dimensions (Abmessungen)\n  if (selectors.dimensions) {\n    const element = $(selectors.dimensions).first();\n    product.dimensions = element.text().trim() || '';\n  }\n\n  // Images (support both 'images' and 'image')\n  const imageSelector = (selectors as any).image || selectors.images;\n  if (imageSelector) {\n    const imageElements = $(imageSelector);\n    product.images = imageElements.map((_, el) => {\n      const $el = $(el);\n      // Try src, data-src, href\n      const src = $el.attr('src') || $el.attr('data-src') || $el.attr('href') || '';\n      return src.trim();\n    }).get().filter(Boolean);\n  }\n\n  // ANSMANN/Magento: ALWAYS try to extract gallery images from JSON (Magento stores all images in JSON)\n  // CRITICAL FIX: Don't skip this even if we found 1 image - Magento always has multiple images in JSON\n  try {\n    // Find Magento gallery init script\n    const scripts = $('script[type=\"text/x-magento-init\"]');\n    let foundMagentoGallery = false;\n    \n    scripts.each((_, scriptEl) => {\n      const scriptContent = $(scriptEl).html();\n      if (scriptContent && scriptContent.includes('mage/gallery/gallery')) {\n        try {\n          const json = JSON.parse(scriptContent);\n          // Find the gallery config\n          for (const key of Object.keys(json)) {\n            if (json[key]['mage/gallery/gallery']) {\n              const gallery = json[key]['mage/gallery/gallery'];\n              if (gallery.data && Array.isArray(gallery.data)) {\n                const galleryImages = gallery.data\n                  .map((img: any) => img.full || img.img || img.thumb)\n                  .filter(Boolean);\n                \n                if (galleryImages.length > 0) {\n                  product.images = galleryImages;\n                  console.log(`[Magento Gallery]  Extracted ${galleryImages.length} images from JSON`);\n                  foundMagentoGallery = true;\n                  return false; // Break the loop\n                }\n              }\n            }\n          }\n        } catch (parseError) {\n          // Silent fail - continue with other scripts\n        }\n      }\n    });\n    \n    if (!foundMagentoGallery && product.images && product.images.length > 0) {\n      console.log(`[Magento Gallery]   No Magento gallery found, using ${product.images.length} images from CSS selectors`);\n    }\n  } catch (error) {\n    console.error('[Magento Gallery] Error parsing gallery JSON:', error);\n  }\n\n  // ANSMANN: Extract high-resolution images AND PDFs from Downloads tab\n  // The Downloads tab contains JPG files and PDF manuals (MSDS, PIB, Bedienungsanleitung)\n  try {\n    const downloadImages: string[] = [];\n    const downloadPdfs: string[] = [];\n    \n    // Find all links in the Downloads tab that point to image files\n    $('#product-info-downloads a[href$=\".jpg\"], #product-info-downloads a[href$=\".JPG\"], #product-info-downloads a[href$=\".png\"], #product-info-downloads a[href$=\".PNG\"]').each((_, link) => {\n      const href = $(link).attr('href');\n      if (href && href.startsWith('http')) {\n        downloadImages.push(href);\n      }\n    });\n    \n    // Find all links in the Downloads tab that point to PDF files\n    $('#product-info-downloads a[href$=\".pdf\"], #product-info-downloads a[href$=\".PDF\"]').each((_, link) => {\n      const href = $(link).attr('href');\n      const text = $(link).text().trim().toLowerCase();\n      if (href && href.startsWith('http')) {\n        downloadPdfs.push(href);\n      }\n    });\n    \n    // If we found download images, prefer them over gallery images (higher quality!)\n    if (downloadImages.length > 0) {\n      console.log(`[ANSMANN Downloads]  Extracted ${downloadImages.length} high-res images from Downloads tab`);\n      // Merge with existing gallery images, prioritizing download images (remove duplicates)\n      const allImages = [...downloadImages, ...(product.images || [])];\n      product.images = Array.from(new Set(allImages)); // Remove duplicates\n      console.log(`[ANSMANN Downloads]   Total unique images: ${product.images.length}`);\n    }\n    \n    // Store PDFs for Brickfox export (MSDS, Manuals, etc.)\n    if (downloadPdfs.length > 0) {\n      (product as any).pdfFiles = downloadPdfs;\n      console.log(`[ANSMANN Downloads]  Extracted ${downloadPdfs.length} PDF files from Downloads tab`);\n    }\n  } catch (error) {\n    console.error('[ANSMANN Downloads] Error extracting download files:', error);\n  }\n\n  // Weight - Format for Brickfox: German format with comma, NO units (e.g., 250 or 1,5)\n  if (selectors.weight) {\n    const element = $(selectors.weight).first();\n    let weightText = element.text().trim() || '';\n    \n    // Fallback: Search for \"gewicht: XXXg\" in HTML\n    if (!weightText) {\n      const weightMatch = html.match(/gewicht:\\s*([\\d,\\.]+)\\s*[gk]/i);\n      if (weightMatch) {\n        weightText = weightMatch[1];\n      }\n    }\n    \n    if (weightText) {\n      product.weight = formatMeasurement(weightText);\n    }\n  }\n\n  // Category (use .last() to get the most specific category from breadcrumb)\n  if (selectors.category) {\n    const elements = $(selectors.category);\n    // Take the last element (most specific category) and skip \"Home\" / \"Startseite\"\n    let categoryText = '';\n    \n    if (elements.length > 0) {\n      // Try from last to first, skip common navigation items\n      for (let i = elements.length - 1; i >= 0; i--) {\n        const text = $(elements[i]).text().trim();\n        const lowerText = text.toLowerCase();\n        \n        // Skip common navigation items\n        if (lowerText && \n            lowerText !== 'home' && \n            lowerText !== 'startseite' &&\n            lowerText !== 'sie sind hier' &&\n            !lowerText.includes('') &&\n            !lowerText.includes('>')) {\n          categoryText = text;\n          break;\n        }\n      }\n    }\n    \n    product.category = categoryText;\n  }\n\n  // Nitecore Technical Fields - extract and format measurements (German format, no units)\n  if (selectors.length) {\n    const element = $(selectors.length).first();\n    product.length = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.bodyDiameter) {\n    const element = $(selectors.bodyDiameter).first();\n    product.bodyDiameter = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.headDiameter) {\n    const element = $(selectors.headDiameter).first();\n    product.headDiameter = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.weightWithoutBattery) {\n    const element = $(selectors.weightWithoutBattery).first();\n    product.weightWithoutBattery = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.totalWeight) {\n    const element = $(selectors.totalWeight).first();\n    product.totalWeight = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.powerSupply) {\n    const element = $(selectors.powerSupply).first();\n    product.powerSupply = element.text().trim() || '';\n  }\n\n  if (selectors.led1) {\n    const element = $(selectors.led1).first();\n    product.led1 = element.text().trim() || '';\n  }\n\n  if (selectors.led2) {\n    const element = $(selectors.led2).first();\n    product.led2 = element.text().trim() || '';\n  }\n\n  if (selectors.spotIntensity) {\n    const element = $(selectors.spotIntensity).first();\n    product.spotIntensity = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.maxLuminosity) {\n    const element = $(selectors.maxLuminosity).first();\n    product.maxLuminosity = formatMeasurement(element.text().trim());\n  }\n\n  if (selectors.maxBeamDistance) {\n    const element = $(selectors.maxBeamDistance).first();\n    product.maxBeamDistance = formatMeasurement(element.text().trim());\n  }\n\n  // ANSMANN Technical Fields - extract and format measurements (German format, no units)\n  if ((selectors as any).nominalspannung) {\n    const element = $((selectors as any).nominalspannung).first();\n    const rawValue = element.text().trim();\n    (product as any).nominalspannung = formatMeasurement(rawValue);\n    if (rawValue) console.log(` Extracted Nominalspannung: ${rawValue}  ${(product as any).nominalspannung}`);\n  }\n\n  if ((selectors as any).nominalkapazitaet) {\n    const element = $((selectors as any).nominalkapazitaet).first();\n    const rawValue = element.text().trim();\n    (product as any).nominalkapazitaet = formatMeasurement(rawValue);\n    if (rawValue) console.log(` Extracted Nominalkapazitt: ${rawValue}  ${(product as any).nominalkapazitaet}`);\n  }\n\n  if ((selectors as any).maxEntladestrom) {\n    const element = $((selectors as any).maxEntladestrom).first();\n    const rawValue = element.text().trim();\n    (product as any).maxEntladestrom = formatMeasurement(rawValue);\n    if (rawValue) console.log(` Extracted max. Entladestrom: ${rawValue}  ${(product as any).maxEntladestrom}`);\n  }\n  \n  // Fallback: Extract max. Entladestrom from description if not found via selector\n  if (!(product as any).maxEntladestrom || (product as any).maxEntladestrom === '') {\n    const entladestromMatch = html.match(/max\\.\\s*entladestrom[:\\s]+([\\d.,]+)\\s*a/i);\n    if (entladestromMatch) {\n      (product as any).maxEntladestrom = formatMeasurement(entladestromMatch[1]);\n      console.log(` Extracted max. Entladestrom from description: ${(product as any).maxEntladestrom}`);\n    }\n  }\n\n  if ((selectors as any).laenge) {\n    const element = $((selectors as any).laenge).first();\n    (product as any).laenge = formatMeasurement(element.text().trim());\n  }\n\n  if ((selectors as any).breite) {\n    const element = $((selectors as any).breite).first();\n    (product as any).breite = formatMeasurement(element.text().trim());\n  }\n\n  if ((selectors as any).hoehe) {\n    const element = $((selectors as any).hoehe).first();\n    (product as any).hoehe = formatMeasurement(element.text().trim());\n  }\n\n  if ((selectors as any).gewicht) {\n    const element = $((selectors as any).gewicht).first();\n    (product as any).gewicht = formatMeasurement(element.text().trim());\n  }\n\n  if ((selectors as any).zellenchemie) {\n    const element = $((selectors as any).zellenchemie).first();\n    (product as any).zellenchemie = element.text().trim() || '';\n  }\n\n  if ((selectors as any).energie) {\n    const element = $((selectors as any).energie).first();\n    (product as any).energie = formatMeasurement(element.text().trim());\n  }\n\n  if ((selectors as any).farbe) {\n    const element = $((selectors as any).farbe).first();\n    (product as any).farbe = element.text().trim() || '';\n  }\n\n  // ANSMANN: Extract Abmessungen (Dimensions) and split into Lnge, Breite, Hhe\n  // Format: \"1.5  1.5  5.1 cm\" or \"7037.537.5 mm\" or \"7037,537,5 mm je Zelle\"\n  if (!(product as any).laenge || !(product as any).breite || !(product as any).hoehe) {\n    let abmessungenText = '';\n    \n    // First try: Use abmessungen selector if available\n    if ((selectors as any).abmessungen) {\n      const element = $((selectors as any).abmessungen).first();\n      abmessungenText = element.text().trim();\n      console.log(` Extracted Abmessungen via selector: \"${abmessungenText}\"`);\n    }\n    \n    // Fallback: Search in HTML if selector didn't work\n    if (!abmessungenText) {\n      const abmessungenHtmlMatch = html.match(/abmessungen[:\\s]+([\\d.,]+)\\s*[x]\\s*([\\d.,]+)\\s*[x]\\s*([\\d.,]+)\\s*(mm|cm)/i);\n      if (abmessungenHtmlMatch) {\n        abmessungenText = abmessungenHtmlMatch[0];\n        console.log(` Extracted Abmessungen from HTML: \"${abmessungenText}\"`);\n      }\n    }\n    \n    // Parse the extracted text (from selector or HTML)\n    const abmessungenMatch = abmessungenText.match(/([\\d.,]+)\\s*[x]\\s*([\\d.,]+)\\s*[x]\\s*([\\d.,]+)\\s*(mm|cm)/i);\n    if (abmessungenMatch) {\n      // Normalize numbers: handle both German (,) and English (.) decimal separators\n      const normalizeNumber = (num: string): string => {\n        // If both comma and dot present, assume German format (1.234,5)\n        if (num.includes(',') && num.includes('.')) {\n          return num.replace(/\\./g, '').replace(',', '.');\n        }\n        // If only comma, assume decimal separator (37,5)\n        if (num.includes(',')) {\n          return num.replace(',', '.');\n        }\n        // Otherwise already English format\n        return num;\n      };\n      \n      let laenge = normalizeNumber(abmessungenMatch[1]);\n      let breite = normalizeNumber(abmessungenMatch[2]);\n      let hoehe = normalizeNumber(abmessungenMatch[3]);\n      const unit = abmessungenMatch[4].toLowerCase();\n      \n      // Convert cm to mm if needed\n      if (unit === 'cm') {\n        laenge = (parseFloat(laenge) * 10).toString();\n        breite = (parseFloat(breite) * 10).toString();\n        hoehe = (parseFloat(hoehe) * 10).toString();\n      }\n      \n      // Format with German comma and no units\n      (product as any).laenge = formatMeasurement(laenge);\n      (product as any).breite = formatMeasurement(breite);\n      (product as any).hoehe = formatMeasurement(hoehe);\n      \n      console.log(` Extracted Abmessungen: ${(product as any).laenge}  ${(product as any).breite}  ${(product as any).hoehe} mm`);\n    }\n  }\n\n  // Store raw HTML for debugging\n  product.rawHtml = html.substring(0, 1000); // First 1000 chars\n\n  // SMART AUTO-EXTRACTION: Description + Technical Data Table + PDF + Safety Warnings\n  const smartExtraction = autoExtractProductDetails($, html, url);\n  if (smartExtraction.description) {\n    product.autoExtractedDescription = smartExtraction.description;\n  }\n  if (smartExtraction.technicalDataTable) {\n    product.technicalDataTable = smartExtraction.technicalDataTable;\n  }\n  if (smartExtraction.pdfManualUrl) {\n    product.pdfManualUrl = smartExtraction.pdfManualUrl;\n  }\n  if (smartExtraction.safetyWarnings) {\n    product.safetyWarnings = smartExtraction.safetyWarnings;\n  }\n\n  // INTELLIGENT TABLE PARSER: Extract structured technical data from properties tables\n  parsePropertiesTable($, product);\n\n  // BUILD COMPLETE HTML TABLE from parsed data (if no complete HTML table was found)\n  if (product.technicalDataTable && !product.technicalDataTable.includes('148,2')) {\n    // The extracted table is incomplete, rebuild from parsed data\n    const fullTableRows: string[] = [];\n    \n    if (product.length) fullTableRows.push(`<tr><td>Lnge (mm)</td><td>${product.length}</td></tr>`);\n    if (product.bodyDiameter) fullTableRows.push(`<tr><td>Gehusedurchmesser (mm)</td><td>${product.bodyDiameter}</td></tr>`);\n    if (product.headDiameter) fullTableRows.push(`<tr><td>Kopfdurchmesser</td><td>${product.headDiameter}</td></tr>`);\n    if (product.weightWithoutBattery) fullTableRows.push(`<tr><td>Gewicht (ohne Batterien/Akku) (g)</td><td>${product.weightWithoutBattery}</td></tr>`);\n    if (product.powerSupply) fullTableRows.push(`<tr><td>Stromversorgung</td><td>${product.powerSupply}</td></tr>`);\n    if (product.led1) fullTableRows.push(`<tr><td>Leuchtmittel 1</td><td>${product.led1}</td></tr>`);\n    if (product.led2) fullTableRows.push(`<tr><td>Leuchtmittel 2</td><td>${product.led2}</td></tr>`);\n    if (product.spotIntensity) fullTableRows.push(`<tr><td>Spotintensitt (cd)</td><td>${product.spotIntensity}</td></tr>`);\n    if (product.maxLuminosity) fullTableRows.push(`<tr><td>Leuchtleistung max.</td><td>${product.maxLuminosity}</td></tr>`);\n    if (product.maxBeamDistance) fullTableRows.push(`<tr><td>Leuchtweite max. (m)</td><td>${product.maxBeamDistance}</td></tr>`);\n    \n    if (fullTableRows.length > 0) {\n      product.technicalDataTable = `<table border=\"0\" summary=\"\">\\n<tbody>\\n${fullTableRows.join('\\n')}\\n</tbody>\\n</table>`;\n      console.log(` Rebuilt COMPLETE HTML table from parsed data (${fullTableRows.length} rows)`);\n    }\n  }\n\n  // Calculate VK Price from EK Price: (EK  2) + 19% = EK  2.38, always ending in ,95\n  // Format: German format with comma (e.g., 11,95)\n  if (product.ekPrice) {\n    const ekValue = parseFloat(product.ekPrice.replace(',', '.'));\n    if (!isNaN(ekValue)) {\n      const vkCalculated = ekValue * 2 * 1.19;\n      // Round to ,95 ending (e.g., 11.90  11,95)\n      const vkRounded = Math.floor(vkCalculated) + 0.95;\n      product.vkPrice = vkRounded.toFixed(2).replace('.', ',');  // German format\n      console.log(` Calculated VK Price: EK ${product.ekPrice}  VK ${product.vkPrice} (calculated: ${vkCalculated.toFixed(2).replace('.', ',')})`);\n    }\n  } else if (product.price) {\n    // If price field exists, treat it as EK and calculate VK\n    const priceValue = parseFloat(product.price.replace(',', '.'));\n    if (!isNaN(priceValue)) {\n      product.ekPrice = product.price;\n      const vkCalculated = priceValue * 2 * 1.19;\n      // Round to ,95 ending (e.g., 11.90  11,95)\n      const vkRounded = Math.floor(vkCalculated) + 0.95;\n      product.vkPrice = vkRounded.toFixed(2).replace('.', ',');  // German format\n      console.log(` Calculated VK Price from price field: EK ${product.ekPrice}  VK ${product.vkPrice} (calculated: ${vkCalculated.toFixed(2).replace('.', ',')})`);\n    }\n  }\n\n  console.log('Scraped product:', {\n    articleNumber: product.articleNumber,\n    productName: product.productName,\n    ean: product.ean,\n    imagesCount: product.images.length,\n    autoExtractedDescription: !!product.autoExtractedDescription,\n    technicalDataTable: !!product.technicalDataTable,\n    pdfManualUrl: !!product.pdfManualUrl,\n    safetyWarnings: !!product.safetyWarnings\n  });\n\n  return product;\n}\n\n/**\n * SMART AUTO-EXTRACTION: Automatically find and extract description + technical data table + PDF + safety warnings\n * Searches for common tab patterns like \"Beschreibung\", \"Technische Daten\", \"Bedienungsanleitungen\", \"Produktsicherheit\"\n */\nfunction autoExtractProductDetails($: cheerio.CheerioAPI, html: string, url: string): {\n  description?: string;\n  technicalDataTable?: string;\n  pdfManualUrl?: string;\n  safetyWarnings?: string;\n} {\n  const result: { description?: string; technicalDataTable?: string; pdfManualUrl?: string; safetyWarnings?: string } = {};\n\n  // 1. AUTO-EXTRACT DESCRIPTION (look for \"Beschreibung\" tab or section)\n  const descriptionSelectors = [\n    '#description-tab-516d15ca626445a38719925615405a64-pane', // Nitecore specific\n    '[id*=\"description\"]',\n    '[class*=\"description\"]',\n    '[id*=\"produktbeschreibung\"]',\n    '.product-description',\n    '.tab-content [id*=\"beschreibung\"]',\n    '.tab-pane:contains(\"Die\")', // Generic German product descriptions start with \"Die\"\n  ];\n\n  for (const selector of descriptionSelectors) {\n    try {\n      const element = $(selector).first();\n      if (element.length > 0) {\n        const text = element.text().trim();\n        if (text.length > 50) { // Minimum length to be valid description\n          result.description = text;\n          console.log(`Auto-extracted description using: ${selector}`);\n          break;\n        }\n      }\n    } catch (error) {\n      continue;\n    }\n  }\n\n  // 2. AUTO-EXTRACT TECHNICAL DATA TABLE - FULL HTML (look for \"Technische Daten\" tab content)\n  // STRATEGY: Extract the entire tab pane content, not just a single table\n  const technicalDataPaneSelectors = [\n    '#technical-data-516d15ca626445a38719925615405a64-pane', // Nitecore specific tab pane (FULL CONTENT)\n    '#additional', // ANSMANN: Magento \"Zusatzinformation\" tab containing technical data table\n    '.additional-attributes-wrapper', // ANSMANN: Wrapper for technical attributes\n    '[id$=\"-pane\"][id*=\"technical\"]', // Match IDs ending with -pane (NOT tab buttons)\n    '.tab-pane[id*=\"technical\"]', // Tab pane with class\n    '.tab-pane[id*=\"technische-daten\"]', // German technical data pane\n  ];\n\n  // Try to get the COMPLETE tab pane first (all DIVs and tables)\n  for (const selector of technicalDataPaneSelectors) {\n    try {\n      const pane = $(selector).first();\n      if (pane.length > 0) {\n        const content = pane.html();\n        // Make sure we got actual content, not just a tab button (should have table or multiple divs)\n        if (content && content.length > 200 && (content.includes('<table') || content.includes('properties-row'))) {\n          result.technicalDataTable = content; // Use raw HTML without wrapper div\n          console.log(`Auto-extracted FULL technical data pane using: ${selector} (${content.length} chars)`);\n          break;\n        }\n      }\n    } catch (error) {\n      continue;\n    }\n  }\n\n  // Fallback: Try individual table selectors\n  if (!result.technicalDataTable) {\n    const tableSelectors = [\n      '.tab-content table',\n      'table.product-detail-properties-table',\n      'table.table-striped',\n      'table[border=\"0\"]',\n      'table.data.table.additional-attributes', // ANSMANN: Technical data table class\n      '.additional-attributes', // ANSMANN: Additional attributes wrapper\n    ];\n\n    for (const selector of tableSelectors) {\n      try {\n        const table = $(selector).first();\n        if (table.length > 0) {\n          const rows = table.find('tr');\n          if (rows.length >= 3) {\n            result.technicalDataTable = table.toString();\n            console.log(`Auto-extracted technical data table using: ${selector} (${rows.length} rows)`);\n            break;\n          }\n        }\n      } catch (error) {\n        continue;\n      }\n    }\n  }\n\n  // Fallback: Search entire HTML for table with technical keywords\n  if (!result.technicalDataTable) {\n    $('table').each((_, el) => {\n      const tableHtml = $(el).html() || '';\n      const tableText = $(el).text().toLowerCase();\n      \n      // Check for technical keywords in German (including ANSMANN-specific fields)\n      const technicalKeywords = [\n        'lnge', 'gewicht', 'durchmesser', 'stromversorgung', 'leuchtmittel', 'lumen', 'leuchtweite',\n        'nominal-spannung', 'nominal-kapazitt', 'entladestrom', 'zellenchemie', 'energie', 'breite', 'hhe',\n        'spannung', 'kapazitt', 'farbe', 'produktgewicht', 'ean-code', 'artikelnummer'\n      ];\n      const matchCount = technicalKeywords.filter(keyword => tableText.includes(keyword)).length;\n      \n      // ANSMANN tables typically have 5 rows with attribute-value pairs\n      const rowCount = $(el).find('tr').length;\n      const hasAttributeValueStructure = tableText.includes('ean-code') || tableText.includes('artikelnummer');\n      \n      if (matchCount >= 2 || (rowCount >= 5 && hasAttributeValueStructure)) { // Lowered threshold for ANSMANN\n        result.technicalDataTable = $(el).toString();\n        console.log(`Auto-extracted technical data table by keyword matching (${matchCount} keywords)`);\n        return false; // Break loop\n      }\n    });\n  }\n\n  // 3. AUTO-EXTRACT PDF MANUAL URL (look for \"Bedienungsanleitungen\" download button)\n  // Nitecore uses: <button onclick=\"download('https://www.nitecore.de/media/.../MANUAL.PDF')\">\n  const pdfButtons = $('button.downloadimg, button[onclick*=\"download\"]');\n  pdfButtons.each((_, btn) => {\n    const onclick = $(btn).attr('onclick');\n    if (onclick) {\n      // Extract URL from onclick=\"download('URL')\"\n      const match = onclick.match(/download\\(['\"]([^'\"]+)['\"]\\)/);\n      if (match && match[1] && (match[1].toLowerCase().includes('.pdf') || match[1].toLowerCase().includes('bedienungsanleitung'))) {\n        result.pdfManualUrl = match[1];\n        console.log(`Auto-extracted PDF manual URL: ${result.pdfManualUrl}`);\n        return false; // Found first PDF, break loop\n      }\n    }\n  });\n\n  // Fallback: Look for direct PDF links\n  if (!result.pdfManualUrl) {\n    const pdfLinks = $('a[href$=\".pdf\"], a[href*=\".PDF\"], a[href*=\"bedienungsanleitung\"]');\n    if (pdfLinks.length > 0) {\n      const href = pdfLinks.first().attr('href');\n      if (href) {\n        try {\n          result.pdfManualUrl = href.startsWith('http') ? href : `https://${new URL(url).hostname}${href}`;\n          console.log(`Auto-extracted PDF manual URL (fallback): ${result.pdfManualUrl}`);\n        } catch (error) {\n          console.error(`Failed to parse PDF URL: ${href}`, error);\n        }\n      }\n    }\n  }\n\n  // 4. AUTO-EXTRACT SAFETY WARNINGS (look for \"Produktsicherheit\" / \"PRODUKT HINWEIS\")\n  const safetyWarnings: string[] = [];\n  \n  // Nitecore uses: <div class=\"custom-hint-text\">Warning text here</div>\n  $('.custom-hint-text, .safety-warning, .product-safety, [class*=\"warning\"], [class*=\"hinweis\"]').each((_, el) => {\n    const text = $(el).text().trim();\n    // Filter out short texts and navigation items\n    if (text.length > 20 && !text.toLowerCase().includes('navigation') && !text.toLowerCase().includes('menu')) {\n      safetyWarnings.push(text);\n    }\n  });\n\n  // Also check for explicit safety icons/symbols\n  $('img[src*=\"warning\"], img[src*=\"hinweis\"], img[src*=\"heat\"], img[src*=\"strahlung\"]').each((_, img) => {\n    const parent = $(img).parent();\n    const siblingText = parent.find('.custom-hint-text, p, span').text().trim();\n    if (siblingText.length > 20 && !safetyWarnings.includes(siblingText)) {\n      safetyWarnings.push(siblingText);\n    }\n  });\n\n  // LIMIT: Nur die 4 wichtigsten Sicherheitshinweise\n  if (safetyWarnings.length > 0) {\n    const topWarnings = safetyWarnings.slice(0, 4);\n    result.safetyWarnings = topWarnings.join('\\n\\n');\n    console.log(`Auto-extracted ${topWarnings.length} safety warning(s) (top 4 from ${safetyWarnings.length} total)`);\n  }\n\n  return result;\n}\n\n/**\n * INTELLIGENT TABLE PARSER: Extract structured technical data from generic property tables\n * Supports two formats:\n * 1. Table: <th class=\"properties-label\">Lnge:</th><td class=\"properties-value\">156 mm</td>\n * 2. DIVs: <div class=\"product-detail-technical-data-label\">Lnge (mm)</div><div class=\"product-detail-technical-data-value\">148,2</div>\n */\nfunction parsePropertiesTable($: cheerio.CheerioAPI, product: any): void {\n  let foundData = false;\n\n  // METHOD 1: Parse DIV-based technical data (Nitecore \"Technische Daten\" tab)\n  const technicalDataContainer = $('.product-detail-technical-data, #lds-technical-data-tab-pane');\n  if (technicalDataContainer.length > 0) {\n    console.log('Found DIV-based technical data structure, parsing...');\n    \n    technicalDataContainer.find('.product-detail-technical-data-label').each((_, labelEl) => {\n      const $label = $(labelEl);\n      const label = $label.text().trim().toLowerCase();\n      const $value = $label.next('.product-detail-technical-data-value');\n      const value = $value.text().trim();\n\n      if (!label || !value) return;\n      foundData = true;\n\n      // Map labels to product fields using keywords\n      if (label.includes('lnge') && !label.includes('leucht')) {\n        product.length = value;\n      } else if (label.includes('gehusedurchmesser') || label.includes('body diameter') || label.includes('bodydurchmesser')) {\n        product.bodyDiameter = value;\n      } else if (label.includes('kopfdurchmesser') || label.includes('head diameter')) {\n        product.headDiameter = value;\n      } else if (label.includes('gewicht') && (label.includes('ohne') || label.includes('without'))) {\n        product.weightWithoutBattery = value;\n      } else if (label.includes('gesamt gewicht') || label.includes('total weight')) {\n        product.totalWeight = value;\n      } else if (label.includes('stromversorgung') || label.includes('power supply')) {\n        product.powerSupply = value;\n      } else if (label.includes('leuchtmittel 1') || label === 'leuchtmittel 1') {\n        product.led1 = value;\n      } else if (label.includes('leuchtmittel 2') || label === 'leuchtmittel 2') {\n        product.led2 = value;\n      } else if (label.includes('spotintensitt') || label.includes('spot intensity')) {\n        product.spotIntensity = value;\n      } else if (label.includes('leuchtleistung')) {\n        product.maxLuminosity = value;\n      } else if (label.includes('leuchtweite')) {\n        product.maxBeamDistance = value;\n      }\n    });\n  }\n\n  // METHOD 2: Parse TABLE-based properties (fallback)\n  if (!foundData) {\n    const table = $('.product-detail-properties-table, table.table-striped, .properties-table').first();\n    \n    if (table.length > 0) {\n      console.log('Found TABLE-based properties, parsing...');\n      \n      table.find('tr').each((_, row) => {\n        const $row = $(row);\n        const label = $row.find('th, .properties-label').first().text().trim().toLowerCase();\n        const value = $row.find('td, .properties-value').first().text().trim();\n\n        if (!label || !value) return;\n\n        // Map labels to product fields using keywords\n        if (label.includes('lnge') && !label.includes('leucht')) {\n          product.length = value;\n        } else if (label.includes('gehusedurchmesser') || label.includes('body diameter')) {\n          product.bodyDiameter = value;\n        } else if (label.includes('kopfdurchmesser') || label.includes('head diameter')) {\n          product.headDiameter = value;\n        } else if (label.includes('gewicht ohne akku') || label.includes('weight without battery')) {\n          product.weightWithoutBattery = value;\n        } else if (label.includes('gesamt gewicht') || label.includes('total weight')) {\n          product.totalWeight = value;\n        } else if (label.includes('stromversorgung') || label.includes('power supply')) {\n          product.powerSupply = value;\n        } else if (label.includes('leuchtmittel 1') || label.includes('led 1')) {\n          product.led1 = value;\n        } else if (label.includes('leuchtmittel 2') || label.includes('led 2')) {\n          product.led2 = value;\n        } else if (label.includes('spotintensitt') || label.includes('spot intensity')) {\n          product.spotIntensity = value;\n        } else if (label.includes('leuchtleistung') || label.includes('max output')) {\n          product.maxLuminosity = value;\n        } else if (label.includes('leuchtweite') || label.includes('beam distance')) {\n          product.maxBeamDistance = value;\n        }\n      });\n    }\n  }\n\n  console.log('Parsed technical data:', {\n    length: product.length,\n    bodyDiameter: product.bodyDiameter,\n    headDiameter: product.headDiameter,\n    weightWithoutBattery: product.weightWithoutBattery,\n    totalWeight: product.totalWeight,\n    powerSupply: product.powerSupply,\n    led1: product.led1,\n    led2: product.led2,\n    spotIntensity: product.spotIntensity,\n    maxLuminosity: product.maxLuminosity,\n    maxBeamDistance: product.maxBeamDistance\n  });\n}\n\n/**\n * Common product link selector patterns to try automatically\n */\nconst AUTO_DETECT_SELECTORS = [\n  'a.product-link',\n  'a.product-item-link',\n  'a[href*=\"/product/\"]',\n  'a[href*=\"/products/\"]',\n  'a[href*=\"/p/\"]',\n  'a[href*=\"/item/\"]',\n  'a[href*=\"/artikel/\"]',\n  '.product-item a',\n  '.product-card a',\n  '.product a',\n  'article a',\n  'a[itemprop=\"url\"]',\n  'a.productTitle',\n  'a.product-name',\n  'h3 a',\n  'h2 a'\n];\n\n/**\n * Auto-detect product link selector by trying common patterns\n */\nfunction autoDetectProductLinks($: cheerio.CheerioAPI, url: string): string[] {\n  const productUrls: string[] = [];\n  \n  for (const selector of AUTO_DETECT_SELECTORS) {\n    try {\n      const links: string[] = [];\n      $(selector).each((_, el) => {\n        const href = $(el).attr('href');\n        if (href && !href.startsWith('#') && !href.startsWith('javascript:')) {\n          const absoluteUrl = href.startsWith('http') ? href : new URL(href, url).toString();\n          links.push(absoluteUrl);\n        }\n      });\n      \n      // If we found at least 3 links with this selector, consider it successful\n      if (links.length >= 3) {\n        console.log(`Auto-detected product links using selector: ${selector} (${links.length} found)`);\n        return links;\n      }\n    } catch (error) {\n      // Skip invalid selectors\n      continue;\n    }\n  }\n  \n  console.log('Auto-detection found no suitable product links');\n  return productUrls;\n}\n\n/**\n * Find the next page URL from pagination\n */\nfunction findNextPageUrl($: cheerio.CheerioAPI, currentUrl: string, paginationSelector?: string): string | null {\n  // Method 1: Use provided pagination selector (e.g., '.pagination .next', 'a[rel=\"next\"]')\n  if (paginationSelector) {\n    const nextLink = $(paginationSelector).first();\n    const href = nextLink.attr('href');\n    if (href && !nextLink.hasClass('disabled') && nextLink.attr('aria-disabled') !== 'true') {\n      return href.startsWith('http') ? href : new URL(href, currentUrl).toString();\n    }\n  }\n\n  // Method 2: Check for input-based pagination (Nitecore-style)\n  // <li class=\"page-item page-next\"><input type=\"radio\" name=\"p\" id=\"p-next\" value=\"2\">\n  const nextInput = $('.page-next:not(.disabled) input[name=\"p\"], input#p-next').first();\n  if (nextInput.length > 0) {\n    const nextPageValue = nextInput.attr('value');\n    if (nextPageValue) {\n      const urlObj = new URL(currentUrl);\n      urlObj.searchParams.set('p', nextPageValue);\n      console.log(`Found next page using input pagination: p=${nextPageValue}`);\n      return urlObj.toString();\n    }\n  }\n\n  // Method 3: Auto-detect common link-based pagination patterns\n  const commonSelectors = [\n    'a[rel=\"next\"]',\n    '.pagination .next:not(.disabled) a',\n    '.pagination li.next:not(.disabled) a',\n    'a.next:not(.disabled)',\n    '.pager .next a',\n    '[aria-label=\"Next\"]',\n    'a:contains(\"Weiter\"):not(.disabled)',\n    'a:contains(\"Next\"):not(.disabled)',\n    'a:contains(\"\"):not(.disabled)',\n    'a:contains(\"\"):not(.disabled)'\n  ];\n\n  for (const selector of commonSelectors) {\n    try {\n      const nextLink = $(selector).first();\n      if (nextLink.length > 0) {\n        const href = nextLink.attr('href');\n        if (href && !nextLink.hasClass('disabled')) {\n          const absoluteUrl = href.startsWith('http') ? href : new URL(href, currentUrl).toString();\n          console.log(`Found next page using selector: ${selector}`);\n          return absoluteUrl;\n        }\n      }\n    } catch (error) {\n      continue;\n    }\n  }\n\n  // Method 4: Try URL pattern increment (e.g., ?page=1  ?page=2)\n  const urlObj = new URL(currentUrl);\n  const pageParam = urlObj.searchParams.get('page') || urlObj.searchParams.get('p');\n  \n  if (pageParam) {\n    const currentPage = parseInt(pageParam, 10);\n    if (!isNaN(currentPage)) {\n      const nextPage = currentPage + 1;\n      const paramName = urlObj.searchParams.has('page') ? 'page' : 'p';\n      urlObj.searchParams.set(paramName, nextPage.toString());\n      console.log(`Incremented URL parameter ${paramName} to ${nextPage}`);\n      return urlObj.toString();\n    }\n  }\n\n  return null;\n}\n\n/**\n * Scrape multiple products from a listing page (single page only)\n */\nexport async function scrapeProductList(\n  url: string,\n  productLinkSelector: string | null,\n  maxProducts: number = 50,\n  options?: Partial<ScrapeOptions>\n): Promise<string[]> {\n  console.log(`Scraping product list from: ${url}`);\n\n  const headers: Record<string, string> = {\n    'User-Agent': options?.userAgent || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n    'Accept-Language': 'de,en-US;q=0.7,en;q=0.3'\n  };\n\n  if (options?.cookies) {\n    headers['Cookie'] = options.cookies;\n  }\n\n  const timeout = options?.timeout || 15000;\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n  let html: string;\n  try {\n    const response = await fetch(url, {\n      headers,\n      signal: controller.signal\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    html = await response.text();\n  } catch (error) {\n    if (error instanceof Error && error.name === 'AbortError') {\n      throw new Error(`Request timeout after ${timeout}ms`);\n    }\n    throw error;\n  } finally {\n    clearTimeout(timeoutId);\n  }\n  const $ = cheerio.load(html);\n\n  let productUrls: string[] = [];\n\n  // Use auto-detection if no selector provided\n  if (!productLinkSelector || productLinkSelector.trim() === '') {\n    console.log('No selector provided, using auto-detection...');\n    productUrls = autoDetectProductLinks($, url);\n  } else {\n    // Extract product URLs using provided selector\n    $(productLinkSelector).each((_, el) => {\n      const href = $(el).attr('href');\n      if (href) {\n        // Make absolute URL if relative\n        const absoluteUrl = href.startsWith('http') ? href : new URL(href, url).toString();\n        productUrls.push(absoluteUrl);\n      }\n    });\n  }\n\n  // Remove duplicates\n  productUrls = Array.from(new Set(productUrls));\n\n  // Limit results\n  const limitedUrls = productUrls.slice(0, maxProducts);\n  console.log(`Found ${productUrls.length} products, returning ${limitedUrls.length}`);\n\n  return limitedUrls;\n}\n\n/**\n * Scrape multiple pages of a product listing with pagination\n */\nexport async function scrapeAllPages(\n  startUrl: string,\n  productLinkSelector: string | null,\n  paginationSelector: string | null,\n  maxPages: number = 10,\n  maxProductsTotal: number = 500,\n  options?: Partial<ScrapeOptions>,\n  progressCallback?: (currentPage: number, totalProducts: number) => void\n): Promise<string[]> {\n  console.log(`Starting multi-page scraping from: ${startUrl}`);\n  console.log(`Max pages: ${maxPages}, Max products: ${maxProductsTotal}`);\n\n  const allProductUrls: string[] = [];\n  let currentUrl: string | null = startUrl;\n  let pageNumber = 1;\n  let consecutiveEmptyPages = 0;\n  const MAX_CONSECUTIVE_EMPTY_PAGES = 3; // Stop after 3 empty pages\n\n  while (currentUrl && pageNumber <= maxPages && allProductUrls.length < maxProductsTotal) {\n    console.log(`\\n Scraping Seite ${pageNumber}/${maxPages}: ${currentUrl}`);\n\n    try {\n      // Scrape current page\n      const pageProducts = await scrapeProductList(\n        currentUrl,\n        productLinkSelector,\n        maxProductsTotal - allProductUrls.length, // Remaining quota\n        options\n      );\n\n      console.log(` Found ${pageProducts.length} products on page ${pageNumber}`);\n      \n      // Track consecutive empty pages\n      if (pageProducts.length === 0) {\n        consecutiveEmptyPages++;\n        console.log(` Empty page detected (${consecutiveEmptyPages}/${MAX_CONSECUTIVE_EMPTY_PAGES})`);\n        \n        if (consecutiveEmptyPages >= MAX_CONSECUTIVE_EMPTY_PAGES) {\n          console.log(` Stopping: ${MAX_CONSECUTIVE_EMPTY_PAGES} consecutive empty pages found`);\n          break;\n        }\n      } else {\n        consecutiveEmptyPages = 0; // Reset counter when products are found\n      }\n      \n      allProductUrls.push(...pageProducts);\n\n      // Report progress\n      if (progressCallback) {\n        progressCallback(pageNumber, allProductUrls.length);\n      }\n\n      // Check if we've reached the limit\n      if (allProductUrls.length >= maxProductsTotal) {\n        console.log(`Reached maximum product limit (${maxProductsTotal})`);\n        break;\n      }\n\n      // Fetch page HTML to find next page\n      const headers: Record<string, string> = {\n        'User-Agent': options?.userAgent || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',\n        'Accept-Language': 'de,en-US;q=0.7,en;q=0.3'\n      };\n\n      if (options?.cookies) {\n        headers['Cookie'] = options.cookies;\n      }\n\n      const response = await fetch(currentUrl, { headers });\n      const html = await response.text();\n      const $ = cheerio.load(html);\n\n      // Find next page\n      const nextUrl = findNextPageUrl($, currentUrl, paginationSelector || undefined);\n      \n      if (!nextUrl) {\n        console.log('No next page found, pagination complete');\n        break;\n      }\n\n      if (nextUrl === currentUrl) {\n        console.log('Next page URL is same as current, stopping to prevent infinite loop');\n        break;\n      }\n\n      currentUrl = nextUrl;\n      pageNumber++;\n\n      // Polite delay between pages (2 seconds)\n      await new Promise(resolve => setTimeout(resolve, 2000));\n\n    } catch (error) {\n      console.error(`Error scraping page ${pageNumber}:`, error);\n      break;\n    }\n  }\n\n  // Remove duplicates (in case products appear on multiple pages)\n  const uniqueProducts = Array.from(new Set(allProductUrls));\n  \n  console.log(`\\n=== PAGINATION COMPLETE ===`);\n  console.log(`Pages scraped: ${pageNumber}`);\n  console.log(`Total products found: ${uniqueProducts.length}`);\n\n  return uniqueProducts;\n}\n\n/**\n * Test a single CSS selector on a URL\n * Returns the extracted value for verification\n */\nexport async function testSelector(options: {\n  url: string;\n  selector: string;\n  userAgent?: string;\n  cookies?: string;\n  timeout?: number;\n}): Promise<{\n  success: boolean;\n  value?: string;\n  html?: string;\n  count?: number;\n  error?: string;\n}> {\n  const { url, selector, userAgent, cookies, timeout = 30000 } = options;\n\n  try {\n    console.log(`[Test Selector] Testing selector \"${selector}\" on ${url}`);\n\n    // Fetch the HTML\n    const headers: Record<string, string> = {\n      'User-Agent': userAgent || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',\n      'Accept-Language': 'de-DE,de;q=0.9,en;q=0.8',\n    };\n\n    if (cookies) {\n      headers['Cookie'] = cookies;\n    }\n\n    let html = '';\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n    try {\n      const response = await fetch(url, {\n        headers,\n        signal: controller.signal,\n      });\n\n      if (!response.ok) {\n        return {\n          success: false,\n          error: `HTTP ${response.status}: ${response.statusText}`\n        };\n      }\n\n      html = await response.text();\n    } finally {\n      clearTimeout(timeoutId);\n    }\n\n    // Parse with Cheerio\n    const $ = cheerio.load(html);\n\n    // Test the selector\n    const elements = $(selector);\n    const count = elements.length;\n\n    if (count === 0) {\n      return {\n        success: false,\n        count: 0,\n        error: 'Kein Element gefunden - Selektor matched nichts auf der Seite'\n      };\n    }\n\n    // Get the first element's value\n    const firstElement = elements.first();\n    const textValue = firstElement.text().trim();\n    const contentAttr = firstElement.attr('content')?.trim();\n    const htmlValue = firstElement.html()?.trim();\n\n    const value = textValue || contentAttr || htmlValue || '';\n\n    return {\n      success: true,\n      value: value.substring(0, 500), // Limit to 500 chars for preview\n      html: htmlValue?.substring(0, 500),\n      count\n    };\n\n  } catch (error: any) {\n    console.error('[Test Selector] Error:', error);\n    return {\n      success: false,\n      error: error.message || 'Unbekannter Fehler beim Testen des Selektors'\n    };\n  }\n}\n\n/**\n * Default selectors for common e-commerce platforms\n */\nexport const defaultSelectors: Record<string, ScraperSelectors> = {\n  generic: {\n    articleNumber: '[itemprop=\"sku\"], .product-code, .article-number',\n    productName: 'h1, [itemprop=\"name\"], .product-title',\n    ean: '[itemprop=\"gtin13\"], .ean, .barcode',\n    manufacturer: '[itemprop=\"brand\"], .manufacturer, .brand',\n    price: '[itemprop=\"price\"], .price, .product-price',\n    description: '[itemprop=\"description\"], .product-description, .description',\n    images: '[itemprop=\"image\"], .product-image img, .gallery img',\n    weight: '.weight, [itemprop=\"weight\"]',\n    category: '.breadcrumb, [itemprop=\"category\"]'\n  },\n  shopware: {\n    articleNumber: '.product-detail-ordernumber',\n    productName: '.product-detail-name',\n    ean: '.product-detail-ordernumber-container .product-detail-ordernumber',\n    price: '.product-detail-price',\n    description: '.product-detail-description',\n    images: '.gallery-slider-image',\n    category: '.breadcrumb-item'\n  }\n};\n\n/**\n * Brickfox-optimized selectors\n * Only the 9 essential fields needed for Brickfox CSV export\n * This minimizes scraping overhead and database storage\n */\nexport const brickfoxSelectors: ScraperSelectors = {\n  articleNumber: '[itemprop=\"sku\"], .product-code, .article-number',\n  productName: 'h1, [itemprop=\"name\"], .product-title',\n  ean: '[itemprop=\"gtin13\"], .ean, .barcode',\n  manufacturer: '[itemprop=\"brand\"], .manufacturer, .brand',\n  category: '.breadcrumb, [itemprop=\"category\"]',\n  price: '[itemprop=\"price\"], .price, .product-price',\n  weight: '.weight, [itemprop=\"weight\"]',\n  description: '[itemprop=\"description\"], .product-description, .description',\n  images: '[itemprop=\"image\"], .product-image img, .gallery img'\n};\n","size_bytes":62665},"client/src/pages/url-scraper.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card } from \"@/components/ui/card\";\nimport { Loader2, Globe, Settings2, FolderPlus, List, Download, Table as TableIcon, Eye, Sparkles, FileText, Save, Copy, Check, Maximize2, ArrowLeft, Database } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport type { Project } from \"@shared/schema\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { apiPost } from \"@/lib/api\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { supabase } from \"@/lib/supabase\";\n\ninterface ScrapedProduct {\n  articleNumber: string;\n  productName: string;\n  ean?: string;\n  manufacturer?: string;\n  price?: string;\n  description?: string;\n  images: string[];\n  localImagePaths?: string[]; // Lokale Bildpfade\n  weight?: string;\n  category?: string;\n  // ANSMANN technical specifications\n  nominalspannung?: string;\n  nominalkapazitaet?: string;\n  maxEntladestrom?: string;\n  laenge?: string;\n  breite?: string;\n  hoehe?: string;\n  gewicht?: string;\n  zellenchemie?: string;\n  energie?: string;\n  farbe?: string;\n  // Nitecore technical specifications\n  length?: string;\n  bodyDiameter?: string;\n  headDiameter?: string;\n  weightWithoutBattery?: string;\n  totalWeight?: string;\n  powerSupply?: string;\n  led1?: string;\n  led2?: string;\n  spotIntensity?: string;\n  maxLuminosity?: string;\n  maxBeamDistance?: string;\n  manufacturerArticleNumber?: string;\n  // Pricing\n  ekPrice?: string;\n  vkPrice?: string;\n  // Auto-extracted data\n  autoExtractedDescription?: string;\n  technicalDataTable?: string;\n  pdfManualUrl?: string;\n  safetyWarnings?: string;\n  rawHtml?: string;\n  // Special\n  [key: string]: any; // Allow dynamic fields\n}\n\ninterface GeneratedContent {\n  description: string;\n  seoTitle: string;\n  seoDescription: string;\n  seoKeywords?: string;\n  categoryId?: string;\n}\n\nexport default function URLScraper() {\n  const { toast } = useToast();\n  const { isAuthenticated } = useAuth();\n  const [location, setLocation] = useLocation();\n  const [url, setUrl] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [scrapedProduct, setScrapedProduct] = useState<ScrapedProduct | null>(null);\n  const [generatedDescription, setGeneratedDescription] = useState<string>(\"\");\n  const [singleProductAiData, setSingleProductAiData] = useState<GeneratedContent | null>(null);\n  const [showAdvanced, setShowAdvanced] = useState(false);\n  const [showSaveDialog, setShowSaveDialog] = useState(false);\n  const [showBulkSaveDialog, setShowBulkSaveDialog] = useState(false);\n  const [selectedProjectId, setSelectedProjectId] = useState<string>(\"new\");\n  const [projectName, setProjectName] = useState<string>(\"\");\n  const [isSaving, setIsSaving] = useState(false);\n\n  // Multi-Product Scraping\n  const [productLinkSelector, setProductLinkSelector] = useState(\"\");\n  const [maxProducts, setMaxProducts] = useState(50);\n  const [scrapedProducts, setScrapedProducts] = useState<ScrapedProduct[]>([]);\n  const [batchProgress, setBatchProgress] = useState({ current: 0, total: 0, status: \"\" });\n  \n  // Pagination for preview table\n  const [currentPage, setCurrentPage] = useState(1);\n  const productsPerPage = 6;\n  \n  // Batch AI Generation\n  const [generatedDescriptions, setGeneratedDescriptions] = useState<Map<string, GeneratedContent>>(new Map());\n  const [isGeneratingBatch, setIsGeneratingBatch] = useState(false);\n  const [aiGenerationProgress, setAiGenerationProgress] = useState({ current: 0, total: 0 });\n  \n  // Abort scraping control\n  const abortScrapingRef = useRef(false);\n  \n  // Pagination options for multi-page scraping\n  const [enablePagination, setEnablePagination] = useState(false);\n  const [paginationSelector, setPaginationSelector] = useState(\"\");\n  const [maxPages, setMaxPages] = useState(10);\n  \n  // Session cookies and userAgent for authenticated scraping\n  const [sessionCookies, setSessionCookies] = useState(\"\");\n  const [userAgent, setUserAgent] = useState(\"\");\n\n  \n  // HTML Preview Dialog\n  const [showHtmlPreview, setShowHtmlPreview] = useState(false);\n  const [htmlPreviewContent, setHtmlPreviewContent] = useState(\"\");\n  \n  // CSV Export Column Selection\n  const [showColumnSelector, setShowColumnSelector] = useState(false);\n  const [exportColumns, setExportColumns] = useState([\n    { key: 'articleNumber', label: 'Artikelnummer', enabled: true },\n    { key: 'productName', label: 'Produktname', enabled: true },\n    { key: 'ean', label: 'EAN', enabled: true },\n    { key: 'manufacturer', label: 'Hersteller', enabled: true },\n    { key: 'ekPrice', label: 'EK_Preis', enabled: true },\n    { key: 'vkPrice', label: 'VK_Preis', enabled: true },\n    { key: 'nominalspannung', label: 'Nominalspannung_V', enabled: true },\n    { key: 'nominalkapazitaet', label: 'Nominalkapazitt_mAh', enabled: true },\n    { key: 'maxEntladestrom', label: 'Max_Entladestrom_A', enabled: true },\n    { key: 'laenge', label: 'Lnge_mm', enabled: true },\n    { key: 'breite', label: 'Breite_mm', enabled: true },\n    { key: 'hoehe', label: 'Hhe_mm', enabled: true },\n    { key: 'gewicht', label: 'Gewicht_g', enabled: true },\n    { key: 'zellenchemie', label: 'Zellenchemie', enabled: true },\n    { key: 'energie', label: 'Energie_Wh', enabled: true },\n    { key: 'farbe', label: 'Farbe', enabled: true },\n    { key: 'category', label: 'Kategorie', enabled: true },\n    { key: 'seoTitle', label: 'SEO_Titel', enabled: true },\n    { key: 'seoDescription', label: 'SEO_Beschreibung', enabled: true },\n    { key: 'seoKeywords', label: 'SEO_Keywords', enabled: false },\n    { key: 'description', label: 'AI_Produktbeschreibung_HTML', enabled: true },\n    { key: 'pdfManualUrl', label: 'PDF_Bedienungsanleitung_URL', enabled: false },\n    { key: 'images', label: 'Bild_URLs', enabled: true },\n  ]);\n  \n  // SEO Title Preview Dialog\n  const [showSeoTitlePreview, setShowSeoTitlePreview] = useState(false);\n  const [seoTitlePreviewContent, setSeoTitlePreviewContent] = useState(\"\");\n  \n  // SEO Description Preview Dialog\n  const [showSeoPreview, setShowSeoPreview] = useState(false);\n  const [seoPreviewContent, setSeoPreviewContent] = useState(\"\");\n  \n  // SEO Keywords Preview Dialog\n  const [showKeywordsPreview, setShowKeywordsPreview] = useState(false);\n  const [keywordsPreviewContent, setKeywordsPreviewContent] = useState(\"\");\n  \n  // HTML Copy State\n  const [copiedArticleNumber, setCopiedArticleNumber] = useState<string | null>(null);\n  \n  // Full View Dialog\n  const [showFullView, setShowFullView] = useState(false);\n  const [fullViewContent, setFullViewContent] = useState<{ title: string; seoDescription: string; keywords: string; html: string }>({ title: '', seoDescription: '', keywords: '', html: '' });\n  \n  // SERP Snippet Preview Dialog\n  const [showSerpPreview, setShowSerpPreview] = useState(false);\n  const [serpPreviewData, setSerpPreviewData] = useState<{ title: string; description: string; url: string; productName: string }>({ title: '', description: '', url: '', productName: '' });\n  \n  // Image Gallery State\n  const [showImageGallery, setShowImageGallery] = useState(false);\n  const [selectedProductImages, setSelectedProductImages] = useState<{ images: string[], productName: string, articleNumber: string }>({ images: [], productName: '', articleNumber: '' });\n  const [currentImageIndex, setCurrentImageIndex] = useState(0);\n\n  // Load existing projects\n  const { data: projectsData } = useQuery<{ success: boolean; projects: Project[] }>({\n    queryKey: ['/api/projects'],\n    enabled: showSaveDialog,\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const response = await fetch('/api/projects', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error('Failed to fetch projects');\n      }\n      return response.json();\n    },\n  });\n\n  // Load suppliers\n  const { data: suppliersData, isLoading: isSuppliersLoading } = useQuery<{ success: boolean; suppliers: any[] }>({\n    queryKey: ['/api/suppliers'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const response = await fetch('/api/suppliers', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error('Failed to fetch suppliers');\n      }\n      const data = await response.json();\n      console.log('Loaded suppliers:', data.suppliers?.length, 'items:', data.suppliers?.map((s: any) => s.name));\n      return data;\n    },\n  });\n\n  const [selectedSupplierId, setSelectedSupplierId] = useState<string>(\"__none__\");\n\n  // Auto-detect supplier based on URL domain\n  const autoDetectSupplier = (url: string, suppliers: any[]) => {\n    if (!suppliers || suppliers.length === 0) return null;\n    \n    try {\n      const urlObj = new URL(url);\n      const domain = urlObj.hostname.toLowerCase();\n      \n      // Match supplier by url_pattern or name\n      for (const supplier of suppliers) {\n        const pattern = supplier.url_pattern?.toLowerCase() || '';\n        const name = supplier.name?.toLowerCase() || '';\n        \n        if (domain.includes(pattern) || domain.includes(name)) {\n          console.log(` Auto-detected supplier: ${supplier.name} (${domain} matches ${pattern})`);\n          return supplier.id;\n        }\n      }\n    } catch (err) {\n      console.warn('Failed to auto-detect supplier:', err);\n    }\n    \n    return null;\n  };\n\n  // ===== SCRAPE SESSION PERSISTENCE =====\n  // Save scraped data to server session (persists across page navigation)\n  const saveScrapeSession = async () => {\n    try {\n      const token = localStorage.getItem('supabase_token');\n      if (!token) return;\n      \n      await fetch('/api/scrape-session', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          urlScraper: {\n            scrapedProducts: scrapedProducts.length > 0 ? scrapedProducts : [],\n            scrapedProduct: scrapedProduct,\n            generatedDescription: generatedDescription || null,\n          },\n        }),\n      });\n      \n      console.log(' URL Scrape session saved to server');\n    } catch (error) {\n      console.error('Failed to save URL scrape session:', error);\n    }\n  };\n\n  // Load scraped data from server session on mount\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    \n    const loadScrapeSession = async () => {\n      try {\n        const token = localStorage.getItem('supabase_token');\n        if (!token) return;\n        \n        const response = await fetch('/api/scrape-session', {\n          headers: {\n            'Authorization': `Bearer ${token}`,\n          },\n        });\n        \n        if (!response.ok) return;\n        \n        const { success, session } = await response.json();\n        \n        if (success && session && session.scrapedProducts) {\n          const urlScraperData = session.scrapedProducts.urlScraper;\n          \n          if (urlScraperData) {\n            if (urlScraperData.scrapedProducts && Array.isArray(urlScraperData.scrapedProducts) && urlScraperData.scrapedProducts.length > 0) {\n              setScrapedProducts(urlScraperData.scrapedProducts);\n              console.log(` Restored ${urlScraperData.scrapedProducts.length} URL products from server session`);\n              \n              toast({\n                title: \"URL-Daten wiederhergestellt\",\n                description: `${urlScraperData.scrapedProducts.length} Produkte aus vorheriger Sitzung geladen`,\n              });\n            }\n            \n            if (urlScraperData.scrapedProduct) {\n              setScrapedProduct(urlScraperData.scrapedProduct);\n            }\n            \n            if (urlScraperData.generatedDescription) {\n              setGeneratedDescription(urlScraperData.generatedDescription);\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Failed to load URL scrape session:', error);\n      }\n    };\n    \n    loadScrapeSession();\n  }, [isAuthenticated]);\n\n  // Auto-save session when scraped data changes\n  useEffect(() => {\n    if (!isAuthenticated) return;\n    if (scrapedProducts.length === 0 && !scrapedProduct) return;\n    \n    const timeoutId = setTimeout(() => {\n      saveScrapeSession();\n    }, 1000); // Debounce 1 second\n    \n    return () => clearTimeout(timeoutId);\n  }, [scrapedProducts, scrapedProduct, generatedDescription, isAuthenticated]);\n\n  // Check for PDF-extracted URLs on component mount (only when authenticated)\n  useEffect(() => {\n    // Wait until user is authenticated\n    if (!isAuthenticated) {\n      return;\n    }\n\n    const pdfUrls = sessionStorage.getItem('pdf_extracted_urls');\n    const pdfMetadataMap = sessionStorage.getItem('pdf_url_metadata_map');\n    const pdfSupplierId = sessionStorage.getItem('pdf_selected_supplier_id');\n    \n    if (pdfUrls && pdfMetadataMap) {\n      try {\n        const urls = pdfUrls.split('\\n').filter(url => url.trim());\n        const metadataMap = JSON.parse(pdfMetadataMap);\n        \n        // Determine supplier ID\n        let supplierIdToUse: string | undefined = undefined;\n        \n        // Use supplier from PDF-Auto-Scraper if set\n        if (pdfSupplierId && pdfSupplierId !== \"__none__\" && suppliersData?.suppliers) {\n          supplierIdToUse = pdfSupplierId;\n          setSelectedSupplierId(pdfSupplierId);\n          const supplier = suppliersData.suppliers.find((s: any) => s.id === pdfSupplierId);\n          if (supplier) {\n            // Load supplier selectors automatically\n            handleSupplierSelect(pdfSupplierId);\n            toast({\n              title: \" Lieferant geladen\",\n              description: `${supplier.name} aus PDF-Upload bernommen`,\n            });\n          }\n          // Clear from sessionStorage\n          sessionStorage.removeItem('pdf_selected_supplier_id');\n        }\n        // Fallback: Auto-detect supplier from URL if no supplier was selected in PDF-Auto-Scraper\n        else if (urls.length > 0 && suppliersData?.suppliers) {\n          const detectedSupplierId = autoDetectSupplier(urls[0], suppliersData.suppliers);\n          if (detectedSupplierId) {\n            supplierIdToUse = detectedSupplierId;\n            setSelectedSupplierId(detectedSupplierId);\n            toast({\n              title: \" Lieferant erkannt\",\n              description: `${suppliersData.suppliers.find((s: any) => s.id === detectedSupplierId)?.name} wurde automatisch ausgewhlt`,\n            });\n          }\n        }\n        \n        // Clear session storage\n        sessionStorage.removeItem('pdf_extracted_urls');\n        sessionStorage.removeItem('pdf_url_metadata_map');\n        \n        // Show notification\n        toast({\n          title: \"PDF-Daten geladen\",\n          description: `${urls.length} Produkt-URLs aus PDF bernommen. Scraping wird gestartet...`,\n        });\n        \n        // Start scraping automatically with detected supplier ID\n        handleScrapeFromPDF(urls, metadataMap, supplierIdToUse);\n      } catch (error) {\n        console.error('Error loading PDF data:', error);\n        toast({\n          title: \"Fehler beim Laden der PDF-Daten\",\n          description: \"Bitte versuchen Sie es erneut\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  }, [isAuthenticated, suppliersData]);\n\n  const handleSupplierSelect = (supplierId: string) => {\n    setSelectedSupplierId(supplierId);\n    \n    if (supplierId === \"__none__\") {\n      // Clear selectors\n      setSelectors({\n        articleNumber: \"\",\n        productName: \"\",\n        ean: \"\",\n        manufacturer: \"\",\n        price: \"\",\n        description: \"\",\n        images: \"\",\n        weight: \"\",\n        category: \"\",\n        nominalspannung: \"\",\n        nominalkapazitaet: \"\",\n        maxEntladestrom: \"\",\n        laenge: \"\",\n        breite: \"\",\n        hoehe: \"\",\n        gewicht: \"\",\n        zellenchemie: \"\",\n        energie: \"\",\n        farbe: \"\"\n      });\n      setProductLinkSelector(\"\");\n      setSessionCookies(\"\");\n      setUserAgent(\"\");\n      return;\n    }\n\n    const supplier = suppliersData?.suppliers?.find(s => s.id === supplierId);\n    if (supplier) {\n      setSelectors({ ...selectors, ...supplier.selectors });\n      // For Nitecore, ALWAYS force .product-image-link (not optional)\n      if (supplier.name === 'Nitecore') {\n        setProductLinkSelector('.product-image-link');\n      } else {\n        setProductLinkSelector(supplier.productLinkSelector || \"\");\n      }\n      setSessionCookies(supplier.sessionCookies || \"\");\n      setUserAgent(supplier.userAgent || \"\");\n      setShowAdvanced(true); // Automatically show selectors when a supplier is selected\n      toast({\n        title: \"Lieferant geladen\",\n        description: `Selektoren und Authentifizierung fr \"${supplier.name}\" wurden geladen`,\n      });\n    }\n  };\n\n  // Custom selectors\n  const [selectors, setSelectors] = useState({\n    articleNumber: \".product-code\",\n    productName: \"h1.product-title\",\n    ean: \".ean\",\n    manufacturer: \".brand\",\n    price: \".price\",\n    description: \".product-description\",\n    images: \".product-image img\",\n    weight: \".weight\",\n    category: \".breadcrumb\",\n    // ANSMANN technical specifications\n    nominalspannung: \"\",\n    nominalkapazitaet: \"\",\n    maxEntladestrom: \"\",\n    laenge: \"\",\n    breite: \"\",\n    hoehe: \"\",\n    gewicht: \"\",\n    zellenchemie: \"\",\n    energie: \"\",\n    farbe: \"\"\n  });\n\n  const handleScrapeProductList = async () => {\n    if (!url.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie eine URL ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    setScrapedProducts([]);\n    setBatchProgress({ current: 0, total: 0, status: enablePagination ? \"Scrape alle Seiten...\" : \"Suche nach Produkten...\" });\n\n    try {\n      let productUrls: string[] = [];\n\n      // Step 1: Get all product URLs from listing page\n      if (enablePagination) {\n        // Use SSE for multi-page scraping with live progress\n        productUrls = await new Promise((resolve, reject) => {\n          const requestBody = {\n            url: url.trim(),\n            productLinkSelector: productLinkSelector.trim() || null,\n            paginationSelector: paginationSelector.trim() || null,\n            maxPages,\n            maxProducts,\n            userAgent: userAgent || undefined,\n            cookies: sessionCookies || undefined\n          };\n\n          // Create URL with query parameters for SSE\n          const params = new URLSearchParams();\n          Object.entries(requestBody).forEach(([key, value]) => {\n            if (value !== undefined && value !== null) {\n              params.append(key, String(value));\n            }\n          });\n\n          const token = localStorage.getItem('supabase_token');\n          fetch('/api/scrape-all-pages', {\n            method: 'POST',\n            headers: { \n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify(requestBody)\n          }).then(response => {\n            const reader = response.body?.getReader();\n            const decoder = new TextDecoder();\n\n            if (!reader) {\n              reject(new Error('No response body'));\n              return;\n            }\n\n            const readStream = async () => {\n              let buffer = ''; // Buffer for incomplete lines\n              \n              try {\n                while (true) {\n                  const { done, value } = await reader.read();\n                  if (done) break;\n\n                  // Decode chunk (do NOT flush decoder - keep state for multi-byte UTF-8)\n                  buffer += decoder.decode(value, { stream: true });\n\n                  // Split on newlines\n                  const lines = buffer.split('\\n');\n                  \n                  // Keep the last incomplete line in the buffer\n                  buffer = lines.pop() || '';\n\n                  // Process complete lines\n                  for (const line of lines) {\n                    if (line.trim() && line.startsWith('data: ')) {\n                      try {\n                        const data = JSON.parse(line.substring(6));\n                        \n                        if (data.type === 'progress') {\n                          setBatchProgress({\n                            current: data.currentPage,\n                            total: maxPages,\n                            status: data.message\n                          });\n                        } else if (data.type === 'complete') {\n                          resolve(data.productUrls);\n                          return;\n                        } else if (data.type === 'error') {\n                          reject(new Error(data.error));\n                          return;\n                        }\n                      } catch (parseErr) {\n                        console.error('Failed to parse SSE line:', line, parseErr);\n                      }\n                    }\n                  }\n                }\n\n                // Process any remaining buffered data\n                if (buffer.trim() && buffer.startsWith('data: ')) {\n                  try {\n                    const data = JSON.parse(buffer.substring(6));\n                    if (data.type === 'complete') {\n                      resolve(data.productUrls);\n                    } else if (data.type === 'error') {\n                      reject(new Error(data.error));\n                    }\n                  } catch (parseErr) {\n                    console.error('Failed to parse final SSE buffer:', buffer, parseErr);\n                  }\n                }\n              } catch (err) {\n                reject(err);\n              }\n            };\n\n            readStream();\n          }).catch(reject);\n        });\n      } else {\n        // Single page scraping (no SSE needed)\n        const requestBody = {\n          url: url.trim(),\n          productLinkSelector: productLinkSelector.trim() || null,\n          maxProducts,\n          userAgent: userAgent || undefined,\n          cookies: sessionCookies || undefined,\n          supplierId: selectedSupplierId !== \"__none__\" ? selectedSupplierId : undefined\n        };\n\n        const token = localStorage.getItem('supabase_token');\n        const listResponse = await fetch('/api/scrape-product-list', {\n          method: 'POST',\n          headers: { \n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${token}`\n          },\n          body: JSON.stringify(requestBody),\n        });\n\n        if (!listResponse.ok) {\n          const error = await listResponse.json();\n          throw new Error(error.error || 'Fehler beim Abrufen der Produktliste');\n        }\n\n        const data = await listResponse.json();\n        productUrls = data.productUrls;\n      }\n\n      if (!productUrls || productUrls.length === 0) {\n        toast({\n          title: \"Keine Produkte gefunden\",\n          description: \"berprfen Sie den CSS-Selektor fr Produktlinks\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      toast({\n        title: \"Produktliste gefunden\",\n        description: `${productUrls.length} Produkte gefunden. Starte Scraping...`,\n      });\n\n      setBatchProgress({ current: 0, total: productUrls.length, status: \"Scraping gestartet...\" });\n\n      // Step 2: Scrape each product\n      const products: ScrapedProduct[] = [];\n      const activeSelectors: any = {};\n      Object.entries(selectors).forEach(([key, value]) => {\n        if (value.trim()) activeSelectors[key] = value;\n      });\n\n      let failedCount = 0;\n      for (let i = 0; i < productUrls.length; i++) {\n        // Check if user aborted\n        if (abortScrapingRef.current) {\n          console.log('Scraping aborted by user');\n          break;\n        }\n\n        const productUrl = productUrls[i];\n        setBatchProgress({ \n          current: i + 1, \n          total: productUrls.length, \n          status: `Scrape Produkt ${i + 1}/${productUrls.length}...` \n        });\n\n        try {\n          const data = await apiPost('/api/scrape-product', {\n            url: productUrl,\n            selectors: Object.keys(activeSelectors).length > 0 ? activeSelectors : undefined,\n            userAgent: userAgent || undefined,\n            cookies: sessionCookies || undefined,\n            supplierId: selectedSupplierId !== \"__none__\" ? selectedSupplierId : undefined\n          }) as any;\n\n          if (data && data.product) {\n            console.log(' [FRONTEND] Received product from backend:', Object.keys(data.product));\n            console.log(' [FRONTEND] Nitecore fields in response:', {\n              length: data.product.length,\n              led1: data.product.led1,\n              led2: data.product.led2,\n              maxLuminosity: data.product.maxLuminosity\n            });\n            // WICHTIG: Explizit ALLE Felder bernehmen (Spread-Operator)\n            const fullProduct = { ...data.product };\n            products.push(fullProduct);\n          } else {\n            console.error(`Fehler beim Scrapen von ${productUrl}`);\n            failedCount++;\n          }\n        } catch (err) {\n          console.error(`Fehler beim Scrapen von ${productUrl}:`, err);\n          failedCount++;\n        }\n\n        // Small delay to avoid overwhelming the server\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n\n      if (failedCount > 0) {\n        toast({\n          title: \"Teilweise erfolgreich\",\n          description: `${products.length} erfolgreich, ${failedCount} fehlgeschlagen`,\n          variant: \"destructive\",\n        });\n      }\n\n      setScrapedProducts(products);\n      \n      if (abortScrapingRef.current) {\n        setBatchProgress({ current: products.length, total: productUrls.length, status: \"Abgebrochen\" });\n        toast({\n          title: \"Scraping abgebrochen\",\n          description: `${products.length} von ${productUrls.length} Produkten gescraped`,\n          variant: \"destructive\",\n        });\n      } else {\n        setBatchProgress({ current: products.length, total: productUrls.length, status: \"Fertig!\" });\n        toast({\n          title: \"Scraping abgeschlossen\",\n          description: `${products.length} von ${productUrls.length} Produkten erfolgreich gescraped`,\n        });\n      }\n\n    } catch (error) {\n      console.error('Product list scraping error:', error);\n      toast({\n        title: \"Fehler\",\n        description: error instanceof Error ? error.message : 'Scraping fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n      abortScrapingRef.current = false; // Reset abort flag\n    }\n  };\n\n  // Handle scraping from PDF-extracted URLs\n  const handleScrapeFromPDF = async (urls: string[], metadataMap: Record<string, any>, overrideSupplierId?: string) => {\n    setIsLoading(true);\n    setScrapedProducts([]);\n    setBatchProgress({ current: 0, total: urls.length, status: \"Erkenne Lieferanten...\" });\n\n    // Use override supplier ID if provided, otherwise use current state\n    let detectedSupplierId = overrideSupplierId || selectedSupplierId;\n    \n    // Only auto-detect if no supplier ID was provided and current selection is \"__none__\"\n    if (!overrideSupplierId && urls.length > 0 && suppliersData?.suppliers && detectedSupplierId === \"__none__\") {\n      const detected = autoDetectSupplier(urls[0], suppliersData.suppliers);\n      if (detected) {\n        detectedSupplierId = detected;\n        setSelectedSupplierId(detected);\n        \n        // Load supplier selectors (only if we just auto-detected)\n        const supplier = suppliersData.suppliers.find((s: any) => s.id === detected);\n        if (supplier) {\n          setSelectors({ ...selectors, ...supplier.selectors });\n          setProductLinkSelector(supplier.productLinkSelector || \"\");\n          setSessionCookies(supplier.sessionCookies || \"\");\n          setUserAgent(supplier.userAgent || \"\");\n          \n          console.log(` Auto-detected and loaded supplier: ${supplier.name}`);\n          toast({\n            title: \" Lieferant erkannt\",\n            description: `${supplier.name} wurde automatisch ausgewhlt`,\n          });\n        }\n      }\n    }\n    // If supplier was provided via override, load selectors to ensure they're available\n    else if (overrideSupplierId && suppliersData?.suppliers) {\n      const supplier = suppliersData.suppliers.find((s: any) => s.id === overrideSupplierId);\n      if (supplier) {\n        // Load selectors explicitly to ensure they're available for scraping\n        setSelectors({ ...selectors, ...supplier.selectors });\n        setProductLinkSelector(supplier.productLinkSelector || \"\");\n        setSessionCookies(supplier.sessionCookies || \"\");\n        setUserAgent(supplier.userAgent || \"\");\n        \n        console.log(` Using pre-selected supplier: ${supplier.name}`);\n        console.log(`Loaded selectors:`, supplier.selectors);\n      }\n    }\n    \n    setBatchProgress({ current: 0, total: urls.length, status: \"Scraping aus PDF gestartet...\" });\n\n    try {\n      const products: ScrapedProduct[] = [];\n      \n      // Build active selectors - use supplier selectors if available\n      let activeSelectors: any = {};\n      if (detectedSupplierId !== \"__none__\" && suppliersData?.suppliers) {\n        const supplier = suppliersData.suppliers.find((s: any) => s.id === detectedSupplierId);\n        if (supplier && supplier.selectors) {\n          // Use supplier selectors directly (not from state which might not be updated yet)\n          activeSelectors = { ...supplier.selectors };\n          console.log(`Using supplier selectors directly:`, activeSelectors);\n        }\n      }\n      \n      // Fallback: use selectors from state if no supplier selectors\n      if (Object.keys(activeSelectors).length === 0) {\n        Object.entries(selectors).forEach(([key, value]) => {\n          if (value.trim()) activeSelectors[key] = value;\n        });\n      }\n\n      let failedCount = 0;\n      for (let i = 0; i < urls.length; i++) {\n        if (abortScrapingRef.current) {\n          console.log('Scraping aborted by user');\n          break;\n        }\n\n        const productUrl = urls[i];\n        const pdfMetadata = metadataMap[productUrl]; // Use URL as key for correct mapping\n        \n        setBatchProgress({ \n          current: i + 1, \n          total: urls.length, \n          status: `Scrape Produkt ${i + 1}/${urls.length}...` \n        });\n\n        try {\n          const data = await apiPost('/api/scrape-product', {\n            url: productUrl,\n            selectors: Object.keys(activeSelectors).length > 0 ? activeSelectors : undefined,\n            userAgent: userAgent || undefined,\n            cookies: sessionCookies || undefined,\n            supplierId: detectedSupplierId !== \"__none__\" ? detectedSupplierId : undefined\n          }) as any;\n\n          if (data && data.product) {\n            console.log(' [PDF-FLOW] Received product from backend:', Object.keys(data.product));\n            console.log(' [PDF-FLOW] Nitecore fields in response:', {\n              length: data.product.length,\n              led1: data.product.led1,\n              led2: data.product.led2,\n              maxLuminosity: data.product.maxLuminosity\n            });\n            \n            // Merge PDF data with scraped data (only if metadata exists for this URL)\n            let mergedProduct = pdfMetadata ? {\n              ...data.product,\n              // Add EK price from PDF\n              ekPrice: pdfMetadata.ekPrice,\n              // Add additional PDF metadata\n              pdfArticleNumber: pdfMetadata.articleNumber,\n              pdfEanCode: pdfMetadata.eanCode,\n              pdfProductName: pdfMetadata.productName,\n              // Preserve manufacturer article number from PDF if available\n              manufacturerArticleNumber: pdfMetadata.manufacturerArticleNumber || data.product.manufacturerArticleNumber,\n            } : data.product;\n            \n            // Calculate VK if EK exists: (EK  2) + 19% = EK  2.38, rounded to ,95\n            if (mergedProduct.ekPrice) {\n              const ekValue = parseFloat(mergedProduct.ekPrice.replace(',', '.'));\n              if (!isNaN(ekValue)) {\n                const vkValue = Math.floor(ekValue * 2 * 1.19) + 0.95;\n                mergedProduct.vkPrice = vkValue.toFixed(2).replace('.', ',');\n              }\n            }\n            \n            console.log(' [PDF-FLOW] Merged product fields:', Object.keys(mergedProduct));\n            console.log(' [PDF-FLOW] Nitecore fields in merged product:', {\n              length: mergedProduct.length,\n              led1: mergedProduct.led1,\n              led2: mergedProduct.led2,\n              maxLuminosity: mergedProduct.maxLuminosity\n            });\n            \n            products.push(mergedProduct);\n          } else {\n            console.error(`Fehler beim Scrapen von ${productUrl}`);\n            failedCount++;\n          }\n        } catch (err) {\n          console.error(`Fehler beim Scrapen von ${productUrl}:`, err);\n          failedCount++;\n        }\n\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n\n      if (failedCount > 0) {\n        toast({\n          title: \"Teilweise erfolgreich\",\n          description: `${products.length} erfolgreich, ${failedCount} fehlgeschlagen`,\n          variant: \"destructive\",\n        });\n      }\n\n      setScrapedProducts(products);\n      \n      // Save scraped products back to PDF-Auto-Scraper sessionStorage\n      // Create URLProduct map for easy merging in PDF-Auto-Scraper\n      const urlToScrapedData: Record<string, any> = {};\n      products.forEach(product => {\n        if (product.url) {\n          urlToScrapedData[product.url] = {\n            images: product.images || [],\n            localImagePaths: product.localImagePaths || [],\n            articleNumber: product.articleNumber,\n            eanCode: product.ean,\n            productName: product.productName,\n            description: product.description,\n            longDescription: product.longDescription,\n          };\n        }\n      });\n      sessionStorage.setItem('pdf_url_scraped_data', JSON.stringify(urlToScrapedData));\n      console.log(` Saved ${Object.keys(urlToScrapedData).length} scraped products to sessionStorage for PDF-Auto-Scraper`);\n      \n      if (abortScrapingRef.current) {\n        setBatchProgress({ current: products.length, total: urls.length, status: \"Abgebrochen\" });\n        toast({\n          title: \"Scraping abgebrochen\",\n          description: `${products.length} von ${urls.length} Produkten gescraped`,\n          variant: \"destructive\",\n        });\n      } else {\n        setBatchProgress({ current: products.length, total: urls.length, status: \"Fertig!\" });\n        toast({\n          title: \"PDF-Scraping abgeschlossen\",\n          description: `${products.length} von ${urls.length} Produkten erfolgreich gescraped (inkl. EK-Preise aus PDF)`,\n        });\n      }\n    } catch (error) {\n      console.error('PDF scraping error:', error);\n      toast({\n        title: \"Fehler\",\n        description: error instanceof Error ? error.message : 'Scraping fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n      abortScrapingRef.current = false;\n    }\n  };\n\n  // Navigate to Pixi Compare with scraped products\n  const handlePixiCompare = () => {\n    if (scrapedProducts.length === 0) {\n      toast({\n        title: 'Keine Produkte',\n        description: 'Bitte scrapen Sie zuerst Produkte',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Get the selected supplier to find the SupplNr\n    const selectedSupplier = suppliersData?.suppliers?.find(s => s.id === selectedSupplierId);\n    const supplNr = selectedSupplier?.supplNr;\n    const supplierName = selectedSupplier?.name || 'Unbekannt';\n\n    // STRICT VALIDATION: Supplier with SupplNr is required\n    if (!supplNr || selectedSupplierId === '__none__') {\n      toast({\n        title: 'Lieferant erforderlich',\n        description: 'Bitte whlen Sie einen Lieferanten mit hinterlegter Pixi-Lieferantennummer aus. Sie knnen diese im Lieferanten-Men konfigurieren.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Convert scraped products to COMPLETE Brickfox CSV format for Pixi Compare\n    const csvData = scrapedProducts.map(product => {\n      // Get AI-generated description if available\n      const generatedContent = generatedDescriptions.get(product.articleNumber);\n      \n      // Extract images: Prioritize URLs, then convert local paths to URLs\n      let imageUrls: string[] = [];\n      \n      // First try: Original image URLs from scraping\n      if (product.images && product.images.length > 0) {\n        imageUrls = product.images;\n      }\n      // Second try: Convert local paths to full URLs\n      else if (product.localImagePaths && product.localImagePaths.length > 0) {\n        const domain = window.location.hostname === 'localhost' \n          ? 'http://localhost:5000'\n          : `https://${window.location.host}`;\n        imageUrls = product.localImagePaths.map(path => \n          `${domain}${path.startsWith('/') ? path : '/' + path}`\n        );\n      }\n      \n      console.log(` Image URLs for ${product.articleNumber}:`, imageUrls);\n      \n      // Create separate p_image[1] to p_image[10] columns\n      const imageColumns: Record<string, string> = {};\n      for (let i = 1; i <= 10; i++) {\n        imageColumns[`p_image[${i}]`] = imageUrls[i - 1] || '';\n      }\n      \n      // Helper: Parse price (EXACT backend logic - returns number | null)\n      // Handles \"UVP: 1.234,56 \"  1234.56, \"EUR 9,92\"  9.92, \"\"  null, 0  0\n      const parsePrice = (price: string | number | null | undefined): number | null => {\n        if (price === null || price === undefined) return null;\n        if (typeof price === 'number') return price;  // Early return for numbers (0 is valid!)\n        \n        const priceStr = String(price);\n        \n        // Remove ALL non-numeric characters except comma, dot, minus (like backend)\n        // Handles \"UVP: 39,75 \", \"EUR 1.234,56\", \"Preis: 9,92 \" etc.\n        let str = priceStr.replace(/[^\\d,.-]/g, '').trim();\n        \n        // German decimal format handling:\n        // - Comma = decimal separator\n        // - Dot = thousand separator\n        // Examples: \"1.234,56\"  1234.56, \"39,75\"  39.75, \"9,92\"  9.92\n        let normalized = str;\n        if (str.includes(',')) {\n          // Has comma  German format with decimal\n          // Remove all dots (thousand separators), replace comma with dot\n          // \"1.234,56\"  \"1234.56\", \"39,75\"  \"39.75\"\n          normalized = str.replace(/\\./g, '').replace(',', '.');\n        } else if (str.includes('.')) {\n          // Has dot but no comma  Could be German thousand separator OR English decimal\n          // Heuristic: Dot followed by exactly 3 digits  German thousand separator\n          // \"1.234\"  1234 (thousand)\n          // \"2.500\"  2500 (thousand)\n          // \"15.99\"  15.99 (decimal, only 2 digits)\n          const dotMatch = str.match(/\\.(\\d+)$/);\n          if (dotMatch && dotMatch[1].length === 3) {\n            // Exactly 3 digits after last dot  German thousand separator\n            normalized = str.replace(/\\./g, '');\n          }\n          // Otherwise keep dot as decimal: \"15.99\", \"10.50\"\n        }\n        // No dot or comma: \"101\"  \"101\", \"250\"  \"250\"\n        \n        // Convert to number and return null if invalid (like backend)\n        const value = parseFloat(normalized);\n        return isNaN(value) ? null : value;\n      };\n      \n      // Helper: Calculate net sales price (EK * 2)\n      const calculateVKNetto = (ek: number): number => {\n        return ek * 2;\n      };\n      \n      // Helper: Calculate gross sales price (EK * 2 + 19% = EK * 2 * 1.19)\n      const calculateVKBrutto = (ek: number): number => {\n        return ek * 2 * 1.19;\n      };\n      \n      const ekPrice = parsePrice(product.price);\n      const vkPriceNetto = ekPrice !== null ? calculateVKNetto(ekPrice) : null;\n      const vkPriceBrutto = ekPrice !== null ? calculateVKBrutto(ekPrice) : null;\n      \n      return {\n        // === PRODUCT FIELDS ===\n        'p_item_number': product.articleNumber || '',\n        'p_group_path[de]': product.category || '',\n        'p_brand': product.manufacturer || '',\n        'p_status': 'Aktiv',\n        'p_name[de]': product.productName || '',\n        'p_tax_class': 'Regelsteuersatz (19%)',\n        'p_never_out_of_stock': 'false',\n        'p_condition': 'Neu',\n        'p_country': 'China',\n        'p_description[de]': generatedContent?.description || product.description || product.longDescription || '',\n        ...imageColumns,  // p_image[1] to p_image[10]\n        \n        // === VARIANT FIELDS ===\n        'v_item_number': product.articleNumber || '',\n        'v_ean': product.ean || '',\n        'v_manufacturers_item_number': product.articleNumber?.replace(/^ANS/, '') || '',\n        'v_supplier_item_number': product.articleNumber || '',\n        'v_status': 'aktiv',\n        'v_classification': 'X',\n        'v_delivery_time[de]': '3-5 Tage',\n        'v_supplier[Eur]': vkPriceBrutto !== null ? vkPriceBrutto.toFixed(2) : '',  // VK-Preis (EK * 2 * 1.19)\n        'v_purchase_price': ekPrice !== null ? ekPrice.toFixed(2) : '',\n        'v_price[Eur]': ekPrice !== null ? ekPrice.toFixed(2) : '',  // EK-Preis\n        'v_price_net': vkPriceNetto !== null ? vkPriceNetto.toFixed(2) : '',  // EK * 2 (Netto-VK)\n        'v_price_gross': vkPriceBrutto !== null ? vkPriceBrutto.toFixed(2) : '',  // EK * 2 * 1.19 (Brutto-VK)\n        'v_never_out_of_stock[standard]': 'true',\n        'v_weight': product.weight || product.gewicht || '',\n        'v_length': product.length || product.laenge || '',\n        'v_width': product.bodyDiameter || product.breite || '',\n        'v_height': product.headDiameter || product.hoehe || '',\n        \n        // === ANSMANN-SPEZIFISCHE FELDER ===\n        'v_capacity_mah': product.nominalkapazitaet || '',\n        'v_voltage': product.nominalspannung || '',\n        'v_max_discharge_current': product.maxEntladestrom || '',\n        'v_cell_chemistry': product.zellenchemie || '',\n        'v_energy': product.energie || '',\n        'v_color': product.farbe || '',\n        \n        // === NITECORE-SPEZIFISCHE FELDER ===\n        'v_power_supply': product.powerSupply || '',\n        'v_led_1': product.led1 || '',\n        'v_led_2': product.led2 || '',\n        'v_spot_intensity': product.spotIntensity || '',\n        'v_max_luminosity': product.maxLuminosity || '',\n        'v_max_beam_distance': product.maxBeamDistance || '',\n        'v_runtime_high': product.runtimeHigh || '',\n        'v_runtime_low': product.runtimeLow || '',\n        'v_impact_resistance': product.impactResistance || '',\n        'v_waterproof_rating': product.waterproofRating || '',\n        \n        // === SEO FELDER (wenn AI-generiert) ===\n        'p_seo_title[de]': generatedContent?.seoTitle || '',\n        'p_seo_description[de]': generatedContent?.seoDescription || '',\n        'p_seo_keywords[de]': generatedContent?.seoKeywords || '',\n      };\n    });\n\n    // Store data AND supplier number in sessionStorage for Pixi Compare\n    sessionStorage.setItem('pixi_compare_data', JSON.stringify(csvData));\n    sessionStorage.setItem('pixi_compare_source', 'url-scraper');\n    sessionStorage.setItem('pixi_compare_supplNr', supplNr);\n    \n    toast({\n      title: 'Daten vorbereitet',\n      description: `${scrapedProducts.length} Produkte werden zum Pixi-Vergleich bertragen (Lieferant ${selectedSupplier.name}: ${supplNr})`,\n    });\n    \n    // Navigate to Pixi Compare\n    setLocation('/pixi-compare?from=url-scraper');\n  };\n\n  // Copy HTML to clipboard\n  const handleCopyHtml = async (articleNumber: string) => {\n    const htmlContent = generatedDescriptions.get(articleNumber)?.description;\n    if (!htmlContent) return;\n\n    try {\n      await navigator.clipboard.writeText(htmlContent);\n      setCopiedArticleNumber(articleNumber);\n      \n      toast({\n        title: \"Erfolgreich kopiert\",\n        description: \"HTML-Code wurde in die Zwischenablage kopiert\",\n      });\n\n      // Reset copied state after 2 seconds\n      setTimeout(() => {\n        setCopiedArticleNumber(null);\n      }, 2000);\n    } catch (error) {\n      console.error('Copy error:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"HTML konnte nicht kopiert werden\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleGenerateDescription = async () => {\n    if (!scrapedProduct) return;\n\n    setIsGenerating(true);\n    try {\n      // Refresh token before generation\n      const { data: { session } } = await supabase.auth.getSession();\n      if (session?.access_token) {\n        localStorage.setItem('supabase_token', session.access_token);\n      }\n\n      const productData = {\n        productName: scrapedProduct.productName,\n        articleNumber: scrapedProduct.articleNumber,\n        ean: scrapedProduct.ean,\n        manufacturer: scrapedProduct.manufacturer,\n        price: scrapedProduct.price,\n        weight: scrapedProduct.weight,\n        category: scrapedProduct.category,\n        description: scrapedProduct.description,\n      };\n\n      const token = localStorage.getItem('supabase_token');\n      const response = await fetch('/api/generate-description', {\n        method: 'POST',\n        headers: { \n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          extractedData: [productData],\n          customAttributes: {\n            exactProductName: scrapedProduct.productName,\n          },\n          // SMART AUTO-EXTRACTION: Pass auto-extracted data to AI\n          autoExtractedDescription: (scrapedProduct as any).autoExtractedDescription,\n          technicalDataTable: (scrapedProduct as any).technicalDataTable,\n          safetyWarnings: (scrapedProduct as any).safetyWarnings, // 1:1 safety warnings\n          pdfManualUrl: (scrapedProduct as any).pdfManualUrl, // PDF manual URL\n          // COST OPTIMIZATION: GPT-4o-mini ist 30 gnstiger!\n          model: 'gpt-4o-mini',\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'AI-Generierung fehlgeschlagen');\n      }\n\n      const data = await response.json();\n      setGeneratedDescription(data.description || '');\n      \n      // Store complete AI data including categoryId\n      setSingleProductAiData({\n        description: data.description || '',\n        seoTitle: data.seoTitle || '',\n        seoDescription: data.seoDescription || '',\n        seoKeywords: data.seoKeywords || '',\n        categoryId: data.categoryId || ''\n      });\n      \n      // Update scrapedProduct with generated description\n      if (scrapedProduct) {\n        setScrapedProduct({\n          ...scrapedProduct,\n          description: data.description || ''\n        });\n      }\n      \n      toast({\n        title: \"Erfolgreich\",\n        description: \"AI-Beschreibung wurde generiert\",\n      });\n\n    } catch (error) {\n      console.error('AI generation error:', error);\n      toast({\n        title: \"Fehler\",\n        description: error instanceof Error ? error.message : 'AI-Generierung fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  // BATCH AI GENERATION: Generate descriptions for all scraped products (PARALLEL VERSION - 10 faster!)\n  const handleGenerateAllDescriptions = async () => {\n    if (scrapedProducts.length === 0) return;\n\n    setIsGeneratingBatch(true);\n    setAiGenerationProgress({ current: 0, total: scrapedProducts.length });\n\n    const newDescriptions = new Map<string, GeneratedContent>();\n    let successCount = 0;\n    let errorCount = 0;\n\n    try {\n      // Refresh token before batch generation\n      const { data: { session } } = await supabase.auth.getSession();\n      if (session?.access_token) {\n        localStorage.setItem('supabase_token', session.access_token);\n      } else {\n        throw new Error('Keine gltige Session. Bitte neu anmelden.');\n      }\n\n      const BATCH_SIZE = 5; // Process 5 products simultaneously\n      const TIMEOUT_MS = 30000; // 30 seconds timeout per product\n\n      // Helper function to generate description with timeout\n      const generateWithTimeout = async (product: any, index: number) => {\n        const timeoutPromise = new Promise((_, reject) =>\n          setTimeout(() => reject(new Error('Timeout after 30s')), TIMEOUT_MS)\n        );\n\n        const generatePromise = (async () => {\n          const productData = {\n            productName: product.productName,\n            articleNumber: product.articleNumber,\n            ean: product.ean,\n            manufacturer: product.manufacturer,\n            price: product.price,\n            weight: product.weight,\n            category: product.category,\n            description: product.description,\n          };\n\n          // WICHTIG: Alle gescrapten technischen Felder bertragen (length, bodyDiameter, led1, etc.)\n          console.log(' [AI-GEN] All product fields:', Object.keys(product));\n          console.log(' [AI-GEN] Nitecore fields in product object:', {\n            length: product.length,\n            led1: product.led1,\n            led2: product.led2,\n            maxLuminosity: product.maxLuminosity\n          });\n          \n          const structuredData: any = {};\n          Object.keys(product).forEach((key) => {\n            // berspringe Basis-Felder (die bereits in productData sind)\n            const skipFields = ['productName', 'articleNumber', 'ean', 'manufacturer', 'price', 'weight', 'category', 'description', 'images', 'autoExtractedDescription', 'technicalDataTable', 'safetyWarnings', 'pdfManualUrl'];\n            if (!skipFields.includes(key) && product[key] !== undefined && product[key] !== null && product[key] !== '') {\n              structuredData[key] = product[key];\n            }\n          });\n          \n          console.log(` Strukturierte Daten (${Object.keys(structuredData).length} Felder):`, Object.keys(structuredData));\n          console.log(` Nitecore-Felder in structuredData:`, {\n            length: structuredData.length,\n            led1: structuredData.led1,\n            led2: structuredData.led2,\n            maxLuminosity: structuredData.maxLuminosity\n          });\n\n          const token = localStorage.getItem('supabase_token');\n          const response = await fetch('/api/generate-description', {\n            method: 'POST',\n            headers: { \n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify({\n              extractedData: [productData],\n              structuredData: Object.keys(structuredData).length > 0 ? structuredData : undefined,\n              customAttributes: {\n                exactProductName: product.productName,\n              },\n              autoExtractedDescription: (product as any).autoExtractedDescription,\n              technicalDataTable: (product as any).technicalDataTable,\n              safetyWarnings: (product as any).safetyWarnings,\n              pdfManualUrl: (product as any).pdfManualUrl,\n              model: 'gpt-4o-mini',\n            }),\n          });\n\n          if (!response.ok) {\n            throw new Error('AI-Generierung fehlgeschlagen');\n          }\n\n          return await response.json();\n        })();\n\n        return Promise.race([generatePromise, timeoutPromise]);\n      };\n\n      // Process products in batches of 5\n      for (let i = 0; i < scrapedProducts.length; i += BATCH_SIZE) {\n        const batch = scrapedProducts.slice(i, Math.min(i + BATCH_SIZE, scrapedProducts.length));\n        \n        // Process batch in parallel\n        const results = await Promise.allSettled(\n          batch.map((product, batchIndex) => generateWithTimeout(product, i + batchIndex))\n        );\n\n        // Process results\n        results.forEach((result, batchIndex) => {\n          const product = batch[batchIndex];\n          if (result.status === 'fulfilled') {\n            const data = result.value as any;\n            // Store complete response with description, seoTitle, seoDescription, seoKeywords, categoryId\n            newDescriptions.set(product.articleNumber, {\n              description: data.description || '',\n              seoTitle: data.seoTitle || '',\n              seoDescription: data.seoDescription || '',\n              seoKeywords: data.seoKeywords || '',\n              categoryId: data.categoryId || '' // Store detected category\n            });\n            successCount++;\n          } else {\n            console.error(`Error generating description for ${product.productName}:`, result.reason);\n            errorCount++;\n          }\n        });\n\n        // Update progress\n        setAiGenerationProgress({ \n          current: Math.min(i + BATCH_SIZE, scrapedProducts.length), \n          total: scrapedProducts.length \n        });\n      }\n\n      setGeneratedDescriptions(newDescriptions);\n\n      toast({\n        title: \"Batch-Generierung abgeschlossen\",\n        description: `${successCount} Beschreibungen erfolgreich generiert${errorCount > 0 ? `, ${errorCount} Fehler` : ''}`,\n      });\n\n    } catch (error) {\n      console.error('Batch AI generation error:', error);\n      toast({\n        title: \"Fehler\",\n        description: error instanceof Error ? error.message : 'Batch-Generierung fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGeneratingBatch(false);\n      setAiGenerationProgress({ current: 0, total: 0 });\n    }\n  };\n\n  // Toggle column selection\n  const toggleColumn = (key: string) => {\n    setExportColumns(prev => \n      prev.map(col => col.key === key ? { ...col, enabled: !col.enabled } : col)\n    );\n  };\n\n  const toggleAllColumns = (enabled: boolean) => {\n    setExportColumns(prev => prev.map(col => ({ ...col, enabled })));\n  };\n\n  const convertToCSV = (products: ScrapedProduct[]): string => {\n    if (products.length === 0) return '';\n\n    // Use only enabled columns from exportColumns\n    const selectedColumns = exportColumns.filter(col => col.enabled);\n    const orderedKeys = selectedColumns.map(col => col.key);\n    const headers = selectedColumns.map(col => col.label);\n\n    // CSV Rows - keep HTML in description, escape quotes properly\n    // Fill missing fields with empty strings\n    const rows = products.map(product => \n      orderedKeys.map(key => {\n        // Special handling for AI-generated fields\n        if (key === 'seoTitle') {\n          const aiData = generatedDescriptions.get(product.articleNumber);\n          return (aiData?.seoTitle || '').replace(/\"/g, '\"\"');\n        }\n        if (key === 'seoDescription') {\n          const aiData = generatedDescriptions.get(product.articleNumber);\n          return (aiData?.seoDescription || '').replace(/\"/g, '\"\"');\n        }\n        if (key === 'seoKeywords') {\n          const aiData = generatedDescriptions.get(product.articleNumber);\n          return (aiData?.seoKeywords || '').replace(/\"/g, '\"\"');\n        }\n        if (key === 'description') {\n          const aiData = generatedDescriptions.get(product.articleNumber);\n          const aiDesc = aiData?.description || '';\n          return aiDesc.replace(/\"/g, '\"\"');\n        }\n        \n        const value = product[key as keyof ScrapedProduct];\n        \n        if (key === 'images') {\n          // Return URLs, not local paths\n          let urls: string[] = [];\n          if (product.images && product.images.length > 0) {\n            urls = product.images;\n          } else if (product.localImagePaths && product.localImagePaths.length > 0) {\n            // Convert local paths to full URLs\n            const domain = window.location.hostname === 'localhost' \n              ? 'localhost:5000'\n              : window.location.host;\n            urls = product.localImagePaths.map(path => \n              `https://${domain}${path.startsWith('/') ? path : '/' + path}`\n            );\n          }\n          return urls.join(' | ');\n        }\n        \n        // Return empty string if field is missing\n        return (value as string || '').replace(/\"/g, '\"\"');\n      })\n    );\n\n    // Combine headers and rows\n    const csvContent = [\n      headers.join(','),\n      ...rows.map(row => row.map(cell => `\"${cell}\"`).join(','))\n    ].join('\\n');\n\n    return csvContent;\n  };\n\n  const downloadCSV = () => {\n    if (scrapedProducts.length === 0) {\n      toast({\n        title: 'Keine Produkte',\n        description: 'Bitte scrapen Sie zuerst Produkte',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Get the selected supplier to find the SupplNr\n    const selectedSupplier = suppliersData?.suppliers?.find(s => s.id === selectedSupplierId);\n    const supplierName = selectedSupplier?.name || 'Unbekannt';\n\n    // Convert scraped products to COMPLETE Brickfox CSV format (same as Pixi Compare)\n    const csvData = scrapedProducts.map(product => {\n      // Get AI-generated description if available\n      const generatedContent = generatedDescriptions.get(product.articleNumber);\n      \n      // Extract images: Prioritize URLs, then convert local paths to URLs\n      let imageUrls: string[] = [];\n      \n      // First try: Original image URLs from scraping\n      if (product.images && product.images.length > 0) {\n        imageUrls = product.images;\n      }\n      // Second try: Convert local paths to full URLs\n      else if (product.localImagePaths && product.localImagePaths.length > 0) {\n        const domain = window.location.hostname === 'localhost' \n          ? 'http://localhost:5000'\n          : `https://${window.location.host}`;\n        imageUrls = product.localImagePaths.map(path => \n          `${domain}${path.startsWith('/') ? path : '/' + path}`\n        );\n      }\n      \n      // Create separate p_image[1] to p_image[10] columns\n      const imageColumns: Record<string, string> = {};\n      for (let i = 1; i <= 10; i++) {\n        imageColumns[`p_image[${i}]`] = imageUrls[i - 1] || '';\n      }\n      \n      // Helper: Parse price (EXACT backend logic - returns number | null)\n      const parsePrice = (price: string | number | null | undefined): number | null => {\n        if (price === null || price === undefined) return null;\n        if (typeof price === 'number') return price;\n        \n        const priceStr = String(price);\n        let str = priceStr.replace(/[^\\d,.-]/g, '').trim();\n        \n        let normalized = str;\n        if (str.includes(',')) {\n          normalized = str.replace(/\\./g, '').replace(',', '.');\n        } else if (str.includes('.')) {\n          const dotMatch = str.match(/\\.(\\d+)$/);\n          if (dotMatch && dotMatch[1].length === 3) {\n            normalized = str.replace(/\\./g, '');\n          }\n        }\n        \n        const value = parseFloat(normalized);\n        return isNaN(value) ? null : value;\n      };\n      \n      const calculateVKNetto = (ek: number): number => ek * 2;\n      const calculateVKBrutto = (ek: number): number => ek * 2 * 1.19;\n      \n      const ekPrice = parsePrice(product.price);\n      const vkPriceNetto = ekPrice !== null ? calculateVKNetto(ekPrice) : null;\n      const vkPriceBrutto = ekPrice !== null ? calculateVKBrutto(ekPrice) : null;\n      \n      return {\n        'p_item_number': product.articleNumber || '',\n        'p_group_path[de]': product.category || '',\n        'p_brand': product.manufacturer || '',\n        'p_status': 'Aktiv',\n        'p_name[de]': product.productName || '',\n        'p_tax_class': 'Regelsteuersatz (19%)',\n        'p_never_out_of_stock': 'false',\n        'p_condition': 'Neu',\n        'p_country': 'China',\n        'p_description[de]': generatedContent?.description || product.description || product.longDescription || '',\n        ...imageColumns,\n        \n        'v_item_number': product.articleNumber || '',\n        'v_ean': product.ean || '',\n        'v_manufacturers_item_number': product.articleNumber?.replace(/^ANS/, '') || '',\n        'v_supplier_item_number': product.articleNumber || '',\n        'v_status': 'aktiv',\n        'v_classification': 'X',\n        'v_delivery_time[de]': '3-5 Tage',\n        'v_supplier[Eur]': vkPriceBrutto !== null ? vkPriceBrutto.toFixed(2) : '',\n        'v_purchase_price': ekPrice !== null ? ekPrice.toFixed(2) : '',\n        'v_price[Eur]': ekPrice !== null ? ekPrice.toFixed(2) : '',\n        'v_price_net': vkPriceNetto !== null ? vkPriceNetto.toFixed(2) : '',\n        'v_price_gross': vkPriceBrutto !== null ? vkPriceBrutto.toFixed(2) : '',\n        'v_never_out_of_stock[standard]': 'true',\n        'v_weight': product.weight || product.gewicht || '',\n        'v_length': product.length || product.laenge || '',\n        'v_width': product.bodyDiameter || product.breite || '',\n        'v_height': product.headDiameter || product.hoehe || '',\n        \n        'v_capacity_mah': product.nominalkapazitaet || '',\n        'v_voltage': product.nominalspannung || '',\n        'v_max_discharge_current': product.maxEntladestrom || '',\n        'v_cell_chemistry': product.zellenchemie || '',\n        'v_energy': product.energie || '',\n        'v_color': product.farbe || '',\n        \n        'v_power_supply': product.powerSupply || '',\n        'v_led_1': product.led1 || '',\n        'v_led_2': product.led2 || '',\n        'v_spot_intensity': product.spotIntensity || '',\n        'v_max_output': product.maxOutput || '',\n        'v_luminosity': product.luminosity || '',\n        'v_runtime': product.runtime || '',\n        'v_waterproof': product.waterproof || '',\n        \n        'p_seo_title[de]': generatedContent?.seoTitle || '',\n        'p_seo_description[de]': generatedContent?.seoDescription || '',\n        'p_seo_keywords[de]': generatedContent?.seoKeywords || '',\n      };\n    });\n\n    // Convert to CSV\n    if (csvData.length === 0) return;\n    \n    const headers = Object.keys(csvData[0]);\n    const rows = csvData.map(row => \n      headers.map(header => {\n        const value = row[header as keyof typeof row] || '';\n        return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n      }).join(',')\n    );\n    \n    const csvContent = [headers.join(','), ...rows].join('\\n');\n    const csvWithBOM = '\\ufeff' + csvContent;\n    \n    const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    \n    link.setAttribute('href', url);\n    link.setAttribute('download', `brickfox_${new Date().toISOString().split('T')[0]}.csv`);\n    link.style.visibility = 'hidden';\n    \n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n\n    toast({\n      title: \"Brickfox CSV heruntergeladen\",\n      description: `${scrapedProducts.length} Produkte im Brickfox-Format exportiert`,\n    });\n  };\n\n  const handleSaveToProject = async () => {\n    if (!scrapedProduct) return;\n\n    if (selectedProjectId === \"new\" && !projectName.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie einen Projektnamen ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (selectedProjectId !== \"new\" && !selectedProjectId) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte whlen Sie ein Projekt aus\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      if (selectedProjectId === \"new\") {\n        // Create new project with single product\n        \n        // Helper: Extract product type word directly from product name\n        const extractProductTypeFromName = (productName: string): string => {\n          const words = productName.split(/[\\s-]+/);\n          // Find product type keywords (usually nouns ending in common patterns)\n          const productTypeKeywords = ['lampe', 'batterie', 'akku', 'ladegert', 'ladestation', 'charger', 'pack'];\n          \n          for (const word of words) {\n            const lowerWord = word.toLowerCase();\n            if (productTypeKeywords.some(keyword => lowerWord.includes(keyword))) {\n              // Return the capitalized word as found in product name\n              return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();\n            }\n          }\n          return 'Produkt';\n        };\n        \n        // MediaMarkt V1: Produkttyp (aus Produktname) + Modellcode (z.B. \"Taschenlampe NCCG7\") - OHNE Marke!\n        const productType = extractProductTypeFromName(scrapedProduct.productName);\n        const modelCode = (scrapedProduct.articleNumber || '').replace(/^[A-Z]+-/, '').trim();\n        const mmV1 = modelCode ? `${productType} ${modelCode}` : productType;\n        \n        // MediaMarkt V2: Nur Modellcodes (ohne ANS- Prfix)\n        const mmV2 = modelCode;\n\n        await apiPost('/api/bulk-save-to-project', {\n          projectName: projectName.trim(),\n          products: [{\n            produktname: scrapedProduct.productName,\n            artikelnummer: scrapedProduct.articleNumber || '',\n            produktbeschreibung: generatedDescription || '',\n            ean: scrapedProduct.ean || '',\n            hersteller: scrapedProduct.manufacturer || '',\n            preis: scrapedProduct.price || '',\n            gewicht: scrapedProduct.weight || '',\n            kategorie: scrapedProduct.category || '',\n            mediamarktname_v1: mmV1,\n            mediamarktname_v2: mmV2,\n            seo_beschreibung: scrapedProduct.description?.substring(0, 200) || '',\n            source_url: url,\n          }],\n        });\n\n        toast({\n          title: \"Projekt erstellt\",\n          description: `Produkt wurde erfolgreich in \"${projectName.trim()}\" gespeichert`,\n        });\n      } else {\n        // Add to existing project\n        const extractedDataArray = [\n          scrapedProduct.ean ? { key: 'ean', value: scrapedProduct.ean, type: 'text' as const } : null,\n          scrapedProduct.manufacturer ? { key: 'hersteller', value: scrapedProduct.manufacturer, type: 'text' as const } : null,\n          scrapedProduct.price ? { key: 'preis', value: scrapedProduct.price, type: 'text' as const } : null,\n          scrapedProduct.weight ? { key: 'gewicht', value: scrapedProduct.weight, type: 'text' as const } : null,\n          scrapedProduct.category ? { key: 'kategorie', value: scrapedProduct.category, type: 'text' as const } : null,\n        ].filter((item): item is { key: string; value: string; type: 'text' } => item !== null);\n\n        await apiPost(`/api/projects/${selectedProjectId}/products`, {\n          name: scrapedProduct.productName,\n          articleNumber: scrapedProduct.articleNumber || '',\n          htmlCode: generatedDescription || '',\n          previewText: scrapedProduct.description?.substring(0, 200) || '',\n          exactProductName: scrapedProduct.productName,\n          extractedData: extractedDataArray.length > 0 ? extractedDataArray : undefined,\n          customAttributes: [\n            { key: 'source_url', value: url, type: 'text' },\n          ].filter(attr => attr.value),\n        });\n\n        const project = projectsData?.projects.find(p => p.id === selectedProjectId);\n        toast({\n          title: \"Produkt hinzugefgt\",\n          description: `Produkt wurde erfolgreich zu \"${project?.name}\" hinzugefgt`,\n        });\n      }\n\n      // Invalidate queries to refresh product counts\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      // Invalidate all product-counts queries\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === '/api/projects/product-counts'\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/products`] });\n\n      setShowSaveDialog(false);\n      setProjectName(\"\");\n      setSelectedProjectId(\"new\");\n\n      // Clear scrape session after saving to project\n      try {\n        const token = localStorage.getItem('supabase_token');\n        if (token) {\n          await fetch('/api/scrape-session', {\n            method: 'DELETE',\n            headers: {\n              'Authorization': `Bearer ${token}`,\n            },\n          });\n          console.log(' Scrape session cleared after project save');\n        }\n      } catch (error) {\n        console.error('Failed to clear scrape session:', error);\n      }\n\n      // Redirect to projects page\n      setTimeout(() => {\n        setLocation('/projects');\n      }, 1000);\n\n    } catch (err) {\n      toast({\n        title: \"Fehler\",\n        description: err instanceof Error ? err.message : 'Speichern fehlgeschlagen',\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  // Bulk save all scraped products to project\n  const handleBulkSaveToProject = async () => {\n    if (scrapedProducts.length === 0) return;\n\n    if (selectedProjectId === \"new\" && !projectName.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie einen Projektnamen ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (selectedProjectId !== \"new\" && !selectedProjectId) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte whlen Sie ein Projekt aus\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      // Convert all scraped products to the format expected by the API\n      const products = scrapedProducts.map((product) => {\n        const generatedContent = generatedDescriptions.get(product.articleNumber);\n        \n        // Extract ALL fields dynamically (exclude metadata fields)\n        const excludeFields = ['articleNumber', 'productName', 'description', 'images', 'localImagePaths'];\n        const extractedDataArray: any[] = [];\n        \n        Object.entries(product).forEach(([key, value]) => {\n          if (!excludeFields.includes(key) && value !== undefined && value !== null && value !== '') {\n            // Convert camelCase to lowercase (e.g., manufacturer -> hersteller)\n            const fieldMap: { [key: string]: string } = {\n              'manufacturer': 'hersteller',\n              'price': 'preis',\n              'weight': 'gewicht'\n            };\n            const mappedKey = fieldMap[key] || key;\n            extractedDataArray.push({ key: mappedKey, value: String(value), type: 'text' as const });\n          }\n        });\n        \n        // CRITICAL: Add images, localImagePaths, and pdfFiles to extractedData for Brickfox export\n        if (product.images && product.images.length > 0) {\n          extractedDataArray.push({ key: 'images', value: JSON.stringify(product.images), type: 'text' as const });\n        }\n        if (product.localImagePaths && product.localImagePaths.length > 0) {\n          extractedDataArray.push({ key: 'localImagePaths', value: JSON.stringify(product.localImagePaths), type: 'text' as const });\n        }\n        if ((product as any).pdfFiles && (product as any).pdfFiles.length > 0) {\n          extractedDataArray.push({ key: 'pdfFiles', value: JSON.stringify((product as any).pdfFiles), type: 'text' as const });\n        }\n        \n        // Helper: Extract product type word directly from product name\n        const extractProductTypeFromName = (productName: string): string => {\n          const words = productName.split(/[\\s-]+/);\n          // Find product type keywords (usually nouns ending in common patterns)\n          const productTypeKeywords = ['lampe', 'batterie', 'akku', 'ladegert', 'ladestation', 'charger', 'pack'];\n          \n          for (const word of words) {\n            const lowerWord = word.toLowerCase();\n            if (productTypeKeywords.some(keyword => lowerWord.includes(keyword))) {\n              // Return the capitalized word as found in product name\n              return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();\n            }\n          }\n          return 'Produkt';\n        };\n        \n        // MediaMarkt V1: Produkttyp (aus Produktname) + Modellcode (z.B. \"Taschenlampe NCCG7\") - OHNE Marke!\n        const productType = extractProductTypeFromName(product.productName);\n        const modelCode = (product.articleNumber || '').replace(/^[A-Z]+-/, '').trim();\n        const mmV1 = modelCode ? `${productType} ${modelCode}` : productType;\n        \n        // MediaMarkt V2: Nur Modellcodes (ohne ANS- Prfix)\n        const mmV2 = modelCode;\n        \n        return {\n          produktname: product.productName,\n          artikelnummer: product.articleNumber || '',\n          produktbeschreibung: generatedContent?.description || '',\n          extractedData: extractedDataArray, // ALL scraped fields as array\n          mediamarktname_v1: mmV1,\n          mediamarktname_v2: mmV2,\n          seo_beschreibung: generatedContent?.seoDescription || product.description?.substring(0, 200) || '',\n          source_url: url,\n        };\n      });\n\n      if (selectedProjectId === \"new\") {\n        // Create new project with all products\n        await apiPost('/api/bulk-save-to-project', {\n          projectName: projectName.trim(),\n          products,\n        });\n\n        toast({\n          title: \"Projekt erstellt\",\n          description: `${scrapedProducts.length} Produkte wurden erfolgreich in \"${projectName.trim()}\" gespeichert`,\n        });\n      } else {\n        // Add all products to existing project\n        for (const product of scrapedProducts) {\n          const generatedContent = generatedDescriptions.get(product.articleNumber);\n          const extractedDataArray = [\n            product.ean ? { key: 'ean', value: product.ean, type: 'text' as const } : null,\n            product.manufacturer ? { key: 'hersteller', value: product.manufacturer, type: 'text' as const } : null,\n            product.price ? { key: 'preis', value: product.price, type: 'text' as const } : null,\n            product.weight ? { key: 'gewicht', value: product.weight, type: 'text' as const } : null,\n            // CRITICAL: Add images and PDFs for Brickfox export (original URLs have priority)\n            product.images && product.images.length > 0 ? { key: 'images', value: JSON.stringify(product.images), type: 'text' as const } : null,\n            product.localImagePaths && product.localImagePaths.length > 0 ? { key: 'localImagePaths', value: JSON.stringify(product.localImagePaths), type: 'text' as const } : null,\n            (product as any).pdfFiles && (product as any).pdfFiles.length > 0 ? { key: 'pdfFiles', value: JSON.stringify((product as any).pdfFiles), type: 'text' as const } : null,\n          ].filter((item): item is { key: string; value: string; type: 'text' } => item !== null);\n\n          await apiPost(`/api/projects/${selectedProjectId}/products`, {\n            name: product.productName,\n            articleNumber: product.articleNumber || '',\n            htmlCode: generatedContent?.description || '',\n            previewText: generatedContent?.seoDescription || product.description?.substring(0, 200) || '',\n            exactProductName: product.productName,\n            images: product.images || [], // CRITICAL: Store original image URLs directly\n            extractedData: extractedDataArray.length > 0 ? extractedDataArray : undefined,\n            customAttributes: [\n              { key: 'source_url', value: url, type: 'text' },\n            ].filter(attr => attr.value),\n          });\n        }\n\n        const project = projectsData?.projects.find(p => p.id === selectedProjectId);\n        toast({\n          title: \"Produkte hinzugefgt\",\n          description: `${scrapedProducts.length} Produkte wurden erfolgreich zu \"${project?.name}\" hinzugefgt`,\n        });\n      }\n\n      // Invalidate queries to refresh product counts\n      queryClient.invalidateQueries({ queryKey: ['/api/projects'] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === '/api/projects/product-counts'\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/products`] });\n\n      setShowBulkSaveDialog(false);\n      setProjectName(\"\");\n      setSelectedProjectId(\"new\");\n\n      // Clear scrape session after saving to project\n      try {\n        const token = localStorage.getItem('supabase_token');\n        if (token) {\n          await fetch('/api/scrape-session', {\n            method: 'DELETE',\n            headers: {\n              'Authorization': `Bearer ${token}`,\n            },\n          });\n          console.log(' Scrape session cleared after bulk project save');\n        }\n      } catch (error) {\n        console.error('Failed to clear scrape session:', error);\n      }\n\n      // Redirect to projects page\n      setTimeout(() => {\n        setLocation('/projects');\n      }, 1000);\n\n    } catch (error) {\n      toast({\n        title: \"Fehler\",\n        description: \"Fehler beim Speichern der Produkte\",\n        variant: \"destructive\",\n      });\n      console.error('Error saving products:', error);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  // Check if coming from PDF Auto-Scraper\n  const isFromPdfAutoScraper = window.location.search.includes('from=pdf-auto-scraper');\n\n  return (\n    <div className=\"min-h-screen bg-background p-6\">\n      <div className=\"max-w-6xl mx-auto space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold\">URL Webscraper</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Extrahieren Sie Produktdaten direkt von Lieferanten-Websites\n            </p>\n          </div>\n          \n          {/* Back to PDF Auto-Scraper button (only shown when coming from PDF-Auto-Scraper) */}\n          {isFromPdfAutoScraper && (\n            <Button\n              variant=\"outline\"\n              onClick={() => setLocation('/pdf-auto-scraper')}\n              className=\"gap-2\"\n            >\n              <ArrowLeft className=\"w-4 h-4\" />\n              Zurck zum PDF-Auto-Scraper\n            </Button>\n          )}\n        </div>\n\n        {/* Lieferanten-Shop Scraper */}\n        <Card className=\"p-6\">\n          <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"list-url\">Kategorieseiten-URL</Label>\n                <Input\n                  id=\"list-url\"\n                  type=\"url\"\n                  placeholder=\"https://www.beispiel.de/kategorie/akkus\"\n                  value={url}\n                  onChange={(e) => setUrl(e.target.value)}\n                  className=\"mt-2\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  URL der Seite mit der Produktliste (z.B. Kategorie- oder Suchseite)\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"supplier-select\">Lieferant auswhlen (optional)</Label>\n                <Select value={selectedSupplierId} onValueChange={handleSupplierSelect}>\n                  <SelectTrigger id=\"supplier-select\" className=\"mt-2\">\n                    <SelectValue placeholder=\"Lieferant whlen oder manuell konfigurieren\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"__none__\">Keine Vorlage (Auto-Erkennung)</SelectItem>\n                    {suppliersData?.suppliers?.map((supplier) => (\n                      <SelectItem key={supplier.id} value={supplier.id}>\n                        {supplier.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                   Gespeicherte CSS-Selektoren fr diesen Lieferanten laden\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"product-link-selector\">Produktlink CSS-Selektor (optional)</Label>\n                <Input\n                  id=\"product-link-selector\"\n                  placeholder=\"a.product-link (leer lassen fr automatische Erkennung)\"\n                  value={productLinkSelector}\n                  onChange={(e) => setProductLinkSelector(e.target.value)}\n                  className=\"mt-2\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                   Leer lassen fr intelligente Auto-Erkennung. Nur ausfllen, wenn die automatische Erkennung fehlschlgt.\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"max-products\">Maximale Anzahl Produkte</Label>\n                <Input\n                  id=\"max-products\"\n                  type=\"number\"\n                  min=\"1\"\n                  value={maxProducts}\n                  onChange={(e) => setMaxProducts(parseInt(e.target.value) || 50)}\n                  className=\"mt-2\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                   Sie knnen beliebig viele Produkte scrapen\n                </p>\n              </div>\n\n              {/* Pagination Options */}\n              <div className=\"p-4 border rounded-lg bg-muted/20 space-y-4\">\n                <div className=\"flex items-center gap-2\">\n                  <Checkbox\n                    id=\"enable-pagination\"\n                    checked={enablePagination}\n                    onCheckedChange={(checked) => setEnablePagination(!!checked)}\n                  />\n                  <Label htmlFor=\"enable-pagination\" className=\"cursor-pointer font-medium\">\n                     Alle Seiten scrapen (Paginierung)\n                  </Label>\n                </div>\n                \n                {enablePagination && (\n                  <>\n                    <div>\n                      <Label htmlFor=\"pagination-selector\" className=\"text-sm\">Pagination CSS-Selektor (optional)</Label>\n                      <Input\n                        id=\"pagination-selector\"\n                        placeholder=\"a[rel='next'], .pagination .next (leer fr Auto-Erkennung)\"\n                        value={paginationSelector}\n                        onChange={(e) => setPaginationSelector(e.target.value)}\n                        className=\"mt-2 text-sm\"\n                      />\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                         Selektor fr den \"Nchste Seite\"-Button. Leer lassen fr automatische Erkennung.\n                      </p>\n                    </div>\n                    \n                    <div>\n                      <Label htmlFor=\"max-pages\" className=\"text-sm\">Maximale Seitenanzahl</Label>\n                      <Input\n                        id=\"max-pages\"\n                        type=\"number\"\n                        min=\"1\"\n                        value={maxPages}\n                        onChange={(e) => setMaxPages(parseInt(e.target.value) || 10)}\n                        className=\"mt-2 text-sm\"\n                      />\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                         Sie knnen beliebig viele Seiten scrapen\n                      </p>\n                    </div>\n                  </>\n                )}\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button onClick={handleScrapeProductList} disabled={isLoading} className=\"flex-1\">\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      {batchProgress.status}\n                    </>\n                  ) : (\n                    <>\n                      <List className=\"w-4 h-4 mr-2\" />\n                      Produktliste scrapen\n                    </>\n                  )}\n                </Button>\n\n                {isLoading && batchProgress.total > 0 && (\n                  <Button\n                    onClick={() => {\n                      abortScrapingRef.current = true;\n                      toast({\n                        title: \"Wird abgebrochen...\",\n                        description: \"Das Scraping wird nach dem aktuellen Produkt gestoppt\",\n                      });\n                    }}\n                    variant=\"destructive\"\n                  >\n                    Abbrechen\n                  </Button>\n                )}\n              </div>\n\n              {isLoading && batchProgress.total > 0 && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span>{batchProgress.status}</span>\n                    <span className=\"font-semibold\">\n                      {batchProgress.current} / {batchProgress.total}\n                      <span className=\"text-muted-foreground ml-2\">\n                        ({Math.round((batchProgress.current / batchProgress.total) * 100)}%)\n                      </span>\n                    </span>\n                  </div>\n                  <Progress value={(batchProgress.current / batchProgress.total) * 100} />\n                </div>\n              )}\n          </div>\n\n          {/* Advanced Selectors */}\n          <div className=\"mt-4 space-y-4\">\n            {selectedSupplierId !== \"__none__\" ? (\n              <div className=\"p-4 border rounded-lg bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-800\">\n                <p className=\"text-sm font-medium text-green-900 dark:text-green-100 flex items-center gap-2\">\n                   Lieferanten-Selektoren geladen\n                </p>\n                <p className=\"text-xs text-green-700 dark:text-green-300 mt-1\">\n                  {suppliersData?.suppliers?.find(s => s.id === selectedSupplierId)?.name} Selektoren werden automatisch beim Scraping verwendet\n                </p>\n              </div>\n            ) : (\n              <>\n                <div>\n                  <div className=\"flex items-center gap-2\">\n                    <Checkbox\n                      id=\"advanced\"\n                      checked={showAdvanced}\n                      onCheckedChange={(checked) => setShowAdvanced(!!checked)}\n                    />\n                    <Label htmlFor=\"advanced\" className=\"cursor-pointer\">\n                      <Settings2 className=\"w-4 h-4 inline mr-1\" />\n                      Erweiterte CSS-Selektoren\n                    </Label>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Standard-Selektoren funktionieren fr die meisten Websites. Nur bei Bedarf anpassen.\n                  </p>\n                </div>\n\n                {showAdvanced && (\n              <div className=\"grid grid-cols-2 gap-4 p-4 border rounded-lg bg-muted/30\">\n                <div>\n                  <Label className=\"text-xs\">Artikelnummer Selector</Label>\n                  <Input\n                    placeholder='.product-code'\n                    value={selectors.articleNumber}\n                    onChange={(e) => setSelectors({...selectors, articleNumber: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Produktname Selector</Label>\n                  <Input\n                    placeholder='h1.product-title'\n                    value={selectors.productName}\n                    onChange={(e) => setSelectors({...selectors, productName: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">EAN Selector</Label>\n                  <Input\n                    placeholder='.ean'\n                    value={selectors.ean}\n                    onChange={(e) => setSelectors({...selectors, ean: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Hersteller Selector</Label>\n                  <Input\n                    placeholder='.brand'\n                    value={selectors.manufacturer}\n                    onChange={(e) => setSelectors({...selectors, manufacturer: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Preis Selector</Label>\n                  <Input\n                    placeholder='.price'\n                    value={selectors.price}\n                    onChange={(e) => setSelectors({...selectors, price: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Beschreibung Selector</Label>\n                  <Input\n                    placeholder='.product-description'\n                    value={selectors.description}\n                    onChange={(e) => setSelectors({...selectors, description: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Bilder Selector</Label>\n                  <Input\n                    placeholder='.product-image img'\n                    value={selectors.images}\n                    onChange={(e) => setSelectors({...selectors, images: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Gewicht Selector</Label>\n                  <Input\n                    placeholder='.weight'\n                    value={selectors.weight}\n                    onChange={(e) => setSelectors({...selectors, weight: e.target.value})}\n                    className=\"text-sm\"\n                  />\n                </div>\n              </div>\n                )}\n              </>\n            )}\n          </div>\n        </Card>\n\n        {/* Scraped Data Display */}\n        {scrapedProduct && (\n          <Card className=\"p-6\">\n            <h3 className=\"text-lg font-semibold mb-4\">Extrahierte Produktdaten</h3>\n            \n            {/* Tabelle mit allen Feldern */}\n            <div className=\"border rounded-lg overflow-hidden\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-[200px]\">Feldname</TableHead>\n                    <TableHead>Extrahierter Wert</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {Object.entries(scrapedProduct).map(([key, value]) => {\n                    // Skip images array, we'll show it separately\n                    if (key === 'images') return null;\n                    \n                    // Skip empty values\n                    if (!value) return null;\n                    \n                    // Skip description if it's an HTML object or auto-extracted flag\n                    if (key === 'autoExtractedDescription' || key === 'technicalDataTable' || key === 'pdfManualUrl' || key === 'safetyWarnings' || key === 'rawHtml') return null;\n                    \n                    // German field name mapping (Nitecore selector names)\n                    const fieldNameMap: Record<string, string> = {\n                      articleNumber: 'Artikelnummer',\n                      productName: 'Produktname',\n                      ean: 'EAN',\n                      manufacturer: 'Hersteller',\n                      price: 'Preis',\n                      weight: 'Gewicht (g)',\n                      description: 'Beschreibung',\n                      length: 'Lnge (mm)',\n                      bodyDiameter: 'Gehusedurchmesser (mm)',\n                      headDiameter: 'Kopfdurchmesser (mm)',\n                      weightWithoutBattery: 'Gewicht ohne Batterie (g)',\n                      totalWeight: 'Gesamt Gewicht (g)',\n                      powerSupply: 'Stromversorgung',\n                      led1: 'Leuchtmittel 1',\n                      led2: 'Leuchtmittel 2',\n                      spotIntensity: 'Spotintensitt (cd)',\n                      maxLuminosity: 'Leuchtleistung max. (Lumen)',\n                      maxBeamDistance: 'Max. Leuchtweite (m)',\n                    };\n                    \n                    const fieldName = fieldNameMap[key] || key;\n                    \n                    return (\n                      <TableRow key={key}>\n                        <TableCell className=\"font-medium text-muted-foreground\">{fieldName}</TableCell>\n                        <TableCell className=\"font-mono text-sm\">\n                          <div className=\"flex items-start justify-between gap-2\">\n                            <div className=\"flex-1 break-words\">\n                              {typeof value === 'object' ? JSON.stringify(value) : String(value)}\n                            </div>\n                            {key === 'description' && value && (\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"shrink-0 h-8 px-2\"\n                                onClick={() => {\n                                  navigator.clipboard.writeText(String(value));\n                                  toast({\n                                    title: \"Kopiert!\",\n                                    description: \"Beschreibung wurde in die Zwischenablage kopiert\",\n                                  });\n                                }}\n                              >\n                                \n                              </Button>\n                            )}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                  \n                </TableBody>\n              </Table>\n            </div>\n\n            {/* Image Gallery */}\n            {scrapedProduct.images && scrapedProduct.images.length > 0 && (\n              <div className=\"mt-6 border-t pt-6\">\n                <h4 className=\"text-md font-semibold mb-3\">\n                  Produktbilder ({scrapedProduct.images.length} gefunden)\n                </h4>\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n                  {scrapedProduct.images.map((imgUrl, index) => (\n                    <div key={index} className=\"relative group\">\n                      <img \n                        src={imgUrl} \n                        alt={`Produktbild ${index + 1}`}\n                        className=\"w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-400 transition-all cursor-pointer\"\n                        onClick={() => window.open(imgUrl, '_blank')}\n                        onError={(e) => {\n                          (e.target as HTMLImageElement).src = 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"%3E%3Crect fill=\"%23ddd\" width=\"100\" height=\"100\"/%3E%3Ctext x=\"50%25\" y=\"50%25\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\"%3EFehler%3C/text%3E%3C/svg%3E';\n                        }}\n                      />\n                      <div className=\"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg transition-all pointer-events-none\" />\n                      <span className=\"absolute bottom-1 right-1 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded\">\n                        #{index + 1}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            <div className=\"mt-6 flex gap-2\">\n              <Button onClick={handleGenerateDescription} disabled={isGenerating}>\n                {isGenerating ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    AI generiert...\n                  </>\n                ) : (\n                  'AI-Beschreibung generieren'\n                )}\n              </Button>\n              <Button \n                variant=\"outline\" \n                disabled={!scrapedProduct}\n                onClick={() => setShowSaveDialog(true)}\n              >\n                Zu Projekt hinzufgen\n              </Button>\n            </div>\n          </Card>\n        )}\n\n        {/* Product List Preview */}\n        {scrapedProducts.length > 0 && (\n          <Card className=\"p-6\">\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-lg font-semibold\">Gescrapte Produkte ({scrapedProducts.length})</h3>\n              <div className=\"flex gap-2\">\n                <Button \n                  onClick={handleGenerateAllDescriptions} \n                  variant=\"default\"\n                  disabled={isGeneratingBatch}\n                >\n                  {isGeneratingBatch ? (\n                    <>\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      {aiGenerationProgress.current}/{aiGenerationProgress.total} generiert...\n                    </>\n                  ) : (\n                    <>\n                      <Sparkles className=\"w-4 h-4 mr-2\" />\n                      Alle AI-Beschreibungen generieren\n                    </>\n                  )}\n                </Button>\n                <Button \n                  onClick={() => setShowBulkSaveDialog(true)} \n                  variant=\"default\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Als Projekt speichern\n                </Button>\n                <Button onClick={downloadCSV} variant=\"outline\">\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  CSV Exportieren\n                </Button>\n                <Button \n                  onClick={handlePixiCompare} \n                  variant=\"default\"\n                  className=\"bg-green-600 hover:bg-green-700\"\n                >\n                  <Database className=\"w-4 h-4 mr-2\" />\n                  Mit Pixi vergleichen\n                </Button>\n              </div>\n            </div>\n\n            {/* AI Generation Progress Bar */}\n            {isGeneratingBatch && (\n              <div className=\"mb-4\">\n                <Progress value={(aiGenerationProgress.current / aiGenerationProgress.total) * 100} className=\"h-2\" />\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Generiere MediaMarkt-Beschreibungen: {aiGenerationProgress.current} von {aiGenerationProgress.total}\n                </p>\n              </div>\n            )}\n            \n            {/* Info Banner */}\n            <div className=\"mb-4 p-4 bg-primary/10 rounded-lg border border-primary/20\">\n              <p className=\"text-sm text-foreground flex items-center gap-2\">\n                <Sparkles className=\"w-4 h-4 text-primary\" />\n                <strong>KI-Felder (blau markiert)</strong> werden nach Klick auf \"Alle AI-Beschreibungen generieren\" automatisch befllt\n              </p>\n            </div>\n            \n            <div className=\"border rounded-lg overflow-x-auto\">\n              <div className=\"max-h-96 overflow-y-auto\">\n                <Table>\n                  <TableHeader className=\"bg-muted sticky top-0 z-20\">\n                    <TableRow>\n                      {/* Scraped Data Columns (wei) */}\n                      <TableHead className=\"w-12 sticky left-0 bg-muted z-20\">#</TableHead>\n                      <TableHead className=\"sticky left-12 bg-muted z-20\">Bild (Anzahl)</TableHead>\n                      <TableHead className=\"min-w-[120px]\">Artikelnummer</TableHead>\n                      <TableHead className=\"min-w-[200px]\">Produktname</TableHead>\n                      <TableHead className=\"min-w-[120px]\">EAN</TableHead>\n                      <TableHead className=\"min-w-[120px]\">Hersteller</TableHead>\n                      <TableHead className=\"min-w-[100px]\">EK (netto) </TableHead>\n                      <TableHead className=\"min-w-[100px]\">VK (brutto) </TableHead>\n                      {/* ANSMANN Technical Specifications */}\n                      <TableHead className=\"min-w-[120px]\">Nominalspannung (V)</TableHead>\n                      <TableHead className=\"min-w-[140px]\">Nominalkapazitt (mAh)</TableHead>\n                      <TableHead className=\"min-w-[140px]\">max. Entladestrom (A)</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Lnge (mm)</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Breite (mm)</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Hhe (mm)</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Gewicht (g)</TableHead>\n                      <TableHead className=\"min-w-[120px]\">Zellenchemie</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Energie (Wh)</TableHead>\n                      <TableHead className=\"min-w-[100px]\">Farbe</TableHead>\n                      \n                      {/* KI-generierte Spalten (blau markiert) */}\n                      <TableHead className=\"min-w-[180px] bg-primary/10 text-primary font-semibold\">\n                         MediaMarkt V1\n                      </TableHead>\n                      <TableHead className=\"min-w-[150px] bg-primary/10 text-primary font-semibold\">\n                         MediaMarkt V2\n                      </TableHead>\n                      <TableHead className=\"min-w-[200px] bg-primary/10 text-primary font-semibold\">\n                         SEO Titel\n                      </TableHead>\n                      <TableHead className=\"min-w-[250px] bg-primary/10 text-primary font-semibold\">\n                         SEO Produktbeschreibung\n                      </TableHead>\n                      <TableHead className=\"min-w-[200px] bg-primary/10 text-primary font-semibold\">\n                         SEO Keywords\n                      </TableHead>\n                      <TableHead className=\"min-w-[250px] bg-primary/10 text-primary font-semibold\">\n                         Produktbeschreibung (HTML)\n                      </TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {scrapedProducts\n                      .slice((currentPage - 1) * productsPerPage, currentPage * productsPerPage)\n                      .map((product, index) => {\n                        const absoluteIndex = (currentPage - 1) * productsPerPage + index;\n                        return (\n                          <TableRow key={absoluteIndex}>\n                        <TableCell className=\"font-mono text-sm sticky left-0 bg-white z-10\">{absoluteIndex + 1}</TableCell>\n                        <TableCell className=\"sticky left-12 bg-white z-10\">\n                          {product.images && product.images.length > 0 ? (\n                            <div className=\"flex items-center gap-2\">\n                              <div \n                                className=\"relative cursor-pointer group\"\n                                onClick={() => {\n                                  setSelectedProductImages({\n                                    images: product.images,\n                                    productName: product.productName,\n                                    articleNumber: product.articleNumber\n                                  });\n                                  setCurrentImageIndex(0);\n                                  setShowImageGallery(true);\n                                }}\n                              >\n                                <img \n                                  src={product.images[0]} \n                                  alt={product.productName}\n                                  className=\"w-16 h-16 object-cover rounded border group-hover:ring-2 group-hover:ring-primary transition-all\"\n                                  onError={(e) => {\n                                    (e.target as HTMLImageElement).src = 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"64\" height=\"64\" fill=\"%23e5e7eb\"/><text x=\"32\" y=\"32\" text-anchor=\"middle\" dy=\".3em\" fill=\"%239ca3af\" font-size=\"12\">-</text></svg>';\n                                  }}\n                                />\n                                <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/20 rounded transition-all flex items-center justify-center\">\n                                  <Eye className=\"w-5 h-5 text-white opacity-0 group-hover:opacity-100 transition-opacity\" />\n                                </div>\n                              </div>\n                              <span className=\"text-xs text-muted-foreground font-medium\">\n                                {product.images.length} {product.images.length === 1 ? 'Bild' : 'Bilder'}\n                              </span>\n                            </div>\n                          ) : (\n                            <div className=\"w-16 h-16 bg-muted rounded border flex items-center justify-center text-muted-foreground text-xs\">\n                              -\n                            </div>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"font-mono text-sm whitespace-nowrap\">{product.articleNumber || '-'}</TableCell>\n                        <TableCell className=\"font-medium whitespace-normal break-words\">{product.productName || '-'}</TableCell>\n                        <TableCell className=\"font-mono text-sm whitespace-nowrap\">{product.ean || '-'}</TableCell>\n                        <TableCell className=\"whitespace-nowrap\">{product.manufacturer || '-'}</TableCell>\n                        <TableCell className=\"font-semibold whitespace-nowrap text-green-700\">{(product as any).ekPrice || '-'}</TableCell>\n                        <TableCell className=\"font-semibold whitespace-nowrap text-blue-700\">{(product as any).vkPrice || '-'}</TableCell>\n                        {/* ANSMANN Technical Specifications */}\n                        <TableCell className=\"text-sm\">{product.nominalspannung || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.nominalkapazitaet || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.maxEntladestrom || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.laenge || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.breite || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.hoehe || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.gewicht || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.zellenchemie || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.energie || '-'}</TableCell>\n                        <TableCell className=\"text-sm\">{product.farbe || '-'}</TableCell>\n                        \n                        {/* KI-generierte Spalten (blau markiert) */}\n                        <TableCell className=\"bg-primary/5 text-xs italic text-muted-foreground\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            `${product.category || 'Produkt'} ${product.articleNumber}`\n                          ) : (\n                            'wird generiert...'\n                          )}\n                        </TableCell>\n                        <TableCell className=\"bg-primary/5 text-xs italic text-muted-foreground\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            product.articleNumber || '-'\n                          ) : (\n                            'wird generiert...'\n                          )}\n                        </TableCell>\n                        <TableCell className=\"bg-primary/5 text-xs\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            <div className=\"flex items-center gap-2\">\n                              <div className=\"max-w-md whitespace-normal\">\n                                {generatedDescriptions.get(product.articleNumber)?.seoTitle || product.productName || '-'}\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setSeoTitlePreviewContent(generatedDescriptions.get(product.articleNumber)?.seoTitle || '');\n                                  setShowSeoTitlePreview(true);\n                                }}\n                                title=\"Vollstndigen SEO-Titel anzeigen\"\n                                className=\"shrink-0\"\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <span className=\"italic text-muted-foreground\">wird generiert...</span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"bg-primary/5 text-xs\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            <div className=\"flex items-center gap-2\">\n                              <div className=\"max-w-md whitespace-normal line-clamp-3\">\n                                {generatedDescriptions.get(product.articleNumber)?.seoDescription || '-'}\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setSeoPreviewContent(generatedDescriptions.get(product.articleNumber)?.seoDescription || '');\n                                  setShowSeoPreview(true);\n                                }}\n                                title=\"Vollstndige SEO-Beschreibung anzeigen\"\n                                className=\"shrink-0\"\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <span className=\"italic text-muted-foreground\">wird generiert...</span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"bg-primary/5 text-xs italic text-muted-foreground\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            <div className=\"flex items-center justify-between gap-2\">\n                              <span className=\"line-clamp-1\">{generatedDescriptions.get(product.articleNumber)?.seoKeywords || `${product.manufacturer}, ${product.category}, ${product.articleNumber}`}</span>\n                              <div className=\"flex gap-1 shrink-0\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    setKeywordsPreviewContent(generatedDescriptions.get(product.articleNumber)?.seoKeywords || '');\n                                    setShowKeywordsPreview(true);\n                                  }}\n                                  title=\"Vollstndige Keywords anzeigen\"\n                                >\n                                  <Eye className=\"w-4 h-4\" />\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    const genContent = generatedDescriptions.get(product.articleNumber);\n                                    setSerpPreviewData({\n                                      title: genContent?.seoTitle || product.productName || '',\n                                      description: genContent?.seoDescription || '',\n                                      url: product.articleNumber || '',\n                                      productName: product.productName || ''\n                                    });\n                                    setShowSerpPreview(true);\n                                  }}\n                                  title=\"SERP Snippet Vorschau (Google-Ansicht)\"\n                                  className=\"text-blue-600 hover:text-blue-700\"\n                                >\n                                  <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                                    <path d=\"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z\"/>\n                                  </svg>\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    const genContent = generatedDescriptions.get(product.articleNumber);\n                                    setFullViewContent({\n                                      title: genContent?.seoTitle || product.productName || '',\n                                      seoDescription: genContent?.seoDescription || '',\n                                      keywords: genContent?.seoKeywords || `${product.manufacturer}, ${product.category}, ${product.articleNumber}`,\n                                      html: genContent?.description || ''\n                                    });\n                                    setShowFullView(true);\n                                  }}\n                                  title=\"Vollansicht ffnen\"\n                                >\n                                  <Maximize2 className=\"w-4 h-4\" />\n                                </Button>\n                              </div>\n                            </div>\n                          ) : (\n                            'wird generiert...'\n                          )}\n                        </TableCell>\n                        <TableCell className=\"bg-primary/5 text-xs font-mono\">\n                          {generatedDescriptions.has(product.articleNumber) ? (\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"max-w-xs truncate text-muted-foreground\" title={generatedDescriptions.get(product.articleNumber)?.description}>\n                                {(generatedDescriptions.get(product.articleNumber)?.description || '').substring(0, 60) + '...'}\n                              </span>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setHtmlPreviewContent(generatedDescriptions.get(product.articleNumber)?.description || '');\n                                  setShowHtmlPreview(true);\n                                }}\n                                title=\"HTML Vorschau anzeigen\"\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => handleCopyHtml(product.articleNumber)}\n                                title=\"HTML kopieren\"\n                                className={copiedArticleNumber === product.articleNumber ? \"text-green-600\" : \"\"}\n                              >\n                                {copiedArticleNumber === product.articleNumber ? (\n                                  <Check className=\"w-4 h-4\" />\n                                ) : (\n                                  <Copy className=\"w-4 h-4\" />\n                                )}\n                              </Button>\n                            </div>\n                          ) : (\n                            <span className=\"text-muted-foreground italic\">wird generiert...</span>\n                          )}\n                        </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                  </TableBody>\n                </Table>\n              </div>\n              \n              {/* Pagination Controls */}\n              {scrapedProducts.length > productsPerPage && (\n                <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    Zeige {((currentPage - 1) * productsPerPage) + 1} bis {Math.min(currentPage * productsPerPage, scrapedProducts.length)} von {scrapedProducts.length} Produkten\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n                      disabled={currentPage === 1}\n                    >\n                      Zurck\n                    </Button>\n                    <div className=\"flex items-center gap-1\">\n                      {Array.from({ length: Math.ceil(scrapedProducts.length / productsPerPage) }, (_, i) => i + 1).map((page) => (\n                        <Button\n                          key={page}\n                          variant={currentPage === page ? \"default\" : \"outline\"}\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(page)}\n                          className=\"w-8 h-8 p-0\"\n                        >\n                          {page}\n                        </Button>\n                      ))}\n                    </div>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setCurrentPage(Math.min(Math.ceil(scrapedProducts.length / productsPerPage), currentPage + 1))}\n                      disabled={currentPage === Math.ceil(scrapedProducts.length / productsPerPage)}\n                    >\n                      Weiter\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </div>\n          </Card>\n        )}\n\n        {/* HTML Preview (Flietext) */}\n        {generatedDescription && (\n          <Card className=\"p-6\">\n            <h3 className=\"text-lg font-semibold mb-4\">HTML-Vorschau (Flietext)</h3>\n            <div className=\"p-6 bg-white dark:bg-gray-900 border rounded-lg max-h-96 overflow-y-auto\">\n              <style dangerouslySetInnerHTML={{ __html: `\n                .product-preview h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }\n                .product-preview h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; }\n                .product-preview h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }\n                .product-preview p { margin: 0.75rem 0; line-height: 1.6; }\n                .product-preview table { width: 100%; border-collapse: collapse; margin: 1rem 0; }\n                .product-preview table th,\n                .product-preview table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; }\n                .product-preview table th { background-color: #f3f4f6; font-weight: 600; }\n                .product-preview table tr:nth-child(even) { background-color: #f9fafb; }\n                .product-preview .properties-label { font-weight: 600; width: 40%; }\n                .product-preview .properties-value { width: 60%; }\n                .dark .product-preview table th,\n                .dark .product-preview table td { border-color: #374151; }\n                .dark .product-preview table th { background-color: #1f2937; }\n                .dark .product-preview table tr:nth-child(even) { background-color: #111827; }\n              ` }} />\n              <div \n                className=\"product-preview\"\n                dangerouslySetInnerHTML={{ __html: generatedDescription }} \n              />\n            </div>\n          </Card>\n        )}\n\n        {/* Save to Project Dialog */}\n        <Dialog open={showSaveDialog} onOpenChange={(open) => {\n          setShowSaveDialog(open);\n          if (!open) {\n            setProjectName(\"\");\n            setSelectedProjectId(\"new\");\n          }\n        }}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Zu Projekt hinzufgen</DialogTitle>\n              <DialogDescription>\n                Speichern Sie das gescrapte Produkt in \"Meine Projekte\"\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"py-4 space-y-4\">\n              <div>\n                <Label htmlFor=\"project-select\" className=\"mb-2 block\">\n                  Projekt whlen\n                </Label>\n                <Select\n                  value={selectedProjectId}\n                  onValueChange={setSelectedProjectId}\n                  disabled={isSaving}\n                >\n                  <SelectTrigger id=\"project-select\">\n                    <SelectValue placeholder=\"Projekt auswhlen...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"new\">\n                      <div className=\"flex items-center\">\n                        <FolderPlus className=\"w-4 h-4 mr-2\" />\n                        Neues Projekt erstellen\n                      </div>\n                    </SelectItem>\n                    {projectsData?.projects && projectsData.projects.length > 0 && (\n                      <>\n                        <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n                          Bestehende Projekte\n                        </div>\n                        {projectsData.projects.map(project => (\n                          <SelectItem key={project.id} value={project.id}>\n                            {project.name}\n                          </SelectItem>\n                        ))}\n                      </>\n                    )}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {selectedProjectId === \"new\" && (\n                <div>\n                  <Label htmlFor=\"project-name\" className=\"mb-2 block\">\n                    Name fr neues Projekt\n                  </Label>\n                  <Input\n                    id=\"project-name\"\n                    placeholder=\"z.B. Webscraping Dezember 2024\"\n                    value={projectName}\n                    onChange={(e) => setProjectName(e.target.value)}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' && !isSaving) {\n                        handleSaveToProject();\n                      }\n                    }}\n                    disabled={isSaving}\n                  />\n                </div>\n              )}\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowSaveDialog(false)}\n                disabled={isSaving}\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handleSaveToProject}\n                disabled={isSaving}\n              >\n                {isSaving ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Speichern...\n                  </>\n                ) : (\n                  'Speichern'\n                )}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* HTML Preview Dialog */}\n        <Dialog open={showHtmlPreview} onOpenChange={setShowHtmlPreview}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Produktbeschreibung Vorschau</DialogTitle>\n              <DialogDescription>\n                So wrde die Beschreibung im MediaMarkt-Shop aussehen\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"p-6 bg-white border rounded-lg overflow-y-auto\" style={{ maxHeight: '70vh' }}>\n                <div dangerouslySetInnerHTML={{ __html: htmlPreviewContent }} />\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    navigator.clipboard.writeText(htmlPreviewContent);\n                    toast({ title: \"Kopiert\", description: \"HTML wurde in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  HTML kopieren\n                </Button>\n                <Button onClick={() => setShowHtmlPreview(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* SEO Title Preview Dialog */}\n        <Dialog open={showSeoTitlePreview} onOpenChange={setShowSeoTitlePreview}>\n          <DialogContent className=\"max-w-4xl\">\n            <DialogHeader>\n              <DialogTitle>SEO Produkttitel</DialogTitle>\n              <DialogDescription>\n                Vollstndiger SEO-optimierter Titel fr Suchmaschinen (max. 70 Zeichen)\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"p-6 bg-muted/50 border rounded-lg\">\n                <p className=\"text-lg font-semibold leading-relaxed\" style={{ wordBreak: 'break-word', whiteSpace: 'normal' }}>\n                  {seoTitlePreviewContent}\n                </p>\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    navigator.clipboard.writeText(seoTitlePreviewContent);\n                    toast({ title: \"Kopiert\", description: \"SEO-Titel wurde in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  Text kopieren\n                </Button>\n                <Button onClick={() => setShowSeoTitlePreview(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* SEO Description Preview Dialog */}\n        <Dialog open={showSeoPreview} onOpenChange={setShowSeoPreview}>\n          <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>SEO Produktbeschreibung</DialogTitle>\n              <DialogDescription>\n                Vollstndige SEO-optimierte Beschreibung fr Suchmaschinen\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"p-6 bg-muted/50 border rounded-lg\">\n                <p className=\"text-sm leading-relaxed whitespace-pre-wrap\">{seoPreviewContent}</p>\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    navigator.clipboard.writeText(seoPreviewContent);\n                    toast({ title: \"Kopiert\", description: \"SEO-Beschreibung wurde in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  Text kopieren\n                </Button>\n                <Button onClick={() => setShowSeoPreview(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* SEO Keywords Preview Dialog */}\n        <Dialog open={showKeywordsPreview} onOpenChange={setShowKeywordsPreview}>\n          <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>SEO Keywords</DialogTitle>\n              <DialogDescription>\n                AI-generierte Keywords fr optimale Suchmaschinenoptimierung\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"p-6 bg-muted/50 border rounded-lg overflow-y-auto\" style={{ maxHeight: '60vh' }}>\n                <p className=\"text-sm leading-relaxed\">{keywordsPreviewContent}</p>\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    navigator.clipboard.writeText(keywordsPreviewContent);\n                    toast({ title: \"Kopiert\", description: \"Keywords wurden in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  Text kopieren\n                </Button>\n                <Button onClick={() => setShowKeywordsPreview(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Full View Dialog */}\n        <Dialog open={showFullView} onOpenChange={setShowFullView}>\n          <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Vollstndige Produktinformationen</DialogTitle>\n              <DialogDescription>\n                Alle AI-generierten Inhalte im Detail\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-6\">\n              {/* SEO Title */}\n              <div>\n                <Label className=\"text-sm font-semibold mb-2 block\">SEO-Titel</Label>\n                <div className=\"p-4 bg-muted rounded-lg border\">\n                  <p className=\"text-sm\">{fullViewContent.title}</p>\n                </div>\n              </div>\n\n              {/* SEO Description */}\n              <div>\n                <Label className=\"text-sm font-semibold mb-2 block\">SEO-Beschreibung</Label>\n                <div className=\"p-4 bg-muted rounded-lg border\">\n                  <p className=\"text-sm\">{fullViewContent.seoDescription}</p>\n                </div>\n              </div>\n\n              {/* Keywords */}\n              <div>\n                <Label className=\"text-sm font-semibold mb-2 block\">Keywords</Label>\n                <div className=\"p-4 bg-muted rounded-lg border\">\n                  <p className=\"text-sm\">{fullViewContent.keywords}</p>\n                </div>\n              </div>\n\n              {/* HTML Description */}\n              <div>\n                <Label className=\"text-sm font-semibold mb-2 block\">HTML-Beschreibung</Label>\n                <div className=\"p-4 bg-muted rounded-lg border max-h-96 overflow-y-auto\">\n                  <pre className=\"text-xs whitespace-pre-wrap break-words font-mono\">{fullViewContent.html}</pre>\n                </div>\n              </div>\n\n              {/* Preview */}\n              <div>\n                <Label className=\"text-sm font-semibold mb-2 block\">HTML-Vorschau</Label>\n                <div className=\"p-6 bg-white border rounded-lg max-h-96 overflow-y-auto\">\n                  <div dangerouslySetInnerHTML={{ __html: fullViewContent.html }} />\n                </div>\n              </div>\n\n              <div className=\"flex gap-2 justify-end\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    navigator.clipboard.writeText(fullViewContent.html);\n                    toast({ title: \"Kopiert\", description: \"HTML wurde in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  <Copy className=\"w-4 h-4 mr-2\" />\n                  HTML kopieren\n                </Button>\n                <Button onClick={() => setShowFullView(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* SERP Snippet Preview Dialog */}\n        <Dialog open={showSerpPreview} onOpenChange={setShowSerpPreview}>\n          <DialogContent className=\"max-w-4xl\">\n            <DialogHeader>\n              <DialogTitle>SERP Snippet Vorschau</DialogTitle>\n              <DialogDescription>\n                So wrde Ihr Produkt in Google-Suchergebnissen erscheinen\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-6\">\n              \n              {/* Google SERP Preview */}\n              <div className=\"p-6 bg-white border rounded-lg\">\n                <div className=\"space-y-2\">\n                  {/* URL Breadcrumb */}\n                  <div className=\"flex items-center gap-1 text-sm text-gray-700\">\n                    <span className=\"font-normal\">www.ihr-shop.de</span>\n                    <span></span>\n                    <span className=\"truncate max-w-md\">{serpPreviewData.productName.toLowerCase().replace(/\\s+/g, '-').replace(/[^a-z0-9-]/g, '')}</span>\n                  </div>\n                  \n                  {/* Meta Title */}\n                  <div>\n                    <h3 className=\"text-xl text-blue-600 hover:underline cursor-pointer font-normal leading-snug\">\n                      {serpPreviewData.title || 'SEO Titel wird hier angezeigt...'}\n                    </h3>\n                  </div>\n                  \n                  {/* Meta Description */}\n                  <div>\n                    <p className=\"text-sm text-gray-600 leading-relaxed\">\n                      {serpPreviewData.description || 'SEO Beschreibung wird hier angezeigt...'}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {/* SEO Quality Metrics */}\n              <div className=\"space-y-4\">\n                <h4 className=\"font-semibold text-sm\">SEO-Qualittsanalyse</h4>\n                \n                {/* Meta Title Metrics */}\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-xs\">\n                    <span className=\"font-medium\">Meta Title</span>\n                    <span className={`font-semibold ${\n                      (serpPreviewData.title.length * 8.5) >= 300 && (serpPreviewData.title.length * 8.5) <= 580 ? 'text-green-600' :\n                      (serpPreviewData.title.length * 8.5) >= 200 && (serpPreviewData.title.length * 8.5) < 300 ? 'text-yellow-600' :\n                      (serpPreviewData.title.length * 8.5) > 580 && (serpPreviewData.title.length * 8.5) <= 620 ? 'text-yellow-600' :\n                      'text-red-600'\n                    }`}>\n                      {Math.round(serpPreviewData.title.length * 8.5)} / 580 pixels\n                    </span>\n                  </div>\n                  <div className=\"relative w-full h-2 bg-gray-200 rounded-full overflow-hidden\">\n                    <div \n                      className={`h-full transition-all ${\n                        (serpPreviewData.title.length * 8.5) >= 300 && (serpPreviewData.title.length * 8.5) <= 580 ? 'bg-green-500' :\n                        (serpPreviewData.title.length * 8.5) >= 200 && (serpPreviewData.title.length * 8.5) < 300 ? 'bg-yellow-500' :\n                        (serpPreviewData.title.length * 8.5) > 580 && (serpPreviewData.title.length * 8.5) <= 620 ? 'bg-yellow-500' :\n                        'bg-red-500'\n                      }`}\n                      style={{ width: `${Math.min((serpPreviewData.title.length * 8.5 / 580) * 100, 100)}%` }}\n                    />\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {(serpPreviewData.title.length * 8.5) >= 300 && (serpPreviewData.title.length * 8.5) <= 580 ? \n                      ' Perfekte Lnge - wird vollstndig in Google angezeigt' :\n                     (serpPreviewData.title.length * 8.5) < 300 ? \n                      ' Etwas kurz - nutzen Sie mehr Platz fr Keywords' :\n                      ' Zu lang - wird in Google abgeschnitten'}\n                  </p>\n                </div>\n\n                {/* Meta Description Metrics */}\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-xs\">\n                    <span className=\"font-medium\">Meta Description</span>\n                    <span className={`font-semibold ${\n                      (serpPreviewData.description.length * 6.3) >= 600 && (serpPreviewData.description.length * 6.3) <= 1000 ? 'text-green-600' :\n                      (serpPreviewData.description.length * 6.3) >= 450 && (serpPreviewData.description.length * 6.3) < 600 ? 'text-yellow-600' :\n                      (serpPreviewData.description.length * 6.3) > 1000 && (serpPreviewData.description.length * 6.3) <= 1100 ? 'text-yellow-600' :\n                      'text-red-600'\n                    }`}>\n                      {Math.round(serpPreviewData.description.length * 6.3)} / 1000 pixels\n                    </span>\n                  </div>\n                  <div className=\"relative w-full h-2 bg-gray-200 rounded-full overflow-hidden\">\n                    <div \n                      className={`h-full transition-all ${\n                        (serpPreviewData.description.length * 6.3) >= 600 && (serpPreviewData.description.length * 6.3) <= 1000 ? 'bg-green-500' :\n                        (serpPreviewData.description.length * 6.3) >= 450 && (serpPreviewData.description.length * 6.3) < 600 ? 'bg-yellow-500' :\n                        (serpPreviewData.description.length * 6.3) > 1000 && (serpPreviewData.description.length * 6.3) <= 1100 ? 'bg-yellow-500' :\n                        'bg-red-500'\n                      }`}\n                      style={{ width: `${Math.min((serpPreviewData.description.length * 6.3 / 1000) * 100, 100)}%` }}\n                    />\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {(serpPreviewData.description.length * 6.3) >= 600 && (serpPreviewData.description.length * 6.3) <= 1000 ? \n                      ' Perfekte Lnge - wird vollstndig in Google angezeigt' :\n                     (serpPreviewData.description.length * 6.3) < 600 ? \n                      ' Etwas kurz - fgen Sie mehr Details hinzu' :\n                      ' Zu lang - wird in Google gekrzt'}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex gap-2 justify-end pt-4 border-t\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    const copyText = `Meta Title: ${serpPreviewData.title}\\n\\nMeta Description: ${serpPreviewData.description}`;\n                    navigator.clipboard.writeText(copyText);\n                    toast({ title: \"Kopiert\", description: \"SERP-Daten wurden in die Zwischenablage kopiert\" });\n                  }}\n                >\n                  <Copy className=\"w-4 h-4 mr-2\" />\n                  SERP-Daten kopieren\n                </Button>\n                <Button onClick={() => setShowSerpPreview(false)}>\n                  Schlieen\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Bulk Save Dialog */}\n        <Dialog open={showBulkSaveDialog} onOpenChange={(open) => {\n          setShowBulkSaveDialog(open);\n          if (!open) {\n            setProjectName(\"\");\n            setSelectedProjectId(\"new\");\n          }\n        }}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Alle Produkte als Projekt speichern</DialogTitle>\n              <DialogDescription>\n                Speichern Sie {scrapedProducts.length} gescrapte Produkte in \"Meine Projekte\"\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"py-4 space-y-4\">\n              <div>\n                <Label htmlFor=\"bulk-project-select\" className=\"mb-2 block\">\n                  Projekt whlen\n                </Label>\n                <Select\n                  value={selectedProjectId}\n                  onValueChange={setSelectedProjectId}\n                  disabled={isSaving}\n                >\n                  <SelectTrigger id=\"bulk-project-select\">\n                    <SelectValue placeholder=\"Projekt auswhlen...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"new\">\n                      <div className=\"flex items-center\">\n                        <FolderPlus className=\"w-4 h-4 mr-2\" />\n                        Neues Projekt erstellen\n                      </div>\n                    </SelectItem>\n                    {projectsData?.projects && projectsData.projects.length > 0 && (\n                      <>\n                        <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n                          Bestehende Projekte\n                        </div>\n                        {projectsData.projects.map(project => (\n                          <SelectItem key={project.id} value={project.id}>\n                            {project.name}\n                          </SelectItem>\n                        ))}\n                      </>\n                    )}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {selectedProjectId === \"new\" && (\n                <div>\n                  <Label htmlFor=\"bulk-project-name\" className=\"mb-2 block\">\n                    Name fr neues Projekt\n                  </Label>\n                  <Input\n                    id=\"bulk-project-name\"\n                    placeholder=\"z.B. Webscraping Dezember 2024\"\n                    value={projectName}\n                    onChange={(e) => setProjectName(e.target.value)}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' && !isSaving) {\n                        handleBulkSaveToProject();\n                      }\n                    }}\n                    disabled={isSaving}\n                  />\n                </div>\n              )}\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowBulkSaveDialog(false)}\n                disabled={isSaving}\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handleBulkSaveToProject}\n                disabled={isSaving}\n              >\n                {isSaving ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Speichere...\n                  </>\n                ) : (\n                  <>\n                    <Save className=\"w-4 h-4 mr-2\" />\n                    {scrapedProducts.length} Produkte speichern\n                  </>\n                )}\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Image Gallery Dialog */}\n        <Dialog open={showImageGallery} onOpenChange={setShowImageGallery}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh]\">\n            <DialogHeader>\n              <DialogTitle>\n                {selectedProductImages.productName}\n              </DialogTitle>\n              <DialogDescription>\n                Artikelnummer: {selectedProductImages.articleNumber}  {selectedProductImages.images.length} {selectedProductImages.images.length === 1 ? 'Bild' : 'Bilder'}\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"space-y-4\">\n              {/* Main Image Display */}\n              <div className=\"relative bg-muted rounded-lg overflow-hidden aspect-square flex items-center justify-center\">\n                {selectedProductImages.images.length > 0 && (\n                  <img \n                    src={selectedProductImages.images[currentImageIndex]} \n                    alt={`${selectedProductImages.productName} - Bild ${currentImageIndex + 1}`}\n                    className=\"max-w-full max-h-full object-contain\"\n                    onError={(e) => {\n                      (e.target as HTMLImageElement).src = 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"400\"><rect width=\"400\" height=\"400\" fill=\"%23e5e7eb\"/><text x=\"200\" y=\"200\" text-anchor=\"middle\" dy=\".3em\" fill=\"%239ca3af\" font-size=\"24\">Bild nicht verfgbar</text></svg>';\n                    }}\n                  />\n                )}\n                \n                {/* Navigation Arrows */}\n                {selectedProductImages.images.length > 1 && (\n                  <>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white\"\n                      onClick={() => setCurrentImageIndex(prev => prev === 0 ? selectedProductImages.images.length - 1 : prev - 1)}\n                    >\n                      <ArrowLeft className=\"w-6 h-6\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white\"\n                      onClick={() => setCurrentImageIndex(prev => prev === selectedProductImages.images.length - 1 ? 0 : prev + 1)}\n                    >\n                      <Eye className=\"w-6 h-6 rotate-180\" />\n                    </Button>\n                  </>\n                )}\n                \n                {/* Image Counter */}\n                <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 text-white px-3 py-1 rounded-full text-sm\">\n                  {currentImageIndex + 1} / {selectedProductImages.images.length}\n                </div>\n              </div>\n              \n              {/* Thumbnail Strip */}\n              {selectedProductImages.images.length > 1 && (\n                <div className=\"flex gap-2 overflow-x-auto pb-2\">\n                  {selectedProductImages.images.map((img, idx) => (\n                    <button\n                      key={idx}\n                      onClick={() => setCurrentImageIndex(idx)}\n                      className={`relative shrink-0 w-20 h-20 rounded border-2 overflow-hidden transition-all ${\n                        idx === currentImageIndex \n                          ? 'border-primary ring-2 ring-primary' \n                          : 'border-muted hover:border-primary/50'\n                      }`}\n                    >\n                      <img \n                        src={img} \n                        alt={`Thumbnail ${idx + 1}`}\n                        className=\"w-full h-full object-cover\"\n                        onError={(e) => {\n                          (e.target as HTMLImageElement).src = 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"80\" height=\"80\"><rect width=\"80\" height=\"80\" fill=\"%23e5e7eb\"/><text x=\"40\" y=\"40\" text-anchor=\"middle\" dy=\".3em\" fill=\"%239ca3af\" font-size=\"10\">-</text></svg>';\n                        }}\n                      />\n                    </button>\n                  ))}\n                </div>\n              )}\n              \n              {/* Image URL */}\n              <div className=\"p-3 bg-muted rounded-lg\">\n                <Label className=\"text-xs text-muted-foreground mb-1 block\">Bild-URL:</Label>\n                <div className=\"flex items-center gap-2\">\n                  <code className=\"text-xs flex-1 break-all\">\n                    {selectedProductImages.images[currentImageIndex]}\n                  </code>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      navigator.clipboard.writeText(selectedProductImages.images[currentImageIndex]);\n                      toast({ title: \"URL kopiert\", description: \"Bild-URL wurde in die Zwischenablage kopiert\" });\n                    }}\n                  >\n                    <Copy className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":150345},"client/src/pages/suppliers.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Plus, Edit, Trash2, Save, TestTube, CheckCircle, AlertCircle } from \"lucide-react\";\nimport { apiGet, apiPost, apiPut, apiDelete } from \"@/lib/api\";\n\ninterface Supplier {\n  id: string;\n  name: string;\n  supplNr?: string;\n  urlPattern?: string;\n  description?: string;\n  selectors: Record<string, string>;\n  productLinkSelector?: string;\n  sessionCookies?: string;\n  userAgent?: string;\n  loginUrl?: string;\n  loginUsernameField?: string;\n  loginPasswordField?: string;\n  loginUsername?: string;\n  loginPassword?: string;\n  verifiedFields?: string[];\n  lastVerifiedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function Suppliers() {\n  const [, setLocation] = useLocation();\n  const [suppliers, setSuppliers] = useState<Supplier[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null);\n  const [verifiedFields, setVerifiedFields] = useState<Set<string>>(new Set());\n  const [testingField, setTestingField] = useState<string | null>(null);\n  const [testUrl, setTestUrl] = useState<string>(\"\");\n  const { toast } = useToast();\n  \n  // Pagination for suppliers table\n  const [currentPage, setCurrentPage] = useState(1);\n  const suppliersPerPage = 6;\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    supplNr: \"\",\n    urlPattern: \"\",\n    description: \"\",\n    productLinkSelector: \"\",\n    sessionCookies: \"\",\n    userAgent: \"\",\n    loginUrl: \"\",\n    loginUsernameField: \"\",\n    loginPasswordField: \"\",\n    loginUsername: \"\",\n    loginPassword: \"\",\n    selectors: {\n      articleNumber: \".product-code\",\n      productName: \"h1.product-title\",\n      ean: \".ean\",\n      manufacturer: \".brand\",\n      price: \".price\",\n      description: \".product-description\",\n      images: \".product-image img\",\n      weight: \".weight\",\n      category: \".breadcrumb\"\n    }\n  });\n\n  useEffect(() => {\n    loadSuppliers();\n  }, []);\n\n  const loadSuppliers = async () => {\n    try {\n      const data = await apiGet<{ success: boolean; suppliers: Supplier[] }>('/api/suppliers');\n      if (data.success) {\n        setSuppliers(data.suppliers);\n      }\n    } catch (error) {\n      console.error('Error loading suppliers:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"Lieferanten konnten nicht geladen werden\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleOpenDialog = (supplier?: Supplier) => {\n    if (supplier) {\n      setEditingSupplier(supplier);\n      setFormData({\n        name: supplier.name,\n        supplNr: supplier.supplNr || \"\",\n        urlPattern: supplier.urlPattern || \"\",\n        description: supplier.description || \"\",\n        productLinkSelector: supplier.productLinkSelector || \"\",\n        sessionCookies: supplier.sessionCookies || \"\",\n        userAgent: supplier.userAgent || \"\",\n        loginUrl: supplier.loginUrl || \"\",\n        loginUsernameField: supplier.loginUsernameField || \"\",\n        loginPasswordField: supplier.loginPasswordField || \"\",\n        loginUsername: supplier.loginUsername || \"\",\n        loginPassword: supplier.loginPassword || \"\",\n        selectors: { ...formData.selectors, ...supplier.selectors }\n      });\n    } else {\n      setEditingSupplier(null);\n      setFormData({\n        name: \"\",\n        supplNr: \"\",\n        urlPattern: \"\",\n        description: \"\",\n        productLinkSelector: \"\",\n        sessionCookies: \"\",\n        userAgent: \"\",\n        loginUrl: \"\",\n        loginUsernameField: \"\",\n        loginPasswordField: \"\",\n        loginUsername: \"\",\n        loginPassword: \"\",\n        selectors: {\n          articleNumber: \".product-code\",\n          productName: \"h1.product-title\",\n          ean: \".ean\",\n          manufacturer: \".brand\",\n          price: \".price\",\n          description: \".product-description\",\n          images: \".product-image img\",\n          weight: \".weight\",\n          category: \".breadcrumb\"\n        }\n      });\n    }\n    setIsDialogOpen(true);\n    setVerifiedFields(new Set(supplier?.verifiedFields || []));\n    setTestUrl(supplier?.urlPattern || \"\");\n  };\n\n  const handleTestSelector = async (fieldName: string, selector: string) => {\n    if (!testUrl || !selector) {\n      toast({\n        title: \"Fehlende Angaben\",\n        description: \"Bitte geben Sie eine Test-URL und einen Selektor ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setTestingField(fieldName);\n    try {\n      const response = await fetch('/api/scraper/test-selector', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n        },\n        body: JSON.stringify({\n          url: testUrl,\n          selector,\n          supplierId: editingSupplier?.id,\n        }),\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        // Mark field as verified\n        setVerifiedFields(prev => new Set([...Array.from(prev), fieldName]));\n        \n        toast({\n          title: \" Selektor funktioniert!\",\n          description: (\n            <div>\n              <div className=\"font-mono text-xs bg-muted p-2 rounded mt-1 max-h-32 overflow-auto\">\n                {result.value || '(leer)'}\n              </div>\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                {result.count} Element(e) gefunden\n              </div>\n            </div>\n          ),\n        });\n      } else {\n        toast({\n          title: \" Selektor fehlgeschlagen\",\n          description: result.error || 'Kein Element gefunden',\n          variant: \"destructive\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Fehler beim Testen\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setTestingField(null);\n    }\n  };\n\n  const handleSave = async () => {\n    if (!formData.name || !formData.name.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie einen Namen ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const activeSelectors: Record<string, string> = {};\n      Object.entries(formData.selectors).forEach(([key, value]) => {\n        if (value.trim()) {\n          activeSelectors[key] = value.trim();\n        }\n      });\n\n      const payload = {\n        name: formData.name.trim(),\n        supplNr: formData.supplNr || undefined,\n        urlPattern: formData.urlPattern || undefined,\n        description: formData.description || undefined,\n        productLinkSelector: formData.productLinkSelector || undefined,\n        sessionCookies: formData.sessionCookies || undefined,\n        userAgent: formData.userAgent || undefined,\n        loginUrl: formData.loginUrl || undefined,\n        loginUsernameField: formData.loginUsernameField || undefined,\n        loginPasswordField: formData.loginPasswordField || undefined,\n        loginUsername: formData.loginUsername || undefined,\n        loginPassword: formData.loginPassword || undefined,\n        selectors: activeSelectors,\n        verifiedFields: Array.from(verifiedFields),\n        lastVerifiedAt: verifiedFields.size > 0 ? new Date().toISOString() : undefined,\n      };\n\n      const data = editingSupplier \n        ? await apiPut<{ success: boolean; error?: string }>(`/api/suppliers/${editingSupplier.id}`, payload)\n        : await apiPost<{ success: boolean; error?: string }>('/api/suppliers', payload);\n\n      if (data.success) {\n        toast({\n          title: \"Erfolg\",\n          description: editingSupplier \n            ? \"Lieferant aktualisiert\" \n            : \"Lieferant erstellt\",\n        });\n        setIsDialogOpen(false);\n        loadSuppliers();\n      } else {\n        throw new Error(data.error || 'Failed to save supplier');\n      }\n    } catch (error) {\n      console.error('Error saving supplier:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"Lieferant konnte nicht gespeichert werden\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleDelete = async (id: string, name: string) => {\n    if (!confirm(`Mchten Sie \"${name}\" wirklich lschen?`)) {\n      return;\n    }\n\n    try {\n      const data = await apiDelete<{ success: boolean; error?: string }>(`/api/suppliers/${id}`);\n\n      if (data.success) {\n        toast({\n          title: \"Erfolg\",\n          description: \"Lieferant gelscht\",\n        });\n        loadSuppliers();\n      } else {\n        throw new Error(data.error || 'Failed to delete supplier');\n      }\n    } catch (error) {\n      console.error('Error deleting supplier:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"Lieferant konnte nicht gelscht werden\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Lieferanten-Profile</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Verwalten Sie CSS-Selektoren fr hufig verwendete Lieferanten\n          </p>\n        </div>\n        <Button onClick={() => handleOpenDialog()}>\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Neuer Lieferant\n        </Button>\n      </div>\n\n      <Card className=\"p-6\">\n        {suppliers.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <p className=\"text-muted-foreground mb-4\">\n              Noch keine Lieferanten-Profile vorhanden\n            </p>\n            <Button onClick={() => handleOpenDialog()} variant=\"outline\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Ersten Lieferanten anlegen\n            </Button>\n          </div>\n        ) : (\n          <>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>URL-Muster</TableHead>\n                <TableHead>Beschreibung</TableHead>\n                <TableHead>Selektoren</TableHead>\n                <TableHead className=\"text-right\">Aktionen</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {suppliers\n                .slice((currentPage - 1) * suppliersPerPage, currentPage * suppliersPerPage)\n                .map((supplier) => (\n                <TableRow \n                  key={supplier.id}\n                  className=\"cursor-pointer hover:bg-muted/50\"\n                  onClick={() => setLocation(`/suppliers/${supplier.id}`)}\n                >\n                  <TableCell className=\"font-medium text-primary hover:underline\">\n                    {supplier.name}\n                  </TableCell>\n                  <TableCell className=\"text-sm text-muted-foreground\">\n                    {supplier.urlPattern || '-'}\n                  </TableCell>\n                  <TableCell className=\"text-sm\">\n                    {supplier.description || '-'}\n                  </TableCell>\n                  <TableCell>\n                    <span className=\"text-xs px-2 py-1 bg-muted rounded\">\n                      {Object.keys(supplier.selectors).length} Selektoren\n                    </span>\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleOpenDialog(supplier);\n                        }}\n                      >\n                        <Edit className=\"w-4 h-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleDelete(supplier.id, supplier.name);\n                        }}\n                      >\n                        <Trash2 className=\"w-4 h-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n          \n          \n          {/* Pagination Controls */}\n          {suppliers.length > suppliersPerPage && (\n            <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30 mt-4\">\n              <div className=\"text-sm text-muted-foreground\">\n                Zeige {((currentPage - 1) * suppliersPerPage) + 1} bis {Math.min(currentPage * suppliersPerPage, suppliers.length)} von {suppliers.length} Lieferanten\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n                  disabled={currentPage === 1}\n                >\n                  Zurck\n                </Button>\n                <div className=\"flex items-center gap-1\">\n                  {Array.from({ length: Math.ceil(suppliers.length / suppliersPerPage) }, (_, i) => i + 1).map((page) => (\n                    <Button\n                      key={page}\n                      variant={currentPage === page ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => setCurrentPage(page)}\n                      className=\"w-8 h-8 p-0\"\n                    >\n                      {page}\n                    </Button>\n                  ))}\n                </div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setCurrentPage(Math.min(Math.ceil(suppliers.length / suppliersPerPage), currentPage + 1))}\n                  disabled={currentPage === Math.ceil(suppliers.length / suppliersPerPage)}\n                >\n                  Weiter\n                </Button>\n              </div>\n            </div>\n          )}\n          </>\n        )}\n      </Card>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingSupplier ? \"Lieferant bearbeiten\" : \"Neuer Lieferant\"}\n            </DialogTitle>\n            <DialogDescription>\n              Konfigurieren Sie CSS-Selektoren fr einen Lieferanten\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"name\">Name *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"z.B. Conrad Electronic\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"supplNr\">Pixi-Lieferantennummer (optional)</Label>\n              <Input\n                id=\"supplNr\"\n                value={formData.supplNr}\n                onChange={(e) => setFormData({ ...formData, supplNr: e.target.value })}\n                placeholder=\"z.B. 1234 oder CONRAD-001\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Wird automatisch beim Pixi-Vergleich verwendet\n              </p>\n            </div>\n\n            <div>\n              <Label htmlFor=\"urlPattern\">URL-Muster (optional)</Label>\n              <Input\n                id=\"urlPattern\"\n                value={formData.urlPattern}\n                onChange={(e) => setFormData({ ...formData, urlPattern: e.target.value })}\n                placeholder=\"z.B. conrad.de, reichelt.de\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Wird verwendet, um den Lieferanten automatisch zu erkennen\n              </p>\n            </div>\n\n            <div>\n              <Label htmlFor=\"description\">Beschreibung (optional)</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Notizen zu diesem Lieferanten...\"\n                rows={2}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"productLinkSelector\">Produktlink CSS-Selektor (optional)</Label>\n              <Input\n                id=\"productLinkSelector\"\n                value={formData.productLinkSelector}\n                onChange={(e) => setFormData({ ...formData, productLinkSelector: e.target.value })}\n                placeholder=\"a.product-link\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Fr Produktlisten-Scraping\n              </p>\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-semibold mb-3\"> Authentifizierung (optional)</h3>\n              \n              <div className=\"mb-4\">\n                <Label htmlFor=\"sessionCookies\">Session Cookies</Label>\n                <Textarea\n                  id=\"sessionCookies\"\n                  value={formData.sessionCookies}\n                  onChange={(e) => setFormData({ ...formData, sessionCookies: e.target.value })}\n                  placeholder=\"sessionid=abc123; csrftoken=xyz789\"\n                  rows={3}\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                   <strong>So kopieren Sie Cookies:</strong><br/>\n                  1. Loggen Sie sich auf der Lieferanten-Webseite ein<br/>\n                  2. ffnen Sie DevTools (F12)  Tab \"Application\"  \"Cookies\"<br/>\n                  3. Kopieren Sie relevante Cookies (z.B. sessionid, auth_token)<br/>\n                  4. Format: <code>cookie1=value1; cookie2=value2</code>\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"userAgent\">Custom User-Agent (optional)</Label>\n                <Input\n                  id=\"userAgent\"\n                  value={formData.userAgent}\n                  onChange={(e) => setFormData({ ...formData, userAgent: e.target.value })}\n                  placeholder=\"Mozilla/5.0 (Windows NT 10.0; Win64; x64)...\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Falls die Webseite bestimmte Browser erfordert\n                </p>\n              </div>\n\n              <div className=\"border-t pt-4 mt-4\">\n                <h4 className=\"font-medium mb-3\">Automatischer Login</h4>\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  Fr Shops, die eine Anmeldung erfordern\n                </p>\n                \n                <div className=\"space-y-3\">\n                  <div>\n                    <Label htmlFor=\"loginUrl\">Login-URL</Label>\n                    <Input\n                      id=\"loginUrl\"\n                      value={formData.loginUrl}\n                      onChange={(e) => setFormData({ ...formData, loginUrl: e.target.value })}\n                      placeholder=\"https://shop.example.com/login\"\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <div>\n                      <Label htmlFor=\"loginUsernameField\" className=\"text-xs\"> Benutzername-Feld (CSS-Selektor)</Label>\n                      <Input\n                        id=\"loginUsernameField\"\n                        value={formData.loginUsernameField}\n                        onChange={(e) => setFormData({ ...formData, loginUsernameField: e.target.value })}\n                        placeholder=\"input[name='email']\"\n                        className=\"text-sm font-mono\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setFormData({ ...formData, loginUsernameField: \"input[name='email'], input[name='username'], #email, #username\" })}\n                        className=\"text-xs text-blue-600 hover:underline mt-1\"\n                      >\n                         Standard-Werte setzen\n                      </button>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"loginPasswordField\" className=\"text-xs\"> Passwort-Feld (CSS-Selektor)</Label>\n                      <Input\n                        id=\"loginPasswordField\"\n                        value={formData.loginPasswordField}\n                        onChange={(e) => setFormData({ ...formData, loginPasswordField: e.target.value })}\n                        placeholder=\"input[name='password']\"\n                        className=\"text-sm font-mono\"\n                      />\n                      <button\n                        type=\"button\"\n                        onClick={() => setFormData({ ...formData, loginPasswordField: \"input[name='password'], input[type='password'], #password\" })}\n                        className=\"text-xs text-blue-600 hover:underline mt-1\"\n                      >\n                         Standard-Werte setzen\n                      </button>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <div>\n                      <Label htmlFor=\"loginUsername\" className=\"text-xs\"> Benutzername (Ihre Login-Daten)</Label>\n                      <Input\n                        id=\"loginUsername\"\n                        value={formData.loginUsername}\n                        onChange={(e) => setFormData({ ...formData, loginUsername: e.target.value })}\n                        placeholder=\"z.B. kundenservice@shop.de\"\n                        className=\"text-sm\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"loginPassword\" className=\"text-xs\"> Passwort (Ihre Login-Daten)</Label>\n                      <Input\n                        id=\"loginPassword\"\n                        type=\"password\"\n                        value={formData.loginPassword}\n                        onChange={(e) => setFormData({ ...formData, loginPassword: e.target.value })}\n                        placeholder=\"Ihr Passwort\"\n                        className=\"text-sm\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <div className=\"flex items-center justify-between mb-3\">\n                <h3 className=\"font-semibold\">Produkt-Selektoren (optional)</h3>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={async () => {\n                    try {\n                      const response = await fetch('/api/selectors/brickfox', {\n                        credentials: 'include'\n                      });\n                      const data = await response.json();\n                      if (data.success && data.selectors) {\n                        setFormData({ ...formData, selectors: data.selectors });\n                        setVerifiedFields(new Set());\n                        toast({\n                          title: \" Starter-Template geladen\",\n                          description: \"Diese Selektoren mssen fr Ihre Website angepasst werden. Bitte testen und verifizieren Sie jeden Selektor.\",\n                          variant: \"default\",\n                        });\n                      }\n                    } catch (error) {\n                      console.error('Fehler beim Laden der Brickfox-Selektoren:', error);\n                    }\n                  }}\n                  className=\"text-xs\"\n                >\n                   Starter-Template laden\n                </Button>\n              </div>\n              \n              <div className=\"bg-amber-50 border border-amber-200 rounded-md p-3 mb-3\">\n                <p className=\"text-xs text-amber-800\">\n                  <strong> Wichtig:</strong> Jede Website hat unterschiedliche CSS-Strukturen. \n                  Passen Sie die Selektoren an Ihre spezifische Website an und testen Sie sie.\n                </p>\n              </div>\n\n              <div className=\"mb-3\">\n                <Label htmlFor=\"testUrl\" className=\"text-sm\">Test-URL (fr Selektor-Validierung)</Label>\n                <Input\n                  id=\"testUrl\"\n                  value={testUrl}\n                  onChange={(e) => setTestUrl(e.target.value)}\n                  placeholder=\"https://shop.example.com/produkt/beispiel-123\"\n                  className=\"text-sm\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  URL zu einem Beispielprodukt, um Selektoren zu testen\n                </p>\n              </div>\n\n              <p className=\"text-xs text-muted-foreground mb-4\">\n                {Object.keys(formData.selectors).length} Selektoren konfiguriert  {verifiedFields.size} verifiziert\n              </p>\n              <div className=\"grid grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2\">\n                {Object.entries(formData.selectors).map(([key, value]) => {\n                  // Generate friendly label names\n                  const labelMap: Record<string, string> = {\n                    articleNumber: \"Artikelnummer\",\n                    productName: \"Produktname\",\n                    ean: \"EAN\",\n                    manufacturer: \"Hersteller\",\n                    price: \"Preis\",\n                    weight: \"Gewicht\",\n                    description: \"Beschreibung\",\n                    images: \"Bilder\",\n                    category: \"Kategorie\",\n                    technicalTable: \"Technische Tabelle\",\n                    length: \"Lnge (mm)\",\n                    bodyDiameter: \"Gehusedurchmesser (mm)\",\n                    headDiameter: \"Kopfdurchmesser (mm)\",\n                    weightWithoutBattery: \"Gewicht ohne Akku (g)\",\n                    totalWeight: \"Gesamt Gewicht (g)\",\n                    powerSupply: \"Stromversorgung\",\n                    led1: \"Leuchtmittel 1\",\n                    led2: \"Leuchtmittel 2\",\n                    spotIntensity: \"Spotintensitt (cd)\",\n                    maxLuminosity: \"Leuchtleistung max.\",\n                    maxBeamDistance: \"Leuchtweite max. (m)\"\n                  };\n\n                  const label = labelMap[key] || key.charAt(0).toUpperCase() + key.slice(1);\n                  const isVerified = verifiedFields.has(key);\n                  const isTesting = testingField === key;\n                  const hasValue = value && value.trim().length > 0;\n\n                  return (\n                    <div key={key} className=\"space-y-1\">\n                      <Label htmlFor={`selector-${key}`} className=\"text-sm flex items-center gap-1\">\n                        {label}\n                        {isVerified && <CheckCircle className=\"w-3 h-3 text-green-600\" />}\n                        {!isVerified && hasValue && <AlertCircle className=\"w-3 h-3 text-amber-500\" />}\n                      </Label>\n                      <div className=\"flex gap-1\">\n                        <Input\n                          id={`selector-${key}`}\n                          value={value || \"\"}\n                          onChange={(e) => {\n                            setFormData({\n                              ...formData,\n                              selectors: { ...formData.selectors, [key]: e.target.value }\n                            });\n                            setVerifiedFields(prev => {\n                              const newSet = new Set(prev);\n                              newSet.delete(key);\n                              return newSet;\n                            });\n                          }}\n                          placeholder={`CSS-Selektor fr ${label}`}\n                          className={`text-sm ${!isVerified && hasValue ? 'border-amber-300 bg-amber-50' : ''} ${isVerified ? 'border-green-300 bg-green-50' : ''}`}\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          size=\"icon\"\n                          onClick={() => handleTestSelector(key, value)}\n                          disabled={!value || !testUrl || isTesting}\n                          title=\"Selektor testen\"\n                          className=\"shrink-0\"\n                        >\n                          <TestTube className={`w-4 h-4 ${isTesting ? 'animate-pulse' : ''}`} />\n                        </Button>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\n              Abbrechen\n            </Button>\n            <Button onClick={handleSave} disabled={isLoading}>\n              <Save className=\"w-4 h-4 mr-2\" />\n              {isLoading ? \"Speichern...\" : \"Speichern\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":30210},"client/src/pages/account.tsx":{"content":"import { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Separator } from '@/components/ui/separator';\nimport { Progress } from '@/components/ui/progress';\nimport { ExternalLink, CreditCard, User, TrendingUp } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { useLocation } from 'wouter';\n\nexport default function Account() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: userData, refetch: refetchUser } = useQuery({\n    queryKey: ['/api/auth/user'],\n    queryFn: async () => {\n      const res = await fetch('/api/auth/user', { credentials: 'include' });\n      if (!res.ok) {\n        setLocation('/login');\n        return null;\n      }\n      return res.json();\n    },\n  });\n\n  const { data: subscriptionData } = useQuery({\n    queryKey: ['/api/subscription/status'],\n    queryFn: async () => {\n      const res = await fetch('/api/subscription/status', { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to load subscription');\n      return res.json();\n    },\n    enabled: !!userData?.user,\n  });\n\n  const portalMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch('/api/stripe/create-portal-session', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Portal-Session fehlgeschlagen');\n      }\n      \n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch('/api/auth/logout', {\n        method: 'POST',\n        credentials: 'include',\n      });\n      if (!res.ok) throw new Error('Logout fehlgeschlagen');\n      return res.json();\n    },\n    onSuccess: () => {\n      setLocation('/login');\n    },\n  });\n\n  if (!userData?.user) {\n    return null;\n  }\n\n  const user = userData.user;\n  const subscription = subscriptionData?.user;\n  const plan = subscriptionData?.plan;\n  const usagePercent = subscription \n    ? (subscription.apiCallsUsed / subscription.apiCallsLimit) * 100\n    : 0;\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4\">\n      <div className=\"max-w-4xl mx-auto space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold text-gray-900\">Mein Account</h1>\n          <Button variant=\"outline\" onClick={() => logoutMutation.mutate()}>\n            Abmelden\n          </Button>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-3\">\n                <User className=\"h-6 w-6\" />\n                <div>\n                  <CardTitle>Profil</CardTitle>\n                  <CardDescription>{user.email}</CardDescription>\n                </div>\n              </div>\n              {user.username && (\n                <Badge variant=\"secondary\">{user.username}</Badge>\n              )}\n            </div>\n          </CardHeader>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-3\">\n                <CreditCard className=\"h-6 w-6\" />\n                <div>\n                  <CardTitle>Abonnement</CardTitle>\n                  <CardDescription>\n                    {plan ? `${plan.name} Plan` : 'Kein aktives Abo'}\n                  </CardDescription>\n                </div>\n              </div>\n              {subscription?.planId && (\n                <Badge\n                  variant={\n                    subscription.subscriptionStatus === 'active'\n                      ? 'default'\n                      : subscription.subscriptionStatus === 'past_due'\n                      ? 'destructive'\n                      : 'secondary'\n                  }\n                >\n                  {subscription.subscriptionStatus === 'active'\n                    ? 'Aktiv'\n                    : subscription.subscriptionStatus === 'past_due'\n                    ? 'Zahlungsrckstand'\n                    : subscription.subscriptionStatus || 'Inaktiv'}\n                </Badge>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {plan && (\n              <>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-gray-600\">Preis</p>\n                    <p className=\"text-xl font-bold\">{plan.price}/Monat</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-gray-600\">AI-Calls Limit</p>\n                    <p className=\"text-xl font-bold\">{plan.apiCallsLimit}</p>\n                  </div>\n                </div>\n\n                <Separator />\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span>Features:</span>\n                  </div>\n                  <ul className=\"text-sm text-gray-600 space-y-1\">\n                    {plan.features.map((feature: string, idx: number) => (\n                      <li key={idx}> {feature}</li>\n                    ))}\n                  </ul>\n                </div>\n\n                <Separator />\n\n                <div className=\"space-y-2\">\n                  <Button\n                    className=\"w-full\"\n                    onClick={() => portalMutation.mutate()}\n                    disabled={portalMutation.isPending}\n                  >\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\n                    {portalMutation.isPending\n                      ? 'Wird geladen...'\n                      : 'Abo verwalten (Rechnungen, Kndigung)'}\n                  </Button>\n                </div>\n              </>\n            )}\n\n            {!plan && (\n              <div className=\"text-center py-4\">\n                <p className=\"text-gray-600 mb-4\">\n                  Sie haben noch kein aktives Abonnement\n                </p>\n                <Button onClick={() => setLocation('/pricing')}>\n                  Plan whlen\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {subscription && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center space-x-3\">\n                <TrendingUp className=\"h-6 w-6\" />\n                <div>\n                  <CardTitle>Nutzung</CardTitle>\n                  <CardDescription>\n                    Ihre AI-Generierungen diesen Monat\n                  </CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span>\n                    {subscription.apiCallsUsed} / {subscription.apiCallsLimit} verwendet\n                  </span>\n                  <span className=\"text-gray-600\">\n                    {Math.round(usagePercent)}%\n                  </span>\n                </div>\n                <Progress value={usagePercent} className=\"h-2\" />\n              </div>\n\n              {usagePercent >= 80 && (\n                <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\n                  <p className=\"text-sm text-yellow-800\">\n                    <strong>Achtung:</strong> Sie haben {Math.round(usagePercent)}% Ihres\n                    monatlichen Limits erreicht.\n                    {usagePercent >= 100 ? (\n                      <> Upgraden Sie Ihren Plan fr mehr AI-Generierungen.</>\n                    ) : (\n                      <> Bald ist Ihr Limit erreicht.</>\n                    )}\n                  </p>\n                  {usagePercent >= 90 && (\n                    <Button\n                      className=\"mt-2 w-full\"\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setLocation('/pricing')}\n                    >\n                      Plan upgraden\n                    </Button>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":8927},"client/src/components/usage-meter.tsx":{"content":"import { Progress } from '@/components/ui/progress';\nimport { useAuth } from '@/lib/auth-context';\nimport { TrendingUp, AlertTriangle } from 'lucide-react';\n\nexport function UsageMeter() {\n  const { user } = useAuth();\n\n  if (!user) {\n    return null;\n  }\n\n  const usagePercent = (user.apiCallsUsed / user.apiCallsLimit) * 100;\n  const isWarning = usagePercent >= 80;\n  const isCritical = usagePercent >= 100;\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-center justify-between text-sm\">\n        <div className=\"flex items-center gap-2\">\n          {isWarning ? (\n            <AlertTriangle className={`h-4 w-4 ${isCritical ? 'text-red-500' : 'text-yellow-500'}`} />\n          ) : (\n            <TrendingUp className=\"h-4 w-4 text-gray-600\" />\n          )}\n          <span className=\"font-medium\">API-Nutzung</span>\n        </div>\n        <span className=\"text-gray-600\">\n          {user.apiCallsUsed} / {user.apiCallsLimit}\n        </span>\n      </div>\n      <Progress\n        value={usagePercent}\n        className={`h-2 ${isCritical ? 'bg-red-100' : isWarning ? 'bg-yellow-100' : ''}`}\n      />\n      {isCritical && (\n        <p className=\"text-xs text-red-600\">\n          Limit erreicht. Upgraden Sie Ihren Plan fr mehr AI-Generierungen.\n        </p>\n      )}\n    </div>\n  );\n}\n","size_bytes":1315},"server/stripe-service.ts":{"content":"import Stripe from 'stripe';\nimport { supabaseStorage } from './supabase-storage';\n\n// Stripe Configuration\nconst getStripe = () => {\n  const secretKey = process.env.STRIPE_SECRET_KEY;\n  if (!secretKey) {\n    console.warn(' STRIPE_SECRET_KEY nicht konfiguriert - Stripe-Funktionen deaktiviert');\n    return null;\n  }\n  return new Stripe(secretKey, {\n    apiVersion: '2025-10-29.clover',\n  });\n};\n\n// Subscription Plans Configuration\nexport const PLANS = {\n  starter: {\n    id: 'starter',\n    name: 'Starter',\n    price: 29,\n    currency: 'eur',\n    apiCallsLimit: 15000, // GPT-4o-mini: 30 gnstiger (500  15k)\n    features: ['3000 Produkte/Monat', '15.000 AI-Generierungen (GPT-4o-mini)', 'CSV-Import', 'URL-Scraping'],\n  },\n  pro: {\n    id: 'pro',\n    name: 'Pro',\n    price: 79,\n    currency: 'eur',\n    apiCallsLimit: 150000, // GPT-4o-mini: 30 gnstiger (5k  150k)\n    features: ['30.000 Produkte/Monat', '150.000 AI-Generierungen (GPT-4o-mini)', 'Alle Starter-Features', 'Bulk-Processing', 'Vorrang-Support'],\n  },\n  enterprise: {\n    id: 'enterprise',\n    name: 'Enterprise',\n    price: 199,\n    currency: 'eur',\n    apiCallsLimit: 600000, // GPT-4o-mini: 30 gnstiger (20k  600k)\n    features: ['Unbegrenzte Produkte', '600.000 AI-Generierungen (GPT-4o-mini)', 'Alle Pro-Features', 'Custom Templates', 'Dedizierter Support'],\n  },\n};\n\n// Create Stripe Customer\nexport async function createStripeCustomer(userId: string, email: string) {\n  const stripe = getStripe();\n  if (!stripe) {\n    throw new Error('Stripe ist nicht konfiguriert');\n  }\n  \n  const customer = await stripe.customers.create({\n    email,\n    metadata: {\n      userId,\n    },\n  });\n  \n  await supabaseStorage.updateUserSubscription(userId, {\n    stripeCustomerId: customer.id,\n  });\n  \n  return customer;\n}\n\n// Create Checkout Session for Subscription\nexport async function createCheckoutSession(\n  userId: string,\n  email: string,\n  planId: 'starter' | 'pro' | 'enterprise',\n  successUrl: string,\n  cancelUrl: string\n) {\n  const stripe = getStripe();\n  if (!stripe) {\n    throw new Error('Stripe ist nicht konfiguriert. Bitte kontaktieren Sie den Administrator.');\n  }\n  const plan = PLANS[planId];\n  \n  if (!plan) {\n    throw new Error(`Ungltiger Plan: ${planId}`);\n  }\n  \n  // Get or create customer\n  const user = await supabaseStorage.getUserById(userId);\n  let customerId = user?.stripeCustomerId;\n  \n  if (!customerId) {\n    const customer = await createStripeCustomer(userId, email);\n    customerId = customer.id;\n  }\n  \n  // Get or create price ID from environment\n  const priceIdKey = `STRIPE_PRICE_${planId.toUpperCase()}` as const;\n  let priceId = process.env[priceIdKey];\n  \n  // If no price ID in env, create one dynamically (for testing)\n  if (!priceId) {\n    const price = await stripe.prices.create({\n      currency: plan.currency,\n      unit_amount: plan.price * 100, // Convert to cents\n      recurring: {\n        interval: 'month',\n      },\n      product_data: {\n        name: `PIMPilot ${plan.name}`,\n      },\n    });\n    priceId = price.id;\n    console.log(` Dynamisch erstellte Price ID fr ${planId}: ${priceId}`);\n    console.log(` Fgen Sie diese in .env hinzu: ${priceIdKey}=${priceId}`);\n  }\n  \n  const session = await stripe.checkout.sessions.create({\n    customer: customerId,\n    mode: 'subscription',\n    payment_method_types: ['card'],\n    line_items: [\n      {\n        price: priceId,\n        quantity: 1,\n      },\n    ],\n    success_url: successUrl,\n    cancel_url: cancelUrl,\n    metadata: {\n      userId,\n      planId,\n    },\n  });\n  \n  return session;\n}\n\n// Create Customer Portal Session\nexport async function createPortalSession(customerId: string, returnUrl: string) {\n  const stripe = getStripe();\n  if (!stripe) {\n    throw new Error('Stripe ist nicht konfiguriert. Bitte kontaktieren Sie den Administrator.');\n  }\n  \n  const session = await stripe.billingPortal.sessions.create({\n    customer: customerId,\n    return_url: returnUrl,\n  });\n  \n  return session;\n}\n\n// Handle Stripe Webhook Events\nexport async function handleWebhookEvent(event: Stripe.Event) {\n  const stripe = getStripe();\n  if (!stripe) {\n    console.error('Stripe nicht konfiguriert - Webhook ignoriert');\n    return;\n  }\n  \n  switch (event.type) {\n    case 'checkout.session.completed': {\n      const session = event.data.object as Stripe.Checkout.Session;\n      const userId = session.metadata?.userId;\n      const planId = session.metadata?.planId as 'starter' | 'pro' | 'enterprise';\n      \n      if (!userId || !planId) {\n        console.error('Missing metadata in checkout.session.completed');\n        return;\n      }\n      \n      const plan = PLANS[planId];\n      \n      // Get subscription details\n      if (session.subscription) {\n        const subscription = await stripe.subscriptions.retrieve(session.subscription as string);\n        \n        await supabaseStorage.updateUserSubscription(userId, {\n          subscriptionStatus: 'active',\n          subscriptionId: subscription.id,\n          planId,\n          currentPeriodEnd: new Date((subscription.current_period_end || 0) * 1000).toISOString(),\n          apiCallsLimit: plan.apiCallsLimit,\n        });\n        \n        console.log(` Subscription activated for user ${userId}, plan: ${planId}`);\n      }\n      break;\n    }\n    \n    case 'invoice.payment_succeeded': {\n      const invoice = event.data.object as Stripe.Invoice;\n      const subscriptionId = typeof invoice.subscription === 'string' ? invoice.subscription : invoice.subscription?.id;\n      \n      if (subscriptionId) {\n        const subscription = await stripe.subscriptions.retrieve(subscriptionId);\n        const userId = subscription.metadata?.userId;\n        \n        if (userId) {\n          await supabaseStorage.updateUserSubscription(userId, {\n            subscriptionStatus: 'active',\n            currentPeriodEnd: new Date((subscription.current_period_end || 0) * 1000).toISOString(),\n          });\n          \n          // Reset API calls counter for new billing period\n          await supabaseStorage.resetApiCalls(userId);\n          \n          console.log(` Payment succeeded, subscription renewed for user ${userId}`);\n        }\n      }\n      break;\n    }\n    \n    case 'invoice.payment_failed': {\n      const invoice = event.data.object as Stripe.Invoice;\n      const subscriptionId = typeof invoice.subscription === 'string' ? invoice.subscription : invoice.subscription?.id;\n      \n      if (subscriptionId) {\n        const subscription = await stripe.subscriptions.retrieve(subscriptionId);\n        const userId = subscription.metadata?.userId;\n        \n        if (userId) {\n          await supabaseStorage.updateUserSubscription(userId, {\n            subscriptionStatus: 'past_due',\n          });\n          \n          console.log(` Payment failed for user ${userId}`);\n        }\n      }\n      break;\n    }\n    \n    case 'customer.subscription.updated': {\n      const subscription = event.data.object as Stripe.Subscription;\n      const userId = subscription.metadata?.userId;\n      \n      if (userId) {\n        // Check if plan changed\n        const priceId = subscription.items.data[0]?.price.id;\n        let newPlanId: 'starter' | 'pro' | 'enterprise' | undefined;\n        \n        // Determine plan from price (this is a simplification, ideally store price->plan mapping)\n        if (subscription.metadata?.planId) {\n          newPlanId = subscription.metadata.planId as any;\n        }\n        \n        await supabaseStorage.updateUserSubscription(userId, {\n          subscriptionStatus: subscription.status,\n          currentPeriodEnd: new Date((subscription.current_period_end || 0) * 1000).toISOString(),\n          planId: newPlanId,\n          apiCallsLimit: newPlanId ? PLANS[newPlanId].apiCallsLimit : undefined,\n        });\n        \n        console.log(` Subscription updated for user ${userId}, status: ${subscription.status}`);\n      }\n      break;\n    }\n    \n    case 'customer.subscription.deleted': {\n      const subscription = event.data.object as Stripe.Subscription;\n      const userId = subscription.metadata?.userId;\n      \n      if (userId) {\n        await supabaseStorage.updateUserSubscription(userId, {\n          subscriptionStatus: 'canceled',\n          subscriptionId: undefined,\n          planId: undefined,\n        });\n        \n        console.log(` Subscription canceled for user ${userId}`);\n      }\n      break;\n    }\n    \n    default:\n      console.log(`Unhandled event type: ${event.type}`);\n  }\n}\n\n// Get Subscription Status\nexport async function getSubscriptionStatus(userId: string) {\n  const user = await supabaseStorage.getUserById(userId);\n  \n  if (!user) {\n    throw new Error('User not found');\n  }\n  \n  const stripe = getStripe();\n  let subscriptionDetails = null;\n  \n  // If Stripe is not configured, return user data without subscription details\n  if (!stripe) {\n    const planId = user.planId as keyof typeof PLANS | null;\n    return {\n      user: {\n        subscriptionStatus: user.subscriptionStatus || 'trial',\n        planId: user.planId || 'trial',\n        apiCallsUsed: user.apiCallsUsed || 0,\n        apiCallsLimit: user.apiCallsLimit || 50,\n      },\n      plan: planId && PLANS[planId] ? PLANS[planId] : {\n        id: 'trial',\n        name: 'Trial',\n        price: 0,\n        currency: 'eur',\n        apiCallsLimit: 50, // Trial limit: 50 calls\n        features: [\n          '50 AI-Generierungen (Trial)',\n          'Alle Features zum Testen',\n          'Upgrade jederzeit mglich'\n        ]\n      },\n      subscription: null\n    };\n  }\n  \n  if (user.subscriptionId) {\n    try {\n      const subscription = await stripe.subscriptions.retrieve(user.subscriptionId);\n      subscriptionDetails = {\n        id: subscription.id,\n        status: subscription.status,\n        currentPeriodEnd: new Date((subscription.current_period_end || 0) * 1000).toISOString(),\n        cancelAtPeriodEnd: subscription.cancel_at_period_end,\n      };\n    } catch (error) {\n      console.error('Error retrieving subscription:', error);\n    }\n  }\n  \n  return {\n    user: {\n      subscriptionStatus: user.subscriptionStatus,\n      planId: user.planId,\n      apiCallsUsed: user.apiCallsUsed,\n      apiCallsLimit: user.apiCallsLimit,\n      currentPeriodEnd: user.currentPeriodEnd,\n    },\n    subscription: subscriptionDetails,\n    plan: user.planId ? PLANS[user.planId as keyof typeof PLANS] : null,\n  };\n}\n","size_bytes":10422},"client/src/pages/login.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { useLocation } from 'wouter';\nimport { useMutation } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { useToast } from '@/hooks/use-toast';\nimport { supabase } from '@/lib/supabase';\nimport { Eye, EyeOff } from 'lucide-react';\n\nconst loginSchema = z.object({\n  email: z.string().min(1, 'Benutzername oder E-Mail erforderlich'),\n  password: z.string().min(1, 'Passwort erforderlich'),\n  rememberMe: z.boolean().optional(),\n});\n\ntype LoginForm = z.infer<typeof loginSchema>;\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  \n  // Load \"Remember Me\" preference from storage (default: true)\n  const [rememberMe, setRememberMe] = useState(() => {\n    const saved = localStorage.getItem('rememberMe');\n    return saved === null ? true : saved === 'true';\n  });\n\n  const {\n    register,\n    handleSubmit,\n    formState: { errors },\n  } = useForm<LoginForm>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      rememberMe: true,\n    },\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (data: LoginForm) => {\n      // Save \"Remember Me\" preference BEFORE login to ensure DynamicStorage uses it\n      if (rememberMe) {\n        localStorage.setItem('rememberMe', 'true');\n      } else {\n        localStorage.setItem('rememberMe', 'false');\n      }\n      \n      const res = await fetch('/api/auth/login', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data),\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Login fehlgeschlagen');\n      }\n      \n      return res.json();\n    },\n    onSuccess: async (data) => {\n      // Set Supabase session properly (DynamicStorage will use the rememberMe preference)\n      if (data.session) {\n        const { error } = await supabase.auth.setSession({\n          access_token: data.session.access_token,\n          refresh_token: data.session.refresh_token,\n        });\n\n        if (error) {\n          console.error('Failed to set Supabase session:', error);\n        } else {\n          console.log(' Supabase session set successfully');\n          \n          // Store token in the appropriate storage AND clean up the other\n          const storage = rememberMe ? localStorage : sessionStorage;\n          const otherStorage = rememberMe ? sessionStorage : localStorage;\n          \n          storage.setItem('supabase_token', data.session.access_token);\n          otherStorage.removeItem('supabase_token'); // Prevent token resurrection\n        }\n      }\n      \n      toast({\n        title: 'Erfolgreich angemeldet',\n        description: 'Sie werden weitergeleitet...',\n      });\n      \n      // Wait a moment for session to be set, then redirect\n      setTimeout(() => {\n        if (data.user?.isAdmin) {\n          window.location.href = '/admin/dashboard';\n        } else {\n          window.location.href = '/dashboard';\n        }\n      }, 300);\n    },\n    onError: (error: Error) => {\n      setIsLoading(false);\n      toast({\n        title: 'Login fehlgeschlagen',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: LoginForm) => {\n    setIsLoading(true);\n    loginMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-50 to-violet-100 p-4\">\n      <Card className=\"w-full max-w-md shadow-xl\">\n        <CardHeader className=\"space-y-1\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <a \n              href=\"/\" \n              className=\"text-sm text-gray-600 hover:text-indigo-600 flex items-center gap-1 transition-colors\"\n            >\n               Zurck zur Startseite\n            </a>\n          </div>\n          <CardTitle className=\"text-2xl font-bold text-center bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent\">PIMPilot</CardTitle>\n          <CardDescription className=\"text-center\">\n            Melden Sie sich mit Ihrem Account an\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">E-Mail oder Benutzername</Label>\n              <Input\n                id=\"email\"\n                type=\"text\"\n                placeholder=\"\"\n                {...register('email')}\n                disabled={isLoading}\n              />\n              {errors.email && (\n                <p className=\"text-sm text-red-500\">{errors.email.message}</p>\n              )}\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Passwort</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"password\"\n                  type={showPassword ? \"text\" : \"password\"}\n                  placeholder=\"\"\n                  {...register('password')}\n                  disabled={isLoading}\n                  className=\"pr-10\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700\"\n                  tabIndex={-1}\n                >\n                  {showPassword ? (\n                    <EyeOff className=\"h-4 w-4\" />\n                  ) : (\n                    <Eye className=\"h-4 w-4\" />\n                  )}\n                </button>\n              </div>\n              {errors.password && (\n                <p className=\"text-sm text-red-500\">{errors.password.message}</p>\n              )}\n            </div>\n            \n            <div className=\"flex items-center space-x-2\">\n              <Checkbox\n                id=\"rememberMe\"\n                checked={rememberMe}\n                onCheckedChange={(checked) => setRememberMe(checked === true)}\n                disabled={isLoading}\n              />\n              <Label\n                htmlFor=\"rememberMe\"\n                className=\"text-sm font-normal cursor-pointer\"\n              >\n                Angemeldet bleiben\n              </Label>\n            </div>\n            \n            <Button type=\"submit\" className=\"w-full\" disabled={isLoading}>\n              {isLoading ? 'Wird angemeldet...' : 'Anmelden'}\n            </Button>\n          </form>\n        </CardContent>\n        <CardFooter className=\"flex flex-col space-y-2\">\n          <div className=\"text-sm text-gray-600 text-center\">\n            Noch kein Account?{' '}\n            <a href=\"/register\" className=\"text-indigo-600 hover:underline font-medium\">\n              Jetzt registrieren\n            </a>\n          </div>\n        </CardFooter>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":7526},"client/src/components/protected-route.tsx":{"content":"import { ReactNode, useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { useAuth } from '@/lib/auth-context';\nimport { UpgradePrompt } from './upgrade-prompt';\n\ninterface ProtectedRouteProps {\n  children: ReactNode;\n  requireSubscription?: boolean;\n}\n\nexport function ProtectedRoute({ children, requireSubscription = false }: ProtectedRouteProps) {\n  const { user, isLoading, isAuthenticated } = useAuth();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !isAuthenticated) {\n      setLocation('/login');\n    }\n  }, [isLoading, isAuthenticated, setLocation]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return null;\n  }\n\n  if (requireSubscription) {\n    if (!user?.subscriptionStatus || user.subscriptionStatus === 'canceled') {\n      return <UpgradePrompt reason=\"no_subscription\" />;\n    }\n\n    if (user.subscriptionStatus === 'past_due') {\n      return <UpgradePrompt reason=\"past_due\" />;\n    }\n  }\n\n  return <>{children}</>;\n}\n","size_bytes":1209},"client/src/pages/register.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { useLocation } from 'wouter';\nimport { useMutation } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { useToast } from '@/hooks/use-toast';\nimport { supabase } from '@/lib/supabase';\nimport { Eye, EyeOff } from 'lucide-react';\n\nconst registerSchema = z.object({\n  companyName: z.string().min(2, 'Firmenname muss mindestens 2 Zeichen lang sein'),\n  email: z.string().email('Ungltige E-Mail-Adresse'),\n  password: z.string().min(8, 'Passwort muss mindestens 8 Zeichen lang sein'),\n  confirmPassword: z.string(),\n  username: z.string().optional(),\n}).refine((data) => data.password === data.confirmPassword, {\n  message: 'Passwrter stimmen nicht berein',\n  path: ['confirmPassword'],\n});\n\ntype RegisterForm = z.infer<typeof registerSchema>;\n\nexport default function Register() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  const {\n    register,\n    handleSubmit,\n    formState: { errors },\n  } = useForm<RegisterForm>({\n    resolver: zodResolver(registerSchema),\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (data: Omit<RegisterForm, 'confirmPassword'>) => {\n      const res = await fetch('/api/auth/register', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data),\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Registrierung fehlgeschlagen');\n      }\n      \n      return res.json();\n    },\n    onSuccess: async (data) => {\n      // Set Supabase session properly\n      if (data.session) {\n        const { error } = await supabase.auth.setSession({\n          access_token: data.session.access_token,\n          refresh_token: data.session.refresh_token,\n        });\n\n        if (error) {\n          console.error('Failed to set Supabase session:', error);\n        } else {\n          console.log(' Supabase session set successfully');\n        }\n      }\n      \n      // Store access token for backward compatibility\n      if (data.access_token) {\n        localStorage.setItem('supabase_token', data.access_token);\n      }\n      \n      toast({\n        title: 'Willkommen bei PIMPilot! ',\n        description: 'Sie haben jetzt Zugriff auf alle Basis-Features (URL-Scraper, CSV-Import, KI-Beschreibungen)',\n      });\n      \n      // Small delay to ensure session is set before redirect\n      setTimeout(() => {\n        setLocation('/projects');\n      }, 500);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Registrierung fehlgeschlagen',\n        description: error.message,\n        variant: 'destructive',\n      });\n      setIsLoading(false);\n    },\n  });\n\n  const onSubmit = (data: RegisterForm) => {\n    setIsLoading(true);\n    const { confirmPassword, ...registerData } = data;\n    registerMutation.mutate(registerData);\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <a \n              href=\"/\" \n              className=\"text-sm text-gray-600 hover:text-indigo-600 flex items-center gap-1 transition-colors\"\n            >\n               Zurck zur Startseite\n            </a>\n          </div>\n          <CardTitle className=\"text-2xl font-bold text-center\">PIMPilot</CardTitle>\n          <CardDescription className=\"text-center\">\n            Erstellen Sie Ihren Account\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"companyName\">Firmenname</Label>\n              <Input\n                id=\"companyName\"\n                type=\"text\"\n                placeholder=\"z.B. AkkuShop GmbH\"\n                {...register('companyName')}\n                disabled={isLoading}\n              />\n              {errors.companyName && (\n                <p className=\"text-sm text-red-500\">{errors.companyName.message}</p>\n              )}\n              <p className=\"text-xs text-gray-500\">\n                Ihr Firmenname wird verwendet, um Ihren eigenen Workspace zu erstellen\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">E-Mail</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"ihre@email.de\"\n                {...register('email')}\n                disabled={isLoading}\n              />\n              {errors.email && (\n                <p className=\"text-sm text-red-500\">{errors.email.message}</p>\n              )}\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"username\">Benutzername (optional)</Label>\n              <Input\n                id=\"username\"\n                type=\"text\"\n                placeholder=\"IhrName\"\n                {...register('username')}\n                disabled={isLoading}\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Passwort</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"password\"\n                  type={showPassword ? \"text\" : \"password\"}\n                  placeholder=\"\"\n                  {...register('password')}\n                  disabled={isLoading}\n                  className=\"pr-10\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700\"\n                  tabIndex={-1}\n                >\n                  {showPassword ? (\n                    <EyeOff className=\"h-4 w-4\" />\n                  ) : (\n                    <Eye className=\"h-4 w-4\" />\n                  )}\n                </button>\n              </div>\n              {errors.password && (\n                <p className=\"text-sm text-red-500\">{errors.password.message}</p>\n              )}\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"confirmPassword\">Passwort besttigen</Label>\n              <div className=\"relative\">\n                <Input\n                  id=\"confirmPassword\"\n                  type={showConfirmPassword ? \"text\" : \"password\"}\n                  placeholder=\"\"\n                  {...register('confirmPassword')}\n                  disabled={isLoading}\n                  className=\"pr-10\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700\"\n                  tabIndex={-1}\n                >\n                  {showConfirmPassword ? (\n                    <EyeOff className=\"h-4 w-4\" />\n                  ) : (\n                    <Eye className=\"h-4 w-4\" />\n                  )}\n                </button>\n              </div>\n              {errors.confirmPassword && (\n                <p className=\"text-sm text-red-500\">{errors.confirmPassword.message}</p>\n              )}\n            </div>\n            \n            <Button type=\"submit\" className=\"w-full\" disabled={isLoading}>\n              {isLoading ? 'Wird registriert...' : 'Account erstellen'}\n            </Button>\n          </form>\n        </CardContent>\n        <CardFooter className=\"flex flex-col space-y-2\">\n          <div className=\"text-sm text-gray-600 text-center\">\n            Bereits ein Account?{' '}\n            <a href=\"/login\" className=\"text-blue-600 hover:underline\">\n              Jetzt anmelden\n            </a>\n          </div>\n        </CardFooter>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":8659},"server/middleware/subscription.ts":{"content":"import { Request, Response, NextFunction } from 'express';\nimport { storage } from '../storage';\n\n// Check if user is authenticated\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: 'Authentifizierung erforderlich' });\n  }\n  next();\n}\n\n// Check if user has an active subscription\nexport function requireSubscription(req: Request, res: Response, next: NextFunction) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: 'Authentifizierung erforderlich' });\n  }\n\n  const user = req.user as any;\n\n  if (!user.subscriptionStatus || user.subscriptionStatus === 'canceled') {\n    return res.status(403).json({ \n      error: 'Aktives Abonnement erforderlich',\n      message: 'Um diese Funktion zu nutzen, bentigen Sie ein aktives Abonnement.',\n      upgradeUrl: '/pricing'\n    });\n  }\n\n  if (user.subscriptionStatus === 'past_due') {\n    return res.status(403).json({ \n      error: 'Zahlung berfllig',\n      message: 'Ihre Zahlung ist berfllig. Bitte aktualisieren Sie Ihre Zahlungsmethode.',\n      updateUrl: '/account'\n    });\n  }\n\n  next();\n}\n\n// Check if user has reached their API call limit\nexport async function checkApiLimit(req: Request, res: Response, next: NextFunction) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: 'Authentifizierung erforderlich' });\n  }\n\n  const user = req.user as any;\n\n  // Get fresh user data to ensure limits are up to date\n  const freshUser = await storage.getUserById(user.id);\n  \n  if (!freshUser) {\n    return res.status(404).json({ error: 'Benutzer nicht gefunden' });\n  }\n\n  const apiCallsUsed = freshUser.apiCallsUsed || 0;\n  const apiCallsLimit = freshUser.apiCallsLimit || 500;\n\n  if (apiCallsUsed >= apiCallsLimit) {\n    return res.status(429).json({\n      error: 'API-Limit erreicht',\n      message: `Sie haben Ihr monatliches Limit von ${apiCallsLimit} AI-Generierungen erreicht.`,\n      apiCallsUsed,\n      apiCallsLimit,\n      upgradeUrl: '/pricing'\n    });\n  }\n\n  // Update user object in request with fresh data\n  req.user = freshUser;\n  \n  next();\n}\n\n// Track API usage after successful request\nexport async function trackApiUsage(req: Request, res: Response, next: NextFunction) {\n  const originalJson = res.json.bind(res);\n\n  res.json = function(body: any) {\n    // Only track if request was successful (2xx status)\n    if (res.statusCode >= 200 && res.statusCode < 300) {\n      if (req.isAuthenticated()) {\n        const user = req.user as any;\n        \n        // Increment API calls asynchronously (don't block response)\n        storage.incrementApiCalls(user.id).catch(err => {\n          console.error('Error tracking API usage:', err);\n        });\n      }\n    }\n\n    return originalJson(body);\n  };\n\n  next();\n}\n\n// Combined middleware for AI-powered endpoints\nexport function requireActiveSubscriptionWithLimit(req: Request, res: Response, next: NextFunction) {\n  requireAuth(req, res, (err) => {\n    if (err) return next(err);\n    \n    requireSubscription(req, res, (err) => {\n      if (err) return next(err);\n      \n      checkApiLimit(req, res, next);\n    });\n  });\n}\n\n// Check if user is admin\nexport async function requireAdmin(req: Request, res: Response, next: NextFunction) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: 'Authentifizierung erforderlich' });\n  }\n\n  const user = req.user as any;\n\n  // Get fresh user data to check admin status\n  const freshUser = await storage.getUserById(user.id);\n  \n  if (!freshUser || !freshUser.isAdmin) {\n    return res.status(403).json({ \n      error: 'Zugriff verweigert',\n      message: 'Nur Administratoren haben Zugriff auf diesen Bereich.'\n    });\n  }\n\n  next();\n}\n","size_bytes":3762},"client/src/components/upgrade-prompt.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { AlertTriangle, TrendingUp, Zap } from 'lucide-react';\nimport { useLocation } from 'wouter';\n\ninterface UpgradePromptProps {\n  reason: 'limit_reached' | 'no_subscription' | 'past_due';\n  message?: string;\n}\n\nexport function UpgradePrompt({ reason, message }: UpgradePromptProps) {\n  const [, setLocation] = useLocation();\n\n  const content = {\n    limit_reached: {\n      icon: <AlertTriangle className=\"h-12 w-12 text-yellow-500\" />,\n      title: 'API-Limit erreicht',\n      description: message || 'Sie haben Ihr monatliches Limit fr AI-Generierungen erreicht.',\n      action: 'Plan upgraden',\n      actionUrl: '/pricing',\n    },\n    no_subscription: {\n      icon: <Zap className=\"h-12 w-12 text-blue-500\" />,\n      title: 'Abonnement erforderlich',\n      description: message || 'Um diese Funktion zu nutzen, bentigen Sie ein aktives Abonnement.',\n      action: 'Plan whlen',\n      actionUrl: '/pricing',\n    },\n    past_due: {\n      icon: <TrendingUp className=\"h-12 w-12 text-red-500\" />,\n      title: 'Zahlung berfllig',\n      description: message || 'Ihre Zahlung ist berfllig. Bitte aktualisieren Sie Ihre Zahlungsmethode.',\n      action: 'Zahlung aktualisieren',\n      actionUrl: '/account',\n    },\n  };\n\n  const promptContent = content[reason];\n\n  return (\n    <div className=\"flex items-center justify-center min-h-[400px] p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"mx-auto mb-4\">\n            {promptContent.icon}\n          </div>\n          <CardTitle className=\"text-2xl\">{promptContent.title}</CardTitle>\n          <CardDescription>{promptContent.description}</CardDescription>\n        </CardHeader>\n        <CardContent className=\"text-center text-sm text-gray-600\">\n          {reason === 'limit_reached' && (\n            <p>\n              Upgraden Sie auf einen hheren Plan, um mehr AI-Generierungen pro Monat zu erhalten.\n            </p>\n          )}\n          {reason === 'no_subscription' && (\n            <p>\n              Whlen Sie einen Plan, der zu Ihren Anforderungen passt, und starten Sie sofort.\n            </p>\n          )}\n          {reason === 'past_due' && (\n            <p>\n              Ihr Zugriff ist eingeschrnkt, bis die Zahlung erfolgreich ist.\n            </p>\n          )}\n        </CardContent>\n        <CardFooter>\n          <Button\n            className=\"w-full\"\n            onClick={() => setLocation(promptContent.actionUrl)}\n          >\n            {promptContent.action}\n          </Button>\n        </CardFooter>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2753},"client/src/pages/pricing.tsx":{"content":"import { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Check, ArrowLeft } from 'lucide-react';\nimport { useLocation } from 'wouter';\n\nexport default function Pricing() {\n  const [, setLocation] = useLocation();\n\n  const handleDemo = (plan: string) => {\n    setLocation('/register');\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-16 px-4\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"mb-8\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation('/')}\n            className=\"flex items-center gap-2 text-gray-600 hover:text-gray-900\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n            Zurck\n          </Button>\n        </div>\n        \n        <div className=\"text-center mb-16\">\n          <h1 className=\"text-5xl font-bold text-gray-900 mb-4\">\n            Der passende Tarif fr deinen Erfolg\n          </h1>\n          <p className=\"text-xl text-gray-600 max-w-3xl mx-auto\">\n            PIMPilot untersttzt dich bei der Produktdatenverwaltung  unabhngig von deiner \n            Unternehmensgre und Branche. Starte jetzt mit einer kostenlosen Testphase und whle \n            anschlieend das fr dich passende Paket.\n          </p>\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-8 max-w-5xl mx-auto items-stretch\">\n          {/* Professional Plan */}\n          <Card className=\"relative bg-white shadow-lg hover:shadow-xl transition-shadow flex flex-col\">\n            <CardHeader className=\"pb-8\">\n              <CardTitle className=\"text-3xl font-bold text-gray-900\">Professional</CardTitle>\n              <CardDescription className=\"text-gray-600 mt-2\">\n                Hervorragend fr Start-Ups, Scale-Ups, kleinere Unternehmen und kleinere Agenturen geeignet.\n              </CardDescription>\n            </CardHeader>\n\n            <CardContent className=\"space-y-4 pb-8 flex-grow\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">CSV Bulk-Import</span>  Hunderte Produkte auf einmal importieren\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">URL Scraper</span>  Automatisches Auslesen von Lieferanten-Websites\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">AI-Produktbeschreibungen</span>  SEO-optimierte Texte per KI\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">Lieferanten-Verwaltung</span>  Gespeicherte CSS-Selektoren\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">CSV-Export mit Field-Mapping</span>  Flexibles Export-System\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-700\">\n                    <span className=\"text-blue-600 font-medium\">Bis zu 500 Produkte/Monat</span>\n                  </span>\n                </div>\n              </div>\n            </CardContent>\n\n            <CardFooter className=\"flex flex-col gap-3 pt-4\">\n              <p className=\"text-2xl font-semibold text-blue-600 text-center w-full\">\n                Preis auf Anfrage\n              </p>\n              <Button \n                onClick={() => handleDemo('professional')}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-6 text-base\"\n              >\n                Kostenlos starten\n              </Button>\n            </CardFooter>\n          </Card>\n\n          {/* Enterprise Plan */}\n          <Card className=\"relative bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-300 shadow-xl hover:shadow-2xl transition-shadow flex flex-col\">\n            <CardHeader className=\"pb-8\">\n              <CardTitle className=\"text-3xl font-bold text-gray-900\">Enterprise</CardTitle>\n              <CardDescription className=\"text-gray-700 mt-2\">\n                Die perfekte Lsung fr groe Unternehmen und Agenturen, die viel Content in kurzer Zeit erstellen.\n              </CardDescription>\n            </CardHeader>\n\n            <CardContent className=\"space-y-4 pb-8 flex-grow\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">Alle Features aus Professional</span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">\n                    <span className=\"text-purple-600 font-medium\">PDF Auto-Scraper</span>  Automatische URL-Extraktion aus PDFs\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">\n                    <span className=\"text-purple-600 font-medium\">ERP-Integration</span>  Duplikat-Erkennung & Abgleich\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">\n                    <span className=\"text-purple-600 font-medium\">MediaMarkt-Formatierung</span>  Automatische Titelgenerierung\n                  </span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">Persnlicher Ansprechpartner & Support</span>\n                </div>\n                <div className=\"flex items-start\">\n                  <Check className=\"h-5 w-5 text-purple-600 mr-3 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-gray-800\">\n                    <span className=\"text-purple-600 font-medium\">Unbegrenzte Produktgenerierung</span>\n                  </span>\n                </div>\n              </div>\n            </CardContent>\n\n            <CardFooter className=\"flex flex-col gap-3 pt-4\">\n              <p className=\"text-2xl font-semibold text-purple-600 text-center w-full\">\n                Preis auf Anfrage\n              </p>\n              <Button \n                onClick={() => handleDemo('enterprise')}\n                className=\"w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 text-white font-medium py-6 text-base shadow-lg\"\n              >\n                Kostenlos starten\n              </Button>\n            </CardFooter>\n          </Card>\n        </div>\n\n        <div className=\"mt-16 text-center\">\n          <p className=\"text-gray-600\">\n            Alle Plne beinhalten 7 Tage Geld-zurck-Garantie\n          </p>\n          <p className=\"text-gray-600 mt-2\">\n            Monatlich kndbar  Keine versteckten Kosten\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8475},"STRIPE_SETUP.md":{"content":"# Stripe Setup-Anleitung fr PIMPilot SaaS\n\n## 1. Stripe Account erstellen\n1. Gehen Sie zu https://dashboard.stripe.com/register\n2. Erstellen Sie einen neuen Account\n3. Verifizieren Sie Ihre E-Mail\n\n## 2. Produkte und Preise erstellen\n\n### Im Stripe Dashboard (https://dashboard.stripe.com/test/products):\n\n#### Starter Plan\n1. Klicken Sie auf **\"Create product\"**\n2. Name: `PIMPilot Starter`\n3. Pricing model: **Recurring**\n4. Price: **29.00 EUR**\n5. Billing period: **Monthly**\n6. Klicken Sie auf **\"Save product\"**\n7. **Kopieren Sie die Price ID** (beginnt mit `price_...`)\n8. Speichern Sie sie als: `STRIPE_PRICE_STARTER`\n\n#### Pro Plan\n1. Klicken Sie auf **\"Create product\"**\n2. Name: `PIMPilot Pro`\n3. Pricing model: **Recurring**\n4. Price: **79.00 EUR**\n5. Billing period: **Monthly**\n6. Klicken Sie auf **\"Save product\"**\n7. **Kopieren Sie die Price ID** (beginnt mit `price_...`)\n8. Speichern Sie sie als: `STRIPE_PRICE_PRO`\n\n#### Enterprise Plan\n1. Klicken Sie auf **\"Create product\"**\n2. Name: `PIMPilot Enterprise`\n3. Pricing model: **Recurring**\n4. Price: **199.00 EUR**\n5. Billing period: **Monthly**\n6. Klicken Sie auf **\"Save product\"**\n7. **Kopieren Sie die Price ID** (beginnt mit `price_...`)\n8. Speichern Sie sie als: `STRIPE_PRICE_ENTERPRISE`\n\n## 3. API-Schlssel kopieren\n\n### Im Stripe Dashboard (https://dashboard.stripe.com/test/apikeys):\n\n#### Secret Key\n1. Klicken Sie auf **\"Reveal test key\"** bei **\"Secret key\"**\n2. Kopieren Sie den Schlssel (beginnt mit `sk_test_...`)\n3. Speichern Sie ihn als: `STRIPE_SECRET_KEY`\n\n#### Publishable Key\n1. Kopieren Sie den **\"Publishable key\"** (beginnt mit `pk_test_...`)\n2. Speichern Sie ihn als: `VITE_STRIPE_PUBLIC_KEY`\n\n## 4. Webhook einrichten\n\n### Im Stripe Dashboard (https://dashboard.stripe.com/test/webhooks):\n\n1. Klicken Sie auf **\"Add endpoint\"**\n2. Endpoint URL: `https://ihr-repl-name.replit.app/api/stripe/webhook`\n   - Ersetzen Sie `ihr-repl-name` mit Ihrer Replit-Domain\n3. **Events auswhlen:**\n   -  `checkout.session.completed`\n   -  `invoice.payment_succeeded`\n   -  `invoice.payment_failed`\n   -  `customer.subscription.updated`\n   -  `customer.subscription.deleted`\n4. Klicken Sie auf **\"Add endpoint\"**\n5. **Kopieren Sie den Webhook Signing Secret** (beginnt mit `whsec_...`)\n6. Speichern Sie ihn als: `STRIPE_WEBHOOK_SECRET`\n\n## 5. Environment-Variablen setzen\n\nFgen Sie die folgenden Variablen zu Ihrer `.env`-Datei hinzu:\n\n```env\n# Stripe API Keys (Backend)\nSTRIPE_SECRET_KEY=sk_test_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\n\n# Stripe Price IDs\nSTRIPE_PRICE_STARTER=price_...\nSTRIPE_PRICE_PRO=price_...\nSTRIPE_PRICE_ENTERPRISE=price_...\n\n# Stripe Public Key (Frontend)\nVITE_STRIPE_PUBLIC_KEY=pk_test_...\n```\n\n## 6. Testing\n\n### Test-Kreditkarten (Stripe Test Mode):\n- **Success:** `4242 4242 4242 4242`\n- **Decline:** `4000 0000 0000 0002`\n- **Expiry:** Beliebiges zuknftiges Datum (z.B. 12/34)\n- **CVC:** Beliebige 3 Ziffern (z.B. 123)\n\n### Test-Flow:\n1. Registrieren Sie einen neuen Test-User\n2. Whlen Sie einen Plan auf `/pricing`\n3. Verwenden Sie Testkarte `4242 4242 4242 4242`\n4. berprfen Sie die Subscription im Account\n5. Testen Sie AI-Generierung (sollte API-Calls zhlen)\n6. berprfen Sie Usage-Meter im Account\n\n## 7. Production Setup\n\n **Wichtig:** Fr Production verwenden Sie **LIVE** Keys statt Test Keys!\n\n### Im Stripe Dashboard umschalten:\n1. Klicken Sie auf **\"Test mode\"** Toggle oben rechts\n2. Schalten Sie um auf **Live mode**\n3. Wiederholen Sie die Schritte 2-4 mit **Live** Keys\n4. Ersetzen Sie alle `sk_test_...` / `pk_test_...` durch `sk_live_...` / `pk_live_...`\n\n## 8. Troubleshooting\n\n### Webhook funktioniert nicht:\n-  berprfen Sie, ob `STRIPE_WEBHOOK_SECRET` korrekt ist\n-  Testen Sie mit **Stripe CLI**: `stripe listen --forward-to localhost:5000/api/stripe/webhook`\n-  Logs prfen: `/tmp/logs/App_*.log`\n\n### Checkout schlgt fehl:\n-  berprfen Sie `STRIPE_PRICE_STARTER/PRO/ENTERPRISE` IDs\n-  Stellen Sie sicher, dass User eingeloggt ist\n-  Browser Console fr Fehler prfen\n\n### Subscription Status wird nicht aktualisiert:\n-  Webhook-Events in Stripe Dashboard prfen\n-  Server-Logs fr Fehler checken\n-  Datenbank berprfen: `SELECT * FROM users WHERE email = 'test@example.com';`\n\n## Support\n\nBei Problemen:\n1. Stripe Dashboard  Logs  Webhook attempts\n2. Server Logs: `/tmp/logs/App_*.log`\n3. Browser Console (F12)\n","size_bytes":4440},"client/src/pages/success.tsx":{"content":"import { useEffect } from 'react';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { CheckCircle } from 'lucide-react';\n\nexport default function Success() {\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    // Auto-redirect after 5 seconds\n    const timer = setTimeout(() => {\n      setLocation('/');\n    }, 5000);\n\n    return () => clearTimeout(timer);\n  }, [setLocation]);\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-emerald-100 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100\">\n            <CheckCircle className=\"h-10 w-10 text-green-600\" />\n          </div>\n          <CardTitle className=\"text-2xl font-bold\">Zahlung erfolgreich!</CardTitle>\n          <CardDescription>\n            Ihr Abonnement wurde erfolgreich aktiviert\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"text-center text-gray-600\">\n            <p>Vielen Dank fr Ihr Vertrauen!</p>\n            <p className=\"mt-2\">\n              Sie knnen jetzt alle Funktionen von PIMPilot nutzen.\n            </p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Button\n              className=\"w-full\"\n              onClick={() => setLocation('/')}\n            >\n              Zur Startseite\n            </Button>\n            <Button\n              className=\"w-full\"\n              variant=\"outline\"\n              onClick={() => setLocation('/account')}\n            >\n              Abo-Einstellungen\n            </Button>\n          </div>\n\n          <p className=\"text-sm text-gray-500 text-center\">\n            Sie werden automatisch weitergeleitet...\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2060},"client/src/components/subscription-badge.tsx":{"content":"import { Badge } from '@/components/ui/badge';\nimport { useAuth } from '@/lib/auth-context';\nimport { Crown } from 'lucide-react';\n\nexport function SubscriptionBadge() {\n  const { user } = useAuth();\n\n  if (!user || !user.planId) {\n    return null;\n  }\n\n  const planColors = {\n    starter: 'bg-gray-500',\n    pro: 'bg-blue-500',\n    enterprise: 'bg-purple-500',\n  } as const;\n\n  const planNames = {\n    starter: 'Starter',\n    pro: 'Pro',\n    enterprise: 'Enterprise',\n  } as const;\n\n  const planId = user.planId as keyof typeof planColors;\n  const color = planColors[planId] || 'bg-gray-500';\n  const name = planNames[planId] || user.planId;\n\n  return (\n    <Badge className={`${color} text-white flex items-center gap-1`}>\n      <Crown className=\"h-3 w-3\" />\n      {name}\n    </Badge>\n  );\n}\n","size_bytes":794},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, ReactNode, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { supabase } from './supabase';\n\ninterface User {\n  id: string;\n  email: string;\n  username?: string;\n  isAdmin: boolean;\n  tenantId?: string;\n  subscriptionStatus?: string;\n  planId?: string;\n  apiCallsUsed: number;\n  apiCallsLimit: number;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n  refetch: () => void;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  // Helper to get the correct storage based on rememberMe preference\n  const getTokenStorage = () => {\n    const saved = localStorage.getItem('rememberMe');\n    // Default to true if not set (matches login page default and DynamicStorage)\n    const rememberMe = saved === null ? true : saved === 'true';\n    return rememberMe ? localStorage : sessionStorage;\n  };\n\n  const { data, isLoading, refetch } = useQuery({\n    queryKey: ['/api/auth/user'],\n    queryFn: async () => {\n      // Check Supabase session first\n      const { data: { session }, error } = await supabase.auth.getSession();\n      \n      if (error || !session) {\n        // Remove token from both storages\n        localStorage.removeItem('supabase_token');\n        sessionStorage.removeItem('supabase_token');\n        return { user: null };\n      }\n\n      // Store token for API calls in the correct storage\n      const token = session.access_token;\n      const storage = getTokenStorage();\n      const otherStorage = storage === localStorage ? sessionStorage : localStorage;\n      \n      storage.setItem('supabase_token', token);\n      otherStorage.removeItem('supabase_token'); // Clean up other storage\n      \n      // Fetch user data from backend with tenant_id\n      const res = await fetch('/api/auth/user', { \n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      \n      if (!res.ok) {\n        // Remove token from both storages\n        localStorage.removeItem('supabase_token');\n        sessionStorage.removeItem('supabase_token');\n        return { user: null };\n      }\n      \n      return res.json();\n    },\n    retry: false,\n    refetchOnWindowFocus: false,\n  });\n\n  // Listen for auth changes\n  useEffect(() => {\n    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {\n      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {\n        if (session?.access_token) {\n          const storage = getTokenStorage();\n          const otherStorage = storage === localStorage ? sessionStorage : localStorage;\n          \n          storage.setItem('supabase_token', session.access_token);\n          otherStorage.removeItem('supabase_token'); // Clean up other storage\n          refetch();\n        }\n      } else if (event === 'SIGNED_OUT') {\n        // Remove token from both storages\n        localStorage.removeItem('supabase_token');\n        sessionStorage.removeItem('supabase_token');\n        refetch();\n      }\n    });\n\n    return () => subscription.unsubscribe();\n  }, [refetch]);\n\n  const value: AuthContextType = {\n    user: data?.user || null,\n    isLoading,\n    isAuthenticated: !!data?.user,\n    refetch,\n  };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within AuthProvider');\n  }\n  return context;\n}\n","size_bytes":3591},"client/src/components/admin-protected-route.tsx":{"content":"import { useAuth } from '@/lib/auth-context';\nimport { useLocation } from 'wouter';\nimport { useEffect } from 'react';\n\nexport function AdminProtectedRoute({ children }: { children: React.ReactNode }) {\n  const { user, isLoading } = useAuth();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation('/login');\n    } else if (!isLoading && user && !user.isAdmin) {\n      setLocation('/dashboard');\n    }\n  }, [user, isLoading, setLocation]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600\"></div>\n      </div>\n    );\n  }\n\n  if (!user || !user.isAdmin) {\n    return null;\n  }\n\n  return <>{children}</>;\n}\n","size_bytes":800},"server/create-admin.ts":{"content":"import { createAdminUser } from './supabase-auth';\n\nconst email = process.env.ADMIN_EMAIL;\nconst password = process.env.ADMIN_PASSWORD;\n\nif (!email || !password) {\n  console.error(' ADMIN_EMAIL and ADMIN_PASSWORD environment variables must be set');\n  console.error('Usage: ADMIN_EMAIL=admin@example.com ADMIN_PASSWORD=securepass npm run create-admin');\n  process.exit(1);\n}\n\ncreateAdminUser(email, password)\n  .then(() => {\n    console.log(' Admin user created successfully!');\n    console.log(`Email: ${email}`);\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(' Error creating admin user:', error.message);\n    process.exit(1);\n  });\n","size_bytes":664},"client/src/lib/api.ts":{"content":"export async function apiRequest(url: string, options: RequestInit = {}) {\n  // Try both localStorage and sessionStorage for token (depends on \"Remember Me\" setting)\n  const token = localStorage.getItem('supabase_token') || sessionStorage.getItem('supabase_token');\n  \n  const headers: Record<string, string> = {\n    ...(options.headers as Record<string, string> || {}),\n  };\n  \n  if (token) {\n    headers['Authorization'] = `Bearer ${token}`;\n  }\n  \n  // Set Content-Type for JSON requests (body is already stringified in apiPost/apiPut)\n  if (options.body && !(options.body instanceof FormData)) {\n    headers['Content-Type'] = 'application/json';\n  }\n  \n  const response = await fetch(url, {\n    ...options,\n    credentials: 'include', // Send cookies for session-based auth\n    headers,\n  });\n  \n  // Auto-logout on 401\n  if (response.status === 401) {\n    localStorage.removeItem('supabase_token');\n    sessionStorage.removeItem('supabase_token');\n    window.location.href = '/login';\n  }\n  \n  return response;\n}\n\nexport async function apiGet<T>(url: string): Promise<T> {\n  const response = await apiRequest(url);\n  if (!response.ok) throw new Error('Request failed');\n  return response.json();\n}\n\nexport async function apiPost<T>(url: string, data?: any): Promise<T> {\n  const response = await apiRequest(url, {\n    method: 'POST',\n    body: data instanceof FormData ? data : JSON.stringify(data),\n  });\n  if (!response.ok) throw new Error('Request failed');\n  return response.json();\n}\n\nexport async function apiPut<T>(url: string, data: any): Promise<T> {\n  const response = await apiRequest(url, {\n    method: 'PUT',\n    body: JSON.stringify(data),\n  });\n  if (!response.ok) throw new Error('Request failed');\n  return response.json();\n}\n\nexport async function apiDelete<T>(url: string): Promise<T> {\n  const response = await apiRequest(url, {\n    method: 'DELETE',\n  });\n  if (!response.ok) throw new Error('Request failed');\n  return response.json();\n}\n\nexport async function apiDownload(url: string, data: any, filename: string): Promise<void> {\n  const response = await apiRequest(url, {\n    method: 'POST',\n    body: JSON.stringify(data),\n  });\n  \n  if (!response.ok) throw new Error('Download failed');\n  \n  const blob = await response.blob();\n  const downloadUrl = window.URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = downloadUrl;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  window.URL.revokeObjectURL(downloadUrl);\n}\n","size_bytes":2546},"client/src/pages/admin-dashboard.tsx":{"content":"import { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog';\nimport { Label } from '@/components/ui/label';\nimport {\n  Users,\n  TrendingUp,\n  Building2,\n  Plus,\n  Search,\n  Crown,\n  Settings,\n  Package,\n  CheckCircle2,\n  Truck,\n  RefreshCcw,\n  Bot,\n  AlertCircle,\n  Trash2,\n  Database,\n  Shield,\n  FileText,\n} from 'lucide-react';\nimport { useState } from 'react';\nimport { useToast } from '@/hooks/use-toast';\nimport { Link } from 'wouter';\nimport { queryClient } from '@/lib/queryClient';\nimport { Switch } from '@/components/ui/switch';\nimport { Checkbox } from '@/components/ui/checkbox';\n\ninterface TenantSettings {\n  features: {\n    pixiIntegration: boolean;\n    sapIntegration: boolean;\n    urlScraper: boolean;\n    csvBulkImport: boolean;\n    aiDescriptions: boolean;\n  };\n  erp: {\n    type: string | null;\n  };\n}\n\ninterface Tenant {\n  id: string;\n  name: string;\n  slug: string;\n  settings: TenantSettings;\n  userCount: number;\n  projectCount: number;\n  supplierCount: number;\n  subscriptionStatus?: string;\n  planId?: string;\n  createdAt: string;\n}\n\ninterface TenantsData {\n  success: boolean;\n  tenants: Tenant[];\n}\n\ninterface KPIsData {\n  success: boolean;\n  kpis: {\n    totalProducts: number;\n    completenessPercentage: number;\n    suppliers: {\n      active: number;\n      successful: number;\n      error: number;\n    };\n    lastPixiSync: string;\n    aiTextsToday: number;\n  };\n}\n\nexport default function AdminDashboard() {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isSettingsDialogOpen, setIsSettingsDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isBulkDeleteDialogOpen, setIsBulkDeleteDialogOpen] = useState(false);\n  const [selectedTenant, setSelectedTenant] = useState<Tenant | null>(null);\n  const [tenantToDelete, setTenantToDelete] = useState<Tenant | null>(null);\n  const [selectedTenantIds, setSelectedTenantIds] = useState<string[]>([]);\n  const [newTenantName, setNewTenantName] = useState('');\n  const { toast } = useToast();\n\n  const { data, isLoading } = useQuery<TenantsData>({\n    queryKey: ['admin-tenants'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/admin/tenants', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        if (res.status === 403) {\n          throw new Error('Zugriff verweigert - nur fr Administratoren');\n        }\n        throw new Error('Failed to load tenants');\n      }\n      return res.json();\n    },\n  });\n\n  const { data: kpisData } = useQuery<KPIsData>({\n    queryKey: ['admin-kpis'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/admin/kpis', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) throw new Error('Failed to load KPIs');\n      return res.json();\n    },\n  });\n\n  const createTenantMutation = useMutation({\n    mutationFn: async (name: string) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/admin/tenants', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ name }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to create tenant');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Kunde angelegt',\n        description: `${newTenantName} wurde erfolgreich erstellt!`,\n      });\n      setIsCreateDialogOpen(false);\n      setNewTenantName('');\n      queryClient.invalidateQueries({ queryKey: ['admin-tenants'] });\n      queryClient.invalidateQueries({ queryKey: ['admin-kpis'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const updateTenantMutation = useMutation({\n    mutationFn: async ({ id, settings }: { id: string; settings: TenantSettings }) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/admin/tenants/${id}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ settings }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to update tenant');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Einstellungen gespeichert',\n        description: `Einstellungen fr ${selectedTenant?.name} wurden erfolgreich aktualisiert!`,\n      });\n      setIsSettingsDialogOpen(false);\n      setSelectedTenant(null);\n      queryClient.invalidateQueries({ queryKey: ['admin-tenants'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const deleteTenantMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/admin/tenants/${id}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to delete tenant');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Kunde gelscht',\n        description: `${tenantToDelete?.name} wurde erfolgreich gelscht!`,\n      });\n      setIsDeleteDialogOpen(false);\n      setTenantToDelete(null);\n      queryClient.invalidateQueries({ queryKey: ['admin-tenants'] });\n      queryClient.invalidateQueries({ queryKey: ['admin-kpis'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const deleteSelectedTenantsMutation = useMutation({\n    mutationFn: async (tenantIds: string[]) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/admin/tenants/bulk-delete', {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ tenantIds }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to delete selected tenants');\n      }\n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: 'Kunden gelscht',\n        description: `${data.deletedCount} Kunden wurden erfolgreich gelscht!`,\n      });\n      setIsBulkDeleteDialogOpen(false);\n      setSelectedTenantIds([]);\n      queryClient.invalidateQueries({ queryKey: ['admin-tenants'] });\n      queryClient.invalidateQueries({ queryKey: ['admin-kpis'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleOpenSettings = (tenant: Tenant) => {\n    const defaultSettings: TenantSettings = {\n      features: {\n        pixiIntegration: false,\n        sapIntegration: false,\n        urlScraper: true,\n        csvBulkImport: true,\n        aiDescriptions: true,\n      },\n      erp: {\n        type: null,\n      },\n    };\n\n    setSelectedTenant({\n      ...tenant,\n      settings: {\n        ...defaultSettings,\n        ...tenant.settings,\n        features: {\n          ...defaultSettings.features,\n          ...(tenant.settings?.features || {}),\n        },\n      },\n    });\n    setIsSettingsDialogOpen(true);\n  };\n\n  const handleToggleFeature = (feature: keyof TenantSettings['features']) => {\n    if (!selectedTenant) return;\n    \n    setSelectedTenant({\n      ...selectedTenant,\n      settings: {\n        ...selectedTenant.settings,\n        features: {\n          ...selectedTenant.settings.features,\n          [feature]: !selectedTenant.settings.features[feature],\n        },\n      },\n    });\n  };\n\n  const handleSaveSettings = () => {\n    if (!selectedTenant) return;\n    updateTenantMutation.mutate({\n      id: selectedTenant.id,\n      settings: selectedTenant.settings,\n    });\n  };\n\n  const tenants = data?.tenants || [];\n  const filteredTenants = tenants.filter(\n    (t) =>\n      t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      t.slug.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const handleToggleTenant = (tenantId: string) => {\n    setSelectedTenantIds(prev => \n      prev.includes(tenantId) \n        ? prev.filter(id => id !== tenantId)\n        : [...prev, tenantId]\n    );\n  };\n\n  const handleToggleAll = () => {\n    if (selectedTenantIds.length === filteredTenants.length) {\n      setSelectedTenantIds([]);\n    } else {\n      setSelectedTenantIds(filteredTenants.map(t => t.id));\n    }\n  };\n\n  const isAllSelected = filteredTenants.length > 0 && selectedTenantIds.length === filteredTenants.length;\n\n  const kpis = kpisData?.kpis;\n  const lastPixiSync = kpis?.lastPixiSync ? new Date(kpis.lastPixiSync) : null;\n\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-7xl\">\n      {/* Header */}\n      <div className=\"mb-8 flex items-center justify-between\">\n        <div>\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Crown className=\"h-8 w-8 text-amber-500\" />\n            <h1 className=\"text-4xl font-bold bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent\">\n              Admin Dashboard\n            </h1>\n          </div>\n          <p className=\"text-gray-600\">Systembersicht und Kundenverwaltung</p>\n        </div>\n        \n        <div className=\"flex gap-3\">\n          <Dialog open={isBulkDeleteDialogOpen} onOpenChange={setIsBulkDeleteDialogOpen}>\n            <DialogTrigger asChild>\n              <Button \n                size=\"lg\" \n                variant=\"destructive\" \n                className=\"gap-2\"\n                disabled={selectedTenantIds.length === 0}\n              >\n                <Trash2 className=\"h-5 w-5\" />\n                Ausgewhlte lschen ({selectedTenantIds.length})\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Ausgewhlte Kunden lschen?</DialogTitle>\n                <DialogDescription>\n                  Diese Aktion lscht die ausgewhlten Kunden unwiderruflich.\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"py-4\">\n                <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n                  <div className=\"flex items-start gap-3\">\n                    <AlertCircle className=\"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5\" />\n                    <div className=\"space-y-2\">\n                      <p className=\"font-semibold text-red-900\">\n                        Ausgewhlte Kunden: {selectedTenantIds.length}\n                      </p>\n                      <p className=\"text-sm text-red-800\">\n                        Alle Kundendaten (User, Projekte, Lieferanten) werden unwiderruflich gelscht.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setIsBulkDeleteDialogOpen(false)}\n                >\n                  Abbrechen\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  onClick={() => deleteSelectedTenantsMutation.mutate(selectedTenantIds)}\n                  disabled={deleteSelectedTenantsMutation.isPending}\n                >\n                  {deleteSelectedTenantsMutation.isPending ? 'Wird gelscht...' : `${selectedTenantIds.length} Kunden lschen`}\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n            <DialogTrigger asChild>\n              <Button size=\"lg\" className=\"gap-2\">\n                <Plus className=\"h-5 w-5\" />\n                Neuen Kunden anlegen\n              </Button>\n            </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Neuen Kunden anlegen</DialogTitle>\n              <DialogDescription>\n                Legen Sie einen neuen Mandanten (z.B. AkkuShop.de, Sport2000) fr Ihre SaaS-Plattform an.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"tenant-name\">Kundenname</Label>\n                <Input\n                  id=\"tenant-name\"\n                  placeholder=\"z.B. AkkuShop.de oder Sport2000\"\n                  value={newTenantName}\n                  onChange={(e) => setNewTenantName(e.target.value)}\n                />\n                <p className=\"text-xs text-gray-500\">\n                  Der Slug wird automatisch generiert (z.B. akkushop-de)\n                </p>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsCreateDialogOpen(false);\n                  setNewTenantName('');\n                }}\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={() => createTenantMutation.mutate(newTenantName)}\n                disabled={!newTenantName.trim() || createTenantMutation.isPending}\n              >\n                {createTenantMutation.isPending ? 'Wird erstellt...' : 'Kunde anlegen'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n\n      {/* Enterprise Security Features Navigation */}\n      <div className=\"mb-8\">\n        <div className=\"mb-4\">\n          <h2 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-indigo-600\" />\n            Enterprise-Sicherheits-Features\n          </h2>\n          <p className=\"text-sm text-gray-600 mt-1\">Verwalten Sie Backups, Berechtigungen und Audit-Logs</p>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <Link href=\"/admin/backups\">\n            <Card className=\"hover:shadow-lg transition-all cursor-pointer border-indigo-100 hover:border-indigo-300\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-indigo-700\">\n                  <Database className=\"h-5 w-5\" />\n                  Backup-Management\n                </CardTitle>\n                <CardDescription>\n                  Erstellen, wiederherstellen und verwalten Sie Daten-Backups mit Point-in-Time Recovery\n                </CardDescription>\n              </CardHeader>\n            </Card>\n          </Link>\n          <Link href=\"/admin/permissions\">\n            <Card className=\"hover:shadow-lg transition-all cursor-pointer border-purple-100 hover:border-purple-300\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-purple-700\">\n                  <Shield className=\"h-5 w-5\" />\n                  Berechtigungen (RBAC)\n                </CardTitle>\n                <CardDescription>\n                  Verwalten Sie Benutzer-Rollen und granulare Zugriffsrechte mit Scope-Kontrolle\n                </CardDescription>\n              </CardHeader>\n            </Card>\n          </Link>\n          <Link href=\"/admin/audit-logs\">\n            <Card className=\"hover:shadow-lg transition-all cursor-pointer border-amber-100 hover:border-amber-300\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-amber-700\">\n                  <FileText className=\"h-5 w-5\" />\n                  Audit-Logs\n                </CardTitle>\n                <CardDescription>\n                  berwachen Sie alle CRUD-Operationen mit detaillierten Change-Logs und Filterung\n                </CardDescription>\n              </CardHeader>\n            </Card>\n          </Link>\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600\"></div>\n        </div>\n      ) : (\n        <>\n          {/* KPI Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8\">\n            <Card className=\"border-blue-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Produkte im System</CardTitle>\n                <Package className=\"h-5 w-5 text-blue-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-blue-600\">\n                  {kpis?.totalProducts?.toLocaleString('de-DE') || 0}\n                </div>\n                <p className=\"text-xs text-gray-500 mt-1\">Gesamt-Produkte</p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-green-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Daten vollstndig</CardTitle>\n                <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-green-600\">\n                  {kpis?.completenessPercentage || 0}%\n                </div>\n                <p className=\"text-xs text-gray-500 mt-1\">Qualittsscore</p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-amber-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Lieferanten aktiv</CardTitle>\n                <Truck className=\"h-5 w-5 text-amber-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-amber-600\">{kpis?.suppliers.active || 0}</div>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <span className=\"text-xs text-green-600 flex items-center gap-1\">\n                    <CheckCircle2 className=\"h-3 w-3\" />\n                    {kpis?.suppliers.successful || 0} OK\n                  </span>\n                  {(kpis?.suppliers.error || 0) > 0 && (\n                    <span className=\"text-xs text-red-600 flex items-center gap-1\">\n                      <AlertCircle className=\"h-3 w-3\" />\n                      {kpis?.suppliers.error} Fehler\n                    </span>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-purple-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Letzter Pixi-Sync</CardTitle>\n                <RefreshCcw className=\"h-5 w-5 text-purple-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-lg font-bold text-purple-600\">\n                  {lastPixiSync ? lastPixiSync.toLocaleDateString('de-DE') : ''}\n                </div>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  {lastPixiSync ? lastPixiSync.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr' : 'Noch kein Sync'}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-indigo-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">KI-Texte heute</CardTitle>\n                <Bot className=\"h-5 w-5 text-indigo-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-indigo-600\">{kpis?.aiTextsToday || 0}</div>\n                <p className=\"text-xs text-gray-500 mt-1\">Generiert</p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Tenant Table */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"text-lg\">Kunden-bersicht</CardTitle>\n                  <CardDescription>Alle Mandanten mit Details und Statistiken</CardDescription>\n                </div>\n                <div className=\"relative w-64\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n                  <Input\n                    placeholder=\"Kunden suchen...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-10\"\n                  />\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"rounded-md border\">\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"bg-gray-50\">\n                      <TableHead className=\"w-12\">\n                        <Checkbox \n                          checked={isAllSelected}\n                          onCheckedChange={handleToggleAll}\n                        />\n                      </TableHead>\n                      <TableHead className=\"font-semibold\">Kundenname</TableHead>\n                      <TableHead className=\"font-semibold\">Slug</TableHead>\n                      <TableHead className=\"font-semibold\">Abo-Status</TableHead>\n                      <TableHead className=\"font-semibold text-right\">User</TableHead>\n                      <TableHead className=\"font-semibold text-right\">Projekte</TableHead>\n                      <TableHead className=\"font-semibold text-right\">Lieferanten</TableHead>\n                      <TableHead className=\"font-semibold\">Erstellt am</TableHead>\n                      <TableHead className=\"font-semibold\">Aktionen</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredTenants.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={9} className=\"text-center py-8 text-gray-500\">\n                          {searchQuery ? 'Keine Kunden gefunden' : 'Noch keine Kunden angelegt'}\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      filteredTenants.map((tenant) => (\n                        <TableRow key={tenant.id} className=\"hover:bg-gray-50\">\n                          <TableCell>\n                            <Checkbox \n                              checked={selectedTenantIds.includes(tenant.id)}\n                              onCheckedChange={() => handleToggleTenant(tenant.id)}\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <Building2 className=\"h-4 w-4 text-indigo-600\" />\n                              <div className=\"font-medium text-gray-900\">{tenant.name}</div>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\" className=\"bg-gray-50 text-gray-700 font-mono text-xs\">\n                              {tenant.slug}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            {tenant.subscriptionStatus === 'active' ? (\n                              <Badge className=\"bg-green-100 text-green-800 border-green-300\">\n                                <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                                {tenant.planId === 'professional' ? 'Professional' : tenant.planId === 'enterprise' ? 'Enterprise' : 'Aktiv'}\n                              </Badge>\n                            ) : tenant.subscriptionStatus === 'trial' ? (\n                              <Badge className=\"bg-blue-100 text-blue-800 border-blue-300\">\n                                <Crown className=\"h-3 w-3 mr-1\" />\n                                Trial\n                              </Badge>\n                            ) : (\n                              <Badge className=\"bg-gray-100 text-gray-800 border-gray-300\">\n                                <AlertCircle className=\"h-3 w-3 mr-1\" />\n                                {tenant.subscriptionStatus || 'Unbekannt'}\n                              </Badge>\n                            )}\n                          </TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            {tenant.userCount}\n                          </TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            {tenant.projectCount}\n                          </TableCell>\n                          <TableCell className=\"text-right font-medium\">\n                            {tenant.supplierCount}\n                          </TableCell>\n                          <TableCell className=\"text-sm text-gray-500\">\n                            {new Date(tenant.createdAt).toLocaleDateString('de-DE')}\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-8 w-8 p-0\"\n                                onClick={() => handleOpenSettings(tenant)}\n                              >\n                                <Settings className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50\"\n                                onClick={() => {\n                                  setTenantToDelete(tenant);\n                                  setIsDeleteDialogOpen(true);\n                                }}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            </CardContent>\n          </Card>\n        </>\n      )}\n\n      {/* Settings Dialog */}\n      <Dialog open={isSettingsDialogOpen} onOpenChange={setIsSettingsDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Settings className=\"h-5 w-5 text-indigo-600\" />\n              Einstellungen fr {selectedTenant?.name}\n            </DialogTitle>\n            <DialogDescription>\n              Konfigurieren Sie welche Features fr diesen Kunden verfgbar sind.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-6 py-4\">\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-semibold text-gray-700 uppercase tracking-wide\">\n                Feature-Flags\n              </h3>\n              \n              {/* Pixi Integration */}\n              <div className=\"flex items-center justify-between p-4 rounded-lg border bg-gray-50 hover:bg-gray-100 transition-colors\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium text-gray-900\">Pixi ERP Integration</div>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Automatischer Produktabgleich mit Pixi ERP System\n                  </p>\n                </div>\n                <Switch\n                  checked={selectedTenant?.settings.features.pixiIntegration || false}\n                  onCheckedChange={() => handleToggleFeature('pixiIntegration')}\n                />\n              </div>\n\n              {/* SAP Integration */}\n              <div className=\"flex items-center justify-between p-4 rounded-lg border bg-gray-50 hover:bg-gray-100 transition-colors\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium text-gray-900\">SAP Integration</div>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Anbindung an SAP-Systeme fr Datenimport/Export\n                  </p>\n                </div>\n                <Switch\n                  checked={selectedTenant?.settings.features.sapIntegration || false}\n                  onCheckedChange={() => handleToggleFeature('sapIntegration')}\n                />\n              </div>\n\n              {/* URL Scraper */}\n              <div className=\"flex items-center justify-between p-4 rounded-lg border bg-gray-50 hover:bg-gray-100 transition-colors\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium text-gray-900\">URL Web-Scraper</div>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Produktdaten von Lieferanten-Webseiten extrahieren\n                  </p>\n                </div>\n                <Switch\n                  checked={selectedTenant?.settings.features.urlScraper || false}\n                  onCheckedChange={() => handleToggleFeature('urlScraper')}\n                />\n              </div>\n\n              {/* CSV Bulk Import */}\n              <div className=\"flex items-center justify-between p-4 rounded-lg border bg-gray-50 hover:bg-gray-100 transition-colors\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium text-gray-900\">CSV Massenimport</div>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Groe Mengen an Produkten via CSV hochladen\n                  </p>\n                </div>\n                <Switch\n                  checked={selectedTenant?.settings.features.csvBulkImport || false}\n                  onCheckedChange={() => handleToggleFeature('csvBulkImport')}\n                />\n              </div>\n\n              {/* AI Descriptions */}\n              <div className=\"flex items-center justify-between p-4 rounded-lg border bg-gray-50 hover:bg-gray-100 transition-colors\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium text-gray-900\">KI-Produktbeschreibungen</div>\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    Automatische Generierung von Produkttexten mit GPT-4o-mini\n                  </p>\n                </div>\n                <Switch\n                  checked={selectedTenant?.settings.features.aiDescriptions || false}\n                  onCheckedChange={() => handleToggleFeature('aiDescriptions')}\n                />\n              </div>\n            </div>\n\n            {/* Summary */}\n            <div className=\"p-4 bg-indigo-50 border border-indigo-200 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"bg-indigo-600 text-white rounded p-1\">\n                  <Settings className=\"h-4 w-4\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h4 className=\"text-sm font-semibold text-indigo-900 mb-1\">\n                    Aktive Features\n                  </h4>\n                  <p className=\"text-xs text-indigo-700\">\n                    {Object.values(selectedTenant?.settings.features || {}).filter(Boolean).length} von 5 Features aktiviert\n                  </p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsSettingsDialogOpen(false);\n                setSelectedTenant(null);\n              }}\n            >\n              Abbrechen\n            </Button>\n            <Button\n              onClick={handleSaveSettings}\n              disabled={updateTenantMutation.isPending}\n              className=\"gap-2\"\n            >\n              {updateTenantMutation.isPending ? 'Wird gespeichert...' : 'Einstellungen speichern'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-red-600\">\n              <AlertCircle className=\"h-5 w-5\" />\n              Kunden lschen?\n            </DialogTitle>\n            <DialogDescription>\n              Mchten Sie den Kunden <span className=\"font-semibold text-gray-900\">{tenantToDelete?.name}</span> wirklich lschen?\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"py-4 space-y-3\">\n            <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg\">\n              <div className=\"flex items-start gap-3\">\n                <AlertCircle className=\"h-5 w-5 text-red-600 mt-0.5\" />\n                <div>\n                  <h4 className=\"text-sm font-semibold text-red-900 mb-1\">\n                    Achtung: Diese Aktion kann nicht rckgngig gemacht werden!\n                  </h4>\n                  <p className=\"text-xs text-red-700\">\n                    Alle Daten dieses Kunden (User, Projekte, Produkte, Lieferanten) werden unwiderruflich gelscht.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {tenantToDelete && (\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Anzahl User:</span>\n                  <span className=\"font-medium\">{tenantToDelete.userCount}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Anzahl Projekte:</span>\n                  <span className=\"font-medium\">{tenantToDelete.projectCount}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600\">Anzahl Lieferanten:</span>\n                  <span className=\"font-medium\">{tenantToDelete.supplierCount}</span>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsDeleteDialogOpen(false);\n                setTenantToDelete(null);\n              }}\n              disabled={deleteTenantMutation.isPending}\n            >\n              Abbrechen\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => {\n                if (tenantToDelete) {\n                  deleteTenantMutation.mutate(tenantToDelete.id);\n                }\n              }}\n              disabled={deleteTenantMutation.isPending}\n              className=\"gap-2\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n              {deleteTenantMutation.isPending ? 'Wird gelscht...' : 'Endgltig lschen'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":37043},"server/supabase-auth.ts":{"content":"import { supabase, supabaseAdmin } from './supabase';\nimport { supabaseStorage } from './supabase-storage';\nimport type { Request, Response, NextFunction } from 'express';\nimport type { User } from '@shared/schema';\n\nexport async function getSupabaseUser(accessToken: string): Promise<User | null> {\n  if (!supabaseAdmin) {\n    throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n  }\n\n  const { data: { user }, error } = await supabase.auth.getUser(accessToken);\n  \n  if (error || !user) return null;\n\n  // CRITICAL: Use supabaseStorage which queries Helium DB (local), not Supabase remote DB!\n  const userData = await supabaseStorage.getUserById(user.id);\n\n  if (!userData) {\n    console.error(`[getSupabaseUser] No user data found in Helium DB for id: ${user.id}`);\n    return null;\n  }\n\n  console.log(`[getSupabaseUser] User data from Helium DB:`, {\n    id: userData.id,\n    email: userData.email,\n    tenant_id: userData.tenantId,\n    role: userData.role,\n    is_admin: userData.isAdmin\n  });\n\n  return userData;\n}\n\nexport async function createAdminUser(email: string, password: string): Promise<void> {\n  if (!supabaseAdmin) {\n    throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n  }\n\n  const { data, error } = await supabaseAdmin.auth.admin.createUser({\n    email,\n    password,\n    email_confirm: true,\n  });\n\n  if (error) throw error;\n\n  const { data: akkushopTenant } = await supabaseAdmin\n    .from('tenants')\n    .select('id')\n    .eq('slug', 'akkushop')\n    .single();\n\n  if (!akkushopTenant) {\n    console.error('AkkuShop tenant not found for admin user');\n  }\n\n  const { error: insertError } = await supabaseAdmin\n    .from('users')\n    .upsert({\n      id: data.user.id,\n      email: email,\n      username: 'Admin',\n      is_admin: true,\n      role: 'admin',\n      tenant_id: akkushopTenant?.id,\n      subscription_status: 'trial',\n      plan_id: 'trial',\n      api_calls_limit: 50, // Trial limit: 50 calls per tool\n      api_calls_used: 0,\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    }, {\n      onConflict: 'id'\n    });\n\n  if (insertError) {\n    throw new Error(`Failed to create user record: ${insertError.message}`);\n  }\n\n  console.log(` Admin user created: ${email}`);\n}\n\nexport function supabaseAuthMiddleware(req: Request, res: Response, next: NextFunction) {\n  const authHeader = req.headers.authorization;\n  \n  if (!authHeader?.startsWith('Bearer ')) {\n    (req as any).user = null;\n    return next();\n  }\n\n  const token = authHeader.split(' ')[1];\n\n  getSupabaseUser(token)\n    .then(user => {\n      (req as any).user = user;\n      next();\n    })\n    .catch(() => {\n      (req as any).user = null;\n      next();\n    });\n}\n","size_bytes":2718},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Progress } from '@/components/ui/progress';\nimport { Button } from '@/components/ui/button';\nimport { useLocation } from 'wouter';\nimport {\n  BarChart,\n  FileText,\n  Package,\n  Zap,\n  Plus,\n  Upload,\n  Link as LinkIcon,\n  ArrowRight\n} from 'lucide-react';\n\ninterface DashboardStats {\n  projectCount: number;\n  productCount: number;\n  apiCallsUsed: number;\n  apiCallsLimit: number;\n  planId: string;\n  subscriptionStatus: string;\n}\n\ninterface Project {\n  id: string;\n  name: string;\n  createdAt: string;\n}\n\ninterface DashboardData {\n  stats: DashboardStats;\n  recentProjects: Project[];\n}\n\nexport default function Dashboard() {\n  const [, setLocation] = useLocation();\n\n  const { data, isLoading } = useQuery<{ success: boolean; stats: DashboardStats; recentProjects: Project[] }>({\n    queryKey: ['dashboard-stats'],\n    queryFn: async () => {\n      const res = await fetch('/api/dashboard/stats', {\n        credentials: 'include',\n      });\n      if (!res.ok) throw new Error('Failed to load dashboard stats');\n      return res.json();\n    },\n  });\n\n  const stats = data?.stats;\n  const recentProjects = data?.recentProjects || [];\n  const usagePercentage = stats ? (stats.apiCallsUsed / stats.apiCallsLimit) * 100 : 0;\n\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-7xl\">\n      {/* Header */}\n      <div className=\"mb-8\">\n        <h1 className=\"text-4xl font-bold bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent mb-2\">\n          Dashboard\n        </h1>\n        <p className=\"text-gray-600\">Willkommen zurck! Hier ist Ihre bersicht.</p>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600\"></div>\n        </div>\n      ) : (\n        <>\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\n            {/* Projects Card */}\n            <Card className=\"border-indigo-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Projekte</CardTitle>\n                <FileText className=\"h-4 w-4 text-indigo-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-indigo-600\">{stats?.projectCount || 0}</div>\n                <p className=\"text-xs text-gray-500 mt-1\">Gesamt erstellt</p>\n              </CardContent>\n            </Card>\n\n            {/* Products Card */}\n            <Card className=\"border-violet-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Produkte</CardTitle>\n                <Package className=\"h-4 w-4 text-violet-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-violet-600\">{stats?.productCount || 0}</div>\n                <p className=\"text-xs text-gray-500 mt-1\">Generierte Beschreibungen</p>\n              </CardContent>\n            </Card>\n\n            {/* API Usage Card */}\n            <Card className=\"border-indigo-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">AI-Generierungen</CardTitle>\n                <Zap className=\"h-4 w-4 text-indigo-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-indigo-600\">\n                  {stats?.apiCallsUsed || 0}\n                  <span className=\"text-lg text-gray-400\">/{stats?.apiCallsLimit || 500}</span>\n                </div>\n                <Progress value={usagePercentage} className=\"mt-2\" />\n                <p className=\"text-xs text-gray-500 mt-1\">{usagePercentage.toFixed(0)}% genutzt</p>\n              </CardContent>\n            </Card>\n\n            {/* Plan Card */}\n            <Card className=\"border-violet-100 hover:shadow-lg transition-shadow\">\n              <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n                <CardTitle className=\"text-sm font-medium text-gray-600\">Aktueller Plan</CardTitle>\n                <BarChart className=\"h-4 w-4 text-violet-600\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold capitalize text-violet-600\">\n                  {stats?.planId === 'trial' ? 'Trial' : stats?.planId || 'Free'}\n                </div>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  Status: {stats?.subscriptionStatus === 'active' ? 'Aktiv' : stats?.subscriptionStatus || 'Trial'}\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            {/* Quick Actions */}\n            <Card className=\"lg:col-span-1\">\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Schnellzugriff</CardTitle>\n                <CardDescription>Starten Sie direkt mit der Arbeit</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                <Button\n                  onClick={() => setLocation('/csv')}\n                  className=\"w-full justify-start bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700\"\n                >\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  CSV hochladen\n                </Button>\n                <Button\n                  onClick={() => setLocation('/creator')}\n                  variant=\"outline\"\n                  className=\"w-full justify-start border-indigo-200 hover:bg-indigo-50\"\n                >\n                  <LinkIcon className=\"h-4 w-4 mr-2\" />\n                  URL scrapen\n                </Button>\n                <Button\n                  onClick={() => setLocation('/projects')}\n                  variant=\"outline\"\n                  className=\"w-full justify-start border-violet-200 hover:bg-violet-50\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Neues Projekt\n                </Button>\n              </CardContent>\n            </Card>\n\n            {/* Recent Projects */}\n            <Card className=\"lg:col-span-2\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"text-lg\">Letzte Projekte</CardTitle>\n                    <CardDescription>Ihre zuletzt erstellten Projekte</CardDescription>\n                  </div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setLocation('/projects')}\n                    className=\"text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50\"\n                  >\n                    Alle anzeigen\n                    <ArrowRight className=\"h-4 w-4 ml-1\" />\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {recentProjects.length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <FileText className=\"h-12 w-12 text-gray-300 mx-auto mb-3\" />\n                    <p className=\"text-gray-500 mb-4\">Noch keine Projekte erstellt</p>\n                    <Button\n                      onClick={() => setLocation('/projects')}\n                      className=\"bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700\"\n                    >\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Erstes Projekt erstellen\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {recentProjects.map((project) => (\n                      <div\n                        key={project.id}\n                        className=\"flex items-center justify-between p-3 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50/30 transition-all cursor-pointer\"\n                        onClick={() => setLocation(`/projects/${project.id}`)}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"h-10 w-10 rounded-lg bg-gradient-to-br from-indigo-100 to-violet-100 flex items-center justify-center\">\n                            <FileText className=\"h-5 w-5 text-indigo-600\" />\n                          </div>\n                          <div>\n                            <p className=\"font-medium text-gray-900\">{project.name}</p>\n                            <p className=\"text-xs text-gray-500\">\n                              {new Date(project.createdAt).toLocaleDateString('de-DE')}\n                            </p>\n                          </div>\n                        </div>\n                        <ArrowRight className=\"h-4 w-4 text-gray-400\" />\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","size_bytes":9593},"server/supabase.ts":{"content":"import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = process.env.SUPABASE_URL!;\nconst supabaseAnonKey = process.env.SUPABASE_ANON_KEY!;\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables (SUPABASE_URL or SUPABASE_ANON_KEY)');\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\n\nexport const supabaseAdmin = supabaseServiceRoleKey\n  ? createClient(supabaseUrl, supabaseServiceRoleKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    })\n  : null;\n\nconsole.log('[Supabase] Admin client initialized:', !!supabaseAdmin);\n","size_bytes":719},"server/routes-supabase.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { supabase, supabaseAdmin } from './supabase';\nimport { supabaseStorage } from './supabase-storage';\nimport { createAdminUser, getSupabaseUser } from './supabase-auth';\nimport { registerUserSchema, loginUserSchema } from '@shared/schema';\nimport { db as heliumDb } from './db';\nimport { sql, eq, and, isNotNull } from 'drizzle-orm';\nimport { \n  productsInProjects as productsInProjectsTable, \n  suppliers as suppliersTable,\n  scrapeSession as scrapeSessionTable,\n  users as usersTable,\n  auditLogs as auditLogsTable,\n  backups as backupsTable,\n  permissions as permissionsTable,\n} from '@shared/schema';\nimport Stripe from 'stripe';\nimport { \n  createCheckoutSession, \n  createPortalSession, \n  handleWebhookEvent, \n  getSubscriptionStatus,\n  PLANS \n} from './stripe-service';\nimport multer from \"multer\";\nimport { analyzeCSV, generateProductDescription, convertTextToHTML, refineDescription, generateProductName, processProductWithNewWorkflow } from \"./ai-service\";\nimport { scrapeProduct, scrapeProductList, defaultSelectors, brickfoxSelectors, type ScraperSelectors, performLogin, testSelector } from \"./scraper-service\";\nimport { pixiService } from \"./services/pixi-service\";\nimport { mapProductsToBrickfox, brickfoxRowsToCSV } from \"./services/brickfox-mapper\";\nimport { enhanceProductsWithAI } from \"./services/brickfox-ai-enhancer\";\nimport { loadMappingsForSupplier, loadMappingsForProject } from \"./services/brickfox-mapping-loader\";\nimport Papa from \"papaparse\";\nimport { nanoid } from \"nanoid\";\nimport { createProjectSchema, createProductInProjectSchema, updateProductInProjectSchema } from \"@shared/schema\";\n\nconst upload = multer({ \n  storage: multer.memoryStorage(),\n  limits: {\n    fileSize: 10 * 1024 * 1024,\n    files: 10,\n  },\n  fileFilter: (req, file, cb) => {\n    const allowedTypes = [\n      'application/pdf',\n      'text/csv',\n      'image/jpeg',\n      'image/png',\n      'image/webp',\n    ];\n    if (allowedTypes.includes(file.mimetype) || file.originalname.endsWith('.csv')) {\n      cb(null, true);\n    } else {\n      cb(new Error(`Unsupported file type: ${file.mimetype}`));\n    }\n  },\n});\n\nimport { apiKeyManager } from './api-key-manager';\nimport { emailService } from './services/email-service';\nimport webhooksRouter from './webhooks-supabase';\nimport mappingRouter from './routes-mapping';\nimport { pdfParserService } from './services/pdf-parser';\n\nasync function requireAuth(req: any, res: any, next: any) {\n  const authHeader = req.headers.authorization;\n  \n  if (!authHeader?.startsWith('Bearer ')) {\n    return res.status(401).json({ error: 'Nicht authentifiziert' });\n  }\n\n  const token = authHeader.split(' ')[1];\n  const user = await getSupabaseUser(token);\n\n  if (!user) {\n    return res.status(401).json({ error: 'Ungltiges Token' });\n  }\n\n  req.user = user;\n  req.userId = user.id;\n  req.tenantId = user.tenantId || null;\n\n  // CRITICAL: Set tenant_id on the ACTUAL Drizzle database connection for RLS\n  if (user.tenantId) {\n    try {\n      const { pool } = await import('./db');\n      if (pool) {\n        const jwtClaims = JSON.stringify({\n          sub: user.id,\n          tenant_id: user.tenantId,\n          role: user.role || 'member',\n          user_role: user.role || 'member'\n        });\n        \n        // Set config on the PostgreSQL connection that Drizzle uses\n        await pool.query(\"SELECT set_config('request.jwt.claims', $1, true)\", [jwtClaims]);\n        console.log(`[RLS] Set tenant context for user ${user.email}: tenant_id=${user.tenantId}`);\n      }\n    } catch (error) {\n      console.error('[requireAuth] CRITICAL: Failed to set tenant context on DB connection:', error);\n      // Don't proceed without RLS context - this would allow cross-tenant access!\n      return res.status(500).json({ error: 'Fehler beim Setzen des Tenant-Kontexts' });\n    }\n  }\n\n  next();\n}\n\nasync function requireAdmin(req: any, res: any, next: any) {\n  await requireAuth(req, res, async () => {\n    if (!req.user?.isAdmin) {\n      return res.status(403).json({ error: 'Admin-Zugriff erforderlich' });\n    }\n    next();\n  });\n}\n\n// Super Admin check: Only for system-wide admin (sarahzerrer@icloud.com)\nasync function requireSuperAdmin(req: any, res: any, next: any) {\n  await requireAuth(req, res, async () => {\n    const isSuperAdmin = req.user?.email === 'sarahzerrer@icloud.com';\n    if (!isSuperAdmin) {\n      return res.status(403).json({ error: 'System-Admin-Zugriff erforderlich' });\n    }\n    next();\n  });\n}\n\n// Middleware: Check if tenant has a specific feature enabled\nfunction requireFeature(featureName: keyof NonNullable<import('@shared/schema').TenantSettings['features']>) {\n  return async (req: any, res: any, next: any) => {\n    if (!req.user?.tenantId) {\n      return res.status(401).json({ error: 'Nicht authentifiziert' });\n    }\n\n    const tenant = await supabaseStorage.getTenant(req.user.tenantId);\n    if (!tenant) {\n      return res.status(404).json({ error: 'Tenant nicht gefunden' });\n    }\n\n    const features = tenant.settings?.features || {};\n    const isEnabled = features[featureName];\n\n    // Default values: urlScraper, csvBulkImport, aiDescriptions are enabled by default\n    const defaultEnabled = ['urlScraper', 'csvBulkImport', 'aiDescriptions'];\n    const featureAllowed = defaultEnabled.includes(featureName) \n      ? isEnabled !== false  // Enabled unless explicitly disabled\n      : isEnabled === true;  // Disabled unless explicitly enabled\n\n    if (!featureAllowed) {\n      return res.status(403).json({ \n        error: `Feature \"${featureName}\" ist fr Ihren Account nicht freigeschaltet. Bitte upgraden Sie Ihr Abonnement.` \n      });\n    }\n\n    next();\n  };\n}\n\nasync function checkApiLimit(req: any, res: any, next: any) {\n  if (!req.user) {\n    return res.status(401).json({ error: 'Nicht authentifiziert' });\n  }\n\n  const user = await supabaseStorage.getUserById(req.user.id);\n  \n  if (!user) {\n    return res.status(404).json({ error: 'Benutzer nicht gefunden' });\n  }\n\n  if (user.apiCallsUsed >= user.apiCallsLimit) {\n    return res.status(429).json({ \n      error: 'API-Limit erreicht', \n      limit: user.apiCallsLimit,\n      used: user.apiCallsUsed \n    });\n  }\n\n  next();\n}\n\nasync function trackApiUsage(req: any, res: any, next: any) {\n  if (req.user) {\n    await supabaseStorage.incrementApiCalls(req.user.id);\n  }\n  next();\n}\n\n/**\n * Helper function to perform login if supplier has login credentials configured\n * Returns cookies to use for scraping requests\n */\nasync function getScrapingCookies(supplierId?: string, providedCookies?: string): Promise<string> {\n  // If cookies are already provided, use them\n  if (providedCookies) {\n    console.log('[getScrapingCookies] Using provided cookies');\n    return providedCookies;\n  }\n\n  // If no supplier ID, return empty cookies\n  if (!supplierId) {\n    console.log('[getScrapingCookies] No supplier ID, returning empty cookies');\n    return '';\n  }\n\n  console.log(`[getScrapingCookies] Looking for supplier with ID: ${supplierId}`);\n\n  // SECURITY: Fetch supplier data with decrypted credentials (internal use only)\n  const supplier = await supabaseStorage.getSupplierWithCredentials(supplierId);\n  if (!supplier) {\n    console.log(`[getScrapingCookies] Supplier not found for ID: ${supplierId}`);\n    return '';\n  }\n  \n  console.log(`[getScrapingCookies] Found supplier: ${supplier.name}`);\n\n  // Check if supplier has login credentials configured\n  if (!supplier.loginUrl || !supplier.loginUsernameField || !supplier.loginPasswordField || \n      !supplier.loginUsername || !supplier.loginPassword) {\n    console.log('[getScrapingCookies] Supplier has no login credentials configured');\n    return supplier.sessionCookies || '';\n  }\n\n  // Perform login and get cookies\n  try {\n    console.log(`[getScrapingCookies] Performing login for supplier ${supplier.name}`);\n    const cookies = await performLogin({\n      loginUrl: supplier.loginUrl,\n      usernameField: supplier.loginUsernameField,\n      passwordField: supplier.loginPasswordField,\n      username: supplier.loginUsername,\n      password: supplier.loginPassword,\n      userAgent: supplier.userAgent\n    });\n\n    // Optionally update supplier with session cookies for future use\n    if (cookies) {\n      await supabaseStorage.updateSupplier(supplierId, { sessionCookies: cookies });\n      console.log(`[getScrapingCookies] Updated supplier session cookies`);\n    }\n\n    return cookies;\n  } catch (error) {\n    console.error('[getScrapingCookies] Login failed:', error);\n    // Fallback to stored session cookies if login fails\n    return supplier.sessionCookies || '';\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Contact Form Endpoint\n  app.post('/api/contact', async (req, res) => {\n    try {\n      const { name, company, email, phone, message } = req.body;\n\n      if (!name || !email || !message) {\n        return res.status(400).json({ error: 'Name, E-Mail und Nachricht sind erforderlich' });\n      }\n\n      // Send email to support/admin\n      const smtpFrom = process.env.SMTP_FROM || 'noreply@pimpilot.com';\n      const adminEmail = process.env.SMTP_USER; // Admin gets the contact form\n\n      if (!adminEmail) {\n        console.warn(' SMTP_USER not configured, cannot send contact form email');\n        return res.status(500).json({ error: 'E-Mail-Service nicht konfiguriert' });\n      }\n\n      // Prepare email body\n      const emailBody = `\nNeue Kontaktanfrage von PIMPilot Website\n==========================================\n\nName: ${name}\n${company ? `Firma: ${company}` : ''}\nE-Mail: ${email}\n${phone ? `Telefon: ${phone}` : ''}\n\nNachricht:\n${message}\n\n==========================================\nGesendet am: ${new Date().toLocaleString('de-DE')}\n`;\n\n      // Use the email service's transporter directly\n      const transporter = (emailService as any).transporter;\n      \n      if (!transporter) {\n        return res.status(500).json({ error: 'E-Mail-Service nicht verfgbar' });\n      }\n\n      await transporter.sendMail({\n        from: smtpFrom,\n        to: adminEmail,\n        replyTo: email,\n        subject: `PIMPilot Kontaktanfrage von ${name}`,\n        text: emailBody,\n      });\n\n      console.log(` Contact form submitted by ${name} (${email})`);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(' Contact form error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Senden der Nachricht' });\n    }\n  });\n\n  app.post('/api/auth/register', async (req, res) => {\n    try {\n      const validatedData = registerUserSchema.parse(req.body);\n      \n      if (!supabaseAdmin) {\n        return res.status(500).json({ error: 'Server-Konfigurationsfehler' });\n      }\n\n      // Step 1: Create new tenant for this company\n      // Generate slug with proper German umlaut handling\n      let tenantSlug = validatedData.companyName\n        .toLowerCase()\n        .replace(//g, 'ae')\n        .replace(//g, 'oe')\n        .replace(//g, 'ue')\n        .replace(//g, 'ss')\n        .normalize('NFD') // Decompose remaining combined characters\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove combining diacritical marks\n        .replace(/[^a-z0-9]+/g, '-') // Replace special chars with dashes\n        .replace(/^-+|-+$/g, '') // Remove leading/trailing dashes\n        .replace(/--+/g, '-'); // Collapse multiple dashes\n\n      // Ensure non-empty slug (fallback to \"company\" if empty)\n      if (!tenantSlug || tenantSlug.length === 0) {\n        tenantSlug = 'company';\n      }\n\n      // Handle slug collisions by appending a number\n      let finalSlug = tenantSlug;\n      let counter = 2;\n      let slugExists = true;\n      \n      while (slugExists) {\n        const existing = await supabaseStorage.getTenantBySlug(finalSlug);\n        if (!existing) {\n          slugExists = false;\n        } else {\n          finalSlug = `${tenantSlug}-${counter}`;\n          counter++;\n        }\n      }\n\n      console.log(`[Register] Creating tenant: ${validatedData.companyName} (slug: ${finalSlug})`);\n\n      const newTenant = await supabaseStorage.createTenant({\n        name: validatedData.companyName,\n        slug: finalSlug,\n        settings: {\n          default_categories: ['battery', 'charger', 'tool', 'gps', 'drone', 'camera'],\n          mediamarkt_title_format: 'Kategorie + Artikelnummer'\n        }\n      });\n\n      console.log(`[Register] Tenant created: ${newTenant.id}`);\n\n      // Step 2: Create user in Supabase Auth with tenant_id in metadata\n      const { data, error } = await supabaseAdmin.auth.admin.createUser({\n        email: validatedData.email,\n        password: validatedData.password,\n        email_confirm: true,\n        user_metadata: {\n          username: validatedData.username || validatedData.email.split('@')[0],\n          tenant_id: newTenant.id,\n          company_name: validatedData.companyName,\n        }\n      });\n\n      if (error) {\n        return res.status(400).json({ error: error.message });\n      }\n\n      if (!data.user) {\n        return res.status(400).json({ error: 'Registrierung fehlgeschlagen' });\n      }\n\n      // User created successfully in Supabase Auth\n      console.log(`[Register] User created in Supabase Auth: ${validatedData.email}`);\n      console.log(`[Register] User assigned to tenant: ${newTenant.id} (${validatedData.companyName})`);\n      \n      // Insert user directly into Helium DB (don't wait for webhook)\n      // First user of tenant becomes admin\n      await heliumDb.insert(usersTable).values({\n        id: data.user.id,\n        email: validatedData.email,\n        username: validatedData.username || validatedData.email.split('@')[0],\n        tenantId: newTenant.id,\n        isAdmin: true, // First user is always admin\n        role: 'admin',\n        subscriptionStatus: 'trial',\n        planId: 'trial',\n        apiCallsLimit: 50,\n        apiCallsUsed: 0,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      });\n      \n      console.log(` [Register] User ${validatedData.email} created in Helium DB (admin role)`);\n\n      const { data: sessionData } = await supabase.auth.signInWithPassword({\n        email: validatedData.email,\n        password: validatedData.password,\n      });\n\n      const user = await supabaseStorage.getUserById(data.user.id);\n\n      res.json({ \n        user, \n        session: sessionData.session,\n        access_token: sessionData.session?.access_token \n      });\n    } catch (error: any) {\n      res.status(400).json({ error: error.message || 'Ungltige Registrierungsdaten' });\n    }\n  });\n\n  app.post('/api/auth/login', async (req, res) => {\n    try {\n      loginUserSchema.parse(req.body);\n      \n      let emailToUse = req.body.email;\n      \n      console.log(`[LOGIN] Input: \"${emailToUse}\", contains @: ${emailToUse.includes('@')}`);\n      \n      if (!emailToUse.includes('@')) {\n        console.log(`[LOGIN] Looking up username: \"${emailToUse}\"`);\n        const userByUsername = await supabaseStorage.getUserByUsername(emailToUse);\n        console.log(`[LOGIN] Username lookup result:`, userByUsername ? `Found: ${userByUsername.email}` : 'Not found');\n        if (userByUsername) {\n          emailToUse = userByUsername.email;\n        } else {\n          console.log(`[LOGIN]  Username \"${emailToUse}\" not found in database`);\n        }\n      }\n      \n      console.log(`[LOGIN] Attempting Supabase auth with email: \"${emailToUse}\"`);\n      const { data, error } = await supabase.auth.signInWithPassword({\n        email: emailToUse,\n        password: req.body.password,\n      });\n\n      if (error || !data.user) {\n        console.log(`[LOGIN]  Supabase auth failed:`, error?.message || 'No user returned');\n        return res.status(401).json({ error: 'Ungltiger Benutzername/E-Mail oder Passwort' });\n      }\n\n      let user = await supabaseStorage.getUserById(data.user.id);\n\n      // AUTO-FIX: If user doesn't exist in Helium DB, create it\n      if (!user && data.user.email) {\n        console.log(` [LOGIN AUTO-FIX] User ${data.user.email} exists in Supabase Auth but not in Helium DB. Creating...`);\n        \n        // Get or create AkkuShop tenant (fallback for legacy users)\n        const { data: akkushopTenant } = await supabaseAdmin!\n          .from('tenants')\n          .select('id')\n          .eq('slug', 'akkushop')\n          .single();\n        \n        if (akkushopTenant) {\n          const { error: insertError } = await supabaseAdmin!\n            .from('users')\n            .insert({\n              id: data.user.id,\n              email: data.user.email,\n              username: data.user.email.split('@')[0],\n              is_admin: false, // Regular user\n              role: 'member',\n              tenant_id: akkushopTenant.id,\n              subscription_status: 'trial',\n              plan_id: 'trial',\n              api_calls_limit: 50,\n              api_calls_used: 0,\n              created_at: new Date().toISOString(),\n              updated_at: new Date().toISOString(),\n            });\n          \n          if (insertError) {\n            console.error(` Failed to create user in Helium DB:`, insertError);\n          } else {\n            console.log(` User ${data.user.email} created in Helium DB`);\n            user = await supabaseStorage.getUserById(data.user.id);\n          }\n        }\n      }\n\n      // AUTO-FIX: Update old limit to new standard (50 calls)\n      if (user && user.apiCallsLimit < 50) {\n        console.log(` Auto-updating ${user.email} to 50 credits (Trial Standard)`);\n        await supabaseAdmin!\n          .from('users')\n          .update({ api_calls_limit: 50 })\n          .eq('id', user.id);\n        \n        // Refresh user data\n        user = await supabaseStorage.getUserById(data.user.id);\n      }\n\n      res.json({ \n        user,\n        session: data.session,\n        access_token: data.session?.access_token\n      });\n    } catch (error) {\n      res.status(400).json({ error: 'Ungltige Login-Daten' });\n    }\n  });\n\n  app.post('/api/auth/logout', async (req, res) => {\n    const authHeader = req.headers.authorization;\n    if (authHeader?.startsWith('Bearer ')) {\n      const token = authHeader.split(' ')[1];\n      await supabase.auth.signOut();\n    }\n    res.json({ success: true });\n  });\n\n  app.get('/api/auth/user', async (req, res) => {\n    const authHeader = req.headers.authorization;\n    \n    if (!authHeader?.startsWith('Bearer ')) {\n      return res.status(401).json({ error: 'Nicht authentifiziert' });\n    }\n\n    const token = authHeader.split(' ')[1];\n    const user = await getSupabaseUser(token);\n\n    if (!user) {\n      return res.status(401).json({ error: 'Ungltige Session' });\n    }\n\n    res.json({ user });\n  });\n\n  // Get current user's tenant (for both admins and regular users)\n  app.get('/api/user/tenant', requireAuth, async (req: any, res) => {\n    try {\n      if (!req.user.tenantId) {\n        return res.json({ tenant: null });\n      }\n\n      const tenant = await supabaseStorage.getTenant(req.user.tenantId);\n      \n      if (!tenant) {\n        return res.status(404).json({ error: 'Tenant nicht gefunden' });\n      }\n\n      const stats = await supabaseStorage.getTenantStats(tenant.id);\n      \n      res.json({\n        tenant: {\n          ...tenant,\n          ...stats,\n        },\n      });\n    } catch (error: any) {\n      console.error('Get user tenant error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Laden des Tenants' });\n    }\n  });\n\n  // Temporary: Update current user's API limit to 3000\n  app.post('/api/auth/update-my-limit', requireAuth, async (req: any, res) => {\n    try {\n      const user = req.user;\n      \n      const { error } = await supabaseAdmin!\n        .from('users')\n        .update({ \n          api_calls_limit: 50,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', user.id);\n\n      if (error) throw error;\n\n      console.log(` Updated user ${user.email} limit from 100 to 3000`);\n      \n      res.json({ \n        success: true, \n        message: 'Dein API-Limit wurde auf 3.000 erhht (GPT-4o-mini)',\n        oldLimit: 100,\n        newLimit: 3000\n      });\n    } catch (error: any) {\n      console.error('Update limit error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get('/api/dashboard/stats', requireAuth, async (req: any, res) => {\n    try {\n      const user = req.user;\n      \n      const projects = await supabaseStorage.getProjectsByUserId(user.id);\n      \n      let totalProducts = 0;\n      for (const project of projects) {\n        const products = await supabaseStorage.getProducts(project.id);\n        totalProducts += products.length;\n      }\n      \n      const freshUser = await supabaseStorage.getUserById(user.id);\n      \n      res.json({\n        success: true,\n        stats: {\n          projectCount: projects.length,\n          productCount: totalProducts,\n          apiCallsUsed: freshUser?.apiCallsUsed || 0,\n          apiCallsLimit: freshUser?.apiCallsLimit || 50,\n          planId: freshUser?.planId || 'trial',\n          subscriptionStatus: freshUser?.subscriptionStatus || 'trial',\n        },\n        recentProjects: projects.slice(0, 5),\n      });\n    } catch (error) {\n      console.error('Dashboard stats error:', error);\n      res.status(500).json({ error: 'Fehler beim Laden der Dashboard-Daten' });\n    }\n  });\n\n  app.get('/api/admin/customers', requireSuperAdmin, async (req, res) => {\n    try {\n      const users = await supabaseStorage.getAllUsers();\n      \n      const customersWithStats = await Promise.all(\n        users.map(async (user) => {\n          const projects = await supabaseStorage.getProjectsByUserId(user.id);\n          let totalProducts = 0;\n          for (const project of projects) {\n            const products = await supabaseStorage.getProducts(project.id);\n            totalProducts += products.length;\n          }\n          \n          return {\n            ...user,\n            projectCount: projects.length,\n            productCount: totalProducts,\n          };\n        })\n      );\n      \n      res.json({\n        success: true,\n        customers: customersWithStats,\n      });\n    } catch (error) {\n      console.error('Admin customers error:', error);\n      res.status(500).json({ error: 'Fehler beim Laden der Kundendaten' });\n    }\n  });\n\n  app.get('/api/admin/users', requireSuperAdmin, async (req, res) => {\n    try {\n      const users = await supabaseStorage.getAllUsers();\n      res.json(users);\n    } catch (error) {\n      res.status(500).json({ error: 'Fehler beim Laden der Benutzer' });\n    }\n  });\n\n  // Initial Admin Setup - nur wenn noch KEIN Admin existiert\n  app.post('/api/admin/initial-setup', async (req, res) => {\n    try {\n      const { email, password, username } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ error: 'E-Mail und Passwort erforderlich' });\n      }\n\n      // Check if any admin already exists\n      const existingAdmins = await heliumDb.select()\n        .from(usersTable)\n        .where(eq(usersTable.isAdmin, true))\n        .limit(1);\n\n      if (existingAdmins.length > 0) {\n        return res.status(403).json({ error: 'Admin-Benutzer existiert bereits' });\n      }\n\n      // Create the first admin user with custom username\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { data, error } = await supabaseAdmin.auth.admin.createUser({\n        email,\n        password,\n        email_confirm: true,\n      });\n\n      if (error) throw error;\n\n      const { data: akkushopTenant } = await supabaseAdmin\n        .from('tenants')\n        .select('id')\n        .eq('slug', 'akkushop')\n        .single();\n\n      if (!akkushopTenant) {\n        console.error('AkkuShop tenant not found for admin user');\n      }\n\n      const { error: insertError } = await supabaseAdmin\n        .from('users')\n        .upsert({\n          id: data.user.id,\n          email: email,\n          username: username || 'Admin',\n          is_admin: true,\n          role: 'admin',\n          tenant_id: akkushopTenant?.id,\n          subscription_status: 'trial',\n          plan_id: 'trial',\n          api_calls_limit: 999999, // Admin: unlimited\n          api_calls_used: 0,\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n        }, {\n          onConflict: 'id'\n        });\n\n      if (insertError) {\n        throw new Error(`Failed to create user record: ${insertError.message}`);\n      }\n\n      console.log(` Initial Admin user created: ${email} (Username: ${username || 'Admin'})`);\n      res.json({ success: true, message: `Admin-Benutzer erstellt: ${username || 'Admin'}` });\n    } catch (error: any) {\n      console.error('Initial admin setup error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post('/api/admin/create-admin', requireSuperAdmin, async (req, res) => {\n    try {\n      const { email, password } = req.body;\n      \n      if (!email || !password) {\n        return res.status(400).json({ error: 'E-Mail und Passwort erforderlich' });\n      }\n\n      await createAdminUser(email, password);\n      res.json({ success: true, message: 'Admin-Benutzer erstellt' });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Tenant Management Endpoints (Admin only)\n  // Get user's own tenant (for regular customers)\n  app.get('/api/user/tenant', requireAuth, async (req: any, res) => {\n    try {\n      const user = req.user; // Already set by requireAuth middleware\n      if (!user || !user.tenantId) {\n        return res.status(401).json({ error: 'Nicht authentifiziert' });\n      }\n\n      const tenant = await supabaseStorage.getTenant(user.tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: 'Tenant nicht gefunden' });\n      }\n\n      const stats = await supabaseStorage.getTenantStats(tenant.id);\n\n      res.json({\n        success: true,\n        tenant: {\n          ...tenant,\n          ...stats,\n        },\n      });\n    } catch (error) {\n      console.error('Get user tenant error:', error);\n      res.status(500).json({ error: 'Fehler beim Laden des Tenants' });\n    }\n  });\n\n  app.get('/api/admin/tenants', requireSuperAdmin, async (req, res) => {\n    try {\n      const tenants = await supabaseStorage.getAllTenants();\n      \n      // Get stats for each tenant\n      const tenantsWithStats = await Promise.all(\n        tenants.map(async (tenant) => {\n          const stats = await supabaseStorage.getTenantStats(tenant.id);\n          return {\n            ...tenant,\n            ...stats,\n          };\n        })\n      );\n      \n      res.json({\n        success: true,\n        tenants: tenantsWithStats,\n      });\n    } catch (error) {\n      console.error('Admin tenants error:', error);\n      res.status(500).json({ error: 'Fehler beim Laden der Tenants' });\n    }\n  });\n\n  app.post('/api/admin/tenants', requireSuperAdmin, async (req, res) => {\n    try {\n      const { name, settings } = req.body;\n      \n      if (!name) {\n        return res.status(400).json({ error: 'Tenant-Name erforderlich' });\n      }\n\n      const tenant = await supabaseStorage.createTenant({ name, settings });\n      const stats = await supabaseStorage.getTenantStats(tenant.id);\n      \n      res.json({\n        success: true,\n        tenant: {\n          ...tenant,\n          ...stats,\n        },\n      });\n    } catch (error: any) {\n      console.error('Create tenant error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Erstellen des Tenants' });\n    }\n  });\n\n  // Bulk delete selected tenants (MUST be before /:id route!)\n  app.delete('/api/admin/tenants/bulk-delete', requireSuperAdmin, async (req, res) => {\n    try {\n      const currentUser = (req as any).user;\n      if (!currentUser) {\n        return res.status(401).json({ error: 'Nicht authentifiziert' });\n      }\n\n      const { tenantIds } = req.body;\n\n      if (!tenantIds || !Array.isArray(tenantIds) || tenantIds.length === 0) {\n        return res.status(400).json({ error: 'Keine Tenant-IDs angegeben' });\n      }\n\n      // Prevent deleting super-admin's own tenant\n      const tenantsToDelete = tenantIds.filter(id => id !== currentUser.tenant_id);\n\n      let deletedCount = 0;\n      for (const tenantId of tenantsToDelete) {\n        const success = await supabaseStorage.deleteTenant(tenantId);\n        if (success) {\n          deletedCount++;\n        }\n      }\n\n      res.json({\n        success: true,\n        deletedCount,\n        message: `${deletedCount} Kunden wurden gelscht`,\n      });\n    } catch (error: any) {\n      console.error('Bulk delete tenants error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Lschen der Tenants' });\n    }\n  });\n\n  app.delete('/api/admin/tenants/:id', requireSuperAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const success = await supabaseStorage.deleteTenant(id);\n      \n      if (!success) {\n        return res.status(404).json({ error: 'Tenant nicht gefunden oder konnte nicht gelscht werden' });\n      }\n      \n      res.json({\n        success: true,\n        message: 'Tenant erfolgreich gelscht',\n      });\n    } catch (error: any) {\n      console.error('Delete tenant error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Lschen des Tenants' });\n    }\n  });\n\n  app.patch('/api/admin/tenants/:id', requireSuperAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { name, settings } = req.body;\n      \n      const tenant = await supabaseStorage.updateTenant(id, { name, settings });\n      \n      if (!tenant) {\n        return res.status(404).json({ error: 'Tenant nicht gefunden' });\n      }\n\n      const stats = await supabaseStorage.getTenantStats(tenant.id);\n      \n      res.json({\n        success: true,\n        tenant: {\n          ...tenant,\n          ...stats,\n        },\n      });\n    } catch (error: any) {\n      console.error('Update tenant error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Aktualisieren des Tenants' });\n    }\n  });\n\n  // Admin KPIs Dashboard Endpoint\n  app.get('/api/admin/kpis', requireSuperAdmin, async (req, res) => {\n    try {\n      const tenantId = req.query.tenantId as string | undefined;\n      \n      // Get total products (mandantenbergreifend or filtered)\n      const productsQuery = heliumDb\n        .select({ count: sql<number>`count(*)::int` })\n        .from(productsInProjectsTable);\n      \n      if (tenantId) {\n        productsQuery.where(eq(productsInProjectsTable.tenantId, tenantId));\n      }\n      \n      const [{ count: totalProducts }] = await productsQuery;\n      \n      // Get data completeness (Produkte mit allen Pflichtfeldern)\n      const completeProductsQuery = heliumDb\n        .select({ count: sql<number>`count(*)::int` })\n        .from(productsInProjectsTable)\n        .where(\n          and(\n            isNotNull(productsInProjectsTable.name),\n            isNotNull(productsInProjectsTable.articleNumber),\n            isNotNull(productsInProjectsTable.extractedData),\n            tenantId ? eq(productsInProjectsTable.tenantId, tenantId) : undefined\n          )\n        );\n      \n      const [{ count: completeProducts }] = await completeProductsQuery;\n      const completenessPercentage = totalProducts > 0 \n        ? Math.round((completeProducts / totalProducts) * 100) \n        : 0;\n      \n      // Get supplier stats\n      const suppliersQuery = heliumDb\n        .select({\n          id: suppliersTable.id,\n          name: suppliersTable.name,\n          lastVerifiedAt: suppliersTable.lastVerifiedAt,\n        })\n        .from(suppliersTable);\n      \n      if (tenantId) {\n        suppliersQuery.where(eq(suppliersTable.tenantId, tenantId));\n      }\n      \n      const suppliers = await suppliersQuery;\n      const activeSuppliers = suppliers.length;\n      const successfulSuppliers = suppliers.filter((s: any) => s.lastVerifiedAt).length;\n      const errorSuppliers = activeSuppliers - successfulSuppliers;\n      \n      // Get last Pixi sync from latest successful comparison\n      const lastPixiSync = new Date(); // Placeholder - real tracking would query scrape_sessions or pixi_comparisons table\n      \n      // Get AI texts generated today\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      \n      const aiTextsQuery = heliumDb\n        .select({ count: sql<number>`count(*)::int` })\n        .from(scrapeSessionTable)\n        .where(\n          and(\n            isNotNull(scrapeSessionTable.generatedDescription),\n            sql`${scrapeSessionTable.createdAt} >= ${today}`,\n            tenantId ? eq(scrapeSessionTable.tenantId, tenantId) : undefined\n          )\n        );\n      \n      const [{ count: aiTextsToday }] = await aiTextsQuery;\n      \n      res.json({\n        success: true,\n        kpis: {\n          totalProducts,\n          completenessPercentage,\n          suppliers: {\n            active: activeSuppliers,\n            successful: successfulSuppliers,\n            error: errorSuppliers,\n          },\n          lastPixiSync: lastPixiSync.toISOString(),\n          aiTextsToday,\n        },\n      });\n    } catch (error: any) {\n      console.error('Admin KPIs error:', error);\n      res.status(500).json({ error: error.message || 'Fehler beim Laden der KPIs' });\n    }\n  });\n\n  app.get('/api/projects', requireAuth, async (req: any, res) => {\n    try {\n      const projects = await supabaseStorage.getProjectsByUserId(req.user.id);\n      res.json({ success: true, projects });\n    } catch (error) {\n      res.status(500).json({ error: 'Fehler beim Laden der Projekte' });\n    }\n  });\n\n  app.post('/api/projects', requireAuth, async (req: any, res) => {\n    try {\n      console.log('[POST /api/projects] Request body:', JSON.stringify(req.body, null, 2));\n      const data = createProjectSchema.parse(req.body);\n      const project = await supabaseStorage.createProject(req.user.id, data);\n      res.json(project);\n    } catch (error: any) {\n      console.error('[POST /api/projects] Error:', error);\n      res.status(400).json({ error: 'Ungltige Projektdaten', details: error.message });\n    }\n  });\n\n  app.get('/api/projects/:id', requireAuth, async (req: any, res) => {\n    try {\n      const project = await supabaseStorage.getProject(req.params.id, req.user.id);\n      if (!project) {\n        return res.status(404).json({ error: 'Projekt nicht gefunden' });\n      }\n      res.json(project);\n    } catch (error) {\n      res.status(500).json({ error: 'Fehler beim Laden des Projekts' });\n    }\n  });\n\n  app.delete('/api/projects/:id', requireAuth, async (req: any, res) => {\n    try {\n      const success = await supabaseStorage.deleteProject(req.params.id, req.user.id);\n      if (!success) {\n        return res.status(404).json({ error: 'Projekt nicht gefunden' });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: 'Fehler beim Lschen des Projekts' });\n    }\n  });\n\n  app.get('/api/projects/:projectId/products', requireAuth, async (req: any, res) => {\n    try {\n      const products = await supabaseStorage.getProducts(req.params.projectId, req.user.id);\n      console.log(`[GET /products] Project ${req.params.projectId}: Found ${products.length} products`);\n      res.json({ success: true, products });\n    } catch (error) {\n      res.status(500).json({ error: 'Fehler beim Laden der Produkte' });\n    }\n  });\n\n  app.post('/api/projects/:projectId/products', requireAuth, checkApiLimit, async (req: any, res) => {\n    try {\n      console.log('[POST /products] Request body:', JSON.stringify(req.body, null, 2));\n      const data = createProductInProjectSchema.parse(req.body);\n      const product = await supabaseStorage.createProduct(req.params.projectId, data, req.user.id);\n      await trackApiUsage(req, res, () => {});\n      res.json(product);\n    } catch (error: any) {\n      console.error('[POST /products] Validation error:', error);\n      res.status(400).json({ error: error.message || 'Ungltige Produktdaten' });\n    }\n  });\n\n  app.delete('/api/products/:id', requireAuth, async (req: any, res) => {\n    try {\n      const success = await supabaseStorage.deleteProduct(req.params.id, req.user.id);\n      if (!success) {\n        return res.status(404).json({ error: 'Produkt nicht gefunden oder keine Berechtigung' });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error('[DELETE /products] Error:', error);\n      res.status(500).json({ error: 'Fehler beim Lschen des Produkts' });\n    }\n  });\n\n  app.post('/api/bulk-save-to-project', requireAuth, requireFeature('csvBulkImport'), checkApiLimit, async (req: any, res) => {\n    try {\n      const { projectName, products } = req.body;\n\n      if (!projectName || !Array.isArray(products) || products.length === 0) {\n        return res.status(400).json({ error: 'Projektname und Produkte sind erforderlich' });\n      }\n\n      console.log(`[BULK-SAVE] Saving ${products.length} products to project \"${projectName}\"`);\n\n      const project = await supabaseStorage.createProject(req.user.id, { name: projectName });\n\n      const savedProducts = [];\n      for (const product of products) {\n        // Use extractedData from request if provided, otherwise build from individual fields\n        const extractedData = product.extractedData && Array.isArray(product.extractedData) \n          ? product.extractedData \n          : [\n              product.ean ? { key: 'ean', value: product.ean, type: 'text' } : null,\n              product.hersteller ? { key: 'hersteller', value: product.hersteller, type: 'text' } : null,\n              product.preis ? { key: 'preis', value: product.preis, type: 'text' } : null,\n              product.gewicht ? { key: 'gewicht', value: product.gewicht, type: 'text' } : null,\n              product.laenge ? { key: 'laenge', value: product.laenge, type: 'text' } : null,\n              product.breite ? { key: 'breite', value: product.breite, type: 'text' } : null,\n              product.hoehe ? { key: 'hoehe', value: product.hoehe, type: 'text' } : null,\n              product.nominalkapazitaet ? { key: 'nominalkapazitaet', value: product.nominalkapazitaet, type: 'text' } : null,\n              product.kategorie ? { key: 'kategorie', value: product.kategorie, type: 'text' } : null,\n              product.source_url ? { key: 'source_url', value: product.source_url, type: 'text' } : null,\n            ].filter((item): item is { key: string; value: string; type: string } => item !== null);\n\n        const productData = {\n          projectId: project.id,\n          name: product.produktname || 'Unbekanntes Produkt',\n          articleNumber: product.artikelnummer || '',\n          htmlCode: product.produktbeschreibung || '',\n          previewText: product.seo_beschreibung || product.kurzbeschreibung || '',\n          exactProductName: product.mediamarktname_v1 || product.mediamarktname_v2 || product.produktname || '',\n          extractedData: extractedData,\n          customAttributes: [\n            { key: 'mediamarktname_v1', value: product.mediamarktname_v1 || '', type: 'text' },\n            { key: 'mediamarktname_v2', value: product.mediamarktname_v2 || '', type: 'text' },\n            { key: 'seo_titel', value: product.seo_titel || '', type: 'text' },\n            { key: 'seo_beschreibung', value: product.seo_beschreibung || '', type: 'text' },\n            { key: 'kurzbeschreibung', value: product.kurzbeschreibung || '', type: 'text' },\n          ].filter(attr => attr.value),\n        };\n\n        const savedProduct = await supabaseStorage.createProduct(project.id, productData, req.user.id);\n        savedProducts.push(savedProduct);\n      }\n\n      await trackApiUsage(req, res, () => {});\n\n      console.log(`[BULK-SAVE] Successfully saved ${savedProducts.length} products`);\n      \n      res.json({ \n        success: true, \n        project,\n        productCount: savedProducts.length \n      });\n    } catch (error: any) {\n      console.error('[BULK-SAVE] Error:', error);\n      res.status(500).json({ \n        error: error.message || 'Fehler beim Speichern der Produkte' \n      });\n    }\n  });\n\n  app.get('/api/suppliers', requireAuth, async (req: any, res) => {\n    try {\n      const suppliers = await supabaseStorage.getSuppliers(req.user.id);\n      res.json({ success: true, suppliers });\n    } catch (error) {\n      res.status(500).json({ success: false, error: 'Fehler beim Laden der Lieferanten' });\n    }\n  });\n\n  app.get('/api/suppliers/:id', requireAuth, async (req: any, res) => {\n    try {\n      const supplier = await supabaseStorage.getSupplier(req.params.id);\n      if (!supplier) {\n        return res.status(404).json({ success: false, error: 'Lieferant nicht gefunden' });\n      }\n      res.json({ success: true, supplier });\n    } catch (error) {\n      res.status(500).json({ success: false, error: 'Fehler beim Laden des Lieferanten' });\n    }\n  });\n\n  // Get Brickfox-optimized selector template\n  app.get('/api/selectors/brickfox', requireAuth, (req: any, res) => {\n    res.json({ success: true, selectors: brickfoxSelectors });\n  });\n\n  app.post('/api/suppliers', requireAuth, async (req: any, res) => {\n    try {\n      const supplier = await supabaseStorage.createSupplier(req.user.id, req.body);\n      res.json({ success: true, supplier });\n    } catch (error: any) {\n      res.status(500).json({ success: false, error: error.message || 'Fehler beim Erstellen des Lieferanten' });\n    }\n  });\n\n  app.put('/api/suppliers/:id', requireAuth, async (req: any, res) => {\n    try {\n      const supplier = await supabaseStorage.updateSupplier(req.params.id, req.body);\n      res.json({ success: true, supplier });\n    } catch (error: any) {\n      res.status(500).json({ success: false, error: error.message || 'Fehler beim Aktualisieren des Lieferanten' });\n    }\n  });\n\n  app.delete('/api/suppliers/:id', requireAuth, async (req: any, res) => {\n    try {\n      await supabaseStorage.deleteSupplier(req.params.id);\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ success: false, error: error.message || 'Fehler beim Lschen des Lieferanten' });\n    }\n  });\n\n  app.post('/api/scrape', requireAuth, requireFeature('urlScraper'), checkApiLimit, upload.none(), async (req, res) => {\n    try {\n      const { url, selectors } = req.body;\n      \n      if (!url) {\n        return res.status(400).json({ error: 'URL ist erforderlich' });\n      }\n\n      const parsedSelectors: ScraperSelectors = selectors ? JSON.parse(selectors) : defaultSelectors.generic;\n      const result = await scrapeProduct({ url, selectors: parsedSelectors });\n      \n      // AI-Farbanalyse: Wenn Bilder vorhanden sind, analysiere das erste Bild\n      if (result.images && result.images.length > 0) {\n        const firstImageUrl = result.images[0];\n        console.log('[Scraper] Starte AI-Farbanalyse fr Produktbild...');\n        \n        try {\n          const { analyzeProductImageColor } = await import('./ai-service');\n          const aiDetectedColor = await analyzeProductImageColor(firstImageUrl);\n          \n          if (aiDetectedColor) {\n            console.log(`[Scraper] AI erkannte Farbe: ${aiDetectedColor} (Original: ${(result as any).farbe || 'keine'})`);\n            (result as any).farbe = aiDetectedColor;\n            (result as any).colorDetectedByAI = true; // Flag fr Frontend-Anzeige\n          }\n        } catch (error) {\n          console.error('[Scraper] Fehler bei AI-Farbanalyse:', error);\n          // Continue ohne Farbanalyse bei Fehler\n        }\n      }\n      \n      await trackApiUsage(req, res, () => {});\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Single product scraping is also FREE\n  app.post('/api/scrape-product', requireAuth, requireFeature('urlScraper'), async (req, res) => {\n    try {\n      const { url, selectors, userAgent, cookies, supplierId } = req.body;\n      \n      if (!url) {\n        return res.status(400).json({ error: 'URL ist erforderlich' });\n      }\n\n      // Get cookies from login if supplier has credentials configured\n      const effectiveCookies = await getScrapingCookies(supplierId, cookies);\n\n      const product = await scrapeProduct({ \n        url, \n        selectors: selectors || defaultSelectors.generic,\n        userAgent,\n        cookies: effectiveCookies\n      });\n      \n      // AI-Farbanalyse: Wenn Bilder vorhanden sind, analysiere das erste Bild\n      if (product.images && product.images.length > 0) {\n        const firstImageUrl = product.images[0];\n        console.log('[Scraper] Starte AI-Farbanalyse fr Produktbild...');\n        \n        try {\n          const { analyzeProductImageColor } = await import('./ai-service');\n          const aiDetectedColor = await analyzeProductImageColor(firstImageUrl);\n          \n          if (aiDetectedColor) {\n            console.log(`[Scraper] AI erkannte Farbe: ${aiDetectedColor} (Original: ${(product as any).farbe || 'keine'})`);\n            (product as any).farbe = aiDetectedColor;\n            (product as any).colorDetectedByAI = true; // Flag fr Frontend-Anzeige\n          }\n        } catch (error) {\n          console.error('[Scraper] Fehler bei AI-Farbanalyse:', error);\n          // Continue ohne Farbanalyse bei Fehler\n        }\n      }\n      \n      // Bilder herunterladen: Alle Produktbilder lokal speichern\n      if (product.images && product.images.length > 0 && product.articleNumber) {\n        console.log(`[Image Download] Starte Download von ${product.images.length} Bildern fr ${product.articleNumber}...`);\n        \n        try {\n          const { downloadProductImages } = await import('./image-download-service');\n          const downloadedImages = await downloadProductImages(product.images, product.articleNumber);\n          \n          // Add local image paths as URLs to product data\n          (product as any).localImagePaths = downloadedImages.map(img => \n            img.localPath.replace('attached_assets/product_images/', '/product-images/')\n          );\n          (product as any).downloadedImages = downloadedImages;\n          \n          console.log(`[Image Download]  ${downloadedImages.length} Bilder erfolgreich heruntergeladen`);\n          console.log(`[Image Download]  downloadedImages Array Length: ${downloadedImages.length}`);\n          console.log(`[Image Download]  Lokale Pfade Array Length: ${(product as any).localImagePaths.length}`);\n          console.log(`[Image Download]  Lokale Pfade:`, (product as any).localImagePaths);\n        } catch (error) {\n          console.error('[Image Download]  Fehler beim Herunterladen der Bilder:', error);\n          // Continue ohne lokale Bilder bei Fehler\n          (product as any).localImagePaths = [];\n        }\n      } else {\n        (product as any).localImagePaths = [];\n      }\n      \n      // DEBUG: Log all product fields to see what's being returned\n      console.log(' [BACKEND] Product fields being returned:', Object.keys(product));\n      console.log(' [BACKEND] Nitecore fields:', {\n        length: product.length,\n        bodyDiameter: product.bodyDiameter,\n        led1: product.led1,\n        led2: product.led2,\n        maxLuminosity: product.maxLuminosity,\n        spotIntensity: product.spotIntensity\n      });\n      \n      await trackApiUsage(req, res, () => {});\n      res.json({ product });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post('/api/test-scrape-product', requireAuth, async (req, res) => {\n    try {\n      const { url, selectors, userAgent, cookies, supplierId } = req.body;\n      \n      if (!url) {\n        return res.status(400).json({ error: 'URL ist erforderlich' });\n      }\n\n      // Get cookies from login if supplier has credentials configured\n      const effectiveCookies = await getScrapingCookies(supplierId, cookies);\n\n      const product = await scrapeProduct({ \n        url, \n        selectors: selectors || defaultSelectors.generic,\n        userAgent,\n        cookies: effectiveCookies\n      });\n      \n      res.json({ product });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Test a single CSS selector (for supplier configuration verification)\n  app.post('/api/scraper/test-selector', requireAuth, requireFeature('urlScraper'), async (req, res) => {\n    try {\n      const { url, selector, userAgent, cookies, supplierId } = req.body;\n      \n      if (!url) {\n        return res.status(400).json({ error: 'URL ist erforderlich' });\n      }\n\n      if (!selector) {\n        return res.status(400).json({ error: 'CSS-Selektor ist erforderlich' });\n      }\n\n      // Get cookies from login if supplier has credentials configured\n      const effectiveCookies = await getScrapingCookies(supplierId, cookies);\n\n      const result = await testSelector({ \n        url, \n        selector,\n        userAgent,\n        cookies: effectiveCookies\n      });\n      \n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Scraping is FREE - no API limit check\n  app.post('/api/scrape-product-list', requireAuth, requireFeature('urlScraper'), async (req, res) => {\n    try {\n      const { listUrl, productLinkSelector, maxProducts, selectors, userAgent, cookies, supplierId } = req.body;\n      \n      if (!listUrl) {\n        return res.status(400).json({ error: 'Listen-URL ist erforderlich' });\n      }\n\n      // Get cookies from login if supplier has credentials configured\n      const effectiveCookies = await getScrapingCookies(supplierId, cookies);\n\n      const result = await scrapeProductList(\n        listUrl,\n        productLinkSelector || 'a.product-link',\n        maxProducts || 50,\n        { selectors: selectors || defaultSelectors.generic, userAgent, cookies: effectiveCookies }\n      );\n      \n      // No usage tracking for scraping (it's free)\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Scraping is FREE - no API limit check (only AI generation costs credits)\n  app.post('/api/scrape-all-pages', requireAuth, requireFeature('urlScraper'), async (req, res) => {\n    try {\n      const { url, listUrl, productLinkSelector, paginationSelector, maxPages, maxProducts, selectors, userAgent, cookies } = req.body;\n      \n      // Support both 'url' and 'listUrl' for backwards compatibility\n      const targetUrl = url || listUrl;\n      \n      if (!targetUrl) {\n        return res.status(400).json({ error: 'URL ist erforderlich' });\n      }\n\n      // Set headers for streaming\n      res.setHeader('Content-Type', 'text/event-stream');\n      res.setHeader('Cache-Control', 'no-cache');\n      res.setHeader('Connection', 'keep-alive');\n\n      console.log(`Starting multi-page scraping from: ${targetUrl}`);\n      console.log(`Max pages: ${maxPages || 10}, Max products: ${maxProducts || 500}`);\n\n      // Import scrapeAllPages function\n      const { scrapeAllPages } = await import('./scraper-service.js');\n\n      // Progress callback to send updates\n      const progressCallback = (currentPage: number, totalProducts: number) => {\n        res.write(`data: ${JSON.stringify({ \n          type: 'progress',\n          currentPage, \n          totalProducts,\n          message: ` Seite ${currentPage} gescraped - ${totalProducts} Produkte gefunden`\n        })}\\n\\n`);\n      };\n\n      const productUrls = await scrapeAllPages(\n        targetUrl,\n        productLinkSelector || null,\n        paginationSelector || null,\n        maxPages || 10,\n        maxProducts || 500,\n        {\n          userAgent,\n          cookies,\n          timeout: 15000\n        },\n        progressCallback\n      );\n      \n      // No usage tracking for scraping (it's free)\n      \n      // Send final result\n      res.write(`data: ${JSON.stringify({ \n        type: 'complete',\n        success: true,\n        productUrls,\n        count: productUrls.length,\n        message: ` Fertig! ${productUrls.length} Produkte von mehreren Seiten gescraped`\n      })}\\n\\n`);\n      res.end();\n    } catch (error: any) {\n      res.write(`data: ${JSON.stringify({ type: 'error', error: error.message })}\\n\\n`);\n      res.end();\n    }\n  });\n\n  app.post('/api/generate', requireAuth, requireFeature('aiDescriptions'), checkApiLimit, async (req, res) => {\n    try {\n      const { productData, template } = req.body;\n      \n      if (!productData) {\n        return res.status(400).json({ error: 'Produktdaten fehlen' });\n      }\n\n      const { html: description } = await generateProductDescription(productData);\n      const htmlCode = convertTextToHTML(description);\n      \n      await trackApiUsage(req, res, () => {});\n      res.json({ description, htmlCode });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post('/api/generate-description', requireAuth, requireFeature('aiDescriptions'), checkApiLimit, async (req, res) => {\n    try {\n      const { extractedData, structuredData, customAttributes, autoExtractedDescription, technicalDataTable, safetyWarnings, pdfManualUrl, model } = req.body;\n\n      if (!extractedData || !Array.isArray(extractedData)) {\n        return res.status(400).json({ error: 'Invalid extracted data' });\n      }\n\n      // SMART AUTO-EXTRACTION: Combine manual extracted data with auto-extracted data\n      const enhancedData = [...extractedData];\n      \n      if (autoExtractedDescription) {\n        enhancedData.push(`Produktbeschreibung:\\n${autoExtractedDescription}`);\n      }\n      \n      if (technicalDataTable) {\n        enhancedData.push(`Technische Daten (HTML-Tabelle):\\n${technicalDataTable}`);\n      }\n\n      if (safetyWarnings) {\n        enhancedData.push(`Sicherheitshinweise:\\n${safetyWarnings}`);\n      }\n\n      if (pdfManualUrl) {\n        enhancedData.push(`Bedienungsanleitung verfgbar: ${pdfManualUrl}`);\n      }\n\n      // COST OPTIMIZATION: Use GPT-4o-mini (30 cheaper) by default\n      const aiModel = model || 'gpt-4o-mini';\n      const { html: description, categoryId: detectedCategory, enrichedProductData } = await generateProductDescription(\n        enhancedData, \n        undefined, \n        {\n          ...customAttributes,\n          structuredData, // WICHTIG: Strukturierte Daten bertragen (length, bodyDiameter, led1, etc.)\n          technicalDataTable, // Pass the original HTML table\n          safetyWarnings, // Pass safety warnings for 1:1 rendering\n          pdfManualUrl // Pass PDF URL for reference\n        }, \n        aiModel\n      );\n\n      // Extract SEO fields from product data\n      const firstData = extractedData[0] || {};\n      const productName = customAttributes?.exactProductName || firstData.productName || firstData.product_name || '';\n      const manufacturer = firstData.manufacturer || firstData.Hersteller || '';\n      const category = detectedCategory; // Use AI-detected category instead of scraped category\n      const articleNumber = firstData.articleNumber || firstData.artikel_nr || '';\n      \n      console.log(`[SEO] Using detected category \"${detectedCategory}\" for SEO generation`);\n      \n      // Collect technical specs for SEO context\n      const technicalSpecs: string[] = [];\n      if (firstData.nominalspannung) technicalSpecs.push(`${firstData.nominalspannung}V`);\n      if (firstData.nominalkapazitaet) technicalSpecs.push(`${firstData.nominalkapazitaet}mAh`);\n      if (firstData.gewicht) technicalSpecs.push(firstData.gewicht);\n      \n      // Generate AI-powered SEO metadata\n      const { generateSEOMetadata, generateSEOKeywords } = await import('./ai-service.js');\n      const seoMetadata = await generateSEOMetadata({\n        productName,\n        manufacturer,\n        category,\n        articleNumber,\n        description: autoExtractedDescription || description.replace(/<[^>]*>/g, '').substring(0, 300),\n        technicalSpecs,\n        nominalkapazitaet: enrichedProductData.nominalkapazitaet || firstData.nominalkapazitaet || structuredData?.nominalkapazitaet,\n        zellenchemie: enrichedProductData.zellenchemie || firstData.zellenchemie || structuredData?.zellenchemie\n      }, aiModel);\n      \n      const { seoTitle, seoDescription } = seoMetadata;\n      \n      // Generate AI-powered SEO Keywords (structured)\n      const descriptionText = autoExtractedDescription || description.replace(/<[^>]*>/g, '').substring(0, 500);\n      const seoKeywordsStructured = await generateSEOKeywords(\n        productName,\n        descriptionText,\n        12, // max 12 keywords per category\n        aiModel\n      );\n      \n      // Combine all keywords into a comma-separated string for backward compatibility\n      const allKeywords = [\n        ...seoKeywordsStructured.hauptkeywords,\n        ...seoKeywordsStructured.longtail_keywords,\n        ...seoKeywordsStructured.brand_keywords,\n        ...seoKeywordsStructured.intent_keywords\n      ].slice(0, 20); // Limit to top 20 keywords\n      const seoKeywords = allKeywords.join(', ');\n\n      await trackApiUsage(req, res, () => {});\n      res.json({ \n        success: true, \n        description,\n        seoTitle,\n        seoDescription,\n        seoKeywords,\n        seoKeywordsStructured // Return structured keywords for advanced use\n      });\n    } catch (error) {\n      console.error('Description generation error:', error);\n      res.status(500).json({ \n        error: error instanceof Error ? error.message : 'Description generation failed' \n      });\n    }\n  });\n\n  app.post('/api/pixi/compare', requireAuth, requireFeature('pixiIntegration'), upload.single('csvFile'), async (req: any, res) => {\n    try {\n      const { supplNr } = req.body;\n      const file = req.file;\n\n      if (!supplNr) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Supplier number (supplNr) is required' \n        });\n      }\n\n      if (!file) {\n        return res.status(400).json({ \n          success: false,\n          error: 'CSV file is required' \n        });\n      }\n\n      console.log(`[Pixi Compare] Processing CSV for supplier ${supplNr}, file size: ${file.size} bytes`);\n\n      // Try to detect encoding - first try UTF-8, then Windows-1252\n      let csvContent = file.buffer.toString('utf-8');\n      \n      // Check if content contains replacement characters (), indicating wrong encoding\n      if (csvContent.includes('')) {\n        console.log('[Pixi Compare] UTF-8 decoding produced replacement characters, trying Windows-1252');\n        csvContent = file.buffer.toString('latin1');\n      }\n\n      const parseResult = await new Promise<any>((resolve, reject) => {\n        Papa.parse(csvContent, {\n          header: true,\n          skipEmptyLines: true,\n          transformHeader: (header) => header.trim(), // Remove leading/trailing spaces from headers\n          complete: (results) => resolve(results),\n          error: (error) => reject(error),\n        });\n      });\n\n      if (!parseResult.data || parseResult.data.length === 0) {\n        return res.status(400).json({ \n          success: false,\n          error: 'CSV file is empty or invalid' \n        });\n      }\n\n      console.log(`[Pixi Compare] Parsed ${parseResult.data.length} products from CSV`);\n\n      // Fix scientific notation in EAN fields FIRST (e.g., \"4,01E+12\" -> \"4013674012345\")\n      parseResult.data.forEach((product: any) => {\n        // Try to fix EAN field\n        ['v_ean', 'ean', 'EAN'].forEach(key => {\n          if (product[key]) {\n            const eanStr = String(product[key]);\n            // Check if it's in scientific notation (e.g., \"4,01E+12\" or \"4.01E+12\")\n            if (eanStr.match(/[0-9],[0-9]+E\\+[0-9]+/i) || eanStr.match(/[0-9]\\.[0-9]+E\\+[0-9]+/i)) {\n              // Parse as number and convert back to string without scientific notation\n              const eanNum = parseFloat(eanStr.replace(',', '.'));\n              if (!isNaN(eanNum)) {\n                product[key] = Math.round(eanNum).toString();\n                console.log(`[Pixi Compare] Fixed EAN scientific notation: ${eanStr} -> ${product[key]}`);\n              }\n            }\n          }\n        });\n      });\n\n      // Filter out empty rows (where important fields are all empty)\n      const products = parseResult.data.filter((row: any) => {\n        // Check if at least one of the key fields has data\n        const keyFields = [\n          row.p_item_number, row.v_manufacturers_item_number, \n          row['p_name[de]'], row.v_ean, row.p_brand\n        ];\n        const hasKeyData = keyFields.some(val => \n          val !== null && val !== undefined && String(val).trim() !== ''\n        );\n        return hasKeyData;\n      });\n\n      console.log(`[Pixi Compare] After filtering: ${products.length} valid products`);\n\n      const comparisonResult = await pixiService.compareProducts(products, supplNr);\n\n      console.log(\n        `[Pixi Compare] Comparison complete: ${comparisonResult.summary.total} total, ` +\n        `${comparisonResult.summary.neu} new, ${comparisonResult.summary.vorhanden} existing`\n      );\n\n      res.json(comparisonResult);\n    } catch (error: any) {\n      console.error('[Pixi Compare] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to compare products with Pixi API' \n      });\n    }\n  });\n\n  app.post('/api/pixi/compare-json', requireAuth, requireFeature('pixiIntegration'), async (req: any, res) => {\n    try {\n      const { products, supplNr } = req.body;\n\n      if (!supplNr) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Supplier number (supplNr) is required' \n        });\n      }\n\n      if (!products || !Array.isArray(products) || products.length === 0) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Products array is required and must not be empty' \n        });\n      }\n\n      console.log(`[Pixi Compare JSON] Processing ${products.length} products for supplier ${supplNr}`);\n\n      const comparisonResult = await pixiService.compareProducts(products, supplNr);\n\n      console.log(\n        `[Pixi Compare JSON] Comparison complete: ${comparisonResult.summary.total} total, ` +\n        `${comparisonResult.summary.neu} new, ${comparisonResult.summary.vorhanden} existing`\n      );\n\n      res.json(comparisonResult);\n    } catch (error: any) {\n      console.error('[Pixi Compare JSON] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to compare products with Pixi API' \n      });\n    }\n  });\n\n  // Direct comparison from PDF-Scraper (alias for compare-json)\n  app.post('/api/pixi/compare-direct', requireAuth, requireFeature('pixiIntegration'), async (req: any, res) => {\n    try {\n      const { products, supplNr } = req.body;\n\n      if (!supplNr) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Supplier number (supplNr) is required' \n        });\n      }\n\n      if (!products || !Array.isArray(products) || products.length === 0) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Products array is required and must not be empty' \n        });\n      }\n\n      console.log(`[Pixi Compare Direct] Processing ${products.length} products from PDF-Scraper for supplier ${supplNr}`);\n\n      const comparisonResult = await pixiService.compareProducts(products, supplNr);\n\n      console.log(\n        `[Pixi Compare Direct] Comparison complete: ${comparisonResult.summary.total} total, ` +\n        `${comparisonResult.summary.neu} new, ${comparisonResult.summary.vorhanden} existing`\n      );\n\n      res.json(comparisonResult);\n    } catch (error: any) {\n      console.error('[Pixi Compare Direct] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to compare products with Pixi API' \n      });\n    }\n  });\n\n  app.delete('/api/pixi/cache', requireAuth, async (req: any, res) => {\n    try {\n      pixiService.clearCache();\n      res.json({ success: true, message: 'Pixi cache cleared' });\n    } catch (error: any) {\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to clear cache' \n      });\n    }\n  });\n\n  // Brickfox CSV Preview - Preview Brickfox data before export\n  app.post('/api/brickfox/preview', requireAuth, async (req: any, res) => {\n    try {\n      const { projectId, supplierId } = req.body;\n\n      if (!projectId) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Project ID is required' \n        });\n      }\n\n      console.log(`[Brickfox Preview] Generating preview for project ${projectId}`);\n\n      // Get all products in project\n      const products = await supabaseStorage.getProducts(projectId, req.user.id);\n      \n      if (!products || products.length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: 'No products found in project'\n        });\n      }\n\n      // Get supplier name and load custom mappings\n      let supplierName = undefined;\n      let customMapping = undefined;\n      const user = await supabaseStorage.getUserById(req.user.id);\n      \n      if (supplierId && user?.tenantId) {\n        const supplier = await supabaseStorage.getSupplier(supplierId);\n        supplierName = supplier?.name;\n        \n        // Load custom field mappings for this supplier (URL scraper)\n        customMapping = await loadMappingsForSupplier(supplierId, user.tenantId, 'url_scraper');\n        console.log(`[Brickfox Preview] Loaded custom URL scraper mappings for supplier ${supplierId}`);\n      } else if (projectId && user?.tenantId) {\n        // Load custom field mappings for this project (CSV)\n        customMapping = await loadMappingsForProject(projectId, user.tenantId, 'csv');\n        console.log(`[Brickfox Preview] Loaded custom CSV mappings for project ${projectId}`);\n      }\n\n      // Load mappingRules.json for fixed values and auto-generate rules\n      let fixedValues = undefined;\n      let autoGenerateRules = undefined;\n      \n      try {\n        const { loadMappingRules } = await import('./services/mapping-rules-loader');\n        const mappingRules = loadMappingRules();\n        fixedValues = mappingRules.fixedValues;\n        autoGenerateRules = mappingRules.autoGenerate;\n        console.log(`[Brickfox Preview] Loaded mappingRules.json with ${Object.keys(fixedValues).length} fixed values`);\n      } catch (error: any) {\n        console.warn(`[Brickfox Preview] Could not load mappingRules.json: ${error.message}`);\n      }\n\n      // Transform to Brickfox format (without AI enhancement for faster preview)\n      const brickfoxRows = mapProductsToBrickfox(products, {\n        supplierName: supplierName || 'Unbekannt',\n        customMapping,\n        fixedValues,\n        autoGenerateRules,\n        enableAI: false // Disable AI for preview to speed up\n      });\n\n      console.log(`[Brickfox Preview] Generated preview with ${brickfoxRows.length} rows`);\n      \n      res.json({\n        success: true,\n        rows: brickfoxRows,\n        totalRows: brickfoxRows.length\n      });\n    } catch (error: any) {\n      console.error('[Brickfox Preview] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to generate Brickfox preview' \n      });\n    }\n  });\n\n  // Brickfox CSV Export - Export project products as Brickfox-formatted CSV\n  app.post('/api/brickfox/export', requireAuth, async (req: any, res) => {\n    try {\n      const { projectId, supplierId } = req.body;\n\n      if (!projectId) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Project ID is required' \n        });\n      }\n\n      console.log(`[Brickfox Export] Exporting project ${projectId}`);\n\n      // Get all products in project\n      const products = await supabaseStorage.getProducts(projectId, req.user.id);\n      \n      if (!products || products.length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: 'No products found in project'\n        });\n      }\n\n      // Get supplier name and load custom mappings\n      let supplierName = undefined;\n      let customMapping = undefined;\n      const user = await supabaseStorage.getUserById(req.user.id);\n      \n      if (supplierId && user?.tenantId) {\n        const supplier = await supabaseStorage.getSupplier(supplierId);\n        supplierName = supplier?.name;\n        \n        // Load custom field mappings for this supplier (URL scraper)\n        customMapping = await loadMappingsForSupplier(supplierId, user.tenantId, 'url_scraper');\n        console.log(`[Brickfox Export] Loaded custom URL scraper mappings for supplier ${supplierId}`);\n      } else if (projectId && user?.tenantId) {\n        // Load custom field mappings for this project (CSV)\n        customMapping = await loadMappingsForProject(projectId, user.tenantId, 'csv');\n        console.log(`[Brickfox Export] Loaded custom CSV mappings for project ${projectId}`);\n      }\n\n      // AI Enhancement: Generate missing fields\n      console.log(`[Brickfox Export] Running AI enhancement for ${products.length} products...`);\n      const aiEnhancements = await enhanceProductsWithAI(products);\n      console.log(`[Brickfox Export] AI enhancement complete: ${aiEnhancements.size} products enhanced`);\n\n      // Merge AI enhancements into products\n      products.forEach(product => {\n        const enhancement = aiEnhancements.get(product.id);\n        if (enhancement) {\n          // Add AI data to customAttributes\n          if (!product.customAttributes) product.customAttributes = [];\n          \n          if (enhancement.customs_tariff_number) {\n            product.customAttributes.push({ \n              key: 'ai_customs_tariff_number', \n              value: enhancement.customs_tariff_number,\n              type: 'string'\n            });\n          }\n          if (enhancement.customs_tariff_text) {\n            product.customAttributes.push({ \n              key: 'ai_customs_tariff_text', \n              value: enhancement.customs_tariff_text,\n              type: 'string'\n            });\n          }\n          if (enhancement.optimized_description) {\n            product.customAttributes.push({ \n              key: 'ai_description', \n              value: enhancement.optimized_description,\n              type: 'string'\n            });\n          }\n        }\n      });\n\n      // Load mappingRules.json for fixed values and auto-generate rules\n      let fixedValues = undefined;\n      let autoGenerateRules = undefined;\n      \n      try {\n        const { loadMappingRules } = await import('./services/mapping-rules-loader');\n        const mappingRules = loadMappingRules();\n        fixedValues = mappingRules.fixedValues;\n        autoGenerateRules = mappingRules.autoGenerate;\n        console.log(`[Brickfox Export] Loaded mappingRules.json with ${Object.keys(fixedValues).length} fixed values`);\n      } catch (error: any) {\n        console.warn(`[Brickfox Export] Could not load mappingRules.json: ${error.message}`);\n      }\n\n      // Transform to Brickfox format\n      const brickfoxRows = mapProductsToBrickfox(products, {\n        supplierName: supplierName || 'Unbekannt',\n        customMapping,\n        fixedValues,\n        autoGenerateRules,\n        enableAI: true\n      });\n\n      // Convert to CSV\n      const csv = brickfoxRowsToCSV(brickfoxRows);\n\n      // Set headers for file download\n      res.setHeader('Content-Type', 'text/csv; charset=utf-8');\n      res.setHeader('Content-Disposition', `attachment; filename=\"brickfox-export-${projectId}.csv\"`);\n      \n      console.log(`[Brickfox Export] Generated CSV with ${brickfoxRows.length} rows`);\n      \n      res.send(csv);\n    } catch (error: any) {\n      console.error('[Brickfox Export] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to export Brickfox CSV' \n      });\n    }\n  });\n\n  // Pixi Supabase Integration - Compare project products with Pixi ERP\n  app.post('/api/pixi/compare-project', requireAuth, requireFeature('pixiIntegration'), async (req: any, res) => {\n    try {\n      const { projectId, supplierId, supplNr } = req.body;\n\n      if (!projectId) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Project ID is required' \n        });\n      }\n\n      if (!supplierId && !supplNr) {\n        return res.status(400).json({ \n          success: false,\n          error: 'Either supplier ID or supplier number (supplNr) is required' \n        });\n      }\n\n      console.log(\n        `[Pixi Compare Project] Starting comparison for project ${projectId} ` +\n        `with ${supplierId ? `supplier ${supplierId}` : `supplNr ${supplNr}`}`\n      );\n\n      const supplierIdOrSupplNr = supplierId || supplNr;\n      const comparisonResult = await pixiService.compareProductsFromSupabase(\n        projectId,\n        supabaseStorage,\n        supplierIdOrSupplNr\n      );\n\n      console.log(\n        `[Pixi Compare Project] Comparison complete: ${comparisonResult.summary.total} total, ` +\n        `${comparisonResult.summary.neu} new, ${comparisonResult.summary.vorhanden} existing`\n      );\n\n      res.json(comparisonResult);\n    } catch (error: any) {\n      console.error('[Pixi Compare Project] Error:', error);\n      res.status(500).json({ \n        success: false,\n        error: error.message || 'Failed to compare products with Pixi API' \n      });\n    }\n  });\n\n  // PDF Preview - Extract URLs without scraping (no automatic scraping)\n  app.post('/api/pdf/preview', requireAuth, upload.single('pdf'), async (req: any, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ \n          success: false, \n          error: 'Keine PDF-Datei hochgeladen' \n        });\n      }\n\n      console.log(`[PDF Preview] Processing PDF: ${req.file.originalname}`);\n\n      // Extract products WITH and WITHOUT URLs\n      const parseResult = await pdfParserService.extractProductsWithSeparation(req.file.buffer);\n\n      console.log(`[PDF Preview] Found ${parseResult.withURL.length} products WITH URLs`);\n      console.log(`[PDF Preview] Found ${parseResult.withoutURL.length} products WITHOUT URLs`);\n\n      res.json({\n        success: true,\n        totalProducts: parseResult.totalProducts,\n        withURL: parseResult.withURL,\n        withoutURL: parseResult.withoutURL,\n        // Legacy field for backwards compatibility\n        products: parseResult.withURL,\n      });\n    } catch (error: any) {\n      console.error('[PDF Preview] Error:', error);\n      res.status(500).json({ \n        success: false, \n        error: error.message || 'Fehler beim Verarbeiten der PDF' \n      });\n    }\n  });\n\n  // Send Email - Request URLs from supplier for products without URLs\n  app.post('/api/email/request-urls', requireAuth, async (req, res) => {\n    try {\n      const { to, subject, message, eanCodes } = req.body;\n\n      if (!to || !subject || !message || !eanCodes || !Array.isArray(eanCodes)) {\n        return res.status(400).json({\n          success: false,\n          error: 'Fehlende Parameter: to, subject, message, eanCodes erforderlich',\n        });\n      }\n\n      console.log(`[Email Service] Sending URL request to ${to} for ${eanCodes.length} products`);\n\n      const result = await emailService.sendSupplierUrlRequest({\n        to,\n        subject,\n        message,\n        eanCodes,\n      });\n\n      if (result.success) {\n        res.json({\n          success: true,\n          message: 'E-Mail erfolgreich versendet',\n        });\n      } else {\n        res.status(500).json({\n          success: false,\n          error: result.error || 'Fehler beim Senden der E-Mail',\n        });\n      }\n    } catch (error: any) {\n      console.error('[Email Service] Error:', error);\n      res.status(500).json({\n        success: false,\n        error: error.message || 'Fehler beim Senden der E-Mail',\n      });\n    }\n  });\n\n  // ===== SCRAPE SESSION MANAGEMENT =====\n  // GET current scrape session for user (persists data between page navigation)\n  app.get('/api/scrape-session', requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).userId;\n      const tenantId = (req as any).tenantId;\n      \n      // Get the most recent scrape session for this user\n      const [session] = await heliumDb\n        .select()\n        .from(scrapeSessionTable)\n        .where(\n          and(\n            eq(scrapeSessionTable.userId, userId),\n            tenantId ? eq(scrapeSessionTable.tenantId, tenantId) : undefined\n          )\n        )\n        .orderBy(sql`${scrapeSessionTable.updatedAt} DESC`)\n        .limit(1);\n      \n      if (!session) {\n        return res.json({ success: true, session: null });\n      }\n      \n      res.json({\n        success: true,\n        session: {\n          id: session.id,\n          scrapedProducts: session.scrapedProducts,\n          scrapedProduct: session.scrapedProduct,\n          generatedDescription: session.generatedDescription,\n          updatedAt: session.updatedAt,\n        },\n      });\n    } catch (error: any) {\n      console.error('[Scrape Session] GET error:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // PUT/UPDATE scrape session (auto-save during scraping)\n  app.put('/api/scrape-session', requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).userId;\n      const tenantId = (req as any).tenantId;\n      const { urlScraper, pdfScraper, generatedDescription } = req.body;\n      \n      // Check if session already exists\n      const [existingSession] = await heliumDb\n        .select()\n        .from(scrapeSessionTable)\n        .where(\n          and(\n            eq(scrapeSessionTable.userId, userId),\n            tenantId ? eq(scrapeSessionTable.tenantId, tenantId) : undefined\n          )\n        )\n        .orderBy(sql`${scrapeSessionTable.updatedAt} DESC`)\n        .limit(1);\n      \n      let session;\n      \n      if (existingSession) {\n        // Merge existing data with new data (preserve both scrapers' data)\n        const existingData = (existingSession.scrapedProducts as any) || {};\n        const mergedData = {\n          urlScraper: urlScraper || existingData.urlScraper || null,\n          pdfScraper: pdfScraper || existingData.pdfScraper || null,\n        };\n        \n        // Update existing session\n        [session] = await heliumDb\n          .update(scrapeSessionTable)\n          .set({\n            scrapedProducts: mergedData,\n            generatedDescription: generatedDescription || existingSession.generatedDescription,\n            updatedAt: new Date(),\n          })\n          .where(eq(scrapeSessionTable.id, existingSession.id))\n          .returning();\n        \n        console.log(`[Scrape Session] Updated session ${session.id} for user ${userId} (urlScraper: ${!!urlScraper}, pdfScraper: ${!!pdfScraper})`);\n      } else {\n        // Create new session\n        [session] = await heliumDb\n          .insert(scrapeSessionTable)\n          .values({\n            userId,\n            tenantId: tenantId || null,\n            scrapedProducts: {\n              urlScraper: urlScraper || null,\n              pdfScraper: pdfScraper || null,\n            },\n            generatedDescription: generatedDescription || null,\n          })\n          .returning();\n        \n        console.log(`[Scrape Session] Created new session ${session.id} for user ${userId}`);\n      }\n      \n      res.json({ success: true, session });\n    } catch (error: any) {\n      console.error('[Scrape Session] PUT error:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // DELETE scrape session (when user saves to project)\n  app.delete('/api/scrape-session', requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).userId;\n      const tenantId = (req as any).tenantId;\n      \n      await heliumDb\n        .delete(scrapeSessionTable)\n        .where(\n          and(\n            eq(scrapeSessionTable.userId, userId),\n            tenantId ? eq(scrapeSessionTable.tenantId, tenantId) : undefined\n          )\n        );\n      \n      console.log(`[Scrape Session] Deleted session for user ${userId}`);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('[Scrape Session] DELETE error:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // ===== BACKUP SYSTEM API ENDPOINTS =====\n  \n  // Create manual backup\n  app.post('/api/backups', requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).userId;\n      const tenantId = (req as any).tenantId;\n      const { backupType = 'manual' } = req.body;\n      \n      const { backupService } = await import('./services/backup-service');\n      \n      const backup = await backupService.createBackup({\n        tenantId,\n        userId,\n        backupType,\n        expiresInDays: 30,\n      });\n      \n      res.json({ success: true, backup });\n    } catch (error: any) {\n      console.error('[Backup API] Create failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // List all backups for tenant\n  app.get('/api/backups', requireAuth, async (req, res) => {\n    try {\n      const tenantId = (req as any).tenantId;\n      \n      const { backupService } = await import('./services/backup-service');\n      const backupsList = await backupService.listBackups(tenantId);\n      \n      res.json({ success: true, backups: backupsList });\n    } catch (error: any) {\n      console.error('[Backup API] List failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // Restore from backup\n  app.post('/api/backups/:id/restore', requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).userId;\n      const tenantId = (req as any).tenantId;\n      const { id } = req.params;\n      \n      const { backupService } = await import('./services/backup-service');\n      const result = await backupService.restoreBackup({\n        backupId: id,\n        tenantId,\n        userId,\n      });\n      \n      res.json({ ...result, success: true });\n    } catch (error: any) {\n      console.error('[Backup API] Restore failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // Delete backup\n  app.delete('/api/backups/:id', requireAuth, async (req, res) => {\n    try {\n      const tenantId = (req as any).tenantId;\n      const { id } = req.params;\n      \n      const { backupService } = await import('./services/backup-service');\n      await backupService.deleteBackup(id, tenantId);\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('[Backup API] Delete failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // Get audit logs (Admin only)\n  app.get('/api/audit-logs', requireSuperAdmin, async (req, res) => {\n    try {\n      const { limit = 100, offset = 0, resourceType, userId } = req.query;\n      \n      let query = heliumDb\n        .select()\n        .from(auditLogsTable)\n        .orderBy(sql`${auditLogsTable.createdAt} DESC`)\n        .limit(Number(limit))\n        .offset(Number(offset));\n      \n      if (resourceType) {\n        query = query.where(eq(auditLogsTable.resourceType, String(resourceType)));\n      }\n      \n      if (userId) {\n        query = query.where(eq(auditLogsTable.userId, String(userId)));\n      }\n      \n      const logs = await query;\n      \n      res.json({ success: true, logs });\n    } catch (error: any) {\n      console.error('[Audit API] List failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // ===== PERMISSION SYSTEM API ENDPOINTS =====\n  \n  // Grant permission to user\n  app.post('/api/permissions', requireSuperAdmin, async (req, res) => {\n    try {\n      const { userId, resource, action, scope, conditions } = req.body;\n      const tenantId = (req as any).tenantId;\n      \n      const { permissionService } = await import('./services/permission-service');\n      \n      const permission = await permissionService.grantPermission({\n        userId,\n        tenantId,\n        resource,\n        action,\n        scope,\n        conditions,\n      });\n      \n      res.json({ success: true, permission });\n    } catch (error: any) {\n      console.error('[Permission API] Grant failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // List user permissions\n  app.get('/api/permissions/:userId', requireAuth, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      const requestingUserId = (req as any).userId;\n      const isAdmin = (req as any).user?.isAdmin;\n      \n      if (!isAdmin && requestingUserId !== userId) {\n        return res.status(403).json({ \n          success: false, \n          error: 'Sie knnen nur Ihre eigenen Berechtigungen einsehen.' \n        });\n      }\n      \n      const { permissionService } = await import('./services/permission-service');\n      const userPermissions = await permissionService.listUserPermissions(userId);\n      \n      res.json({ success: true, permissions: userPermissions });\n    } catch (error: any) {\n      console.error('[Permission API] List failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // Revoke permission\n  app.delete('/api/permissions/:id', requireSuperAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const { permissionService } = await import('./services/permission-service');\n      await permissionService.revokePermission(id);\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('[Permission API] Revoke failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n  \n  // Update user role\n  app.put('/api/users/:userId/role', requireSuperAdmin, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      const { role } = req.body;\n      \n      const allowedRoles = ['admin', 'editor', 'viewer', 'project_manager', 'member'];\n      if (!allowedRoles.includes(role)) {\n        return res.status(400).json({ \n          success: false, \n          error: `Ungltige Rolle. Erlaubt: ${allowedRoles.join(', ')}` \n        });\n      }\n      \n      const { permissionService } = await import('./services/permission-service');\n      const user = await permissionService.updateUserRole(userId, role);\n      \n      res.json({ success: true, user });\n    } catch (error: any) {\n      console.error('[Permission API] Role update failed:', error);\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // Mount webhook routes\n  app.use('/api/webhooks', webhooksRouter);\n\n  // Mount mapping routes\n  app.use('/api', mappingRouter);\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":87240},"server/supabase-storage.ts":{"content":"import { supabase, supabaseAdmin } from './supabase';\nimport { encryptionService } from './services/encryption-service';\nimport { db as heliumDb } from './db'; // Helium/Neon PostgreSQL client\nimport { eq, desc, and } from 'drizzle-orm';\nimport { users as usersTable, tenants as tenantsTable, suppliers as suppliersTable, projects as projectsTable, productsInProjects as productsInProjectsTable } from '@shared/schema';\n\n// Use admin client for backend operations to bypass RLS\nconst db = supabaseAdmin || supabase;\nimport type {\n  Project,\n  CreateProject,\n  ProductInProject,\n  CreateProductInProject,\n  UpdateProductInProject,\n  Template,\n  Supplier,\n  CreateSupplier,\n  UpdateSupplier,\n  User,\n  RegisterUser,\n  CreateTenant,\n  UpdateTenant,\n  TenantSettings\n} from '@shared/schema';\n\nexport interface Tenant {\n  id: string;\n  name: string;\n  slug: string;\n  settings: TenantSettings;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface IStorage {\n  createUser(data: RegisterUser): Promise<User>;\n  getUserById(id: string): Promise<User | null>;\n  getUserByEmail(email: string): Promise<User & { passwordHash: string } | null>;\n  getUserByUsername(username: string): Promise<User & { passwordHash: string } | null>;\n  getAllUsers(): Promise<User[]>;\n  updateUserSubscription(userId: string, data: {\n    stripeCustomerId?: string;\n    subscriptionStatus?: string;\n    subscriptionId?: string;\n    planId?: string;\n    currentPeriodEnd?: string;\n    apiCallsLimit?: number;\n  }): Promise<User | null>;\n  incrementApiCalls(userId: string): Promise<void>;\n  resetApiCalls(userId: string): Promise<void>;\n  \n  createProject(userId: string, data: CreateProject): Promise<Project>;\n  getProjects(): Promise<Project[]>;\n  getProjectsByUserId(userId: string): Promise<Project[]>;\n  getProject(id: string, userId?: string): Promise<Project | null>;\n  deleteProject(id: string, userId?: string): Promise<boolean>;\n  \n  createProduct(projectId: string, data: CreateProductInProject, userId?: string): Promise<ProductInProject>;\n  getProducts(projectId: string, userId?: string): Promise<ProductInProject[]>;\n  getProduct(id: string, userId?: string): Promise<ProductInProject | null>;\n  updateProduct(id: string, data: UpdateProductInProject, userId?: string): Promise<ProductInProject | null>;\n  deleteProduct(id: string, userId?: string): Promise<boolean>;\n  \n  createTemplate(name: string, content: string, isDefault?: boolean): Promise<Template>;\n  getTemplates(userId?: string): Promise<Template[]>;\n  getTemplate(id: string): Promise<Template | null>;\n  deleteTemplate(id: string): Promise<boolean>;\n  \n  createSupplier(userId: string, data: CreateSupplier): Promise<Supplier>;\n  getSuppliers(userId: string): Promise<Supplier[]>;\n  getSupplier(id: string): Promise<Supplier | null>;\n  updateSupplier(id: string, data: UpdateSupplier): Promise<Supplier | null>;\n  deleteSupplier(id: string): Promise<boolean>;\n  \n  updateProductPixiStatus(productId: string, pixiData: {\n    pixi_status: 'NEU' | 'VORHANDEN';\n    pixi_ean: string | null;\n    pixi_checked_at: string;\n  }): Promise<boolean>;\n  batchUpdateProductsPixiStatus(updates: Array<{\n    id: string;\n    pixi_status: 'NEU' | 'VORHANDEN';\n    pixi_ean: string | null;\n    pixi_checked_at: string;\n  }>): Promise<boolean>;\n}\n\nexport class SupabaseStorage implements IStorage {\n  private safeDecrypt(ciphertext: string | null | undefined): string | null {\n    try {\n      return encryptionService.decrypt(ciphertext);\n    } catch (error) {\n      console.error('[Storage] Decryption failed, returning null:', error);\n      return null;\n    }\n  }\n\n  async createUser(data: RegisterUser): Promise<User> {\n    throw new Error('Use Supabase Auth signUp instead');\n  }\n\n  async getUserById(id: string): Promise<User | null> {\n    // CRITICAL: Use Helium/Neon DB directly (not Supabase remote DB!)\n    const users = await heliumDb.select().from(usersTable).where(eq(usersTable.id, id)).limit(1);\n    const user = users[0];\n\n    if (!user) return null;\n\n    return {\n      id: user.id,\n      email: user.email,\n      username: user.username || undefined,\n      isAdmin: user.isAdmin || false,\n      tenantId: user.tenantId || undefined,\n      role: user.role || 'member',\n      stripeCustomerId: user.stripeCustomerId || undefined,\n      subscriptionStatus: user.subscriptionStatus || undefined,\n      subscriptionId: user.subscriptionId || undefined,\n      planId: user.planId || undefined,\n      currentPeriodEnd: user.currentPeriodEnd || undefined,\n      apiCallsUsed: user.apiCallsUsed || 0,\n      apiCallsLimit: user.apiCallsLimit || 50,\n      createdAt: user.createdAt,\n      updatedAt: user.updatedAt,\n    };\n  }\n\n  async getUserByEmail(email: string): Promise<User & { passwordHash: string } | null> {\n    if (!supabaseAdmin) {\n      throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n    }\n\n    const { data: user, error } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .eq('email', email)\n      .single();\n\n    if (error || !user) return null;\n\n    return {\n      id: user.id,\n      email: user.email,\n      username: user.username || undefined,\n      isAdmin: user.is_admin || false,\n      tenantId: user.tenant_id || undefined,\n      role: user.role || 'member',\n      passwordHash: '', // Not used with Supabase Auth\n      stripeCustomerId: user.stripe_customer_id || undefined,\n      subscriptionStatus: user.subscription_status || undefined,\n      subscriptionId: user.subscription_id || undefined,\n      planId: user.plan_id || undefined,\n      currentPeriodEnd: user.current_period_end || undefined,\n      apiCallsUsed: user.api_calls_used || 0,\n      apiCallsLimit: user.api_calls_limit || 50,\n      createdAt: user.created_at,\n      updatedAt: user.updated_at,\n    };\n  }\n\n  async getUserByUsername(username: string): Promise<User & { passwordHash: string } | null> {\n    // CRITICAL: Query Helium DB directly (local PostgreSQL), not Supabase remote DB!\n    const users = await heliumDb.select()\n      .from(usersTable)\n      .where(eq(usersTable.username, username))\n      .limit(1);\n\n    if (!users || users.length === 0) return null;\n\n    const user = users[0];\n\n    return {\n      id: user.id,\n      email: user.email,\n      username: user.username || undefined,\n      isAdmin: user.isAdmin || false,\n      tenantId: user.tenantId || undefined,\n      role: user.role || 'member',\n      passwordHash: '', // Not used with Supabase Auth\n      stripeCustomerId: user.stripeCustomerId || undefined,\n      subscriptionStatus: user.subscriptionStatus || undefined,\n      subscriptionId: user.subscriptionId || undefined,\n      planId: user.planId || undefined,\n      currentPeriodEnd: user.currentPeriodEnd ? user.currentPeriodEnd.toISOString() : undefined,\n      apiCallsUsed: user.apiCallsUsed || 0,\n      apiCallsLimit: user.apiCallsLimit || 50,\n      createdAt: user.createdAt ? user.createdAt.toISOString() : new Date().toISOString(),\n      updatedAt: user.updatedAt ? user.updatedAt.toISOString() : new Date().toISOString(),\n    };\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    if (!supabaseAdmin) {\n      throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n    }\n\n    const { data: users, error } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .order('created_at');\n\n    if (error || !users) return [];\n\n    return users.map(user => ({\n      id: user.id,\n      email: user.email,\n      username: user.username || undefined,\n      isAdmin: user.is_admin || false,\n      tenantId: user.tenant_id || undefined,\n      role: user.role || 'member',\n      stripeCustomerId: user.stripe_customer_id || undefined,\n      subscriptionStatus: user.subscription_status || undefined,\n      subscriptionId: user.subscription_id || undefined,\n      planId: user.plan_id || undefined,\n      currentPeriodEnd: user.current_period_end || undefined,\n      apiCallsUsed: user.api_calls_used || 0,\n      apiCallsLimit: user.api_calls_limit || 50,\n      createdAt: user.created_at,\n      updatedAt: user.updated_at,\n    }));\n  }\n\n  async updateUserSubscription(userId: string, data: {\n    stripeCustomerId?: string;\n    subscriptionStatus?: string;\n    subscriptionId?: string;\n    planId?: string;\n    currentPeriodEnd?: string;\n    apiCallsLimit?: number;\n  }): Promise<User | null> {\n    if (!supabaseAdmin) {\n      throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n    }\n\n    const updateData: any = {};\n    if (data.stripeCustomerId) updateData.stripe_customer_id = data.stripeCustomerId;\n    if (data.subscriptionStatus) updateData.subscription_status = data.subscriptionStatus;\n    if (data.subscriptionId) updateData.subscription_id = data.subscriptionId;\n    if (data.planId) updateData.plan_id = data.planId;\n    if (data.currentPeriodEnd) updateData.current_period_end = data.currentPeriodEnd;\n    if (data.apiCallsLimit !== undefined) updateData.api_calls_limit = data.apiCallsLimit;\n\n    const { data: user, error } = await supabaseAdmin\n      .from('users')\n      .update(updateData)\n      .eq('id', userId)\n      .select()\n      .single();\n\n    if (error || !user) return null;\n\n    return {\n      id: user.id,\n      email: user.email,\n      username: user.username || undefined,\n      isAdmin: user.is_admin || false,\n      role: user.role || 'member',\n      stripeCustomerId: user.stripe_customer_id || undefined,\n      subscriptionStatus: user.subscription_status || undefined,\n      subscriptionId: user.subscription_id || undefined,\n      planId: user.plan_id || undefined,\n      currentPeriodEnd: user.current_period_end || undefined,\n      apiCallsUsed: user.api_calls_used || 0,\n      apiCallsLimit: user.api_calls_limit || 50,\n      createdAt: user.created_at,\n      updatedAt: user.updated_at,\n    };\n  }\n\n  async incrementApiCalls(userId: string): Promise<void> {\n    if (!supabaseAdmin) {\n      throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n    }\n\n    const { data: user } = await supabaseAdmin\n      .from('users')\n      .select('api_calls_used')\n      .eq('id', userId)\n      .single();\n\n    if (user) {\n      await supabaseAdmin\n        .from('users')\n        .update({ api_calls_used: (user.api_calls_used || 0) + 1 })\n        .eq('id', userId);\n    }\n  }\n\n  async resetApiCalls(userId: string): Promise<void> {\n    if (!supabaseAdmin) {\n      throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n    }\n\n    await supabaseAdmin\n      .from('users')\n      .update({ api_calls_used: 0 })\n      .eq('id', userId);\n  }\n\n  async createProject(userId: string, data: CreateProject): Promise<Project> {\n    const user = await this.getUserById(userId);\n    if (!user) throw new Error('User not found');\n    \n    if (!user.tenantId) {\n      console.error(`[SECURITY CRITICAL] User ${userId} has NO tenant_id - cannot create project`);\n      throw new Error('User must belong to an organization to create projects');\n    }\n\n    console.log('[createProject] Attempting to insert:', {\n      user_id: userId,\n      tenant_id: user.tenantId,\n      name: data.name,\n    });\n\n    // Use Helium DB in development, Supabase in production\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (isDevelopment) {\n      // Use Drizzle ORM with Helium DB\n      const [project] = await heliumDb\n        .insert(projectsTable)\n        .values({\n          userId,\n          tenantId: user.tenantId,\n          name: data.name,\n        })\n        .returning();\n\n      if (!project) {\n        throw new Error('Failed to create project: No data returned');\n      }\n\n      return {\n        id: project.id,\n        name: project.name,\n        createdAt: project.createdAt!.toISOString(),\n      };\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { data: project, error } = await supabaseAdmin\n        .from('projects')\n        .insert({\n          user_id: userId,\n          tenant_id: user.tenantId,\n          name: data.name,\n        })\n        .select()\n        .single();\n\n      if (error) {\n        console.error('[createProject] Supabase error:', JSON.stringify(error, null, 2));\n        throw new Error(`Failed to create project: ${error.message}`);\n      }\n      \n      if (!project) {\n        console.error('[createProject] No project returned but no error');\n        throw new Error('Failed to create project: No data returned');\n      }\n\n      return {\n        id: project.id,\n        name: project.name,\n        createdAt: project.created_at,\n      };\n    }\n  }\n\n  async getProjects(): Promise<Project[]> {\n    throw new Error('Use getProjectsByUserId instead - organization filtering required');\n  }\n\n  async getProjectsByUserId(userId: string): Promise<Project[]> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    const user = await this.getUserById(userId);\n    if (!user) return [];\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      let query = heliumDb\n        .select()\n        .from(projectsTable)\n        .where(eq(projectsTable.userId, userId))\n        .orderBy(desc(projectsTable.createdAt));\n\n      const projects = await query;\n\n      return projects.map((p: any) => ({\n        id: p.id,\n        name: p.name,\n        createdAt: p.createdAt!.toISOString(),\n      }));\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const query = supabaseAdmin\n        .from('projects')\n        .select('*')\n        .eq('user_id', userId)\n        .order('created_at');\n\n      if (user.tenantId) {\n        query.eq('tenant_id', user.tenantId);\n      }\n\n      const { data: projects, error } = await query;\n\n      if (error || !projects) return [];\n\n      return projects.map(p => ({\n        id: p.id,\n        name: p.name,\n        createdAt: p.created_at,\n      }));\n    }\n  }\n\n  async getProject(id: string, userId?: string): Promise<Project | null> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      const [project] = await heliumDb\n        .select()\n        .from(projectsTable)\n        .where(eq(projectsTable.id, id))\n        .limit(1);\n\n      if (!project) return null;\n\n      if (userId) {\n        const user = await this.getUserById(userId);\n        if (!user) {\n          console.warn(`[SECURITY] Invalid user ${userId} tried to access project ${id}`);\n          return null;\n        }\n        \n        if (!user.tenantId) {\n          console.warn(`[SECURITY CRITICAL] User ${userId} has NO tenant_id - blocking ALL access`);\n          return null;\n        }\n        \n        if (!project.tenantId) {\n          console.warn(`[SECURITY CRITICAL] Project ${id} has NO tenant_id - blocking access (needs backfill)`);\n          return null;\n        }\n        \n        if (user.tenantId !== project.tenantId) {\n          console.warn(`[SECURITY] User ${userId} (org: ${user.tenantId}) tried to access project ${id} (org: ${project.tenantId})`);\n          return null;\n        }\n      }\n\n      return {\n        id: project.id,\n        name: project.name,\n        createdAt: project.createdAt!.toISOString(),\n      };\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { data: project, error } = await supabaseAdmin\n        .from('projects')\n        .select('*')\n        .eq('id', id)\n        .single();\n\n      if (error || !project) return null;\n\n      if (userId) {\n        const user = await this.getUserById(userId);\n        if (!user) {\n          console.warn(`[SECURITY] Invalid user ${userId} tried to access project ${id}`);\n          return null;\n        }\n        \n        if (!user.tenantId) {\n          console.warn(`[SECURITY CRITICAL] User ${userId} has NO tenant_id - blocking ALL access`);\n          return null;\n        }\n        \n        if (!project.tenant_id) {\n          console.warn(`[SECURITY CRITICAL] Project ${id} has NO tenant_id - blocking access (needs backfill)`);\n          return null;\n        }\n        \n        if (user.tenantId !== project.tenant_id) {\n          console.warn(`[SECURITY] User ${userId} (org: ${user.tenantId}) tried to access project ${id} (org: ${project.tenant_id})`);\n          return null;\n        }\n      }\n\n      return {\n        id: project.id,\n        name: project.name,\n        createdAt: project.created_at,\n      };\n    }\n  }\n\n  async deleteProject(id: string, userId?: string): Promise<boolean> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (userId) {\n      const project = await this.getProject(id, userId);\n      if (!project) {\n        console.warn(`[SECURITY] User ${userId} tried to delete project ${id} from different org`);\n        return false;\n      }\n    }\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      // First delete all products in this project (CASCADE delete)\n      await heliumDb\n        .delete(productsInProjectsTable)\n        .where(eq(productsInProjectsTable.projectId, id));\n      \n      // Then delete the project itself\n      await heliumDb\n        .delete(projectsTable)\n        .where(eq(projectsTable.id, id));\n      return true;\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      // First delete all products in this project (CASCADE delete)\n      await supabaseAdmin\n        .from('products_in_projects')\n        .delete()\n        .eq('project_id', id);\n\n      // Then delete the project itself\n      const { error } = await supabaseAdmin\n        .from('projects')\n        .delete()\n        .eq('id', id);\n\n      return !error;\n    }\n  }\n\n  async createProduct(projectId: string, data: CreateProductInProject, userId?: string): Promise<ProductInProject> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    const project = await this.getProject(projectId, userId);\n    if (!project) {\n      if (userId) console.warn(`[SECURITY] User ${userId} tried to create product in non-existent/unauthorized project ${projectId}`);\n      throw new Error('Project not found or access denied');\n    }\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      const [projectData] = await heliumDb\n        .select({ tenantId: projectsTable.tenantId })\n        .from(projectsTable)\n        .where(eq(projectsTable.id, projectId))\n        .limit(1);\n\n      const [product] = await heliumDb\n        .insert(productsInProjectsTable)\n        .values({\n          projectId,\n          tenantId: projectData?.tenantId || null,\n          name: data.name,\n          files: data.files || null,\n          htmlCode: data.htmlCode,\n          previewText: data.previewText,\n          extractedData: data.extractedData || null,\n          template: data.template,\n          customAttributes: data.customAttributes || null,\n          exactProductName: data.exactProductName,\n          articleNumber: data.articleNumber,\n          manufacturerArticleNumber: data.manufacturerArticleNumber,\n        })\n        .returning();\n\n      if (!product) throw new Error('Failed to create product');\n\n      return this.mapProduct(product);\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const projectData = await supabaseAdmin\n        .from('projects')\n        .select('tenant_id')\n        .eq('id', projectId)\n        .single();\n\n      const { data: product, error} = await supabaseAdmin\n        .from('products_in_projects')\n        .insert({\n          project_id: projectId,\n          tenant_id: projectData.data?.tenant_id || null,\n          name: data.name,\n          files: data.files || null,\n          html_code: data.htmlCode,\n          preview_text: data.previewText,\n          extracted_data: data.extractedData || null,\n          template: data.template,\n          custom_attributes: data.customAttributes || null,\n          exact_product_name: data.exactProductName,\n          article_number: data.articleNumber,\n          manufacturer_article_number: data.manufacturerArticleNumber,\n        })\n        .select()\n        .single();\n\n      if (error || !product) throw new Error('Failed to create product');\n\n      return this.mapProduct(product);\n    }\n  }\n\n  async getProducts(projectId: string, userId?: string): Promise<ProductInProject[]> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    const project = await this.getProject(projectId, userId);\n    if (!project) return [];\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      const products = await heliumDb\n        .select()\n        .from(productsInProjectsTable)\n        .where(eq(productsInProjectsTable.projectId, projectId))\n        .orderBy(desc(productsInProjectsTable.createdAt));\n\n      return products.map((p: any) => this.mapProduct(p));\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { data: products, error } = await supabaseAdmin\n        .from('products_in_projects')\n        .select('*')\n        .eq('project_id', projectId)\n        .order('created_at');\n\n      if (error || !products) return [];\n\n      return products.map(p => this.mapProduct(p));\n    }\n  }\n\n  async getProduct(id: string, userId?: string): Promise<ProductInProject | null> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      const [product] = await heliumDb\n        .select()\n        .from(productsInProjectsTable)\n        .where(eq(productsInProjectsTable.id, id))\n        .limit(1);\n\n      if (!product) return null;\n\n      if (userId) {\n        const user = await this.getUserById(userId);\n        if (!user) {\n          console.warn(`[SECURITY] Invalid user ${userId} tried to access product ${id}`);\n          return null;\n        }\n        \n        if (!user.tenantId) {\n          console.warn(`[SECURITY CRITICAL] User ${userId} has NO tenant_id - blocking ALL access`);\n          return null;\n        }\n        \n        if (!product.tenantId) {\n          console.warn(`[SECURITY CRITICAL] Product ${id} has NO tenant_id - blocking access (needs backfill)`);\n          return null;\n        }\n        \n        if (user.tenantId !== product.tenantId) {\n          console.warn(`[SECURITY] User ${userId} (org: ${user.tenantId}) tried to access product ${id} (org: ${product.tenantId})`);\n          return null;\n        }\n      }\n\n      return this.mapProduct(product);\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { data: product, error } = await supabaseAdmin\n        .from('products_in_projects')\n        .select('*')\n        .eq('id', id)\n        .single();\n\n      if (error || !product) return null;\n\n      if (userId) {\n        const user = await this.getUserById(userId);\n        if (!user) {\n          console.warn(`[SECURITY] Invalid user ${userId} tried to access product ${id}`);\n          return null;\n        }\n        \n        if (!user.tenantId) {\n          console.warn(`[SECURITY CRITICAL] User ${userId} has NO tenant_id - blocking ALL access`);\n          return null;\n        }\n        \n        if (!product.tenant_id) {\n          console.warn(`[SECURITY CRITICAL] Product ${id} has NO tenant_id - blocking access (needs backfill)`);\n          return null;\n        }\n        \n        if (user.tenantId !== product.tenant_id) {\n          console.warn(`[SECURITY] User ${userId} (org: ${user.tenantId}) tried to access product ${id} (org: ${product.tenant_id})`);\n          return null;\n        }\n      }\n\n      return this.mapProduct(product);\n    }\n  }\n\n  async updateProduct(id: string, data: UpdateProductInProject, userId?: string): Promise<ProductInProject | null> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (userId) {\n      const existingProduct = await this.getProduct(id, userId);\n      if (!existingProduct) {\n        console.warn(`[SECURITY] User ${userId} tried to update product ${id} from different org`);\n        return null;\n      }\n    }\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      const updateData: any = {};\n      if (data.name !== undefined) updateData.name = data.name;\n      if (data.files !== undefined) updateData.files = data.files;\n      if (data.htmlCode !== undefined) updateData.htmlCode = data.htmlCode;\n      if (data.previewText !== undefined) updateData.previewText = data.previewText;\n      if (data.extractedData !== undefined) updateData.extractedData = data.extractedData;\n      if (data.template !== undefined) updateData.template = data.template;\n      if (data.customAttributes !== undefined) updateData.customAttributes = data.customAttributes;\n      if (data.exactProductName !== undefined) updateData.exactProductName = data.exactProductName;\n      if (data.articleNumber !== undefined) updateData.articleNumber = data.articleNumber;\n      if (data.pixi_status !== undefined) updateData.pixiStatus = data.pixi_status;\n      if (data.pixi_ean !== undefined) updateData.pixiEan = data.pixi_ean;\n      if (data.pixi_checked_at !== undefined) updateData.pixiCheckedAt = data.pixi_checked_at;\n\n      const [product] = await heliumDb\n        .update(productsInProjectsTable)\n        .set(updateData)\n        .where(eq(productsInProjectsTable.id, id))\n        .returning();\n\n      if (!product) return null;\n\n      return this.mapProduct(product);\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const updateData: any = {};\n      if (data.name !== undefined) updateData.name = data.name;\n      if (data.files !== undefined) updateData.files = data.files;\n      if (data.htmlCode !== undefined) updateData.html_code = data.htmlCode;\n      if (data.previewText !== undefined) updateData.preview_text = data.previewText;\n      if (data.extractedData !== undefined) updateData.extracted_data = data.extractedData;\n      if (data.template !== undefined) updateData.template = data.template;\n      if (data.customAttributes !== undefined) updateData.custom_attributes = data.customAttributes;\n      if (data.exactProductName !== undefined) updateData.exact_product_name = data.exactProductName;\n      if (data.articleNumber !== undefined) updateData.article_number = data.articleNumber;\n      if (data.pixi_status !== undefined) updateData.pixi_status = data.pixi_status;\n      if (data.pixi_ean !== undefined) updateData.pixi_ean = data.pixi_ean;\n      if (data.pixi_checked_at !== undefined) updateData.pixi_checked_at = data.pixi_checked_at;\n\n      const { data: product, error } = await supabaseAdmin\n        .from('products_in_projects')\n        .update(updateData)\n        .eq('id', id)\n        .select()\n        .single();\n\n      if (error || !product) return null;\n\n      return this.mapProduct(product);\n    }\n  }\n\n  async deleteProduct(id: string, userId?: string): Promise<boolean> {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n\n    if (userId) {\n      const product = await this.getProduct(id, userId);\n      if (!product) {\n        console.warn(`[SECURITY] User ${userId} tried to delete product ${id} from different org`);\n        return false;\n      }\n    }\n\n    if (isDevelopment) {\n      // Use Helium DB in development\n      await heliumDb\n        .delete(productsInProjectsTable)\n        .where(eq(productsInProjectsTable.id, id));\n      return true;\n    } else {\n      // Use Supabase in production\n      if (!supabaseAdmin) {\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY not configured');\n      }\n\n      const { error } = await supabaseAdmin\n        .from('products_in_projects')\n        .delete()\n        .eq('id', id);\n\n      return !error;\n    }\n  }\n\n  async createTemplate(name: string, content: string, isDefault?: boolean): Promise<Template> {\n    const { data: template, error } = await supabase\n      .from('templates')\n      .insert({\n        name,\n        content,\n        is_default: isDefault || false,\n      })\n      .select()\n      .single();\n\n    if (error || !template) throw new Error('Failed to create template');\n\n    return {\n      id: template.id,\n      name: template.name,\n      content: template.content,\n      isDefault: template.is_default || false,\n    };\n  }\n\n  async getTemplates(userId?: string): Promise<Template[]> {\n    let tenantId: string | null = null;\n    \n    if (userId) {\n      const user = await this.getUserById(userId);\n      tenantId = user?.tenantId || null;\n    }\n\n    const query = supabase\n      .from('templates')\n      .select('*')\n      .order('created_at');\n\n    if (tenantId) {\n      query.or(`tenant_id.eq.${tenantId},tenant_id.is.null`);\n    } else {\n      query.is('tenant_id', null);\n    }\n\n    const { data: templates, error } = await query;\n\n    if (error || !templates) return [];\n\n    return templates.map(t => ({\n      id: t.id,\n      name: t.name,\n      content: t.content,\n      isDefault: t.is_default || false,\n    }));\n  }\n\n  async getTemplate(id: string): Promise<Template | null> {\n    const { data: template, error } = await supabase\n      .from('templates')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (error || !template) return null;\n\n    return {\n      id: template.id,\n      name: template.name,\n      content: template.content,\n      isDefault: template.is_default || false,\n    };\n  }\n\n  async deleteTemplate(id: string): Promise<boolean> {\n    const { error } = await supabase\n      .from('templates')\n      .delete()\n      .eq('id', id);\n\n    return !error;\n  }\n\n  async createSupplier(userId: string, data: CreateSupplier): Promise<Supplier> {\n    const user = await this.getUserById(userId);\n    if (!user) throw new Error('User not found');\n\n    const insertData: any = {\n      userId: userId,\n      tenantId: user.tenantId || null,\n      name: data.name,\n      supplNr: data.supplNr || null,\n      urlPattern: data.urlPattern || null,\n      description: data.description || null,\n      selectors: data.selectors || {},\n      productLinkSelector: data.productLinkSelector || null,\n      sessionCookies: encryptionService.encrypt(data.sessionCookies) || null,\n      userAgent: data.userAgent || null,\n      loginUrl: data.loginUrl || null,\n      loginUsernameField: data.loginUsernameField || null,\n      loginPasswordField: data.loginPasswordField || null,\n      loginUsername: data.loginUsername || null,\n      verifiedFields: data.verifiedFields || null,\n      lastVerifiedAt: data.lastVerifiedAt || null,\n    };\n\n    // SECURITY: Encrypt password before storing\n    if (data.loginPassword) {\n      insertData.loginPassword = encryptionService.encrypt(data.loginPassword);\n    }\n\n    // CRITICAL: Use Helium DB with Drizzle (same as reads!)\n    const [newSupplier] = await heliumDb\n      .insert(suppliersTable)\n      .values(insertData)\n      .returning();\n\n    if (!newSupplier) throw new Error('Failed to create supplier');\n\n    return {\n      id: newSupplier.id,\n      name: newSupplier.name,\n      supplNr: newSupplier.supplNr || undefined,\n      urlPattern: newSupplier.urlPattern || undefined,\n      description: newSupplier.description || undefined,\n      selectors: newSupplier.selectors as any,\n      productLinkSelector: newSupplier.productLinkSelector || undefined,\n      sessionCookies: newSupplier.sessionCookies || undefined,\n      userAgent: newSupplier.userAgent || undefined,\n      loginUrl: newSupplier.loginUrl || undefined,\n      loginUsernameField: newSupplier.loginUsernameField || undefined,\n      loginPasswordField: newSupplier.loginPasswordField || undefined,\n      loginUsername: newSupplier.loginUsername || undefined,\n      verifiedFields: newSupplier.verifiedFields || undefined,\n      lastVerifiedAt: newSupplier.lastVerifiedAt || undefined,\n      createdAt: newSupplier.createdAt!,\n      updatedAt: newSupplier.updatedAt!,\n    };\n  }\n\n  async getSuppliers(userId: string): Promise<Supplier[]> {\n    const user = await this.getUserById(userId);\n    if (!user) {\n      console.log('[getSuppliers] User not found:', userId);\n      return [];\n    }\n\n    // CRITICAL: Use Helium DB with Drizzle\n    let suppliers;\n    if (user.tenantId) {\n      console.log('[getSuppliers] Filtering by tenant_id:', user.tenantId);\n      suppliers = await heliumDb\n        .select()\n        .from(suppliersTable)\n        .where(eq(suppliersTable.tenantId, user.tenantId))\n        .orderBy(suppliersTable.name);\n    } else {\n      console.log('[getSuppliers] Filtering by user_id:', userId);\n      suppliers = await heliumDb\n        .select()\n        .from(suppliersTable)\n        .where(eq(suppliersTable.userId, userId))\n        .orderBy(suppliersTable.name);\n    }\n\n    console.log('[getSuppliers] Found suppliers:', suppliers.length);\n    \n    return suppliers.map((s: any) => ({\n      id: s.id,\n      userId: s.userId,\n      tenantId: s.tenantId || undefined,\n      name: s.name,\n      supplNr: s.supplNr || undefined,\n      urlPattern: s.urlPattern || undefined,\n      description: s.description || undefined,\n      selectors: s.selectors as any,\n      productLinkSelector: s.productLinkSelector || undefined,\n      sessionCookies: this.safeDecrypt(s.sessionCookies) || undefined,\n      userAgent: s.userAgent || undefined,\n      loginUrl: s.loginUrl || undefined,\n      loginUsernameField: s.loginUsernameField || undefined,\n      loginPasswordField: s.loginPasswordField || undefined,\n      loginUsername: s.loginUsername || undefined,\n      exportMappings: s.exportMappings as any || undefined,\n      verifiedFields: s.verifiedFields || undefined,\n      lastVerifiedAt: s.lastVerifiedAt || undefined,\n      createdAt: s.createdAt!,\n      updatedAt: s.updatedAt!,\n    }));\n  }\n\n  async getSupplier(id: string): Promise<Supplier | null> {\n    // Use Helium DB with Drizzle instead of Supabase to avoid RLS issues\n    const [supplier] = await heliumDb\n      .select()\n      .from(suppliersTable)\n      .where(eq(suppliersTable.id, id))\n      .limit(1);\n\n    if (!supplier) return null;\n\n    return {\n      id: supplier.id,\n      name: supplier.name,\n      supplNr: supplier.supplNr || undefined,\n      urlPattern: supplier.urlPattern || undefined,\n      description: supplier.description || undefined,\n      selectors: supplier.selectors as any,\n      productLinkSelector: supplier.productLinkSelector || undefined,\n      sessionCookies: this.safeDecrypt(supplier.sessionCookies) || undefined,\n      userAgent: supplier.userAgent || undefined,\n      loginUrl: supplier.loginUrl || undefined,\n      loginUsernameField: supplier.loginUsernameField || undefined,\n      loginPasswordField: supplier.loginPasswordField || undefined,\n      loginUsername: supplier.loginUsername || undefined,\n      loginPassword: this.safeDecrypt(supplier.loginPassword) || undefined,\n      verifiedFields: supplier.verifiedFields || undefined,\n      lastVerifiedAt: supplier.lastVerifiedAt || undefined,\n      createdAt: supplier.createdAt!,\n      updatedAt: supplier.updatedAt!,\n    };\n  }\n\n  async updateSupplier(id: string, data: UpdateSupplier): Promise<Supplier | null> {\n    const updateData: any = { updatedAt: new Date() };\n    if (data.name !== undefined) updateData.name = data.name;\n    if (data.supplNr !== undefined) updateData.supplNr = data.supplNr;\n    if (data.urlPattern !== undefined) updateData.urlPattern = data.urlPattern;\n    if (data.description !== undefined) updateData.description = data.description;\n    if (data.selectors !== undefined) updateData.selectors = data.selectors;\n    if (data.productLinkSelector !== undefined) updateData.productLinkSelector = data.productLinkSelector;\n    if (data.sessionCookies !== undefined) updateData.sessionCookies = data.sessionCookies ? encryptionService.encrypt(data.sessionCookies) : null;\n    if (data.userAgent !== undefined) updateData.userAgent = data.userAgent;\n    if (data.loginUrl !== undefined) updateData.loginUrl = data.loginUrl;\n    if (data.loginUsernameField !== undefined) updateData.loginUsernameField = data.loginUsernameField;\n    if (data.loginPasswordField !== undefined) updateData.loginPasswordField = data.loginPasswordField;\n    if (data.loginUsername !== undefined) updateData.loginUsername = data.loginUsername;\n    if (data.verifiedFields !== undefined) updateData.verifiedFields = data.verifiedFields || null;\n    if (data.lastVerifiedAt !== undefined) updateData.lastVerifiedAt = data.lastVerifiedAt;\n    \n    // SECURITY: Encrypt password before storing (or clear if null)\n    if (data.loginPassword !== undefined) {\n      updateData.loginPassword = data.loginPassword ? encryptionService.encrypt(data.loginPassword) : null;\n    }\n\n    // CRITICAL: Use Helium DB with Drizzle (same as reads!)\n    const [updatedSupplier] = await heliumDb\n      .update(suppliersTable)\n      .set(updateData)\n      .where(eq(suppliersTable.id, id))\n      .returning();\n\n    if (!updatedSupplier) return null;\n\n    return {\n      id: updatedSupplier.id,\n      name: updatedSupplier.name,\n      supplNr: updatedSupplier.supplNr || undefined,\n      urlPattern: updatedSupplier.urlPattern || undefined,\n      description: updatedSupplier.description || undefined,\n      selectors: updatedSupplier.selectors as any,\n      productLinkSelector: updatedSupplier.productLinkSelector || undefined,\n      sessionCookies: updatedSupplier.sessionCookies || undefined,\n      userAgent: updatedSupplier.userAgent || undefined,\n      loginUrl: updatedSupplier.loginUrl || undefined,\n      loginUsernameField: updatedSupplier.loginUsernameField || undefined,\n      loginPasswordField: updatedSupplier.loginPasswordField || undefined,\n      loginUsername: updatedSupplier.loginUsername || undefined,\n      verifiedFields: updatedSupplier.verifiedFields || undefined,\n      lastVerifiedAt: updatedSupplier.lastVerifiedAt || undefined,\n      createdAt: updatedSupplier.createdAt!,\n      updatedAt: updatedSupplier.updatedAt!,\n    };\n  }\n\n  async deleteSupplier(id: string): Promise<boolean> {\n    // CRITICAL: Use Helium DB with Drizzle (same as reads!)\n    await heliumDb\n      .delete(suppliersTable)\n      .where(eq(suppliersTable.id, id));\n\n    return true;\n  }\n\n  async updateProductPixiStatus(productId: string, pixiData: {\n    pixi_status: 'NEU' | 'VORHANDEN';\n    pixi_ean: string | null;\n    pixi_checked_at: string;\n  }): Promise<boolean> {\n    const { error } = await supabase\n      .from('products_in_projects')\n      .update({\n        pixi_status: pixiData.pixi_status,\n        pixi_ean: pixiData.pixi_ean,\n        pixi_checked_at: pixiData.pixi_checked_at,\n      })\n      .eq('id', productId);\n\n    return !error;\n  }\n\n  async batchUpdateProductsPixiStatus(updates: Array<{\n    id: string;\n    pixi_status: 'NEU' | 'VORHANDEN';\n    pixi_ean: string | null;\n    pixi_checked_at: string;\n  }>): Promise<boolean> {\n    try {\n      const timestamp = new Date().toISOString();\n      \n      for (const update of updates) {\n        const { error } = await supabase\n          .from('products_in_projects')\n          .update({\n            pixi_status: update.pixi_status,\n            pixi_ean: update.pixi_ean,\n            pixi_checked_at: update.pixi_checked_at || timestamp,\n          })\n          .eq('id', update.id);\n\n        if (error) {\n          console.error(`[Supabase] Failed to update product ${update.id}:`, error);\n          return false;\n        }\n      }\n\n      console.log(`[Supabase] Successfully updated ${updates.length} products with Pixi status`);\n      return true;\n    } catch (error) {\n      console.error('[Supabase] Batch update failed:', error);\n      return false;\n    }\n  }\n\n  private mapProduct(product: any): ProductInProject {\n    // Support both snake_case (Supabase) and camelCase (Drizzle/Helium)\n    return {\n      id: product.id,\n      projectId: product.projectId || product.project_id,\n      name: product.name || undefined,\n      files: product.files || undefined,\n      htmlCode: product.htmlCode || product.html_code || undefined,\n      previewText: product.previewText || product.preview_text || undefined,\n      extractedData: product.extractedData || product.extracted_data || undefined,\n      template: product.template || undefined,\n      customAttributes: product.customAttributes || product.custom_attributes || undefined,\n      exactProductName: product.exactProductName || product.exact_product_name || undefined,\n      articleNumber: product.articleNumber || product.article_number || undefined,\n      pixi_status: product.pixi_status || undefined,\n      pixi_ean: product.pixi_ean || undefined,\n      pixi_checked_at: product.pixi_checked_at || undefined,\n      createdAt: product.createdAt?.toISOString?.() || product.created_at,\n    };\n  }\n\n  private mapSupplier(supplier: any): Supplier {\n    // SECURITY: DO NOT return decrypted password in API responses\n    // Password is only decrypted internally when needed for login\n    return {\n      id: supplier.id,\n      name: supplier.name,\n      supplNr: supplier.suppl_nr || undefined,\n      urlPattern: supplier.url_pattern || undefined,\n      description: supplier.description || undefined,\n      selectors: supplier.selectors || {},\n      productLinkSelector: supplier.product_link_selector || undefined,\n      sessionCookies: supplier.session_cookies || undefined,\n      userAgent: supplier.user_agent || undefined,\n      loginUrl: supplier.login_url || undefined,\n      loginUsernameField: supplier.login_username_field || undefined,\n      loginPasswordField: supplier.login_password_field || undefined,\n      loginUsername: supplier.login_username || undefined,\n      loginPassword: undefined, // SECURITY: Never expose password to clients\n      verifiedFields: supplier.verified_fields ? JSON.parse(supplier.verified_fields) : undefined,\n      lastVerifiedAt: supplier.last_verified_at || undefined,\n      createdAt: supplier.created_at,\n      updatedAt: supplier.updated_at,\n    };\n  }\n\n  /**\n   * Internal method to get supplier with decrypted password for login purposes\n   * SECURITY: Only use this internally, never expose to API responses\n   */\n  async getSupplierWithCredentials(id: string): Promise<Supplier | null> {\n    // Use Helium DB (development environment) - suppliers are stored there\n    const suppliers = await heliumDb\n      .select()\n      .from(suppliersTable)\n      .where(eq(suppliersTable.id, id))\n      .limit(1);\n\n    const supplier = suppliers[0];\n    if (!supplier) {\n      console.log(`[getSupplierWithCredentials] No supplier found in Helium for ID: ${id}`);\n      return null;\n    }\n\n    // Decrypt password for internal use\n    let decryptedPassword: string | undefined = undefined;\n    if (supplier.loginPassword) {\n      decryptedPassword = this.safeDecrypt(supplier.loginPassword) || undefined;\n    }\n\n    return {\n      ...supplier,\n      loginPassword: decryptedPassword\n    };\n  }\n\n  // Tenant Management Methods\n  async getAllTenants(): Promise<Tenant[]> {\n    const tenants = await heliumDb.select().from(tenantsTable).orderBy(desc(tenantsTable.createdAt));\n\n    return tenants.map((tenant: any) => ({\n      id: tenant.id,\n      name: tenant.name,\n      slug: tenant.slug,\n      settings: tenant.settings as TenantSettings || {},\n      createdAt: tenant.createdAt!,\n      updatedAt: tenant.updatedAt!,\n    }));\n  }\n\n  async getTenant(id: string): Promise<Tenant | null> {\n    const tenants = await heliumDb.select().from(tenantsTable).where(eq(tenantsTable.id, id)).limit(1);\n    const tenant = tenants[0];\n\n    if (!tenant) return null;\n\n    return {\n      id: tenant.id,\n      name: tenant.name,\n      slug: tenant.slug,\n      settings: tenant.settings as TenantSettings || {},\n      createdAt: tenant.createdAt!,\n      updatedAt: tenant.updatedAt!,\n    };\n  }\n\n  async getTenantBySlug(slug: string): Promise<Tenant | null> {\n    const tenants = await heliumDb.select().from(tenantsTable).where(eq(tenantsTable.slug, slug)).limit(1);\n    const tenant = tenants[0];\n\n    if (!tenant) return null;\n\n    return {\n      id: tenant.id,\n      name: tenant.name,\n      slug: tenant.slug,\n      settings: tenant.settings as TenantSettings || {},\n      createdAt: tenant.createdAt!,\n      updatedAt: tenant.updatedAt!,\n    };\n  }\n\n  async createTenant(data: CreateTenant): Promise<Tenant> {\n    // Generate slug from name if not provided\n    const slug = data.slug || data.name.toLowerCase()\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+|-+$/g, '');\n\n    // Default settings with all features enabled\n    const defaultSettings: TenantSettings = {\n      features: {\n        pixiIntegration: false,\n        sapIntegration: false,\n        urlScraper: true,\n        csvBulkImport: true,\n        aiDescriptions: true,\n      },\n      erp: {\n        type: null,\n      },\n      ...data.settings,\n    };\n\n    const result = await heliumDb.insert(tenantsTable).values({\n      name: data.name,\n      slug,\n      settings: defaultSettings,\n    }).returning();\n\n    const tenant = result[0];\n\n    if (!tenant) {\n      throw new Error(`Failed to create tenant`);\n    }\n\n    return {\n      id: tenant.id,\n      name: tenant.name,\n      slug: tenant.slug,\n      settings: tenant.settings as TenantSettings || {},\n      createdAt: tenant.createdAt!,\n      updatedAt: tenant.updatedAt!,\n    };\n  }\n\n  async updateTenant(id: string, data: UpdateTenant): Promise<Tenant | null> {\n    const updates: any = {\n      updatedAt: new Date(),\n    };\n\n    if (data.name) updates.name = data.name;\n    if (data.settings) updates.settings = data.settings;\n\n    const result = await heliumDb\n      .update(tenantsTable)\n      .set(updates)\n      .where(eq(tenantsTable.id, id))\n      .returning();\n\n    const tenant = result[0];\n\n    if (!tenant) return null;\n\n    return {\n      id: tenant.id,\n      name: tenant.name,\n      slug: tenant.slug,\n      settings: tenant.settings as TenantSettings || {},\n      createdAt: tenant.createdAt!,\n      updatedAt: tenant.updatedAt!,\n    };\n  }\n\n  async deleteTenant(id: string): Promise<boolean> {\n    try {\n      await heliumDb.delete(tenantsTable).where(eq(tenantsTable.id, id));\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n\n  async getTenantStats(tenantId: string): Promise<{\n    userCount: number;\n    projectCount: number;\n    supplierCount: number;\n    subscriptionStatus?: string;\n    planId?: string;\n  }> {\n    const { data: users } = await db\n      .from('users')\n      .select('id, subscription_status, plan_id')\n      .eq('tenant_id', tenantId);\n\n    const { data: projects } = await db\n      .from('projects')\n      .select('id')\n      .eq('tenant_id', tenantId);\n\n    const { data: suppliers } = await db\n      .from('suppliers')\n      .select('id')\n      .eq('tenant_id', tenantId);\n\n    const owner = users?.[0];\n\n    return {\n      userCount: users?.length || 0,\n      projectCount: projects?.length || 0,\n      supplierCount: suppliers?.length || 0,\n      subscriptionStatus: owner?.subscription_status || 'trial',\n      planId: owner?.plan_id || 'trial',\n    };\n  }\n}\n\nexport const supabaseStorage = new SupabaseStorage();\n","size_bytes":47403},"client/src/pages/pixi-compare.tsx":{"content":"import { useState, useRef, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Upload, FileText, CheckCircle, XCircle, Download, Database, Save } from 'lucide-react';\nimport { useAuth } from '@/lib/auth-context';\nimport { useLocation } from 'wouter';\nimport type { Project, Supplier } from '@shared/schema';\n\ninterface ComparisonResult {\n  artikelnummer: string;\n  manufacturerArticleNumber?: string;\n  produktname: string;\n  ean: string;\n  hersteller: string;\n  pixi_status: 'NEU' | 'VORHANDEN';\n  pixi_ean: string | null;\n  originalData?: any;\n}\n\ninterface ComparisonResponse {\n  success: boolean;\n  summary: {\n    total: number;\n    neu: number;\n    vorhanden: number;\n  };\n  products: ComparisonResult[];\n  error?: string;\n}\n\nexport default function PixiComparePage() {\n  const { user } = useAuth();\n  const [, setLocation] = useLocation();\n  \n  // CSV Mode State\n  const [file, setFile] = useState<File | null>(null);\n  const [supplNr, setSupplNr] = useState('');\n  const [selectedCsvSupplier, setSelectedCsvSupplier] = useState<string>('');\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  // Project Mode State\n  const [projects, setProjects] = useState<Project[]>([]);\n  const [suppliers, setSuppliers] = useState<Supplier[]>([]);\n  const [selectedProject, setSelectedProject] = useState<string>('');\n  const [selectedSupplier, setSelectedSupplier] = useState<string>('');\n  const [manualSupplNr, setManualSupplNr] = useState<string>('');\n  const [loadingData, setLoadingData] = useState(false);\n  \n  // Shared State\n  const [loading, setLoading] = useState(false);\n  const [result, setResult] = useState<ComparisonResponse | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [activeTab, setActiveTab] = useState<'csv' | 'project'>('project');\n  \n  // Save Project Dialog State\n  const [showSaveDialog, setShowSaveDialog] = useState(false);\n  const [projectName, setProjectName] = useState('');\n  const [saving, setSaving] = useState(false);\n  \n  // Pagination for results table\n  const [currentPage, setCurrentPage] = useState(1);\n  const productsPerPage = 100; // Show more products to enable scrolling\n\n  useEffect(() => {\n    if (activeTab === 'project' || activeTab === 'csv') {\n      loadProjectsAndSuppliers();\n    }\n  }, [activeTab]);\n\n  // Check if data from Scrapers exists and auto-load\n  useEffect(() => {\n    const pdfData = sessionStorage.getItem('pixi_compare_data');\n    const pdfSource = sessionStorage.getItem('pixi_compare_source');\n    const pdfSupplNr = sessionStorage.getItem('pixi_compare_supplNr');\n    \n    if (pdfData && (pdfSource === 'pdf-scraper' || pdfSource === 'url-scraper')) {\n      try {\n        const csvData = JSON.parse(pdfData);\n        console.log(`[Pixi Compare] Auto-loading data from ${pdfSource}:`, csvData.length, 'products');\n        \n        if (!pdfSupplNr) {\n          console.error(`[Pixi Compare] Missing supplier number from ${pdfSource}`);\n          setError('Lieferantennummer fehlt. Bitte whlen Sie einen Lieferanten aus.');\n          // Clear sessionStorage\n          sessionStorage.removeItem('pixi_compare_data');\n          sessionStorage.removeItem('pixi_compare_source');\n          return;\n        }\n        \n        console.log('[Pixi Compare] Using supplier number:', pdfSupplNr);\n        \n        // Auto-trigger comparison with the stored supplier number\n        handleDirectDataCompare(csvData, pdfSupplNr);\n        \n        // Clear sessionStorage after loading\n        sessionStorage.removeItem('pixi_compare_data');\n        sessionStorage.removeItem('pixi_compare_source');\n        sessionStorage.removeItem('pixi_compare_supplNr');\n      } catch (error) {\n        console.error(`[Pixi Compare] Failed to parse ${pdfSource} data:`, error);\n      }\n    }\n  }, []);\n\n  const loadProjectsAndSuppliers = async () => {\n    setLoadingData(true);\n    try {\n      const token = localStorage.getItem('supabase_token');\n      \n      const [projectsRes, suppliersRes] = await Promise.all([\n        fetch('/api/projects', {\n          headers: { 'Authorization': `Bearer ${token}` },\n        }),\n        fetch('/api/suppliers', {\n          headers: { 'Authorization': `Bearer ${token}` },\n        }),\n      ]);\n\n      if (projectsRes.ok) {\n        const projectsData = await projectsRes.json();\n        setProjects(projectsData.projects || []);\n      }\n\n      if (suppliersRes.ok) {\n        const suppliersData = await suppliersRes.json();\n        setSuppliers(suppliersData.suppliers || []);\n      }\n    } catch (err: any) {\n      console.error('Failed to load data:', err);\n    } finally {\n      setLoadingData(false);\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    console.log('[Pixi Compare] File input changed:', e.target.files);\n    const selectedFile = e.target.files?.[0];\n    if (selectedFile) {\n      console.log('[Pixi Compare] File selected:', selectedFile.name, selectedFile.size, 'bytes');\n      if (!selectedFile.name.toLowerCase().endsWith('.csv')) {\n        console.error('[Pixi Compare] Invalid file type:', selectedFile.name);\n        setError('Bitte whlen Sie eine CSV-Datei aus');\n        return;\n      }\n      setFile(selectedFile);\n      setError(null);\n      setResult(null);\n      console.log('[Pixi Compare] File set successfully');\n    } else {\n      console.log('[Pixi Compare] No file selected');\n    }\n  };\n\n  const handleProjectCompare = async () => {\n    if (!selectedProject) {\n      setError('Bitte whlen Sie ein Projekt aus');\n      return;\n    }\n\n    if (!selectedSupplier && !manualSupplNr) {\n      setError('Bitte whlen Sie einen Lieferanten aus oder geben Sie eine Lieferantennummer ein');\n      return;\n    }\n\n    setLoading(true);\n    setError(null);\n    setResult(null);\n\n    try {\n      const token = localStorage.getItem('supabase_token');\n\n      const requestBody: any = {\n        projectId: selectedProject,\n      };\n\n      // Use supplier ID if selected, otherwise use manual supplNr\n      if (selectedSupplier) {\n        requestBody.supplierId = selectedSupplier;\n      } else if (manualSupplNr) {\n        requestBody.supplNr = manualSupplNr;\n      }\n\n      const response = await fetch('/api/pixi/compare-project', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(requestBody),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok || !data.success) {\n        throw new Error(data.error || 'Vergleich fehlgeschlagen');\n      }\n\n      setResult(data);\n    } catch (err: any) {\n      setError(err.message || 'Ein Fehler ist aufgetreten');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCSVCompare = async () => {\n    console.log('[Pixi Compare] CSV Compare button clicked');\n    console.log('[Pixi Compare] File:', file);\n    console.log('[Pixi Compare] SupplNr:', supplNr);\n    \n    if (!file) {\n      console.error('[Pixi Compare] No file selected');\n      setError('Bitte whlen Sie eine CSV-Datei aus');\n      return;\n    }\n\n    if (!supplNr) {\n      console.error('[Pixi Compare] No supplier number entered');\n      setError('Bitte geben Sie eine Lieferantennummer ein');\n      return;\n    }\n\n    setLoading(true);\n    setError(null);\n    setResult(null);\n\n    try {\n      const token = localStorage.getItem('supabase_token');\n      if (!token) {\n        console.error('[Pixi Compare] No authentication token found');\n        throw new Error('Nicht authentifiziert. Bitte melden Sie sich erneut an.');\n      }\n      \n      console.log('[Pixi Compare] Creating FormData...');\n      const formData = new FormData();\n      formData.append('csvFile', file);\n      formData.append('supplNr', supplNr);\n\n      console.log('[Pixi Compare] Sending request to /api/pixi/compare...');\n      const response = await fetch('/api/pixi/compare', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n        body: formData,\n      });\n\n      console.log('[Pixi Compare] Response status:', response.status);\n      const data = await response.json();\n      console.log('[Pixi Compare] Response data:', data);\n\n      if (!response.ok || !data.success) {\n        throw new Error(data.error || 'Vergleich fehlgeschlagen');\n      }\n\n      setResult(data);\n      console.log('[Pixi Compare] Comparison successful!');\n    } catch (err: any) {\n      console.error('[Pixi Compare] Error:', err);\n      setError(err.message || 'Ein Fehler ist aufgetreten');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleDirectDataCompare = async (csvData: any[], supplierNumber: string) => {\n    console.log('[Pixi Compare] Direct data comparison with', csvData.length, 'products');\n    \n    if (!supplierNumber) {\n      setError('Bitte geben Sie eine Lieferantennummer ein');\n      return;\n    }\n\n    setLoading(true);\n    setError(null);\n    setResult(null);\n    setActiveTab('csv'); // Switch to CSV tab to show results\n\n    try {\n      const token = localStorage.getItem('supabase_token');\n      if (!token) {\n        throw new Error('Nicht authentifiziert. Bitte melden Sie sich erneut an.');\n      }\n      \n      // Send JSON data instead of FormData\n      const response = await fetch('/api/pixi/compare-direct', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          products: csvData,\n          supplNr: supplierNumber,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok || !data.success) {\n        throw new Error(data.error || 'Vergleich fehlgeschlagen');\n      }\n\n      setResult(data);\n      setSupplNr(supplierNumber); // Update the UI with the supplier number\n      console.log('[Pixi Compare] Direct comparison successful!');\n    } catch (err: any) {\n      console.error('[Pixi Compare] Error:', err);\n      setError(err.message || 'Ein Fehler ist aufgetreten');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const downloadResults = () => {\n    if (!result) return;\n\n    // Helper function to escape CSV values\n    const escapeCsvValue = (value: any): string => {\n      if (value === null || value === undefined) return '';\n      const str = String(value);\n      // Escape quotes and wrap in quotes if contains comma, quote, or newline\n      if (str.includes(',') || str.includes('\"') || str.includes('\\n')) {\n        return `\"${str.replace(/\"/g, '\"\"')}\"`;\n      }\n      return str;\n    };\n\n    let csvRows: string[] = [];\n\n    // Check if we have originalData (Brickfox format)\n    if (result.products.length > 0 && result.products[0].originalData) {\n      // Get all column names from the first product's originalData\n      const firstProduct = result.products[0].originalData;\n      const columnNames = Object.keys(firstProduct);\n      \n      // Create header with original columns + Pixi Status\n      const headers = [...columnNames, 'Pixi_Status'];\n      csvRows.push(headers.join(','));\n\n      // Create data rows with all original data + Pixi columns\n      result.products.forEach(product => {\n        if (product.originalData) {\n          const rowValues = columnNames.map(col => \n            escapeCsvValue(product.originalData[col])\n          );\n          // Add Pixi status\n          rowValues.push(escapeCsvValue(product.pixi_status));\n          csvRows.push(rowValues.join(','));\n        }\n      });\n    } else {\n      // Fallback: Simple format if no originalData available\n      csvRows = [\n        ['Artikelnummer', 'Produktname', 'EAN', 'Hersteller', 'Pixi Status'].join(','),\n        ...result.products.map(p => \n          [\n            escapeCsvValue(p.artikelnummer),\n            escapeCsvValue(p.produktname),\n            escapeCsvValue(p.ean),\n            escapeCsvValue(p.hersteller),\n            escapeCsvValue(p.pixi_status)\n          ].join(',')\n        )\n      ];\n    }\n\n    const csvContent = csvRows.join('\\n');\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    link.href = URL.createObjectURL(blob);\n    link.download = `pixi-vergleich-${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();\n  };\n\n  const handleSaveAsProject = async () => {\n    if (!projectName.trim()) {\n      setError('Bitte geben Sie einen Projektnamen ein');\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const token = localStorage.getItem('supabase_token');\n\n      // Create new project\n      const projectResponse = await fetch('/api/projects', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          name: projectName.trim(),\n        }),\n      });\n\n      if (!projectResponse.ok) {\n        throw new Error('Projekt konnte nicht erstellt werden');\n      }\n\n      const projectData = await projectResponse.json();\n      const newProjectId = projectData.project.id;\n\n      // Convert comparison results to products and save them\n      const productsToSave = result!.products.map((p) => ({\n        name: p.produktname,\n        articleNumber: p.artikelnummer,\n        ean: p.ean,\n        manufacturer: p.hersteller,\n        pixi_status: p.pixi_status,\n      }));\n\n      for (const product of productsToSave) {\n        await fetch('/api/products', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${token}`,\n          },\n          body: JSON.stringify({\n            ...product,\n            projectId: newProjectId,\n          }),\n        });\n      }\n\n      // Navigate to the new project\n      setShowSaveDialog(false);\n      setProjectName('');\n      setLocation(`/projects/${newProjectId}`);\n    } catch (err: any) {\n      setError(err.message || 'Fehler beim Speichern des Projekts');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      <div className=\"max-w-6xl mx-auto space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold mb-2\">Pixi ERP Vergleich</h1>\n          <p className=\"text-muted-foreground\">\n            Vergleichen Sie Ihre Produktdaten mit dem Pixi ERP-System um neue Artikel zu identifizieren\n          </p>\n        </div>\n\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'csv' | 'project')} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-2\">\n            <TabsTrigger value=\"project\">\n              <Database className=\"mr-2 h-4 w-4\" />\n              Projekt-basiert\n            </TabsTrigger>\n            <TabsTrigger value=\"csv\">\n              <Upload className=\"mr-2 h-4 w-4\" />\n              CSV-Upload\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"project\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Projekt-basierter Vergleich</CardTitle>\n                <CardDescription>\n                  Whlen Sie ein Projekt und einen Lieferanten aus Ihrer Datenbank\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"project\">Projekt</Label>\n                  <Select\n                    value={selectedProject}\n                    onValueChange={setSelectedProject}\n                    disabled={loading || loadingData}\n                  >\n                    <SelectTrigger id=\"project\">\n                      <SelectValue placeholder=\"Projekt auswhlen...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {projects.map((project) => (\n                        <SelectItem key={project.id} value={project.id}>\n                          {project.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"supplier\">Lieferant (optional)</Label>\n                    <Select\n                      value={selectedSupplier}\n                      onValueChange={(value) => {\n                        setSelectedSupplier(value);\n                        if (value) setManualSupplNr('');\n                      }}\n                      disabled={loading || loadingData || !!manualSupplNr}\n                    >\n                      <SelectTrigger id=\"supplier\">\n                        <SelectValue placeholder=\"Lieferant auswhlen...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {suppliers.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">\n                            Keine Lieferanten vorhanden\n                          </div>\n                        ) : (\n                          suppliers.map((supplier) => (\n                            <SelectItem key={supplier.id} value={supplier.id}>\n                              {supplier.name}\n                              {supplier.supplNr && ` (${supplier.supplNr})`}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 flex items-center\">\n                      <span className=\"w-full border-t\" />\n                    </div>\n                    <div className=\"relative flex justify-center text-xs uppercase\">\n                      <span className=\"bg-background px-2 text-muted-foreground\">\n                        Oder\n                      </span>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"manualSupplNr\">Lieferantennummer manuell eingeben</Label>\n                    <Input\n                      id=\"manualSupplNr\"\n                      value={manualSupplNr}\n                      onChange={(e) => {\n                        setManualSupplNr(e.target.value);\n                        if (e.target.value) setSelectedSupplier('');\n                      }}\n                      placeholder=\"z.B. 7077 fr Nitecore\"\n                      disabled={loading || loadingData || !!selectedSupplier}\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Pixi-Lieferantennummer (z.B. 7077 = Nitecore/KTL, 7001 = andere)\n                    </p>\n                  </div>\n                </div>\n\n                {error && (\n                  <Alert variant=\"destructive\">\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                )}\n\n                <Button\n                  onClick={handleProjectCompare}\n                  disabled={!selectedProject || (!selectedSupplier && !manualSupplNr) || loading || loadingData}\n                  className=\"w-full\"\n                >\n                  <CheckCircle className=\"mr-2 h-4 w-4\" />\n                  {loading ? 'Vergleiche mit Pixi...' : 'Jetzt vergleichen'}\n                </Button>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"csv\">\n            <Card>\n              <CardHeader>\n                <CardTitle>CSV-Upload & Vergleich</CardTitle>\n                <CardDescription>\n                  Laden Sie eine CSV-Datei mit Produktdaten hoch und vergleichen Sie diese mit Pixi\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"csvSupplier\">Lieferant</Label>\n                    <Select\n                      value={selectedCsvSupplier}\n                      onValueChange={(value) => {\n                        setSelectedCsvSupplier(value);\n                        if (value) {\n                          const supplier = suppliers.find(s => s.id === value);\n                          setSupplNr(supplier?.supplNr || '');\n                        }\n                      }}\n                      disabled={loading || loadingData || !!supplNr}\n                    >\n                      <SelectTrigger id=\"csvSupplier\">\n                        <SelectValue placeholder=\"Lieferant auswhlen...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {suppliers.length === 0 ? (\n                          <div className=\"p-2 text-sm text-muted-foreground\">\n                            Keine Lieferanten vorhanden\n                          </div>\n                        ) : (\n                          suppliers.map((supplier) => (\n                            <SelectItem key={supplier.id} value={supplier.id}>\n                              {supplier.name}\n                              {supplier.supplNr && ` (${supplier.supplNr})`}\n                            </SelectItem>\n                          ))\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 flex items-center\">\n                      <span className=\"w-full border-t\" />\n                    </div>\n                    <div className=\"relative flex justify-center text-xs uppercase\">\n                      <span className=\"bg-background px-2 text-muted-foreground\">\n                        Oder\n                      </span>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"supplNr\">Lieferantennummer manuell eingeben</Label>\n                    <Input\n                      id=\"supplNr\"\n                      value={supplNr}\n                      onChange={(e) => {\n                        setSupplNr(e.target.value);\n                        if (e.target.value) setSelectedCsvSupplier('');\n                      }}\n                      placeholder=\"z.B. 7077\"\n                      disabled={loading || !!selectedCsvSupplier}\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Pixi-Lieferantennummer (z.B. 7077 = Nitecore/KTL, 7117 = Ansmann)\n                    </p>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"csvFile\">CSV-Datei</Label>\n                    <div className=\"flex gap-2\">\n                      <Input\n                        ref={fileInputRef}\n                        id=\"csvFile\"\n                        type=\"file\"\n                        accept=\".csv\"\n                        onChange={handleFileChange}\n                        disabled={loading}\n                        className=\"flex-1\"\n                      />\n                      {file && (\n                        <Button\n                          variant=\"outline\"\n                          size=\"icon\"\n                          onClick={() => {\n                            setFile(null);\n                            if (fileInputRef.current) fileInputRef.current.value = '';\n                          }}\n                          disabled={loading}\n                        >\n                          <XCircle className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                    </div>\n                    {file && (\n                      <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                        <FileText className=\"h-4 w-4\" />\n                        {file.name} ({(file.size / 1024).toFixed(1)} KB)\n                      </p>\n                    )}\n                  </div>\n                </div>\n\n                {error && (\n                  <Alert variant=\"destructive\">\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                )}\n\n                <Button\n                  onClick={handleCSVCompare}\n                  disabled={!file || !supplNr.trim() || loading}\n                  className=\"w-full\"\n                  size=\"lg\"\n                >\n                  <Upload className=\"mr-2 h-4 w-4\" />\n                  {loading ? 'Vergleiche mit Pixi...' : 'Jetzt vergleichen'}\n                </Button>\n                \n                {!file && (\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                     Bitte whlen Sie zuerst eine CSV-Datei aus\n                  </p>\n                )}\n                {file && !supplNr.trim() && (\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                     Bitte geben Sie eine Lieferantennummer ein\n                  </p>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {result && (\n          <>\n            <Card>\n              <CardHeader>\n                <CardTitle>Vergleichsergebnis</CardTitle>\n                <CardDescription>\n                  Zusammenfassung des Pixi-Abgleichs\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div className=\"bg-muted p-4 rounded-lg text-center\">\n                    <div className=\"text-2xl font-bold\">{result.summary.total}</div>\n                    <div className=\"text-sm text-muted-foreground\">Gesamt</div>\n                  </div>\n                  <div className=\"bg-green-50 dark:bg-green-950 p-4 rounded-lg text-center border border-green-200 dark:border-green-800\">\n                    <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                      {result.summary.neu}\n                    </div>\n                    <div className=\"text-sm text-green-700 dark:text-green-300\">Neu</div>\n                  </div>\n                  <div className=\"bg-blue-50 dark:bg-blue-950 p-4 rounded-lg text-center border border-blue-200 dark:border-blue-800\">\n                    <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                      {result.summary.vorhanden}\n                    </div>\n                    <div className=\"text-sm text-blue-700 dark:text-blue-300\">Vorhanden</div>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-3 gap-4 mt-4\">\n                  <Button\n                    onClick={downloadResults}\n                    variant=\"outline\"\n                  >\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    CSV Download\n                  </Button>\n                  <Button\n                    onClick={() => {\n                      setProjectName(`Pixi Vergleich ${new Date().toLocaleDateString('de-DE')}`);\n                      setShowSaveDialog(true);\n                    }}\n                    variant=\"default\"\n                  >\n                    <Save className=\"mr-2 h-4 w-4\" />\n                    Projekt speichern\n                  </Button>\n                  <Button\n                    onClick={async () => {\n                      try {\n                        const token = localStorage.getItem('supabase_token');\n                        await fetch('/api/pixi/cache', {\n                          method: 'DELETE',\n                          headers: { 'Authorization': `Bearer ${token}` }\n                        });\n                        alert('Pixi Cache wurde geleert. Bitte vergleichen Sie erneut.');\n                      } catch (err) {\n                        console.error('Cache clear failed:', err);\n                      }\n                    }}\n                    variant=\"outline\"\n                  >\n                    Cache leeren\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Produktliste ({result.products.length})</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"rounded-md border overflow-hidden\">\n                  <div className=\"max-h-96 overflow-y-auto overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          {/* Pixi Status column first */}\n                          <TableHead className=\"min-w-[120px]\">Status</TableHead>\n                        \n                        {/* Dynamic columns based on data source */}\n                        {result.products.length > 0 && result.products[0].originalData ? (\n                          // CSV Upload: Show all original CSV columns\n                          Object.keys(result.products[0].originalData)\n                            .filter(columnName => columnName !== 'pixi_ean')\n                            .map((columnName, idx) => (\n                              <TableHead key={idx} className=\"min-w-[150px]\">\n                                {columnName}\n                              </TableHead>\n                            ))\n                        ) : (\n                          // Project-based: Show basic product fields\n                          <>\n                            <TableHead className=\"min-w-[150px]\">Artikelnummer</TableHead>\n                            <TableHead className=\"min-w-[150px]\">Hersteller-Artikelnr.</TableHead>\n                            <TableHead className=\"min-w-[300px]\">Produktname</TableHead>\n                            <TableHead className=\"min-w-[130px]\">EAN</TableHead>\n                            <TableHead className=\"min-w-[150px]\">Hersteller</TableHead>\n                          </>\n                        )}\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {result.products\n                        .slice((currentPage - 1) * productsPerPage, currentPage * productsPerPage)\n                        .map((product, idx) => (\n                        <TableRow key={idx}>\n                          {/* Pixi Status column */}\n                          <TableCell>\n                            <Badge\n                              variant={product.pixi_status === 'NEU' ? 'default' : 'secondary'}\n                              className={\n                                product.pixi_status === 'NEU'\n                                  ? 'bg-green-600 hover:bg-green-700'\n                                  : 'bg-blue-600 hover:bg-blue-700'\n                              }\n                            >\n                              {product.pixi_status === 'NEU' ? (\n                                <CheckCircle className=\"mr-1 h-3 w-3\" />\n                              ) : (\n                                <FileText className=\"mr-1 h-3 w-3\" />\n                              )}\n                              {product.pixi_status}\n                            </Badge>\n                          </TableCell>\n                          \n                          {/* Data columns - dynamic based on source */}\n                          {product.originalData ? (\n                            // CSV Upload: Show all original data columns\n                            Object.keys(result.products[0].originalData || {})\n                              .filter(columnName => columnName !== 'pixi_ean')\n                              .map((columnName, colIdx) => (\n                                <TableCell key={colIdx} className=\"text-sm\">\n                                  {product.originalData[columnName] || '-'}\n                                </TableCell>\n                              ))\n                          ) : (\n                            // Project-based: Show basic product fields\n                            <>\n                              <TableCell className=\"text-sm\">{product.artikelnummer || '-'}</TableCell>\n                              <TableCell className=\"text-muted-foreground\">{product.manufacturerArticleNumber || '-'}</TableCell>\n                              <TableCell className=\"font-medium\">{product.produktname || '-'}</TableCell>\n                              <TableCell className=\"font-mono text-xs\">{product.ean || '-'}</TableCell>\n                              <TableCell className=\"text-sm\">{product.hersteller || '-'}</TableCell>\n                            </>\n                          )}\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                  </div>\n                  \n                  {/* Pagination Controls */}\n                  {result.products.length > productsPerPage && (\n                    <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30\">\n                      <div className=\"text-sm text-muted-foreground\">\n                        Zeige {((currentPage - 1) * productsPerPage) + 1} bis {Math.min(currentPage * productsPerPage, result.products.length)} von {result.products.length} Produkten\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n                          disabled={currentPage === 1}\n                        >\n                          Zurck\n                        </Button>\n                        <div className=\"flex items-center gap-1\">\n                          {Array.from({ length: Math.ceil(result.products.length / productsPerPage) }, (_, i) => i + 1).map((page) => (\n                            <Button\n                              key={page}\n                              variant={currentPage === page ? \"default\" : \"outline\"}\n                              size=\"sm\"\n                              onClick={() => setCurrentPage(page)}\n                              className=\"w-8 h-8 p-0\"\n                            >\n                              {page}\n                            </Button>\n                          ))}\n                        </div>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.min(Math.ceil(result.products.length / productsPerPage), currentPage + 1))}\n                          disabled={currentPage === Math.ceil(result.products.length / productsPerPage)}\n                        >\n                          Weiter\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </>\n        )}\n\n        <Dialog open={showSaveDialog} onOpenChange={setShowSaveDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Als Projekt speichern</DialogTitle>\n              <DialogDescription>\n                Speichern Sie die Vergleichsergebnisse als neues Projekt in Ihrer Datenbank\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"project-name\">Projektname</Label>\n                <Input\n                  id=\"project-name\"\n                  value={projectName}\n                  onChange={(e) => setProjectName(e.target.value)}\n                  placeholder=\"z.B. Nitecore Katalog 2025\"\n                  autoFocus\n                />\n              </div>\n              {result && (\n                <div className=\"text-sm text-muted-foreground\">\n                  Es werden {result.summary.total} Produkte gespeichert \n                  ({result.summary.neu} neu, {result.summary.vorhanden} vorhanden)\n                </div>\n              )}\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setShowSaveDialog(false);\n                  setProjectName('');\n                }}\n                disabled={saving}\n              >\n                Abbrechen\n              </Button>\n              <Button\n                onClick={handleSaveAsProject}\n                disabled={!projectName.trim() || saving}\n              >\n                {saving ? 'Speichere...' : 'Projekt speichern'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":37762},"server/services/pixi-service.ts":{"content":"/**\n * Pixi ERP API Integration Service\n * \n * Provides methods to interact with the Pixi ERP system for product comparison\n * and inventory management.\n */\n\nimport type { ProductInProject, Supplier } from '@shared/schema';\nimport type { IStorage } from '../supabase-storage';\n\ninterface PixiItemSearchRequest {\n  SupplNr: string;\n}\n\ninterface PixiItemSearchResponse {\n  data: Array<{\n    ItemNrSuppl: string;\n    EANUPC: string;\n  }>;\n}\n\ninterface PixiComparisonResult {\n  artikelnummer: string;\n  manufacturerArticleNumber?: string;\n  produktname: string;\n  ean: string;\n  hersteller: string;\n  pixi_status: 'NEU' | 'VORHANDEN';\n  pixi_ean: string | null;\n  originalData?: any; // Complete original CSV row data\n}\n\ninterface PixiComparisonSummary {\n  success: boolean;\n  summary: {\n    total: number;\n    neu: number;\n    vorhanden: number;\n  };\n  products: PixiComparisonResult[];\n}\n\ninterface PixiSupabaseComparisonResult extends PixiComparisonResult {\n  id: string;\n  pixi_checked_at: string;\n}\n\ninterface PixiSupabaseComparisonSummary {\n  success: boolean;\n  projectId: string;\n  supplierId?: string;\n  summary: {\n    total: number;\n    neu: number;\n    vorhanden: number;\n  };\n  products: PixiSupabaseComparisonResult[];\n}\n\ninterface CSVProduct {\n  Artikelnummer?: string;\n  Produktname?: string;\n  EAN?: string;\n  Hersteller?: string;\n  [key: string]: any;\n}\n\n/**\n * Pixi ERP API Service\n */\nexport class PixiService {\n  private apiUrl: string;\n  private authToken: string;\n  private cache: Map<string, { data: PixiItemSearchResponse; timestamp: number }>;\n  private cacheTTL: number = 5 * 60 * 1000; // 5 minutes\n\n  constructor() {\n    this.apiUrl = process.env.PIXI_API_URL || 'https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch';\n    this.authToken = process.env.PIXI_AUTH_TOKEN || '';\n    this.cache = new Map();\n  }\n\n  /**\n   * Search for items in Pixi ERP by supplier number\n   * @param supplNr Supplier number (e.g., \"7077\")\n   * @returns Pixi item search response\n   */\n  async searchItems(supplNr: string): Promise<PixiItemSearchResponse> {\n    // Check cache first\n    const cached = this.cache.get(supplNr);\n    if (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n      console.log(`[Pixi Service] Cache hit for supplier ${supplNr}`);\n      return cached.data;\n    }\n\n    try {\n      console.log(`[Pixi Service] Fetching items for supplier ${supplNr}`);\n      \n      const response = await fetch(this.apiUrl, {\n        method: 'POST',\n        headers: {\n          'X-AUTH-TOKEN': this.authToken,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ SupplNr: supplNr }),\n        signal: AbortSignal.timeout(30000), // 30 second timeout\n      });\n\n      if (!response.ok) {\n        throw new Error(`Pixi API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data: PixiItemSearchResponse = await response.json();\n      \n      // Debug: Log first raw item to see actual field names\n      if (data.data && data.data.length > 0) {\n        console.log('[Pixi Debug] RAW API Response - First item:', JSON.stringify(data.data[0], null, 2));\n      }\n      \n      // Cache the result\n      this.cache.set(supplNr, { data, timestamp: Date.now() });\n      \n      console.log(`[Pixi Service] Found ${data.data?.length || 0} items for supplier ${supplNr}`);\n      \n      return data;\n    } catch (error: any) {\n      console.error(`[Pixi Service] Error fetching items:`, error.message);\n      throw new Error(`Failed to fetch items from Pixi API: ${error.message}`);\n    }\n  }\n\n  /**\n   * Helper function to extract column value with flexible column name matching\n   */\n  private getColumnValue(product: any, possibleNames: string[]): string {\n    for (const name of possibleNames) {\n      const value = product[name];\n      if (value !== undefined && value !== null && value !== '') {\n        return typeof value === 'string' ? value.trim() : value.toString().trim();\n      }\n    }\n    return '';\n  }\n\n  /**\n   * Compare CSV products with Pixi inventory\n   * @param products Array of products from CSV\n   * @param supplNr Supplier number\n   * @returns Comparison results with status (NEU/VORHANDEN)\n   */\n  async compareProducts(products: CSVProduct[], supplNr: string): Promise<PixiComparisonSummary> {\n    try {\n      // Log the column names from the first product to help debug\n      if (products.length > 0) {\n        const columnNames = Object.keys(products[0]);\n        console.log(`[Pixi Service] CSV columns detected:`, columnNames);\n      }\n\n      // Fetch all items from Pixi for this supplier\n      const pixiResponse = await this.searchItems(supplNr);\n      const pixiItems = pixiResponse.data || [];\n\n      // Create lookup maps for fast comparison\n      const pixiByItemNr = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\n      const pixiByEan = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\n\n      pixiItems.forEach(item => {\n        if (item.ItemNrSuppl) {\n          pixiByItemNr.set(item.ItemNrSuppl.toUpperCase(), item);\n        }\n        if (item.EANUPC) {\n          pixiByEan.set(item.EANUPC, item);\n        }\n      });\n\n      // Compare each product\n      const results: PixiComparisonResult[] = [];\n      let neuCount = 0;\n      let vorhandenCount = 0;\n\n      for (const product of products) {\n        // Get both article numbers for better matching\n        const artikelnummer = this.getColumnValue(product, [\n          'Artikelnummer', 'artikelnummer', 'ARTIKELNUMMER',\n          'Article Number', 'ArticleNumber', 'article_number',\n          'Item Number', 'ItemNumber', 'item_number',\n          'SKU', 'sku', 'Art.-Nr.', 'Art.Nr.',\n          'p_item_number'  // Prioritize p_item_number\n        ]);\n        \n        const manufacturerItemNr = this.getColumnValue(product, [\n          'ItemNrSuppl', 'manufacturers_item_number',\n          'Herstellerartikelnummer', 'Hersteller-Artikelnummer'\n        ]);\n        \n        const produktname = this.getColumnValue(product, [\n          'Produktname', 'produktname', 'PRODUKTNAME',\n          'Product Name', 'ProductName', 'product_name',\n          'Name', 'name', 'Bezeichnung', 'bezeichnung',\n          'Description', 'description',\n          'p_name[de]', 'p_name[en]', 'p_name'  // Export system columns\n        ]);\n        \n        const ean = this.getColumnValue(product, [\n          'EAN', 'ean', 'EAN-Code', 'EAN Code',\n          'GTIN', 'gtin', 'Barcode', 'barcode',\n          'UPC', 'upc', 'EAN/UPC',\n          'EANUPC', 'p_ean'  // Export system columns\n        ]);\n        \n        const hersteller = this.getColumnValue(product, [\n          'Hersteller', 'hersteller', 'HERSTELLER',\n          'Manufacturer', 'manufacturer', 'Brand', 'brand',\n          'Marke', 'marke', 'Supplier', 'supplier',\n          'p_brand', 'v_brand'  // Export system columns\n        ]);\n\n        // Check if product exists in Pixi - try multiple strategies\n        let pixiItem = null;\n        let isMatch = false;\n        let matchedEan: string | null = null;\n\n        // DEBUG: Log first product for debugging\n        if (results.length === 0) {\n          console.log('[Pixi Match Debug] First product:', {\n            artikelnummer,\n            manufacturerItemNr,\n            ean,\n            produktname: produktname?.substring(0, 50)\n          });\n          console.log('[Pixi Match Debug] First 5 Pixi items:', \n            Array.from(pixiByItemNr.entries()).slice(0, 5).map(([key, val]) => ({\n              ItemNrSuppl: key,\n              EANUPC: val.EANUPC\n            }))\n          );\n        }\n\n        // Strategy 1: Try p_item_number (e.g., \"ANS2447304960\")\n        if (artikelnummer) {\n          const lookupKey = artikelnummer.toUpperCase();\n          pixiItem = pixiByItemNr.get(lookupKey);\n          if (pixiItem) {\n            console.log(`[Pixi Match]  Strategy 1 matched: ${artikelnummer} -> ${pixiItem.ItemNrSuppl}`);\n            isMatch = true;\n            matchedEan = pixiItem.EANUPC || null;\n          }\n          \n          // Try without prefix (e.g., \"ANS2447304960\" -> \"2447304960\")\n          if (!isMatch && lookupKey.length > 3) {\n            const withoutPrefix = lookupKey.substring(3);\n            pixiItem = pixiByItemNr.get(withoutPrefix);\n            if (pixiItem) {\n              console.log(`[Pixi Match]  Strategy 1b matched (without prefix): ${artikelnummer} -> ${pixiItem.ItemNrSuppl}`);\n              isMatch = true;\n              matchedEan = pixiItem.EANUPC || null;\n            }\n          }\n        }\n\n        // Strategy 2: Try ItemNrSuppl (e.g., \"2447304960\")\n        if (!isMatch && manufacturerItemNr) {\n          const lookupKey = manufacturerItemNr.toUpperCase();\n          pixiItem = pixiByItemNr.get(lookupKey);\n          if (pixiItem) {\n            console.log(`[Pixi Match]  Strategy 2 matched: ${manufacturerItemNr} -> ${pixiItem.ItemNrSuppl}`);\n            isMatch = true;\n            matchedEan = pixiItem.EANUPC || null;\n          }\n        }\n\n        // Strategy 3: Try EAN as fallback\n        if (!isMatch && ean) {\n          pixiItem = pixiByEan.get(ean);\n          if (pixiItem) {\n            console.log(`[Pixi Match]  Strategy 3 matched: ${ean} -> ${pixiItem.ItemNrSuppl}`);\n            isMatch = true;\n            matchedEan = pixiItem.EANUPC || null;\n          }\n        }\n\n        // DEBUG: Log mismatches for first few products\n        if (!isMatch && results.length < 3) {\n          console.log(`[Pixi Match]  No match found for:`, {\n            artikelnummer,\n            manufacturerItemNr,\n            ean,\n            produktname: produktname?.substring(0, 50)\n          });\n        }\n\n        const status: 'NEU' | 'VORHANDEN' = isMatch ? 'VORHANDEN' : 'NEU';\n        \n        if (status === 'NEU') {\n          neuCount++;\n        } else {\n          vorhandenCount++;\n        }\n\n        results.push({\n          artikelnummer,\n          manufacturerArticleNumber: manufacturerItemNr || undefined,\n          produktname,\n          ean,\n          hersteller,\n          pixi_status: status,\n          pixi_ean: matchedEan,\n          originalData: product, // Store complete original CSV row\n        });\n      }\n\n      return {\n        success: true,\n        summary: {\n          total: products.length,\n          neu: neuCount,\n          vorhanden: vorhandenCount,\n        },\n        products: results,\n      };\n    } catch (error: any) {\n      console.error('[Pixi Service] Comparison failed:', error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Compare products from Supabase with Pixi inventory and update database\n   * @param projectId Project ID to load products from\n   * @param storage Supabase storage instance\n   * @param supplierIdOrSupplNr Supplier ID or direct SupplNr\n   * @returns Comparison results with updated database records\n   */\n  async compareProductsFromSupabase(\n    projectId: string,\n    storage: IStorage,\n    supplierIdOrSupplNr: string\n  ): Promise<PixiSupabaseComparisonSummary> {\n    try {\n      console.log(`[Pixi Service] Starting Supabase comparison for project ${projectId}`);\n\n      // Load products from Supabase\n      const products = await storage.getProducts(projectId);\n      if (!products || products.length === 0) {\n        throw new Error('No products found in project');\n      }\n\n      console.log(`[Pixi Service] Loaded ${products.length} products from Supabase`);\n\n      // Determine SupplNr - either direct value or lookup from supplier\n      let supplNr: string;\n      let supplierId: string | undefined;\n\n      if (supplierIdOrSupplNr.match(/^\\d+$/)) {\n        // Looks like a SupplNr (numeric)\n        supplNr = supplierIdOrSupplNr;\n      } else {\n        // Assume it's a supplier ID\n        supplierId = supplierIdOrSupplNr;\n        const supplier = await storage.getSupplier(supplierId);\n        \n        if (!supplier) {\n          throw new Error(`Supplier ${supplierId} not found`);\n        }\n        \n        if (!supplier.supplNr) {\n          throw new Error(`Supplier ${supplier.name} has no SupplNr configured`);\n        }\n        \n        supplNr = supplier.supplNr;\n        console.log(`[Pixi Service] Using SupplNr ${supplNr} from supplier ${supplier.name}`);\n      }\n\n      // Fetch Pixi inventory\n      const pixiResponse = await this.searchItems(supplNr);\n      const pixiItems = pixiResponse.data || [];\n\n      // Create lookup maps (case-insensitive, preserve hyphens!)\n      const pixiByItemNr = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\n      const pixiByEan = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\n      \n      pixiItems.forEach(item => {\n        if (item.ItemNrSuppl) {\n          // Only uppercase for case-insensitive matching - DO NOT remove hyphens!\n          const normalized = item.ItemNrSuppl.trim().toUpperCase();\n          pixiByItemNr.set(normalized, item);\n        }\n        if (item.EANUPC) {\n          // Only uppercase for case-insensitive matching - DO NOT remove hyphens!\n          const normalized = item.EANUPC.trim().toUpperCase();\n          pixiByEan.set(normalized, item);\n        }\n      });\n\n      console.log(`[Pixi Service] Loaded ${pixiItems.length} items from Pixi API`);\n      \n      // Debug: Show first 5 Pixi items to verify format\n      if (pixiItems.length > 0) {\n        console.log(`[Pixi Debug] First 5 Pixi items:`, \n          pixiItems.slice(0, 5).map(item => ({\n            ItemNrSuppl: item.ItemNrSuppl,\n            EANUPC: item.EANUPC\n          }))\n        );\n      }\n\n      // Compare and prepare updates\n      const results: PixiSupabaseComparisonResult[] = [];\n      const updates: Array<{\n        id: string;\n        pixi_status: 'NEU' | 'VORHANDEN';\n        pixi_ean: string | null;\n        pixi_checked_at: string;\n      }> = [];\n      \n      let neuCount = 0;\n      let vorhandenCount = 0;\n      const timestamp = new Date().toISOString();\n\n      for (const product of products) {\n        const artikelnummer = product.articleNumber?.trim() || product.name?.trim() || '';\n        const produktname = product.name?.trim() || '';\n        \n        // Try to get EAN from extractedData (primary) or customAttributes (fallback)\n        let ean = '';\n        let hersteller = '';\n        let manufacturerItemNr = '';\n        \n        // extractedData is an array of {key, value, type}\n        if (product.extractedData && Array.isArray(product.extractedData)) {\n          const eanAttr = product.extractedData.find((attr: any) => \n            attr.key?.toLowerCase() === 'ean'\n          );\n          if (eanAttr) {\n            ean = eanAttr.value?.toString().trim() || '';\n          }\n          \n          const herstellerAttr = product.extractedData.find((attr: any) => \n            attr.key?.toLowerCase() === 'hersteller'\n          );\n          if (herstellerAttr) {\n            hersteller = herstellerAttr.value?.toString().trim() || '';\n          }\n          \n          const manuItemNrAttr = product.extractedData.find((attr: any) => \n            attr.key?.toLowerCase() === 'manufacturerarticlenumber'\n          );\n          if (manuItemNrAttr) {\n            manufacturerItemNr = manuItemNrAttr.value?.toString().trim() || '';\n          }\n        }\n        \n        // Fallback to customAttributes if not found in extractedData\n        if (!ean && product.customAttributes) {\n          const eanAttr = product.customAttributes.find((attr: any) => \n            attr.key?.toLowerCase() === 'ean' || attr.key?.toLowerCase() === 'ean-nummer'\n          );\n          if (eanAttr) {\n            ean = eanAttr.value?.toString().trim() || '';\n          }\n        }\n\n        // Multi-strategy matching (case-insensitive, preserve hyphens!)\n        let pixiItem = null;\n        let matchStrategy = '';\n        \n        // Helper: Normalize strings for matching (only uppercase - DO NOT remove hyphens!)\n        const normalize = (str: string) => str.trim().toUpperCase();\n        \n        // Strategy 1: Try exact match with full article number (normalized)\n        pixiItem = pixiByItemNr.get(normalize(artikelnummer));\n        if (pixiItem) {\n          matchStrategy = 'artikelnummer_exact';\n        }\n        \n        // Strategy 2: Try with manufacturer item number (normalized)\n        if (!pixiItem && manufacturerItemNr) {\n          pixiItem = pixiByItemNr.get(normalize(manufacturerItemNr));\n          if (pixiItem) {\n            matchStrategy = 'manufacturer_item_nr';\n          }\n        }\n        \n        // Strategy 3: Try removing common prefixes (normalized)\n        if (!pixiItem && artikelnummer.length > 3) {\n          const withoutPrefix = artikelnummer.replace(/^(ANS|BK|VK|ART)/i, '');\n          if (withoutPrefix !== artikelnummer) {\n            pixiItem = pixiByItemNr.get(normalize(withoutPrefix));\n            if (pixiItem) {\n              matchStrategy = 'artikelnummer_without_prefix';\n            }\n          }\n        }\n        \n        // Strategy 4: Try EAN as fallback (normalized)\n        if (!pixiItem && ean) {\n          pixiItem = pixiByEan.get(normalize(ean));\n          if (pixiItem) {\n            matchStrategy = 'ean';\n          }\n        }\n        \n        const isMatch = !!pixiItem;\n        const matchedEan = pixiItem?.EANUPC || null;\n        const status: 'NEU' | 'VORHANDEN' = isMatch ? 'VORHANDEN' : 'NEU';\n        \n        // Debug logging for products that don't match\n        if (!isMatch) {\n          const withoutPrefix = artikelnummer.replace(/^(ANS|BK|VK|ART)/i, '');\n          console.log(`[Pixi No-Match Debug] Product not found:`, {\n            artikelnummer,\n            manufacturerItemNr,\n            ean,\n            withoutPrefix,\n            searchedKeys: [\n              artikelnummer.toUpperCase(),\n              manufacturerItemNr?.toUpperCase(),\n              withoutPrefix !== artikelnummer ? withoutPrefix.toUpperCase() : null,\n              ean?.toUpperCase()\n            ].filter(Boolean)\n          });\n        }\n        \n        // Debug logging for first successful match\n        if (isMatch && results.filter(r => r.pixi_status === 'VORHANDEN').length === 0) {\n          console.log(`[Pixi Match Success] First matched product:`, {\n            artikelnummer,\n            matchStrategy,\n            matchedItemNr: pixiItem?.ItemNrSuppl,\n            matchedEan: pixiItem?.EANUPC,\n          });\n        }\n\n        if (status === 'NEU') {\n          neuCount++;\n        } else {\n          vorhandenCount++;\n        }\n\n        // Build Brickfox-formatted originalData\n        const brickfoxData: any = {\n          p_item_number: artikelnummer,\n          ItemNrSuppl: manufacturerItemNr || artikelnummer,\n          'p_name[de]': produktname,\n          EANUPC: ean,\n          p_brand: hersteller,\n        };\n\n        // Add ALL extractedData fields as Brickfox columns\n        if (product.extractedData && Array.isArray(product.extractedData)) {\n          product.extractedData.forEach((attr: any) => {\n            if (attr.key && attr.value && !['ean', 'hersteller', 'manufacturerarticlenumber'].includes(attr.key.toLowerCase())) {\n              // Map known fields to Brickfox format\n              const fieldName = attr.key;\n              brickfoxData[fieldName] = attr.value;\n            }\n          });\n        }\n\n        // Add custom attributes as additional Brickfox fields\n        if (product.customAttributes) {\n          product.customAttributes.forEach((attr: any) => {\n            if (attr.key && attr.value) {\n              brickfoxData[attr.key] = attr.value;\n            }\n          });\n        }\n\n        results.push({\n          id: product.id,\n          artikelnummer,\n          manufacturerArticleNumber: manufacturerItemNr || undefined,\n          produktname,\n          ean,\n          hersteller,\n          pixi_status: status,\n          pixi_ean: matchedEan,\n          pixi_checked_at: timestamp,\n          originalData: brickfoxData, // Add Brickfox-formatted data\n        });\n\n        updates.push({\n          id: product.id,\n          pixi_status: status,\n          pixi_ean: matchedEan,\n          pixi_checked_at: timestamp,\n        });\n      }\n\n      // Batch update in Supabase\n      console.log(`[Pixi Service] Updating ${updates.length} products in Supabase`);\n      const updateSuccess = await storage.batchUpdateProductsPixiStatus(updates);\n      \n      if (!updateSuccess) {\n        console.warn('[Pixi Service] Some database updates may have failed');\n      }\n\n      return {\n        success: true,\n        projectId,\n        supplierId,\n        summary: {\n          total: products.length,\n          neu: neuCount,\n          vorhanden: vorhandenCount,\n        },\n        products: results,\n      };\n    } catch (error: any) {\n      console.error('[Pixi Service] Supabase comparison failed:', error.message);\n      throw error;\n    }\n  }\n\n  /**\n   * Clear the cache (useful for testing or forced refresh)\n   */\n  clearCache(): void {\n    this.cache.clear();\n    console.log('[Pixi Service] Cache cleared');\n  }\n}\n\n// Export singleton instance\nexport const pixiService = new PixiService();\n","size_bytes":21000},"PIXI_INTEGRATION.md":{"content":"# Pixi ERP Integration\n\n## berblick\nDie Pixi-Integration ermglicht es, CSV-Produktdaten automatisch mit Ihrem Pixi ERP-System abzugleichen, um neue Artikel zu identifizieren und Duplikate zu vermeiden.\n\n## Features\n\n **CSV-Upload**: Laden Sie Produktlisten als CSV-Datei hoch  \n **API-Integration**: Automatischer Abgleich mit Pixi ERP via REST API  \n **Intelligenter Vergleich**: Artikel- und EAN-Nummern-Matching  \n **Status-Tracking**: Sofortige Kennzeichnung als \"NEU\" oder \"VORHANDEN\"  \n **Export-Funktion**: Ergebnisse als CSV herunterladen  \n **Performance**: Caching fr 5 Minuten, um API-Calls zu reduzieren  \n **Multi-Tenant**: Vollstndig organization_id-isoliert\n\n## Architektur\n\n### Backend-Komponenten\n\n**1. Pixi Service** (`server/services/pixi-service.ts`)\n- Verwaltet API-Calls zu Pixi ERP\n- Implementiert intelligentes 5-Minuten-Caching\n- Matching-Logik: Artikelnummer (primr) + EAN-Validierung (optional)\n- TypeScript Interfaces fr Type-Safety\n\n**2. API Endpoints** (`server/routes-supabase.ts`)\n```\nPOST /api/pixi/compare          # CSV-Upload & Vergleich\nPOST /api/pixi/compare-json     # JSON-basierter Vergleich\nDELETE /api/pixi/cache          # Cache lschen\n```\n\n### Frontend\n\n**Pixi Vergleich Page** (`client/src/pages/pixi-compare.tsx`)\n- Benutzerfreundliche Upload-UI\n- Live-Statistiken (Gesamt, Neu, Vorhanden)\n- Detaillierte Produktliste mit Filter\n- CSV-Export-Funktion\n\n**Navigation**: Sidebar-Men mit \"Pixi Vergleich\" Icon\n\n## Verwendung\n\n### 1. CSV-Datei vorbereiten\n\nIhre CSV-Datei sollte diese Spalten enthalten:\n```csv\nArtikelnummer,Produktname,EAN,Hersteller,Preis,Gewicht\nNC-CG7,Nitecore Chameleon CG7,6952506407231,Nitecore,89.00,158\nNC-CI7,Nitecore CI7,6952506405336,Nitecore,59.90,138\n```\n\n**Wichtige Spalten fr den Vergleich:**\n- `Artikelnummer` - Primres Vergleichsfeld (wird mit Pixi `ItemNrSuppl` abgeglichen)\n- `EAN` - Optional fr Validierung (wird mit Pixi `EANUPC` verglichen)\n- `Produktname` - Zur Anzeige\n- `Hersteller` - Zur Anzeige\n\n### 2. Vergleich durchfhren\n\n1. Navigieren Sie zu **\"Pixi Vergleich\"** in der Sidebar\n2. Geben Sie die **Lieferantennummer** ein (z.B. `7077`)\n3. Laden Sie Ihre **CSV-Datei** hoch\n4. Klicken Sie auf **\"Jetzt vergleichen\"**\n\n### 3. Ergebnisse analysieren\n\nNach dem Vergleich sehen Sie:\n\n**Zusammenfassung:**\n-  Gesamt: Anzahl aller Produkte\n-  Neu: Produkte, die NICHT in Pixi existieren\n-  Vorhanden: Produkte, die bereits in Pixi sind\n\n**Detailliste:**\n- Status-Badge fr jedes Produkt (NEU/VORHANDEN)\n- Artikelnummer, Produktname, EAN\n- Pixi EAN zur Validierung\n\n### 4. Ergebnisse exportieren\n\nKlicken Sie auf **\"Ergebnisse als CSV herunterladen\"**, um eine exportierbare Liste zu erhalten.\n\n## API-Konfiguration\n\n### Erforderliche Secrets (bereits konfiguriert)\n\n```bash\nPIXI_API_URL=https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch\nPIXI_AUTH_TOKEN=<Ihr-API-Token>\n```\n\nDiese werden sicher als Replit Secrets gespeichert.\n\n## API-Details\n\n### Pixi ItemSearch API\n\n**Endpoint:** `POST https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch`\n\n**Request:**\n```json\n{\n  \"SupplNr\": \"7077\"\n}\n```\n\n**Response:**\n```json\n{\n  \"data\": [\n    {\n      \"ItemNrSuppl\": \"NC-CG7\",\n      \"EANUPC\": \"6952506407231\"\n    }\n  ]\n}\n```\n\n### PIMPilot Compare API\n\n**Request:**\n```bash\ncurl -X POST http://localhost:5000/api/pixi/compare \\\n  -H \"Authorization: Bearer <token>\" \\\n  -F \"csvFile=@produktliste.csv\" \\\n  -F \"supplNr=7077\"\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"summary\": {\n    \"total\": 50,\n    \"neu\": 15,\n    \"vorhanden\": 35\n  },\n  \"products\": [\n    {\n      \"artikelnummer\": \"NC-CG7\",\n      \"produktname\": \"Nitecore Chameleon CG7\",\n      \"ean\": \"6952506407231\",\n      \"hersteller\": \"Nitecore\",\n      \"pixi_status\": \"NEU\",\n      \"pixi_ean\": null\n    }\n  ]\n}\n```\n\n## Matching-Logik\n\n### Primrer Match: Artikelnummer\n```typescript\nconst pixiItem = pixiByItemNr.get(artikelnummer.toUpperCase());\n```\n- Case-insensitive Vergleich\n- Exact Match erforderlich\n\n### Sekundre Validierung: EAN\n```typescript\nif (ean && pixiItem.EANUPC && ean !== pixiItem.EANUPC) {\n  console.warn(`EAN mismatch for ${artikelnummer}`);\n}\n```\n- Warnung bei EAN-Diskrepanzen\n- Verhindert falsche Zuordnungen\n\n## Performance & Caching\n\n**Cache-TTL:** 5 Minuten  \n**Warum?** Reduziert API-Calls bei mehreren Vergleichen desselben Lieferanten\n\n**Cache manuell lschen:**\n```bash\ncurl -X DELETE http://localhost:5000/api/pixi/cache \\\n  -H \"Authorization: Bearer <token>\"\n```\n\n## Fehlerbehandlung\n\nDas System behandelt folgende Fehler:\n\n **Ungltige CSV-Dateien** - Validierung vor Upload  \n **API-Timeouts** - 30 Sekunden Timeout  \n **Netzwerkfehler** - Retry-Logik im Service  \n **Leere Responses** - Fallback auf leere Arrays  \n **Authentifizierungsfehler** - 401/403 Handling\n\n## Sicherheit\n\n-  **requireAuth Middleware**: Nur authentifizierte User\n-  **Multi-Tenant Isolation**: organization_id wird automatisch validiert\n-  **Token-basierte Auth**: Bearer Token aus localStorage\n-  **Secret Management**: API-Token in Replit Secrets\n\n## Testing\n\n**Test-CSV bereitgestellt:** `test-pixi-data.csv`\n\nEnthlt 5 Testprodukte:\n- 2 existierende Nitecore Produkte (sollten als VORHANDEN erkannt werden)\n- 3 neue Test-Produkte (sollten als NEU erkannt werden)\n\n## Zuknftige Erweiterungen\n\nMgliche Features:\n- [ ] Batch-Processing fr groe CSV-Dateien (>10.000 Zeilen)\n- [ ] Webhook-Benachrichtigungen bei neuen Produkten\n- [ ] Automatischer Export nach Pixi bei \"NEU\"-Produkten\n- [ ] Duplikat-Erkennung via Fuzzy-Matching\n- [ ] Historische Vergleichsberichte\n\n## Technische Details\n\n**Dependencies:**\n- `papaparse` - CSV-Parsing\n- Native `fetch` API - HTTP Requests (kein axios bentigt)\n- TypeScript - Type-Safety\n\n**Code-Qualitt:**\n-  JSDoc Kommentare\n-  TypeScript Interfaces\n-  Error Handling\n-  Logging mit Prefixes `[Pixi Service]`, `[Pixi Compare]`\n\n## Support\n\nBei Problemen:\n1. Prfen Sie die Browser-Console fr Fehler\n2. berprfen Sie die Server-Logs: `[Pixi Service]` und `[Pixi Compare]` Tags\n3. Validieren Sie CSV-Format\n4. Testen Sie mit `test-pixi-data.csv`\n","size_bytes":6146},"docs/DEMO-ANLEITUNG.md":{"content":"#  PIMPilot - Demo-Anleitung fr Chef-Prsentation\n\n##  Vorbereitung (5 Minuten vor Prsentation)\n\n### 1. Prsentations-Datei ffnen\n```\nffnen Sie: docs/presentation.html im Browser\n```\nDiese enthlt die **vollstndige Executive Summary** mit allen Features.\n\n### 2. Live-App starten\n```\nDie App luft bereits auf Port 5000\nffnen Sie: http://localhost:5000 (oder Ihre Replit-URL)\n```\n\n### 3. Test-Login vorbereiten\n```\nEmail: saranzerrer@icloud.com\nPasswort: [Ihr Passwort]\nOrganization: AkkuShop (Admin-Rolle)\n```\n\n---\n\n##  Demo-Ablauf (15-20 Minuten)\n\n### **Slide 1: Hero & Executive Summary** (2 Min)\n**Was zeigen:**\n- PIMPilot ist Multi-Tenant B2B SaaS\n- 6 Kern-Features, 3 Pricing Tiers\n- 100 gratis AI-Generationen im Trial\n\n**Key Message:** \n> \"Eine Plattform fr unbegrenzt viele B2B-Kunden mit vollstndiger Datenisolation\"\n\n---\n\n### **Slide 2: Hauptfunktionen** (5 Min)\n**Durchgehen Sie alle 6 Feature-Cards:**\n\n1. ** AI Content Generator**\n   - \"Automatische Produktbeschreibungen wie MediaMarkt\"\n   - \"Bulk CSV-Upload fr tausende Produkte\"\n\n2. ** Web Scraper**\n   - \"Intelligentes Scraping von Lieferanten-Websites\"\n   - \"Supplier-Profile speichern Konfigurationen\"\n\n3. ** Pixi ERP Integration**  **NEU!**\n   - \"Automatischer Abgleich: NEU vs. VORHANDEN\"\n   - \"Zwei Modi: CSV-Upload & Projekt-basiert\"\n\n4. ** Projekt-Management**\n   - \"Organisieren Sie Produkte in Projekten\"\n\n5. ** Stripe-Integration**\n   - \"3 Pricing Tiers mit automatischem Limit-Enforcement\"\n\n6. ** Enterprise Security**\n   - \"Multi-Tenant mit organization_id-Isolation\"\n\n---\n\n### **Slide 3: Technische Architektur** (3 Min)\n**Was zeigen:**\n- Tech Stack Badges (React, TypeScript, PostgreSQL, OpenAI...)\n- Klick auf \"Architektur-Diagramm ffnen\" Button\n- Zeigen Sie das farbige Flussdiagramm\n\n**Key Message:**\n> \"6-Layer Architektur: Frontend  Auth  API  Services  Database  External\"\n\n---\n\n### **Live-Demo in der App** (7 Min)\n\n#### **Demo 1: Dashboard** (1 Min)\n- Login zeigen\n- bersicht: Projekte, Produkte, API Usage\n\n#### **Demo 2: Pixi-Vergleich**  **HIGHLIGHT!** (3 Min)\n```\nNavigation: /pixi-compare\n```\n\n**Tab: Projekt-basiert** ( Hauptfeature)\n1. Projekt auswhlen (z.B. \"AkkuShop Herbst 2024\")\n2. Lieferant auswhlen\n3. \"Jetzt vergleichen\" klicken\n4. **Ergebnis zeigen:**\n   - Gesamt / NEU / VORHANDEN Statistiken\n   - Tabelle mit Status-Badges\n   - CSV-Export-Funktion\n\n**Key Message:**\n> \"Status wird dauerhaft in der Datenbank gespeichert - keine doppelte Arbeit mehr!\"\n\n**Tab: CSV-Upload** (Optional)\n- Fr einmalige Analysen ohne Projekt\n\n#### **Demo 3: AI Generator** (2 Min)\n```\nNavigation: /generate\n```\n1. CSV hochladen oder manuell eingeben\n2. \"Generieren\" klicken\n3. AI-generierte Produktbeschreibung zeigen\n\n#### **Demo 4: Web Scraper** (1 Min)\n```\nNavigation: /scraper\n```\n1. URL eingeben (z.B. Lieferanten-Website)\n2. Automatische Erkennung zeigen\n3. Scraping-Ergebnis in Tabelle\n\n---\n\n### **Slide 4: Geschftsmodell** (3 Min)\n**Pricing-Tabelle zeigen:**\n- Starter: 500 AI-Gen/Monat\n- Pro: 5,000 AI-Gen/Monat\n- Enterprise: Unlimited\n\n**Trial-Modus hervorheben:**\n> \"100 kostenlose AI-Generierungen zum Testen - keine Kreditkarte ntig\"\n\n---\n\n### **Slide 5: Wettbewerbsvorteile** (2 Min)\n**Vergleichstabelle zeigen:**\n- PIMPilot vs. Traditionelle PIM-Systeme\n- Grne Hkchen bei allen PIMPilot-Features\n\n**Key Differentiator:**\n> \"Setup in < 5 Minuten statt Wochen. Native AI-Integration statt Add-ons.\"\n\n---\n\n### **Slide 6: Roadmap & Nchste Schritte** (2 Min)\n**Was ist bereit:**\n-  Produktionsreife Platform\n-  Multi-Tenant-Isolation getestet\n-  OpenAI & Stripe Live-Integrationen\n-  Pixi ERP Integration mit Supabase\n\n**Was kommt (Q1 2026):**\n- Analytics Dashboard\n- REST API fr Enterprise\n- Weitere ERP-Systeme (SAP, Shopware)\n\n**Go-Live-Prozess:**\n- 4 Wochen: Beta  Feedback  Soft Launch  Continuous Improvement\n\n---\n\n##  Closing Statement\n\n**Empfohlene Abschluss-Worte:**\n\n> \"PIMPilot ist produktionsbereit und lst ein echtes Problem: \n> Die manuelle Erstellung von Produktbeschreibungen kostet Unternehmen \n> hunderte Stunden pro Monat. Mit unserer AI-Automatisierung reduzieren \n> wir das um 90%.\n> \n> Wir haben eine skalierbare Multi-Tenant-Architektur, die ab Tag 1 \n> fr multiple B2B-Kunden funktioniert. Die Pixi ERP-Integration, \n> die wir gerade implementiert haben, ist ein perfektes Beispiel fr \n> unsere Flexibilitt.\n> \n> Ich empfehle einen 4-Wochen-Launch-Prozess mit Beta-Testing bei \n> 3-5 Kunden. Was denken Sie?\"\n\n---\n\n##  Wichtige Metriken zum Merken\n\n- **6** Kern-Features\n- **100** gratis AI-Generationen (Trial)\n- **90%** Zeitersparnis gegenber manueller Arbeit\n- **< 5 Min** Setup-Zeit\n- **< 3 Monate** ROI\n\n---\n\n##  Technische Details (falls gefragt)\n\n**Datenbank:**\n- PostgreSQL via Supabase/Neon\n- Multi-Tenant mit organization_id Foreign Keys\n- Automatische Rollback-Checkpoints\n\n**Security:**\n- Passport.js JWT Authentication\n- bcrypt Password-Hashing (10 Runden)\n- Server-seitiges organization_id Filtering\n\n**AI:**\n- OpenAI GPT-4o-mini\n- Modular Subprompt-Architektur\n- Category-based Template System\n\n**Pixi Integration:**\n- 5-Minuten-Caching (API-Performance)\n- Intelligentes Matching: Artikelnummer + EAN\n- Status-Persistierung in Supabase\n\n---\n\n##  Hufige Fragen & Antworten\n\n**F: \"Wie viele Kunden knnen wir gleichzeitig haben?\"**\n> A: \"Unbegrenzt. Die Multi-Tenant-Architektur skaliert horizontal. \n> Jeder Kunde hat seine eigene organization_id mit vollstndiger Datenisolation.\"\n\n**F: \"Was kostet uns die OpenAI API?\"**\n> A: \"~$0.002 pro Produktbeschreibung. Bei 1000 Generierungen = $2. \n> Wir berechnen dem Kunden $0.10 pro Generierung = $98 Marge.\"\n\n**F: \"Wie schnell knnen wir weitere ERP-Systeme integrieren?\"**\n> A: \"1-2 Wochen pro System. Die Pixi-Integration ist ein Template, \n> das wir wiederverwenden knnen.\"\n\n**F: \"Brauchen wir noch mehr Entwickler?\"**\n> A: \"Fr Launch: Nein. Fr Roadmap (Q1 2026): 1 zustzlicher Full-Stack Developer empfohlen.\"\n\n---\n\n##  Letzte Checks vor Prsentation\n\n- [ ] `docs/presentation.html` ffnet korrekt\n- [ ] App luft auf Port 5000\n- [ ] Login funktioniert (saranzerrer@icloud.com)\n- [ ] Pixi-Vergleich zeigt Daten\n- [ ] Architektur-Diagramm (`pimpilot-architecture.html`) ffnet\n\n---\n\n**Viel Erfolg bei der Prsentation! **\n","size_bytes":6382},"docs/README-Diagramme.md":{"content":"#  PIMPilot System-Diagramme\n\n##  Schnellstart\n\n### Option 1: HTML-Datei ( EMPFOHLEN)\n\n1. **ffnen:** `docs/pimpilot-architecture.html` im Browser (Doppelklick)\n2. **Downloaden:** Klick auf \"Als SVG herunterladen\" oder \"Als PNG herunterladen\"\n3. **Fertig!** Sie haben Ihr Diagramm als Bilddatei\n\n---\n\n##  Weitere Optionen\n\n### Option 2: Mermaid Live Editor (Online)\n\n1. ffnen Sie: https://mermaid.live\n2. Kopieren Sie den Inhalt von `docs/pimpilot-architecture.mmd`\n3. Einfgen in den Editor\n4. Klicken Sie auf **Actions**  **Export SVG** oder **Export PNG**\n\n### Option 3: VS Code Extension\n\n1. Installieren Sie **\"Mermaid Preview\"** in VS Code\n2. ffnen Sie `docs/pimpilot-architecture.mmd`\n3. Rechtsklick  **\"Open Preview\"**\n4. Im Preview: Rechtsklick  **\"Export as SVG/PNG\"**\n\n---\n\n##  Fr Figma-Import\n\nDa Figma keine programmatische Erstellung untersttzt:\n\n1. **SVG exportieren** (siehe oben)\n2. In Figma: **File**  **Import**  SVG auswhlen\n3. Das Diagramm wird als editierbare Shapes importiert\n4. Jetzt knnen Sie es in Figma bearbeiten\n\n---\n\n##  Diagramm-Struktur\n\nDas Diagramm zeigt die **vollstndige PIMPilot-Architektur** in 6 Schichten:\n\n###  Frontend Layer (Blau)\n- Dashboard, Projects, Products\n- AI Generator, Web Scraper, Pixi Compare\n\n###  Authentication (Orange)\n- Passport.js Middleware\n- JWT Token Validation\n- Multi-Tenant Isolation\n\n###  Backend API (Lila)\n- REST Endpoints fr alle Features\n- CRUD-Operationen\n- Multi-Tenant-Filterung\n\n###  Service Layer (Grn)\n- AI Service (OpenAI)\n- Scraper Service (Cheerio)\n- Pixi Service (ERP Integration)\n- Stripe Service (Payments)\n- Supabase Storage (Database)\n\n###  Database (Rosa)\n- Multi-Tenant PostgreSQL\n- Organizations, Users, Projects\n- Products, Suppliers, API Logs\n- ** = Pixi-Integration Fields**\n\n###  External Services (Gelb)\n- OpenAI API\n- Pixi ERP API\n- Stripe API\n\n---\n\n##  Datenfluss-Beispiel\n\n```\nUser interagiert mit Frontend\n    \nJWT-Token wird validiert (Auth Middleware)\n    \nAPI-Endpoint empfngt Request\n    \nService-Layer verarbeitet Business Logic\n    \nDatenbank-Queries mit organization_id-Filter\n    \nResponse zurck an Frontend\n```\n\n---\n\n##  Technologie-Stack\n\n- **Frontend:** React 18, TypeScript, Vite, Tailwind CSS\n- **Backend:** Express.js, TypeScript, Passport.js\n- **Database:** PostgreSQL (Supabase/Neon)\n- **AI:** OpenAI GPT-4o-mini\n- **Web Scraping:** Cheerio\n- **Payments:** Stripe\n\n---\n\n##  Support\n\nBei Fragen zur Architektur:\n- Siehe `replit.md` fr detaillierte Dokumentation\n- Alle Pixi-Integration Details in `PIXI_INTEGRATION.md`\n\n---\n\n**Zuletzt aktualisiert:** 31. Oktober 2025  \n**Version:** 2.0 (mit Pixi-Supabase-Integration)\n","size_bytes":2759},"shared/brickfox-schema.ts":{"content":"/**\n * Brickfox CSV Export Schema\n * Defines all Brickfox fields, their types, scopes, and default values\n */\n\nexport type BrickfoxFieldScope = 'product' | 'variant';\nexport type BrickfoxFieldType = 'string' | 'number' | 'boolean' | 'price';\nexport type BrickfoxSourceType = 'scraped' | 'constant' | 'calculated' | 'ai_generated';\n\nexport interface BrickfoxFieldMeta {\n  key: string;\n  label: string;\n  scope: BrickfoxFieldScope;\n  type: BrickfoxFieldType;\n  locale?: string;\n  required?: boolean;\n  defaultValue?: string | number | boolean;\n  sourceType: BrickfoxSourceType;\n  description?: string;\n  calculation?: string; // Formula description\n}\n\nexport const BRICKFOX_FIELDS: BrickfoxFieldMeta[] = [\n  // Product-level fields\n  {\n    key: 'p_item_number',\n    label: 'Artikelnummer',\n    scope: 'product',\n    type: 'string',\n    required: true,\n    sourceType: 'scraped',\n    description: 'Eindeutige Artikelnummer des Produkts'\n  },\n  {\n    key: 'p_group_path[de]',\n    label: 'Kategoriepfad',\n    scope: 'product',\n    type: 'string',\n    locale: 'de',\n    sourceType: 'scraped',\n    description: 'Kategoriepfad (z.B. \"Akkus > Werkzeugakkus > Makita\")'\n  },\n  {\n    key: 'p_brand',\n    label: 'Marke / Hersteller',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'Marke oder Hersteller des Produkts'\n  },\n  {\n    key: 'p_status',\n    label: 'Produktstatus',\n    scope: 'product',\n    type: 'string',\n    defaultValue: 'Aktiv',\n    sourceType: 'constant',\n    description: 'Status des Produkts (Aktiv/Inaktiv)'\n  },\n  {\n    key: 'p_name[de]',\n    label: 'Produktname (deutsch)',\n    scope: 'product',\n    type: 'string',\n    locale: 'de',\n    required: true,\n    sourceType: 'scraped',\n    description: 'Produktname in deutscher Sprache'\n  },\n  {\n    key: 'p_tax_class',\n    label: 'Steuerklasse',\n    scope: 'product',\n    type: 'string',\n    defaultValue: 'Regelsteuersatz (19%)',\n    sourceType: 'constant',\n    description: 'Steuerklasse fr das Produkt'\n  },\n  {\n    key: 'p_never_out_of_stock',\n    label: 'Immer lieferbar',\n    scope: 'product',\n    type: 'boolean',\n    defaultValue: false,\n    sourceType: 'constant',\n    description: 'Ob das Produkt immer lieferbar ist'\n  },\n  {\n    key: 'p_condition',\n    label: 'Zustand',\n    scope: 'product',\n    type: 'string',\n    defaultValue: 'Neu',\n    sourceType: 'constant',\n    description: 'Zustand des Produkts (Neu/Gebraucht)'\n  },\n  {\n    key: 'p_country',\n    label: 'Herkunftsland',\n    scope: 'product',\n    type: 'string',\n    defaultValue: 'China',\n    sourceType: 'constant',\n    description: 'Herkunftsland des Produkts'\n  },\n  {\n    key: 'p_description[de]',\n    label: 'Produktbeschreibung (deutsch)',\n    scope: 'product',\n    type: 'string',\n    locale: 'de',\n    sourceType: 'ai_generated',\n    description: 'KI-optimierte Produktbeschreibung basierend auf Lieferantenbeschreibung'\n  },\n  // Variant-level fields\n  {\n    key: 'v_item_number',\n    label: 'Varianten-Artikelnummer',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'Artikelnummer der Variante (kann gleich p_item_number sein)'\n  },\n  {\n    key: 'v_ean',\n    label: 'EAN / GTIN',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'EAN-Code der Variante'\n  },\n  {\n    key: 'v_manufacturers_item_number',\n    label: 'Herstellerartikelnummer',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'Artikelnummer beim Hersteller'\n  },\n  {\n    key: 'v_status',\n    label: 'Variantenstatus',\n    scope: 'variant',\n    type: 'string',\n    defaultValue: 'aktiv',\n    sourceType: 'constant',\n    description: 'Status der Variante'\n  },\n  {\n    key: 'v_classification',\n    label: 'Variantenklassifizierung',\n    scope: 'variant',\n    type: 'string',\n    defaultValue: 'X',\n    sourceType: 'constant',\n    description: 'Klassifizierung der Variante (z.B. Gre, Farbe, Kapazitt)'\n  },\n  {\n    key: 'v_price[Eur]',\n    label: 'Verkaufspreis (EUR)',\n    scope: 'variant',\n    type: 'price',\n    locale: 'Eur',\n    sourceType: 'calculated',\n    calculation: 'EK * 2 + 19%',\n    description: 'Berechneter Verkaufspreis: (Einkaufspreis * 2) + 19% MwSt'\n  },\n  {\n    key: 'v_delivery_time[de]',\n    label: 'Lieferzeit (deutsch)',\n    scope: 'variant',\n    type: 'string',\n    locale: 'de',\n    defaultValue: '3-5 Tage',\n    sourceType: 'constant',\n    description: 'Lieferzeit fr die Variante'\n  },\n  {\n    key: 'v_supplier[Eur]',\n    label: 'Lieferant',\n    scope: 'variant',\n    type: 'string',\n    locale: 'Eur',\n    sourceType: 'constant',\n    description: 'Name des Lieferanten (automatisch vom Supplier-Namen)'\n  },\n  {\n    key: 'v_supplier_item_number',\n    label: 'Artikelnummer beim Lieferanten',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'Artikelnummer wie beim Lieferanten gelistet'\n  },\n  {\n    key: 'v_purchase_price',\n    label: 'Einkaufspreis',\n    scope: 'variant',\n    type: 'price',\n    sourceType: 'scraped',\n    description: 'Einkaufspreis vom Lieferanten'\n  },\n  {\n    key: 'v_never_out_of_stock[standard]',\n    label: 'Immer verfgbar (Variante)',\n    scope: 'variant',\n    type: 'boolean',\n    defaultValue: false,\n    sourceType: 'constant',\n    description: 'Ob die Variante immer verfgbar ist'\n  },\n  {\n    key: 'v_weight',\n    label: 'Gewicht (g)',\n    scope: 'variant',\n    type: 'number',\n    sourceType: 'scraped',\n    description: 'Gewicht der Variante in Gramm'\n  },\n  {\n    key: 'v_length',\n    label: 'Lnge (mm)',\n    scope: 'variant',\n    type: 'number',\n    sourceType: 'scraped',\n    description: 'Lnge der Variante in Millimetern'\n  },\n  {\n    key: 'v_width',\n    label: 'Breite (mm)',\n    scope: 'variant',\n    type: 'number',\n    sourceType: 'scraped',\n    description: 'Breite der Variante in Millimetern'\n  },\n  {\n    key: 'v_height',\n    label: 'Hhe (mm)',\n    scope: 'variant',\n    type: 'number',\n    sourceType: 'scraped',\n    description: 'Hhe der Variante in Millimetern'\n  },\n  {\n    key: 'v_capacity_mah',\n    label: 'Kapazitt (mAh)',\n    scope: 'variant',\n    type: 'number',\n    sourceType: 'scraped',\n    description: 'Akkukapazitt in Milliamperestunden'\n  },\n  {\n    key: 'v_customs_tariff_number',\n    label: 'Zolltarifnummer',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'ai_generated',\n    description: 'KI-generierte Zolltarifnummer (falls nicht gescraped)'\n  },\n  {\n    key: 'v_customs_tariff_text',\n    label: 'Beschreibung des Zolltarifs',\n    scope: 'variant',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'Beschreibung des Zolltarifs'\n  },\n  // Produktbilder (bis zu 10 Bilder)\n  {\n    key: 'p_image[1]',\n    label: 'Produktbild 1',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum ersten Produktbild'\n  },\n  {\n    key: 'p_image[2]',\n    label: 'Produktbild 2',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum zweiten Produktbild'\n  },\n  {\n    key: 'p_image[3]',\n    label: 'Produktbild 3',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum dritten Produktbild'\n  },\n  {\n    key: 'p_image[4]',\n    label: 'Produktbild 4',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum vierten Produktbild'\n  },\n  {\n    key: 'p_image[5]',\n    label: 'Produktbild 5',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum fnften Produktbild'\n  },\n  {\n    key: 'p_image[6]',\n    label: 'Produktbild 6',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum sechsten Produktbild'\n  },\n  {\n    key: 'p_image[7]',\n    label: 'Produktbild 7',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum siebten Produktbild'\n  },\n  {\n    key: 'p_image[8]',\n    label: 'Produktbild 8',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum achten Produktbild'\n  },\n  {\n    key: 'p_image[9]',\n    label: 'Produktbild 9',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum neunten Produktbild'\n  },\n  {\n    key: 'p_image[10]',\n    label: 'Produktbild 10',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL oder Pfad zum zehnten Produktbild'\n  },\n  // PDF Media Files\n  {\n    key: 'p_media[1][pdf]',\n    label: 'PDF-Datei 1 (MSDS/Manual)',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL zur ersten PDF-Datei (z.B. MSDS, Bedienungsanleitung)'\n  },\n  {\n    key: 'p_media[2][pdf]',\n    label: 'PDF-Datei 2 (Manual/PIB)',\n    scope: 'product',\n    type: 'string',\n    sourceType: 'scraped',\n    description: 'URL zur zweiten PDF-Datei (z.B. Produktinformationsblatt)'\n  }\n];\n\n// Helper: Get all fields by scope\nexport function getBrickfoxFieldsByScope(scope: BrickfoxFieldScope): BrickfoxFieldMeta[] {\n  return BRICKFOX_FIELDS.filter(f => f.scope === scope);\n}\n\n// Helper: Get field by key\nexport function getBrickfoxField(key: string): BrickfoxFieldMeta | undefined {\n  return BRICKFOX_FIELDS.find(f => f.key === key);\n}\n\n// Helper: Get all scraped fields (for UI mapping dropdown)\nexport function getScrapedFields(): BrickfoxFieldMeta[] {\n  return BRICKFOX_FIELDS.filter(f => f.sourceType === 'scraped');\n}\n\n// Helper: Get all constant fields\nexport function getConstantFields(): BrickfoxFieldMeta[] {\n  return BRICKFOX_FIELDS.filter(f => f.sourceType === 'constant');\n}\n\n// Helper: Get all AI-generated fields\nexport function getAIGeneratedFields(): BrickfoxFieldMeta[] {\n  return BRICKFOX_FIELDS.filter(f => f.sourceType === 'ai_generated');\n}\n\n// Mapping configuration type for suppliers\nexport interface BrickfoxExportMapping {\n  [brickfoxField: string]: {\n    source: 'scraped' | 'constant' | 'calculated' | 'ai';\n    field?: string; // Scraped field name (e.g., 'articleNumber', 'productName')\n    value?: string | number | boolean; // Constant value\n  };\n}\n\n// Default mapping template (can be overridden per supplier)\nexport const DEFAULT_BRICKFOX_MAPPING: BrickfoxExportMapping = {\n  // Product fields - scraped\n  'p_item_number': { source: 'scraped', field: 'articleNumber' },\n  'p_group_path[de]': { source: 'scraped', field: 'kategorie' },  // German field name\n  'p_brand': { source: 'scraped', field: 'hersteller' },  // German field name\n  'p_name[de]': { source: 'scraped', field: 'productName' },\n  \n  // Product fields - constants\n  'p_status': { source: 'constant', value: 'Aktiv' },\n  'p_tax_class': { source: 'constant', value: 'Regelsteuersatz (19%)' },\n  'p_never_out_of_stock': { source: 'constant', value: false },\n  'p_condition': { source: 'constant', value: 'Neu' },\n  'p_country': { source: 'constant', value: 'China' },\n  \n  // Product fields - AI\n  'p_description[de]': { source: 'scraped', field: 'htmlCode' },  // Use scraped HTML description\n  \n  // Produktbilder - scraped (werden automatisch aus localImagePaths extrahiert)\n  'p_image[1]': { source: 'scraped', field: 'localImagePaths[0]' },\n  'p_image[2]': { source: 'scraped', field: 'localImagePaths[1]' },\n  'p_image[3]': { source: 'scraped', field: 'localImagePaths[2]' },\n  'p_image[4]': { source: 'scraped', field: 'localImagePaths[3]' },\n  'p_image[5]': { source: 'scraped', field: 'localImagePaths[4]' },\n  'p_image[6]': { source: 'scraped', field: 'localImagePaths[5]' },\n  'p_image[7]': { source: 'scraped', field: 'localImagePaths[6]' },\n  'p_image[8]': { source: 'scraped', field: 'localImagePaths[7]' },\n  'p_image[9]': { source: 'scraped', field: 'localImagePaths[8]' },\n  'p_image[10]': { source: 'scraped', field: 'localImagePaths[9]' },\n  \n  // Variant fields - scraped\n  'v_item_number': { source: 'scraped', field: 'articleNumber' },\n  'v_ean': { source: 'scraped', field: 'ean' },\n  'v_manufacturers_item_number': { source: 'scraped', field: 'manufacturerArticleNumber' },  // OHNE Prfix (z.B. \"1522-0045\")\n  'v_supplier_item_number': { source: 'scraped', field: 'manufacturerArticleNumber' },  // OHNE Prfix (z.B. \"1522-0045\")\n  'v_purchase_price': { source: 'scraped', field: 'preis' },  // German field name\n  'v_weight': { source: 'scraped', field: 'gewicht' },  // German field name\n  'v_length': { source: 'scraped', field: 'laenge' },  // German field name\n  'v_width': { source: 'scraped', field: 'breite' },  // German field name\n  'v_height': { source: 'scraped', field: 'hoehe' },  // German field name\n  'v_capacity_mah': { source: 'scraped', field: 'nominalkapazitaet' },  // German field name\n  'v_customs_tariff_text': { source: 'scraped', field: 'customsTariff' },\n  \n  // Variant fields - constants\n  'v_status': { source: 'constant', value: 'aktiv' },\n  'v_classification': { source: 'constant', value: 'X' },\n  'v_delivery_time[de]': { source: 'constant', value: '3-5 Tage' },\n  'v_supplier[Eur]': { source: 'constant', value: 'Unbekannt' },  // Will be replaced with actual supplier name\n  'v_never_out_of_stock[standard]': { source: 'constant', value: true },  // Always available\n  \n  // Variant fields - calculated\n  'v_price[Eur]': { source: 'calculated' }, // Will be calculated from v_purchase_price\n  \n  // Variant fields - AI\n  'v_customs_tariff_number': { source: 'ai' },\n};\n","size_bytes":13483},"server/services/brickfox-ai-enhancer.ts":{"content":"/**\n * Brickfox AI Enhancement Service\n * Uses OpenAI to generate missing Brickfox fields\n */\n\nimport OpenAI from 'openai';\nimport type { ProductInProject } from '../../shared/schema';\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY || process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport interface AIEnhancementResult {\n  customs_tariff_number?: string;\n  customs_tariff_text?: string;\n  optimized_description?: string;\n}\n\n/**\n * Generate customs tariff number (Zolltarifnummer) using AI\n */\nasync function generateCustomsTariffNumber(product: ProductInProject): Promise<{ number: string; text: string } | null> {\n  try {\n    const extractedData = product.extractedData?.[0];\n    const customAttrs = product.customAttributes || [];\n    \n    const productInfo = `\n      Produktname: ${product.name || product.exactProductName || 'Unbekannt'}\n      Artikelnummer: ${product.articleNumber || 'Unbekannt'}\n      Kategorie: ${customAttrs.find(a => a.key === 'kategorie')?.value || extractedData?.fileName || 'Unbekannt'}\n      Hersteller: ${customAttrs.find(a => a.key === 'hersteller')?.value || 'Unbekannt'}\n    `.trim();\n\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: 'Du bist ein Experte fr Zolltarifnummern (HS-Codes). Generiere die korrekte 8-stellige Zolltarifnummer fr das beschriebene Produkt. Antworte NUR mit der Nummer und einer kurzen Beschreibung im Format: \"12345678|Beschreibung\".'\n        },\n        {\n          role: 'user',\n          content: `Bestimme die Zolltarifnummer fr folgendes Produkt:\\n\\n${productInfo}`\n        }\n      ],\n      temperature: 0.3,\n      max_tokens: 100,\n    });\n\n    const result = response.choices[0]?.message?.content?.trim();\n    if (!result) return null;\n\n    const [number, ...textParts] = result.split('|');\n    const text = textParts.join('|').trim();\n\n    return {\n      number: number.trim(),\n      text: text || number.trim()\n    };\n  } catch (error) {\n    console.error('[AI Enhancer] Failed to generate customs tariff:', error);\n    return null;\n  }\n}\n\n/**\n * Optimize product description for Brickfox/OTTO Market\n */\nasync function optimizeDescription(product: ProductInProject): Promise<string | null> {\n  try {\n    const extractedData = product.extractedData?.[0];\n    const customAttrs = product.customAttributes || [];\n    \n    // Use description from customAttributes (scraped from supplier)\n    const scrapedDesc = customAttrs.find(a => a.key === 'description')?.value;\n    const originalDescription = scrapedDesc || product.previewText || extractedData?.extractedText || extractedData?.description || '';\n    \n    if (!originalDescription) return null;\n\n    const productInfo = `\n      Produktname: ${product.name || product.exactProductName}\n      Hersteller: ${customAttrs.find(a => a.key === 'manufacturer')?.value || ''}\n      Kategorie: ${customAttrs.find(a => a.key === 'category')?.value || ''}\n      Original-Beschreibung: ${originalDescription}\n    `.trim();\n\n    const response = await openai.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: 'Du bist ein Experte fr E-Commerce Produktbeschreibungen. Optimiere die Produktbeschreibung fr bessere Verkaufschancen: kurz, prgnant, verkaufsfrdernd, SEO-optimiert. Verwende Bullet-Points fr Features. Max. 500 Zeichen.'\n        },\n        {\n          role: 'user',\n          content: `Optimiere folgende Produktbeschreibung:\\n\\n${productInfo}`\n        }\n      ],\n      temperature: 0.7,\n      max_tokens: 300,\n    });\n\n    return response.choices[0]?.message?.content?.trim() || null;\n  } catch (error) {\n    console.error('[AI Enhancer] Failed to optimize description:', error);\n    return null;\n  }\n}\n\n/**\n * Enhance product data with AI-generated fields\n */\nexport async function enhanceProductWithAI(product: ProductInProject): Promise<AIEnhancementResult> {\n  const result: AIEnhancementResult = {};\n\n  try {\n    // Generate all AI fields in parallel for speed\n    const [tariff, description] = await Promise.all([\n      generateCustomsTariffNumber(product),\n      optimizeDescription(product),\n    ]);\n\n    if (tariff) {\n      result.customs_tariff_number = tariff.number;\n      result.customs_tariff_text = tariff.text;\n    }\n\n    if (description) {\n      result.optimized_description = description;\n    }\n\n    return result;\n  } catch (error) {\n    console.error('[AI Enhancer] Error enhancing product:', error);\n    return result;\n  }\n}\n\n/**\n * Batch enhance multiple products\n */\nexport async function enhanceProductsWithAI(products: ProductInProject[]): Promise<Map<string, AIEnhancementResult>> {\n  const results = new Map<string, AIEnhancementResult>();\n\n  // Process in batches of 5 to avoid rate limits\n  const batchSize = 5;\n  for (let i = 0; i < products.length; i += batchSize) {\n    const batch = products.slice(i, i + batchSize);\n    const batchResults = await Promise.all(\n      batch.map(async (product) => {\n        const enhancement = await enhanceProductWithAI(product);\n        return { id: product.id, enhancement };\n      })\n    );\n\n    batchResults.forEach(({ id, enhancement }) => {\n      results.set(id, enhancement);\n    });\n\n    // Small delay between batches\n    if (i + batchSize < products.length) {\n      await new Promise(resolve => setTimeout(resolve, 1000));\n    }\n  }\n\n  return results;\n}\n","size_bytes":5531},"server/services/brickfox-mapper.ts":{"content":"/**\n * Brickfox Mapper Service\n * Transforms scraped product data into Brickfox CSV format\n */\n\nimport { \n  BRICKFOX_FIELDS, \n  BrickfoxExportMapping, \n  DEFAULT_BRICKFOX_MAPPING,\n  getBrickfoxField \n} from '../../shared/brickfox-schema';\nimport type { ProductInProject } from '../../shared/schema';\n\n// Debug logging helper - only logs when DEBUG_MODE=true\nconst DEBUG_MODE = process.env.DEBUG_MODE === 'true';\nfunction debugLog(...args: any[]) {\n  if (DEBUG_MODE) {\n    console.log('[Brickfox Mapper DEBUG]', ...args);\n  }\n}\n\nexport interface BrickfoxRow {\n  [key: string]: string | number | boolean | null;\n}\n\nexport interface BrickfoxMapperOptions {\n  supplierName?: string;\n  customMapping?: BrickfoxExportMapping;\n  enableAI?: boolean;\n  fixedValues?: Record<string, string | number>;\n  autoGenerateRules?: Record<string, {\n    dependsOn: string;\n    rule: string;\n    fallback?: string;\n  }>;\n}\n\n/**\n * Calculate sales price from purchase price\n * Formula: (EK * 2) + 19% = EK * 2 * 1.19\n */\nfunction calculateSalesPrice(purchasePrice: number): number {\n  return purchasePrice * 2 * 1.19;\n}\n\n/**\n * Parse weight from string (e.g., \"150g\"  150, \"1.5 kg\"  1500)\n */\nfunction parseWeight(weight: string | number | null): number | null {\n  if (weight === null || weight === undefined) return null;\n  if (typeof weight === 'number') return weight;\n  \n  const str = weight.toString().toLowerCase().trim();\n  \n  // German decimal format handling:\n  // - Comma = decimal separator\n  // - Dot = thousand separator\n  // Examples: \"1.234,5 kg\", \"2.500 g\", \"1,5 kg\", \"101 g\"\n  let normalized = str;\n  if (str.includes(',')) {\n    // Has comma  German format with decimal\n    // Remove all dots (thousand separators), replace comma with dot\n    // \"1.234,5 kg\"  \"1234.5\", \"39,75\"  \"39.75\"\n    normalized = str.replace(/\\./g, '').replace(',', '.');\n  } else if (str.includes('.')) {\n    // Has dot but no comma  Could be German thousand separator OR English decimal\n    // Most data has commas, but some numbers use dots as thousand separators\n    \n    // Extract just the number part\n    const numPart = str.match(/[\\d.]+/)?.[0] || str;\n    \n    // Heuristic: Dot followed by exactly 3 digits  German thousand separator\n    // \"2.500 g\"  2500g (thousand)\n    // \"2.5 kg\"  2.5kg (decimal)\n    // \"1.234 \"  1234 (thousand)\n    const dotMatch = numPart.match(/\\.(\\d+)$/);\n    if (dotMatch && dotMatch[1].length === 3) {\n      // Exactly 3 digits after last dot  German thousand separator\n      normalized = str.replace(/\\./g, '');\n    }\n    // Otherwise keep dot as decimal: \"1.5 kg\", \"0.75 kg\", \"10.99 \"\n  }\n  // No dot or comma: \"101 g\"  \"101\", \"250 g\"  \"250\"\n  \n  const match = normalized.match(/(\\d+\\.?\\d*)\\s*(g|kg|gram|kilogram)?/);\n  if (!match) return null;\n  \n  const value = parseFloat(match[1]);\n  const unit = match[2];\n  \n  if (unit && (unit.startsWith('kg') || unit.startsWith('kilogram'))) {\n    return value * 1000; // Convert kg to g\n  }\n  \n  return value;\n}\n\n/**\n * Parse price from string (e.g., \"12,50 \"  12.50, \"$15.99\"  15.99)\n */\nfunction parsePrice(price: string | number | null): number | null {\n  if (price === null || price === undefined) return null;\n  if (typeof price === 'number') return price;\n  \n  // Remove currency symbols and whitespace\n  let str = price.toString().replace(/[^\\d,.-]/g, '').trim();\n  \n  // German decimal format handling (same logic as parseWeight):\n  // - Comma = decimal separator\n  // - Dot = thousand separator\n  // Examples: \"1.234,56 \"  1234.56, \"39,75 \"  39.75, \"9,92 \"  9.92\n  let normalized = str;\n  if (str.includes(',')) {\n    // Has comma  German format with decimal\n    // Remove all dots (thousand separators), replace comma with dot\n    // \"1.234,56\"  \"1234.56\", \"39,75\"  \"39.75\"\n    normalized = str.replace(/\\./g, '').replace(',', '.');\n  } else if (str.includes('.')) {\n    // Has dot but no comma  Could be German thousand separator OR English decimal\n    // Most data has commas, but some numbers use dots as thousand separators\n    \n    // Heuristic: Dot followed by exactly 3 digits  German thousand separator\n    // \"1.234 \"  1234 (thousand)\n    // \"2.500 \"  2500 (thousand)\n    // \"15.99 \"  15.99 (decimal, only 2 digits)\n    const dotMatch = str.match(/\\.(\\d+)$/);\n    if (dotMatch && dotMatch[1].length === 3) {\n      // Exactly 3 digits after last dot  German thousand separator\n      normalized = str.replace(/\\./g, '');\n    }\n    // Otherwise keep dot as decimal: \"15.99\", \"9.95\"\n  }\n  \n  const value = parseFloat(normalized);\n  return isNaN(value) ? null : value;\n}\n\n/**\n * Intelligentes Auto-Mapping: Erkennt automatisch Felder aus den Produktdaten\n * basierend auf Label-Namen (z.B. \"Produktbeschreibung\", \"VK (Verkaufspreis)\", \"Lnge\")\n */\nfunction autoMapFieldByLabel(\n  product: ProductInProject,\n  brickfoxField: string\n): string | number | boolean | null {\n  if (!product.extractedData || product.extractedData.length === 0) {\n    return null;\n  }\n\n  // Mapping von Brickfox-Feldern zu mglichen Label-Namen (case-insensitive)\n  const labelMappings: Record<string, string[]> = {\n    'p_item_number': ['artikelnummer', 'art.-nr', 'art.nr', 'artnr', 'item number', 'sku'],\n    'p_name[de]': ['produktname', 'name', 'bezeichnung', 'product name', 'title'],\n    'p_description[de]': ['produktbeschreibung', 'beschreibung', 'description', 'langtext', 'long text'],\n    'v_ean': ['ean', 'ean-code', 'ean code', 'barcode', 'gtin'],\n    'v_price[Eur]': ['vkprice', 'vk (verkaufspreis)', 'vk', 'verkaufspreis', 'uvp', 'preis', 'price', 'rrp'],\n    'v_purchase_price': ['ekprice', 'ek-preis', 'ek', 'einkaufspreis', 'purchase price', 'cost'],\n    'v_weight': ['gewicht', 'weight', 'netto-gewicht', 'bruttogewicht'],\n    'v_width': ['breite', 'width', 'b'],\n    'v_height': ['hhe', 'hoehe', 'height', 'h'],\n    'v_depth': ['lnge', 'laenge', 'tiefe', 'length', 'depth', 'l'],\n    'v_brand': ['hersteller', 'marke', 'brand', 'manufacturer'],\n  };\n\n  const possibleLabels = labelMappings[brickfoxField];\n  if (!possibleLabels) return null;\n\n  // Suche nach passendem Label in extractedData\n  for (const item of product.extractedData) {\n    // Prfe sowohl 'label' als auch 'key' Felder\n    const labelLower = item.label ? item.label.toLowerCase().trim() : '';\n    const keyLower = item.key ? item.key.toLowerCase().trim() : '';\n    \n    // Exakte bereinstimmung oder enthlt das Schlsselwort\n    for (const keyword of possibleLabels) {\n      if (labelLower === keyword || labelLower.includes(keyword) ||\n          keyLower === keyword || keyLower.includes(keyword)) {\n        return item.value;\n      }\n    }\n  }\n\n  return null;\n}\n\n/**\n * Get value from product data using field mapping\n */\nfunction getFieldValue(\n  product: ProductInProject,\n  mapping: BrickfoxExportMapping,\n  brickfoxField: string,\n  supplierName?: string\n): string | number | boolean | null {\n  const config = mapping[brickfoxField];\n  const fieldMeta = getBrickfoxField(brickfoxField);\n  if (!fieldMeta) return null;\n  \n  // SPECIAL CASE: p_description[de] soll IMMER Beschreibung verwenden (nicht Auto-Mapping!)\n  if (brickfoxField === 'p_description[de]') {\n    // Priority 1: htmlCode Feld (AI-generierter HTML-Code)\n    const htmlCode = (product as any).htmlCode;\n    if (htmlCode && htmlCode.trim()) {\n      debugLog(`[SPECIAL] p_description[de]  htmlCode (${htmlCode.length} chars)`);\n      return htmlCode;\n    }\n    \n    // Priority 2: autoExtractedDescription aus extractedData\n    if (product.extractedData && product.extractedData.length > 0) {\n      const autoExtracted = product.extractedData.find((item: any) => \n        item.key === 'autoExtractedDescription'\n      );\n      if (autoExtracted && autoExtracted.value) {\n        debugLog(`[SPECIAL] p_description[de]  autoExtractedDescription (${autoExtracted.value.length} chars)`);\n        return autoExtracted.value;\n      }\n      \n      // Priority 3: Fallback auf \"Produktbeschreibung\" Label\n      const descItem = product.extractedData.find((item: any) => \n        item.label && item.label.toLowerCase().includes('produktbeschreibung')\n      );\n      if (descItem && descItem.value) {\n        debugLog(`[SPECIAL] p_description[de]  Produktbeschreibung label (${descItem.value.length} chars)`);\n        return descItem.value;\n      }\n    }\n  }\n  \n  // SPECIAL CASE: p_image[1] bis p_image[10] - Extrahiere Bilder aus Original-URLs oder lokalen Pfaden\n  if (brickfoxField.startsWith('p_image[')) {\n    const imageIndex = parseInt(brickfoxField.match(/\\[(\\d+)\\]/)?.[1] || '0') - 1; // p_image[1]  Index 0\n    \n    // PRIORITY 1: Original image URLs direkt aus product.images (vom URL-Scraper)\n    // Diese sind die Original-URLs von der Lieferanten-Website\n    const productImages = (product as any).images;\n    if (productImages && Array.isArray(productImages) && productImages.length > 0) {\n      if (productImages[imageIndex]) {\n        debugLog(`[SPECIAL] ${brickfoxField}  Original product.images[${imageIndex}]: ${productImages[imageIndex]}`);\n        return productImages[imageIndex];\n      }\n    }\n    \n    // PRIORITY 2: localImagePaths aus extractedData (heruntergeladene Bilder als Fallback)\n    // Nur wenn keine Original-URLs vorhanden sind, verwenden wir lokale Pfade\n    if (product.extractedData && product.extractedData.length > 0) {\n      const localImagesItem = product.extractedData.find((item: any) => \n        item.key === 'localImagePaths'\n      );\n      if (localImagesItem && localImagesItem.value) {\n        // localImagePaths kann ein String \"/path/to/image.jpg\" oder ein Array sein\n        let imagePaths: string[] = [];\n        if (typeof localImagesItem.value === 'string') {\n          // Einzelner Pfad oder komma-separierte Liste\n          imagePaths = localImagesItem.value.split(',').map((p: string) => p.trim()).filter(Boolean);\n        } else if (Array.isArray(localImagesItem.value)) {\n          imagePaths = localImagesItem.value.filter(Boolean);\n        }\n        \n        if (imagePaths[imageIndex]) {\n          debugLog(`[SPECIAL] ${brickfoxField}  localImagePaths[${imageIndex}]: ${imagePaths[imageIndex]}`);\n          return imagePaths[imageIndex];\n        }\n      }\n    }\n    \n    // PRIORITY 3: Direkt aus product.extractedData nach \"images\" oder hnlichen Feldern suchen\n    if (product.extractedData && product.extractedData.length > 0) {\n      const imagesItem = product.extractedData.find((item: any) => \n        item.key === 'images' || item.key === 'productImages' || item.key === 'downloadedImages'\n      );\n      if (imagesItem && imagesItem.value) {\n        let images: string[] = [];\n        if (typeof imagesItem.value === 'string') {\n          images = imagesItem.value.split(',').map((p: string) => p.trim()).filter(Boolean);\n        } else if (Array.isArray(imagesItem.value)) {\n          images = imagesItem.value.filter(Boolean);\n        }\n        \n        if (images[imageIndex]) {\n          debugLog(`[SPECIAL] ${brickfoxField}  images[${imageIndex}]: ${images[imageIndex]}`);\n          return images[imageIndex];\n        }\n      }\n    }\n    \n    // Kein Bild fr diesen Index gefunden\n    return null;\n  }\n  \n  // SPECIAL CASE: p_media[1][pdf] und p_media[2][pdf] - Extrahiere PDFs aus extractedData\n  if (brickfoxField.startsWith('p_media[') && brickfoxField.endsWith('[pdf]')) {\n    const mediaIndex = parseInt(brickfoxField.match(/\\[(\\d+)\\]/)?.[1] || '0') - 1; // p_media[1][pdf]  Index 0\n    \n    // Extract PDFs from extractedData.pdfFiles\n    if (product.extractedData && product.extractedData.length > 0) {\n      const pdfFilesItem = product.extractedData.find((item: any) => \n        item.key === 'pdfFiles'\n      );\n      if (pdfFilesItem && pdfFilesItem.value) {\n        let pdfUrls: string[] = [];\n        try {\n          // pdfFiles ist ein JSON-Array von URLs\n          if (typeof pdfFilesItem.value === 'string') {\n            pdfUrls = JSON.parse(pdfFilesItem.value);\n          } else if (Array.isArray(pdfFilesItem.value)) {\n            pdfUrls = pdfFilesItem.value;\n          }\n          \n          if (pdfUrls[mediaIndex]) {\n            debugLog(`[SPECIAL] ${brickfoxField}  pdfFiles[${mediaIndex}]: ${pdfUrls[mediaIndex]}`);\n            return pdfUrls[mediaIndex];\n          }\n        } catch (error) {\n          // Silently handle parse errors - pdfFiles might be a simple string URL instead of JSON array\n          debugLog(`[INFO] pdfFiles is not a JSON array, treating as single value`);\n        }\n      }\n    }\n    \n    // Kein PDF fr diesen Index gefunden\n    return null;\n  }\n  \n  // Falls kein Config vorhanden, versuche Auto-Mapping\n  if (!config) {\n    const autoMappedValue = autoMapFieldByLabel(product, brickfoxField);\n    if (autoMappedValue !== null && autoMappedValue !== undefined && autoMappedValue !== '') {\n      let value: any = autoMappedValue;\n      \n      // Parse based on field type\n      if (fieldMeta.type === 'number' || fieldMeta.key === 'v_weight') {\n        value = parseWeight(value);\n      } else if (fieldMeta.type === 'price') {\n        value = parsePrice(value);\n      }\n      \n      debugLog(`[AUTO-MAPPED] ${brickfoxField}  ${value}`);\n      return value;\n    }\n    return fieldMeta.defaultValue || null;\n  }\n  \n  // Special handling for v_supplier[Eur] - always use supplierName if available\n  if (brickfoxField === 'v_supplier[Eur]') {\n    return supplierName || config.value || fieldMeta.defaultValue || 'Unbekannt';\n  }\n  \n  // Constant value\n  if (config.source === 'constant') {\n    return config.value ?? fieldMeta.defaultValue ?? null;\n  }\n  \n  // Calculated value - PRIORITT 1: VK-Preis mit intelligenter Logik\n  if (config.source === 'calculated') {\n    if (brickfoxField === 'v_price[Eur]') {\n      // PRIORITY 1: Prfe ob vkPrice bereits in extractedData vorhanden ist\n      const existingVkPrice = autoMapFieldByLabel(product, 'v_price[Eur]');\n      if (existingVkPrice !== null && existingVkPrice !== undefined && existingVkPrice !== '') {\n        let value: any = existingVkPrice;\n        if (fieldMeta.type === 'price') {\n          value = parsePrice(value);\n        }\n        debugLog(`[CALCULATED] v_price[Eur]  Existing vkPrice from extractedData: ${value}`);\n        return value;\n      }\n      \n      // PRIORITY 2: Berechne VK aus EK (nur wenn kein vkPrice vorhanden)\n      const purchasePrice = getFieldValue(product, mapping, 'v_purchase_price', supplierName);\n      if (typeof purchasePrice === 'number') {\n        const calculated = calculateSalesPrice(purchasePrice);\n        debugLog(`[CALCULATED] v_price[Eur]  Calculated from EK ${purchasePrice}: ${calculated}`);\n        return calculated;\n      }\n    }\n    return null;\n  }\n  \n  // Scraped value\n  if (config.source === 'scraped' && config.field) {\n    // Try direct product fields first\n    let value: any = (product as any)[config.field];\n    \n    // If not found, try extractedData array (new format: [{key, value, type}])\n    if (!value && product.extractedData && product.extractedData.length > 0) {\n      const extracted = product.extractedData.find((item: any) => item.key === config.field);\n      if (extracted) {\n        value = (extracted as any).value;\n      }\n    }\n    \n    // Debug logging - only when DEBUG_MODE=true\n    debugLog(`Field: ${config.field}, Found value:`, value);\n    \n    // Parse based on field type\n    if (fieldMeta.type === 'number' || fieldMeta.key === 'v_weight') {\n      value = parseWeight(value);\n    } else if (fieldMeta.type === 'price') {\n      value = parsePrice(value);\n    }\n    \n    return value ?? null;\n  }\n  \n  // AI-generated values from customAttributes\n  if (config.source === 'ai') {\n    const customAttrs = product.customAttributes || [];\n    \n    // Map Brickfox field to AI custom attribute key\n    const aiFieldMap: Record<string, string> = {\n      'p_description[de]': 'ai_description',\n      'v_customs_tariff_number': 'ai_customs_tariff_number',\n      'v_customs_tariff_text': 'ai_customs_tariff_text',\n    };\n    \n    const aiKey = aiFieldMap[brickfoxField];\n    if (aiKey) {\n      const aiAttr = customAttrs.find(a => a.key === aiKey);\n      return aiAttr?.value || null;\n    }\n    \n    return null;\n  }\n  \n  return null;\n}\n\n/**\n * Generate auto-generated field value (e.g., category path from voltage)\n */\nfunction generateAutoFieldValue(\n  rule: {\n    dependsOn: string;\n    rule: string;\n    fallback?: string;\n  },\n  product: ProductInProject\n): string | null {\n  if (!rule) return null;\n  \n  try {\n    // Extract value from product's extractedData\n    let dependsOnValue: string | null = null;\n    \n    if (product.extractedData && Array.isArray(product.extractedData)) {\n      const attr = product.extractedData.find((item: any) => \n        item.key === rule.dependsOn || item.label === rule.dependsOn\n      );\n      if (attr) {\n        dependsOnValue = attr.value?.toString();\n      }\n    }\n    \n    if (dependsOnValue) {\n      // Replace template variables in rule (e.g., {{Nominalspannung (V)}})\n      let result = rule.rule.replace(\n        new RegExp(`\\\\{\\\\{${rule.dependsOn}\\\\}\\\\}`, 'g'),\n        dependsOnValue\n      );\n      return result;\n    } else if (rule.fallback) {\n      return rule.fallback;\n    }\n  } catch (error) {\n    console.error('[Auto-Generate] Error generating auto field:', error);\n  }\n  \n  return rule.fallback || null;\n}\n\n/**\n * Transform a single product into Brickfox row(s)\n * Note: Most products have single variant, so we create one row per product\n */\nexport function mapProductToBrickfox(\n  product: ProductInProject,\n  options: BrickfoxMapperOptions = {}\n): BrickfoxRow {\n  const mapping = options.customMapping || DEFAULT_BRICKFOX_MAPPING;\n  const row: BrickfoxRow = {};\n  \n  // Map all Brickfox fields\n  for (const field of BRICKFOX_FIELDS) {\n    const value = getFieldValue(product, mapping, field.key, options.supplierName);\n    row[field.key] = value;\n  }\n  \n  // Apply fixed values from mappingRules.json (if provided)\n  if (options.fixedValues) {\n    for (const [key, value] of Object.entries(options.fixedValues)) {\n      row[key] = value;\n    }\n  }\n  \n  // Apply auto-generated fields (e.g., category path from voltage)\n  if (options.autoGenerateRules) {\n    for (const [fieldName, rule] of Object.entries(options.autoGenerateRules)) {\n      const generatedValue = generateAutoFieldValue(rule, product);\n      if (generatedValue) {\n        row[fieldName] = generatedValue;\n      }\n    }\n  }\n  \n  return row;\n}\n\n/**\n * Transform multiple products into Brickfox rows\n */\nexport function mapProductsToBrickfox(\n  products: ProductInProject[],\n  options: BrickfoxMapperOptions = {}\n): BrickfoxRow[] {\n  return products.map(product => mapProductToBrickfox(product, options));\n}\n\n/**\n * Get column headers in correct Brickfox order\n */\nexport function getBrickfoxColumns(): string[] {\n  return BRICKFOX_FIELDS.map(f => f.key);\n}\n\n/**\n * Convert Brickfox rows to CSV string\n */\nexport function brickfoxRowsToCSV(rows: BrickfoxRow[]): string {\n  if (rows.length === 0) return '';\n  \n  const columns = getBrickfoxColumns();\n  const header = columns.join(',');\n  \n  const dataRows = rows.map(row => {\n    return columns.map(col => {\n      const value = row[col];\n      \n      if (value === null || value === undefined) return '';\n      \n      // Handle booleans\n      if (typeof value === 'boolean') {\n        return value ? 'true' : 'false';\n      }\n      \n      // Handle numbers - convert to German decimal format (comma instead of dot)\n      if (typeof value === 'number') {\n        // Convert to German format: 68.95  \"68,95\"\n        return value.toString().replace('.', ',');\n      }\n      \n      // Handle strings - escape quotes and wrap if contains comma/quotes/newline\n      const str = value.toString();\n      if (str.includes(',') || str.includes('\"') || str.includes('\\n')) {\n        return `\"${str.replace(/\"/g, '\"\"')}\"`;\n      }\n      \n      return str;\n    }).join(',');\n  });\n  \n  return [header, ...dataRows].join('\\n');\n}\n","size_bytes":20031},"client/src/lib/supabase.ts":{"content":"import { createClient } from '@supabase/supabase-js';\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL || 'https://lxemqwvdaxzeldpjmxoc.supabase.co';\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || '';\n\nif (!supabaseAnonKey) {\n  console.error(' VITE_SUPABASE_ANON_KEY is missing! Supabase Auth will not work.');\n}\n\n// Dynamic storage adapter that respects \"Remember Me\" preference\nclass DynamicStorage implements Storage {\n  private getRememberMe(): boolean {\n    const saved = localStorage.getItem('rememberMe');\n    // Default to true if not set (matches login page default)\n    return saved === null ? true : saved === 'true';\n  }\n\n  private getStorage(): Storage {\n    return this.getRememberMe() ? localStorage : sessionStorage;\n  }\n\n  get length(): number {\n    return this.getStorage().length;\n  }\n\n  key(index: number): string | null {\n    return this.getStorage().key(index);\n  }\n\n  getItem(key: string): string | null {\n    const rememberMe = this.getRememberMe();\n    \n    // Only read from the storage matching the current preference\n    if (rememberMe) {\n      return localStorage.getItem(key);\n    } else {\n      return sessionStorage.getItem(key);\n    }\n  }\n\n  setItem(key: string, value: string): void {\n    const storage = this.getStorage();\n    const rememberMe = this.getRememberMe();\n    \n    // Write to the appropriate storage\n    storage.setItem(key, value);\n    \n    // IMPORTANT: Clean up the OTHER storage to prevent token resurrection\n    if (rememberMe) {\n      sessionStorage.removeItem(key);\n    } else {\n      localStorage.removeItem(key);\n    }\n  }\n\n  removeItem(key: string): void {\n    // Remove from both storages to ensure cleanup\n    localStorage.removeItem(key);\n    sessionStorage.removeItem(key);\n  }\n\n  clear(): void {\n    // Clear both storages\n    localStorage.clear();\n    sessionStorage.clear();\n  }\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n  auth: {\n    autoRefreshToken: true,\n    persistSession: true,\n    detectSessionInUrl: true,\n    storage: new DynamicStorage(),\n    storageKey: 'sb-auth-token',\n  },\n});\n\nconsole.log(' Supabase client initialized:', supabaseUrl);\n","size_bytes":2181},"MAPPING_TOOL_CONCEPT.md":{"content":"#  Visual Mapping Tool - Konzept & UI Design\n\n## bersicht\nVisuelles Drag & Drop Interface zum Mapping von Scraper-Feldern  Brickfox CSV-Spalten\n\n---\n\n##  Database Schema\n\n### 1. `field_mappings` Tabelle\n```sql\n- id (UUID)\n- supplier_id (FK  suppliers.id)\n- source_field (TEXT) // \"product.title\", \"product.ean\"\n- target_field (TEXT) // \"Produktname\", \"EAN\"\n- transformation (JSONB) // optional: { type: \"uppercase\" }\n- display_order (TEXT)\n- is_active (BOOLEAN)\n- created_at, updated_at\n```\n\n### 2. `mapping_presets` Tabelle\n```sql\n- id (UUID)\n- name (TEXT) // \"Brickfox Standard\"\n- description (TEXT)\n- mapping_config (JSONB) // Complete preset\n- is_system (BOOLEAN) // System presets can't be deleted\n- created_at, updated_at\n```\n\n---\n\n##  UI Design (React Component)\n\n### Layout:\n```\n\n  Visual Field Mapper                           [Save] [Test]\n\n                                                               \n                     \n   Scraper Fields             Brickfox CSV               \n                     \n    product.title  >  Produktname              \n    product.ean    >  EAN                      \n    product.price  >  Verkaufspreis            \n    product.desc      /---->  Beschreibung             \n    custom.brand     /        Hersteller               \n                               Marke                    \n   [+ Custom Field]            Kategorie                \n                     \n                                                               \n  \n   Transformationen (optional)                             \n  \n   product.title  Produktname                             \n     [x] Uppercase  [ ] Lowercase  [ ] Trim                \n     [ ] Prefix: ___  [ ] Suffix: ___                      \n     [ ] Custom Regex: _________________                   \n  \n                                                               \n  \n   Preview (first 3 products)                              \n  \n   Produktname        EAN           Verkaufspreis       \n   POWERBANK 20000    4260123456    29.99              \n   USB-C KABEL 2M     4260789012    12.99              \n  \n\n```\n\n---\n\n##  User Flow\n\n### 1. **Supplier auswhlen**\n   - User navigiert zu Supplier-Detail-Seite\n   - Klickt auf Tab \"Field Mapping\"\n\n### 2. **Mapping konfigurieren**\n   - Drag & Drop: Linke Spalte  Rechte Spalte\n   - **Alternative:** Click-to-Connect (einfacher als Drag & Drop)\n   - Optional: Transformation hinzufgen\n\n### 3. **Vorschau testen**\n   - \"Test Preview\" Button\n   - System ldt letzte 3 gescrapte Produkte\n   - Zeigt Mapping-Ergebnis als Tabelle\n\n### 4. **Speichern**\n   - \"Save Mapping\"  Speichert in `field_mappings` Tabelle\n   - Wird automatisch beim nchsten Brickfox-Export verwendet\n\n---\n\n##  Implementation Plan\n\n### Phase 1: Backend (Tag 1)\n- [x] DB Schema erstellt (`shared/mapping-schema.ts`)\n- [ ] Migration ausfhren (`npm run db:push`)\n- [ ] API Routes:\n  - `GET /api/suppliers/:id/mappings`\n  - `POST /api/suppliers/:id/mappings`\n  - `PUT /api/mappings/:id`\n  - `DELETE /api/mappings/:id`\n\n### Phase 2: Frontend (Tag 2-3)\n- [ ] React Component `FieldMappingEditor.tsx`\n- [ ] Drag & Drop Library (React DnD oder simpler: Click-to-Connect)\n- [ ] Transformation UI\n- [ ] Preview Component\n\n### Phase 3: Integration (Tag 4)\n- [ ] Brickfox Mapper: Dynamisches Mapping laden\n- [ ] Fallback auf Standard-Mapping\n- [ ] Testing mit echten Supplier-Daten\n\n---\n\n##  Technologie-Entscheidungen\n\n### UI Libraries (Optionen):\n1. **React DnD** (komplex, aber mchtig)\n2. **React Beautiful DnD** (einfacher, deprecated aber stabil)\n3. **Custom Click-to-Connect** (am einfachsten!)  EMPFOHLEN\n\n### Warum Click-to-Connect statt Drag & Drop?\n Einfacher zu bedienen (kein Dragging ntig)  \n Mobile-friendly  \n Weniger Code  \n Bessere Accessibility  \n\n**Beispiel Click-to-Connect:**\n```\n1. User klickt \"product.title\" (links)\n2. Button wird grn markiert\n3. User klickt \"Produktname\" (rechts)\n4. Verbindungslinie erscheint\n5. Fertig!\n```\n\n---\n\n##  Offene Fragen fr Sie:\n\n1. **UI-Style:** Drag & Drop oder Click-to-Connect?\n2. **Transformationen:** Welche sind wichtig?\n   - Uppercase/Lowercase \n   - Prefix/Suffix (z.B. \"Akku - \" + Titel)\n   - Regex-Replace\n   - Concat (mehrere Felder zusammen)\n3. **Presets:** Brauchen Sie vordefinierte Templates?\n   - \"Brickfox Standard\"\n   - \"MediaMarkt Format\"\n   - \"Custom\"\n\n---\n\n##  Nchste Schritte\n\n**Wenn Sie bereit sind:**\n1. Ich erstelle die Migration fr die neuen Tabellen\n2. Ich implementiere die API-Endpoints\n3. Sie geben Feedback zum UI-Konzept\n4. Ich baue das Frontend\n\n**Oder soll ich direkt loslegen mit der Standard-Variante (Click-to-Connect)?**\n","size_bytes":7125},"shared/mapping-schema.ts":{"content":"import { pgTable, uuid, text, jsonb, timestamp, boolean } from 'drizzle-orm/pg-core';\nimport { suppliers } from './schema';\n\n/**\n * Field Mappings Table\n * Stores visual mapping configurations for Scraper  Brickfox CSV conversion\n * \n * Example:\n * - source_field: \"product.title\" (from scraper)\n * - target_field: \"Produktname\" (Brickfox CSV column)\n * - transformation: { type: \"uppercase\", params: {} }\n */\nexport const fieldMappings = pgTable(\"field_mappings\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  \n  // Multi-tenancy\n  tenantId: uuid(\"tenant_id\"),\n  \n  // Link to supplier (each supplier can have custom mappings)\n  supplierId: uuid(\"supplier_id\").references(() => suppliers.id, { onDelete: \"cascade\" }),\n  \n  // Source type: \"csv\" or \"url_scraper\"\n  sourceType: text(\"source_type\").notNull().default('url_scraper'),\n  \n  // Source field from scraper (JSON path notation) or CSV column name\n  // Examples: \n  // - URL Scraper: \"product.title\", \"product.price\", \"customAttributes.brand\"\n  // - CSV: \"Produktname\", \"EAN\", \"Preis\"\n  sourceField: text(\"source_field\").notNull(),\n  \n  // Target field in Brickfox CSV\n  // Examples: \"Produktname\", \"EAN\", \"Verkaufspreis\", \"Beschreibung\"\n  targetField: text(\"target_field\").notNull(),\n  \n  // Optional transformation to apply\n  // Examples: \n  // - { type: \"uppercase\" }\n  // - { type: \"regex\", pattern: \"\\\\d+\", replacement: \"\" }\n  // - { type: \"concat\", separator: \" - \", fields: [\"brand\", \"model\"] }\n  transformation: jsonb(\"transformation\"),\n  \n  // Display order in UI (for sorting)\n  displayOrder: text(\"display_order\").default('0'),\n  \n  // Is this mapping active?\n  isActive: boolean(\"is_active\").default(true),\n  \n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\n/**\n * Mapping Presets Table\n * Pre-configured mapping templates for common scenarios\n */\nexport const mappingPresets = pgTable(\"mapping_presets\", {\n  id: uuid(\"id\").primaryKey().defaultRandom(),\n  \n  // Multi-tenancy\n  tenantId: uuid(\"tenant_id\"),\n  \n  // Preset name (e.g., \"Brickfox Standard\", \"MediaMarkt Format\")\n  name: text(\"name\").notNull(),\n  \n  // Description\n  description: text(\"description\"),\n  \n  // Source type this preset is for: \"csv\" or \"url_scraper\"\n  sourceType: text(\"source_type\").notNull().default('url_scraper'),\n  \n  // Complete mapping configuration (JSON array of field mappings)\n  mappingConfig: jsonb(\"mapping_config\").notNull(),\n  \n  // Is this a system preset (not deletable by users)?\n  isSystem: boolean(\"is_system\").default(false),\n  \n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n});\n\n/**\n * Available Brickfox CSV Fields\n * Exakte Spaltennamen wie von Brickfox erwartet\n */\nexport const brickfoxFields = [\n  // Produkt-Stammdaten (p_*)\n  { key: 'p_item_number', label: 'Produkt Artikelnummer', required: true, type: 'string', category: 'Produktdaten' },\n  { key: 'p_group_path[de]', label: 'Kategoriepfad (DE)', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_brand', label: 'Marke', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_status', label: 'Produkt Status', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_name[de]', label: 'Produktname (DE)', required: true, type: 'string', category: 'Produktdaten' },\n  { key: 'p_tax_class', label: 'Steuerklasse', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_never_out_of_stock', label: 'Nie ausverkauft', required: false, type: 'boolean', category: 'Produktdaten' },\n  { key: 'p_condition', label: 'Zustand', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_country', label: 'Land', required: false, type: 'string', category: 'Produktdaten' },\n  { key: 'p_description[de]', label: 'Beschreibung (DE)', required: false, type: 'html', category: 'Produktdaten' },\n  \n  // Varianten-Daten (v_*)\n  { key: 'v_item_number', label: 'Varianten Artikelnummer', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_ean', label: 'EAN', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_manufacturers_item_number', label: 'Hersteller Artikelnummer', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_status', label: 'Varianten Status', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_classification', label: 'Klassifizierung', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_price[Eur]', label: 'Verkaufspreis (EUR)', required: false, type: 'number', category: 'Variantendaten' },\n  { key: 'v_delivery_time[de]', label: 'Lieferzeit (DE)', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_supplier[Eur]', label: 'Lieferant (EUR)', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_supplier_item_number', label: 'Lieferanten Artikelnummer', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_purchase_price', label: 'Einkaufspreis', required: false, type: 'number', category: 'Variantendaten' },\n  { key: 'v_never_out_of_stock[standard]', label: 'Standard nie ausverkauft', required: false, type: 'boolean', category: 'Variantendaten' },\n  { key: 'v_weight', label: 'Gewicht', required: false, type: 'number', category: 'Variantendaten' },\n  { key: 'v_customs_tariff_number', label: 'Zolltarifnummer', required: false, type: 'string', category: 'Variantendaten' },\n  { key: 'v_customs_tariff_text', label: 'Zolltarif Text', required: false, type: 'string', category: 'Variantendaten' },\n] as const;\n\n/**\n * Transformation Types\n */\nexport type TransformationType = \n  | 'uppercase'\n  | 'lowercase'\n  | 'trim'\n  | 'regex'\n  | 'concat'\n  | 'prefix'\n  | 'suffix'\n  | 'custom';\n\nexport interface FieldTransformation {\n  type: TransformationType;\n  params?: Record<string, any>;\n}\n","size_bytes":6017},"WEBHOOK_SETUP_COMPLETE.md":{"content":"#  Supabase Auth Webhook Sync - PRODUCTION READY\n\n## Status: COMPLETED & TESTED\n\n### What Works:\n Supabase Auth (Cloud)  Database Webhook  Helium DB (Local)  \n Auto-creates users with tenant assignment  \n Signature verification (optional)  \n Test endpoint for local development  \n\n### Test Results:\n```bash\n# Test 1: Database Webhook (production format)\n User created: final-test@example.com\n Tenant assigned: AkkuShop (16fcf886-...)\n Trial subscription: 3000 API calls\n\n# Test 2: Legacy test endpoint (development)\n User created: legacy-test@example.com\n Full workflow tested\n```\n\n### Production Setup (Supabase Dashboard):\n\n**Step 1: Database Webhooks**\n1. Navigate to: **Database  Webhooks**\n2. Click: **Create a new hook**\n3. Configure:\n   - Table: `auth.users`\n   - Events: `INSERT`, `UPDATE`\n   - Method: `POST`\n   - URL: `https://your-domain.com/api/webhooks/supabase-auth`\n   - HTTP Headers: `x-supabase-signature: YOUR_SECRET_KEY`\n\n**Step 2: Environment Variable**\n```bash\nSUPABASE_WEBHOOK_SECRET=YOUR_SECRET_KEY\n```\n\n### Files:\n- `server/webhooks-supabase.ts` - Webhook handler\n- `shared/schema.ts` - Users table (password_hash removed)\n- `server/routes-supabase.ts` - Registration simplified\n\n### Architecture:\n```\nUser Registration\n    \nSupabase Auth (creates auth.users)\n    \nDatabase Webhook (INSERT event)\n    \nPOST /api/webhooks/supabase-auth\n    \nHelium DB (creates public.users)\n    \nDone! User can login \n```\n\n### Benefits:\n No manual DB sync needed  \n Works in Dev (Helium) & Prod (Supabase Remote)  \n Single source of truth (Supabase Auth)  \n Fully automated  \n No n8n or external services needed  \n\n---\n**Next: Visual Field Mapping Tool** \n","size_bytes":1738},"server/webhooks-supabase.ts":{"content":"import { Router } from 'express';\nimport { db } from './db';\nimport { users, tenants } from '@shared/schema';\nimport { eq } from 'drizzle-orm';\nimport crypto from 'crypto';\n\nconst router = Router();\n\n// Database Webhook format (triggered on auth.users table changes)\ninterface SupabaseDatabaseWebhook {\n  type: 'INSERT' | 'UPDATE' | 'DELETE';\n  table: string;\n  schema: string;\n  record: {\n    id: string;\n    email: string;\n    created_at: string;\n    updated_at?: string;\n    raw_user_meta_data?: {\n      username?: string;\n      [key: string]: any;\n    };\n    [key: string]: any;\n  } | null;\n  old_record: any | null;\n}\n\n// Legacy format for test endpoint\ninterface SupabaseAuthEvent {\n  type: 'user_created' | 'user_updated' | 'user_deleted';\n  data: {\n    id: string;\n    email: string;\n    created_at: string;\n    updated_at?: string;\n    user_metadata?: {\n      username?: string;\n      [key: string]: any;\n    };\n  };\n}\n\n/**\n * Webhook Signature Verification for Database Webhooks\n * Simple shared-secret approach: X-Supabase-Signature header must match secret\n * \n * Note: Supabase Database Webhooks don't natively generate HMAC signatures.\n * This uses a simple shared-secret header that you configure in the webhook.\n */\nfunction verifyWebhookSignature(signature: string | undefined, secret: string): boolean {\n  if (!signature) {\n    console.warn('[Webhook] No signature provided');\n    return false;\n  }\n\n  // Simple string comparison with timing-safe function\n  try {\n    return crypto.timingSafeEqual(\n      Buffer.from(signature),\n      Buffer.from(secret)\n    );\n  } catch (error) {\n    console.error('[Webhook] Signature comparison failed:', error);\n    return false;\n  }\n}\n\n/**\n * Get or create AkkuShop tenant\n */\nasync function getOrCreateAkkuShopTenant(): Promise<string> {\n  // Try to find existing tenant\n  const existingTenant = await db\n    .select()\n    .from(tenants)\n    .where(eq(tenants.slug, 'akkushop'))\n    .limit(1);\n\n  if (existingTenant.length > 0) {\n    return existingTenant[0].id;\n  }\n\n  // Create new tenant\n  console.log('[Webhook] Creating AkkuShop tenant');\n  const newTenant = await db\n    .insert(tenants)\n    .values({\n      name: 'AkkuShop',\n      slug: 'akkushop',\n      settings: {\n        default_categories: ['battery', 'charger', 'tool', 'gps', 'drone', 'camera'],\n        mediamarkt_title_format: 'Kategorie + Artikelnummer'\n      }\n    })\n    .returning();\n\n  return newTenant[0].id;\n}\n\n/**\n * Handle database INSERT event (user created in auth.users)\n */\nasync function handleUserInsert(record: SupabaseDatabaseWebhook['record']) {\n  if (!record) {\n    throw new Error('No record provided');\n  }\n\n  const { id, email, created_at, raw_user_meta_data } = record;\n  \n  console.log(`[Webhook] Creating user in Helium DB: ${email}`);\n\n  // Get tenant ID from user metadata (set during registration)\n  // If not present, fall back to AkkuShop for backward compatibility\n  let tenantId: string;\n  if (raw_user_meta_data?.tenant_id) {\n    tenantId = raw_user_meta_data.tenant_id;\n    console.log(`[Webhook] Using tenant from user metadata: ${tenantId} (${raw_user_meta_data.company_name || 'Unknown'})`);\n  } else {\n    console.warn(`[Webhook] No tenant_id in user metadata, falling back to AkkuShop (legacy user)`);\n    tenantId = await getOrCreateAkkuShopTenant();\n  }\n\n  // Check if user already exists\n  const existingUser = await db\n    .select()\n    .from(users)\n    .where(eq(users.id, id))\n    .limit(1);\n\n  if (existingUser.length > 0) {\n    console.log(`[Webhook] User ${email} already exists, skipping creation`);\n    return {\n      status: 'skipped',\n      reason: 'User already exists',\n      user_id: id\n    };\n  }\n\n  // Create user in Helium DB\n  // First user of a new tenant becomes admin\n  const isFirstUserOfTenant = await db\n    .select()\n    .from(users)\n    .where(eq(users.tenantId, tenantId))\n    .limit(1);\n\n  const isAdmin = isFirstUserOfTenant.length === 0; // First user = admin\n\n  await db.insert(users).values({\n    id,\n    email,\n    username: raw_user_meta_data?.username || email.split('@')[0],\n    tenantId,\n    isAdmin,\n    role: isAdmin ? 'admin' : 'member',\n    subscriptionStatus: 'trial',\n    planId: 'trial',\n    apiCallsLimit: 50,\n    apiCallsUsed: 0,\n    createdAt: new Date(created_at),\n    updatedAt: new Date(created_at),\n  });\n\n  console.log(` [Webhook] User ${email} created successfully in Helium DB`);\n  console.log(`   - Tenant: ${tenantId}`);\n  console.log(`   - Role: ${isAdmin ? 'admin (first user)' : 'member'}`);\n\n  return {\n    status: 'success',\n    action: 'user_insert',\n    user_id: id,\n    email,\n    tenant_id: tenantId,\n    is_admin: isAdmin\n  };\n}\n\n/**\n * Handle database UPDATE event (user updated in auth.users)\n */\nasync function handleUserUpdate(record: SupabaseDatabaseWebhook['record']) {\n  if (!record) {\n    throw new Error('No record provided');\n  }\n\n  const { id, email, raw_user_meta_data } = record;\n  \n  console.log(`[Webhook] Updating user in Helium DB: ${email}`);\n\n  // Update user in Helium DB\n  await db\n    .update(users)\n    .set({\n      email,\n      username: raw_user_meta_data?.username,\n      updatedAt: new Date(),\n    })\n    .where(eq(users.id, id));\n\n  console.log(` [Webhook] User ${email} updated successfully`);\n\n  return {\n    status: 'success',\n    action: 'user_update',\n    user_id: id,\n    email\n  };\n}\n\n/**\n * Handle database DELETE event (user deleted from auth.users)\n */\nasync function handleUserDelete(old_record: any) {\n  const { id, email } = old_record;\n  \n  console.log(`[Webhook] Soft-deleting user in Helium DB: ${email}`);\n\n  // Soft delete: Update status instead of hard delete\n  // Note: We don't have a 'status' field yet, so we could add it or just log\n  // For now, we'll just log the deletion\n  console.log(` [Webhook] User deletion logged but not implemented: ${email}`);\n\n  return {\n    status: 'success',\n    action: 'user_delete',\n    user_id: id,\n    email,\n    note: 'Logged but not deleted from Helium DB'\n  };\n}\n\n/**\n * LEGACY: Handle user_created event (for test endpoint)\n */\nasync function handleUserCreated(event: SupabaseAuthEvent) {\n  const { id, email, created_at, user_metadata } = event.data;\n  \n  console.log(`[Webhook] Creating user in Helium DB: ${email}`);\n\n  // Get tenant ID\n  const tenantId = await getOrCreateAkkuShopTenant();\n\n  // Check if user already exists\n  const existingUser = await db\n    .select()\n    .from(users)\n    .where(eq(users.id, id))\n    .limit(1);\n\n  if (existingUser.length > 0) {\n    console.log(`[Webhook] User ${email} already exists, skipping creation`);\n    return {\n      status: 'skipped',\n      reason: 'User already exists',\n      user_id: id\n    };\n  }\n\n  // Create user in Helium DB\n  await db.insert(users).values({\n    id,\n    email,\n    username: user_metadata?.username || email.split('@')[0],\n    tenantId,\n    isAdmin: false,\n    role: 'member',\n    subscriptionStatus: 'trial',\n    planId: 'trial',\n    apiCallsLimit: 50,\n    apiCallsUsed: 0,\n    createdAt: new Date(created_at),\n    updatedAt: new Date(created_at),\n  });\n\n  console.log(` [Webhook] User ${email} created successfully in Helium DB`);\n\n  return {\n    status: 'success',\n    action: 'user_created',\n    user_id: id,\n    email,\n    tenant_id: tenantId\n  };\n}\n\n/**\n * Handle user_updated event\n */\nasync function handleUserUpdated(event: SupabaseAuthEvent) {\n  const { id, email, user_metadata } = event.data;\n  \n  console.log(`[Webhook] Updating user in Helium DB: ${email}`);\n\n  // Update user in Helium DB\n  await db\n    .update(users)\n    .set({\n      email,\n      username: user_metadata?.username,\n      updatedAt: new Date(),\n    })\n    .where(eq(users.id, id));\n\n  console.log(` [Webhook] User ${email} updated successfully`);\n\n  return {\n    status: 'success',\n    action: 'user_updated',\n    user_id: id,\n    email\n  };\n}\n\n/**\n * Handle user_deleted event\n */\nasync function handleUserDeleted(event: SupabaseAuthEvent) {\n  const { id, email } = event.data;\n  \n  console.log(`[Webhook] Soft-deleting user in Helium DB: ${email}`);\n\n  // Soft delete: Update status instead of hard delete\n  // Note: We don't have a 'status' field yet, so we could add it or just log\n  // For now, we'll just log the deletion\n  console.log(` [Webhook] User deletion logged but not implemented: ${email}`);\n\n  return {\n    status: 'success',\n    action: 'user_deleted',\n    user_id: id,\n    email,\n    note: 'Logged but not deleted from Helium DB'\n  };\n}\n\n/**\n * Webhook endpoint for Supabase Database Webhooks\n * POST /api/webhooks/supabase-auth\n * \n * Handles INSERT/UPDATE/DELETE events from auth.users table\n */\nrouter.post('/supabase-auth', async (req, res) => {\n  try {\n    const signature = req.headers['x-supabase-signature'] as string | undefined;\n    \n    // Verify webhook signature if secret is configured\n    const webhookSecret = process.env.SUPABASE_WEBHOOK_SECRET;\n    if (webhookSecret) {\n      const isValid = verifyWebhookSignature(signature, webhookSecret);\n      if (!isValid) {\n        console.error('[Webhook] Invalid signature');\n        return res.status(401).json({ error: 'Invalid webhook signature' });\n      }\n    } else {\n      console.warn('[Webhook] No SUPABASE_WEBHOOK_SECRET configured - skipping signature verification');\n    }\n\n    const webhook = req.body as SupabaseDatabaseWebhook;\n    \n    // Validate webhook is from auth.users table\n    if (webhook.schema !== 'auth' || webhook.table !== 'users') {\n      console.warn(`[Webhook] Unexpected table: ${webhook.schema}.${webhook.table}`);\n      return res.status(400).json({ error: 'Webhook must be from auth.users table' });\n    }\n\n    console.log(`[Webhook] Received ${webhook.type} event for user ${webhook.record?.email || 'unknown'}`);\n\n    let result;\n    switch (webhook.type) {\n      case 'INSERT':\n        if (!webhook.record) {\n          return res.status(400).json({ error: 'No record provided for INSERT' });\n        }\n        result = await handleUserInsert(webhook.record);\n        break;\n      \n      case 'UPDATE':\n        if (!webhook.record) {\n          return res.status(400).json({ error: 'No record provided for UPDATE' });\n        }\n        result = await handleUserUpdate(webhook.record);\n        break;\n      \n      case 'DELETE':\n        if (!webhook.old_record) {\n          return res.status(400).json({ error: 'No old_record provided for DELETE' });\n        }\n        result = await handleUserDelete(webhook.old_record);\n        break;\n      \n      default:\n        console.warn(`[Webhook] Unknown event type: ${webhook.type}`);\n        return res.status(400).json({ error: `Unknown event type: ${webhook.type}` });\n    }\n\n    return res.json({\n      ...result,\n      timestamp: new Date().toISOString()\n    });\n\n  } catch (error) {\n    console.error('[Webhook] Error processing event:', error);\n    return res.status(500).json({\n      status: 'error',\n      error: error instanceof Error ? error.message : 'Unknown error'\n    });\n  }\n});\n\n/**\n * TEST endpoint - Simulate Supabase Auth webhook locally\n * POST /api/webhooks/supabase-auth-test\n */\nrouter.post('/supabase-auth-test', async (req, res) => {\n  try {\n    const { email, userId } = req.body;\n    \n    if (!email) {\n      return res.status(400).json({ error: 'Email is required' });\n    }\n\n    console.log(`[Webhook Test] Simulating user_created event for ${email}`);\n\n    const event: SupabaseAuthEvent = {\n      type: 'user_created',\n      data: {\n        id: userId || crypto.randomUUID(),\n        email,\n        created_at: new Date().toISOString(),\n        user_metadata: {\n          username: email.split('@')[0]\n        }\n      }\n    };\n\n    const result = await handleUserCreated(event);\n\n    return res.json({\n      ...result,\n      timestamp: new Date().toISOString(),\n      note: 'This was a test webhook call'\n    });\n\n  } catch (error) {\n    console.error('[Webhook Test] Error:', error);\n    return res.status(500).json({\n      status: 'error',\n      error: error instanceof Error ? error.message : 'Unknown error'\n    });\n  }\n});\n\nexport default router;\n","size_bytes":12049},"client/src/components/tenant-switcher.tsx":{"content":"import { Building2, Check, ChevronDown } from 'lucide-react';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { useTenant } from '@/lib/tenant-context';\n\nexport function TenantSwitcher() {\n  const { currentTenant, tenants, switchTenant, isLoading } = useTenant();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-md bg-muted\">\n        <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n        <span className=\"text-sm text-muted-foreground\">Ldt...</span>\n      </div>\n    );\n  }\n\n  if (!currentTenant || tenants.length === 0) {\n    return null;\n  }\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\" className=\"gap-2 h-9\">\n          <Building2 className=\"h-4 w-4 text-indigo-600\" />\n          <span className=\"font-medium\">{currentTenant.name}</span>\n          <Badge variant=\"secondary\" className=\"ml-1 text-xs\">\n            Aktiv\n          </Badge>\n          <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-64\">\n        <DropdownMenuLabel>Kunde wechseln</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        {tenants.map((tenant) => (\n          <DropdownMenuItem\n            key={tenant.id}\n            onClick={() => switchTenant(tenant.id)}\n            className=\"flex items-center justify-between cursor-pointer\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <Building2 className=\"h-4 w-4 text-gray-500\" />\n              <div>\n                <div className=\"font-medium\">{tenant.name}</div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {tenant.userCount} User  {tenant.projectCount} Projekte\n                </div>\n              </div>\n            </div>\n            {currentTenant.id === tenant.id && (\n              <Check className=\"h-4 w-4 text-indigo-600\" />\n            )}\n          </DropdownMenuItem>\n        ))}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","size_bytes":2313},"client/src/lib/tenant-context.tsx":{"content":"import { createContext, useContext, ReactNode, useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { useAuth } from './auth-context';\nimport type { TenantSettings } from '@shared/schema';\n\ninterface Tenant {\n  id: string;\n  name: string;\n  slug: string;\n  settings: TenantSettings;\n  userCount: number;\n  projectCount: number;\n  supplierCount: number;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface TenantContextType {\n  currentTenant: Tenant | null;\n  tenants: Tenant[];\n  isLoading: boolean;\n  switchTenant: (tenantId: string) => void;\n  refetch: () => void;\n}\n\nconst TenantContext = createContext<TenantContextType | undefined>(undefined);\n\nexport function TenantProvider({ children }: { children: ReactNode }) {\n  const { user, isAuthenticated } = useAuth();\n  const [currentTenantId, setCurrentTenantId] = useState<string | null>(null);\n\n  // Only true system admins can see tenant switcher (not regular tenant admins)\n  const isSuperAdmin = user?.email === 'sarahzerrer@icloud.com';\n  \n  // Fetch all tenants (only for system admins)\n  const { data: tenantsData, isLoading: tenantsLoading, refetch: refetchTenants } = useQuery({\n    queryKey: ['admin-tenants'],\n    queryFn: async () => {\n      if (!isSuperAdmin) return { tenants: [] };\n      \n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/admin/tenants', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      \n      if (!res.ok) return { tenants: [] };\n      return res.json();\n    },\n    enabled: isAuthenticated && isSuperAdmin,\n  });\n\n  // Fetch user's own tenant (for regular users)\n  const { data: userTenantData, isLoading: userTenantLoading } = useQuery({\n    queryKey: ['user-tenant'],\n    queryFn: async () => {\n      if (isSuperAdmin) return { tenant: null }; // System admins use tenant switcher\n      \n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/user/tenant', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      \n      if (!res.ok) return { tenant: null };\n      return res.json();\n    },\n    enabled: isAuthenticated && !isSuperAdmin,\n  });\n\n  const isLoading = tenantsLoading || userTenantLoading;\n  const tenants = tenantsData?.tenants || [];\n  \n  // For system admins: Auto-select first tenant if none selected\n  useEffect(() => {\n    if (isSuperAdmin && tenants.length > 0 && !currentTenantId) {\n      const savedTenantId = localStorage.getItem('selected_tenant_id');\n      if (savedTenantId && tenants.find((t: Tenant) => t.id === savedTenantId)) {\n        setCurrentTenantId(savedTenantId);\n      } else {\n        setCurrentTenantId(tenants[0].id);\n      }\n    }\n  }, [isSuperAdmin, tenants, currentTenantId]);\n\n  // Determine current tenant based on user role\n  let currentTenant: Tenant | null = null;\n  if (isSuperAdmin) {\n    // System admins use the tenant switcher\n    currentTenant = tenants.find((t: Tenant) => t.id === currentTenantId) || null;\n  } else {\n    // Regular users use their assigned tenant\n    currentTenant = userTenantData?.tenant || null;\n  }\n\n  const switchTenant = (tenantId: string) => {\n    setCurrentTenantId(tenantId);\n    localStorage.setItem('selected_tenant_id', tenantId);\n    console.log(`[TenantContext] Switched to tenant: ${tenants.find((t: Tenant) => t.id === tenantId)?.name}`);\n  };\n\n  const value: TenantContextType = {\n    currentTenant,\n    tenants,\n    isLoading,\n    switchTenant,\n    refetch: refetchTenants,\n  };\n\n  return <TenantContext.Provider value={value}>{children}</TenantContext.Provider>;\n}\n\nexport function useTenant() {\n  const context = useContext(TenantContext);\n  if (context === undefined) {\n    throw new Error('useTenant must be used within TenantProvider');\n  }\n  return context;\n}\n","size_bytes":3859},"server/routes-mapping.ts":{"content":"import { Router, Request, Response } from 'express';\nimport { eq, and, desc } from 'drizzle-orm';\nimport { db as heliumDb } from './db';\nimport { fieldMappings, mappingPresets } from '../shared/mapping-schema';\nimport { supabaseStorage } from './supabase-storage';\nimport { supabase } from './supabase';\nimport { detectFieldsFromUrlScraper, detectFieldsFromCSV } from './services/field-detection-service';\n\nconst router = Router();\n\nasync function requireAuth(req: any, res: any, next: any) {\n  const authHeader = req.headers.authorization;\n  \n  if (!authHeader?.startsWith('Bearer ')) {\n    return res.status(401).json({ error: 'Nicht authentifiziert' });\n  }\n  \n  const token = authHeader.substring(7);\n  const { data: { user }, error } = await supabase.auth.getUser(token);\n  \n  if (error || !user) {\n    return res.status(401).json({ error: 'Ungltiges Token' });\n  }\n  \n  req.user = user;\n  next();\n}\n\nrouter.get('/suppliers/:supplierId/mappings', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { supplierId } = req.params;\n    const { source_type } = req.query;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      return res.status(403).json({ error: 'No tenant assigned' });\n    }\n\n    let query = heliumDb\n      .select()\n      .from(fieldMappings)\n      .where(\n        and(\n          eq(fieldMappings.supplierId, supplierId),\n          eq(fieldMappings.tenantId, user.tenantId)\n        )\n      )\n      .orderBy(desc(fieldMappings.displayOrder));\n\n    if (source_type) {\n      query = query.where(\n        and(\n          eq(fieldMappings.supplierId, supplierId),\n          eq(fieldMappings.tenantId, user.tenantId),\n          eq(fieldMappings.sourceType, source_type as string)\n        )\n      );\n    }\n\n    const mappings = await query;\n\n    res.json({\n      success: true,\n      mappings: mappings.map((m: typeof fieldMappings.$inferSelect) => ({\n        id: m.id,\n        supplierId: m.supplierId,\n        sourceType: m.sourceType,\n        sourceField: m.sourceField,\n        targetField: m.targetField,\n        transformation: m.transformation,\n        displayOrder: m.displayOrder,\n        isActive: m.isActive,\n        createdAt: m.createdAt,\n        updatedAt: m.updatedAt,\n      })),\n    });\n  } catch (error) {\n    console.error('[GET /suppliers/:supplierId/mappings] Error:', error);\n    res.status(500).json({ error: 'Failed to fetch mappings' });\n  }\n});\n\nrouter.post('/suppliers/:supplierId/mappings', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { supplierId } = req.params;\n    const { sourceType, sourceField, targetField, transformation, displayOrder } = req.body;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      return res.status(403).json({ error: 'No tenant assigned' });\n    }\n\n    if (!sourceType || !sourceField || !targetField) {\n      return res.status(400).json({ error: 'Missing required fields' });\n    }\n\n    const [mapping] = await heliumDb\n      .insert(fieldMappings)\n      .values({\n        tenantId: user.tenantId,\n        supplierId,\n        sourceType,\n        sourceField,\n        targetField,\n        transformation: transformation || null,\n        displayOrder: displayOrder || '0',\n        isActive: true,\n      })\n      .returning();\n\n    res.json({\n      success: true,\n      mapping: {\n        id: mapping.id,\n        supplierId: mapping.supplierId,\n        sourceType: mapping.sourceType,\n        sourceField: mapping.sourceField,\n        targetField: mapping.targetField,\n        transformation: mapping.transformation,\n        displayOrder: mapping.displayOrder,\n        isActive: mapping.isActive,\n        createdAt: mapping.createdAt,\n        updatedAt: mapping.updatedAt,\n      },\n    });\n  } catch (error) {\n    console.error('[POST /suppliers/:supplierId/mappings] Error:', error);\n    res.status(500).json({ error: 'Failed to create mapping' });\n  }\n});\n\nrouter.put('/mappings/:id', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { id } = req.params;\n    const { sourceField, targetField, transformation, displayOrder, isActive } = req.body;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      return res.status(403).json({ error: 'No tenant assigned' });\n    }\n\n    const [existingMapping] = await heliumDb\n      .select()\n      .from(fieldMappings)\n      .where(\n        and(\n          eq(fieldMappings.id, id),\n          eq(fieldMappings.tenantId, user.tenantId)\n        )\n      )\n      .limit(1);\n\n    if (!existingMapping) {\n      return res.status(404).json({ error: 'Mapping not found or access denied' });\n    }\n\n    const [updatedMapping] = await heliumDb\n      .update(fieldMappings)\n      .set({\n        sourceField: sourceField || existingMapping.sourceField,\n        targetField: targetField || existingMapping.targetField,\n        transformation: transformation !== undefined ? transformation : existingMapping.transformation,\n        displayOrder: displayOrder || existingMapping.displayOrder,\n        isActive: isActive !== undefined ? isActive : existingMapping.isActive,\n        updatedAt: new Date(),\n      })\n      .where(eq(fieldMappings.id, id))\n      .returning();\n\n    res.json({\n      success: true,\n      mapping: {\n        id: updatedMapping.id,\n        supplierId: updatedMapping.supplierId,\n        sourceType: updatedMapping.sourceType,\n        sourceField: updatedMapping.sourceField,\n        targetField: updatedMapping.targetField,\n        transformation: updatedMapping.transformation,\n        displayOrder: updatedMapping.displayOrder,\n        isActive: updatedMapping.isActive,\n        createdAt: updatedMapping.createdAt,\n        updatedAt: updatedMapping.updatedAt,\n      },\n    });\n  } catch (error) {\n    console.error('[PUT /mappings/:id] Error:', error);\n    res.status(500).json({ error: 'Failed to update mapping' });\n  }\n});\n\nrouter.delete('/mappings/:id', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { id } = req.params;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      return res.status(403).json({ error: 'No tenant assigned' });\n    }\n\n    const [existingMapping] = await heliumDb\n      .select()\n      .from(fieldMappings)\n      .where(\n        and(\n          eq(fieldMappings.id, id),\n          eq(fieldMappings.tenantId, user.tenantId)\n        )\n      )\n      .limit(1);\n\n    if (!existingMapping) {\n      return res.status(404).json({ error: 'Mapping not found or access denied' });\n    }\n\n    await heliumDb\n      .delete()\n      .from(fieldMappings)\n      .where(eq(fieldMappings.id, id));\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('[DELETE /mappings/:id] Error:', error);\n    res.status(500).json({ error: 'Failed to delete mapping' });\n  }\n});\n\nrouter.get('/fields/detect', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { source_type, supplier_id, project_id } = req.query;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    if (!source_type) {\n      return res.status(400).json({ error: 'source_type is required (csv or url_scraper)' });\n    }\n\n    let detectedFields = [];\n\n    if (source_type === 'url_scraper' && supplier_id) {\n      detectedFields = await detectFieldsFromUrlScraper(supplier_id as string, userId);\n    } else if (source_type === 'csv' && project_id) {\n      detectedFields = await detectFieldsFromCSV(project_id as string, userId);\n    } else {\n      return res.status(400).json({ \n        error: 'Missing required parameters: supplier_id for url_scraper or project_id for csv' \n      });\n    }\n\n    res.json({\n      success: true,\n      sourceType: source_type,\n      fields: detectedFields,\n      count: detectedFields.length,\n    });\n  } catch (error) {\n    console.error('[GET /fields/detect] Error:', error);\n    res.status(500).json({ error: 'Failed to detect fields' });\n  }\n});\n\nrouter.get('/presets', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { source_type } = req.query;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      return res.status(403).json({ error: 'No tenant assigned' });\n    }\n\n    let query = heliumDb\n      .select()\n      .from(mappingPresets)\n      .where(\n        and(\n          eq(mappingPresets.tenantId, user.tenantId)\n        )\n      )\n      .orderBy(desc(mappingPresets.createdAt));\n\n    if (source_type) {\n      query = query.where(\n        and(\n          eq(mappingPresets.tenantId, user.tenantId),\n          eq(mappingPresets.sourceType, source_type as string)\n        )\n      );\n    }\n\n    const presets = await query;\n\n    res.json({\n      success: true,\n      presets: presets.map((p: typeof mappingPresets.$inferSelect) => ({\n        id: p.id,\n        name: p.name,\n        description: p.description,\n        sourceType: p.sourceType,\n        mappingConfig: p.mappingConfig,\n        isSystem: p.isSystem,\n        createdAt: p.createdAt,\n        updatedAt: p.updatedAt,\n      })),\n    });\n  } catch (error) {\n    console.error('[GET /presets] Error:', error);\n    res.status(500).json({ error: 'Failed to fetch presets' });\n  }\n});\n\nrouter.post('/mapping/apply', requireAuth, async (req: Request, res: Response) => {\n  try {\n    const { sourceData, exportToCsv = false, filename = 'brickfox_export' } = req.body;\n    const userId = (req as any).user?.id;\n\n    if (!userId) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    if (!sourceData || !Array.isArray(sourceData) || sourceData.length === 0) {\n      return res.status(400).json({ \n        error: 'sourceData is required and must be a non-empty array' \n      });\n    }\n\n    const { mappingService } = await import('./services/mapping-service');\n    const result = await mappingService.applyMapping(sourceData);\n\n    if (!result.success) {\n      return res.status(400).json({\n        success: false,\n        error: 'Mapping failed',\n        errors: result.errors,\n        warnings: result.warnings,\n        stats: result.stats,\n      });\n    }\n\n    if (exportToCsv && result.csv) {\n      const filePath = await mappingService.exportToFile(result.csv, filename);\n      \n      return res.json({\n        success: true,\n        message: 'Mapping erfolgreich angewendet und als CSV exportiert',\n        data: result.data,\n        csv: result.csv,\n        filePath,\n        errors: result.errors,\n        warnings: result.warnings,\n        stats: result.stats,\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'Mapping erfolgreich angewendet',\n      data: result.data,\n      csv: result.csv,\n      errors: result.errors,\n      warnings: result.warnings,\n      stats: result.stats,\n    });\n  } catch (error) {\n    console.error('[POST /mapping/apply] Error:', error);\n    res.status(500).json({ \n      error: 'Mapping failed',\n      message: error instanceof Error ? error.message : String(error)\n    });\n  }\n});\n\nexport default router;\n","size_bytes":11751},"client/src/components/supplier-overview-tab.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CheckCircle } from \"lucide-react\";\n\nexport interface Supplier {\n  id: string;\n  name: string;\n  supplNr?: string;\n  urlPattern?: string;\n  description?: string;\n  selectors: Record<string, string>;\n  productLinkSelector?: string;\n  sessionCookies?: string;\n  userAgent?: string;\n  loginUrl?: string;\n  loginUsernameField?: string;\n  loginPasswordField?: string;\n  loginUsername?: string;\n  loginPassword?: string;\n  verifiedFields?: string[];\n  lastVerifiedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface SupplierOverviewTabProps {\n  supplier: Supplier;\n  onUpdate: () => void;\n}\n\nexport default function SupplierOverviewTab({ supplier }: SupplierOverviewTabProps) {\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"p-6\">\n        <h3 className=\"text-lg font-semibold mb-4\">Grundinformationen</h3>\n        <dl className=\"grid grid-cols-2 gap-4\">\n          <div>\n            <dt className=\"text-sm font-medium text-muted-foreground\">Name</dt>\n            <dd className=\"mt-1 text-sm\">{supplier.name}</dd>\n          </div>\n          \n          {supplier.supplNr && (\n            <div>\n              <dt className=\"text-sm font-medium text-muted-foreground\">Lieferantennummer (Pixi)</dt>\n              <dd className=\"mt-1 text-sm\">{supplier.supplNr}</dd>\n            </div>\n          )}\n          \n          {supplier.urlPattern && (\n            <div>\n              <dt className=\"text-sm font-medium text-muted-foreground\">URL-Muster</dt>\n              <dd className=\"mt-1 text-sm font-mono text-xs\">{supplier.urlPattern}</dd>\n            </div>\n          )}\n          \n          <div>\n            <dt className=\"text-sm font-medium text-muted-foreground\">Erstellt am</dt>\n            <dd className=\"mt-1 text-sm\">\n              {new Date(supplier.createdAt).toLocaleDateString('de-DE', {\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric'\n              })}\n            </dd>\n          </div>\n        </dl>\n      </Card>\n\n      {supplier.description && (\n        <Card className=\"p-6\">\n          <h3 className=\"text-lg font-semibold mb-2\">Beschreibung</h3>\n          <p className=\"text-sm text-muted-foreground whitespace-pre-wrap\">{supplier.description}</p>\n        </Card>\n      )}\n\n      <Card className=\"p-6\">\n        <h3 className=\"text-lg font-semibold mb-4\">CSS-Selektoren</h3>\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-sm font-medium\">Anzahl konfigurierter Selektoren:</span>\n            <Badge variant=\"secondary\">{Object.keys(supplier.selectors).length}</Badge>\n          </div>\n          \n          {supplier.verifiedFields && supplier.verifiedFields.length > 0 && (\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm font-medium\">Verifizierte Felder:</span>\n              <Badge variant=\"default\" className=\"bg-green-600\">\n                <CheckCircle className=\"w-3 h-3 mr-1\" />\n                {supplier.verifiedFields.length}\n              </Badge>\n            </div>\n          )}\n          \n          {supplier.lastVerifiedAt && (\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm font-medium\">Zuletzt verifiziert:</span>\n              <span className=\"text-sm text-muted-foreground\">\n                {new Date(supplier.lastVerifiedAt).toLocaleString('de-DE')}\n              </span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"mt-4 pt-4 border-t\">\n          <p className=\"text-xs text-muted-foreground mb-2\">Konfigurierte Felder:</p>\n          <div className=\"flex flex-wrap gap-2\">\n            {Object.keys(supplier.selectors).map((field) => (\n              <Badge\n                key={field}\n                variant={supplier.verifiedFields?.includes(field) ? \"default\" : \"outline\"}\n                className={supplier.verifiedFields?.includes(field) ? \"bg-green-600\" : \"\"}\n              >\n                {field}\n              </Badge>\n            ))}\n          </div>\n        </div>\n      </Card>\n\n      {(supplier.sessionCookies || supplier.loginUrl) && (\n        <Card className=\"p-6\">\n          <h3 className=\"text-lg font-semibold mb-4\"> Authentifizierung</h3>\n          <div className=\"space-y-3\">\n            {supplier.sessionCookies && (\n              <div>\n                <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Session Cookies</dt>\n                <dd className=\"text-xs font-mono bg-muted p-2 rounded truncate\">\n                  {supplier.sessionCookies.substring(0, 100)}...\n                </dd>\n              </div>\n            )}\n            \n            {supplier.loginUrl && (\n              <>\n                <div>\n                  <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Login-URL</dt>\n                  <dd className=\"text-xs font-mono bg-muted p-2 rounded\">{supplier.loginUrl}</dd>\n                </div>\n                \n                {supplier.loginUsername && (\n                  <div>\n                    <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Benutzername</dt>\n                    <dd className=\"text-xs bg-muted p-2 rounded\">{supplier.loginUsername}</dd>\n                  </div>\n                )}\n                \n                <Badge variant=\"secondary\">Automatischer Login konfiguriert</Badge>\n              </>\n            )}\n          </div>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":5620},"client/src/components/field-mapping-editor.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Loader2, Check, X, ArrowRight, Trash2 } from 'lucide-react';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Separator } from '@/components/ui/separator';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Label } from '@/components/ui/label';\nimport { brickfoxFields } from '@shared/mapping-schema';\n\ninterface DetectedField {\n  key: string;\n  label: string;\n  type: string;\n  sampleValue?: any;\n  count: number;\n}\n\ninterface FieldMapping {\n  id?: string;\n  sourceField: string;\n  targetField: string;\n  transformation?: any;\n  isActive?: boolean;\n}\n\ninterface FieldMappingEditorProps {\n  supplierId?: string;\n  projectId?: string;\n  sourceType?: 'url_scraper' | 'csv';\n  onSave?: (mappings: FieldMapping[]) => void;\n}\n\nexport function FieldMappingEditor({ supplierId, projectId, sourceType: initialSourceType, onSave }: FieldMappingEditorProps) {\n  const [sourceType, setSourceType] = useState<'url_scraper' | 'csv'>(initialSourceType || 'url_scraper');\n  const [sourceFields, setSourceFields] = useState<DetectedField[]>([]);\n  const [mappings, setMappings] = useState<FieldMapping[]>([]);\n  const [selectedSourceField, setSelectedSourceField] = useState<string | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [saving, setSaving] = useState(false);\n\n  useEffect(() => {\n    loadDetectedFields();\n    loadExistingMappings();\n  }, [sourceType, supplierId, projectId]);\n\n  const loadDetectedFields = async () => {\n    setLoading(true);\n    try {\n      const params = new URLSearchParams({\n        source_type: sourceType,\n        ...(sourceType === 'url_scraper' ? { supplier_id: supplierId } : {}),\n        ...(sourceType === 'csv' && projectId ? { project_id: projectId } : {}),\n      });\n\n      const response = await fetch(`/api/fields/detect?${params}`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n        },\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        setSourceFields(data.fields || []);\n      }\n    } catch (error) {\n      console.error('Failed to load detected fields:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadExistingMappings = async () => {\n    // Skip loading if supplier ID is not provided for URL scraper\n    if (sourceType === 'url_scraper' && !supplierId) {\n      console.warn('[Field Mapping] No supplier ID provided, skipping mapping load');\n      return;\n    }\n\n    // Skip loading if project ID is not provided for CSV\n    if (sourceType === 'csv' && !projectId) {\n      console.warn('[Field Mapping] No project ID provided, skipping mapping load');\n      return;\n    }\n\n    try {\n      const params = new URLSearchParams({ source_type: sourceType });\n      \n      // Use different endpoint based on source type\n      const url = sourceType === 'url_scraper' && supplierId\n        ? `/api/suppliers/${supplierId}/mappings?${params}`\n        : sourceType === 'csv' && projectId\n        ? `/api/projects/${projectId}/mappings?${params}`\n        : null;\n\n      if (!url) {\n        console.warn('[Field Mapping] No valid endpoint for loading mappings');\n        return;\n      }\n\n      const response = await fetch(url, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n        },\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        setMappings(data.mappings || []);\n      }\n    } catch (error) {\n      console.error('Failed to load existing mappings:', error);\n    }\n  };\n\n  const handleSourceFieldClick = (fieldKey: string) => {\n    if (selectedSourceField === fieldKey) {\n      setSelectedSourceField(null);\n    } else {\n      setSelectedSourceField(fieldKey);\n    }\n  };\n\n  const handleTargetFieldClick = (targetField: string) => {\n    if (!selectedSourceField) return;\n\n    const existingMappingIndex = mappings.findIndex(\n      m => m.sourceField === selectedSourceField\n    );\n\n    if (existingMappingIndex >= 0) {\n      const updatedMappings = [...mappings];\n      updatedMappings[existingMappingIndex] = {\n        ...updatedMappings[existingMappingIndex],\n        targetField,\n      };\n      setMappings(updatedMappings);\n    } else {\n      setMappings([\n        ...mappings,\n        {\n          sourceField: selectedSourceField,\n          targetField,\n        },\n      ]);\n    }\n\n    setSelectedSourceField(null);\n  };\n\n  const handleRemoveMapping = (sourceField: string) => {\n    setMappings(mappings.filter(m => m.sourceField !== sourceField));\n  };\n\n  const handleSave = async () => {\n    setSaving(true);\n    try {\n      const existingMappingIds = mappings.filter((m: FieldMapping) => m.id).map((m: FieldMapping) => m.id);\n      const currentMappings = await loadExistingMappingsData();\n      const deletedIds = currentMappings\n        .filter((m: FieldMapping) => !existingMappingIds.includes(m.id))\n        .map((m: FieldMapping) => m.id);\n\n      for (const id of deletedIds) {\n        if (id) {\n          await fetch(`/api/mappings/${id}`, {\n            method: 'DELETE',\n            headers: {\n              'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n            },\n          });\n        }\n      }\n\n      for (const mapping of mappings) {\n        if (mapping.id) {\n          await fetch(`/api/mappings/${mapping.id}`, {\n            method: 'PUT',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n            },\n            body: JSON.stringify({\n              sourceField: mapping.sourceField,\n              targetField: mapping.targetField,\n              transformation: mapping.transformation || null,\n            }),\n          });\n        } else {\n          await fetch(`/api/suppliers/${supplierId}/mappings`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n            },\n            body: JSON.stringify({\n              sourceType,\n              sourceField: mapping.sourceField,\n              targetField: mapping.targetField,\n              transformation: mapping.transformation || null,\n            }),\n          });\n        }\n      }\n\n      onSave?.(mappings);\n      await loadExistingMappings();\n    } catch (error) {\n      console.error('Failed to save mappings:', error);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const loadExistingMappingsData = async () => {\n    try {\n      const params = new URLSearchParams({ source_type: sourceType });\n      const response = await fetch(`/api/suppliers/${supplierId}/mappings?${params}`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n        },\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        return data.mappings || [];\n      }\n      return [];\n    } catch (error) {\n      console.error('Failed to load existing mappings:', error);\n      return [];\n    }\n  };\n\n  const getMappedTargetField = (sourceField: string) => {\n    return mappings.find(m => m.sourceField === sourceField)?.targetField;\n  };\n\n  const isTargetFieldMapped = (targetField: string) => {\n    return mappings.some(m => m.targetField === targetField);\n  };\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader>\n        <CardTitle>Field Mapping</CardTitle>\n        <CardDescription>\n          Ordnen Sie Datenquellen den Brickfox CSV-Spalten zu\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        {/* Anleitung */}\n        <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\n          <h4 className=\"font-semibold text-blue-900 mb-2 flex items-center gap-2\">\n            <span className=\"text-lg\"></span>\n            So funktioniert die Zuordnung:\n          </h4>\n          <ol className=\"text-sm text-blue-800 space-y-1 ml-6 list-decimal\">\n            <li><strong>Schritt 1:</strong> Klicken Sie auf ein Quellenfeld links (z.B. \"EAN Barcode\")</li>\n            <li><strong>Schritt 2:</strong> Klicken Sie dann auf das passende Brickfox-Feld rechts (z.B. \"EAN\")</li>\n            <li><strong>Schritt 3:</strong> Die Felder werden automatisch verknpft ( grnes Hkchen)</li>\n            <li><strong>Fertig:</strong> Klicken Sie auf \"Speichern\" um die Zuordnung zu sichern</li>\n          </ol>\n          <p className=\"text-xs text-blue-700 mt-2 italic\">\n             Tipp: Bereits zugeordnete Felder sind mit einem grnen Hkchen markiert\n          </p>\n        </div>\n\n        <div>\n          <Label>Datenquelle whlen</Label>\n          <RadioGroup\n            value={sourceType}\n            onValueChange={(value) => setSourceType(value as 'url_scraper' | 'csv')}\n            className=\"flex gap-4 mt-2\"\n          >\n            <div className=\"flex items-center space-x-2\">\n              <RadioGroupItem value=\"url_scraper\" id=\"url_scraper\" />\n              <Label htmlFor=\"url_scraper\" className=\"cursor-pointer\">URL Scraper</Label>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <RadioGroupItem value=\"csv\" id=\"csv\" />\n              <Label htmlFor=\"csv\" className=\"cursor-pointer\">CSV Upload</Label>\n            </div>\n          </RadioGroup>\n        </div>\n\n        <Separator />\n\n        {loading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-2 gap-6\">\n            <div>\n              <div className=\"flex items-center justify-between mb-3\">\n                <h3 className=\"text-sm font-semibold\">\n                   Quellenfelder ({sourceType === 'url_scraper' ? 'Scraper' : 'CSV'})\n                </h3>\n                {selectedSourceField && (\n                  <Badge variant=\"default\" className=\"bg-blue-600\">\n                    Ausgewhlt \n                  </Badge>\n                )}\n              </div>\n              <ScrollArea className=\"h-[400px] rounded-md border p-3\">\n                <div className=\"space-y-2\">\n                  {sourceFields.length === 0 && (\n                    <p className=\"text-sm text-muted-foreground text-center py-8\">\n                      Keine Felder erkannt. Bitte scrapen Sie zuerst Produkte oder laden Sie eine CSV hoch.\n                    </p>\n                  )}\n                  {sourceFields.map((field) => {\n                    const mappedTarget = getMappedTargetField(field.key);\n                    const isSelected = selectedSourceField === field.key;\n\n                    return (\n                      <Button\n                        key={field.key}\n                        variant={isSelected ? 'default' : mappedTarget ? 'secondary' : 'outline'}\n                        className=\"w-full justify-start text-left h-auto py-3 px-3\"\n                        onClick={() => handleSourceFieldClick(field.key)}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            {mappedTarget && <Check className=\"h-4 w-4 text-green-600 flex-shrink-0\" />}\n                            <span className=\"font-semibold truncate\">{field.label}</span>\n                            <Badge variant=\"outline\" className=\"text-xs ml-auto\">\n                              {field.type}\n                            </Badge>\n                          </div>\n                          {field.sampleValue && (\n                            <div className=\"bg-gray-100 rounded px-2 py-1 mt-1\">\n                              <span className=\"text-sm font-medium text-gray-800 break-words\">\n                                {String(field.sampleValue).slice(0, 50)}{String(field.sampleValue).length > 50 ? '...' : ''}\n                              </span>\n                            </div>\n                          )}\n                          {mappedTarget && (\n                            <div className=\"flex items-center gap-1 mt-2\">\n                              <ArrowRight className=\"h-3 w-3 text-muted-foreground\" />\n                              <span className=\"text-xs text-muted-foreground\">{mappedTarget}</span>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-5 w-5 p-0 ml-auto\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  handleRemoveMapping(field.key);\n                                }}\n                              >\n                                <X className=\"h-3 w-3\" />\n                              </Button>\n                            </div>\n                          )}\n                        </div>\n                      </Button>\n                    );\n                  })}\n                </div>\n              </ScrollArea>\n            </div>\n\n            <div>\n              <div className=\"flex items-center justify-between mb-3\">\n                <h3 className=\"text-sm font-semibold\">\n                   Brickfox CSV Felder\n                </h3>\n                {selectedSourceField && (\n                  <Badge variant=\"outline\" className=\"text-blue-600 border-blue-600\">\n                    Whlen Sie ein Ziel \n                  </Badge>\n                )}\n              </div>\n              <ScrollArea className=\"h-[400px] rounded-md border p-3\">\n                <div className=\"space-y-2\">\n                  {brickfoxFields.map((field: typeof brickfoxFields[number]) => {\n                    const isMapped = isTargetFieldMapped(field.key);\n\n                    return (\n                      <Button\n                        key={field.key}\n                        variant={isMapped ? 'secondary' : 'outline'}\n                        className=\"w-full justify-start text-left h-auto py-3 px-3\"\n                        onClick={() => handleTargetFieldClick(field.key)}\n                        disabled={!selectedSourceField}\n                      >\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            {isMapped && <Check className=\"h-4 w-4 text-green-600 flex-shrink-0\" />}\n                            <span className=\"font-semibold truncate\">{field.label}</span>\n                            {field.required && (\n                              <Badge variant=\"destructive\" className=\"text-xs ml-auto\">\n                                Pflicht\n                              </Badge>\n                            )}\n                          </div>\n                          {field.category && (\n                            <Badge variant=\"outline\" className=\"text-xs mb-1 bg-blue-50 text-blue-700 border-blue-200\">\n                              {field.category}\n                            </Badge>\n                          )}\n                          <div className=\"text-xs text-muted-foreground\">\n                            {field.type}\n                          </div>\n                        </div>\n                      </Button>\n                    );\n                  })}\n                </div>\n              </ScrollArea>\n            </div>\n          </div>\n        )}\n\n        <Separator />\n\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm text-muted-foreground\">\n            {mappings.length} {mappings.length === 1 ? 'Mapping' : 'Mappings'} erstellt\n          </div>\n          <div className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setMappings([])}\n              disabled={mappings.length === 0}\n            >\n              <Trash2 className=\"h-4 w-4 mr-2\" />\n              Alle lschen\n            </Button>\n            <Button\n              onClick={handleSave}\n              disabled={saving || mappings.length === 0}\n            >\n              {saving && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Speichern\n            </Button>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":16653},"server/services/field-detection-service.ts":{"content":"import { supabaseStorage } from '../supabase-storage';\n\n/**\n * Auto-Detection Service\n * Extracts available fields from recent products (URL Scraper or CSV)\n */\n\nexport interface DetectedField {\n  key: string;\n  label: string;\n  type: 'string' | 'number' | 'array' | 'object' | 'url';\n  sampleValue?: any;\n  count: number;\n}\n\n/**\n * Detect fields from URL Scraper products\n */\nexport async function detectFieldsFromUrlScraper(\n  supplierId: string,\n  userId: string,\n  limit: number = 10\n): Promise<DetectedField[]> {\n  try {\n    const user = await supabaseStorage.getUserById(userId);\n    if (!user?.tenantId) {\n      console.warn('[Field Detection] User has no tenant ID');\n      return [];\n    }\n\n    const projectsResponse = await supabaseStorage.getProjectsByUserId(userId);\n    if (!projectsResponse || projectsResponse.length === 0) {\n      console.warn('[Field Detection] No projects found for user');\n      return [];\n    }\n\n    let allProducts: any[] = [];\n    for (const project of projectsResponse.slice(0, 5)) {\n      const projectProducts = await supabaseStorage.getProducts(project.id, userId);\n      allProducts = allProducts.concat(projectProducts || []);\n    }\n\n    if (allProducts.length === 0) {\n      console.warn('[Field Detection] No products found in user projects');\n      return [];\n    }\n\n    const urlScraperProducts = allProducts.filter(p => \n      p.extractedData && Array.isArray(p.extractedData) && p.extractedData.length > 0\n    ).slice(0, limit);\n\n    if (urlScraperProducts.length === 0) {\n      return [];\n    }\n\n    const fieldMap = new Map<string, { count: number; type: string; samples: any[] }>();\n\n    urlScraperProducts.forEach(product => {\n      if (!product.extractedData) return;\n\n      extractFieldsRecursive(product.extractedData, '', fieldMap);\n\n      if (product.name) {\n        addOrUpdateField(fieldMap, 'name', product.name, 'string');\n      }\n      if (product.exactProductName) {\n        addOrUpdateField(fieldMap, 'exactProductName', product.exactProductName, 'string');\n      }\n      if (product.articleNumber) {\n        addOrUpdateField(fieldMap, 'articleNumber', product.articleNumber, 'string');\n      }\n      if (product.customAttributes) {\n        extractFieldsRecursive(product.customAttributes, 'customAttributes', fieldMap);\n      }\n    });\n\n    const detectedFields: DetectedField[] = [];\n    \n    fieldMap.forEach((value, key) => {\n      // Filtere NUR sehr spezifische technische Metadaten-Felder aus:\n      // - Array-Index-Eigenschaften die GENAU auf .key, .type, .label enden\n      // - Beispiel: FILTERN: \"[0].key\", \"[1].type\", \"[2].label\"\n      // - Beispiel: BEHALTEN: \"preis\", \"ean\", \"beschreibung\", \"hersteller\"\n      const isArrayMetadata = /\\[\\d+\\]\\.(key|type|label)$/i.test(key);\n      \n      if (!isArrayMetadata) {\n        detectedFields.push({\n          key,\n          label: formatFieldLabel(key),\n          type: value.type as any,\n          sampleValue: value.samples[0],\n          count: value.count,\n        });\n      }\n    });\n\n    return detectedFields.sort((a, b) => b.count - a.count || a.key.localeCompare(b.key));\n  } catch (error) {\n    console.error('[Field Detection URL Scraper] Error:', error);\n    return [];\n  }\n}\n\n/**\n * Detect fields from CSV products\n */\nexport async function detectFieldsFromCSV(\n  projectId?: string,\n  userId?: string,\n  limit: number = 10\n): Promise<DetectedField[]> {\n  try {\n    if (!projectId || !userId) {\n      return [];\n    }\n\n    const products = await supabaseStorage.getProducts(projectId, userId);\n    if (!products || products.length === 0) {\n      return [];\n    }\n\n    const csvProducts = products.filter(p => \n      p.extractedData && typeof p.extractedData === 'object'\n    ).slice(0, limit);\n\n    if (csvProducts.length === 0) {\n      return [];\n    }\n\n    const fieldMap = new Map<string, { count: number; type: string; samples: any[] }>();\n\n    csvProducts.forEach(product => {\n      if (!product.extractedData) return;\n\n      if (Array.isArray(product.extractedData)) {\n        product.extractedData.forEach((item: any) => {\n          if (typeof item === 'object') {\n            Object.keys(item).forEach(key => {\n              addOrUpdateField(fieldMap, key, item[key], detectType(item[key]));\n            });\n          }\n        });\n      } else if (typeof product.extractedData === 'object') {\n        Object.keys(product.extractedData).forEach(key => {\n          addOrUpdateField(fieldMap, key, (product.extractedData as any)[key], detectType((product.extractedData as any)[key]));\n        });\n      }\n    });\n\n    const detectedFields: DetectedField[] = [];\n    \n    fieldMap.forEach((value, key) => {\n      // Fr CSV: Keine Filterung ntig, da CSV normalerweise saubere Spalten hat\n      detectedFields.push({\n        key,\n        label: formatFieldLabel(key),\n        type: value.type as any,\n        sampleValue: value.samples[0],\n        count: value.count,\n      });\n    });\n\n    return detectedFields.sort((a, b) => b.count - a.count || a.key.localeCompare(b.key));\n  } catch (error) {\n    console.error('[Field Detection CSV] Error:', error);\n    return [];\n  }\n}\n\nfunction extractFieldsRecursive(\n  obj: any,\n  prefix: string,\n  fieldMap: Map<string, { count: number; type: string; samples: any[] }>\n) {\n  if (!obj || typeof obj !== 'object') return;\n\n  if (Array.isArray(obj)) {\n    obj.forEach((item, index) => {\n      if (typeof item === 'object' && item !== null) {\n        // SPECIAL CASE: If item has 'label' and 'value', use label as field name\n        if (item.label && 'value' in item) {\n          const fieldName = item.label;\n          const fieldValue = item.value;\n          const fieldType = item.type || detectType(fieldValue);\n          addOrUpdateField(fieldMap, fieldName, fieldValue, fieldType);\n        } else {\n          extractFieldsRecursive(item, prefix ? `${prefix}[${index}]` : `[${index}]`, fieldMap);\n        }\n      } else {\n        const key = prefix ? `${prefix}[${index}]` : `[${index}]`;\n        addOrUpdateField(fieldMap, key, item, detectType(item));\n      }\n    });\n  } else {\n    Object.keys(obj).forEach(key => {\n      const value = obj[key];\n      const fullKey = prefix ? `${prefix}.${key}` : key;\n\n      if (value !== null && typeof value === 'object') {\n        extractFieldsRecursive(value, fullKey, fieldMap);\n      } else {\n        addOrUpdateField(fieldMap, fullKey, value, detectType(value));\n      }\n    });\n  }\n}\n\nfunction addOrUpdateField(\n  fieldMap: Map<string, { count: number; type: string; samples: any[] }>,\n  key: string,\n  value: any,\n  type: string\n) {\n  const existing = fieldMap.get(key);\n  if (existing) {\n    existing.count++;\n    if (existing.samples.length < 3 && !existing.samples.includes(value)) {\n      existing.samples.push(value);\n    }\n  } else {\n    fieldMap.set(key, { count: 1, type, samples: [value] });\n  }\n}\n\nfunction detectType(value: any): string {\n  if (value === null || value === undefined) return 'string';\n  if (typeof value === 'number') return 'number';\n  if (Array.isArray(value)) return 'array';\n  if (typeof value === 'object') return 'object';\n  if (typeof value === 'string') {\n    if (value.match(/^https?:\\/\\//)) return 'url';\n  }\n  return 'string';\n}\n\nfunction formatFieldLabel(key: string): string {\n  // Common field mappings for better labels\n  const fieldLabels: Record<string, string> = {\n    // Basis-Daten\n    'ean': 'EAN',\n    'articleNumber': 'Artikelnummer',\n    'productName': 'Produktname',\n    'name': 'Produktname',\n    'exactProductName': 'Exakter Produktname',\n    \n    // Preise\n    'price': 'Preis',\n    'ekPrice': 'EK-Preis',\n    'vkPrice': 'VK-Preis',\n    'uvp': 'UVP',\n    'vk': 'VK (Verkaufspreis)',\n    'ek': 'EK (Einkaufspreis)',\n    \n    // Hersteller & Marke\n    'manufacturer': 'Hersteller',\n    'manufacturerArticleNumber': 'Hersteller-Artikelnummer',\n    'brand': 'Marke',\n    \n    // Beschreibungen\n    'description': 'Beschreibung',\n    'htmlCode': 'HTML-Beschreibung',\n    'previewText': 'Flietext',\n    'kurzbeschreibung': 'Kurzbeschreibung',\n    'seoBeschreibung': 'SEO-Beschreibung',\n    'seoTitle': 'SEO-Titel',\n    'seoDescription': 'SEO-Beschreibung',\n    'seoKeywords': 'SEO-Keywords',\n    \n    // Bilder & Medien\n    'images': 'Bilder (URLs)',\n    'files': 'Produktbilder',\n    'localImagePaths': 'Lokale Bildpfade',\n    'pdfManualUrl': 'PDF-Bedienungsanleitung',\n    \n    // Mae & Gewicht\n    'weight': 'Gewicht',\n    'gewicht': 'Gewicht',\n    'height': 'Hhe',\n    'hoehe': 'Hhe',\n    'width': 'Breite',\n    'breite': 'Breite',\n    'length': 'Lnge',\n    'laenge': 'Lnge',\n    \n    // Technische Daten (ANSMANN)\n    'nominalspannung': 'Nominalspannung (V)',\n    'nominalkapazitaet': 'Nominalkapazitt (mAh)',\n    'maxEntladestrom': 'Max. Entladestrom (A)',\n    'zellenchemie': 'Zellenchemie',\n    'energie': 'Energie (Wh)',\n    'farbe': 'Farbe',\n    \n    // Technische Daten (Nitecore)\n    'bodyDiameter': 'Gehusedurchmesser',\n    'headDiameter': 'Kopfdurchmesser',\n    'led1': 'LED 1',\n    'led2': 'LED 2',\n    'maxLuminosity': 'Max. Helligkeit (Lumen)',\n    'spotIntensity': 'Spotintensitt',\n    'maxBeamDistance': 'Max. Leuchtweite (m)',\n    'powerSupply': 'Stromversorgung',\n    'totalWeight': 'Gesamtgewicht',\n    'weightWithoutBattery': 'Gewicht ohne Batterie',\n    \n    // Sonstige\n    'category': 'Kategorie',\n    'stock': 'Lagerbestand',\n    'sku': 'SKU',\n  };\n\n  // Check for exact matches first\n  const lowerKey = key.toLowerCase();\n  for (const [fieldKey, label] of Object.entries(fieldLabels)) {\n    if (lowerKey === fieldKey.toLowerCase() || lowerKey.endsWith(`.${fieldKey.toLowerCase()}`)) {\n      return label;\n    }\n  }\n\n  // Remove array indices and format nicely\n  let formatted = key\n    .replace(/\\[\\d+\\]\\./g, '') // Remove [0]. [1]. etc.\n    .replace(/([A-Z])/g, ' $1') // Add space before capitals\n    .replace(/[._]/g, ' ') // Replace dots and underscores with spaces\n    .trim()\n    .split(' ')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n    .join(' ');\n\n  return formatted;\n}\n","size_bytes":10047},"client/src/components/supplier-selectors-tab.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Save, TestTube, CheckCircle, AlertCircle } from \"lucide-react\";\nimport { apiPut } from \"@/lib/api\";\n\nexport interface Supplier {\n  id: string;\n  name: string;\n  supplNr?: string;\n  urlPattern?: string;\n  description?: string;\n  selectors: Record<string, string>;\n  productLinkSelector?: string;\n  sessionCookies?: string;\n  userAgent?: string;\n  loginUrl?: string;\n  loginUsernameField?: string;\n  loginPasswordField?: string;\n  loginUsername?: string;\n  loginPassword?: string;\n  verifiedFields?: string[];\n  lastVerifiedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface SupplierSelectorsTabProps {\n  supplier: Supplier;\n  onUpdate: () => void;\n}\n\nexport default function SupplierSelectorsTab({ supplier, onUpdate }: SupplierSelectorsTabProps) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [verifiedFields, setVerifiedFields] = useState<Set<string>>(\n    new Set(supplier.verifiedFields || [])\n  );\n  const [testingField, setTestingField] = useState<string | null>(null);\n  const [testUrl, setTestUrl] = useState<string>(supplier.urlPattern || \"\");\n  const [formData, setFormData] = useState({\n    name: supplier.name,\n    supplNr: supplier.supplNr || \"\",\n    urlPattern: supplier.urlPattern || \"\",\n    description: supplier.description || \"\",\n    productLinkSelector: supplier.productLinkSelector || \"\",\n    sessionCookies: supplier.sessionCookies || \"\",\n    userAgent: supplier.userAgent || \"\",\n    loginUrl: supplier.loginUrl || \"\",\n    loginUsernameField: supplier.loginUsernameField || \"\",\n    loginPasswordField: supplier.loginPasswordField || \"\",\n    loginUsername: supplier.loginUsername || \"\",\n    loginPassword: supplier.loginPassword || \"\",\n    selectors: { ...supplier.selectors }\n  });\n  const { toast } = useToast();\n\n  useEffect(() => {\n    setFormData({\n      name: supplier.name,\n      supplNr: supplier.supplNr || \"\",\n      urlPattern: supplier.urlPattern || \"\",\n      description: supplier.description || \"\",\n      productLinkSelector: supplier.productLinkSelector || \"\",\n      sessionCookies: supplier.sessionCookies || \"\",\n      userAgent: supplier.userAgent || \"\",\n      loginUrl: supplier.loginUrl || \"\",\n      loginUsernameField: supplier.loginUsernameField || \"\",\n      loginPasswordField: supplier.loginPasswordField || \"\",\n      loginUsername: supplier.loginUsername || \"\",\n      loginPassword: supplier.loginPassword || \"\",\n      selectors: { ...supplier.selectors }\n    });\n    setVerifiedFields(new Set(supplier.verifiedFields || []));\n    setTestUrl(supplier.urlPattern || \"\");\n  }, [supplier.id]);\n\n  const handleTestSelector = async (fieldName: string, selector: string) => {\n    if (!testUrl || !selector) {\n      toast({\n        title: \"Fehlende Angaben\",\n        description: \"Bitte geben Sie eine Test-URL und einen Selektor ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setTestingField(fieldName);\n    try {\n      const response = await fetch('/api/scraper/test-selector', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token')}`,\n        },\n        body: JSON.stringify({\n          url: testUrl,\n          selector,\n          supplierId: supplier.id,\n        }),\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        setVerifiedFields(prev => new Set([...Array.from(prev), fieldName]));\n        \n        toast({\n          title: \" Selektor funktioniert!\",\n          description: (\n            <div>\n              <div className=\"font-mono text-xs bg-muted p-2 rounded mt-1 max-h-32 overflow-auto\">\n                {result.value || '(leer)'}\n              </div>\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                {result.count} Element(e) gefunden\n              </div>\n            </div>\n          ),\n        });\n      } else {\n        toast({\n          title: \" Selektor fehlgeschlagen\",\n          description: result.error || 'Kein Element gefunden',\n          variant: \"destructive\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Fehler beim Testen\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setTestingField(null);\n    }\n  };\n\n  const handleSave = async () => {\n    if (!formData.name || !formData.name.trim()) {\n      toast({\n        title: \"Fehler\",\n        description: \"Bitte geben Sie einen Namen ein\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const activeSelectors: Record<string, string> = {};\n      Object.entries(formData.selectors).forEach(([key, value]) => {\n        if (value.trim()) {\n          activeSelectors[key] = value.trim();\n        }\n      });\n\n      const payload: any = {\n        name: formData.name.trim(),\n        supplNr: formData.supplNr || undefined,\n        urlPattern: formData.urlPattern || undefined,\n        description: formData.description || undefined,\n        productLinkSelector: formData.productLinkSelector || undefined,\n        sessionCookies: formData.sessionCookies || undefined,\n        userAgent: formData.userAgent || undefined,\n        loginUrl: formData.loginUrl || undefined,\n        loginUsernameField: formData.loginUsernameField || undefined,\n        loginPasswordField: formData.loginPasswordField || undefined,\n        loginUsername: formData.loginUsername || undefined,\n        selectors: activeSelectors,\n        verifiedFields: Array.from(verifiedFields),\n        lastVerifiedAt: verifiedFields.size > 0 ? new Date().toISOString() : undefined,\n      };\n\n      if (formData.loginPassword && formData.loginPassword.trim()) {\n        payload.loginPassword = formData.loginPassword.trim();\n      }\n\n      const data = await apiPut<{ success: boolean; error?: string }>(`/api/suppliers/${supplier.id}`, payload);\n\n      if (data.success) {\n        toast({\n          title: \"Erfolg\",\n          description: \"Lieferant aktualisiert\",\n        });\n        onUpdate();\n      } else {\n        throw new Error(data.error || 'Failed to save supplier');\n      }\n    } catch (error) {\n      console.error('Error saving supplier:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"Lieferant konnte nicht gespeichert werden\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const selectorFields = [\n    // Basis-Produktdaten\n    { key: 'productName', label: 'Produktname', group: 'Basis-Daten', placeholder: 'h1.product-name, .product-title' },\n    { key: 'articleNumber', label: 'Artikelnummer (Hersteller)', group: 'Basis-Daten', placeholder: '.sku, .product-code, [itemprop=\"sku\"]' },\n    { key: 'ean', label: 'EAN / GTIN', group: 'Basis-Daten', placeholder: '.ean, [itemprop=\"gtin13\"]' },\n    { key: 'manufacturer', label: 'Hersteller / Marke', group: 'Basis-Daten', placeholder: '.brand, [itemprop=\"brand\"]' },\n    \n    // Preise (wichtig fr Hndler!)\n    { key: 'price', label: ' Hndler-EK-Preis (Netto)', group: 'Preise', placeholder: '.dealer-price, .wholesale-price, .net-price' },\n    { key: 'priceGross', label: ' Hndler-EK-Preis (Brutto)', group: 'Preise', placeholder: '.gross-price, .price-incl-tax' },\n    { key: 'rrp', label: 'UVP / Empf. VK-Preis', group: 'Preise', placeholder: '.rrp, .msrp, [itemprop=\"price\"]' },\n    \n    // Bilder und Medien\n    { key: 'images', label: 'Produktbilder', group: 'Medien', placeholder: '.product-image img, .gallery img' },\n    \n    // Beschreibungen\n    { key: 'description', label: 'Kurzbeschreibung', group: 'Beschreibungen', placeholder: '.short-description, .product-intro' },\n    { key: 'longDescription', label: 'Ausfhrliche Beschreibung', group: 'Beschreibungen', placeholder: '.long-description, .product-details' },\n    \n    // Technische Daten\n    { key: 'weight', label: 'Gewicht', group: 'Technische Daten', placeholder: '.weight, [itemprop=\"weight\"]' },\n    { key: 'dimensions', label: 'Abmessungen (LBH)', group: 'Technische Daten', placeholder: '.dimensions, .size' },\n    { key: 'category', label: 'Kategorie', group: 'Technische Daten', placeholder: '.category, .breadcrumb' },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"p-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-lg font-semibold\">Grundeinstellungen</h3>\n          <Button onClick={handleSave} disabled={isLoading}>\n            <Save className=\"w-4 h-4 mr-2\" />\n            {isLoading ? \"Speichere...\" : \"Speichern\"}\n          </Button>\n        </div>\n\n        <div className=\"space-y-4\">\n          <div>\n            <Label htmlFor=\"name\">Name *</Label>\n            <Input\n              id=\"name\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              placeholder=\"z.B. Conrad Electronic\"\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"supplNr\">Pixi-Lieferantennummer (optional)</Label>\n            <Input\n              id=\"supplNr\"\n              value={formData.supplNr}\n              onChange={(e) => setFormData({ ...formData, supplNr: e.target.value })}\n              placeholder=\"z.B. 1234 oder CONRAD-001\"\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"urlPattern\">URL-Muster (optional)</Label>\n            <Input\n              id=\"urlPattern\"\n              value={formData.urlPattern}\n              onChange={(e) => setFormData({ ...formData, urlPattern: e.target.value })}\n              placeholder=\"z.B. conrad.de, reichelt.de\"\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"description\">Beschreibung (optional)</Label>\n            <Textarea\n              id=\"description\"\n              value={formData.description}\n              onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n              placeholder=\"Notizen zu diesem Lieferanten...\"\n              rows={3}\n            />\n          </div>\n        </div>\n      </Card>\n\n      <Card className=\"p-6\">\n        <h3 className=\"text-lg font-semibold mb-4\">Automatischer Login (optional)</h3>\n        <p className=\"text-sm text-muted-foreground mb-4\">\n          Konfigurieren Sie einen automatischen Login fr Lieferanten, die eine Anmeldung erfordern.\n        </p>\n        \n        <div className=\"space-y-4\">\n          <div>\n            <Label htmlFor=\"loginUrl\">Login-URL</Label>\n            <Input\n              id=\"loginUrl\"\n              value={formData.loginUrl}\n              onChange={(e) => setFormData({ ...formData, loginUrl: e.target.value })}\n              placeholder=\"https://shop.example.com/login\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"loginUsernameField\"> Benutzername-Feld (CSS-Selektor)</Label>\n              <Input\n                id=\"loginUsernameField\"\n                value={formData.loginUsernameField}\n                onChange={(e) => setFormData({ ...formData, loginUsernameField: e.target.value })}\n                placeholder=\"z.B. input[name='email'] oder #username\"\n                className=\"font-mono\"\n              />\n              <div className=\"flex items-center gap-2 mt-1\">\n                <p className=\"text-xs text-muted-foreground flex-1\">\n                  Der CSS-Selektor fr das Benutzername-Eingabefeld im Login-Formular\n                </p>\n                <button\n                  type=\"button\"\n                  onClick={() => setFormData({ ...formData, loginUsernameField: \"input[name='email'], input[name='username'], #email, #username\" })}\n                  className=\"text-xs text-blue-600 hover:underline whitespace-nowrap\"\n                >\n                   Standard setzen\n                </button>\n              </div>\n            </div>\n\n            <div>\n              <Label htmlFor=\"loginPasswordField\"> Passwort-Feld (CSS-Selektor)</Label>\n              <Input\n                id=\"loginPasswordField\"\n                value={formData.loginPasswordField}\n                onChange={(e) => setFormData({ ...formData, loginPasswordField: e.target.value })}\n                placeholder=\"z.B. input[name='password'] oder #password\"\n                className=\"font-mono\"\n              />\n              <div className=\"flex items-center gap-2 mt-1\">\n                <p className=\"text-xs text-muted-foreground flex-1\">\n                  Der CSS-Selektor fr das Passwort-Eingabefeld im Login-Formular\n                </p>\n                <button\n                  type=\"button\"\n                  onClick={() => setFormData({ ...formData, loginPasswordField: \"input[name='password'], input[type='password'], #password\" })}\n                  className=\"text-xs text-blue-600 hover:underline whitespace-nowrap\"\n                >\n                   Standard setzen\n                </button>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"loginUsername\"> Benutzername (Ihre Login-Daten)</Label>\n              <Input\n                id=\"loginUsername\"\n                value={formData.loginUsername}\n                onChange={(e) => setFormData({ ...formData, loginUsername: e.target.value })}\n                placeholder=\"z.B. kundenservice@shop.de\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Ihr tatschlicher Benutzername fr den Login\n              </p>\n            </div>\n\n            <div>\n              <Label htmlFor=\"loginPassword\"> Passwort (Ihre Login-Daten)</Label>\n              <Input\n                id=\"loginPassword\"\n                type=\"password\"\n                value={formData.loginPassword}\n                onChange={(e) => setFormData({ ...formData, loginPassword: e.target.value })}\n                placeholder=\"Ihr Passwort\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Ihr tatschliches Passwort fr den Login\n              </p>\n            </div>\n          </div>\n        </div>\n      </Card>\n\n      <Card className=\"p-6\">\n        <h3 className=\"text-lg font-semibold mb-4\">CSS-Selektoren testen</h3>\n        \n        <div className=\"mb-4\">\n          <Label htmlFor=\"testUrl\">Test-URL</Label>\n          <Input\n            id=\"testUrl\"\n            value={testUrl}\n            onChange={(e) => setTestUrl(e.target.value)}\n            placeholder=\"https://example.com/product/123\"\n          />\n          <p className=\"text-xs text-muted-foreground mt-1\">\n            Verwenden Sie eine echte Produktseite zum Testen der Selektoren\n          </p>\n        </div>\n\n        <div className=\"space-y-6\">\n          {/* Group selectors by category */}\n          {['Basis-Daten', 'Preise', 'Medien', 'Beschreibungen', 'Technische Daten'].map(group => {\n            const groupFields = selectorFields.filter(f => f.group === group);\n            if (groupFields.length === 0) return null;\n            \n            return (\n              <div key={group} className=\"border-l-4 border-blue-500 pl-4\">\n                <h4 className=\"font-semibold text-sm mb-3 text-blue-700\">{group}</h4>\n                <div className=\"space-y-3\">\n                  {groupFields.map(({ key, label, placeholder }) => {\n                    const isVerified = verifiedFields.has(key);\n                    const isTesting = testingField === key;\n                    \n                    return (\n                      <div key={key} className=\"flex gap-2\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <Label htmlFor={key} className=\"text-sm\">{label}</Label>\n                            {isVerified && (\n                              <CheckCircle className=\"w-4 h-4 text-green-600\" />\n                            )}\n                          </div>\n                          <Input\n                            id={key}\n                            value={formData.selectors[key] || ''}\n                            onChange={(e) => setFormData({\n                              ...formData,\n                              selectors: { ...formData.selectors, [key]: e.target.value }\n                            })}\n                            placeholder={placeholder || `.${key}`}\n                            className={`font-mono text-xs ${isVerified ? \"border-green-500\" : \"\"}`}\n                          />\n                        </div>\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleTestSelector(key, formData.selectors[key])}\n                          disabled={isTesting || !formData.selectors[key] || !testUrl}\n                          className=\"mt-6\"\n                        >\n                          {isTesting ? (\n                            <AlertCircle className=\"w-4 h-4 animate-spin\" />\n                          ) : (\n                            <TestTube className=\"w-4 h-4\" />\n                          )}\n                        </Button>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":17870},"client/src/pages/supplier-detail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Settings, Map, Info } from \"lucide-react\";\nimport { apiGet } from \"@/lib/api\";\nimport { FieldMappingEditor } from \"@/components/field-mapping-editor\";\nimport SupplierOverviewTab, { Supplier as SupplierOverviewType } from \"@/components/supplier-overview-tab\";\nimport SupplierSelectorsTab, { Supplier as SupplierSelectorsType } from \"@/components/supplier-selectors-tab\";\n\ninterface Supplier {\n  id: string;\n  name: string;\n  supplNr?: string;\n  urlPattern?: string;\n  description?: string;\n  selectors: Record<string, string>;\n  productLinkSelector?: string;\n  sessionCookies?: string;\n  userAgent?: string;\n  loginUrl?: string;\n  loginUsernameField?: string;\n  loginPasswordField?: string;\n  loginUsername?: string;\n  loginPassword?: string;\n  verifiedFields?: string[];\n  lastVerifiedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function SupplierDetail() {\n  const [, params] = useRoute(\"/suppliers/:id\");\n  const [, setLocation] = useLocation();\n  const [supplier, setSupplier] = useState<Supplier | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const { toast } = useToast();\n\n  useEffect(() => {\n    if (params?.id) {\n      loadSupplier(params.id);\n    }\n  }, [params?.id]);\n\n  const loadSupplier = async (id: string) => {\n    setIsLoading(true);\n    setSupplier(null);\n    try {\n      const data = await apiGet<{ success: boolean; supplier: Supplier }>(`/api/suppliers/${id}`);\n      if (data.success && data.supplier) {\n        setSupplier(data.supplier);\n      } else {\n        toast({\n          title: \"Fehler\",\n          description: \"Lieferant nicht gefunden\",\n          variant: \"destructive\",\n        });\n        setLocation(\"/suppliers\");\n      }\n    } catch (error) {\n      console.error('Error loading supplier:', error);\n      toast({\n        title: \"Fehler\",\n        description: \"Lieferant konnte nicht geladen werden\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/suppliers\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 max-w-7xl\">\n        <div className=\"flex items-center justify-center h-64\">\n          <p className=\"text-muted-foreground\">Lade Lieferant...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!supplier) {\n    return null;\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      <div className=\"mb-6\">\n        <Button\n          variant=\"ghost\"\n          onClick={() => setLocation(\"/suppliers\")}\n          className=\"mb-4\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Zurck zu Lieferanten\n        </Button>\n\n        <div className=\"flex justify-between items-start\">\n          <div>\n            <h1 className=\"text-3xl font-bold\">{supplier.name}</h1>\n            {supplier.description && (\n              <p className=\"text-muted-foreground mt-2\">{supplier.description}</p>\n            )}\n            {supplier.urlPattern && (\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                URL-Muster: {supplier.urlPattern}\n              </p>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"overview\" className=\"flex items-center gap-2\">\n            <Info className=\"w-4 h-4\" />\n            bersicht\n          </TabsTrigger>\n          <TabsTrigger value=\"selectors\" className=\"flex items-center gap-2\">\n            <Settings className=\"w-4 h-4\" />\n            CSS-Selektoren\n          </TabsTrigger>\n          <TabsTrigger value=\"field-mapping\" className=\"flex items-center gap-2\">\n            <Map className=\"w-4 h-4\" />\n            Field Mapping\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"overview\">\n          <SupplierOverviewTab supplier={supplier} onUpdate={() => loadSupplier(supplier.id)} />\n        </TabsContent>\n\n        <TabsContent value=\"selectors\">\n          <SupplierSelectorsTab supplier={supplier} onUpdate={() => loadSupplier(supplier.id)} />\n        </TabsContent>\n\n        <TabsContent value=\"field-mapping\">\n          <Card className=\"p-6\">\n            <div className=\"mb-6\">\n              <h2 className=\"text-xl font-semibold mb-2\">Field Mapping Tool</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Definieren Sie, wie gescrapte Felder auf Brickfox-CSV-Spalten gemappt werden sollen.\n                Diese Mappings werden automatisch beim CSV-Export verwendet.\n              </p>\n            </div>\n            <FieldMappingEditor\n              supplierId={supplier.id}\n              sourceType=\"url_scraper\"\n            />\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":5210},"server/services/brickfox-mapping-loader.ts":{"content":"/**\n * Brickfox Mapping Loader\n * Loads saved field mappings from database and converts to Brickfox format\n */\n\nimport { eq, and } from 'drizzle-orm';\nimport { db as heliumDb } from '../db';\nimport { fieldMappings } from '../../shared/mapping-schema';\nimport { BrickfoxExportMapping, DEFAULT_BRICKFOX_MAPPING } from '../../shared/brickfox-schema';\n\nexport async function loadMappingsForSupplier(\n  supplierId: string,\n  tenantId: string,\n  sourceType: 'csv' | 'url_scraper' = 'url_scraper'\n): Promise<BrickfoxExportMapping> {\n  try {\n    const savedMappings = await heliumDb\n      .select()\n      .from(fieldMappings)\n      .where(\n        and(\n          eq(fieldMappings.supplierId, supplierId),\n          eq(fieldMappings.tenantId, tenantId),\n          eq(fieldMappings.sourceType, sourceType),\n          eq(fieldMappings.isActive, true)\n        )\n      );\n\n    if (!savedMappings || savedMappings.length === 0) {\n      console.log(`[Mapping Loader] No custom mappings found for supplier ${supplierId}, using defaults`);\n      return DEFAULT_BRICKFOX_MAPPING;\n    }\n\n    console.log(`[Mapping Loader] Found ${savedMappings.length} custom mappings for supplier ${supplierId}`);\n\n    const customMapping: BrickfoxExportMapping = { ...DEFAULT_BRICKFOX_MAPPING };\n\n    for (const mapping of savedMappings) {\n      customMapping[mapping.targetField] = {\n        source: 'scraped',\n        field: mapping.sourceField,\n      };\n    }\n\n    return customMapping;\n  } catch (error) {\n    console.error('[Mapping Loader] Error loading mappings:', error);\n    return DEFAULT_BRICKFOX_MAPPING;\n  }\n}\n\nexport async function loadMappingsForProject(\n  projectId: string,\n  tenantId: string,\n  sourceType: 'csv' | 'url_scraper' = 'csv'\n): Promise<BrickfoxExportMapping> {\n  try {\n    const savedMappings = await heliumDb\n      .select()\n      .from(fieldMappings)\n      .where(\n        and(\n          eq(fieldMappings.tenantId, tenantId),\n          eq(fieldMappings.sourceType, sourceType),\n          eq(fieldMappings.isActive, true)\n        )\n      );\n\n    if (!savedMappings || savedMappings.length === 0) {\n      console.log(`[Mapping Loader] No CSV mappings found for tenant ${tenantId}, using defaults`);\n      return DEFAULT_BRICKFOX_MAPPING;\n    }\n\n    console.log(`[Mapping Loader] Found ${savedMappings.length} CSV mappings`);\n\n    const customMapping: BrickfoxExportMapping = { ...DEFAULT_BRICKFOX_MAPPING };\n\n    for (const mapping of savedMappings) {\n      customMapping[mapping.targetField] = {\n        source: 'scraped',\n        field: mapping.sourceField,\n      };\n    }\n\n    return customMapping;\n  } catch (error) {\n    console.error('[Mapping Loader] Error loading CSV mappings:', error);\n    return DEFAULT_BRICKFOX_MAPPING;\n  }\n}\n","size_bytes":2735},"client/src/pages/field-mapping-demo.tsx":{"content":"import { FieldMappingEditor } from '@/components/field-mapping-editor';\nimport { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\n\nexport default function FieldMappingDemo() {\n  const handleSave = (mappings: any[]) => {\n    console.log('Mappings saved:', mappings);\n  };\n\n  return (\n    <div className=\"container max-w-7xl mx-auto py-8 px-4\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Field Mapping Tool</h1>\n        <p className=\"text-muted-foreground\">\n          Ordnen Sie gescrapte Felder oder CSV-Spalten den Brickfox-Spalten zu\n        </p>\n      </div>\n\n      <FieldMappingEditor\n        supplierId=\"test-supplier-id\"\n        projectId=\"test-project-id\"\n        onSave={handleSave}\n      />\n\n      <Card className=\"mt-8\">\n        <CardHeader>\n          <CardTitle>Anleitung</CardTitle>\n          <CardDescription>So verwenden Sie das Field Mapping Tool</CardDescription>\n        </CardHeader>\n        <div className=\"p-6 space-y-4 text-sm\">\n          <div>\n            <strong>1. Datenquelle whlen:</strong>\n            <p className=\"text-muted-foreground\">\n              Whlen Sie zwischen \"URL Scraper\" (fr gescrapte Produkte) oder \"CSV Upload\" (fr hochgeladene CSV-Dateien).\n            </p>\n          </div>\n          <div>\n            <strong>2. Feld auswhlen:</strong>\n            <p className=\"text-muted-foreground\">\n              Klicken Sie auf ein Quellfeld (links), das Sie zuordnen mchten.\n            </p>\n          </div>\n          <div>\n            <strong>3. Zielfeld zuordnen:</strong>\n            <p className=\"text-muted-foreground\">\n              Klicken Sie dann auf das entsprechende Brickfox-Feld (rechts). Die Verbindung wird sofort erstellt.\n            </p>\n          </div>\n          <div>\n            <strong>4. Speichern:</strong>\n            <p className=\"text-muted-foreground\">\n              Klicken Sie auf \"Speichern\", um die Mappings zu speichern. Diese werden dann automatisch beim Brickfox-Export verwendet.\n            </p>\n          </div>\n        </div>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2108},"client/src/pages/pdf-auto-scraper.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from '@/components/ui/dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { Upload, FileText, Loader2, ExternalLink, ArrowRight, Mail, Database } from 'lucide-react';\nimport { useLocation } from 'wouter';\n\ninterface PDFProduct {\n  productName: string;\n  url: string | null;\n  articleNumber: string | null;\n  manufacturerArticleNumber?: string | null;  // Hersteller-Artikelnummer (ohne Prfix)\n  eanCode: string | null;\n  ekPrice: string | null;\n  description: string | null;\n  marke: string | null;\n  ve: string | null;\n  liefermenge: string | null;\n  images?: string[];  // Bild-URLs vom URL-Scraper\n  localImagePaths?: string[];  // Lokale Bildpfade\n}\n\ninterface PDFPreviewResult {\n  success: boolean;\n  totalProducts: number;\n  products: PDFProduct[]; // Legacy: products with URL\n  withURL: PDFProduct[];\n  withoutURL: PDFProduct[];\n}\n\nexport default function PDFAutoScraper() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [extractedProducts, setExtractedProducts] = useState<PDFProduct[]>([]);\n  const [productsWithoutURL, setProductsWithoutURL] = useState<PDFProduct[]>([]);\n  const [selectedSupplierId, setSelectedSupplierId] = useState<string>(\"__none__\");\n  const [activeTab, setActiveTab] = useState<'withURL' | 'withoutURL'>('withURL');\n  \n  // Email Dialog State\n  const [isEmailDialogOpen, setIsEmailDialogOpen] = useState(false);\n  const [emailTo, setEmailTo] = useState('');\n  const [emailSubject, setEmailSubject] = useState('Anfrage: Produkt-URLs fr EAN-Codes');\n  const [emailMessage, setEmailMessage] = useState(`Sehr geehrte Damen und Herren,\n\nwir bentigen fr folgende Produkte (EAN-Codes) die entsprechenden Produkt-URLs:\n\n[Die EAN-Codes werden automatisch unten angefgt]\n\nBitte senden Sie uns die URLs zu den aufgelisteten EAN-Codes.\n\nVielen Dank im Voraus!`);\n  \n  // Pagination\n  const [currentPage, setCurrentPage] = useState(1);\n  const productsPerPage = 6;\n\n  // ===== SCRAPE SESSION PERSISTENCE =====\n  // Save scraped data to server session (persists across page navigation)\n  const saveScrapeSession = async (products: PDFProduct[], productsNoUrl: PDFProduct[]) => {\n    try {\n      const token = localStorage.getItem('supabase_token');\n      if (!token) return;\n      \n      await fetch('/api/scrape-session', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          pdfScraper: {\n            withURL: products,\n            withoutURL: productsNoUrl,\n            supplierId: selectedSupplierId,\n          },\n        }),\n      });\n      \n      console.log(' PDF Scrape session saved to server');\n    } catch (error) {\n      console.error('Failed to save PDF scrape session:', error);\n    }\n  };\n\n  // Load extracted products from sessionStorage on mount (when returning from URL-Scraper)\n  useEffect(() => {\n    const savedProducts = sessionStorage.getItem('pdf_auto_scraper_extracted_products');\n    const savedProductsWithoutURL = sessionStorage.getItem('pdf_auto_scraper_products_without_url');\n    const savedSupplierId = sessionStorage.getItem('pdf_auto_scraper_selected_supplier');\n    const scrapedData = sessionStorage.getItem('pdf_url_scraped_data');\n    \n    if (savedProducts) {\n      try {\n        let products = JSON.parse(savedProducts);\n        \n        // Merge scraped data (images, descriptions, etc.) if available\n        if (scrapedData) {\n          const urlToScrapedData = JSON.parse(scrapedData);\n          console.log(` Merging scraped data for ${Object.keys(urlToScrapedData).length} products`);\n          \n          products = products.map((product: PDFProduct) => {\n            if (product.url && urlToScrapedData[product.url]) {\n              const scraped = urlToScrapedData[product.url];\n              return {\n                ...product,\n                images: scraped.images || [],\n                localImagePaths: scraped.localImagePaths || [],\n                description: scraped.description || product.description,\n              };\n            }\n            return product;\n          });\n          \n          // CRITICAL: Save merged data back to sessionStorage so images persist across navigation\n          sessionStorage.setItem('pdf_auto_scraper_extracted_products', JSON.stringify(products));\n          \n          // Clear scraped data after merging\n          sessionStorage.removeItem('pdf_url_scraped_data');\n          \n          toast({\n            title: 'Scraping-Daten bernommen',\n            description: `Bilder und Beschreibungen wurden von ${Object.keys(urlToScrapedData).length} Produkten bernommen`,\n          });\n        }\n        \n        setExtractedProducts(products);\n      } catch (error) {\n        console.error('Failed to parse saved products:', error);\n      }\n    }\n    \n    if (savedProductsWithoutURL) {\n      try {\n        const products = JSON.parse(savedProductsWithoutURL);\n        setProductsWithoutURL(products);\n      } catch (error) {\n        console.error('Failed to parse saved products without URL:', error);\n      }\n    }\n    \n    if (savedSupplierId) {\n      setSelectedSupplierId(savedSupplierId);\n    }\n  }, []);\n\n  // Load scraped data from server session on mount (restore after navigation)\n  useEffect(() => {\n    const loadScrapeSession = async () => {\n      try {\n        const token = localStorage.getItem('supabase_token');\n        if (!token) return;\n        \n        // Don't load if we already have sessionStorage data\n        const hasSessionStorage = sessionStorage.getItem('pdf_auto_scraper_extracted_products');\n        if (hasSessionStorage) return;\n        \n        const response = await fetch('/api/scrape-session', {\n          headers: {\n            'Authorization': `Bearer ${token}`,\n          },\n        });\n        \n        if (!response.ok) return;\n        \n        const { success, session } = await response.json();\n        \n        if (success && session && session.scrapedProducts) {\n          const pdfScraperData = session.scrapedProducts.pdfScraper;\n          \n          if (pdfScraperData) {\n            if (pdfScraperData.withURL && Array.isArray(pdfScraperData.withURL) && pdfScraperData.withURL.length > 0) {\n              setExtractedProducts(pdfScraperData.withURL);\n              console.log(` Restored ${pdfScraperData.withURL.length} PDF products from server session`);\n            }\n            \n            if (pdfScraperData.withoutURL && Array.isArray(pdfScraperData.withoutURL)) {\n              setProductsWithoutURL(pdfScraperData.withoutURL);\n            }\n            \n            if (pdfScraperData.supplierId) {\n              setSelectedSupplierId(pdfScraperData.supplierId);\n            }\n            \n            const totalProducts = (pdfScraperData.withURL?.length || 0) + (pdfScraperData.withoutURL?.length || 0);\n            if (totalProducts > 0) {\n              toast({\n                title: \"PDF-Daten wiederhergestellt\",\n                description: `${totalProducts} Produkte aus vorheriger Sitzung geladen`,\n              });\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Failed to load PDF scrape session:', error);\n      }\n    };\n    \n    loadScrapeSession();\n  }, []);\n\n  // Auto-save session when PDF products change\n  useEffect(() => {\n    if (extractedProducts.length === 0 && productsWithoutURL.length === 0) return;\n    \n    const timeoutId = setTimeout(() => {\n      saveScrapeSession(extractedProducts, productsWithoutURL);\n    }, 1000); // Debounce 1 second\n    \n    return () => clearTimeout(timeoutId);\n  }, [extractedProducts, productsWithoutURL, selectedSupplierId]);\n\n  // Auto-save selected supplier to sessionStorage whenever it changes\n  useEffect(() => {\n    if (selectedSupplierId) {\n      sessionStorage.setItem('pdf_auto_scraper_selected_supplier', selectedSupplierId);\n    }\n  }, [selectedSupplierId]);\n\n  // Load suppliers\n  const { data: suppliersData } = useQuery<{ success: boolean; suppliers: any[] }>({\n    queryKey: ['/api/suppliers'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token') || sessionStorage.getItem('supabase_token');\n      const response = await fetch('/api/suppliers', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        throw new Error('Failed to fetch suppliers');\n      }\n      return response.json();\n    },\n  });\n\n  const extractMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('pdf', file);\n\n      const response = await fetch('/api/pdf/preview', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('supabase_token') || sessionStorage.getItem('supabase_token')}`,\n        },\n        body: formData,\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        throw new Error('PDF-Verarbeitung fehlgeschlagen');\n      }\n\n      return response.json() as Promise<PDFPreviewResult>;\n    },\n    onSuccess: (data) => {\n      setExtractedProducts(data.withURL);\n      setProductsWithoutURL(data.withoutURL);\n      setCurrentPage(1); // Reset to first page\n      \n      // Set default active tab based on what's available\n      if (data.withURL.length > 0) {\n        setActiveTab('withURL');\n      } else if (data.withoutURL.length > 0) {\n        setActiveTab('withoutURL');\n      }\n      \n      // Save to sessionStorage so it persists when returning from URL-Scraper\n      sessionStorage.setItem('pdf_auto_scraper_extracted_products', JSON.stringify(data.withURL));\n      sessionStorage.setItem('pdf_auto_scraper_products_without_url', JSON.stringify(data.withoutURL));\n      \n      toast({\n        title: 'PDF analysiert',\n        description: `${data.totalProducts} Produkte gefunden (${data.withURL.length} mit URL, ${data.withoutURL.length} ohne URL)`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Email Mutation - Send URL request to supplier\n  const emailMutation = useMutation({\n    mutationFn: async (params: { to: string; subject: string; message: string; eanCodes: string[] }) => {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 35000); // 35s timeout\n\n      try {\n        const response = await fetch('/api/email/request-urls', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${localStorage.getItem('supabase_token') || sessionStorage.getItem('supabase_token')}`,\n          },\n          body: JSON.stringify(params),\n          signal: controller.signal,\n        });\n\n        clearTimeout(timeoutId);\n\n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'E-Mail konnte nicht gesendet werden');\n        }\n\n        return response.json();\n      } catch (error) {\n        clearTimeout(timeoutId);\n        if (error instanceof Error && error.name === 'AbortError') {\n          throw new Error('SMTP-Server antwortet nicht (Timeout). Bitte prfen Sie die Server-Einstellungen.');\n        }\n        throw error;\n      }\n    },\n    onSuccess: () => {\n      toast({\n        title: 'E-Mail gesendet',\n        description: 'Die Anfrage wurde erfolgreich an den Lieferanten gesendet',\n      });\n      setIsEmailDialogOpen(false);\n      setEmailTo('');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler beim Senden',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleSendEmail = () => {\n    if (!emailTo || !emailSubject || !emailMessage) {\n      toast({\n        title: 'Fehlende Eingaben',\n        description: 'Bitte fllen Sie alle Felder aus',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Extract EAN codes from products without URL\n    const eanCodes = productsWithoutURL\n      .map(p => p.eanCode)\n      .filter(Boolean) as string[];\n\n    if (eanCodes.length === 0) {\n      toast({\n        title: 'Keine EAN-Codes',\n        description: 'Keine EAN-Codes zum Senden verfgbar',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    emailMutation.mutate({\n      to: emailTo,\n      subject: emailSubject,\n      message: emailMessage,\n      eanCodes,\n    });\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (file.type !== 'application/pdf') {\n        toast({\n          title: 'Ungltiger Dateityp',\n          description: 'Bitte whlen Sie eine PDF-Datei',\n          variant: 'destructive',\n        });\n        return;\n      }\n      setSelectedFile(file);\n      setExtractedProducts([]);\n    }\n  };\n\n  const handleExtract = () => {\n    if (!selectedFile) {\n      toast({\n        title: 'Keine Datei ausgewhlt',\n        description: 'Bitte whlen Sie eine PDF-Datei',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    extractMutation.mutate(selectedFile);\n  };\n\n  const handleScrapeWithURLScraper = () => {\n    if (extractedProducts.length === 0) {\n      toast({\n        title: 'Keine Produkte',\n        description: 'Bitte extrahieren Sie zuerst Produkte aus dem PDF',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Filter products with URLs and create URLmetadata map\n    const productsWithUrls = extractedProducts.filter(p => p.url);\n    \n    if (productsWithUrls.length === 0) {\n      toast({\n        title: 'Keine URLs gefunden',\n        description: 'Keine Produkte mit URLs im PDF gefunden',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Create map: URL  Product metadata (for correct merging in URL-Scraper)\n    const urlToMetadata: Record<string, any> = {};\n    productsWithUrls.forEach(product => {\n      if (product.url) {\n        urlToMetadata[product.url] = {\n          ekPrice: product.ekPrice,\n          articleNumber: product.articleNumber,\n          manufacturerArticleNumber: product.manufacturerArticleNumber,\n          eanCode: product.eanCode,\n          productName: product.productName,\n        };\n      }\n    });\n    \n    // Store URLs and metadata map in sessionStorage\n    const urls = productsWithUrls.map(p => p.url).join('\\n');\n    sessionStorage.setItem('pdf_extracted_urls', urls);\n    sessionStorage.setItem('pdf_url_metadata_map', JSON.stringify(urlToMetadata));\n    \n    // Store selected supplier ID for URL-Scraper\n    if (selectedSupplierId && selectedSupplierId !== \"__none__\") {\n      sessionStorage.setItem('pdf_selected_supplier_id', selectedSupplierId);\n    }\n    \n    // Store selected supplier ID for PDF-Auto-Scraper (to restore when returning)\n    sessionStorage.setItem('pdf_auto_scraper_selected_supplier', selectedSupplierId);\n    \n    setLocation('/url-scraper?from=pdf-auto-scraper');\n  };\n\n  const handleBrickfoxAutoMapping = async () => {\n    if (extractedProducts.length === 0) {\n      toast({\n        title: 'Keine Produkte',\n        description: 'Bitte extrahieren Sie zuerst Produkte aus dem PDF',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    try {\n      toast({\n        title: 'Mapping wird durchgefhrt...',\n        description: 'Ihre Daten werden in Brickfox-Format konvertiert',\n      });\n\n      const sourceData = extractedProducts.map(product => ({\n        'Artikelnummer': product.articleNumber || '',\n        'Produktname': product.productName || '',\n        'EAN': product.eanCode || '',\n        'Hersteller': product.marke || '',\n        'EK (netto) ': product.ekPrice || '',\n        'Nominalspannung (V)': '',\n        'Nominalkapazitt (mAh)': '',\n        'Lnge (mm)': '',\n        'Breite (mm)': '',\n        'Hhe (mm)': '',\n        'Gewicht (g)': '',\n        'Energie (Wh)': '',\n        'Zellenchemie': '',\n        'SEO Titel': '',\n        'SEO Produktbeschreibung': product.description || '',\n        'SEO Keywords': '',\n        'Produktbeschreibung (HTML)': product.description || '',\n        'Schutzschaltung (Li-Ion)': '',\n      }));\n\n      const token = localStorage.getItem('supabase_token');\n      if (!token) {\n        toast({\n          title: 'Nicht authentifiziert',\n          description: 'Bitte melden Sie sich an',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      const response = await fetch('/api/mapping/apply', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          sourceData,\n          exportToCsv: true,\n          filename: 'brickfox_pdf_export',\n        }),\n      });\n\n      const result = await response.json();\n\n      if (!result.success) {\n        toast({\n          title: 'Mapping fehlgeschlagen',\n          description: result.error || 'Ein Fehler ist aufgetreten',\n          variant: 'destructive',\n        });\n        console.error('Mapping errors:', result.errors);\n        return;\n      }\n\n      const blob = new Blob([result.csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `brickfox_export_${new Date().toISOString().slice(0, 10)}.csv`;\n      link.click();\n\n      toast({\n        title: 'Export erfolgreich!',\n        description: `${result.stats.validRows} Produkte wurden in Brickfox-Format exportiert`,\n      });\n\n      if (result.warnings && result.warnings.length > 0) {\n        console.warn('Mapping warnings:', result.warnings);\n      }\n    } catch (error) {\n      console.error('Brickfox mapping error:', error);\n      toast({\n        title: 'Fehler beim Export',\n        description: error instanceof Error ? error.message : 'Ein unbekannter Fehler ist aufgetreten',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-6xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-3xl font-bold mb-2\">PDF Auto-Scraper</h1>\n        <p className=\"text-muted-foreground\">\n          Extrahieren Sie Produkt-URLs und EK-Preise aus Lieferanten-PDFs und verarbeiten Sie diese mit dem URL-Scraper\n        </p>\n      </div>\n\n      <div className=\"grid gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>1. PDF hochladen</CardTitle>\n            <CardDescription>\n              Lieferanten-PDF mit anklickbaren Produkt-URLs und EK-Preisen\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"pdf\">PDF-Datei</Label>\n              <div className=\"flex items-center gap-2\">\n                <Input\n                  id=\"pdf\"\n                  type=\"file\"\n                  accept=\".pdf\"\n                  onChange={handleFileChange}\n                  disabled={extractMutation.isPending}\n                />\n                {selectedFile && (\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <FileText className=\"h-4 w-4\" />\n                    {selectedFile.name}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"supplier-select\">Lieferant auswhlen (optional)</Label>\n              <Select value={selectedSupplierId} onValueChange={setSelectedSupplierId}>\n                <SelectTrigger id=\"supplier-select\">\n                  <SelectValue placeholder=\"Keine Vorlage (Auto-Erkennung)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"__none__\">Keine Vorlage (Auto-Erkennung)</SelectItem>\n                  {suppliersData?.suppliers?.map((supplier) => (\n                    <SelectItem key={supplier.id} value={supplier.id}>\n                      {supplier.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                 Gespeicherte CSS-Selektoren fr diesen Lieferanten laden\n              </p>\n            </div>\n\n            <Button\n              onClick={handleExtract}\n              disabled={!selectedFile || extractMutation.isPending}\n              className=\"w-full\"\n            >\n              {extractMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  PDF wird analysiert...\n                </>\n              ) : (\n                <>\n                  <Upload className=\"mr-2 h-4 w-4\" />\n                  URLs & Preise extrahieren\n                </>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n\n        {(extractedProducts.length > 0 || productsWithoutURL.length > 0) && (\n          <>\n            <Card>\n              <CardHeader>\n                <CardTitle>2. Extrahierte Produkte</CardTitle>\n                <CardDescription>\n                  Produkte aufgeteilt nach Verfgbarkeit von URLs\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'withURL' | 'withoutURL')}>\n                  <TabsList className=\"grid w-full grid-cols-2\">\n                    <TabsTrigger value=\"withURL\" className=\"flex items-center gap-2\">\n                      Mit URL ({extractedProducts.length})\n                      <Badge variant=\"secondary\">{extractedProducts.length}</Badge>\n                    </TabsTrigger>\n                    <TabsTrigger value=\"withoutURL\" className=\"flex items-center gap-2\">\n                      Ohne URL ({productsWithoutURL.length})\n                      <Badge variant=\"secondary\">{productsWithoutURL.length}</Badge>\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"withURL\" className=\"mt-4\">\n                <div className=\"rounded-md border overflow-hidden\">\n                  <div className=\"max-h-96 overflow-y-auto overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead className=\"min-w-[250px]\">Produktname (Bezeichnung)</TableHead>\n                          <TableHead className=\"min-w-[120px]\">Artikel-Nr.</TableHead>\n                          <TableHead className=\"min-w-[150px]\">Hersteller-Artikelnr.</TableHead>\n                          <TableHead className=\"min-w-[130px]\">EAN</TableHead>\n                          <TableHead className=\"min-w-[100px]\">Netto-EK</TableHead>\n                          <TableHead className=\"min-w-[100px]\">Liefermenge</TableHead>\n                          <TableHead className=\"min-w-[400px]\">URL</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {extractedProducts\n                          .filter(p => p.url)\n                          .slice((currentPage - 1) * productsPerPage, currentPage * productsPerPage)\n                          .map((product, index) => (\n                          <TableRow key={index}>\n                            <TableCell className=\"font-medium\">{product.productName || '-'}</TableCell>\n                            <TableCell>{product.articleNumber || '-'}</TableCell>\n                            <TableCell className=\"text-muted-foreground\">{product.manufacturerArticleNumber || '-'}</TableCell>\n                            <TableCell>{product.eanCode || '-'}</TableCell>\n                            <TableCell className=\"whitespace-nowrap\">{product.ekPrice ? `${product.ekPrice} ` : '-'}</TableCell>\n                            <TableCell className=\"whitespace-nowrap\">{product.liefermenge || '1 Stck'}</TableCell>\n                            <TableCell>\n                              <a \n                                href={product.url!} \n                                target=\"_blank\" \n                                rel=\"noopener noreferrer\"\n                                className=\"text-blue-600 hover:underline flex items-center gap-1\"\n                              >\n                                <ExternalLink className=\"h-3 w-3 flex-shrink-0\" />\n                                <span className=\"break-all\">{product.url}</span>\n                              </a>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </div>\n                  \n                  {/* Pagination Controls */}\n                  {extractedProducts.filter(p => p.url).length > productsPerPage && (\n                    <div className=\"flex items-center justify-between px-4 py-3 border-t bg-muted/30\">\n                      <div className=\"text-sm text-muted-foreground\">\n                        Zeige {((currentPage - 1) * productsPerPage) + 1} bis {Math.min(currentPage * productsPerPage, extractedProducts.filter(p => p.url).length)} von {extractedProducts.filter(p => p.url).length} Produkten\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n                          disabled={currentPage === 1}\n                        >\n                          Zurck\n                        </Button>\n                        <div className=\"flex items-center gap-1\">\n                          {Array.from({ length: Math.ceil(extractedProducts.filter(p => p.url).length / productsPerPage) }, (_, i) => i + 1).map((page) => (\n                            <Button\n                              key={page}\n                              variant={currentPage === page ? \"default\" : \"outline\"}\n                              size=\"sm\"\n                              onClick={() => setCurrentPage(page)}\n                              className=\"w-8 h-8 p-0\"\n                            >\n                              {page}\n                            </Button>\n                          ))}\n                        </div>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setCurrentPage(Math.min(Math.ceil(extractedProducts.filter(p => p.url).length / productsPerPage), currentPage + 1))}\n                          disabled={currentPage === Math.ceil(extractedProducts.filter(p => p.url).length / productsPerPage)}\n                        >\n                          Weiter\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"withoutURL\" className=\"mt-4\">\n                    {productsWithoutURL.length > 0 ? (\n                      <div className=\"space-y-4\">\n                        <div className=\"rounded-md border overflow-hidden\">\n                          <div className=\"max-h-96 overflow-y-auto overflow-x-auto\">\n                            <Table>\n                              <TableHeader>\n                                <TableRow>\n                                  <TableHead className=\"min-w-[120px]\">Artikel-Nr.</TableHead>\n                                  <TableHead className=\"min-w-[150px]\">Hersteller-Artikelnr.</TableHead>\n                                  <TableHead className=\"min-w-[130px]\">EAN</TableHead>\n                                  <TableHead className=\"min-w-[100px]\">Netto-EK</TableHead>\n                                  <TableHead className=\"min-w-[100px]\">Liefermenge</TableHead>\n                                </TableRow>\n                              </TableHeader>\n                              <TableBody>\n                                {productsWithoutURL.map((product, index) => (\n                                  <TableRow key={index}>\n                                    <TableCell>{product.articleNumber || '-'}</TableCell>\n                                    <TableCell className=\"text-muted-foreground\">{product.manufacturerArticleNumber || '-'}</TableCell>\n                                    <TableCell>{product.eanCode || '-'}</TableCell>\n                                    <TableCell className=\"whitespace-nowrap\">{product.ekPrice ? `${product.ekPrice} ` : '-'}</TableCell>\n                                    <TableCell className=\"whitespace-nowrap\">{product.liefermenge || '1 Stck'}</TableCell>\n                                  </TableRow>\n                                ))}\n                              </TableBody>\n                            </Table>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2 p-4 bg-orange-50 border border-orange-200 rounded-md\">\n                          <Mail className=\"h-5 w-5 text-orange-600\" />\n                          <div className=\"flex-1\">\n                            <p className=\"text-sm font-medium text-orange-900\">URLs erforderlich</p>\n                            <p className=\"text-xs text-orange-700\">Kontaktieren Sie den Lieferanten, um Produkt-URLs zu erhalten</p>\n                          </div>\n                          <Dialog open={isEmailDialogOpen} onOpenChange={setIsEmailDialogOpen}>\n                            <DialogTrigger asChild>\n                              <Button variant=\"outline\" size=\"sm\" className=\"border-orange-300\">\n                                <Mail className=\"h-4 w-4 mr-2\" />\n                                URLs anfragen\n                              </Button>\n                            </DialogTrigger>\n                            <DialogContent className=\"max-w-2xl\">\n                              <DialogHeader>\n                                <DialogTitle>E-Mail an Lieferanten senden</DialogTitle>\n                                <DialogDescription>\n                                  Senden Sie eine Anfrage mit den EAN-Codes an Ihren Lieferanten\n                                </DialogDescription>\n                              </DialogHeader>\n                              <div className=\"space-y-4 py-4\">\n                                <div className=\"space-y-2\">\n                                  <Label htmlFor=\"email-to\">Empfnger-E-Mail *</Label>\n                                  <Input\n                                    id=\"email-to\"\n                                    type=\"email\"\n                                    placeholder=\"lieferant@beispiel.de\"\n                                    value={emailTo}\n                                    onChange={(e) => setEmailTo(e.target.value)}\n                                  />\n                                </div>\n                                <div className=\"space-y-2\">\n                                  <Label htmlFor=\"email-subject\">Betreff *</Label>\n                                  <Input\n                                    id=\"email-subject\"\n                                    value={emailSubject}\n                                    onChange={(e) => setEmailSubject(e.target.value)}\n                                  />\n                                </div>\n                                <div className=\"space-y-2\">\n                                  <Label htmlFor=\"email-message\">Nachricht *</Label>\n                                  <Textarea\n                                    id=\"email-message\"\n                                    rows={8}\n                                    value={emailMessage}\n                                    onChange={(e) => setEmailMessage(e.target.value)}\n                                    className=\"font-mono text-sm\"\n                                  />\n                                  <p className=\"text-xs text-muted-foreground\">\n                                     Die EAN-Codes ({productsWithoutURL.filter(p => p.eanCode).length} Stck) werden automatisch am Ende der E-Mail angefgt\n                                  </p>\n                                </div>\n                              </div>\n                              <DialogFooter>\n                                <Button\n                                  variant=\"outline\"\n                                  onClick={() => setIsEmailDialogOpen(false)}\n                                  disabled={emailMutation.isPending}\n                                >\n                                  Abbrechen\n                                </Button>\n                                <Button\n                                  onClick={handleSendEmail}\n                                  disabled={emailMutation.isPending}\n                                >\n                                  {emailMutation.isPending ? (\n                                    <>\n                                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                                      Wird gesendet...\n                                    </>\n                                  ) : (\n                                    <>\n                                      <Mail className=\"mr-2 h-4 w-4\" />\n                                      E-Mail senden\n                                    </>\n                                  )}\n                                </Button>\n                              </DialogFooter>\n                            </DialogContent>\n                          </Dialog>\n                        </div>\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-12 text-muted-foreground\">\n                        <p>Keine Produkte ohne URL gefunden</p>\n                      </div>\n                    )}\n                  </TabsContent>\n                </Tabs>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-blue-200 bg-blue-50/50\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <ArrowRight className=\"h-5 w-5 text-blue-600\" />\n                  3. Mit URL-Scraper weiterverarbeiten\n                </CardTitle>\n                <CardDescription>\n                  Nutzen Sie den URL-Scraper, um vollstndige Produktdaten von den extrahierten URLs zu laden\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Button \n                  onClick={handleScrapeWithURLScraper}\n                  className=\"w-full\"\n                  size=\"lg\"\n                >\n                  Zum URL-Scraper wechseln\n                  <ArrowRight className=\"ml-2 h-4 w-4\" />\n                </Button>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Die extrahierten URLs und EK-Preise werden automatisch bernommen\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-green-200 bg-green-50/50\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Database className=\"h-5 w-5 text-green-600\" />\n                  4. Automatischer Brickfox-Export\n                </CardTitle>\n                <CardDescription>\n                  Konvertieren Sie die PDF-Daten automatisch in Brickfox-CSV-Format\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Button \n                  onClick={handleBrickfoxAutoMapping}\n                  className=\"w-full bg-green-600 hover:bg-green-700\"\n                  size=\"lg\"\n                  disabled={extractedProducts.length === 0}\n                >\n                  <Database className=\"mr-2 h-4 w-4\" />\n                  Brickfox-CSV generieren\n                </Button>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  Automatisches Mapping: Spannung  Kategorie, Preise, Attribute, Bilder uvm.\n                </p>\n              </CardContent>\n            </Card>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":37458},"server/services/pdf-parser.ts":{"content":"import * as pdfjsLib from 'pdfjs-dist/legacy/build/pdf.mjs';\nimport type { TextItem } from 'pdfjs-dist/types/src/display/api';\n\nconst DEBUG_MODE = process.env.DEBUG_MODE === 'true';\n\ninterface PDFProduct {\n  productName: string;\n  url: string | null;\n  articleNumber: string | null;\n  manufacturerArticleNumber?: string | null;  // Hersteller-Artikelnummer (ohne Prfix)\n  eanCode: string | null;\n  ekPrice: string | null;\n  description: string | null;\n  marke: string | null;\n  ve: string | null;\n  liefermenge: string | null;\n  kategorie?: string | null;\n  bezeichnung?: string | null;\n}\n\nexport interface PDFParseResult {\n  withURL: PDFProduct[];\n  withoutURL: PDFProduct[];\n  totalProducts: number;\n}\n\nexport class PDFParserService {\n  /**\n   * Extract ALL products from PDF: WITH URL and WITHOUT URL\n   * Returns separated lists for different workflows\n   */\n  async extractProductsWithSeparation(buffer: Buffer): Promise<PDFParseResult> {\n    try {\n      const uint8Array = new Uint8Array(buffer);\n      const loadingTask = pdfjsLib.getDocument({ data: uint8Array });\n      const pdfDoc = await loadingTask.promise;\n      \n      const productsWithURL: PDFProduct[] = [];\n      const productsWithoutURL: PDFProduct[] = [];\n      const numPages = pdfDoc.numPages;\n\n      console.log(` PDF Parser (Separation Mode): Processing ${numPages} pages...`);\n\n      for (let pageNum = 1; pageNum <= numPages; pageNum++) {\n        const page = await pdfDoc.getPage(pageNum);\n        \n        const textContent = await page.getTextContent();\n        const annotations = await page.getAnnotations();\n        const textItems = textContent.items as TextItem[];\n\n        // Extract links with their bounding boxes\n        const links = annotations\n          .filter((anno: any) => anno.subtype === 'Link' && anno.url)\n          .map((anno: any) => ({\n            url: anno.url,\n            rect: anno.rect,\n            y: anno.rect[1],\n            x: anno.rect[0],\n          }));\n\n        console.log(` Page ${pageNum}: Found ${links.length} products with URLs`);\n\n        // Track processed Y positions to avoid duplicate parsing\n        const processedYPositions = new Set<number>();\n\n        // 1. PRODUCTS WITH URL\n        links.forEach((link) => {\n          // Increase Y-tolerance to capture multi-line data (article number, EAN, price might be on different Y positions)\n          const rowYMin = link.y - 15;  // Increased from 8 to 15\n          const rowYMax = link.y + 15;  // Increased from 8 to 15\n\n          const rowTextItems = textItems.filter((item) => {\n            const itemY = item.transform[5];\n            return itemY >= rowYMin && itemY <= rowYMax;\n          });\n\n          rowTextItems.sort((a, b) => a.transform[4] - b.transform[4]);\n          const rowText = rowTextItems.map(item => item.str).join(' ');\n\n          const product = this.parseProductRow(rowText, link.url);\n          if (product && this.isValidProduct(product)) {\n            productsWithURL.push(product);\n            processedYPositions.add(Math.round(link.y));\n          }\n        });\n\n        // 2. PRODUCTS WITHOUT URL (pure table rows)\n        // Group text items by Y position range to capture multi-line data\n        const textByRow = new Map<number, TextItem[]>();\n        \n        textItems.forEach((item) => {\n          // Round to nearest 5 to group nearby Y positions\n          const y = Math.round(item.transform[5] / 5) * 5;\n          if (!textByRow.has(y)) {\n            textByRow.set(y, []);\n          }\n          textByRow.get(y)!.push(item);\n        });\n\n        // Process rows that weren't already processed (no URL)\n        textByRow.forEach((items, y) => {\n          // Check if this Y position is close to any processed position\n          const isProcessed = Array.from(processedYPositions).some(processedY => {\n            return Math.abs(y - processedY) < 15;\n          });\n          \n          if (!isProcessed) {\n            items.sort((a, b) => a.transform[4] - b.transform[4]);\n            const rowText = items.map(item => item.str).join(' ');\n\n            // Only parse rows that look like product data\n            if (this.looksLikeProductRow(rowText)) {\n              const product = this.parseProductRow(rowText, null);\n              if (product && product.articleNumber && product.eanCode) {\n                productsWithoutURL.push(product);\n              }\n            }\n          }\n        });\n      }\n\n      // Remove duplicates\n      const uniqueWithURL = this.removeDuplicates(productsWithURL, true);\n      const uniqueWithoutURL = this.removeDuplicates(productsWithoutURL, false);\n\n      console.log(` Products WITH URL: ${uniqueWithURL.length}`);\n      console.log(` Products WITHOUT URL: ${uniqueWithoutURL.length}`);\n\n      return {\n        withURL: uniqueWithURL,\n        withoutURL: uniqueWithoutURL,\n        totalProducts: uniqueWithURL.length + uniqueWithoutURL.length\n      };\n    } catch (error) {\n      console.error(' PDF Parser Separation Error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if a text row looks like product data\n   */\n  private looksLikeProductRow(rowText: string): boolean {\n    // Must have article number pattern\n    const hasArticle = /\\b\\d{4}-\\d{4}(?:-\\d{2})?\\b/.test(rowText) || /\\b\\d{8,10}\\b/.test(rowText);\n    // Must have EAN pattern\n    const hasEAN = /\\b\\d{13}\\b/.test(rowText);\n    // Should have price pattern\n    const hasPrice = /\\d+[,\\.]\\d{2}/.test(rowText);\n    \n    return hasArticle && hasEAN && hasPrice;\n  }\n\n  /**\n   * Remove duplicate products\n   */\n  private removeDuplicates(products: PDFProduct[], byURL: boolean): PDFProduct[] {\n    return products.reduce((acc, product) => {\n      const exists = byURL\n        ? acc.find(p => p.url === product.url)\n        : acc.find(p => p.articleNumber === product.articleNumber || p.eanCode === product.eanCode);\n      \n      if (!exists) {\n        acc.push(product);\n      }\n      \n      return acc;\n    }, [] as PDFProduct[]);\n  }\n\n  /**\n   * Extract hyperlinks and product data from supplier PDF using position-based row detection\n   * This method uses Y-coordinate matching to associate prices and metadata with specific product links\n   */\n  async extractProductsFromPDFAdvanced(buffer: Buffer): Promise<PDFProduct[]> {\n    try {\n      // Convert Buffer to Uint8Array (pdfjs-dist requirement)\n      const uint8Array = new Uint8Array(buffer);\n      const loadingTask = pdfjsLib.getDocument({ data: uint8Array });\n      const pdfDoc = await loadingTask.promise;\n      \n      const products: PDFProduct[] = [];\n      const numPages = pdfDoc.numPages;\n\n      console.log(` PDF Parser (Advanced): Processing ${numPages} pages...`);\n\n      for (let pageNum = 1; pageNum <= numPages; pageNum++) {\n        const page = await pdfDoc.getPage(pageNum);\n        \n        const textContent = await page.getTextContent();\n        const annotations = await page.getAnnotations();\n        const textItems = textContent.items as TextItem[];\n\n        // Extract links with their bounding boxes\n        const links = annotations\n          .filter((anno: any) => anno.subtype === 'Link' && anno.url)\n          .map((anno: any) => ({\n            url: anno.url,\n            rect: anno.rect, // [x1, y1, x2, y2]\n            y: anno.rect[1], // Bottom Y coordinate\n            x: anno.rect[0], // Left X coordinate\n          }));\n\n        if (DEBUG_MODE) {\n          console.log(`Page ${pageNum}: Found ${links.length} links`);\n        }\n\n        // For each link, find text items in the same row (within Y range)\n        links.forEach((link) => {\n          // Define row bounds: within 8 units of link Y position for tight row matching\n          // Typical PDF line height is ~12 units, so 8 ensures we stay within one row\n          // while accounting for slight vertical alignment variations\n          const rowYMin = link.y - 8;\n          const rowYMax = link.y + 8;\n\n          // Find all text items in this row\n          // We use Y-coordinate for row matching only - X-coordinates are used for ordering\n          const rowTextItems = textItems.filter((item) => {\n            const itemY = item.transform[5];\n            return itemY >= rowYMin && itemY <= rowYMax;\n          });\n\n          // Sort by X position (left to right)\n          rowTextItems.sort((a, b) => a.transform[4] - b.transform[4]);\n\n          // Build row text\n          const rowText = rowTextItems.map(item => item.str).join(' ');\n\n          if (DEBUG_MODE) {\n            console.log(`Link URL: ${link.url}`);\n            console.log(`Row text: ${rowText.substring(0, 100)}...`);\n          }\n\n          // Parse this specific row\n          const product = this.parseProductRow(rowText, link.url);\n          if (product && this.isValidProduct(product)) {\n            products.push(product);\n          }\n        });\n      }\n\n      // Remove duplicates based on URL (same product might appear on multiple pages)\n      const uniqueProducts = products.reduce((acc, product) => {\n        if (!product.url) return acc;\n        \n        // Check if this URL already exists\n        const exists = acc.find(p => p.url === product.url);\n        if (!exists) {\n          acc.push(product);\n        }\n        \n        return acc;\n      }, [] as PDFProduct[]);\n\n      console.log(` PDF Parser (Advanced): Extracted ${products.length} products (${uniqueProducts.length} unique)`);\n      return uniqueProducts;\n    } catch (error) {\n      console.error(' PDF Parser Advanced Error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Parse a single table row into a product\n   */\n  private parseProductRow(rowText: string, url: string | null): PDFProduct | null {\n    try {\n      // Pattern for table: Marke | Bezeichnung | Artikel-Nr. | Beschreibung | EAN | VE | EK | UEVP\n      const parts = rowText.split(/\\s{2,}/); // Split by 2+ spaces\n\n      const product: PDFProduct = {\n        productName: '',\n        url,\n        articleNumber: null,\n        eanCode: null,\n        ekPrice: null,\n        description: null,\n        marke: null,\n        ve: null,\n        liefermenge: null,\n      };\n\n      // Extract structured data using IMPROVED regex patterns\n      // Article Number Patterns:\n      // - XXXX-XXXX-XX (10 digits with dashes)\n      // - XXXX-XXXX (8 digits with dashes)\n      // - XXXXXXXX (8 digits without dashes)\n      // - XXXXXXXXXX (10 digits without dashes)\n      const articleMatch = rowText.match(/\\b\\d{4}-\\d{4}(?:-\\d{2})?\\b/) || \n                          rowText.match(/\\b\\d{8,10}\\b/);\n      \n      // EAN Patterns:\n      // - 13 digits (standard EAN-13)\n      // - Can be anywhere in the text\n      const eanMatch = rowText.match(/\\b\\d{13}\\b/);\n      \n      // Price Patterns (FLEXIBLE):\n      // - XX,XX  or XX.XX \n      // - XX,XX or XX.XX (without  symbol)\n      // - With or without spaces\n      const priceMatches = rowText.match(/(\\d+[,\\.]\\d{2})\\s*?/g);\n\n      // Debug: Log what we found (always log if nothing found)\n      if (DEBUG_MODE || !articleMatch || !eanMatch || !priceMatches) {\n        console.log(`\\n Row parsing:`);\n        console.log(`  Row text: ${rowText.substring(0, 200)}...`);\n        console.log(`  Article match: ${articleMatch ? articleMatch[0] : 'NONE'}`);\n        console.log(`  EAN match: ${eanMatch ? eanMatch[0] : 'NONE'}`);\n        console.log(`  Price matches: ${priceMatches ? priceMatches.join(', ') : 'NONE'}`);\n      }\n\n      // Process Article Number: Keep original format with hyphens (2447-3049-60)\n      if (articleMatch) {\n        const originalNumber = articleMatch[0].trim();  // Keep hyphens intact!\n        product.articleNumber = originalNumber;  // Will be prefixed later in the route\n        product.manufacturerArticleNumber = originalNumber;  // Keep original format for Pixi matching\n        console.log(`   Article: ${product.articleNumber} (Manufacturer: ${product.manufacturerArticleNumber})`);\n      }\n      \n      // Process EAN Code\n      if (eanMatch) {\n        product.eanCode = eanMatch[0];\n        console.log(`   EAN: ${product.eanCode}`);\n      }\n      \n      // Process Prices (Netto-EK)\n      // PDF has 2 prices: Netto-EK (second-to-last) and UE/VP (last)\n      // We need Netto-EK, NOT UE/VP!\n      if (priceMatches && priceMatches.length >= 1) {\n        // Clean prices: remove  and whitespace\n        const cleanedPrices = priceMatches.map(p => p.replace(//g, '').trim());\n        \n        // If there are 2+ prices, take the second-to-last (Netto-EK)\n        // If there's only 1 price, take it as fallback\n        product.ekPrice = cleanedPrices.length >= 2 \n          ? cleanedPrices[cleanedPrices.length - 2]  // Netto-EK (not UE/VP!)\n          : cleanedPrices[cleanedPrices.length - 1]; // Fallback for single price\n        \n        console.log(`   Netto-EK: ${product.ekPrice || 'N/A'} (aus ${cleanedPrices.length} Preisen)`);\n      }\n\n      // Extract Marke (first word is often the brand)\n      const firstWord = rowText.split(/\\s+/)[0];\n      if (firstWord && firstWord.length > 2) {\n        product.marke = firstWord;\n      }\n\n      // Extract BEZEICHNUNG as productName (between Marke and Artikel-Nr.)\n      // Strategy: Remove all recognized patterns and extract the remaining text\n      let cleanedText = rowText;\n      \n      // Remove Marke (first word)\n      if (product.marke) {\n        cleanedText = cleanedText.replace(product.marke, '').trim();\n      }\n      \n      // Remove Artikel-Nr.\n      if (articleMatch) {\n        cleanedText = cleanedText.replace(articleMatch[0], '').trim();\n      }\n      \n      // Remove EAN\n      if (eanMatch) {\n        cleanedText = cleanedText.replace(eanMatch[0], '').trim();\n      }\n      \n      // Remove all prices\n      if (priceMatches) {\n        priceMatches.forEach(price => {\n          cleanedText = cleanedText.replace(price, '').trim();\n        });\n      }\n      \n      // Remove common column headers/noise\n      cleanedText = cleanedText\n        .replace(/\\bVE\\b/g, '')\n        .replace(/\\bEK\\b/g, '')\n        .replace(/\\bUEVP\\b/g, '')\n        .replace(/\\bNetto-EK\\b/g, '')\n        .replace(/\\s{2,}/g, ' ') // Normalize multiple spaces\n        .trim();\n      \n      // Extract the first meaningful text block as Bezeichnung (product name)\n      // This should be the product description after removing all structured data\n      const bezeichnungMatch = cleanedText.match(/^([^\\d]{5,}?)(?:\\s{2,}|$)/);\n      if (bezeichnungMatch) {\n        product.productName = bezeichnungMatch[1].trim();\n      } else if (cleanedText.length > 3) {\n        // Fallback: Use cleaned text if it's meaningful\n        product.productName = cleanedText.substring(0, 100).trim();\n      } else {\n        // Last resort: Use \"Unknown Product\"\n        product.productName = 'Unknown Product';\n      }\n      \n      console.log(`   Bezeichnung (Produktname): ${product.productName}`);\n\n      // Extract Liefermenge with multiple patterns:\n      // - \"4er\"  4 Stck\n      // - \"4 Stck\"  4 Stck\n      // - \"100 Karton\"  100 Stck\n      // - \"10er Pack\"  10 Stck\n      const liefermengePatterns = [\n        /(\\d+)\\s*er\\b/i,                              // \"4er\", \"10er\"\n        /(\\d+)\\s*-\\s*er\\b/i,                          // \"4-er\"\n        /(\\d+)\\s*(Stck|St\\.|STK)/i,                  // \"4 Stck\", \"4 St.\", \"4 STK\"\n        /(\\d+)\\s*(Karton|Box)/i,                      // \"100 Karton\", \"50 Box\"\n        /(\\d+)\\s*(Pack|pack)/i,                       // \"10 Pack\"\n      ];\n      \n      let liefermengeFound = false;\n      for (const pattern of liefermengePatterns) {\n        const match = rowText.match(pattern);\n        if (match) {\n          product.liefermenge = `${match[1]} Stck`;\n          console.log(`   Liefermenge: ${product.liefermenge} (Pattern: ${pattern})`);\n          liefermengeFound = true;\n          break;\n        }\n      }\n      \n      if (!liefermengeFound) {\n        // Default: 1 Stck if not specified\n        product.liefermenge = '1 Stck';\n      }\n\n      return product;\n    } catch (error) {\n      console.error('Error parsing product row:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Filter out non-product links (AGB, Datenschutz, Impressum, etc.)\n   */\n  private isValidProduct(product: PDFProduct): boolean {\n    const name = product.productName.toLowerCase();\n    const url = product.url?.toLowerCase() || '';\n    \n    // Filter out common non-product pages by name\n    const invalidKeywords = [\n      'agb',\n      'geschaeftskunden',\n      'datenschutz',\n      'impressum',\n      'kontakt',\n      'cookie',\n      'nutzungsbedingungen',\n      'widerruf',\n      'versand',\n      'zahlung',\n      'gmbh',          // Company names\n      'co. kg',\n      ' ag ',\n      'akkushop',\n      'ansmann ag'\n    ];\n    \n    // Filter out invalid URLs\n    const invalidUrlPatterns = [\n      'agb',\n      'geschaeftskund',\n      'datenschutz',\n      'impressum',\n      'kontakt',\n      'cookie'\n    ];\n    \n    // Check product name for invalid keywords\n    if (invalidKeywords.some(keyword => name.includes(keyword))) {\n      if (DEBUG_MODE) {\n        console.log(` Filtered out non-product (name): ${product.productName}`);\n      }\n      return false;\n    }\n    \n    // Check URL for invalid patterns\n    if (url && invalidUrlPatterns.some(pattern => url.includes(pattern))) {\n      if (DEBUG_MODE) {\n        console.log(` Filtered out non-product (URL): ${product.url}`);\n      }\n      return false;\n    }\n    \n    return true;\n  }\n}\n\nexport const pdfParserService = new PDFParserService();\n","size_bytes":17535},"server/services/email-service.ts":{"content":"import nodemailer from 'nodemailer';\n\n/**\n * Email Service for sending emails via SMTP (Greyhound)\n */\nclass EmailService {\n  private transporter: nodemailer.Transporter | null = null;\n\n  constructor() {\n    this.initializeTransporter();\n  }\n\n  /**\n   * Initialize SMTP transporter with Greyhound credentials\n   */\n  private initializeTransporter() {\n    const smtpHost = process.env.SMTP_HOST;\n    const smtpPort = process.env.SMTP_PORT ? parseInt(process.env.SMTP_PORT) : 587;\n    const smtpUser = process.env.SMTP_USER;\n    const smtpPass = process.env.SMTP_PASS;\n    const smtpFrom = process.env.SMTP_FROM;\n\n    if (!smtpHost || !smtpUser || !smtpPass || !smtpFrom) {\n      console.warn(' SMTP credentials not configured. Email sending will be disabled.');\n      return;\n    }\n\n    this.transporter = nodemailer.createTransport({\n      host: smtpHost,\n      port: smtpPort,\n      secure: smtpPort === 465, // true for 465, false for other ports\n      auth: {\n        user: smtpUser,\n        pass: smtpPass,\n      },\n      connectionTimeout: 30000, // 30 seconds (default: 120s)\n      greetingTimeout: 30000, // 30 seconds\n      socketTimeout: 45000, // 45 seconds for actual sending\n    });\n\n    console.log(` Email Service initialized: ${smtpHost}:${smtpPort}`);\n  }\n\n  /**\n   * Send email for requesting product URLs from supplier\n   */\n  async sendSupplierUrlRequest(params: {\n    to: string;\n    subject: string;\n    message: string;\n    eanCodes: string[];\n  }): Promise<{ success: boolean; error?: string }> {\n    if (!this.transporter) {\n      return {\n        success: false,\n        error: 'SMTP transporter not configured. Please check SMTP environment variables.',\n      };\n    }\n\n    const { to, subject, message, eanCodes } = params;\n    const smtpFrom = process.env.SMTP_FROM!;\n\n    // Build EAN list for email body\n    const eanList = eanCodes.map((ean, index) => `${index + 1}. ${ean}`).join('\\n');\n\n    // Construct email body\n    const emailBody = `${message}\n\n\nEAN-Codes (${eanCodes.length} Produkte):\n\n\n${eanList}\n\n\n\nMit freundlichen Gren\n${smtpFrom}\n`;\n\n    try {\n      const info = await this.transporter.sendMail({\n        from: smtpFrom,\n        to: to,\n        subject: subject,\n        text: emailBody,\n      });\n\n      console.log(' Email sent successfully:', info.messageId);\n      return { success: true };\n    } catch (error) {\n      console.error(' Email sending failed:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Test SMTP connection\n   */\n  async testConnection(): Promise<{ success: boolean; error?: string }> {\n    if (!this.transporter) {\n      return {\n        success: false,\n        error: 'SMTP transporter not configured',\n      };\n    }\n\n    try {\n      await this.transporter.verify();\n      console.log(' SMTP connection test successful');\n      return { success: true };\n    } catch (error) {\n      console.error(' SMTP connection test failed:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n}\n\nexport const emailService = new EmailService();\n","size_bytes":3490},"server/image-download-service.ts":{"content":"import fs from 'fs/promises';\nimport { createWriteStream } from 'fs';\nimport path from 'path';\nimport https from 'https';\nimport http from 'http';\n\nexport interface DownloadedImage {\n  originalUrl: string;\n  localPath: string;\n  filename: string;\n}\n\n/**\n * Downloads an image from a URL and saves it locally\n */\nasync function downloadImage(url: string, outputPath: string): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const protocol = url.startsWith('https') ? https : http;\n    \n    protocol.get(url, (response) => {\n      if (response.statusCode !== 200) {\n        reject(new Error(`Failed to download image: ${response.statusCode}`));\n        return;\n      }\n\n      const fileStream = createWriteStream(outputPath);\n      response.pipe(fileStream);\n\n      fileStream.on('finish', () => {\n        fileStream.close();\n        resolve();\n      });\n\n      fileStream.on('error', (err: Error) => {\n        fs.unlink(outputPath).catch(() => {});\n        reject(err);\n      });\n    }).on('error', (err) => {\n      reject(err);\n    });\n  });\n}\n\n/**\n * Sanitizes article number to prevent directory traversal attacks\n * @param articleNumber Raw article number from user input\n * @returns Safe article number (only alphanumeric, underscore, hyphen)\n */\nfunction sanitizeArticleNumber(articleNumber: string): string {\n  // Remove any characters that could cause path traversal\n  // Allow only: A-Z, a-z, 0-9, underscore, hyphen\n  const sanitized = articleNumber.replace(/[^A-Za-z0-9_-]/g, '_');\n  \n  // Prevent empty or dangerous patterns\n  if (!sanitized || sanitized === '.' || sanitized === '..') {\n    return 'unknown_product';\n  }\n  \n  return sanitized;\n}\n\n/**\n * Downloads all product images and saves them locally\n * @param imageUrls Array of image URLs to download\n * @param articleNumber Product article number (used for folder name) - will be sanitized\n * @returns Array of downloaded image info (original URL + local path)\n */\nexport async function downloadProductImages(\n  imageUrls: string[],\n  articleNumber: string\n): Promise<DownloadedImage[]> {\n  if (!imageUrls || imageUrls.length === 0) {\n    return [];\n  }\n\n  // CRITICAL: Sanitize article number to prevent directory traversal attacks\n  const safeArticleNumber = sanitizeArticleNumber(articleNumber);\n  console.log(`[Image Download] Sanitized article number: \"${articleNumber}\"  \"${safeArticleNumber}\"`);\n\n  // Create product-specific folder\n  const productFolder = path.join('attached_assets', 'product_images', safeArticleNumber);\n  await fs.mkdir(productFolder, { recursive: true });\n\n  const downloadedImages: DownloadedImage[] = [];\n\n  // Download each image with loop\n  for (let i = 0; i < imageUrls.length; i++) {\n    const imageUrl = imageUrls[i];\n    \n    try {\n      // Detect file extension from URL\n      const urlPath = new URL(imageUrl).pathname;\n      const ext = path.extname(urlPath) || '.jpg';\n      const filename = `bild_${i + 1}${ext}`;\n      const localPath = path.join(productFolder, filename);\n\n      console.log(`[Image Download] Downloading image ${i + 1}/${imageUrls.length}: ${imageUrl}`);\n      await downloadImage(imageUrl, localPath);\n\n      downloadedImages.push({\n        originalUrl: imageUrl,\n        localPath: localPath.replace(/\\\\/g, '/'), // Normalize path separators\n        filename\n      });\n\n      console.log(`[Image Download]  Saved: ${localPath}`);\n    } catch (error) {\n      console.error(`[Image Download]  Failed to download image ${i + 1}: ${error}`);\n      // Continue with next image even if one fails\n    }\n  }\n\n  return downloadedImages;\n}\n","size_bytes":3588},"docs/WORKFLOW_DIAGRAMS.md":{"content":"# PIMPilot - Workflow-Flussdiagramme\n\nDieses Dokument enthlt visuelle Flussdiagramme fr alle Hauptfunktionen von PIMPilot.\n\n---\n\n## 1. CSV Bulk-Import  KI-Produktbeschreibungen\n\n```mermaid\nflowchart TD\n    Start([User ldt CSV-Datei hoch]) --> Parse[CSV-Datei parsen]\n    Parse --> Validate{Spalten valid?}\n    Validate -->|Nein| Error1[Fehler: Ungltige CSV]\n    Validate -->|Ja| SelectProject[Projekt auswhlen]\n    SelectProject --> MapColumns[Spalten zuordnen: Name, EAN, Hersteller, etc.]\n    MapColumns --> ImportDB[(Produkte in Datenbank speichern)]\n    ImportDB --> SelectProducts[Produkte fr KI-Generierung auswhlen]\n    SelectProducts --> AILoop{Fr jedes Produkt}\n    AILoop --> CallOpenAI[OpenAI GPT-4o-mini API aufrufen]\n    CallOpenAI --> GenerateDesc[SEO-optimierte Beschreibung generieren]\n    GenerateDesc --> SaveDesc[(Beschreibung speichern)]\n    SaveDesc --> NextProduct{Weitere Produkte?}\n    NextProduct -->|Ja| AILoop\n    NextProduct -->|Nein| ShowResults[Ergebnisse anzeigen]\n    ShowResults --> ExportOption[Export-Option whlen]\n    ExportOption --> End([Fertig])\n```\n\n**Dauer:** 2-5 Sekunden pro Produkt (abhngig von OpenAI API)\n\n---\n\n## 2. URL Web-Scraper  Produktdaten extrahieren\n\n```mermaid\nflowchart TD\n    Start([User gibt Produkt-URLs ein]) --> SelectSupplier[Lieferant auswhlen: ANSMANN, Nitecore, etc.]\n    SelectSupplier --> LoadSelectors[(CSS-Selektoren aus DB laden)]\n    LoadSelectors --> HasSelectors{Selektoren vorhanden?}\n    HasSelectors -->|Nein| ManualSelectors[Manuelle Selektoren eingeben]\n    HasSelectors -->|Ja| AutoSelectors[Gespeicherte Selektoren verwenden]\n    ManualSelectors --> StartScrape\n    AutoSelectors --> StartScrape[Scraping starten]\n    StartScrape --> LoginCheck{Login erforderlich?}\n    LoginCheck -->|Ja| PerformLogin[Automatischer Login mit gespeicherten Cookies]\n    LoginCheck -->|Nein| FetchPage\n    PerformLogin --> FetchPage[Webseite abrufen]\n    FetchPage --> ParseHTML[HTML mit Cheerio parsen]\n    ParseHTML --> ExtractData[Daten extrahieren: Name, Preis, EAN, Bilder, etc.]\n    ExtractData --> DownloadImages[Produktbilder herunterladen]\n    DownloadImages --> MagentoCheck{Magento-System?}\n    MagentoCheck -->|Ja| ParseJSON[JSON Gallery-Daten extrahieren]\n    MagentoCheck -->|Nein| RegularImages[Standard IMG-Tags]\n    ParseJSON --> SaveProduct\n    RegularImages --> SaveProduct[(Produkt in DB speichern)]\n    SaveProduct --> MoreURLs{Weitere URLs?}\n    MoreURLs -->|Ja| FetchPage\n    MoreURLs -->|Nein| Results[Gescrapte Produkte anzeigen]\n    Results --> AIGenerate[Optional: KI-Beschreibungen generieren]\n    AIGenerate --> End([Fertig])\n```\n\n**Features:**\n- Automatischer Login mit Session-Cookie-Persistierung\n- Magento JSON Gallery-Parsing\n- Intelligente CSS-Selektor-Erkennung\n- Automatischer Bild-Download\n\n---\n\n## 3. PDF Auto-Scraper  Automatische Pipeline\n\n```mermaid\nflowchart TD\n    Start([User ldt PDF hoch]) --> ParsePDF[PDF mit pdf-parse analysieren]\n    ParsePDF --> ExtractText[Text extrahieren]\n    ExtractText --> FindURLs[Produkt-URLs via RegEx finden]\n    FindURLs --> FindPrices[Preise extrahieren: Netto-EK, UE/VP]\n    FindPrices --> ValidateURLs{URLs gefunden?}\n    ValidateURLs -->|Nein| Error1[Fehler: Keine URLs im PDF]\n    ValidateURLs -->|Ja| CalculateVK[VK berechnen: EK  2.38, gerundet auf .95]\n    CalculateVK --> GroupBySupplier[URLs nach Lieferant gruppieren]\n    GroupBySupplier --> SelectSupplier[Lieferant fr Scraping auswhlen]\n    SelectSupplier --> LoadSelectors[(CSS-Selektoren laden)]\n    LoadSelectors --> AutoScrape[Automatisches Scraping aller URLs]\n    AutoScrape --> ExtractData[Produktdaten extrahieren]\n    ExtractData --> MergeData[PDF-Daten + Scraped-Daten zusammenfhren]\n    MergeData --> EnrichData[VK-Preis + Artikelnummern hinzufgen]\n    EnrichData --> SaveProducts[(Produkte in DB speichern)]\n    SaveProducts --> AIGenerate[Optional: KI-Beschreibungen]\n    AIGenerate --> Results[Komplette Produktliste anzeigen]\n    Results --> End([Fertig])\n```\n\n**Besonderheit:**\n- **VK-Formel:** `(Netto-EK  2) + 19% = EK  2.38`, immer auf `.95` gerundet\n- **Dual Article Numbers:** Lieferant-Nr + Interne Nr (z.B. ANSMANN + A-Code)\n\n---\n\n## 4. Pixi ERP-Integration  Duplikat-Erkennung\n\n```mermaid\nflowchart TD\n    Start([User whlt Projekt aus]) --> LoadProducts[(Produkte aus Projekt laden)]\n    LoadProducts --> PrepareData[EAN-Codes extrahieren]\n    PrepareData --> CallPixiAPI[Pixi ERP API aufrufen]\n    CallPixiAPI --> FetchInventory[Bestandsdaten abrufen]\n    FetchInventory --> CompareProducts{Fr jedes Produkt}\n    CompareProducts --> MatchEAN{EAN im Pixi-System?}\n    MatchEAN -->|Ja| MarkExisting[Als \"Existing\" markieren]\n    MatchEAN -->|Nein| MarkNew[Als \"New\" markieren]\n    MarkExisting --> CheckStock[Lagerbestand prfen]\n    MarkNew --> NextProduct\n    CheckStock --> UpdateStatus[Status aktualisieren]\n    UpdateStatus --> NextProduct{Weitere Produkte?}\n    NextProduct -->|Ja| CompareProducts\n    NextProduct -->|Nein| GenerateReport[Vergleichsbericht erstellen]\n    GenerateReport --> ShowResults[Ergebnisse anzeigen: New vs. Existing]\n    ShowResults --> ExportCSV[CSV-Export mit Status]\n    ExportCSV --> End([Fertig])\n```\n\n**Output:**\n- Liste: Neue Produkte (nicht in Pixi)\n- Liste: Bestehende Produkte (bereits in Pixi)\n- Lagerbestandsinformationen\n\n---\n\n## 5. Field Mapping  Flexibles Export-System\n\n```mermaid\nflowchart TD\n    Start([User ffnet Field Mapping]) --> LoadSource[Quell-Daten laden: Scraped/CSV]\n    LoadSource --> LoadTarget[Ziel-Felder laden: Export-Template]\n    LoadTarget --> ShowMapping[Visual Click-to-Connect Interface]\n    ShowMapping --> UserConnect{User verbindet Felder}\n    UserConnect --> DragDrop[Drag & Drop: Source  Target]\n    DragDrop --> Transform{Transformation ntig?}\n    Transform -->|Ja| AddFormula[Formel hinzufgen: z.B. CONCAT, UPPER]\n    Transform -->|Nein| DirectMap[Direktes Mapping]\n    AddFormula --> SaveMapping\n    DirectMap --> SaveMapping[(Mapping-Preset speichern)]\n    SaveMapping --> MoreFields{Weitere Felder?}\n    MoreFields -->|Ja| UserConnect\n    MoreFields -->|Nein| ValidateMapping{Pflichtfelder gemappt?}\n    ValidateMapping -->|Nein| Error1[Fehler: Fehlende Pflichtfelder]\n    ValidateMapping -->|Ja| ApplyMapping[Mapping auf alle Produkte anwenden]\n    ApplyMapping --> GenerateExport[Export-CSV generieren]\n    GenerateExport --> DownloadCSV[CSV-Download]\n    DownloadCSV --> End([Fertig])\n```\n\n**Features:**\n- Wiederverwendbare Mapping-Presets\n- Custom Transformations (CONCAT, SPLIT, UPPER, etc.)\n- Validierung von Pflichtfeldern\n\n---\n\n## 6. Brickfox/ERP CSV-Export  Finaler Export\n\n```mermaid\nflowchart TD\n    Start([User whlt Projekt aus]) --> LoadProducts[(Produkte aus DB laden)]\n    LoadProducts --> CheckMapping{Mapping vorhanden?}\n    CheckMapping -->|Nein| CreateMapping[Field Mapping konfigurieren]\n    CheckMapping -->|Ja| LoadMapping[(Mapping-Preset laden)]\n    CreateMapping --> LoadMapping\n    LoadMapping --> ApplyRules[Geschftsregeln anwenden]\n    ApplyRules --> FormatData[Daten formatieren: Datum, Preise, etc.]\n    FormatData --> EnrichAI{KI-Beschreibungen vorhanden?}\n    EnrichAI -->|Nein| GenerateAI[KI-Beschreibungen generieren]\n    EnrichAI -->|Ja| SkipAI\n    GenerateAI --> MergeData\n    SkipAI --> MergeData[Alle Daten zusammenfhren]\n    MergeData --> ValidateData{Datenqualitt OK?}\n    ValidateData -->|Nein| ShowErrors[Fehler anzeigen]\n    ValidateData -->|Ja| GenerateCSV[CSV-Datei erstellen]\n    GenerateCSV --> AddHeaders[CSV-Header hinzufgen]\n    AddHeaders --> ExportFile[Datei zum Download bereitstellen]\n    ExportFile --> End([Fertig: Brickfox-ready CSV])\n```\n\n**Output-Format:**\n- Brickfox-kompatible CSV\n- Alle Pflichtfelder gefllt\n- SEO-optimierte Beschreibungen\n- Korrekte Preisformatierung\n\n---\n\n## 7. Gesamtbersicht: Kompletter PIMPilot-Workflow\n\n```mermaid\nflowchart LR\n    subgraph Input[\" Input-Quellen\"]\n        CSV[CSV-Upload]\n        PDF[PDF-Upload]\n        URL[Manuelle URLs]\n    end\n\n    subgraph Processing[\" Verarbeitung\"]\n        Parse[Daten parsen]\n        Scrape[Web Scraping]\n        AI[KI-Generierung]\n        Map[Field Mapping]\n    end\n\n    subgraph Database[\" Datenbank\"]\n        Projects[(Projekte)]\n        Products[(Produkte)]\n        Suppliers[(Lieferanten)]\n    end\n\n    subgraph Integration[\" Integrationen\"]\n        Pixi[Pixi ERP]\n        OpenAI[OpenAI API]\n        SMTP[E-Mail]\n    end\n\n    subgraph Output[\" Output\"]\n        ExportCSV[CSV-Export]\n        Dashboard[Dashboard]\n        Reports[Berichte]\n    end\n\n    CSV --> Parse\n    PDF --> Parse\n    URL --> Scrape\n    Parse --> Products\n    Scrape --> Products\n    Products --> AI\n    AI --> OpenAI\n    OpenAI --> Products\n    Products --> Map\n    Map --> ExportCSV\n    Products --> Pixi\n    Pixi --> Reports\n    Products --> Dashboard\n\n    style Input fill:#e3f2fd\n    style Processing fill:#fff3e0\n    style Database fill:#f3e5f5\n    style Integration fill:#e8f5e9\n    style Output fill:#fce4ec\n```\n\n---\n\n## Zeitschtzungen pro Workflow\n\n| Workflow | Dauer (Single Product) | Dauer (100 Products) |\n|----------|------------------------|----------------------|\n| CSV Import | 1 Sekunde | 10 Sekunden |\n| URL Scraper | 3-5 Sekunden | 5-8 Minuten |\n| PDF Auto-Scraper | 5-10 Sekunden | 8-15 Minuten |\n| KI-Generierung | 2-4 Sekunden | 3-7 Minuten |\n| Pixi-Vergleich | 1 Sekunde | 15-30 Sekunden |\n| Field Mapping | Einmalig 5 Min | Wiederverwendbar |\n| CSV-Export | 1 Sekunde | 5 Sekunden |\n\n**Gesamt:** Von PDF bis fertiger CSV: **15-20 Minuten** fr 100 Produkte\n\n---\n\n## Technologie-Stack\n\n```mermaid\ngraph TD\n    subgraph Frontend\n        React[React 18 + TypeScript]\n        Vite[Vite Build Tool]\n        Shadcn[shadcn/ui Components]\n        TailwindCSS[Tailwind CSS]\n    end\n\n    subgraph Backend\n        Express[Express.js]\n        Drizzle[Drizzle ORM]\n        Supabase[Supabase Auth]\n    end\n\n    subgraph Database\n        PostgreSQL[(PostgreSQL)]\n        Helium[Helium Dev]\n        SupabaseProd[Supabase Prod]\n    end\n\n    subgraph External\n        OpenAI[OpenAI GPT-4o-mini]\n        PixiAPI[Pixi ERP API]\n        Cheerio[Cheerio Web Scraper]\n        SMTP[Greyhound SMTP]\n    end\n\n    React --> Express\n    Express --> Drizzle\n    Drizzle --> PostgreSQL\n    PostgreSQL --> Helium\n    PostgreSQL --> SupabaseProd\n    Express --> OpenAI\n    Express --> PixiAPI\n    Express --> Cheerio\n    Express --> SMTP\n\n    style Frontend fill:#4fc3f7\n    style Backend fill:#81c784\n    style Database fill:#ba68c8\n    style External fill:#ffb74d\n```\n\n---\n\n## Lizenz & Kontakt\n\n**PIMPilot** - Produktdaten-Management automatisiert  \n 2025 | Alle Rechte vorbehalten\n\nFr Fragen: [Kontaktformular](/contact)\n","size_bytes":10737},"client/src/pages/contact.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { ArrowLeft, Mail, Send, CheckCircle2 } from 'lucide-react';\nimport { useLocation } from 'wouter';\n\nexport default function Contact() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n  \n  const [formData, setFormData] = useState({\n    name: '',\n    company: '',\n    email: '',\n    phone: '',\n    message: '',\n  });\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n\n    try {\n      const res = await fetch('/api/contact', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(formData),\n      });\n\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Fehler beim Senden der Nachricht');\n      }\n\n      setIsSuccess(true);\n      toast({\n        title: 'Nachricht gesendet!',\n        description: 'Wir melden uns schnellstmglich bei Ihnen.',\n      });\n\n      setFormData({\n        name: '',\n        company: '',\n        email: '',\n        phone: '',\n        message: '',\n      });\n    } catch (error: any) {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    setFormData({\n      ...formData,\n      [e.target.name]: e.target.value,\n    });\n  };\n\n  if (isSuccess) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-16 px-4 flex items-center justify-center\">\n        <Card className=\"max-w-md w-full text-center\">\n          <CardContent className=\"pt-12 pb-8\">\n            <div className=\"mb-6 flex justify-center\">\n              <div className=\"bg-green-100 rounded-full p-4\">\n                <CheckCircle2 className=\"h-12 w-12 text-green-600\" />\n              </div>\n            </div>\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">Vielen Dank!</h2>\n            <p className=\"text-gray-600 mb-6\">\n              Ihre Nachricht wurde erfolgreich versendet. Wir melden uns schnellstmglich bei Ihnen.\n            </p>\n            <Button onClick={() => setLocation('/')} className=\"w-full\">\n              Zurck zur Startseite\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-16 px-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        <div className=\"mb-8\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation('/')}\n            className=\"flex items-center gap-2 text-gray-600 hover:text-gray-900\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n            Zurck\n          </Button>\n        </div>\n\n        <div className=\"text-center mb-12\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <div className=\"bg-indigo-100 rounded-full p-3\">\n              <Mail className=\"h-8 w-8 text-indigo-600\" />\n            </div>\n          </div>\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-4\">\n            Kontaktieren Sie uns\n          </h1>\n          <p className=\"text-xl text-gray-600 max-w-2xl mx-auto\">\n            Haben Sie Fragen zu PIMPilot? Wir helfen Ihnen gerne weiter!\n          </p>\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-8\">\n          {/* Contact Form */}\n          <Card className=\"shadow-lg\">\n            <CardHeader>\n              <CardTitle>Nachricht senden</CardTitle>\n              <CardDescription>\n                Fllen Sie das Formular aus und wir melden uns bei Ihnen.\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Name *</Label>\n                  <Input\n                    id=\"name\"\n                    name=\"name\"\n                    placeholder=\"Ihr Name\"\n                    value={formData.name}\n                    onChange={handleChange}\n                    required\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"company\">Firma</Label>\n                  <Input\n                    id=\"company\"\n                    name=\"company\"\n                    placeholder=\"Ihre Firma (optional)\"\n                    value={formData.company}\n                    onChange={handleChange}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">E-Mail *</Label>\n                  <Input\n                    id=\"email\"\n                    name=\"email\"\n                    type=\"email\"\n                    placeholder=\"ihre@email.de\"\n                    value={formData.email}\n                    onChange={handleChange}\n                    required\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\">Telefon</Label>\n                  <Input\n                    id=\"phone\"\n                    name=\"phone\"\n                    type=\"tel\"\n                    placeholder=\"+49 123 456789 (optional)\"\n                    value={formData.phone}\n                    onChange={handleChange}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"message\">Nachricht *</Label>\n                  <Textarea\n                    id=\"message\"\n                    name=\"message\"\n                    placeholder=\"Ihre Nachricht...\"\n                    value={formData.message}\n                    onChange={handleChange}\n                    required\n                    rows={6}\n                    className=\"resize-none\"\n                  />\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  disabled={isSubmitting}\n                  className=\"w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 hover:from-blue-700 hover:via-purple-700 hover:to-pink-700\"\n                >\n                  {isSubmitting ? (\n                    <>Wird gesendet...</>\n                  ) : (\n                    <>\n                      <Send className=\"h-4 w-4 mr-2\" />\n                      Nachricht senden\n                    </>\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n\n          {/* Contact Info */}\n          <div className=\"space-y-6\">\n            <Card className=\"shadow-lg bg-gradient-to-br from-blue-50 to-purple-50\">\n              <CardHeader>\n                <CardTitle>Warum PIMPilot?</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"bg-blue-600 text-white rounded-full p-1 flex-shrink-0 mt-0.5\">\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-gray-900\">Schnelle Implementierung</p>\n                    <p className=\"text-sm text-gray-600\">In wenigen Tagen startklar</p>\n                  </div>\n                </div>\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"bg-purple-600 text-white rounded-full p-1 flex-shrink-0 mt-0.5\">\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-gray-900\">KI-Automatisierung</p>\n                    <p className=\"text-sm text-gray-600\">Spart Zeit und Kosten</p>\n                  </div>\n                </div>\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"bg-pink-600 text-white rounded-full p-1 flex-shrink-0 mt-0.5\">\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-gray-900\">Persnlicher Support</p>\n                    <p className=\"text-sm text-gray-600\">Direkter Ansprechpartner</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8977},"server/services/permission-service.ts":{"content":"import { db as heliumDb } from '../db';\nimport { permissions, users } from '../../shared/schema';\nimport { eq, and } from 'drizzle-orm';\n\nexport type Resource = 'products' | 'projects' | 'suppliers' | 'backups' | 'users' | 'templates' | 'exports';\nexport type Action = 'read' | 'create' | 'update' | 'delete' | 'export' | 'import' | 'restore';\nexport type Scope = 'all' | 'own' | 'team' | 'none';\n\nexport interface PermissionCheck {\n  userId: string;\n  resource: Resource;\n  action: Action;\n  resourceOwnerId?: string;\n  tenantId?: string;\n}\n\nexport class PermissionService {\n  async hasPermission(check: PermissionCheck): Promise<boolean> {\n    try {\n      const { userId, resource, action, resourceOwnerId, tenantId } = check;\n\n      const [user] = await heliumDb\n        .select()\n        .from(users)\n        .where(eq(users.id, userId))\n        .limit(1);\n\n      if (!user) {\n        console.log(`[Permission] User ${userId} not found`);\n        return false;\n      }\n\n      if (user.isAdmin) {\n        console.log(`[Permission] Admin user ${userId} has full access`);\n        return true;\n      }\n\n      const userPermissions = await heliumDb\n        .select()\n        .from(permissions)\n        .where(\n          and(\n            eq(permissions.userId, userId),\n            eq(permissions.resource, resource),\n            eq(permissions.action, action)\n          )\n        );\n\n      if (userPermissions.length === 0) {\n        const defaultPermissions = this.getDefaultPermissionsForRole(user.role || 'member');\n        const matchingDefaults = defaultPermissions.filter(\n          (p) => p.resource === resource && p.action === action\n        );\n\n        if (matchingDefaults.length === 0) {\n          console.log(`[Permission] User ${userId} has no permissions for ${action} on ${resource}`);\n          return false;\n        }\n\n        for (const defaultPerm of matchingDefaults) {\n          if (defaultPerm.scope === 'all') {\n            console.log(`[Permission] User ${userId} has default ${action} on ${resource} with 'all' scope via role ${user.role}`);\n            return true;\n          }\n\n          if (defaultPerm.scope === 'own') {\n            if (action === 'create') {\n              console.log(`[Permission] User ${userId} allowed to create ${resource} with 'own' scope (will own created resource)`);\n              return true;\n            }\n            \n            if (resourceOwnerId === userId) {\n              console.log(`[Permission] User ${userId} has default ${action} on ${resource} with 'own' scope and owns resource`);\n              return true;\n            }\n          }\n\n          if (defaultPerm.scope === 'team') {\n            if (action === 'create') {\n              console.log(`[Permission] User ${userId} allowed to create ${resource} with 'team' scope within tenant`);\n              return true;\n            }\n            \n            if (user.tenantId === tenantId) {\n              console.log(`[Permission] User ${userId} has default ${action} on ${resource} with 'team' scope within tenant`);\n              return true;\n            }\n          }\n        }\n\n        console.log(`[Permission] User ${userId} has default permissions but scope check failed`);\n        return false;\n      }\n\n      for (const permission of userPermissions) {\n        const scope = permission.scope as Scope;\n\n        if (scope === 'all') {\n          console.log(`[Permission] User ${userId} has 'all' scope for ${action} on ${resource}`);\n          return true;\n        }\n\n        if (scope === 'own') {\n          if (action === 'create') {\n            console.log(`[Permission] User ${userId} allowed to create ${resource} with 'own' scope`);\n            return true;\n          }\n          \n          if (resourceOwnerId === userId) {\n            console.log(`[Permission] User ${userId} has 'own' scope and owns resource`);\n            return true;\n          }\n        }\n\n        if (scope === 'team') {\n          if (action === 'create') {\n            console.log(`[Permission] User ${userId} allowed to create ${resource} with 'team' scope`);\n            return true;\n          }\n          \n          if (user.tenantId === tenantId) {\n            console.log(`[Permission] User ${userId} has 'team' scope within tenant`);\n            return true;\n          }\n        }\n      }\n\n      console.log(`[Permission] User ${userId} denied ${action} on ${resource}`);\n      return false;\n    } catch (error) {\n      console.error('[Permission] Check failed:', error);\n      return false;\n    }\n  }\n\n  async grantPermission(data: {\n    userId: string;\n    tenantId?: string;\n    resource: Resource;\n    action: Action;\n    scope?: Scope;\n    conditions?: any;\n  }) {\n    try {\n      const [permission] = await heliumDb\n        .insert(permissions)\n        .values({\n          userId: data.userId,\n          tenantId: data.tenantId || null,\n          resource: data.resource,\n          action: data.action,\n          scope: data.scope || 'all',\n          conditions: data.conditions || null,\n        })\n        .returning();\n\n      console.log(` [Permission] Granted ${data.action} on ${data.resource} to user ${data.userId}`);\n      return permission;\n    } catch (error: any) {\n      console.error('[Permission] Grant failed:', error);\n      throw new Error(`Failed to grant permission: ${error.message}`);\n    }\n  }\n\n  async revokePermission(permissionId: string) {\n    try {\n      await heliumDb\n        .delete(permissions)\n        .where(eq(permissions.id, permissionId));\n\n      console.log(` [Permission] Revoked permission ${permissionId}`);\n      return { success: true };\n    } catch (error: any) {\n      console.error('[Permission] Revoke failed:', error);\n      throw new Error(`Failed to revoke permission: ${error.message}`);\n    }\n  }\n\n  async listUserPermissions(userId: string) {\n    try {\n      const userPermissions = await heliumDb\n        .select()\n        .from(permissions)\n        .where(eq(permissions.userId, userId));\n\n      return userPermissions;\n    } catch (error: any) {\n      console.error('[Permission] List failed:', error);\n      throw new Error(`Failed to list permissions: ${error.message}`);\n    }\n  }\n\n  async updateUserRole(userId: string, newRole: string) {\n    try {\n      const [user] = await heliumDb\n        .update(users)\n        .set({ role: newRole })\n        .where(eq(users.id, userId))\n        .returning();\n\n      console.log(` [Permission] Updated user ${userId} to role ${newRole}`);\n      return user;\n    } catch (error: any) {\n      console.error('[Permission] Role update failed:', error);\n      throw new Error(`Failed to update role: ${error.message}`);\n    }\n  }\n\n  getDefaultPermissionsForRole(role: string): Array<{ resource: Resource; action: Action; scope: Scope }> {\n    const rolePermissions: Record<string, Array<{ resource: Resource; action: Action; scope: Scope }>> = {\n      admin: [\n        { resource: 'products', action: 'read', scope: 'all' },\n        { resource: 'products', action: 'create', scope: 'all' },\n        { resource: 'products', action: 'update', scope: 'all' },\n        { resource: 'products', action: 'delete', scope: 'all' },\n        { resource: 'products', action: 'export', scope: 'all' },\n        { resource: 'projects', action: 'read', scope: 'all' },\n        { resource: 'projects', action: 'create', scope: 'all' },\n        { resource: 'projects', action: 'update', scope: 'all' },\n        { resource: 'projects', action: 'delete', scope: 'all' },\n        { resource: 'suppliers', action: 'read', scope: 'all' },\n        { resource: 'suppliers', action: 'create', scope: 'all' },\n        { resource: 'suppliers', action: 'update', scope: 'all' },\n        { resource: 'suppliers', action: 'delete', scope: 'all' },\n        { resource: 'backups', action: 'read', scope: 'all' },\n        { resource: 'backups', action: 'create', scope: 'all' },\n        { resource: 'backups', action: 'restore', scope: 'all' },\n        { resource: 'users', action: 'read', scope: 'all' },\n        { resource: 'users', action: 'create', scope: 'all' },\n        { resource: 'users', action: 'update', scope: 'all' },\n      ],\n      editor: [\n        { resource: 'products', action: 'read', scope: 'all' },\n        { resource: 'products', action: 'create', scope: 'all' },\n        { resource: 'products', action: 'update', scope: 'all' },\n        { resource: 'products', action: 'export', scope: 'all' },\n        { resource: 'projects', action: 'read', scope: 'all' },\n        { resource: 'projects', action: 'create', scope: 'all' },\n        { resource: 'projects', action: 'update', scope: 'all' },\n        { resource: 'suppliers', action: 'read', scope: 'all' },\n        { resource: 'suppliers', action: 'create', scope: 'all' },\n        { resource: 'suppliers', action: 'update', scope: 'all' },\n      ],\n      viewer: [\n        { resource: 'products', action: 'read', scope: 'all' },\n        { resource: 'products', action: 'export', scope: 'all' },\n        { resource: 'projects', action: 'read', scope: 'all' },\n        { resource: 'suppliers', action: 'read', scope: 'all' },\n      ],\n      project_manager: [\n        { resource: 'products', action: 'read', scope: 'all' },\n        { resource: 'products', action: 'create', scope: 'all' },\n        { resource: 'products', action: 'update', scope: 'own' },\n        { resource: 'products', action: 'delete', scope: 'own' },\n        { resource: 'projects', action: 'read', scope: 'all' },\n        { resource: 'projects', action: 'create', scope: 'all' },\n        { resource: 'projects', action: 'update', scope: 'own' },\n        { resource: 'projects', action: 'delete', scope: 'own' },\n        { resource: 'suppliers', action: 'read', scope: 'all' },\n      ],\n      member: [\n        { resource: 'products', action: 'read', scope: 'own' },\n        { resource: 'products', action: 'create', scope: 'own' },\n        { resource: 'products', action: 'update', scope: 'own' },\n        { resource: 'projects', action: 'read', scope: 'own' },\n        { resource: 'projects', action: 'create', scope: 'own' },\n        { resource: 'suppliers', action: 'read', scope: 'all' },\n      ],\n    };\n\n    return rolePermissions[role] || rolePermissions.member;\n  }\n\n  async initializeDefaultPermissions(userId: string, role: string, tenantId?: string) {\n    try {\n      const defaultPerms = this.getDefaultPermissionsForRole(role);\n\n      for (const perm of defaultPerms) {\n        await this.grantPermission({\n          userId,\n          tenantId,\n          resource: perm.resource,\n          action: perm.action,\n          scope: perm.scope,\n        });\n      }\n\n      console.log(` [Permission] Initialized ${defaultPerms.length} default permissions for user ${userId} (${role})`);\n    } catch (error: any) {\n      console.error('[Permission] Initialize defaults failed:', error);\n    }\n  }\n}\n\nexport const permissionService = new PermissionService();\n","size_bytes":10904},"server/services/backup-service.ts":{"content":"import { db as heliumDb } from '../db';\nimport { \n  backups, \n  auditLogs, \n  projects, \n  productsInProjects, \n  suppliers, \n  templates,\n  users,\n  permissions,\n} from '../../shared/schema';\nimport { eq, and, sql, desc } from 'drizzle-orm';\n\ninterface BackupMetadata {\n  tablesIncluded: string[];\n  recordCounts: Record<string, number>;\n  duration: number;\n  compression: boolean;\n}\n\ninterface CreateBackupOptions {\n  tenantId?: string;\n  userId?: string;\n  backupType: 'manual' | 'scheduled' | 'pre_migration';\n  expiresInDays?: number;\n}\n\ninterface RestoreBackupOptions {\n  backupId: string;\n  tenantId: string;\n  userId: string;\n}\n\nexport class BackupService {\n  async createBackup(options: CreateBackupOptions) {\n    const startTime = Date.now();\n    const { tenantId, userId, backupType, expiresInDays = 30 } = options;\n\n    try {\n      console.log(`[Backup] Starting ${backupType} backup for tenant: ${tenantId || 'ALL'}`);\n\n      const backupData: any = {};\n      const recordCounts: Record<string, number> = {};\n\n      if (tenantId) {\n        backupData.users = await heliumDb\n          .select()\n          .from(users)\n          .where(eq(users.tenantId, tenantId));\n        recordCounts.users = backupData.users.length;\n\n        backupData.projects = await heliumDb\n          .select()\n          .from(projects)\n          .where(eq(projects.tenantId, tenantId));\n        recordCounts.projects = backupData.projects.length;\n\n        backupData.products = await heliumDb\n          .select()\n          .from(productsInProjects)\n          .where(eq(productsInProjects.tenantId, tenantId));\n        recordCounts.products = backupData.products.length;\n\n        backupData.suppliers = await heliumDb\n          .select()\n          .from(suppliers)\n          .where(eq(suppliers.tenantId, tenantId));\n        recordCounts.suppliers = backupData.suppliers.length;\n\n        backupData.templates = await heliumDb\n          .select()\n          .from(templates)\n          .where(eq(templates.tenantId, tenantId));\n        recordCounts.templates = backupData.templates.length;\n\n        backupData.permissions = await heliumDb\n          .select()\n          .from(permissions)\n          .where(eq(permissions.tenantId, tenantId));\n        recordCounts.permissions = backupData.permissions.length;\n      } else {\n        backupData.projects = await heliumDb.select().from(projects);\n        recordCounts.projects = backupData.projects.length;\n\n        backupData.products = await heliumDb.select().from(productsInProjects);\n        recordCounts.products = backupData.products.length;\n\n        backupData.suppliers = await heliumDb.select().from(suppliers);\n        recordCounts.suppliers = backupData.suppliers.length;\n\n        backupData.templates = await heliumDb.select().from(templates);\n        recordCounts.templates = backupData.templates.length;\n      }\n\n      const duration = Date.now() - startTime;\n      const backupDataString = JSON.stringify(backupData);\n      const size = Buffer.byteLength(backupDataString, 'utf8');\n\n      const metadata: BackupMetadata = {\n        tablesIncluded: Object.keys(recordCounts),\n        recordCounts,\n        duration,\n        compression: false,\n      };\n\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + expiresInDays);\n\n      const [backup] = await heliumDb\n        .insert(backups)\n        .values({\n          tenantId: tenantId || null,\n          backupType,\n          status: 'completed',\n          backupData: backupData,\n          size,\n          createdBy: userId || null,\n          expiresAt,\n          metadata,\n        })\n        .returning();\n\n      console.log(` [Backup] Created backup ${backup.id} (${(size / 1024 / 1024).toFixed(2)} MB, ${duration}ms)`);\n      console.log(`   Tables: ${Object.entries(recordCounts).map(([k, v]) => `${k}=${v}`).join(', ')}`);\n\n      await this.logAudit({\n        tenantId: tenantId || null,\n        userId: userId || null,\n        action: 'create',\n        resourceType: 'backup',\n        resourceId: backup.id,\n        changes: { metadata },\n      });\n\n      return backup;\n    } catch (error: any) {\n      console.error(` [Backup] Failed:`, error);\n      throw new Error(`Backup failed: ${error.message}`);\n    }\n  }\n\n  async restoreBackup(options: RestoreBackupOptions) {\n    const { backupId, tenantId, userId } = options;\n\n    try {\n      console.log(`[Backup] Starting restore from backup ${backupId} for tenant ${tenantId}`);\n\n      const [backup] = await heliumDb\n        .select()\n        .from(backups)\n        .where(eq(backups.id, backupId))\n        .limit(1);\n\n      if (!backup) {\n        throw new Error('Backup not found');\n      }\n\n      if (backup.tenantId && backup.tenantId !== tenantId) {\n        throw new Error('Backup does not belong to this tenant');\n      }\n\n      const backupData = backup.backupData as any;\n\n      await heliumDb.transaction(async (tx) => {\n        console.log('[Backup] Starting point-in-time restore transaction...');\n\n        await tx.delete(permissions).where(eq(permissions.tenantId, tenantId));\n        await tx.delete(productsInProjects).where(eq(productsInProjects.tenantId, tenantId));\n        await tx.delete(projects).where(eq(projects.tenantId, tenantId));\n        await tx.delete(suppliers).where(eq(suppliers.tenantId, tenantId));\n        await tx.delete(templates).where(eq(templates.tenantId, tenantId));\n        \n        await tx.delete(users).where(eq(users.tenantId, tenantId));\n        \n        console.log('[Backup] Deleted existing tenant data for clean restore');\n\n        if (backupData.users && Array.isArray(backupData.users)) {\n          for (const user of backupData.users) {\n            await tx\n              .insert(users)\n              .values(user);\n          }\n          console.log(`[Backup] Restored ${backupData.users.length} users`);\n        }\n\n        if (backupData.projects && Array.isArray(backupData.projects)) {\n          for (const project of backupData.projects) {\n            await tx\n              .insert(projects)\n              .values({\n                ...project,\n                tenantId,\n              });\n          }\n          console.log(`[Backup] Restored ${backupData.projects.length} projects`);\n        }\n\n        if (backupData.products && Array.isArray(backupData.products)) {\n          for (const product of backupData.products) {\n            await tx\n              .insert(productsInProjects)\n              .values({\n                ...product,\n                tenantId,\n              });\n          }\n          console.log(`[Backup] Restored ${backupData.products.length} products`);\n        }\n\n        if (backupData.suppliers && Array.isArray(backupData.suppliers)) {\n          for (const supplier of backupData.suppliers) {\n            await tx\n              .insert(suppliers)\n              .values({\n                ...supplier,\n                tenantId,\n              });\n          }\n          console.log(`[Backup] Restored ${backupData.suppliers.length} suppliers`);\n        }\n\n        if (backupData.templates && Array.isArray(backupData.templates)) {\n          for (const template of backupData.templates) {\n            await tx\n              .insert(templates)\n              .values({\n                ...template,\n                tenantId,\n              });\n          }\n          console.log(`[Backup] Restored ${backupData.templates.length} templates`);\n        }\n\n        if (backupData.permissions && Array.isArray(backupData.permissions)) {\n          for (const permission of backupData.permissions) {\n            await tx\n              .insert(permissions)\n              .values({\n                ...permission,\n                tenantId,\n              });\n          }\n          console.log(`[Backup] Restored ${backupData.permissions.length} permissions`);\n        }\n      });\n\n      console.log(` [Backup] Restore completed from backup ${backupId}`);\n\n      await this.logAudit({\n        tenantId,\n        userId,\n        action: 'restore',\n        resourceType: 'backup',\n        resourceId: backupId,\n        changes: { restoredAt: new Date().toISOString() },\n      });\n\n      return { success: true, message: 'Backup restored successfully' };\n    } catch (error: any) {\n      console.error(` [Backup] Restore failed:`, error);\n      throw new Error(`Restore failed: ${error.message}`);\n    }\n  }\n\n  async listBackups(tenantId?: string) {\n    try {\n      const query = tenantId\n        ? heliumDb.select().from(backups).where(eq(backups.tenantId, tenantId))\n        : heliumDb.select().from(backups);\n\n      const backupsList = await query\n        .orderBy(desc(backups.createdAt))\n        .limit(50);\n\n      const sanitized = backupsList.map((b) => ({\n        ...b,\n        backupData: undefined,\n      }));\n\n      return sanitized;\n    } catch (error: any) {\n      console.error(` [Backup] List failed:`, error);\n      throw new Error(`Failed to list backups: ${error.message}`);\n    }\n  }\n\n  async deleteBackup(backupId: string, tenantId?: string) {\n    try {\n      const conditions = tenantId\n        ? and(eq(backups.id, backupId), eq(backups.tenantId, tenantId))\n        : eq(backups.id, backupId);\n\n      const deleted = await heliumDb\n        .delete(backups)\n        .where(conditions!)\n        .returning();\n\n      if (deleted.length === 0) {\n        throw new Error('Backup not found or access denied');\n      }\n\n      console.log(` [Backup] Deleted backup ${backupId}`);\n      return { success: true };\n    } catch (error: any) {\n      console.error(` [Backup] Delete failed:`, error);\n      throw new Error(`Failed to delete backup: ${error.message}`);\n    }\n  }\n\n  async cleanupExpiredBackups() {\n    try {\n      const now = new Date();\n      const deleted = await heliumDb\n        .delete(backups)\n        .where(sql`${backups.expiresAt} < ${now}`)\n        .returning();\n\n      console.log(` [Backup] Cleaned up ${deleted.length} expired backups`);\n      return { deleted: deleted.length };\n    } catch (error: any) {\n      console.error(` [Backup] Cleanup failed:`, error);\n      throw new Error(`Cleanup failed: ${error.message}`);\n    }\n  }\n\n  async logAudit(data: {\n    tenantId: string | null;\n    userId: string | null;\n    action: string;\n    resourceType: string;\n    resourceId: string;\n    changes?: any;\n    ipAddress?: string;\n    userAgent?: string;\n  }) {\n    try {\n      await heliumDb.insert(auditLogs).values({\n        tenantId: data.tenantId,\n        userId: data.userId,\n        action: data.action,\n        resourceType: data.resourceType,\n        resourceId: data.resourceId,\n        changes: data.changes || null,\n        ipAddress: data.ipAddress || null,\n        userAgent: data.userAgent || null,\n      });\n    } catch (error) {\n      console.error('[Audit] Failed to log:', error);\n    }\n  }\n}\n\nexport const backupService = new BackupService();\n","size_bytes":10871},"server/middleware/permissions.ts":{"content":"import { Request, Response, NextFunction } from 'express';\nimport { permissionService, Resource, Action } from '../services/permission-service';\n\nexport interface PermissionRequest extends Request {\n  userId?: string;\n  tenantId?: string;\n  user?: any;\n}\n\nexport function requirePermission(resource: Resource, action: Action, options?: { \n  loadOwnership?: boolean;\n  resourceIdParam?: string;\n}) {\n  return async (req: PermissionRequest, res: Response, next: NextFunction) => {\n    try {\n      const userId = req.userId;\n      const tenantId = req.tenantId;\n\n      if (!userId) {\n        return res.status(401).json({ \n          error: 'Authentifizierung erforderlich',\n          message: 'Sie mssen angemeldet sein, um auf diese Ressource zuzugreifen.'\n        });\n      }\n\n      let resourceOwnerId: string | undefined = undefined;\n\n      if (action !== 'create') {\n        const resourceIdParam = options?.resourceIdParam || 'id';\n        const resourceId = req.params[resourceIdParam];\n        \n        if (resourceId) {\n          const { db } = await import('../db');\n\n          if (resource === 'projects') {\n            const { projects } = await import('../../shared/schema');\n            const { eq } = await import('drizzle-orm');\n            const [project] = await db.select().from(projects).where(eq(projects.id, resourceId)).limit(1);\n            resourceOwnerId = project?.userId;\n          } else if (resource === 'products') {\n            const { productsInProjects } = await import('../../shared/schema');\n            const { projects } = await import('../../shared/schema');\n            const { eq } = await import('drizzle-orm');\n            const [product] = await db.select().from(productsInProjects).where(eq(productsInProjects.id, resourceId)).limit(1);\n            if (product?.projectId) {\n              const [project] = await db.select().from(projects).where(eq(projects.id, product.projectId)).limit(1);\n              resourceOwnerId = project?.userId;\n            }\n          } else if (resource === 'suppliers') {\n            const { suppliers } = await import('../../shared/schema');\n            const { eq } = await import('drizzle-orm');\n            const [supplier] = await db.select().from(suppliers).where(eq(suppliers.id, resourceId)).limit(1);\n            resourceOwnerId = supplier?.userId;\n          }\n        }\n      }\n\n      const hasPermission = await permissionService.hasPermission({\n        userId,\n        resource,\n        action,\n        resourceOwnerId,\n        tenantId,\n      });\n\n      if (!hasPermission) {\n        return res.status(403).json({ \n          error: 'Zugriff verweigert',\n          message: `Sie haben keine Berechtigung fr '${action}' auf '${resource}'.`,\n          required: { resource, action }\n        });\n      }\n\n      next();\n    } catch (error: any) {\n      console.error('[Permission Middleware] Error:', error);\n      return res.status(500).json({ \n        error: 'Interner Serverfehler',\n        message: 'Berechtigungsprfung fehlgeschlagen.'\n      });\n    }\n  };\n}\n\nexport function requireAnyPermission(checks: Array<{ resource: Resource; action: Action }>) {\n  return async (req: PermissionRequest, res: Response, next: NextFunction) => {\n    try {\n      const userId = req.userId;\n      const tenantId = req.tenantId;\n\n      if (!userId) {\n        return res.status(401).json({ \n          error: 'Authentifizierung erforderlich'\n        });\n      }\n\n      for (const check of checks) {\n        const hasPermission = await permissionService.hasPermission({\n          userId,\n          resource: check.resource,\n          action: check.action,\n          tenantId,\n        });\n\n        if (hasPermission) {\n          next();\n          return;\n        }\n      }\n\n      return res.status(403).json({ \n        error: 'Zugriff verweigert',\n        message: 'Sie haben keine der erforderlichen Berechtigungen.',\n        required: checks\n      });\n    } catch (error: any) {\n      console.error('[Permission Middleware] Error:', error);\n      return res.status(500).json({ \n        error: 'Interner Serverfehler'\n      });\n    }\n  };\n}\n\nexport function requireRole(allowedRoles: string[]) {\n  return async (req: PermissionRequest, res: Response, next: NextFunction) => {\n    try {\n      const user = req.user;\n\n      if (!user) {\n        return res.status(401).json({ \n          error: 'Authentifizierung erforderlich'\n        });\n      }\n\n      if (user.isAdmin) {\n        next();\n        return;\n      }\n\n      const userRole = user.role || 'member';\n\n      if (allowedRoles.includes(userRole)) {\n        next();\n        return;\n      }\n\n      return res.status(403).json({ \n        error: 'Zugriff verweigert',\n        message: `Ihre Rolle '${userRole}' hat keinen Zugriff. Erforderlich: ${allowedRoles.join(', ')}`,\n        required: { roles: allowedRoles },\n        current: { role: userRole }\n      });\n    } catch (error: any) {\n      console.error('[Role Middleware] Error:', error);\n      return res.status(500).json({ \n        error: 'Interner Serverfehler'\n      });\n    }\n  };\n}\n","size_bytes":5071},"client/src/components/admin-audit-log-viewer.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { FileText, Filter, Clock, User, Database } from 'lucide-react';\nimport { useState } from 'react';\nimport { format } from 'date-fns';\nimport { de } from 'date-fns/locale';\n\ninterface AuditLog {\n  id: string;\n  userId: string;\n  action: string;\n  resourceType: string;\n  resourceId: string | null;\n  changes: any;\n  ipAddress: string | null;\n  userAgent: string | null;\n  createdAt: string;\n  userEmail?: string;\n}\n\nexport function AdminAuditLogViewer() {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [actionFilter, setActionFilter] = useState<string>('all');\n  const [resourceFilter, setResourceFilter] = useState<string>('all');\n\n  const { data: auditLogs, isLoading } = useQuery<{ success: boolean; logs: AuditLog[] }>({\n    queryKey: ['admin-audit-logs'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/audit-logs', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        throw new Error('Failed to load audit logs');\n      }\n      return res.json();\n    },\n  });\n\n  const formatDate = (dateString: string) => {\n    return format(new Date(dateString), 'dd.MM.yyyy HH:mm:ss', { locale: de });\n  };\n\n  const getActionBadgeVariant = (action: string) => {\n    switch (action) {\n      case 'create':\n      case 'backup_create':\n        return 'default';\n      case 'update':\n        return 'secondary';\n      case 'delete':\n      case 'backup_delete':\n        return 'destructive';\n      case 'restore':\n      case 'backup_restore':\n        return 'outline';\n      default:\n        return 'outline';\n    }\n  };\n\n  const filteredLogs = auditLogs?.logs.filter(log => {\n    const matchesSearch = \n      searchQuery === '' ||\n      log.userEmail?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      log.action.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      log.resourceType.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    const matchesAction = actionFilter === 'all' || log.action === actionFilter;\n    const matchesResource = resourceFilter === 'all' || log.resourceType === resourceFilter;\n    \n    return matchesSearch && matchesAction && matchesResource;\n  }) || [];\n\n  const uniqueActions = [...new Set(auditLogs?.logs.map(log => log.action) || [])];\n  const uniqueResources = [...new Set(auditLogs?.logs.map(log => log.resourceType) || [])];\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-2xl font-bold flex items-center gap-2\">\n          <FileText className=\"h-6 w-6\" />\n          Audit-Log-Viewer\n        </h2>\n        <p className=\"text-muted-foreground mt-1\">\n          berwachen Sie alle CRUD-Operationen im System\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Filter & Suche</CardTitle>\n          <CardDescription>\n            Durchsuchen und filtern Sie Audit-Logs\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <User className=\"h-4 w-4\" />\n                Suche\n              </label>\n              <Input\n                placeholder=\"Benutzer, Aktion, Ressource...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <Filter className=\"h-4 w-4\" />\n                Aktion\n              </label>\n              <Select value={actionFilter} onValueChange={setActionFilter}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Alle Aktionen</SelectItem>\n                  {uniqueActions.map(action => (\n                    <SelectItem key={action} value={action}>\n                      {action}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <Database className=\"h-4 w-4\" />\n                Ressource\n              </label>\n              <Select value={resourceFilter} onValueChange={setResourceFilter}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Alle Ressourcen</SelectItem>\n                  {uniqueResources.map(resource => (\n                    <SelectItem key={resource} value={resource}>\n                      {resource}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Audit-Logs ({filteredLogs.length})</CardTitle>\n          <CardDescription>\n            Chronologische bersicht aller Systemnderungen\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Lade Audit-Logs...\n            </div>\n          ) : filteredLogs.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Keine Audit-Logs gefunden\n            </div>\n          ) : (\n            <ScrollArea className=\"h-[600px]\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Zeitpunkt</TableHead>\n                    <TableHead>Benutzer</TableHead>\n                    <TableHead>Aktion</TableHead>\n                    <TableHead>Ressource</TableHead>\n                    <TableHead>Ressource-ID</TableHead>\n                    <TableHead>IP-Adresse</TableHead>\n                    <TableHead>nderungen</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredLogs.map((log) => (\n                    <TableRow key={log.id}>\n                      <TableCell className=\"font-medium whitespace-nowrap\">\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                          {formatDate(log.createdAt)}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {log.userEmail || 'System'}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={getActionBadgeVariant(log.action)}>\n                          {log.action}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">\n                          {log.resourceType}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"font-mono text-xs\">\n                        {log.resourceId ? log.resourceId.substring(0, 8) + '...' : '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {log.ipAddress || '-'}\n                      </TableCell>\n                      <TableCell>\n                        {log.changes ? (\n                          <details className=\"cursor-pointer\">\n                            <summary className=\"text-sm text-blue-600 hover:underline\">\n                              Details anzeigen\n                            </summary>\n                            <pre className=\"mt-2 text-xs bg-muted p-2 rounded overflow-auto max-w-sm\">\n                              {JSON.stringify(log.changes, null, 2)}\n                            </pre>\n                          </details>\n                        ) : (\n                          <span className=\"text-muted-foreground text-sm\">-</span>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </ScrollArea>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Statistiken</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-muted-foreground\">Gesamt</p>\n              <p className=\"text-2xl font-bold\">{auditLogs?.logs.length || 0}</p>\n            </div>\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-muted-foreground\">Heute</p>\n              <p className=\"text-2xl font-bold\">\n                {auditLogs?.logs.filter(log => \n                  new Date(log.createdAt).toDateString() === new Date().toDateString()\n                ).length || 0}\n              </p>\n            </div>\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-muted-foreground\">Create</p>\n              <p className=\"text-2xl font-bold text-green-600\">\n                {auditLogs?.logs.filter(log => log.action.includes('create')).length || 0}\n              </p>\n            </div>\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-muted-foreground\">Delete</p>\n              <p className=\"text-2xl font-bold text-red-600\">\n                {auditLogs?.logs.filter(log => log.action.includes('delete')).length || 0}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":10484},"server/services/mapping-service.ts":{"content":"import { promises as fs } from 'fs';\nimport path from 'path';\n\ninterface MappingRules {\n  version: string;\n  description: string;\n  source: string;\n  target: string;\n  mapping: Record<string, string[]>;\n  mappingPriority: Record<string, string[]>;\n  fixedValues: Record<string, string>;\n  autoGenerate: Record<string, {\n    dependsOn: string;\n    rule: string;\n    fallback?: string;\n  }>;\n  transformations: Record<string, {\n    type: string;\n    from: string;\n    to: string;\n    formula: string;\n  }>;\n  validation: {\n    required: string[];\n    dataTypes: Record<string, string>;\n    ranges: Record<string, { min: number; max: number }>;\n  };\n  outputFormat: {\n    type: string;\n    delimiter: string;\n    encoding: string;\n    includeHeader: boolean;\n    columns: string[];\n  };\n}\n\ninterface MappingResult {\n  success: boolean;\n  data?: Record<string, string>[];\n  csv?: string;\n  errors?: string[];\n  warnings?: string[];\n  stats?: {\n    totalRows: number;\n    validRows: number;\n    invalidRows: number;\n    missingFields: string[];\n  };\n}\n\nexport class MappingService {\n  private rules: MappingRules | null = null;\n  private rulesPath = path.join(process.cwd(), 'mappingRules.json');\n\n  async loadRules(): Promise<void> {\n    try {\n      const content = await fs.readFile(this.rulesPath, 'utf-8');\n      this.rules = JSON.parse(content);\n      console.log('[MappingService] Mapping rules loaded successfully');\n    } catch (error) {\n      console.error('[MappingService] Failed to load mapping rules:', error);\n      throw new Error('Failed to load mapping rules');\n    }\n  }\n\n  async applyMapping(sourceData: Record<string, any>[]): Promise<MappingResult> {\n    if (!this.rules) {\n      await this.loadRules();\n    }\n\n    if (!this.rules) {\n      return {\n        success: false,\n        errors: ['Mapping rules not loaded']\n      };\n    }\n\n    const errors: string[] = [];\n    const warnings: string[] = [];\n    const mappedData: Record<string, string>[] = [];\n    let validRows = 0;\n    let invalidRows = 0;\n\n    for (let i = 0; i < sourceData.length; i++) {\n      const row = sourceData[i];\n      const rowErrors: string[] = [];\n\n      try {\n        const mappedRow = await this.mapSingleRow(row, rowErrors, warnings);\n        \n        if (rowErrors.length > 0) {\n          invalidRows++;\n          errors.push(`Row ${i + 1}: ${rowErrors.join(', ')}`);\n        } else {\n          validRows++;\n          mappedData.push(mappedRow);\n        }\n      } catch (error) {\n        invalidRows++;\n        const errorMsg = error instanceof Error ? error.message : String(error);\n        errors.push(`Row ${i + 1}: ${errorMsg}`);\n      }\n    }\n\n    const csv = this.generateCSV(mappedData);\n\n    return {\n      success: validRows > 0,\n      data: mappedData,\n      csv,\n      errors: errors.length > 0 ? errors : undefined,\n      warnings: warnings.length > 0 ? warnings : undefined,\n      stats: {\n        totalRows: sourceData.length,\n        validRows,\n        invalidRows,\n        missingFields: this.getMissingRequiredFields(mappedData)\n      }\n    };\n  }\n\n  private async mapSingleRow(\n    sourceRow: Record<string, any>,\n    errors: string[],\n    warnings: string[]\n  ): Promise<Record<string, string>> {\n    const result: Record<string, string> = {};\n\n    if (!this.rules) throw new Error('Rules not loaded');\n\n    for (const column of this.rules.outputFormat.columns) {\n      result[column] = '';\n    }\n\n    const pendingMappings: Record<string, Array<{ sourceField: string; value: string; priority: number }>> = {};\n\n    for (const [sourceField, targetFields] of Object.entries(this.rules.mapping)) {\n      const sourceValue = sourceRow[sourceField];\n\n      if (sourceValue === undefined || sourceValue === null || sourceValue === '') {\n        continue;\n      }\n\n      for (const targetField of targetFields) {\n        if (!pendingMappings[targetField]) {\n          pendingMappings[targetField] = [];\n        }\n\n        let priority = 999;\n        if (this.rules.mappingPriority[targetField]) {\n          const priorityFields = this.rules.mappingPriority[targetField];\n          const priorityIndex = priorityFields.indexOf(sourceField);\n          if (priorityIndex !== -1) {\n            priority = priorityIndex;\n          }\n        }\n\n        pendingMappings[targetField].push({\n          sourceField,\n          value: String(sourceValue),\n          priority,\n        });\n      }\n    }\n\n    for (const [targetField, candidates] of Object.entries(pendingMappings)) {\n      candidates.sort((a, b) => a.priority - b.priority);\n      result[targetField] = candidates[0].value;\n    }\n\n    for (const [field, value] of Object.entries(this.rules.fixedValues)) {\n      result[field] = value;\n    }\n\n    for (const [field, config] of Object.entries(this.rules.autoGenerate)) {\n      const dependsOnValue = sourceRow[config.dependsOn];\n      \n      if (dependsOnValue !== undefined && dependsOnValue !== null && dependsOnValue !== '') {\n        const generatedValue = config.rule.replace(\n          `{{${config.dependsOn}}}`,\n          String(dependsOnValue)\n        );\n        result[field] = generatedValue;\n      } else if (config.fallback) {\n        result[field] = config.fallback;\n        warnings.push(`Field ${field}: Using fallback value (${config.dependsOn} is missing)`);\n      }\n    }\n\n    for (const [field, transformation] of Object.entries(this.rules.transformations)) {\n      if (result[field] && result[field] !== '') {\n        try {\n          const value = parseFloat(result[field]);\n          if (!isNaN(value)) {\n            const transformed = this.applyTransformation(value, transformation.formula);\n            if (transformed !== null) {\n              result[field] = String(transformed);\n            } else {\n              warnings.push(`Unsupported transformation formula for ${field}: ${transformation.formula}`);\n            }\n          }\n        } catch (error) {\n          warnings.push(`Failed to transform ${field}: ${error}`);\n        }\n      }\n    }\n\n    const validationErrors = this.validateRow(result);\n    if (validationErrors.length > 0) {\n      errors.push(...validationErrors);\n    }\n\n    return result;\n  }\n\n  private applyTransformation(value: number, formula: string): number | null {\n    const match = formula.match(/value\\s*([+\\-*/])\\s*([\\d.]+)/);\n    if (!match) {\n      return null;\n    }\n\n    const operator = match[1];\n    const operand = parseFloat(match[2]);\n\n    if (isNaN(operand)) {\n      return null;\n    }\n\n    switch (operator) {\n      case '+':\n        return value + operand;\n      case '-':\n        return value - operand;\n      case '*':\n        return value * operand;\n      case '/':\n        return operand !== 0 ? value / operand : null;\n      default:\n        return null;\n    }\n  }\n\n  private validateRow(row: Record<string, string>): string[] {\n    const errors: string[] = [];\n\n    if (!this.rules) return errors;\n\n    for (const requiredField of this.rules.validation.required) {\n      if (!row[requiredField] || row[requiredField] === '') {\n        errors.push(`Required field missing: ${requiredField}`);\n      }\n    }\n\n    for (const [field, dataType] of Object.entries(this.rules.validation.dataTypes)) {\n      const value = row[field];\n      if (value && value !== '') {\n        if (dataType === 'number') {\n          const numValue = parseFloat(value);\n          if (isNaN(numValue)) {\n            errors.push(`Field ${field} must be a number, got: ${value}`);\n          }\n        }\n      }\n    }\n\n    for (const [field, range] of Object.entries(this.rules.validation.ranges)) {\n      const value = row[field];\n      if (value && value !== '') {\n        const numValue = parseFloat(value);\n        if (!isNaN(numValue)) {\n          if (numValue < range.min || numValue > range.max) {\n            errors.push(\n              `Field ${field} out of range: ${numValue} (expected ${range.min}-${range.max})`\n            );\n          }\n        }\n      }\n    }\n\n    return errors;\n  }\n\n  private getMissingRequiredFields(data: Record<string, string>[]): string[] {\n    if (!this.rules || data.length === 0) return [];\n\n    const missingFields = new Set<string>();\n\n    for (const row of data) {\n      for (const requiredField of this.rules.validation.required) {\n        if (!row[requiredField] || row[requiredField] === '') {\n          missingFields.add(requiredField);\n        }\n      }\n    }\n\n    return Array.from(missingFields);\n  }\n\n  private generateCSV(data: Record<string, string>[]): string {\n    if (!this.rules || data.length === 0) return '';\n\n    const delimiter = this.rules.outputFormat.delimiter;\n    const columns = this.rules.outputFormat.columns;\n    const lines: string[] = [];\n\n    if (this.rules.outputFormat.includeHeader) {\n      lines.push(columns.join(delimiter));\n    }\n\n    for (const row of data) {\n      const values = columns.map(col => {\n        const value = row[col] || '';\n        if (value.includes(delimiter) || value.includes('\"') || value.includes('\\n')) {\n          return `\"${value.replace(/\"/g, '\"\"')}\"`;\n        }\n        return value;\n      });\n      lines.push(values.join(delimiter));\n    }\n\n    return lines.join('\\n');\n  }\n\n  async exportToFile(csv: string, filename: string): Promise<string> {\n    const outputDir = path.join(process.cwd(), 'exports');\n    \n    try {\n      await fs.mkdir(outputDir, { recursive: true });\n    } catch (error) {\n      console.error('[MappingService] Failed to create output directory:', error);\n    }\n\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);\n    const outputPath = path.join(outputDir, `${filename}_${timestamp}.csv`);\n\n    await fs.writeFile(outputPath, csv, 'utf-8');\n    console.log(`[MappingService] CSV exported to: ${outputPath}`);\n\n    return outputPath;\n  }\n}\n\nexport const mappingService = new MappingService();\n","size_bytes":9819},"client/src/pages/admin-permissions.tsx":{"content":"import { AdminPermissionManagement } from '@/components/admin-permission-management';\nimport { Button } from '@/components/ui/button';\nimport { ArrowLeft } from 'lucide-react';\nimport { Link } from 'wouter';\n\nexport default function AdminPermissions() {\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-7xl\">\n      <div className=\"mb-6\">\n        <Link href=\"/admin/dashboard\">\n          <Button variant=\"ghost\" className=\"gap-2\">\n            <ArrowLeft className=\"h-4 w-4\" />\n            Zurck zum Admin-Dashboard\n          </Button>\n        </Link>\n      </div>\n      <AdminPermissionManagement />\n    </div>\n  );\n}\n","size_bytes":635},"client/src/pages/admin-audit-logs.tsx":{"content":"import { AdminAuditLogViewer } from '@/components/admin-audit-log-viewer';\nimport { Button } from '@/components/ui/button';\nimport { ArrowLeft } from 'lucide-react';\nimport { Link } from 'wouter';\n\nexport default function AdminAuditLogs() {\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-7xl\">\n      <div className=\"mb-6\">\n        <Link href=\"/admin/dashboard\">\n          <Button variant=\"ghost\" className=\"gap-2\">\n            <ArrowLeft className=\"h-4 w-4\" />\n            Zurck zum Admin-Dashboard\n          </Button>\n        </Link>\n      </div>\n      <AdminAuditLogViewer />\n    </div>\n  );\n}\n","size_bytes":616},"server/services/encryption-service.ts":{"content":"import crypto from 'crypto';\n\nconst ALGORITHM = 'aes-256-gcm';\nconst IV_LENGTH = 16;\nconst TAG_LENGTH = 16;\nconst SALT_LENGTH = 64;\nconst KEY_LENGTH = 32;\n\nclass EncryptionService {\n  private masterKey: Buffer | null = null;\n\n  private getEncryptionKey(): Buffer {\n    if (this.masterKey) {\n      return this.masterKey;\n    }\n\n    const key = process.env.ENCRYPTION_KEY;\n    \n    if (!key) {\n      throw new Error('ENCRYPTION_KEY environment variable not set');\n    }\n\n    if (key.length < 32) {\n      throw new Error('ENCRYPTION_KEY must be at least 32 characters long');\n    }\n\n    this.masterKey = crypto.createHash('sha256').update(key).digest();\n    return this.masterKey;\n  }\n\n  encrypt(plaintext: string | null | undefined): string | null {\n    if (plaintext === null || plaintext === undefined || plaintext === '') {\n      return null;\n    }\n\n    try {\n      const key = this.getEncryptionKey();\n      const iv = crypto.randomBytes(IV_LENGTH);\n      const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n      \n      let encrypted = cipher.update(plaintext, 'utf8', 'hex');\n      encrypted += cipher.final('hex');\n      \n      const tag = cipher.getAuthTag();\n      \n      const result = Buffer.concat([\n        iv,\n        tag,\n        Buffer.from(encrypted, 'hex')\n      ]);\n\n      return result.toString('base64');\n    } catch (error) {\n      console.error('[Encryption] Error encrypting data:', error);\n      throw new Error('Encryption failed');\n    }\n  }\n\n  decrypt(ciphertext: string | null | undefined): string | null {\n    if (ciphertext === null || ciphertext === undefined || ciphertext === '') {\n      return null;\n    }\n\n    try {\n      const key = this.getEncryptionKey();\n      const buffer = Buffer.from(ciphertext, 'base64');\n      \n      const iv = buffer.subarray(0, IV_LENGTH);\n      const tag = buffer.subarray(IV_LENGTH, IV_LENGTH + TAG_LENGTH);\n      const encrypted = buffer.subarray(IV_LENGTH + TAG_LENGTH);\n      \n      const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n      decipher.setAuthTag(tag);\n      \n      let decrypted = decipher.update(encrypted);\n      decrypted = Buffer.concat([decrypted, decipher.final()]);\n      \n      return decrypted.toString('utf8');\n    } catch (error) {\n      console.error('[Encryption] Decryption failed - possible tampering or wrong key:', error);\n      throw new Error('Decryption failed - data may be tampered or encryption key is wrong');\n    }\n  }\n\n  encryptObject<T extends Record<string, any>>(\n    obj: T,\n    fields: (keyof T)[]\n  ): T {\n    const result = { ...obj };\n    \n    for (const field of fields) {\n      const value = obj[field];\n      if (typeof value === 'string') {\n        result[field] = this.encrypt(value) as any;\n      }\n    }\n    \n    return result;\n  }\n\n  decryptObject<T extends Record<string, any>>(\n    obj: T,\n    fields: (keyof T)[]\n  ): T {\n    const result = { ...obj };\n    \n    for (const field of fields) {\n      const value = obj[field];\n      if (typeof value === 'string') {\n        result[field] = this.decrypt(value) as any;\n      }\n    }\n    \n    return result;\n  }\n\n  hashPassword(password: string): string {\n    const salt = crypto.randomBytes(SALT_LENGTH);\n    const hash = crypto.pbkdf2Sync(password, salt, 100000, KEY_LENGTH, 'sha512');\n    \n    return Buffer.concat([salt, hash]).toString('base64');\n  }\n\n  verifyPassword(password: string, hashedPassword: string): boolean {\n    try {\n      const buffer = Buffer.from(hashedPassword, 'base64');\n      const salt = buffer.subarray(0, SALT_LENGTH);\n      const originalHash = buffer.subarray(SALT_LENGTH);\n      \n      const hash = crypto.pbkdf2Sync(password, salt, 100000, KEY_LENGTH, 'sha512');\n      \n      return crypto.timingSafeEqual(hash, originalHash);\n    } catch (error) {\n      console.error('[Encryption] Error verifying password:', error);\n      return false;\n    }\n  }\n}\n\nexport const encryptionService = new EncryptionService();\n","size_bytes":3934},"client/src/components/admin-permission-management.tsx":{"content":"import { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport { Label } from '@/components/ui/label';\nimport { Shield, Users, Crown, Eye, Pencil, UserCog } from 'lucide-react';\nimport { useState } from 'react';\nimport { useToast } from '@/hooks/use-toast';\nimport { queryClient } from '@/lib/queryClient';\n\ninterface User {\n  id: string;\n  email: string;\n  username: string | null;\n  role: string;\n  tenantId: string | null;\n  createdAt: string;\n}\n\ninterface Permission {\n  id: string;\n  userId: string;\n  resource: string;\n  action: string;\n  scope: string;\n  createdAt: string;\n}\n\nconst ROLES = [\n  { value: 'admin', label: 'Administrator', icon: Crown, color: 'text-yellow-500' },\n  { value: 'editor', label: 'Editor', icon: Pencil, color: 'text-blue-500' },\n  { value: 'viewer', label: 'Viewer', icon: Eye, color: 'text-gray-500' },\n  { value: 'project_manager', label: 'Project Manager', icon: UserCog, color: 'text-purple-500' },\n  { value: 'member', label: 'Member', icon: Users, color: 'text-green-500' },\n];\n\nconst RESOURCES = ['users', 'projects', 'products', 'suppliers', 'templates', 'backups'];\nconst ACTIONS = ['create', 'read', 'update', 'delete'];\nconst SCOPES = ['all', 'own', 'team', 'none'];\n\nexport function AdminPermissionManagement() {\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [isRoleDialogOpen, setIsRoleDialogOpen] = useState(false);\n  const [isPermissionDialogOpen, setIsPermissionDialogOpen] = useState(false);\n  const [newRole, setNewRole] = useState('');\n  const [newPermission, setNewPermission] = useState({\n    resource: 'projects',\n    action: 'read',\n    scope: 'own',\n  });\n  const { toast } = useToast();\n\n  const { data: users, isLoading: usersLoading } = useQuery<{ success: boolean; users: User[] }>({\n    queryKey: ['admin-users'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/users', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        throw new Error('Failed to load users');\n      }\n      return res.json();\n    },\n  });\n\n  const { data: permissions, isLoading: permissionsLoading } = useQuery<{ success: boolean; permissions: Permission[] }>({\n    queryKey: ['admin-permissions'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/permissions', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        throw new Error('Failed to load permissions');\n      }\n      return res.json();\n    },\n  });\n\n  const updateRoleMutation = useMutation({\n    mutationFn: async ({ userId, role }: { userId: string; role: string }) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/users/${userId}/role`, {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ role }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to update role');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Rolle aktualisiert',\n        description: 'Die Benutzerrolle wurde erfolgreich aktualisiert!',\n      });\n      setIsRoleDialogOpen(false);\n      setSelectedUser(null);\n      queryClient.invalidateQueries({ queryKey: ['admin-users'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const createPermissionMutation = useMutation({\n    mutationFn: async (permission: { userId: string; resource: string; action: string; scope: string }) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/permissions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify(permission),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to create permission');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Berechtigung erstellt',\n        description: 'Die Berechtigung wurde erfolgreich erstellt!',\n      });\n      setIsPermissionDialogOpen(false);\n      setSelectedUser(null);\n      queryClient.invalidateQueries({ queryKey: ['admin-permissions'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const deletePermissionMutation = useMutation({\n    mutationFn: async (permissionId: string) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/permissions/${permissionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to delete permission');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Berechtigung gelscht',\n        description: 'Die Berechtigung wurde erfolgreich gelscht!',\n      });\n      queryClient.invalidateQueries({ queryKey: ['admin-permissions'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const getRoleIcon = (role: string) => {\n    const roleData = ROLES.find(r => r.value === role);\n    if (!roleData) return Users;\n    const Icon = roleData.icon;\n    return <Icon className={`h-4 w-4 ${roleData.color}`} />;\n  };\n\n  const getRoleLabel = (role: string) => {\n    return ROLES.find(r => r.value === role)?.label || role;\n  };\n\n  const getScopeBadgeVariant = (scope: string) => {\n    switch (scope) {\n      case 'all': return 'default';\n      case 'own': return 'secondary';\n      case 'team': return 'outline';\n      default: return 'destructive';\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-2xl font-bold flex items-center gap-2\">\n          <Shield className=\"h-6 w-6\" />\n          Berechtigungsverwaltung\n        </h2>\n        <p className=\"text-muted-foreground mt-1\">\n          Verwalten Sie Benutzerrollen und granulare Berechtigungen\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Benutzer & Rollen</CardTitle>\n          <CardDescription>\n            Weisen Sie Benutzern Rollen zu oder erstellen Sie spezifische Berechtigungen\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {usersLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Lade Benutzer...\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Benutzer</TableHead>\n                  <TableHead>E-Mail</TableHead>\n                  <TableHead>Rolle</TableHead>\n                  <TableHead>Tenant</TableHead>\n                  <TableHead className=\"text-right\">Aktionen</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {users?.users.map((user) => (\n                  <TableRow key={user.id}>\n                    <TableCell className=\"font-medium\">\n                      <div className=\"flex items-center gap-2\">\n                        {getRoleIcon(user.role)}\n                        {user.username || 'Unbekannt'}\n                      </div>\n                    </TableCell>\n                    <TableCell>{user.email}</TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">\n                        {getRoleLabel(user.role)}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      {user.tenantId ? (\n                        <Badge variant=\"secondary\">Tenant-User</Badge>\n                      ) : (\n                        <Badge variant=\"outline\">Kein Tenant</Badge>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedUser(user);\n                            setNewRole(user.role);\n                            setIsRoleDialogOpen(true);\n                          }}\n                        >\n                          Rolle ndern\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedUser(user);\n                            setIsPermissionDialogOpen(true);\n                          }}\n                        >\n                          + Berechtigung\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Custom Permissions</CardTitle>\n          <CardDescription>\n            Granulare Berechtigungen die ber Standard-Rollen hinausgehen\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {permissionsLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Lade Berechtigungen...\n            </div>\n          ) : permissions?.permissions.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Keine Custom Permissions vorhanden\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Benutzer</TableHead>\n                  <TableHead>Ressource</TableHead>\n                  <TableHead>Aktion</TableHead>\n                  <TableHead>Scope</TableHead>\n                  <TableHead className=\"text-right\">Aktionen</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {permissions?.permissions.map((permission) => {\n                  const user = users?.users.find(u => u.id === permission.userId);\n                  return (\n                    <TableRow key={permission.id}>\n                      <TableCell className=\"font-medium\">\n                        {user?.username || user?.email || 'Unbekannt'}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{permission.resource}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge>{permission.action}</Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={getScopeBadgeVariant(permission.scope)}>\n                          {permission.scope}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => deletePermissionMutation.mutate(permission.id)}\n                        >\n                          Lschen\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  );\n                })}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isRoleDialogOpen} onOpenChange={setIsRoleDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Rolle ndern</DialogTitle>\n            <DialogDescription>\n              ndern Sie die Rolle fr {selectedUser?.username || selectedUser?.email}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Rolle</Label>\n              <Select value={newRole} onValueChange={setNewRole}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {ROLES.map(role => (\n                    <SelectItem key={role.value} value={role.value}>\n                      <div className=\"flex items-center gap-2\">\n                        <role.icon className={`h-4 w-4 ${role.color}`} />\n                        {role.label}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsRoleDialogOpen(false)}>\n              Abbrechen\n            </Button>\n            <Button\n              onClick={() => selectedUser && updateRoleMutation.mutate({\n                userId: selectedUser.id,\n                role: newRole,\n              })}\n              disabled={updateRoleMutation.isPending}\n            >\n              Speichern\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isPermissionDialogOpen} onOpenChange={setIsPermissionDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Berechtigung hinzufgen</DialogTitle>\n            <DialogDescription>\n              Erstellen Sie eine spezifische Berechtigung fr {selectedUser?.username || selectedUser?.email}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Ressource</Label>\n              <Select\n                value={newPermission.resource}\n                onValueChange={(value) => setNewPermission({ ...newPermission, resource: value })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {RESOURCES.map(resource => (\n                    <SelectItem key={resource} value={resource}>\n                      {resource}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Aktion</Label>\n              <Select\n                value={newPermission.action}\n                onValueChange={(value) => setNewPermission({ ...newPermission, action: value })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {ACTIONS.map(action => (\n                    <SelectItem key={action} value={action}>\n                      {action}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Scope</Label>\n              <Select\n                value={newPermission.scope}\n                onValueChange={(value) => setNewPermission({ ...newPermission, scope: value })}\n              >\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {SCOPES.map(scope => (\n                    <SelectItem key={scope} value={scope}>\n                      {scope}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsPermissionDialogOpen(false)}>\n              Abbrechen\n            </Button>\n            <Button\n              onClick={() => selectedUser && createPermissionMutation.mutate({\n                userId: selectedUser.id,\n                ...newPermission,\n              })}\n              disabled={createPermissionMutation.isPending}\n            >\n              Erstellen\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":17345},"client/src/pages/admin-backups.tsx":{"content":"import { AdminBackupManagement } from '@/components/admin-backup-management';\nimport { Button } from '@/components/ui/button';\nimport { ArrowLeft } from 'lucide-react';\nimport { Link } from 'wouter';\n\nexport default function AdminBackups() {\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-7xl\">\n      <div className=\"mb-6\">\n        <Link href=\"/admin/dashboard\">\n          <Button variant=\"ghost\" className=\"gap-2\">\n            <ArrowLeft className=\"h-4 w-4\" />\n            Zurck zum Admin-Dashboard\n          </Button>\n        </Link>\n      </div>\n      <AdminBackupManagement />\n    </div>\n  );\n}\n","size_bytes":619},"client/src/components/admin-backup-management.tsx":{"content":"import { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\nimport { Database, Download, Trash2, RefreshCcw, Clock, HardDrive } from 'lucide-react';\nimport { useState } from 'react';\nimport { useToast } from '@/hooks/use-toast';\nimport { queryClient } from '@/lib/queryClient';\nimport { format } from 'date-fns';\nimport { de } from 'date-fns/locale';\n\ninterface Backup {\n  id: string;\n  created_by: string;\n  created_at: string;\n  expires_at: string;\n  size_bytes: number;\n  description: string | null;\n  data: any;\n}\n\nexport function AdminBackupManagement() {\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isRestoreDialogOpen, setIsRestoreDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [selectedBackup, setSelectedBackup] = useState<Backup | null>(null);\n  const { toast } = useToast();\n\n  const { data: backups, isLoading } = useQuery<{ success: boolean; backups: Backup[] }>({\n    queryKey: ['admin-backups'],\n    queryFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/backups', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        throw new Error('Failed to load backups');\n      }\n      return res.json();\n    },\n  });\n\n  const createBackupMutation = useMutation({\n    mutationFn: async () => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch('/api/backups', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ description: 'Manual Backup' }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to create backup');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Backup erstellt',\n        description: 'Das Backup wurde erfolgreich erstellt!',\n      });\n      setIsCreateDialogOpen(false);\n      queryClient.invalidateQueries({ queryKey: ['admin-backups'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const restoreBackupMutation = useMutation({\n    mutationFn: async (backupId: string) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/backups/${backupId}/restore`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to restore backup');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Backup wiederhergestellt',\n        description: 'Die Daten wurden erfolgreich wiederhergestellt!',\n      });\n      setIsRestoreDialogOpen(false);\n      setSelectedBackup(null);\n      queryClient.invalidateQueries();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const deleteBackupMutation = useMutation({\n    mutationFn: async (backupId: string) => {\n      const token = localStorage.getItem('supabase_token');\n      const res = await fetch(`/api/backups/${backupId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || 'Failed to delete backup');\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Backup gelscht',\n        description: 'Das Backup wurde erfolgreich gelscht!',\n      });\n      setIsDeleteDialogOpen(false);\n      setSelectedBackup(null);\n      queryClient.invalidateQueries({ queryKey: ['admin-backups'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Fehler',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const formatBytes = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];\n  };\n\n  const formatDate = (dateString: string) => {\n    return format(new Date(dateString), 'dd.MM.yyyy HH:mm', { locale: de });\n  };\n\n  const isExpired = (expiresAt: string) => {\n    return new Date(expiresAt) < new Date();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold flex items-center gap-2\">\n            <Database className=\"h-6 w-6\" />\n            Backup-Management\n          </h2>\n          <p className=\"text-muted-foreground mt-1\">\n            Verwalten Sie System-Backups fr Datensicherheit und Wiederherstellung\n          </p>\n        </div>\n        <Button onClick={() => setIsCreateDialogOpen(true)}>\n          <HardDrive className=\"mr-2 h-4 w-4\" />\n          Backup erstellen\n        </Button>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Verfgbare Backups</CardTitle>\n          <CardDescription>\n            Point-in-Time Recovery fr Business-Daten (30 Tage Retention)\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Lade Backups...\n            </div>\n          ) : backups?.backups.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Keine Backups vorhanden\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Erstellt am</TableHead>\n                  <TableHead>Beschreibung</TableHead>\n                  <TableHead>Gre</TableHead>\n                  <TableHead>Luft ab</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead className=\"text-right\">Aktionen</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {backups?.backups.map((backup) => (\n                  <TableRow key={backup.id}>\n                    <TableCell className=\"font-medium\">\n                      <div className=\"flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                        {formatDate(backup.created_at)}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      {backup.description || 'Automatisches Backup'}\n                    </TableCell>\n                    <TableCell>{formatBytes(backup.size_bytes)}</TableCell>\n                    <TableCell>{formatDate(backup.expires_at)}</TableCell>\n                    <TableCell>\n                      {isExpired(backup.expires_at) ? (\n                        <Badge variant=\"destructive\">Abgelaufen</Badge>\n                      ) : (\n                        <Badge variant=\"success\" className=\"bg-green-500\">Aktiv</Badge>\n                      )}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedBackup(backup);\n                            setIsRestoreDialogOpen(true);\n                          }}\n                          disabled={isExpired(backup.expires_at)}\n                        >\n                          <Download className=\"h-4 w-4 mr-1\" />\n                          Wiederherstellen\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSelectedBackup(backup);\n                            setIsDeleteDialogOpen(true);\n                          }}\n                        >\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Neues Backup erstellen</DialogTitle>\n            <DialogDescription>\n              Erstellt ein vollstndiges Backup aller Geschftsdaten (Users, Projects, Products, Suppliers, Templates, Permissions).\n              Das Backup luft automatisch nach 30 Tagen ab.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n              Abbrechen\n            </Button>\n            <Button\n              onClick={() => createBackupMutation.mutate()}\n              disabled={createBackupMutation.isPending}\n            >\n              {createBackupMutation.isPending ? (\n                <>\n                  <RefreshCcw className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Wird erstellt...\n                </>\n              ) : (\n                <>\n                  <HardDrive className=\"mr-2 h-4 w-4\" />\n                  Backup erstellen\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={isRestoreDialogOpen} onOpenChange={setIsRestoreDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Backup wiederherstellen?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Diese Aktion stellt alle Daten aus dem Backup vom{' '}\n              <strong>{selectedBackup && formatDate(selectedBackup.created_at)}</strong> wieder her.\n              {' '}Aktuelle Daten werden berschrieben. Diese Aktion kann nicht rckgngig gemacht werden.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => setSelectedBackup(null)}>\n              Abbrechen\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedBackup && restoreBackupMutation.mutate(selectedBackup.id)}\n              className=\"bg-destructive hover:bg-destructive/90\"\n            >\n              Wiederherstellen\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Backup lschen?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Mchten Sie das Backup vom{' '}\n              <strong>{selectedBackup && formatDate(selectedBackup.created_at)}</strong> wirklich lschen?\n              {' '}Diese Aktion kann nicht rckgngig gemacht werden.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => setSelectedBackup(null)}>\n              Abbrechen\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedBackup && deleteBackupMutation.mutate(selectedBackup.id)}\n              className=\"bg-destructive hover:bg-destructive/90\"\n            >\n              Lschen\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":12841},"docs/pixi-integration.md":{"content":"# Pixi ERP Integration - Technische Dokumentation\n\n## bersicht\n\nDas PIMPilot-System integriert sich mit dem Pixi ERP-System von Akkutools, um automatisch zu erkennen, ob Produkte bereits im Pixi-Inventar vorhanden sind oder neu angelegt werden mssen. Die Integration nutzt einen intelligenten Multi-Strategie-Matching-Algorithmus fr maximale Trefferquote.\n\n---\n\n## 1. API-Konfiguration\n\n### 1.1 Pixi API Endpoint\n\n**URL:** `https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch`\n\n**Methode:** `POST`\n\n**Header:**\n```http\nX-AUTH-TOKEN: GKr7pTd-Fy6xJQb8r2nM4ks9tzdgvXNc2ZBLRw3qDPVhy_U8aaXr4LfNSweRKtqq\nContent-Type: application/json\n```\n\n**Request Body:**\n```json\n{\n  \"SupplNr\": \"7001\"\n}\n```\n\n**Response Format:**\n```json\n{\n  \"data\": [\n    {\n      \"ItemNrSuppl\": \"2447304960\",\n      \"EANUPC\": \"4013674035489\"\n    },\n    {\n      \"ItemNrSuppl\": \"82120\",\n      \"EANUPC\": \"4020634998623\"\n    }\n  ]\n}\n```\n\n### 1.2 Environment-Variablen\n\nDie API-Credentials werden ber Environment-Variablen konfiguriert:\n\n```bash\nPIXI_API_URL=https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch\nPIXI_AUTH_TOKEN=GKr7pTd-Fy6xJQb8r2nM4ks9tzdgvXNc2ZBLRw3qDPVhy_U8aaXr4LfNSweRKtqq\n```\n\n**Implementierung:** `server/services/pixi-service.ts`\n```typescript\nconstructor() {\n  this.apiUrl = process.env.PIXI_API_URL || 'https://akkutools.laptopakku.eu/api/pixi/pixiItemSearch';\n  this.authToken = process.env.PIXI_AUTH_TOKEN || '';\n}\n```\n\n---\n\n## 2. Lieferantennummer (SupplNr)\n\n### 2.1 Automatische Zuordnung\n\nDie SupplNr wird automatisch aus dem Lieferanten-Profil extrahiert, wenn ein Lieferant im UI ausgewhlt wird:\n\n**Frontend-Implementierung:**\n```typescript\n// client/src/pages/pixi-compare.tsx (Zeile 593-594)\nconst supplier = suppliers.find(s => s.id === value);\nsetSupplNr(supplier?.supplNr || '');\n```\n\n### 2.2 Lieferanten-Datenbank\n\nDie SupplNr wird in der `suppliers`-Tabelle gespeichert:\n\n**Schema:**\n```typescript\nsuppliers: {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\"),\n  supplNr: varchar(\"suppl_nr\"),  // Pixi-Lieferantennummer\n  organization_id: varchar(\"organization_id\")\n}\n```\n\n### 2.3 Bekannte SupplNr-Zuordnungen\n\n| SupplNr | Lieferant | Beschreibung |\n|---------|-----------|--------------|\n| `7001` | Diverse | Standard-Lieferant |\n| `7077` | Nitecore/KTL | Nitecore-Produkte |\n| `7117` | ANSMANN | ANSMANN-Akkus |\n\n---\n\n## 3. Multi-Strategie Matching-Algorithmus\n\n### 3.1 bersicht\n\nDas System verwendet drei Matching-Strategien in sequenzieller Reihenfolge. Bei der ersten erfolgreichen bereinstimmung wird das Produkt als \"VORHANDEN\" markiert.\n\n```\n\n                    Produkt aus CSV/PDF/URL                  \n  - Artikelnummer: \"ANS2447304960\"                           \n  - Hersteller-Artikelnr.: \"2447304960\"                      \n  - EAN: \"4013674035489\"                                     \n\n                       \n                       \n         \n           Strategie 1: Artikelnummer \n           (mit/ohne Prfix)          \n         \n                    \n         \n           Match gefunden?    \n         \n          JA               NEIN\n                          \n                          \n          VORHANDEN   \n                        Strategie 2: Hersteller-Nr.    \n                      \n                                 \n                      \n                        Match gefunden?    \n                      \n                       JA               NEIN\n                                       \n                                       \n                       VORHANDEN   \n                                     Strategie 3: EAN   \n                                   \n                                              \n                                   \n                                     Match gefunden?    \n                                   \n                                    JA               NEIN\n                                                    \n                                                    \n                                    VORHANDEN      NEU\n```\n\n### 3.2 Strategie 1: Artikelnummer (mit/ohne Prfix)\n\n**Zweck:** Matching ber die vollstndige Artikelnummer\n\n**Datenfelder:**\n- CSV: `Artikelnummer`, `p_item_number`, `SKU`\n- Pixi: `ItemNrSuppl`\n\n**Algorithmus:**\n\n**1a) Versuch mit voller Artikelnummer:**\n```typescript\n// Beispiel: \"ANS2447304960\"\nconst lookupKey = artikelnummer.toUpperCase();\npixiItem = pixiByItemNr.get(lookupKey);\n```\n\n**1b) Versuch ohne Prfix (automatisch):**\n```typescript\n// Beispiel: \"ANS2447304960\"  \"2447304960\"\nif (!isMatch && lookupKey.length > 3) {\n  const withoutPrefix = lookupKey.substring(3);\n  pixiItem = pixiByItemNr.get(withoutPrefix);\n}\n```\n\n**Beispiel:**\n```\nDein Produkt: \"ANS2447304960\"\nPixi ItemNrSuppl: \"2447304960\"\n\n1a) Match mit \"ANS2447304960\"   KEIN MATCH\n1b) Match mit \"2447304960\"   MATCH GEFUNDEN!\n```\n\n**Logging:**\n```log\n[Pixi Match]  Strategy 1b matched (without prefix): ANS2447304960 -> 2447304960\n```\n\n### 3.3 Strategie 2: Hersteller-Artikelnummer\n\n**Zweck:** Matching ber die Herstellernummer (ohne Lieferanten-Prfix)\n\n**Datenfelder:**\n- CSV: `ItemNrSuppl`, `manufacturers_item_number`, `Herstellerartikelnummer`\n- PDF: Automatisch extrahiert aus Produktbeschreibung\n- Pixi: `ItemNrSuppl`\n\n**Algorithmus:**\n```typescript\n// Beispiel: \"2447304960\"\nif (!isMatch && manufacturerItemNr) {\n  const lookupKey = manufacturerItemNr.toUpperCase();\n  pixiItem = pixiByItemNr.get(lookupKey);\n}\n```\n\n**Beispiel:**\n```\nDein Produkt: manufacturerItemNr = \"2447304960\"\nPixi ItemNrSuppl: \"2447304960\"\n\nMatch mit \"2447304960\"   MATCH GEFUNDEN!\n```\n\n**Logging:**\n```log\n[Pixi Match]  Strategy 2 matched: 2447304960 -> 2447304960\n```\n\n### 3.4 Strategie 3: EAN-Fallback\n\n**Zweck:** Matching ber EAN/GTIN/Barcode als letzte Option\n\n**Datenfelder:**\n- CSV: `EAN`, `GTIN`, `Barcode`, `UPC`, `p_ean`\n- Pixi: `EANUPC`\n\n**Algorithmus:**\n```typescript\n// Beispiel: \"4013674035489\"\nif (!isMatch && ean) {\n  pixiItem = pixiByEan.get(ean);\n}\n```\n\n**Beispiel:**\n```\nDein Produkt: EAN = \"4013674035489\"\nPixi EANUPC: \"4013674035489\"\n\nMatch mit \"4013674035489\"   MATCH GEFUNDEN!\n```\n\n**Logging:**\n```log\n[Pixi Match]  Strategy 3 matched: 4013674035489 -> 4013674035489\n```\n\n### 3.5 Kein Match gefunden\n\nWenn alle drei Strategien fehlschlagen:\n\n```typescript\nconst status: 'NEU' | 'VORHANDEN' = isMatch ? 'VORHANDEN' : 'NEU';\n```\n\n**Logging:**\n```log\n[Pixi Match]  No match found for: {\n  artikelnummer: \"ANS99999999\",\n  manufacturerItemNr: \"99999999\",\n  ean: \"0000000000000\",\n  produktname: \"Neues Produkt XYZ\"\n}\n```\n\n---\n\n## 4. Performance-Optimierungen\n\n### 4.1 Map-basierte Lookup (O(1) Komplexitt)\n\nAnstatt bei jedem Produkt durch das gesamte Pixi-Array zu iterieren, werden zwei Hash-Maps erstellt:\n\n```typescript\n// Create lookup maps for fast comparison\nconst pixiByItemNr = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\nconst pixiByEan = new Map<string, { ItemNrSuppl: string; EANUPC: string }>();\n\npixiItems.forEach(item => {\n  if (item.ItemNrSuppl) {\n    pixiByItemNr.set(item.ItemNrSuppl.toUpperCase(), item);\n  }\n  if (item.EANUPC) {\n    pixiByEan.set(item.EANUPC, item);\n  }\n});\n```\n\n**Vorteile:**\n- **O(1) Lookup** statt O(n) Iteration\n- **Case-Insensitive** durch `.toUpperCase()`\n- **Doppelte Indizierung** (ItemNr + EAN)\n\n### 4.2 Cache-System (5 Minuten TTL)\n\nAPI-Requests werden gecacht, um Pixi-API zu entlasten:\n\n```typescript\nprivate cache: Map<string, { data: PixiItemSearchResponse; timestamp: number }>;\nprivate cacheTTL: number = 5 * 60 * 1000; // 5 Minuten\n\n// Check cache first\nconst cached = this.cache.get(supplNr);\nif (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n  console.log(`[Pixi Service] Using cached data for supplier ${supplNr}`);\n  return cached.data;\n}\n```\n\n**Vorteile:**\n- Reduziert API-Calls bei mehrfachen Vergleichen\n- 5-Minuten-Fenster fr aktuelle Daten\n- Automatisches Cleanup bei Ablauf\n\n---\n\n## 5. Datenfluss\n\n### 5.1 CSV-Upload-Flow\n\n```\n\n  1. User whlt CSV   \n     + Lieferant      \n\n           \n           \n\n  2. Frontend: CSV  FormData             \n     supplNr aus Lieferanten-Profil       \n\n           \n           \n\n  3. Backend: POST /api/pixi/compare      \n     - Parse CSV (Papa Parse)             \n     - Fix EAN Scientific Notation        \n\n           \n           \n\n  4. Pixi Service: searchItems(supplNr)   \n     POST akkutools.laptopakku.eu/api/... \n     X-AUTH-TOKEN: ...                    \n\n           \n           \n\n  5. Build Maps (pixiByItemNr, pixiByEan) \n\n           \n           \n\n  6. For each CSV product:                \n     - Strategie 1: Artikelnummer         \n     - Strategie 2: Hersteller-Nr.        \n     - Strategie 3: EAN                   \n\n           \n           \n\n  7. Return ComparisonResult:             \n     {                                    \n       summary: { total, neu, vorhanden } \n       products: [...]                    \n     }                                    \n\n           \n           \n\n  8. Frontend: Display Results            \n     - Tabelle mit NEU/VORHANDEN-Status   \n     - CSV Export-Option                  \n\n```\n\n### 5.2 Projekt-basierter Flow\n\n```\n\n  1. User whlt       \n     Projekt +        \n     Lieferant        \n\n           \n           \n\n  2. Backend: GET /api/products           \n     Filter: projectId + organizationId   \n\n           \n           \n\n  3. Load supplNr from suppliers table    \n     (if supplierId provided)             \n\n           \n           \n\n  4. Same as CSV-Flow (Steps 4-8)         \n\n```\n\n---\n\n## 6. Backend-Implementierung\n\n### 6.1 API-Endpoints\n\n**Endpoint 1: CSV-Upload-Vergleich**\n```typescript\nPOST /api/pixi/compare\nHeaders: Authorization: Bearer <token>\nBody: FormData {\n  csvFile: File,\n  supplNr: \"7001\"\n}\n\nResponse: {\n  success: true,\n  summary: {\n    total: 36,\n    neu: 9,\n    vorhanden: 27\n  },\n  products: [\n    {\n      artikelnummer: \"ANS2447304960\",\n      manufacturerArticleNumber: \"2447304960\",\n      produktname: \"Lithium-Ionen Akkupack...\",\n      ean: \"4013674035489\",\n      hersteller: \"ANSMANN\",\n      pixi_status: \"VORHANDEN\",\n      pixi_ean: \"4013674035489\"\n    }\n  ]\n}\n```\n\n**Endpoint 2: Projekt-basierter Vergleich**\n```typescript\nPOST /api/pixi/compare-project\nHeaders: Authorization: Bearer <token>\nContent-Type: application/json\nBody: {\n  projectId: \"uuid\",\n  supplierId: \"uuid\"  // oder supplNr: \"7001\"\n}\n\nResponse: (gleich wie Endpoint 1)\n```\n\n### 6.2 Service-Architektur\n\n**Datei:** `server/services/pixi-service.ts`\n\n**Hauptmethoden:**\n\n```typescript\nclass PixiService {\n  // API-Request an Pixi\n  async searchItems(supplNr: string): Promise<PixiItemSearchResponse>\n  \n  // CSV-Vergleich\n  async compareProducts(products: CSVProduct[], supplNr: string): Promise<PixiComparisonSummary>\n  \n  // Projekt-Vergleich\n  async compareProductsFromSupabase(\n    projectId: string,\n    supabaseStorage: SupabaseStorage,\n    supplierIdOrSupplNr: string\n  ): Promise<PixiSupabaseComparisonSummary>\n  \n  // Flexible Spalten-Erkennung\n  private getColumnValue(product: any, possibleNames: string[]): string\n}\n```\n\n### 6.3 Spalten-Erkennung (Flexibles Mapping)\n\nDas System erkennt automatisch verschiedene Spaltennamen:\n\n```typescript\n// Artikelnummer\nconst artikelnummer = this.getColumnValue(product, [\n  'Artikelnummer', 'artikelnummer', 'ARTIKELNUMMER',\n  'Article Number', 'ArticleNumber', 'article_number',\n  'Item Number', 'ItemNumber', 'item_number',\n  'SKU', 'sku', 'Art.-Nr.', 'Art.Nr.',\n  'p_item_number'\n]);\n\n// Hersteller-Artikelnummer\nconst manufacturerItemNr = this.getColumnValue(product, [\n  'ItemNrSuppl', 'manufacturers_item_number',\n  'Herstellerartikelnummer', 'Hersteller-Artikelnummer'\n]);\n\n// EAN\nconst ean = this.getColumnValue(product, [\n  'EAN', 'ean', 'EAN-Code', 'EAN Code',\n  'GTIN', 'gtin', 'Barcode', 'barcode',\n  'UPC', 'upc', 'EAN/UPC',\n  'EANUPC', 'p_ean'\n]);\n\n// Produktname\nconst produktname = this.getColumnValue(product, [\n  'Produktname', 'produktname', 'PRODUKTNAME',\n  'Product Name', 'ProductName', 'product_name',\n  'Name', 'name', 'Bezeichnung', 'bezeichnung',\n  'Description', 'description',\n  'p_name[de]', 'p_name[en]', 'p_name'\n]);\n\n// Hersteller\nconst hersteller = this.getColumnValue(product, [\n  'Hersteller', 'hersteller', 'HERSTELLER',\n  'Manufacturer', 'manufacturer', 'Brand', 'brand',\n  'Marke', 'marke', 'Supplier', 'supplier',\n  'p_brand', 'v_brand'\n]);\n```\n\n**Vorteile:**\n- Untersttzt deutsche + englische Spaltennamen\n- Case-Insensitive\n- Priorittslogik (erste gefundene Spalte wird verwendet)\n- Untersttzt Brickfox-Export-Spalten\n\n---\n\n## 7. Frontend-Implementierung\n\n### 7.1 UI-Komponente\n\n**Datei:** `client/src/pages/pixi-compare.tsx`\n\n**Tabs:**\n1. **CSV-Upload**: Manueller CSV-Upload + Lieferant-Auswahl\n2. **Projekt-basiert**: Vergleich aus bestehendem Projekt\n\n**Features:**\n- Auto-Fill der SupplNr bei Lieferanten-Auswahl\n- Manuelle SupplNr-Eingabe als Alternative\n- Live-Status-Anzeige (Gesamt, Neu, Vorhanden)\n- Tabellen-Darstellung mit horizontalem Scrolling\n- CSV-Export der Ergebnisse\n\n### 7.2 Tabellen-Struktur\n\n```jsx\n<div className=\"rounded-md border overflow-hidden\">\n  <div className=\"max-h-96 overflow-y-auto overflow-x-auto\">\n    <Table>\n      <TableHeader className=\"sticky top-0 bg-background z-10\">\n        <TableRow>\n          <TableHead className=\"min-w-[100px]\">Status</TableHead>\n          <TableHead className=\"min-w-[180px]\">Artikelnummer</TableHead>\n          <TableHead className=\"min-w-[150px]\">Hersteller-Artikelnr.</TableHead>\n          <TableHead className=\"min-w-[300px]\">Produktname</TableHead>\n          <TableHead className=\"min-w-[150px]\">EAN</TableHead>\n          <TableHead className=\"min-w-[150px]\">Hersteller</TableHead>\n        </TableRow>\n      </TableHeader>\n      <TableBody>\n        {results.map((result) => (\n          <TableRow key={...}>\n            <TableCell>\n              {result.pixi_status === 'NEU' ? (\n                <Badge className=\"bg-green-500\">NEU</Badge>\n              ) : (\n                <Badge variant=\"outline\">VORHANDEN</Badge>\n              )}\n            </TableCell>\n            <TableCell>{result.artikelnummer}</TableCell>\n            <TableCell>{result.manufacturerArticleNumber || '-'}</TableCell>\n            ...\n          </TableRow>\n        ))}\n      </TableBody>\n    </Table>\n  </div>\n</div>\n```\n\n---\n\n## 8. Debugging & Logging\n\n### 8.1 Debug-Logs\n\nDas System erstellt detaillierte Console-Logs fr Debugging:\n\n**Produkterkennung:**\n```log\n[Pixi Service] CSV columns detected: [\"Artikelnummer\", \"Produktname\", \"EAN\", ...]\n[Pixi Service] Parsed 36 products from CSV\n```\n\n**API-Request:**\n```log\n[Pixi Service] Fetching items for supplier 7001\n[Pixi Service] Received 1247 items from Pixi API\n```\n\n**Matching-Details (erste 3 Produkte):**\n```log\n[Pixi Match Debug] First product: {\n  artikelnummer: \"ANS2447304960\",\n  manufacturerItemNr: \"2447304960\",\n  ean: \"4013674035489\",\n  produktname: \"Lithium-Ionen Akkupack...\"\n}\n\n[Pixi Match Debug] First 5 Pixi items: [\n  { ItemNrSuppl: \"2447304960\", EANUPC: \"4013674035489\" },\n  { ItemNrSuppl: \"82120\", EANUPC: \"4020634998623\" },\n  ...\n]\n\n[Pixi Match]  Strategy 1b matched (without prefix): ANS2447304960 -> 2447304960\n[Pixi Match]  Strategy 2 matched: 24470105 -> 24470105\n[Pixi Match]  No match found for: { artikelnummer: \"ANS99999\", ... }\n```\n\n**Zusammenfassung:**\n```log\n[Pixi Compare] Comparison complete: 36 total, 9 new, 27 existing\n```\n\n### 8.2 Error-Handling\n\n**API-Fehler:**\n```typescript\nif (!response.ok) {\n  throw new Error(`Pixi API error: ${response.status} ${response.statusText}`);\n}\n```\n\n**Timeout-Protection:**\n```typescript\nconst response = await fetch(this.apiUrl, {\n  signal: AbortSignal.timeout(30000), // 30 Sekunden\n});\n```\n\n**Validierung:**\n```typescript\nif (!supplNr) {\n  return res.status(400).json({ \n    success: false,\n    error: 'Supplier number (supplNr) is required' \n  });\n}\n```\n\n---\n\n## 9. CSV-Export\n\n### 9.1 Export-Format\n\nDer CSV-Export enthlt alle Vergleichsdaten:\n\n```csv\nStatus,Artikelnummer,Hersteller-Artikelnr.,Produktname,EAN,Hersteller,Pixi-EAN\nVORHANDEN,ANS2447304960,2447304960,Lithium-Ionen Akkupack 10,8 V/5200 mAh/3S2P,4013674035489,ANSMANN,4013674035489\nNEU,ANS99999999,99999999,Neues Produkt XYZ,0000000000000,ANSMANN,\n```\n\n### 9.2 Implementation\n\n```typescript\nconst handleCSVExport = () => {\n  const csvRows = [\n    ['Status', 'Artikelnummer', 'Hersteller-Artikelnr.', 'Produktname', 'EAN', 'Hersteller', 'Pixi-EAN']\n  ];\n  \n  result.products.forEach(product => {\n    csvRows.push([\n      product.pixi_status,\n      product.artikelnummer || '',\n      product.manufacturerArticleNumber || '',\n      product.produktname || '',\n      product.ean || '',\n      product.hersteller || '',\n      product.pixi_ean || ''\n    ]);\n  });\n  \n  const csvContent = csvRows.map(row => \n    row.map(cell => `\"${cell}\"`).join(',')\n  ).join('\\n');\n  \n  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n  const link = document.createElement('a');\n  link.href = URL.createObjectURL(blob);\n  link.download = `pixi-vergleich-${new Date().toISOString().split('T')[0]}.csv`;\n  link.click();\n};\n```\n\n---\n\n## 10. Troubleshooting\n\n### Problem 1: Keine Matches trotz vorhandener Produkte\n\n**Ursachen:**\n- Falsche SupplNr\n- Prfix-Mismatch (z.B. \"ANSI\" statt \"ANS\")\n- EAN-Format-Fehler (Scientific Notation)\n\n**Lsung:**\n1. Console-Logs prfen: `[Pixi Match Debug] First product: {...}`\n2. SupplNr validieren: `suppliers` Tabelle prfen\n3. CSV-Spalten prfen: `[Pixi Service] CSV columns detected: [...]`\n\n### Problem 2: API-Timeout\n\n**Ursache:** Pixi API antwortet nicht innerhalb von 30 Sekunden\n\n**Lsung:**\n```typescript\n// Timeout erhhen in pixi-service.ts\nsignal: AbortSignal.timeout(60000), // 60 Sekunden\n```\n\n### Problem 3: Cache-Probleme\n\n**Symptom:** Alte Daten werden angezeigt\n\n**Lsung:**\n```typescript\n// Cache manuell leeren\nthis.cache.clear();\n```\n\n### Problem 4: EAN in Scientific Notation\n\n**Symptom:** EAN wird als \"4,01E+12\" dargestellt\n\n**Lsung:**\nDas System korrigiert automatisch:\n```typescript\nif (eanStr.match(/[0-9],[0-9]+E\\+[0-9]+/i)) {\n  const eanNum = parseFloat(eanStr.replace(',', '.'));\n  product[key] = Math.round(eanNum).toString();\n}\n```\n\n---\n\n## 11. Sicherheit\n\n### 11.1 Authentifizierung\n\nAlle API-Endpoints sind geschtzt:\n\n```typescript\napp.post('/api/pixi/compare', \n  requireAuth,  // JWT-Token validieren\n  requireFeature('pixiIntegration'),  // Feature-Flag prfen\n  upload.single('csvFile'), \n  async (req: any, res) => { ... }\n);\n```\n\n### 11.2 Multi-Tenancy\n\nAutomatische Isolation per `organization_id`:\n\n```typescript\nconst products = await supabaseStorage.getProductsByProject(\n  projectId,\n  req.user.organizationId  // Tenant-Isolation\n);\n```\n\n### 11.3 Token-Schutz\n\nDer `X-AUTH-TOKEN` wird niemals im Frontend exponiert:\n- Nur in Environment-Variablen\n- Nur Backend hat Zugriff\n- Wird nicht in Logs ausgegeben\n\n---\n\n## 12. Performance-Metriken\n\n### 12.1 Benchmark-Daten\n\n**CSV mit 36 Produkten:**\n- Pixi API-Request: ~500ms\n- Map-Building: ~5ms\n- Matching (36 Produkte): ~2ms\n- **Gesamt: ~510ms**\n\n**CSV mit 500 Produkten:**\n- Pixi API-Request: ~800ms (Cache: ~0ms)\n- Map-Building: ~15ms\n- Matching (500 Produkte): ~25ms\n- **Gesamt: ~840ms**\n\n### 12.2 Optimierungspotenzial\n\n1. **Batch-Processing:** Groe CSVs in Chunks aufteilen\n2. **Persistent Cache:** Redis statt In-Memory\n3. **Parallel API-Calls:** Mehrere SupplNr gleichzeitig abfragen\n\n---\n\n## 13. Changelog\n\n| Datum | Version | nderung |\n|-------|---------|----------|\n| 2025-11-05 | 1.3 | **KRITISCH:** Bindestriche in Artikelnummern werden nun erhalten (z.B. \"2447-3049-60\") - keine Normalisierung mehr! |\n| 2025-11-05 | 1.2 | Multi-Strategie Matching implementiert |\n| 2025-11-04 | 1.1 | manufacturerArticleNumber-Feld hinzugefgt |\n| 2025-11-03 | 1.0 | Initiale Pixi-Integration |\n\n---\n\n## 14. Support & Kontakt\n\n**Technischer Ansprechpartner:** IT-Team PIMPilot\n\n**Dokumentation erstellt:** November 2025\n\n**Letzte Aktualisierung:** 2025-11-05\n","size_bytes":24601},"server/services/mapping-rules-loader.ts":{"content":"import { readFileSync } from 'fs';\nimport { join } from 'path';\n\nexport interface MappingRules {\n  version: string;\n  description: string;\n  source: string;\n  target: string;\n  mapping: Record<string, string[]>;\n  mappingPriority: Record<string, string[]>;\n  fixedValues: Record<string, string | number>;\n  autoGenerate: Record<string, {\n    dependsOn: string;\n    rule: string;\n    fallback?: string;\n  }>;\n  transformations: Record<string, {\n    type: string;\n    from?: string;\n    to?: string;\n    formula?: string;\n  }>;\n  validation: {\n    required: string[];\n    dataTypes: Record<string, string>;\n    ranges: Record<string, { min: number; max: number }>;\n  };\n  outputFormat: {\n    type: string;\n    delimiter: string;\n    encoding: string;\n    includeHeader: boolean;\n    columns: string[];\n  };\n}\n\n/**\n * Load mapping rules from mappingRules.json\n */\nexport function loadMappingRules(): MappingRules {\n  try {\n    const filePath = join(process.cwd(), 'mappingRules.json');\n    const fileContent = readFileSync(filePath, 'utf-8');\n    const rules = JSON.parse(fileContent) as MappingRules;\n    \n    console.log(`[Mapping Rules] Loaded rules version ${rules.version}`);\n    console.log(`[Mapping Rules] Fixed values: ${Object.keys(rules.fixedValues).length} fields`);\n    \n    return rules;\n  } catch (error: any) {\n    console.error('[Mapping Rules] Error loading mappingRules.json:', error.message);\n    throw new Error('Failed to load mapping rules');\n  }\n}\n\n/**\n * Apply transformations to a value\n */\nexport function applyTransformation(\n  value: string | number,\n  transformation: MappingRules['transformations'][string]\n): string | number {\n  if (!value || !transformation) return value;\n  \n  try {\n    if (transformation.type === 'unit_conversion') {\n      const numValue = typeof value === 'string' ? parseFloat(value) : value;\n      if (isNaN(numValue)) return value;\n      \n      // Execute transformation formula\n      if (transformation.formula === 'value / 1000') {\n        return (numValue / 1000).toFixed(3);\n      } else if (transformation.formula === 'value / 10') {\n        return (numValue / 10).toFixed(1);\n      }\n    }\n  } catch (error) {\n    console.error('[Transformation] Error applying transformation:', error);\n  }\n  \n  return value;\n}\n\n/**\n * Generate auto-generated fields (e.g., category path from voltage)\n */\nexport function generateAutoField(\n  rule: MappingRules['autoGenerate'][string],\n  productData: any\n): string | null {\n  if (!rule) return null;\n  \n  try {\n    // Extract value from product data\n    const dependsOnValue = productData[rule.dependsOn];\n    \n    if (dependsOnValue) {\n      // Replace template variables in rule (e.g., {{Nominalspannung (V)}})\n      let result = rule.rule.replace(\n        new RegExp(`\\\\{\\\\{${rule.dependsOn}\\\\}\\\\}`, 'g'),\n        dependsOnValue\n      );\n      return result;\n    } else if (rule.fallback) {\n      return rule.fallback;\n    }\n  } catch (error) {\n    console.error('[Auto-Generate] Error generating auto field:', error);\n  }\n  \n  return rule.fallback || null;\n}\n","size_bytes":3058}},"version":2}