<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMPilot System Architecture</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .buttons {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .mermaid {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .legend h3 {
            margin-top: 0;
            color: #333;
        }
        .legend-item {
            display: inline-block;
            margin: 10px 20px 10px 0;
            font-size: 14px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ PIMPilot System Architecture</h1>
        <p class="subtitle">Multi-Tenant B2B SaaS f√ºr AI-gest√ºtzte Produktbeschreibungen</p>
        
        <div class="buttons">
            <button onclick="downloadSVG()">üì• Als SVG herunterladen</button>
            <button onclick="downloadPNG()">üì• Als PNG herunterladen</button>
            <button onclick="window.print()">üñ®Ô∏è Drucken</button>
        </div>

        <div class="mermaid">
graph TB
    subgraph Frontend["üé® FRONTEND (React + TypeScript)"]
        Dashboard["üìä Dashboard<br/>/dashboard"]
        Projects["üìÅ Projects<br/>/project/:id"]
        Products["üõçÔ∏è Products<br/>/products"]
        AIGen["ü§ñ AI Generator<br/>/generate<br/>‚Ä¢ Bulk CSV Upload<br/>‚Ä¢ AI Prompts"]
        Scraper["üîç Web Scraper<br/>/scraper<br/>‚Ä¢ URL Scraping<br/>‚Ä¢ Supplier Mgmt"]
        Pixi["üìà Pixi Compare<br/>/pixi-compare<br/>‚Ä¢ CSV Upload<br/>‚Ä¢ Project Mode"]
    end

    subgraph Auth["üîê AUTHENTICATION"]
        AuthMW["Passport.js Middleware<br/>‚Ä¢ JWT Token Validation<br/>‚Ä¢ Multi-Tenant Isolation<br/>‚Ä¢ organization_id"]
    end

    subgraph API["‚öôÔ∏è BACKEND API (Express.js)"]
        AuthAPI["üîë /api/auth/*<br/>‚Ä¢ login<br/>‚Ä¢ register<br/>‚Ä¢ logout"]
        ProjectAPI["üìÇ /api/projects<br/>‚Ä¢ CRUD<br/>‚Ä¢ Multi-tenant"]
        ProductAPI["üõí /api/products<br/>‚Ä¢ CRUD<br/>‚Ä¢ Multi-tenant"]
        GenAPI["üéØ /api/generate<br/>‚Ä¢ AI Bulk Gen<br/>‚Ä¢ Usage Tracking<br/>‚Ä¢ Tier Limits"]
        ScraperAPI["üï∑Ô∏è /api/scraper/*<br/>‚Ä¢ scrapeUrl<br/>‚Ä¢ suppliers<br/>‚Ä¢ profiles"]
        PixiAPI["üìä /api/pixi/*<br/>‚Ä¢ compare<br/>‚Ä¢ compare-project<br/>‚Ä¢ cache"]
    end

    subgraph Services["üîß SERVICE LAYER"]
        AIService["üß† AI Service<br/>(OpenAI GPT-4o-mini)<br/>‚Ä¢ Prompts & Subprompts<br/>‚Ä¢ Templates<br/>‚Ä¢ Usage Tracking"]
        ScraperService["üîé Scraper Service<br/>(Cheerio)<br/>‚Ä¢ CSS Selectors<br/>‚Ä¢ Auto-detect<br/>‚Ä¢ Table Parser"]
        PixiService["üì° Pixi Service<br/>(Pixi ERP API)<br/>‚Ä¢ ItemSearch<br/>‚Ä¢ Matching Logic<br/>‚Ä¢ 5-min Cache"]
        StripeService["üí≥ Stripe Service<br/>‚Ä¢ Subscriptions<br/>‚Ä¢ Trial Mode<br/>‚Ä¢ Tier Limits"]
        SupabaseStorage["üíæ Supabase Storage<br/>‚Ä¢ CRUD Operations<br/>‚Ä¢ Mappers<br/>‚Ä¢ Batch Updates<br/>‚Ä¢ Organization Filter"]
    end

    subgraph Database["üóÑÔ∏è DATABASE (PostgreSQL/Supabase)"]
        Orgs["üë• organizations<br/>‚Ä¢ id (PK)<br/>‚Ä¢ name<br/>‚Ä¢ created_at"]
        Users["üë§ users<br/>‚Ä¢ id (PK)<br/>‚Ä¢ email<br/>‚Ä¢ password<br/>‚Ä¢ organization_id<br/>‚Ä¢ role"]
        ProjectsDB["üìÅ projects<br/>‚Ä¢ id (PK)<br/>‚Ä¢ name<br/>‚Ä¢ organization_id"]
        ProductsDB["üõçÔ∏è products_in_projects<br/>‚Ä¢ id (PK)<br/>‚Ä¢ project_id<br/>‚Ä¢ product_name<br/>‚Ä¢ pixi_status ‚≠ê<br/>‚Ä¢ pixi_ean ‚≠ê<br/>‚Ä¢ pixi_checked_at ‚≠ê"]
        Suppliers["üì¶ suppliers<br/>‚Ä¢ id (PK)<br/>‚Ä¢ name<br/>‚Ä¢ suppl_nr ‚≠ê<br/>‚Ä¢ selectors<br/>‚Ä¢ organization_id"]
        APILogs["üìù api_usage_logs<br/>‚Ä¢ id (PK)<br/>‚Ä¢ user_id<br/>‚Ä¢ organization_id<br/>‚Ä¢ api_calls<br/>‚Ä¢ timestamp"]
    end

    subgraph External["üåê EXTERNAL SERVICES"]
        OpenAI["ü§ñ OpenAI API<br/>GPT-4o-mini<br/>‚Ä¢ Text Generation<br/>‚Ä¢ Streaming<br/>‚Ä¢ Token Tracking"]
        PixiERP["üìä Pixi ERP<br/>ItemSearch API<br/>‚Ä¢ artikelnummer<br/>‚Ä¢ produktname<br/>‚Ä¢ EANUPC"]
        StripeAPI["üí≥ Stripe API<br/>‚Ä¢ Starter Plan<br/>‚Ä¢ Pro Plan<br/>‚Ä¢ Enterprise"]
    end

    %% Frontend connections
    Dashboard --> AuthMW
    Projects --> AuthMW
    Products --> AuthMW
    AIGen --> AuthMW
    Scraper --> AuthMW
    Pixi --> AuthMW

    %% Auth to API
    AuthMW --> AuthAPI
    AuthMW --> ProjectAPI
    AuthMW --> ProductAPI
    AuthMW --> GenAPI
    AuthMW --> ScraperAPI
    AuthMW --> PixiAPI

    %% API to Services
    AuthAPI --> SupabaseStorage
    ProjectAPI --> SupabaseStorage
    ProductAPI --> SupabaseStorage
    GenAPI --> AIService
    ScraperAPI --> ScraperService
    PixiAPI --> PixiService

    %% Services connections
    AIService --> SupabaseStorage
    ScraperService --> SupabaseStorage
    PixiService --> SupabaseStorage
    StripeService --> SupabaseStorage

    %% Storage to Database
    SupabaseStorage --> Orgs
    SupabaseStorage --> Users
    SupabaseStorage --> ProjectsDB
    SupabaseStorage --> ProductsDB
    SupabaseStorage --> Suppliers
    SupabaseStorage --> APILogs

    %% External Services
    AIService --> OpenAI
    PixiService --> PixiERP
    StripeService --> StripeAPI

    %% Database relationships
    Users -.->|belongs to| Orgs
    ProjectsDB -.->|belongs to| Orgs
    ProductsDB -.->|belongs to| ProjectsDB
    Suppliers -.->|belongs to| Orgs
    APILogs -.->|tracks| Users

    classDef frontend fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef auth fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef api fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef service fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef external fill:#fff9c4,stroke:#f9a825,stroke-width:2px

    class Dashboard,Projects,Products,AIGen,Scraper,Pixi frontend
    class AuthMW auth
    class AuthAPI,ProjectAPI,ProductAPI,GenAPI,ScraperAPI,PixiAPI api
    class AIService,ScraperService,PixiService,StripeService,SupabaseStorage service
    class Orgs,Users,ProjectsDB,ProductsDB,Suppliers,APILogs database
    class OpenAI,PixiERP,StripeAPI external
        </div>

        <div class="legend">
            <h3>üìå Legende</h3>
            <div class="legend-item">
                <span class="legend-color" style="background: #e3f2fd; border-color: #1976d2;"></span>
                Frontend Layer
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #fff3e0; border-color: #f57c00;"></span>
                Authentication
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #f3e5f5; border-color: #7b1fa2;"></span>
                Backend API
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #e8f5e9; border-color: #388e3c;"></span>
                Service Layer
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #fce4ec; border-color: #c2185b;"></span>
                Database
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #fff9c4; border-color: #f9a825;"></span>
                External Services
            </div>
            <div style="margin-top: 15px;">
                <strong>‚≠ê = Neu hinzugef√ºgt f√ºr Pixi-Integration</strong>
            </div>
        </div>
    </div>

    <script>
        function downloadSVG() {
            const svg = document.querySelector('.mermaid svg');
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pimpilot-architecture.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadPNG() {
            const svg = document.querySelector('.mermaid svg');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            img.onload = function() {
                canvas.width = img.width * 2;
                canvas.height = img.height * 2;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(function(blob) {
                    const pngUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = pngUrl;
                    a.download = 'pimpilot-architecture.png';
                    a.click();
                    URL.revokeObjectURL(pngUrl);
                    URL.revokeObjectURL(url);
                });
            };
            
            img.src = url;
        }
    </script>
</body>
</html>
